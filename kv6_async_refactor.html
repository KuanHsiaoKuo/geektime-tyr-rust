<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>å¼‚æ­¥æ”¹é€  - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_3_0_trait_overview.html"><strong aria-hidden="true">4.2.3.1.</strong> traitæ¦‚è§ˆ</a></li><li class="chapter-item "><a href="2_3_1_trait_impl.html"><strong aria-hidden="true">4.2.3.2.</strong> Trait Impl</a></li><li class="chapter-item "><a href="2_3_2_trait_object.html"><strong aria-hidden="true">4.2.3.3.</strong> Trait Object</a></li><li class="chapter-item "><a href="2_3_3_trait_frequently.html"><strong aria-hidden="true">4.2.3.4.</strong> å¸¸ç”¨trait</a></li><li class="chapter-item "><a href="2_3_4_trait_design.html"><strong aria-hidden="true">4.2.3.5.</strong> Traitè®¾è®¡</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a></li><li class="chapter-item "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_2_1_slice.html"><strong aria-hidden="true">4.3.2.1.</strong> åˆ‡ç‰‡</a></li><li class="chapter-item "><a href="3_2_2_hashmap.html"><strong aria-hidden="true">4.3.2.2.</strong> å“ˆå¸Œè¡¨</a></li></ol></li><li class="chapter-item "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a></li><li class="chapter-item "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="4_1_macros_classify.html"><strong aria-hidden="true">4.4.1.</strong> å®åˆ†ç±»</a></li><li class="chapter-item "><a href="4_2_declarative_macros.html"><strong aria-hidden="true">4.4.2.</strong> å£°æ˜å®</a></li><li class="chapter-item "><a href="4_3_procedural_macros.html"><strong aria-hidden="true">4.4.3.</strong> è¿‡ç¨‹å®</a></li></ol></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item "><a href="5_2_future_async_await.html"><strong aria-hidden="true">4.5.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">4.5.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html" class="active"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="å…­å¼‚æ­¥å¤„ç†"><a class="header" href="#å…­å¼‚æ­¥å¤„ç†">å…­ã€å¼‚æ­¥å¤„ç†</a></h1>
<!--ts-->
<ul>
<li><a href="#%E5%85%AD%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86">å…­ã€å¼‚æ­¥å¤„ç†</a>
<ul>
<li><a href="#%E5%9B%9E%E9%A1%BE%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B">å›é¡¾æ„å»ºè¿‡ç¨‹</a></li>
<li><a href="#%E5%BC%80%E5%A7%8B%E5%81%9A%E5%BC%82%E6%AD%A5%E9%87%8D%E6%9E%84">å¼€å§‹åšå¼‚æ­¥é‡æ„</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA-proststream">åˆ›å»º ProstStream</a>
<ul>
<li><a href="#%E6%B5%8B%E8%AF%95">æµ‹è¯•ï¼</a></li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8-proststream">ä½¿ç”¨ ProstStream</a></li>
<li><a href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E5%9B%9E%E9%A1%BE%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7">å¼‚æ­¥å¤„ç†å›é¡¾ï¼šå•å…ƒæµ‹è¯•çš„é‡è¦æ€§</a></li>
<li><a href="#%E6%80%9D%E8%80%83%E9%A2%98">æ€è€ƒé¢˜</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct 19 11:46:39 UTC 2022 -->
<!--te-->
<h2 id="å›é¡¾æ„å»ºè¿‡ç¨‹"><a class="header" href="#å›é¡¾æ„å»ºè¿‡ç¨‹">å›é¡¾æ„å»ºè¿‡ç¨‹</a></h2>
<p>ä¹‹å‰å·²ç»å®Œæˆäº†ä¸€ä¸ªç›¸å¯¹å®Œå–„çš„ KV serverã€‚</p>
<details id="admonition-è¿˜è®°å¾—æ˜¯æ€ä¹ˆä¸€æ­¥æ­¥æ„å»ºè¿™ä¸ªæœåŠ¡çš„ä¹ˆ" class="admonition question">
<summary class="admonition-title">
<p>è¿˜è®°å¾—æ˜¯æ€ä¹ˆä¸€æ­¥æ­¥æ„å»ºè¿™ä¸ªæœåŠ¡çš„ä¹ˆï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-è¿˜è®°å¾—æ˜¯æ€ä¹ˆä¸€æ­¥æ­¥æ„å»ºè¿™ä¸ªæœåŠ¡çš„ä¹ˆ"></a></p>
</summary>
<div>
<ol>
<li>æ­å¥½ KV server çš„åŸºç¡€åŠŸèƒ½ï¼š</li>
</ol>
<ul>
<li>æ„é€ äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´äº¤äº’çš„ protobuf</li>
<li>ç„¶åè®¾è®¡CommandService trait å’Œ Storage traitï¼Œåˆ†åˆ«å¤„ç†å®¢æˆ·ç«¯å‘½ä»¤å’Œå­˜å‚¨ã€‚</li>
</ul>
<ol start="2">
<li>è¿›ä¸€æ­¥æ„é€ äº† Service æ•°æ®ç»“æ„ï¼š</li>
</ol>
<ul>
<li>æ¥æ”¶ CommandRequest</li>
<li>æ ¹æ®å…¶ç±»å‹è°ƒç”¨ç›¸åº”çš„ CommandService å¤„ç†</li>
<li>å¹¶åšåˆé€‚çš„äº‹ä»¶é€šçŸ¥</li>
<li>æœ€åè¿”å› CommandResponseã€‚</li>
</ul>
<blockquote>
<p>ä½†æ‰€æœ‰è¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨åŒæ­¥çš„ä¸–ç•Œï¼šä¸ç®¡æ•°æ®æ˜¯æ€ä¹ˆè·å¾—çš„ï¼Œæ•°æ®å·²ç»åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æŠŠä¸€ç§æ•°æ®ç±»å‹è½¬æ¢æˆå¦ä¸€ç§æ•°æ®ç±»å‹çš„è¿ç®—è€Œå·²ã€‚</p>
</blockquote>
<ol start="3">
<li>ä¹‹åæ¶‰è¶³ç½‘ç»œçš„ä¸–ç•Œã€‚</li>
</ol>
<ul>
<li>ä¸º KV server æ„é€ äº†è‡ªå·±çš„ frameï¼šä¸€ä¸ªåŒ…å«é•¿åº¦å’Œæ˜¯å¦å‹ç¼©çš„ä¿¡æ¯çš„ 4 å­—èŠ‚çš„å¤´ï¼Œä»¥åŠå®é™…çš„ payloadï¼›</li>
<li>è¿˜è®¾è®¡äº†ä¸€ä¸ª FrameCoder æ¥å¯¹ frame è¿›è¡Œå°åŒ…å’Œæ‹†åŒ…ï¼Œè¿™ä¸ºæ¥ä¸‹æ¥æ„é€ ç½‘ç»œæ¥å£æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ã€‚</li>
</ul>
<ol start="4">
<li>
<p>è€ƒè™‘åˆ°ç½‘ç»œå®‰å…¨ï¼Œæä¾›äº† TLS çš„æ”¯æŒã€‚</p>
</li>
<li>
<p>åœ¨æ„å»º ProstStream çš„æ—¶å€™å¼€å§‹å¤„ç†å¼‚æ­¥</p>
</li>
</ol>
<ul>
<li>ProstStream å†…éƒ¨çš„ stream éœ€è¦æ”¯æŒ AsyncRead + AsyncWriteï¼Œè¿™å¯ä»¥è®© ProstStream é€‚é…åŒ…æ‹¬ TcpStream å’Œ TlsStream åœ¨å†…çš„ä¸€åˆ‡å®ç°äº† AsyncRead å’Œ AsyncWrite çš„å¼‚æ­¥ç½‘ç»œæ¥å£ã€‚</li>
</ul>
<blockquote>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬æ‰“é€šäº†:</p>
</blockquote>
<ul>
<li>ä»è¿œç«¯å¾—åˆ°ä¸€ä¸ªå‘½ä»¤</li>
<li>å†ç» TCPã€TLS</li>
<li>ç„¶åè¢« FrameCoder è§£å‡ºæ¥ä¸€ä¸ª CommandRequest</li>
<li>äº¤ç”± Service æ¥å¤„ç†çš„è¿‡ç¨‹</li>
<li>æŠŠåŒæ­¥ä¸–ç•Œå’Œå¼‚æ­¥ä¸–ç•Œè¿æ¥èµ·æ¥çš„ï¼Œå°±æ˜¯ ProstServerStream è¿™ä¸ªç»“æ„ã€‚</li>
</ul>
</div>
</details>
<div id="admonition--è¿™ä¸ªä»æ”¶åŒ…å¤„ç†åˆ°å¤„ç†å®Œæˆåå‘åŒ…çš„å®Œæ•´æµç¨‹å’Œç³»ç»Ÿç»“æ„å¯ä»¥çœ‹ä¸‹å›¾" class="admonition abstract">
<div class="admonition-title">
<blockquote>
<p>è¿™ä¸ªä»æ”¶åŒ…å¤„ç†åˆ°å¤„ç†å®Œæˆåå‘åŒ…çš„å®Œæ•´æµç¨‹å’Œç³»ç»Ÿç»“æ„ï¼Œå¯ä»¥çœ‹ä¸‹å›¾ï¼š</p>
</blockquote>
<p><a class="admonition-anchor-link" href="#admonition--è¿™ä¸ªä»æ”¶åŒ…å¤„ç†åˆ°å¤„ç†å®Œæˆåå‘åŒ…çš„å®Œæ•´æµç¨‹å’Œç³»ç»Ÿç»“æ„å¯ä»¥çœ‹ä¸‹å›¾"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/82da823b4eb16935fdeyy727e3b3262c.jpg" alt="img" /></p>
</div>
</div>
<h2 id="å¼€å§‹åšå¼‚æ­¥é‡æ„"><a class="header" href="#å¼€å§‹åšå¼‚æ­¥é‡æ„">å¼€å§‹åšå¼‚æ­¥é‡æ„</a></h2>
<p>è™½ç„¶æˆ‘ä»¬å¾ˆæ—©å°±å·²ç»æ’°å†™äº†ä¸å°‘å¼‚æ­¥æˆ–è€…å’Œå¼‚æ­¥æœ‰å…³çš„ä»£ç ã€‚ä½†æ˜¯æœ€èƒ½ä½“ç° Rust å¼‚æ­¥æœ¬è´¨çš„ poll()ã€poll_read()ã€poll_next() è¿™æ ·çš„å¤„ç†å‡½æ•°è¿˜æ²¡æœ‰æ€ä¹ˆå†™è¿‡ï¼Œä¹‹å‰æµ‹è¯•å¼‚æ­¥çš„ read_frame() å†™è¿‡ä¸€ä¸ª
DummyStreamï¼Œç®—æ˜¯ä½“éªŒäº†ä¸€ä¸‹åº•å±‚çš„å¼‚æ­¥å¤„ç†å‡½æ•°çš„å¤æ‚æ¥å£ã€‚</p>
<details id="admonition-ä¸è¿‡åœ¨-dummystream-é‡Œå¹¶æ²¡æœ‰åšä»»ä½•å¤æ‚çš„åŠ¨ä½œ" class="admonition note">
<summary class="admonition-title">
<p>ä¸è¿‡åœ¨ DummyStream é‡Œï¼Œå¹¶æ²¡æœ‰åšä»»ä½•å¤æ‚çš„åŠ¨ä½œï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸è¿‡åœ¨-dummystream-é‡Œå¹¶æ²¡æœ‰åšä»»ä½•å¤æ‚çš„åŠ¨ä½œ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
struct DummyStream {
    buf: BytesMut,
}

impl AsyncRead for DummyStream {
    fn poll_read(
        self: std::pin::Pin&lt;&amp;mut Self&gt;,
        _cx: &amp;mut std::task::Context&lt;'_&gt;,
        buf: &amp;mut tokio::io::ReadBuf&lt;'_&gt;,
    ) -&gt; std::task::Poll&lt;std::io::Result&lt;()&gt;&gt; {
        // çœ‹çœ‹ ReadBuf éœ€è¦å¤šå¤§çš„æ•°æ®
        let len = buf.capacity();
        // split å‡ºè¿™ä¹ˆå¤§çš„æ•°æ®
        let data = self.get_mut().buf.split_to(len);
        // æ‹·è´ç»™ ReadBuf
        buf.put_slice(&amp;data);
        // ç›´æ¥å®Œå·¥
        std::task::Poll::Ready(Ok(()))
    }
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>è¿™é‡Œå¯¹ç°æœ‰çš„ä»£ç åšäº›é‡æ„ï¼Œè®©æ ¸å¿ƒçš„ ProstStream æ›´ç¬¦åˆ Rust çš„å¼‚æ­¥ IO æ¥å£é€»è¾‘ã€‚</p>
</blockquote>
<p>å…·ä½“è¦åšç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<details id="admonition-çœ‹ä¹‹å‰å†™çš„-prostserverstream-çš„-process-å‡½æ•°æ¯”è¾ƒä¸€ä¸‹å®ƒå’Œ-async_prost-åº“çš„-asyncprost-çš„è°ƒç”¨é€»è¾‘" class="admonition info">
<summary class="admonition-title">
<p>çœ‹ä¹‹å‰å†™çš„ ProstServerStream çš„ process() å‡½æ•°ï¼Œæ¯”è¾ƒä¸€ä¸‹å®ƒå’Œ async_prost åº“çš„ AsyncProst çš„è°ƒç”¨é€»è¾‘ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-çœ‹ä¹‹å‰å†™çš„-prostserverstream-çš„-process-å‡½æ•°æ¯”è¾ƒä¸€ä¸‹å®ƒå’Œ-async_prost-åº“çš„-asyncprost-çš„è°ƒç”¨é€»è¾‘"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// process() å‡½æ•°çš„å†…åœ¨é€»è¾‘
while let Ok(cmd) = self.recv().await {
    info!(&quot;Got a new command: {:?}&quot;, cmd);
    let res = self.service.execute(cmd);
    self.send(res).await?;
}

// async_prost åº“çš„ AsyncProst çš„è°ƒç”¨é€»è¾‘
while let Some(Ok(cmd)) = stream.next().await {
    info!(&quot;Got a new command: {:?}&quot;, cmd);
    let res = svc.execute(cmd);
    stream.send(res).await.unwrap();
}
</code></pre></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>ç”±äº AsyncProst å®ç°äº† <a href="https://docs.rs/futures/0.3.17/futures/stream/trait.Stream.html">Stream</a> å’Œ <a href="https://docs.rs/futures/0.3.17/futures/sink/trait.Sink.html">Sink</a></li>
<li>èƒ½æ›´åŠ è‡ªç„¶åœ°è°ƒç”¨ <a href="https://docs.rs/futures/0.3.17/futures/stream/trait.StreamExt.html">StreamExt trait </a>çš„ next() æ–¹æ³•å’Œ SinkExt trait çš„ send() æ–¹æ³•ï¼Œæ¥å¤„ç†æ•°æ®çš„æ”¶å‘</li>
<li>è€Œ ProstServerStream åˆ™è‡ªå·±é¢å¤–å®ç°äº†å‡½æ•° recv() å’Œ send()ã€‚</li>
</ul>
<blockquote>
<p>è™½ç„¶ä»ä»£ç å¯¹æ¯”çš„è§’åº¦ï¼Œè¿™ä¸¤æ®µä»£ç å‡ ä¹ä¸€æ ·ï¼Œä½†æœªæ¥çš„å¯æ‰©å±•æ€§ï¼Œå’Œæ•´ä¸ªå¼‚æ­¥ç”Ÿæ€çš„èæ´½æ€§ä¸Šï¼ŒAsyncProst è¿˜æ˜¯æ›´èƒœä¸€ç­¹ã€‚</p>
</blockquote>
</div>
</details>
<p>æ‰€ä»¥è¿™é‡Œå°±æ„é€ ä¸€ä¸ª ProstStream ç»“æ„ï¼Œè®©å®ƒå®ç° Stream å’Œ Sink è¿™ä¸¤ä¸ª traitï¼Œç„¶åè®© ProstServerStream å’Œ ProstClientStream ä½¿ç”¨å®ƒã€‚</p>
<h2 id="åˆ›å»º-proststream"><a class="header" href="#åˆ›å»º-proststream">åˆ›å»º ProstStream</a></h2>
<details id="admonition-åœ¨å¼€å§‹é‡æ„ä¹‹å‰å…ˆæ¥ç®€å•å¤ä¹ ä¸€ä¸‹-stream-trait-å’Œ-sink-trait" class="admonition note">
<summary class="admonition-title">
<p>åœ¨å¼€å§‹é‡æ„ä¹‹å‰ï¼Œå…ˆæ¥ç®€å•å¤ä¹ ä¸€ä¸‹ Stream trait å’Œ Sink traitï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-åœ¨å¼€å§‹é‡æ„ä¹‹å‰å…ˆæ¥ç®€å•å¤ä¹ ä¸€ä¸‹-stream-trait-å’Œ-sink-trait"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// å¯ä»¥ç±»æ¯” Iterator
pub trait Stream {
    // ä» Stream ä¸­è¯»å–åˆ°çš„æ•°æ®ç±»å‹
    type Item;

  // ä» stream é‡Œè¯»å–ä¸‹ä¸€ä¸ªæ•°æ®
    fn poll_next(
    self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;
    ) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt;;
}

// 
pub trait Sink&lt;Item&gt; {
    type Error;
    fn poll_ready(
        self: Pin&lt;&amp;mut Self&gt;, 
        cx: &amp;mut Context&lt;'_&gt;
    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;
    fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: Item) -&gt; Result&lt;(), Self::Error&gt;;
    fn poll_flush(
        self: Pin&lt;&amp;mut Self&gt;, 
        cx: &amp;mut Context&lt;'_&gt;
    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;
    fn poll_close(
        self: Pin&lt;&amp;mut Self&gt;, 
        cx: &amp;mut Context&lt;'_&gt;
    ) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt;;
}
</code></pre></pre>
</div>
</details>
<details id="admonition--é‚£ä¹ˆ-proststream-å…·ä½“éœ€è¦åŒ…å«ä»€ä¹ˆç±»å‹å‘¢" class="admonition question">
<summary class="admonition-title">
<blockquote>
<p>é‚£ä¹ˆ ProstStream å…·ä½“éœ€è¦åŒ…å«ä»€ä¹ˆç±»å‹å‘¢ï¼Ÿ </p>
</blockquote>
<p><a class="admonition-anchor-link" href="#admonition--é‚£ä¹ˆ-proststream-å…·ä½“éœ€è¦åŒ…å«ä»€ä¹ˆç±»å‹å‘¢"></a></p>
</summary>
<div>
<ol>
<li>
<p>å› ä¸ºå®ƒçš„ä¸»è¦èŒè´£æ˜¯ä»åº•ä¸‹çš„ stream ä¸­è¯»å–æˆ–è€…å‘é€æ•°æ®ï¼Œæ‰€ä»¥ä¸€ä¸ªæ”¯æŒ AsyncRead å’Œ AsyncWrite çš„æ³›å‹å‚æ•° S æ˜¯å¿…ç„¶éœ€è¦çš„ã€‚</p>
</li>
<li>
<p>å¦å¤– Stream trait å’Œ Sink éƒ½å„éœ€è¦ä¸€ä¸ª Item ç±»å‹ï¼Œå¯¹äºæˆ‘ä»¬çš„ç³»ç»Ÿæ¥è¯´ï¼ŒItem æ˜¯ CommandRequest æˆ–è€… CommandResponseï¼Œä½†ä¸ºäº†çµæ´»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ In å’Œ Out è¿™ä¸¤ä¸ªæ³›å‹å‚æ•°æ¥è¡¨ç¤ºã€‚</p>
</li>
<li>
<p>å½“ç„¶ï¼Œåœ¨å¤„ç† Stream å’Œ Sink æ—¶è¿˜éœ€è¦ read buffer å’Œ write bufferã€‚</p>
</li>
</ol>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬çš„ ProstStream ç»“æ„çœ‹ä¸Šå»æ˜¯è¿™æ ·å­çš„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct ProstStream&lt;S, In, Out&gt; {
    // innner stream
    stream: S,
    // å†™ç¼“å­˜
    wbuf: BytesMut,
    // è¯»ç¼“å­˜
    rbuf: BytesMut,
}
</code></pre></pre>
</div>
</details>
<details id="admonition-ç„¶è€Œrust-ä¸å…è®¸æ•°æ®ç»“æ„æœ‰è¶…å‡ºéœ€è¦çš„æ³›å‹å‚æ•°æ€ä¹ˆåŠ" class="admonition question">
<summary class="admonition-title">
<p>ç„¶è€Œï¼ŒRust ä¸å…è®¸æ•°æ®ç»“æ„æœ‰è¶…å‡ºéœ€è¦çš„æ³›å‹å‚æ•°ã€‚æ€ä¹ˆåŠï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-ç„¶è€Œrust-ä¸å…è®¸æ•°æ®ç»“æ„æœ‰è¶…å‡ºéœ€è¦çš„æ³›å‹å‚æ•°æ€ä¹ˆåŠ"></a></p>
</summary>
<div>
<blockquote>
<p>åˆ«æ€¥ï¼Œå¯ä»¥ç”¨<a href="https://doc.rust-lang.org/std/marker/struct.PhantomData.html"> PhantomDataï¼Œå®ƒæ˜¯ä¸€ä¸ªé›¶å­—èŠ‚å¤§å°çš„å ä½ç¬¦</a>ï¼Œå¯ä»¥è®©æˆ‘ä»¬çš„æ•°æ®ç»“æ„æºå¸¦æœªä½¿ç”¨çš„æ³›å‹å‚æ•°ã€‚</p>
</blockquote>
</div>
</details>
<p>å¥½ï¼Œç°åœ¨æœ‰è¶³å¤Ÿçš„æ€è·¯äº†ï¼Œæˆ‘ä»¬åˆ›å»º src/network/stream.rsï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼ˆè®°å¾—åœ¨ src/network/mod.rs æ·»åŠ å¯¹ stream.rs çš„å¼•ç”¨ï¼‰ï¼š</p>
<details id="admonition-è¿™æ®µä»£ç åŒ…å«äº†ä¸º-proststream-å®ç°-stream-å’Œ-sink-çš„éª¨æ¶ä»£ç " class="admonition note">
<summary class="admonition-title">
<p>è¿™æ®µä»£ç åŒ…å«äº†ä¸º ProstStream å®ç° Stream å’Œ Sink çš„éª¨æ¶ä»£ç ã€‚ </p>
<p><a class="admonition-anchor-link" href="#admonition-è¿™æ®µä»£ç åŒ…å«äº†ä¸º-proststream-å®ç°-stream-å’Œ-sink-çš„éª¨æ¶ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use bytes::BytesMut;
use futures::{Sink, Stream};
use std::{
    marker::PhantomData,
    pin::Pin,
    task::{Context, Poll},
};
use tokio::io::{AsyncRead, AsyncWrite};

use crate::{FrameCoder, KvError};

/// å¤„ç† KV server prost frame çš„ stream
pub struct ProstStream&lt;S, In, Out&gt; where {
    // innner stream
    stream: S,
    // å†™ç¼“å­˜
    wbuf: BytesMut,
    // è¯»ç¼“å­˜
    rbuf: BytesMut,

    // ç±»å‹å ä½ç¬¦
    _in: PhantomData&lt;In&gt;,
    _out: PhantomData&lt;Out&gt;,
}

impl&lt;S, In, Out&gt; Stream for ProstStream&lt;S, In, Out&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send,
    In: Unpin + Send + FrameCoder,
    Out: Unpin + Send,
{
    /// å½“è°ƒç”¨ next() æ—¶ï¼Œå¾—åˆ° Result&lt;In, KvError&gt;
    type Item = Result&lt;In, KvError&gt;;

    fn poll_next(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt; {
        todo!()
    }
}

/// å½“è°ƒç”¨ send() æ—¶ï¼Œä¼šæŠŠ Out å‘å‡ºå»
impl&lt;S, In, Out&gt; Sink&lt;Out&gt; for ProstStream&lt;S, In, Out&gt;
where
    S: AsyncRead + AsyncWrite + Unpin,
    In: Unpin + Send,
    Out: Unpin + Send + FrameCoder,
{
    /// å¦‚æœå‘é€å‡ºé”™ï¼Œä¼šè¿”å› KvError
    type Error = KvError;

    fn poll_ready(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {
        todo!()
    }

    fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: Out) -&gt; Result&lt;(), Self::Error&gt; {
        todo!()
    }

    fn poll_flush(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {
        todo!()
    }

    fn poll_close(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {
        todo!()
    }
}
</code></pre></pre>
</div>
</details>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€ä¸ªä¸ªå¤„ç†ã€‚</p>
<blockquote>
<p>æ³¨æ„å¯¹äº In å’Œ Out å‚æ•°ï¼Œè¿˜ä¸ºå…¶çº¦æŸäº† FrameCoderï¼Œè¿™æ ·ï¼Œåœ¨å®ç°é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ decode_frame() å’Œ encode_frame() æ¥è·å–ä¸€ä¸ª Item æˆ–è€… encode ä¸€ä¸ª Itemã€‚</p>
</blockquote>
<details id="admonition-1-stream-çš„å®ç°-ä¸»è¦æ˜¯stream-çš„-poll_next-æ–¹æ³•" class="admonition note">
<summary class="admonition-title">
<ol>
<li>Stream çš„å®ç°, ä¸»è¦æ˜¯Stream çš„ poll_next() æ–¹æ³•ã€‚</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-1-stream-çš„å®ç°-ä¸»è¦æ˜¯stream-çš„-poll_next-æ–¹æ³•"></a></p>
</summary>
<div>
<p>poll_next() å¯ä»¥ç›´æ¥è°ƒç”¨ä¹‹å‰å†™å¥½çš„ read_frame()ï¼Œç„¶åå†ç”¨ decode_frame() æ¥è§£åŒ…ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn poll_next(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;Self::Item&gt;&gt; {
    // ä¸Šä¸€æ¬¡è°ƒç”¨ç»“æŸå rbuf åº”è¯¥ä¸ºç©º
    assert!(self.rbuf.len() == 0);

    // ä» rbuf ä¸­åˆ†ç¦»å‡º restï¼ˆæ‘†è„±å¯¹ self çš„å¼•ç”¨ï¼‰
    let mut rest = self.rbuf.split_off(0);

    // ä½¿ç”¨ read_frame æ¥è·å–æ•°æ®
    let fut = read_frame(&amp;mut self.stream, &amp;mut rest);
    ready!(Box::pin(fut).poll_unpin(cx))?;

    // æ‹¿åˆ°ä¸€ä¸ª frame çš„æ•°æ®ï¼ŒæŠŠ buffer åˆå¹¶å›å»
    self.rbuf.unsplit(rest);

    // è°ƒç”¨ decode_frame è·å–è§£åŒ…åçš„æ•°æ®
    Poll::Ready(Some(In::decode_frame(&amp;mut self.rbuf)))
}
</code></pre></pre>
<blockquote>
<p>è¿™ä¸ªä¸éš¾ç†è§£ï¼Œä½†ä¸­é—´è¿™æ®µéœ€è¦ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
 // ä½¿ç”¨ read_frame æ¥è·å–æ•°æ®
let fut = read_frame(&amp;mut self.stream, &amp;mut rest);
ready!(Box::pin(fut).poll_unpin(cx))?;
</code></pre></pre>
<ol>
<li>å› ä¸º poll_xxx() æ–¹æ³•å·²ç»æ˜¯ async/await çš„åº•å±‚ API å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ poll_xxx() æ–¹æ³•ä¸­ï¼Œæ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨å¼‚æ­¥å‡½æ•°çš„ï¼Œéœ€è¦æŠŠå®ƒçœ‹ä½œä¸€ä¸ª futureï¼Œç„¶åè°ƒç”¨ future çš„ poll å‡½æ•°ã€‚</li>
<li>å› ä¸º future æ˜¯ä¸€ä¸ª traitï¼Œæ‰€ä»¥éœ€è¦ Box å°†å…¶å¤„ç†æˆä¸€ä¸ªåœ¨å †ä¸Šçš„ trait objectï¼Œè¿™æ ·å°±å¯ä»¥è°ƒç”¨ <a href="https://docs.rs/futures/0.3.17/futures/future/trait.FutureExt.html#method.poll_unpin">FutureExt çš„ poll_unpin() æ–¹æ³•</a>ã€‚Box::pin ä¼šç”Ÿæˆ Pin<Box>ã€‚</li>
<li>è‡³äº ready! å®ï¼Œå®ƒä¼šåœ¨ Pending æ—¶ç›´æ¥ return Pendingï¼Œè€Œåœ¨ Ready æ—¶ï¼Œè¿”å› Ready çš„å€¼ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
macro_rules! ready {
    ($e:expr $(,)?) =&gt; {
        match $e {
            $crate::task::Poll::Ready(t) =&gt; t,
            $crate::task::Poll::Pending =&gt; return $crate::task::Poll::Pending,
        }
    };
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>Stream æˆ‘ä»¬å°±å®ç°å¥½äº†ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿæ²¡æœ‰é‚£ä¹ˆå¤æ‚ï¼Ÿ</p>
</blockquote>
<details id="admonition-2-sinkçš„å®ç°ä¸»è¦æ˜¯å››ä¸ªæ–¹æ³•" class="admonition note">
<summary class="admonition-title">
<ol start="2">
<li>Sinkçš„å®ç°ï¼šä¸»è¦æ˜¯å››ä¸ªæ–¹æ³•</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-sinkçš„å®ç°ä¸»è¦æ˜¯å››ä¸ªæ–¹æ³•"></a></p>
</summary>
<div>
<p>å†å†™ Sinkï¼Œçœ‹ä¸Šå»è¦å®ç°å¥½å‡ ä¸ªæ–¹æ³•ï¼Œå…¶å®ä¹Ÿä¸ç®—å¤æ‚çš„å››ä¸ªæ–¹æ³• ï¼š</p>
<ul>
<li>poll_ready</li>
<li>start_send()</li>
<li>poll_flush </li>
<li>poll_close </li>
</ul>
<p>æˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹ï¼š</p>
<ol>
<li><a href="https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#tymethod.poll_ready">poll_ready() </a>æ˜¯åšèƒŒå‹çš„</li>
</ol>
<p>ä½ å¯ä»¥æ ¹æ®è´Ÿè½½æ¥å†³å®šè¦ä¸è¦è¿”å› Poll::Readyã€‚å¯¹äºæˆ‘ä»¬çš„ç½‘ç»œå±‚æ¥è¯´ï¼Œå¯ä»¥å…ˆä¸å…³å¿ƒèƒŒå‹ï¼Œä¾é æ“ä½œç³»ç»Ÿçš„ TCP åè®®æ ˆæä¾›èƒŒå‹å¤„ç†å³å¯ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è¿”å› Poll::Ready(Ok(()))ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šå±‚æƒ³å†™æ•°æ®ï¼Œå¯ä»¥éšæ—¶å†™ã€‚</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn poll_ready(self: Pin&lt;&amp;mut Self&gt;, _cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {
    Poll::Ready(Ok(()))
}
</code></pre></pre>
<ol start="2">
<li>å½“ poll_ready() è¿”å› Ready åï¼ŒSink å°±èµ°åˆ°<a href="https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#tymethod.start_send"> start_send()</a>ã€‚æˆ‘ä»¬åœ¨ start_send() é‡Œå°±æŠŠå¿…è¦çš„æ•°æ®å‡†å¤‡å¥½ã€‚è¿™é‡ŒæŠŠ item å°åŒ…æˆå­—èŠ‚æµï¼Œå­˜å…¥ wbuf ä¸­ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
fn start_send(self: Pin&lt;&amp;mut Self&gt;, item: Out) -&gt; Result&lt;(), Self::Error&gt; {
    let this = self.get_mut();
    item.encode_frame(&amp;mut this.wbuf)?;

    Ok(())
}
</code></pre></pre>
<ol start="3">
<li>ç„¶ååœ¨ <a href="https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#tymethod.poll_flush">poll_flush()</a> ä¸­ï¼Œæˆ‘ä»¬å¼€å§‹å†™æ•°æ®ã€‚è¿™é‡Œéœ€è¦è®°å½•å½“å‰å†™åˆ°å“ªé‡Œï¼Œæ‰€ä»¥éœ€è¦åœ¨ ProstStream é‡ŒåŠ ä¸€ä¸ªå­—æ®µ writtenï¼Œè®°å½•å†™å…¥äº†å¤šå°‘å­—èŠ‚ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
/// å¤„ç† KV server prost frame çš„ stream
pub struct ProstStream&lt;S, In, Out&gt; {
    // innner stream
    stream: S,
    // å†™ç¼“å­˜
    wbuf: BytesMut,
    // å†™å…¥äº†å¤šå°‘å­—èŠ‚
    written: usize,
    // è¯»ç¼“å­˜
    rbuf: BytesMut,

    // ç±»å‹å ä½ç¬¦
    _in: PhantomData&lt;In&gt;,
    _out: PhantomData&lt;Out&gt;,
}
</code></pre></pre>
<p>æœ‰äº†è¿™ä¸ª written å­—æ®µï¼Œ å°±å¯ä»¥å¾ªç¯å†™å…¥ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn poll_flush(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {
    let this = self.get_mut();

    // å¾ªç¯å†™å…¥ stream ä¸­
    while this.written != this.wbuf.len() {
        let n = ready!(Pin::new(&amp;mut this.stream).poll_write(cx, &amp;this.wbuf[this.written..]))?;
        this.written += n;
    }

    // æ¸…é™¤ wbuf
    this.wbuf.clear();
    this.written = 0;

    // è°ƒç”¨ stream çš„ poll_flush ç¡®ä¿å†™å…¥
    ready!(Pin::new(&amp;mut this.stream).poll_flush(cx)?);
    Poll::Ready(Ok(()))
}
</code></pre></pre>
<ol start="4">
<li>æœ€åæ˜¯ <a href="https://docs.rs/futures/0.3.17/futures/prelude/trait.Sink.html#tymethod.poll_close">poll_close()</a>ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ stream çš„ flush å’Œ shutdown æ–¹æ³•ï¼Œç¡®ä¿æ•°æ®å†™å®Œå¹¶ä¸” stream å…³é—­ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
fn poll_close(mut self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Result&lt;(), Self::Error&gt;&gt; {
    // è°ƒç”¨ stream çš„ poll_flush ç¡®ä¿å†™å…¥
    ready!(self.as_mut().poll_flush(cx))?;

    // è°ƒç”¨ stream çš„ poll_shutdown ç¡®ä¿ stream å…³é—­
    ready!(Pin::new(&amp;mut self.stream).poll_shutdown(cx))?;
    Poll::Ready(Ok(()))
}
</code></pre></pre>
</div>
</details>
<details id="admonition-3-æˆ‘ä»¬çš„-proststream-ç›®å‰å·²ç»å®ç°äº†-stream-å’Œ-sinkä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å†æ„å»ºä¸€äº›è¾…åŠ©æ–¹æ³•æ¯”å¦‚-new" class="admonition note">
<summary class="admonition-title">
<ol start="3">
<li>æˆ‘ä»¬çš„ ProstStream ç›®å‰å·²ç»å®ç°äº† Stream å’Œ Sinkï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå†æ„å»ºä¸€äº›è¾…åŠ©æ–¹æ³•ï¼Œæ¯”å¦‚ new()ï¼š </li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-3-æˆ‘ä»¬çš„-proststream-ç›®å‰å·²ç»å®ç°äº†-stream-å’Œ-sinkä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å†æ„å»ºä¸€äº›è¾…åŠ©æ–¹æ³•æ¯”å¦‚-new"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;S, In, Out&gt; ProstStream&lt;S, In, Out&gt;
where
    S: AsyncRead + AsyncWrite + Send + Unpin,
{
    /// åˆ›å»ºä¸€ä¸ª ProstStream
    pub fn new(stream: S) -&gt; Self {
        Self {
            stream,
            written: 0,
            wbuf: BytesMut::new(),
            rbuf: BytesMut::new(),
            _in: PhantomData::default(),
            _out: PhantomData::default(),
        }
    }
}

// ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬çš„ Stream æ˜¯ Unpinï¼Œæœ€å¥½å®ç°ä¸€ä¸‹
impl&lt;S, Req, Res&gt; Unpin for ProstStream&lt;S, Req, Res&gt; where S: Unpin {}
</code></pre></pre>
<hr />
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜ä¸ºå…¶å®ç° Unpin traitï¼Œè¿™ä¼šç»™åˆ«äººåœ¨ä½¿ç”¨ä½ çš„ä»£ç æ—¶å¸¦æ¥å¾ˆå¤šæ–¹ä¾¿ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸ºå¼‚æ­¥æ“ä½œè€Œåˆ›å»ºçš„æ•°æ®ç»“æ„ï¼Œå¦‚æœä½¿ç”¨äº†æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆåªè¦å†…éƒ¨æ²¡æœ‰è‡ªå¼•ç”¨æ•°æ®ï¼Œå°±åº”è¯¥å®ç° Unpinã€‚</p>
</div>
</details>
<h3 id="æµ‹è¯•"><a class="header" href="#æµ‹è¯•">æµ‹è¯•ï¼</a></h3>
<p>åˆåˆ°äº†é‡è¦çš„æµ‹è¯•ç¯èŠ‚ã€‚æˆ‘ä»¬éœ€è¦å†™ç‚¹æµ‹è¯•æ¥ç¡®ä¿ ProstStream èƒ½æ­£å¸¸å·¥ä½œã€‚å› ä¸ºä¹‹å‰åœ¨ src/network/frame.rs ä¸­å†™äº†ä¸ª DummyStreamï¼Œå®ç°äº† AsyncReadï¼Œæˆ‘ä»¬åªéœ€è¦æ‰©å±•å®ƒï¼Œè®©å®ƒå†å®ç°
AsyncWriteã€‚</p>
<details id="admonition-1-ä¸ºäº†è®©å®ƒå¯ä»¥è¢«å¤ç”¨æˆ‘ä»¬å°†å…¶ä»-framers-ä¸­ç§»å‡ºæ¥æ”¾åœ¨-srcnetworkmodrs-ä¸­å¹¶ä¿®æ”¹æˆä¸‹é¢çš„æ ·å­è®°å¾—åœ¨-framers-çš„æµ‹è¯•é‡Œ-use-æ–°çš„-dummystream" class="admonition note">
<summary class="admonition-title">
<ol>
<li>ä¸ºäº†è®©å®ƒå¯ä»¥è¢«å¤ç”¨ï¼Œæˆ‘ä»¬å°†å…¶ä» frame.rs ä¸­ç§»å‡ºæ¥ï¼Œæ”¾åœ¨ src/network/mod.rs ä¸­ï¼Œå¹¶ä¿®æ”¹æˆä¸‹é¢çš„æ ·å­ï¼ˆè®°å¾—åœ¨ frame.rs çš„æµ‹è¯•é‡Œ use æ–°çš„ DummyStreamï¼‰ï¼š </li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-1-ä¸ºäº†è®©å®ƒå¯ä»¥è¢«å¤ç”¨æˆ‘ä»¬å°†å…¶ä»-framers-ä¸­ç§»å‡ºæ¥æ”¾åœ¨-srcnetworkmodrs-ä¸­å¹¶ä¿®æ”¹æˆä¸‹é¢çš„æ ·å­è®°å¾—åœ¨-framers-çš„æµ‹è¯•é‡Œ-use-æ–°çš„-dummystream"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
pub mod utils {
    use bytes::{BufMut, BytesMut};
    use std::task::Poll;
    use tokio::io::{AsyncRead, AsyncWrite};

    pub struct DummyStream {
        pub buf: BytesMut,
    }

    impl AsyncRead for DummyStream {
        fn poll_read(
            self: std::pin::Pin&lt;&amp;mut Self&gt;,
            _cx: &amp;mut std::task::Context&lt;'_&gt;,
            buf: &amp;mut tokio::io::ReadBuf&lt;'_&gt;,
        ) -&gt; Poll&lt;std::io::Result&lt;()&gt;&gt; {
            let len = buf.capacity();
            let data = self.get_mut().buf.split_to(len);
            buf.put_slice(&amp;data);
            Poll::Ready(Ok(()))
        }
    }

    impl AsyncWrite for DummyStream {
        fn poll_write(
            self: std::pin::Pin&lt;&amp;mut Self&gt;,
            _cx: &amp;mut std::task::Context&lt;'_&gt;,
            buf: &amp;[u8],
        ) -&gt; Poll&lt;Result&lt;usize, std::io::Error&gt;&gt; {
            self.get_mut().buf.put_slice(buf);
            Poll::Ready(Ok(buf.len()))
        }

        fn poll_flush(
            self: std::pin::Pin&lt;&amp;mut Self&gt;,
            _cx: &amp;mut std::task::Context&lt;'_&gt;,
        ) -&gt; Poll&lt;Result&lt;(), std::io::Error&gt;&gt; {
            Poll::Ready(Ok(()))
        }

        fn poll_shutdown(
            self: std::pin::Pin&lt;&amp;mut Self&gt;,
            _cx: &amp;mut std::task::Context&lt;'_&gt;,
        ) -&gt; Poll&lt;Result&lt;(), std::io::Error&gt;&gt; {
            Poll::Ready(Ok(()))
        }
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-2-å¥½è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨-srcnetworkstreamrs-ä¸‹å†™ä¸ªæµ‹è¯•äº†" class="admonition note">
<summary class="admonition-title">
<ol start="2">
<li>å¥½ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ src/network/stream.rs ä¸‹å†™ä¸ªæµ‹è¯•äº†ï¼š </li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-å¥½è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨-srcnetworkstreamrs-ä¸‹å†™ä¸ªæµ‹è¯•äº†"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {
    use super::*;
    use crate::{utils::DummyStream, CommandRequest};
    use anyhow::Result;
    use futures::prelude::*;

    #[tokio::test]
    async fn prost_stream_should_work() -&gt; Result&lt;()&gt; {
        let buf = BytesMut::new();
        let stream = DummyStream { buf };
        let mut stream = ProstStream::&lt;_, CommandRequest, CommandRequest&gt;::new(stream);
        let cmd = CommandRequest::new_hdel(&quot;t1&quot;, &quot;k1&quot;);
        stream.send(cmd.clone()).await?;
        if let Some(Ok(s)) = stream.next().await {
            assert_eq!(s, cmd);
        } else {
            assert!(false);
        }
        Ok(())
    }
}
</code></pre></pre>
</div>
</details>
<ol start="3">
<li>è¿è¡Œ cargo test ï¼Œä¸€åˆ‡æµ‹è¯•é€šè¿‡ï¼ï¼ˆå¦‚æœä½ ç¼–è¯‘é”™è¯¯ï¼Œå¯èƒ½ç¼ºå°‘ use çš„é—®é¢˜ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹ï¼Œæˆ–è€…å‚è€ƒ GitHub ä¸Šçš„å®Œæ•´ä»£ç ï¼‰ã€‚</li>
</ol>
<h2 id="ä½¿ç”¨-proststream"><a class="header" href="#ä½¿ç”¨-proststream">ä½¿ç”¨ ProstStream</a></h2>
<details id="admonition-æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥è®©-prostserverstream-å’Œ-prostclientstream-ä½¿ç”¨æ–°å®šä¹‰çš„-proststream-äº†ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„å¯¹æ¯”çœ‹çœ‹äºŒè€…çš„åŒºåˆ«" class="admonition note">
<summary class="admonition-title">
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥è®© ProstServerStream å’Œ ProstClientStream ä½¿ç”¨æ–°å®šä¹‰çš„ ProstStream äº†ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„å¯¹æ¯”ï¼Œçœ‹çœ‹äºŒè€…çš„åŒºåˆ«ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥è®©-prostserverstream-å’Œ-prostclientstream-ä½¿ç”¨æ–°å®šä¹‰çš„-proststream-äº†ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„å¯¹æ¯”çœ‹çœ‹äºŒè€…çš„åŒºåˆ«"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// æ—§çš„æ¥å£
// pub struct ProstServerStream&lt;S&gt; {
//     inner: S,
//     service: Service,
// }

pub struct ProstServerStream&lt;S&gt; {
    inner: ProstStream&lt;S, CommandRequest, CommandResponse&gt;,
    service: Service,
}

// æ—§çš„æ¥å£
// pub struct ProstClientStream&lt;S&gt; {
//     inner: S,
// }

pub struct ProstClientStream&lt;S&gt; {
    inner: ProstStream&lt;S, CommandResponse, CommandRequest&gt;,
}
</code></pre></pre>
<blockquote>
<p>ç„¶ååˆ é™¤ send() / recv() å‡½æ•°ï¼Œå¹¶ä¿®æ”¹ process() / execute() å‡½æ•°ä½¿å…¶ä½¿ç”¨ next() æ–¹æ³•å’Œ send() æ–¹æ³•ã€‚ä¸»è¦çš„æ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
/// å¤„ç†æœåŠ¡å™¨ç«¯çš„æŸä¸ª accept ä¸‹æ¥çš„ socket çš„è¯»å†™
pub struct ProstServerStream&lt;S&gt; {
    inner: ProstStream&lt;S, CommandRequest, CommandResponse&gt;,
    service: Service,
}

/// å¤„ç†å®¢æˆ·ç«¯ socket çš„è¯»å†™
pub struct ProstClientStream&lt;S&gt; {
    inner: ProstStream&lt;S, CommandResponse, CommandRequest&gt;,
}

impl&lt;S&gt; ProstServerStream&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send,
{
    pub fn new(stream: S, service: Service) -&gt; Self {
        Self {
            inner: ProstStream::new(stream),
            service,
        }
    }

    pub async fn process(mut self) -&gt; Result&lt;(), KvError&gt; {
        let stream = &amp;mut self.inner;
        while let Some(Ok(cmd)) = stream.next().await {
            info!(&quot;Got a new command: {:?}&quot;, cmd);
            let res = self.service.execute(cmd);
            stream.send(res).await.unwrap();
        }

        Ok(())
    }
}

impl&lt;S&gt; ProstClientStream&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send,
{
    pub fn new(stream: S) -&gt; Self {
        Self {
            inner: ProstStream::new(stream),
        }
    }

    pub async fn execute(&amp;mut self, cmd: CommandRequest) -&gt; Result&lt;CommandResponse, KvError&gt; {
        let stream = &amp;mut self.inner;
        stream.send(cmd).await?;

        match stream.next().await {
            Some(v) =&gt; v,
            None =&gt; Err(KvError::Internal(&quot;Didn't get any response&quot;.into())),
        }
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-æµ‹è¯•" class="admonition success">
<summary class="admonition-title">
<p>æµ‹è¯•</p>
<p><a class="admonition-anchor-link" href="#admonition-æµ‹è¯•"></a></p>
</summary>
<div>
<p>å†æ¬¡è¿è¡Œ cargo test ï¼Œæ‰€æœ‰çš„æµ‹è¯•åº”è¯¥éƒ½èƒ½é€šè¿‡ã€‚åŒæ ·å¦‚æœæœ‰ç¼–è¯‘é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç¼ºå°‘äº†å¼•ç”¨ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</p>
<pre><code class="language-shell">RUST_LOG=info cargo run --bin kvs --quiet
</code></pre>
<p>ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</p>
<pre><code class="language-shell">RUST_LOG=info cargo run --bin kvc --quiet
</code></pre>
<p>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ä¸”å¤„ç†æ­£å¸¸ï¼</p>
</div>
</details>
<blockquote>
<p>æˆ‘ä»¬é‡æ„äº† ProstServerStream å’Œ ProstClientStream çš„ä»£ç ï¼Œä½¿å…¶å†…éƒ¨ä½¿ç”¨æ›´ç¬¦åˆ futures åº“é‡Œ Stream / Sink trait
çš„ç”¨æ³•ï¼Œæ•´ä½“ä»£ç æ”¹åŠ¨ä¸å°ï¼Œä½†æ˜¯å†…éƒ¨å®ç°çš„å˜æ›´å¹¶ä¸å½±å“ç³»ç»Ÿçš„å…¶å®ƒéƒ¨åˆ†ï¼è¿™ç®€ç›´å¤ªæ£’äº†ï¼</p>
</blockquote>
<h2 id="å¼‚æ­¥å¤„ç†å›é¡¾å•å…ƒæµ‹è¯•çš„é‡è¦æ€§"><a class="header" href="#å¼‚æ­¥å¤„ç†å›é¡¾å•å…ƒæµ‹è¯•çš„é‡è¦æ€§">å¼‚æ­¥å¤„ç†å›é¡¾ï¼šå•å…ƒæµ‹è¯•çš„é‡è¦æ€§</a></h2>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿›è¡Œé‡æ„æ¥æ”¹å–„æ—¢æœ‰ä»£ç çš„è´¨é‡æ˜¯å¿…ä¸å¯å°‘çš„ã€‚ä¹‹å‰åœ¨å¼€å‘ KV server çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸æ–­åœ°è¿›è¡Œä¸€äº›å°çš„é‡æ„ã€‚</p>
<p>æœ¬èŠ‚æˆ‘ä»¬åšäº†ä¸ªç¨å¾®å¤§ä¸€äº›çš„é‡æ„ï¼Œä¸ºå·²æœ‰çš„ä»£ç æä¾›æ›´åŠ ç¬¦åˆå¼‚æ­¥ IO æ¥å£çš„åŠŸèƒ½ã€‚</p>
<blockquote>
<p>ä»å¯¹å¤–ä½¿ç”¨çš„è§’åº¦æ¥è¯´ï¼Œå®ƒå¹¶æ²¡æœ‰æä¾›æˆ–è€…æ»¡è¶³ä»»ä½•é¢å¤–çš„éœ€æ±‚ï¼Œä½†æ˜¯ä»ä»£ç ç»“æ„å’Œè´¨é‡çš„è§’åº¦ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬çš„ ProstStream å¯ä»¥æ›´æ–¹ä¾¿å’Œæ›´ç›´è§‚åœ°è¢«å…¶å®ƒæ¥å£è°ƒç”¨ï¼Œä¹Ÿæ›´å®¹æ˜“è·Ÿæ•´ä¸ª Rust çš„ç°æœ‰ç”Ÿæ€ç»“åˆèµ·æ¥ã€‚</p>
</blockquote>
<p>ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆè‡ªç„¶åœ°è¿›è¡Œä»£ç é‡æ„ï¼Ÿè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æœ‰è¶³å¤Ÿçš„å•å…ƒæµ‹è¯•è¦†ç›–æ¥æ‰“åº•ã€‚</p>
<p>å°±åƒç”Ÿç‰©çš„è¿›åŒ–ä¸€æ ·ï¼Œå¥½çš„ä»£ç æ˜¯åœ¨è‰¯æ€§çš„é‡æ„ä¸­ä¸æ–­æ¼”è¿›å‡ºæ¥çš„ï¼Œè€Œè‰¯æ€§çš„é‡æ„ï¼Œæ˜¯åœ¨ä¼˜ç§€çš„å•å…ƒæµ‹è¯•çš„ç›‘ç®¡ä¸‹ï¼Œä½¿ä»£ç æœç€æ­£ç¡®æ–¹å‘è¿ˆå‡ºçš„æ­¥ä¼ã€‚åœ¨è¿™é‡Œï¼Œå•å…ƒæµ‹è¯•æ‰®æ¼”ç€ç”Ÿç‰©è¿›åŒ–ä¸­è‡ªç„¶ç¯å¢ƒçš„è§’è‰²ï¼ŒæŠŠé‡æ„è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¸€ä¸€æ‰¼æ€ã€‚</p>
<h2 id="æ€è€ƒé¢˜"><a class="header" href="#æ€è€ƒé¢˜">æ€è€ƒé¢˜</a></h2>
<p>ä¸ºä»€ä¹ˆåœ¨åˆ›å»º ProstStream æ—¶ï¼Œè¦åœ¨æ•°æ®ç»“æ„ä¸­æ”¾ wbuf / rbuf å’Œ written å­—æ®µï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½ç”¨å±€éƒ¨å˜é‡ï¼Ÿ</p>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="kv5_network_security.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="kv7_big_refactor.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="kv5_network_security.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="kv7_big_refactor.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
