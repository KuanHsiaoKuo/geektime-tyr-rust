<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>å®ç°å¹¶éªŒè¯åè®®å±‚ - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_3_0_trait_overview.html"><strong aria-hidden="true">4.2.3.1.</strong> traitæ¦‚è§ˆ</a></li><li class="chapter-item "><a href="2_3_1_trait_impl.html"><strong aria-hidden="true">4.2.3.2.</strong> Trait Impl</a></li><li class="chapter-item "><a href="2_3_2_trait_object.html"><strong aria-hidden="true">4.2.3.3.</strong> Trait Object</a></li><li class="chapter-item "><a href="2_3_3_trait_frequently.html"><strong aria-hidden="true">4.2.3.4.</strong> å¸¸ç”¨trait</a></li><li class="chapter-item "><a href="2_3_4_trait_design.html"><strong aria-hidden="true">4.2.3.5.</strong> Traitè®¾è®¡</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a></li><li class="chapter-item "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a></li><li class="chapter-item "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a></li><li class="chapter-item "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="4_1_macros_classify.html"><strong aria-hidden="true">4.4.1.</strong> å®åˆ†ç±»</a></li><li class="chapter-item "><a href="4_2_declarative_macros.html"><strong aria-hidden="true">4.4.2.</strong> å£°æ˜å®</a></li><li class="chapter-item "><a href="4_3_procedural_macros.html"><strong aria-hidden="true">4.4.3.</strong> è¿‡ç¨‹å®</a></li></ol></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item "><a href="5_2_future_async_await.html"><strong aria-hidden="true">4.5.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">4.5.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html" class="active"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="äºŒå®ç°å¹¶éªŒè¯åè®®å±‚"><a class="header" href="#äºŒå®ç°å¹¶éªŒè¯åè®®å±‚">äºŒã€å®ç°å¹¶éªŒè¯åè®®å±‚</a></h1>
<!--ts-->
<ul>
<li><a href="#%E4%BA%8C%E5%AE%9E%E7%8E%B0%E5%B9%B6%E9%AA%8C%E8%AF%81%E5%8D%8F%E8%AE%AE%E5%B1%82">äºŒã€å®ç°å¹¶éªŒè¯åè®®å±‚</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96">åˆ›å»ºé¡¹ç›®ï¼Œæ·»åŠ ä¾èµ–</a></li>
<li><a href="#protobuf%E5%A4%84%E7%90%86">protobufå¤„ç†</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E5%B9%B6%E9%AA%8C%E8%AF%81-storage-trait">å®ç°å¹¶éªŒè¯ Storage trait</a>
<ul>
<li><a href="#%E6%9E%84%E5%BB%BAmemtable">æ„å»ºMemTable</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95">æµ‹è¯•</a></li>
</ul>
</li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E5%B9%B6%E9%AA%8C%E8%AF%81-commandservice-trait">å®ç°å¹¶éªŒè¯ CommandService trait</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%BF%99%E4%B9%88%E5%86%99">ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Ÿ</a></li>
<li><a href="#%E5%9C%A8-srcpbmodrs-%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%9B%B8%E5%85%B3%E7%9A%84%E5%A4%96%E5%9B%B4%E9%80%BB%E8%BE%91">åœ¨ src/pb/mod.rs ä¸­æ·»åŠ ç›¸å…³çš„å¤–å›´é€»è¾‘</a></li>
</ul>
</li>
<li><a href="#%E6%9C%80%E5%90%8E%E7%9A%84%E6%8B%BC%E5%9B%BEservice-%E7%BB%93%E6%9E%84%E7%9A%84%E5%AE%9E%E7%8E%B0">æœ€åçš„æ‹¼å›¾ï¼šService ç»“æ„çš„å®ç°</a>
<ul>
<li><a href="#%E5%9B%B4%E7%BB%95%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95">å›´ç»•æ¥å£æµ‹è¯•</a></li>
<li><a href="#%E7%BB%A7%E7%BB%AD%E5%86%99%E4%BB%A3%E7%A0%81">ç»§ç»­å†™ä»£ç </a></li>
</ul>
</li>
<li><a href="#%E6%96%B0%E7%9A%84-server">æ–°çš„ server</a></li>
<li><a href="#%E8%BF%90%E8%A1%8C">è¿è¡Œ</a></li>
<li><a href="#%E5%88%9D%E6%AD%A5%E6%84%9F%E5%8F%97rust%E6%92%B0%E5%86%99%E4%BB%A3%E7%A0%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">åˆæ­¥æ„Ÿå—Rustæ’°å†™ä»£ç æœ€ä½³å®è·µ</a></li>
<li><a href="#%E4%B8%BA%E5%89%A9%E4%B8%8B6%E4%B8%AA%E5%91%BD%E4%BB%A4%E6%9E%84%E5%BB%BA%E6%B5%8B%E8%AF%95%E5%B9%B6%E5%AE%9E%E7%8E%B0">ä¸ºå‰©ä¸‹6ä¸ªå‘½ä»¤æ„å»ºæµ‹è¯•å¹¶å®ç°</a></li>
<li><a href="#%E8%80%83%E8%99%91%E7%94%A8%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%A4%84%E7%90%86%E5%B9%B6%E5%8F%91">è€ƒè™‘ç”¨çº¿ç¨‹æ± å¤„ç†å¹¶å‘</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Tue Oct 18 14:01:46 UTC 2022 -->
<!--te-->
<p>è¿˜æ˜¯æŒ‰ç…§ä¸Šä¸€è®²å®šä¹‰æ¥å£çš„é¡ºåºæ¥ä¸€ä¸ªä¸€ä¸ªæµ‹è¯•ï¼šé¦–å…ˆæˆ‘ä»¬æ¥æ„å»ºåè®®å±‚ã€‚</p>
<h2 id="åˆ›å»ºé¡¹ç›®æ·»åŠ ä¾èµ–"><a class="header" href="#åˆ›å»ºé¡¹ç›®æ·»åŠ ä¾èµ–">åˆ›å»ºé¡¹ç›®ï¼Œæ·»åŠ ä¾èµ–</a></h2>
<details id="admonition-ç¬”è®°" class="admonition note">
<summary class="admonition-title">
<p>ç¬”è®°ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-ç¬”è®°"></a></p>
</summary>
<div>
<ol>
<li>å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼šcargo new kv â€“lib</li>
<li>è¿›å…¥åˆ°é¡¹ç›®ç›®å½•ï¼Œåœ¨ Cargo.toml ä¸­æ·»åŠ ä¾èµ–ï¼š</li>
</ol>
<pre><code class="language-toml">[package]
name = &quot;kv&quot;
version = &quot;0.1.0&quot;
edition = &quot;2018&quot;

[dependencies]
bytes = &quot;1&quot; # é«˜æ•ˆå¤„ç†ç½‘ç»œ buffer çš„åº“
prost = &quot;0.8&quot; # å¤„ç† protobuf çš„ä»£ç 
tracing = &quot;0.1&quot; # æ—¥å¿—å¤„ç†

[dev-dependencies]
anyhow = &quot;1&quot; # é”™è¯¯å¤„ç†
async-prost = &quot;0.2.1&quot; # æ”¯æŒæŠŠ protobuf å°è£…æˆ TCP frame
futures = &quot;0.3&quot; # æä¾› Stream trait
tokio = { version = &quot;1&quot;, features = [&quot;rt&quot;, &quot;rt-multi-thread&quot;, &quot;io-util&quot;, &quot;macros&quot;, &quot;net&quot; ] } # å¼‚æ­¥ç½‘ç»œåº“
tracing-subscriber = &quot;0.2&quot; # æ—¥å¿—å¤„ç†

[build-dependencies]
prost-build = &quot;0.8&quot; # ç¼–è¯‘ protobuf
</code></pre>
</div>
</details>
<h2 id="protobufå¤„ç†"><a class="header" href="#protobufå¤„ç†">protobufå¤„ç†</a></h2>
<p>ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º abi.protoï¼ŒæŠŠä¸Šæ–‡ä¸­ protobuf çš„ä»£ç æ”¾è¿›å»ã€‚</p>
<details id="admonition-åœ¨æ ¹ç›®å½•ä¸‹å†åˆ›å»º-buildrs" class="admonition note">
<summary class="admonition-title">
<p>åœ¨æ ¹ç›®å½•ä¸‹ï¼Œå†åˆ›å»º build.rs</p>
<p><a class="admonition-anchor-link" href="#admonition-åœ¨æ ¹ç›®å½•ä¸‹å†åˆ›å»º-buildrs"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let mut config = prost_build::Config::new();
    config.bytes(&amp;[&quot;.&quot;]);
    config.type_attribute(&quot;.&quot;, &quot;#[derive(PartialOrd)]&quot;);
    config
        .out_dir(&quot;src/pb&quot;)
        .compile_protos(&amp;[&quot;abi.proto&quot;], &amp;[&quot;.&quot;])
        .unwrap();
}
</code></pre></pre>
<ol>
<li>è¿™é‡Œæˆ‘ä»¬ä¸ºç¼–è¯‘å‡ºæ¥çš„ä»£ç é¢å¤–æ·»åŠ äº†ä¸€äº›å±æ€§ã€‚æ¯”å¦‚ä¸º protobuf çš„ bytes ç±»å‹ç”Ÿæˆ Bytes è€Œéç¼ºçœçš„ Vec<u8>ï¼Œä¸ºæ‰€æœ‰ç±»å‹åŠ å…¥ PartialOrd æ´¾ç”Ÿå®ã€‚</li>
<li>å…³äº prost-build çš„æ‰©å±•ï¼Œä½ å¯ä»¥çœ‹<a href="https://docs.rs/prost-build/0.8.0/prost_build/struct.Config.html">æ–‡æ¡£</a>ã€‚</li>
</ol>
</div>
</details>
<blockquote>
<p>è®°å¾—åˆ›å»º src/pb ç›®å½•ï¼Œå¦åˆ™ç¼–ä¸è¿‡ã€‚</p>
</blockquote>
<p>ç°åœ¨ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åš cargo build ä¼šç”Ÿæˆ src/pb/abi.rs æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«æ‰€æœ‰ protobuf å®šä¹‰çš„æ¶ˆæ¯çš„ Rust æ•°æ®ç»“æ„ã€‚</p>
<details id="admonition-æˆ‘ä»¬åˆ›å»º-srcpbmodrså¼•å…¥-abirså¹¶åšä¸€äº›åŸºæœ¬çš„ç±»å‹è½¬æ¢" class="admonition note">
<summary class="admonition-title">
<p>æˆ‘ä»¬åˆ›å»º src/pb/mod.rsï¼Œå¼•å…¥ abi.rsï¼Œå¹¶åšä¸€äº›åŸºæœ¬çš„ç±»å‹è½¬æ¢</p>
<p><a class="admonition-anchor-link" href="#admonition-æˆ‘ä»¬åˆ›å»º-srcpbmodrså¼•å…¥-abirså¹¶åšä¸€äº›åŸºæœ¬çš„ç±»å‹è½¬æ¢"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub mod abi;

use abi::{command_request::RequestData, *};

impl CommandRequest {
    /// åˆ›å»º HSET å‘½ä»¤
    pub fn new_hset(table: impl Into&lt;String&gt;, key: impl Into&lt;String&gt;, value: Value) -&gt; Self {
        Self {
            request_data: Some(RequestData::Hset(Hset {
                table: table.into(),
                pair: Some(Kvpair::new(key, value)),
            })),
        }
    }
}

impl Kvpair {
    /// åˆ›å»ºä¸€ä¸ªæ–°çš„ kv pair
    pub fn new(key: impl Into&lt;String&gt;, value: Value) -&gt; Self {
        Self {
            key: key.into(),
            value: Some(value),
        }
    }
}

/// ä» String è½¬æ¢æˆ Value
impl From&lt;String&gt; for Value {
    fn from(s: String) -&gt; Self {
        Self {
            value: Some(value::Value::String(s)),
        }
    }
}

/// ä» &amp;str è½¬æ¢æˆ Value
impl From&lt;&amp;str&gt; for Value {
    fn from(s: &amp;str) -&gt; Self {
        Self {
            value: Some(value::Value::String(s.into())),
        }
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-æœ€ååœ¨-srclibrs-ä¸­å¼•å…¥-pb-æ¨¡å—" class="admonition note">
<summary class="admonition-title">
<p>æœ€åï¼Œåœ¨ src/lib.rs ä¸­ï¼Œå¼•å…¥ pb æ¨¡å— </p>
<p><a class="admonition-anchor-link" href="#admonition-æœ€ååœ¨-srclibrs-ä¸­å¼•å…¥-pb-æ¨¡å—"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">mod pb;

pub use pb::abi::*;
</code></pre></pre>
</div>
</details>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æœ‰äº†èƒ½æŠŠ KV server æœ€åŸºæœ¬çš„ protobuf æ¥å£è¿è½¬èµ·æ¥çš„ä»£ç ã€‚</p>
<details id="admonition-ä½¿ç”¨ç¤ºä¾‹examples" class="admonition example">
<summary class="admonition-title">
<p>ä½¿ç”¨ç¤ºä¾‹ï¼šexamples</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½¿ç”¨ç¤ºä¾‹examples"></a></p>
</summary>
<div>
<p>åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º examplesï¼Œè¿™æ ·å¯ä»¥å†™ä¸€äº›ä»£ç æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åè®®ã€‚</p>
<ol>
<li>æˆ‘ä»¬å¯ä»¥å…ˆåˆ›å»ºä¸€ä¸ª examples/client.rs æ–‡ä»¶ï¼Œå†™å…¥å¦‚ä¸‹ä»£ç ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use async_prost::AsyncProstStream;
use futures::prelude::*;
use kv::{CommandRequest, CommandResponse};
use tokio::net::TcpStream;
use tracing::info;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();

    let addr = &quot;127.0.0.1:9527&quot;;
    // è¿æ¥æœåŠ¡å™¨
    let stream = TcpStream::connect(addr).await?;

    // ä½¿ç”¨ AsyncProstStream æ¥å¤„ç† TCP Frame
    let mut client =
        AsyncProstStream::&lt;_, CommandResponse, CommandRequest, _&gt;::from(stream).for_async();

    // ç”Ÿæˆä¸€ä¸ª HSET å‘½ä»¤
    let cmd = CommandRequest::new_hset(&quot;table1&quot;, &quot;hello&quot;, &quot;world&quot;.into());

    // å‘é€ HSET å‘½ä»¤
    client.send(cmd).await?;
    if let Some(Ok(data)) = client.next().await {
        info!(&quot;Got response {:?}&quot;, data);
    }

    Ok(())
}
</code></pre></pre>
<p>è¿™æ®µä»£ç è¿æ¥æœåŠ¡å™¨çš„ 9527 ç«¯å£ï¼Œå‘é€ä¸€ä¸ª HSET å‘½ä»¤å‡ºå»ï¼Œç„¶åç­‰å¾…æœåŠ¡å™¨çš„å“åº”ã€‚</p>
<ol start="2">
<li>åŒæ ·çš„ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª examples/dummy_server.rs æ–‡ä»¶ï¼Œå†™å…¥ä»£ç ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use async_prost::AsyncProstStream;
use futures::prelude::*;
use kv::{CommandRequest, CommandResponse};
use tokio::net::TcpListener;
use tracing::info;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();
    let addr = &quot;127.0.0.1:9527&quot;;
    let listener = TcpListener::bind(addr).await?;
    info!(&quot;Start listening on {}&quot;, addr);
    loop {
        let (stream, addr) = listener.accept().await?;
        info!(&quot;Client {:?} connected&quot;, addr);
        tokio::spawn(async move {
            let mut stream =
                AsyncProstStream::&lt;_, CommandRequest, CommandResponse, _&gt;::from(stream).for_async();
            while let Some(Ok(msg)) = stream.next().await {
                info!(&quot;Got a new command: {:?}&quot;, msg);
                // åˆ›å»ºä¸€ä¸ª 404 response è¿”å›ç»™å®¢æˆ·ç«¯
                let mut resp = CommandResponse::default();
                resp.status = 404;
                resp.message = &quot;Not found&quot;.to_string();
                stream.send(resp).await.unwrap();
            }
            info!(&quot;Client {:?} disconnected&quot;, addr);
        });
    }
}
</code></pre></pre>
</div>
</details>
<p>åœ¨è¿™æ®µä»£ç é‡Œï¼ŒæœåŠ¡å™¨ç›‘å¬ 9527 ç«¯å£ï¼Œå¯¹ä»»ä½•å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¸€å¾‹è¿”å› status = 404ï¼Œmessage æ˜¯ â€œNot foundâ€ çš„å“åº”ã€‚</p>
<p>å¦‚æœä½ å¯¹è¿™ä¸¤æ®µä»£ç ä¸­çš„å¼‚æ­¥å’Œç½‘ç»œå¤„ç†åŠæ‡‚ä¸æ‡‚ï¼Œæ²¡å…³ç³»ï¼Œä½ å…ˆæŠŠä»£ç æŠ„ä¸‹æ¥è¿è¡Œã€‚ä»Šå¤©çš„å†…å®¹è·Ÿç½‘ç»œæ— å…³ï¼Œä½ é‡ç‚¹çœ‹å¤„ç†æµç¨‹å°±è¡Œã€‚æœªæ¥ä¼šè®²åˆ°ç½‘ç»œå’Œå¼‚æ­¥å¤„ç†çš„ã€‚</p>
<details id="admonition-è¿è¡Œæµ‹è¯•" class="admonition success">
<summary class="admonition-title">
<p>è¿è¡Œæµ‹è¯• </p>
<p><a class="admonition-anchor-link" href="#admonition-è¿è¡Œæµ‹è¯•"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</p>
<pre><code class="language-shell">RUST_LOG=info cargo run --example dummy_server --quietã€‚
</code></pre>
<p>ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">RUST_LOG=info cargo run --example client --quiet
</code></pre></pre>
<p>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œåè®®å±‚çœ‹ä¸Šå»è¿ä½œè‰¯å¥½ã€‚ä¸€æ—¦éªŒè¯é€šè¿‡ï¼Œå°±ä½ å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œå› ä¸ºåè®®å±‚çš„å…¶å®ƒä»£ç éƒ½åªæ˜¯å·¥ä½œé‡è€Œå·²ï¼Œåœ¨ä¹‹åéœ€è¦çš„æ—¶å€™å¯ä»¥æ…¢æ…¢å®ç°ã€‚</p>
</div>
</details>
<h2 id="å®ç°å¹¶éªŒè¯-storage-trait"><a class="header" href="#å®ç°å¹¶éªŒè¯-storage-trait">å®ç°å¹¶éªŒè¯ Storage trait</a></h2>
<p>æ¥ä¸‹æ¥æ„å»º Storage traitã€‚</p>
<p>æˆ‘ä»¬ä¸Šä¸€è®²è°ˆåˆ°äº†å¦‚ä½•ä½¿ç”¨åµŒå¥—çš„æ”¯æŒå¹¶å‘çš„ im-memory HashMap æ¥å®ç° storage traitã€‚ç”±äº Arc&lt;RwLock&lt;HashMap&lt;K, V&gt;&gt;&gt; è¿™æ ·çš„æ”¯æŒå¹¶å‘çš„ HashMap æ˜¯ä¸€ä¸ªåˆšéœ€ï¼ŒRust
ç”Ÿæ€æœ‰å¾ˆå¤šç›¸å…³çš„ crate æ”¯æŒï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ dashmap åˆ›å»ºä¸€ä¸ª MemTable ç»“æ„ï¼Œæ¥å®ç° Storage traitã€‚</p>
<details id="admonition-å®ç°" class="admonition note">
<summary class="admonition-title">
<p>å®ç° </p>
<p><a class="admonition-anchor-link" href="#admonition-å®ç°"></a></p>
</summary>
<div>
<ol>
<li>å…ˆåˆ›å»º src/storage ç›®å½•</li>
<li>ç„¶ååˆ›å»º src/storage/mod.rsï¼ŒæŠŠåˆšæ‰è®¨è®ºçš„ trait ä»£ç æ”¾è¿›å»å</li>
<li>åœ¨ src/lib.rs ä¸­å¼•å…¥ â€œmod storageâ€ã€‚æ­¤æ—¶ä¼šå‘ç°ä¸€ä¸ªé”™è¯¯ï¼šå¹¶æœªå®šä¹‰ KvErrorã€‚</li>
<li>åˆ›å»º src/error.rsï¼Œä½¿ç”¨<a href="https://github.com/dtolnay/thiserror">thiserror</a>çš„æ´¾ç”Ÿå®è‡ªå®šä¹‰é”™è¯¯ç±»å‹ï¼Œç„¶åå¡«å…¥ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use crate::Value;
use thiserror::Error;

#[derive(Error, Debug, PartialEq)]
pub enum KvError {
    #[error(&quot;Not found for table: {0}, key: {1}&quot;)]
    NotFound(String, String),

    #[error(&quot;Cannot parse command: `{0}`&quot;)]
    InvalidCommand(String),
    #[error(&quot;Cannot convert value {:0} to {1}&quot;)]
    ConvertError(Value, &amp;'static str),
    #[error(&quot;Cannot process command {0} with table: {1}, key: {2}. Error: {}&quot;)]
    StorageError(&amp;'static str, String, String, String),

    #[error(&quot;Failed to encode protobuf message&quot;)]
    EncodeError(#[from] prost::EncodeError),
    #[error(&quot;Failed to decode protobuf message&quot;)]
    DecodeError(#[from] prost::DecodeError),

    #[error(&quot;Internal error: {0}&quot;)]
    Internal(String),
}
</code></pre></pre>
<p>è¿™äº› error çš„å®šä¹‰å…¶å®æ˜¯åœ¨å®ç°è¿‡ç¨‹ä¸­é€æ­¥æ·»åŠ çš„ï¼Œä½†ä¸ºäº†è®²è§£æ–¹ä¾¿ï¼Œå…ˆä¸€æ¬¡æ€§æ·»åŠ ã€‚å¯¹äº Storage çš„å®ç°ï¼Œæˆ‘ä»¬åªå…³å¿ƒ StorageErrorï¼Œå…¶å®ƒçš„ error å®šä¹‰æœªæ¥ä¼šç”¨åˆ°ã€‚</p>
<ol start="5">
<li>åŒæ ·ï¼Œåœ¨ src/lib.rs ä¸‹å¼•å…¥ mod errorï¼Œç°åœ¨ src/lib.rs æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
mod error;
mod pb;
mod storage;

pub use error::KvError;
pub use pb::abi::*;
pub use storage::*;
</code></pre></pre>
<p>src/storage/mod.rs æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use crate::{KvError, Kvpair, Value};

/// å¯¹å­˜å‚¨çš„æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒæ•°æ®å­˜åœ¨å“ªå„¿ï¼Œä½†éœ€è¦å®šä¹‰å¤–ç•Œå¦‚ä½•å’Œå­˜å‚¨æ‰“äº¤é“
pub trait Storage {
    /// ä»ä¸€ä¸ª HashTable é‡Œè·å–ä¸€ä¸ª key çš„ value
    fn get(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;
    /// ä»ä¸€ä¸ª HashTable é‡Œè®¾ç½®ä¸€ä¸ª key çš„ valueï¼Œè¿”å›æ—§çš„ value
    fn set(&amp;self, table: &amp;str, key: String, value: Value) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;
    /// æŸ¥çœ‹ HashTable ä¸­æ˜¯å¦æœ‰ key
    fn contains(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;bool, KvError&gt;;
    /// ä» HashTable ä¸­åˆ é™¤ä¸€ä¸ª key
    fn del(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt;;
    /// éå† HashTableï¼Œè¿”å›æ‰€æœ‰ kv pairï¼ˆè¿™ä¸ªæ¥å£ä¸å¥½ï¼‰
    fn get_all(&amp;self, table: &amp;str) -&gt; Result&lt;Vec&lt;Kvpair&gt;, KvError&gt;;
    /// éå† HashTableï¼Œè¿”å› kv pair çš„ Iterator
    fn get_iter(&amp;self, table: &amp;str) -&gt; Result&lt;Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt;, KvError&gt;;
}
</code></pre></pre>
</div>
</details>
<details id="admonition-æˆåŠŸ-é€šè¿‡-storage-trait-å·²ç»å¤§æ¦‚çŸ¥é“-memtable-æ€ä¹ˆç”¨æ‰€ä»¥å¯ä»¥å…ˆå†™æ®µæµ‹è¯•ä½“éªŒä¸€ä¸‹" class="admonition success">
<summary class="admonition-title">
<p>æˆåŠŸï¼š é€šè¿‡ Storage trait å·²ç»å¤§æ¦‚çŸ¥é“ MemTable æ€ä¹ˆç”¨ï¼Œæ‰€ä»¥å¯ä»¥å…ˆå†™æ®µæµ‹è¯•ä½“éªŒä¸€ä¸‹ </p>
<p><a class="admonition-anchor-link" href="#admonition-æˆåŠŸ-é€šè¿‡-storage-trait-å·²ç»å¤§æ¦‚çŸ¥é“-memtable-æ€ä¹ˆç”¨æ‰€ä»¥å¯ä»¥å…ˆå†™æ®µæµ‹è¯•ä½“éªŒä¸€ä¸‹"></a></p>
</summary>
<div>
<p>ä»£ç ç›®å‰æ²¡æœ‰ç¼–è¯‘é”™è¯¯ï¼Œå¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶æœ«å°¾æ·»åŠ æµ‹è¯•ä»£ç ï¼Œå°è¯•ä½¿ç”¨è¿™äº›æ¥å£äº†ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ„å»º MemTableï¼Œä½†é€šè¿‡ Storage trait å·²ç»å¤§æ¦‚çŸ¥é“ MemTable æ€ä¹ˆç”¨ï¼Œæ‰€ä»¥å¯ä»¥å…ˆå†™æ®µæµ‹è¯•ä½“éªŒä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn memtable_basic_interface_should_work() {
        let store = MemTable::new();
        test_basi_interface(store);
    }

    #[test]
    fn memtable_get_all_should_work() {
        let store = MemTable::new();
        test_get_all(store);
    }

    fn test_basi_interface(store: impl Storage) {
        // ç¬¬ä¸€æ¬¡ set ä¼šåˆ›å»º tableï¼Œæ’å…¥ key å¹¶è¿”å› Noneï¼ˆä¹‹å‰æ²¡å€¼ï¼‰
        let v = store.set(&quot;t1&quot;, &quot;hello&quot;.into(), &quot;world&quot;.into());
        assert!(v.unwrap().is_none());
        // å†æ¬¡ set åŒæ ·çš„ key ä¼šæ›´æ–°ï¼Œå¹¶è¿”å›ä¹‹å‰çš„å€¼
        let v1 = store.set(&quot;t1&quot;, &quot;hello&quot;.into(), &quot;world1&quot;.into());
        assert_eq!(v1, Ok(Some(&quot;world&quot;.into())));

        // get å­˜åœ¨çš„ key ä¼šå¾—åˆ°æœ€æ–°çš„å€¼
        let v = store.get(&quot;t1&quot;, &quot;hello&quot;);
        assert_eq!(v, Ok(Some(&quot;world1&quot;.into())));

        // get ä¸å­˜åœ¨çš„ key æˆ–è€… table ä¼šå¾—åˆ° None
        assert_eq!(Ok(None), store.get(&quot;t1&quot;, &quot;hello1&quot;));
        assert!(store.get(&quot;t2&quot;, &quot;hello1&quot;).unwrap().is_none());

        // contains çº¯åœ¨çš„ key è¿”å› trueï¼Œå¦åˆ™ false
        assert_eq!(store.contains(&quot;t1&quot;, &quot;hello&quot;), Ok(true));
        assert_eq!(store.contains(&quot;t1&quot;, &quot;hello1&quot;), Ok(false));
        assert_eq!(store.contains(&quot;t2&quot;, &quot;hello&quot;), Ok(false));

        // del å­˜åœ¨çš„ key è¿”å›ä¹‹å‰çš„å€¼
        let v = store.del(&quot;t1&quot;, &quot;hello&quot;);
        assert_eq!(v, Ok(Some(&quot;world1&quot;.into())));

        // del ä¸å­˜åœ¨çš„ key æˆ– table è¿”å› None
        assert_eq!(Ok(None), store.del(&quot;t1&quot;, &quot;hello1&quot;));
        assert_eq!(Ok(None), store.del(&quot;t2&quot;, &quot;hello&quot;));
    }

    fn test_get_all(store: impl Storage) {
        store.set(&quot;t2&quot;, &quot;k1&quot;.into(), &quot;v1&quot;.into()).unwrap();
        store.set(&quot;t2&quot;, &quot;k2&quot;.into(), &quot;v2&quot;.into()).unwrap();
        let mut data = store.get_all(&quot;t2&quot;).unwrap();
        data.sort_by(|a, b| a.partial_cmp(b).unwrap());
        assert_eq!(
            data,
            vec![
                Kvpair::new(&quot;k1&quot;, &quot;v1&quot;.into()),
                Kvpair::new(&quot;k2&quot;, &quot;v2&quot;.into())
            ]
        )
    }

    fn test_get_iter(store: impl Storage) {
        store.set(&quot;t2&quot;, &quot;k1&quot;.into(), &quot;v1&quot;.into()).unwrap();
        store.set(&quot;t2&quot;, &quot;k2&quot;.into(), &quot;v2&quot;.into()).unwrap();
        let mut data: Vec&lt;_&gt; = store.get_iter(&quot;t2&quot;).unwrap().collect();
        data.sort_by(|a, b| a.partial_cmp(b).unwrap());
        assert_eq!(
            data,
            vec![
                Kvpair::new(&quot;k1&quot;, &quot;v1&quot;.into()),
                Kvpair::new(&quot;k2&quot;, &quot;v2&quot;.into())
            ]
        )
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-è¿™ç§åœ¨å†™å®ç°ä¹‹å‰å†™å•å…ƒæµ‹è¯•æ˜¯æ ‡å‡†çš„-tddtest-driven-developmentæ–¹å¼" class="admonition quote">
<summary class="admonition-title">
<p>è¿™ç§åœ¨å†™å®ç°ä¹‹å‰å†™å•å…ƒæµ‹è¯•ï¼Œæ˜¯æ ‡å‡†çš„ TDDï¼ˆTest-Driven Developmentï¼‰æ–¹å¼ã€‚ </p>
<p><a class="admonition-anchor-link" href="#admonition-è¿™ç§åœ¨å†™å®ç°ä¹‹å‰å†™å•å…ƒæµ‹è¯•æ˜¯æ ‡å‡†çš„-tddtest-driven-developmentæ–¹å¼"></a></p>
</summary>
<div>
<p>è¿™ç§åœ¨å†™å®ç°ä¹‹å‰å†™å•å…ƒæµ‹è¯•ï¼Œæ˜¯æ ‡å‡†çš„ TDDï¼ˆTest-Driven Developmentï¼‰æ–¹å¼ã€‚</p>
<p>æˆ‘ä¸ªäººä¸æ˜¯ TDD çš„ç‹‚çƒ­ç²‰ä¸ï¼Œä½†ä¼šåœ¨æ„å»ºå®Œ trait åï¼Œä¸ºè¿™ä¸ª trait æ’°å†™æµ‹è¯•ä»£ç ï¼Œå› ä¸ºå†™æµ‹è¯•ä»£ç æ˜¯ä¸ªå¾ˆå¥½çš„éªŒè¯æ¥å£æ˜¯å¦å¥½ç”¨çš„æ—¶æœºã€‚æ¯•ç«Ÿæˆ‘ä»¬ä¸å¸Œæœ›å®ç° trait ä¹‹åï¼Œæ‰å‘ç° trait çš„å®šä¹‰æœ‰ç‘•ç–µï¼Œéœ€è¦ä¿®æ”¹ï¼Œè¿™ä¸ªæ—¶å€™æ”¹åŠ¨çš„ä»£ä»·å°±æ¯”è¾ƒå¤§äº†ã€‚</p>
<p>æ‰€ä»¥ï¼Œå½“ trait æ¨æ•²å®Œæ¯•ï¼Œå°±å¯ä»¥å¼€å§‹å†™ä½¿ç”¨ trait çš„æµ‹è¯•ä»£ç äº†ã€‚åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä»”ç»†æ„Ÿå—ï¼Œå¦‚æœå†™æµ‹è¯•ç”¨ä¾‹æ—¶ç”¨å¾—ä¸èˆ’æœï¼Œæˆ–è€…ä¸ºäº†ä½¿ç”¨å®ƒéœ€è¦åšå¾ˆå¤šç¹ççš„æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥é‡æ–°å®¡è§† trait çš„è®¾è®¡ã€‚</p>
<p>ä½ å¦‚æœä»”ç»†çœ‹å•å…ƒæµ‹è¯•çš„ä»£ç ï¼Œå°±ä¼šå‘ç°æˆ‘å§‹ç»ˆç§‰æŒæµ‹è¯• trait æ¥å£çš„æ€æƒ³ã€‚å°½ç®¡åœ¨æµ‹è¯•ä¸­éœ€è¦ä¸€ä¸ªå®é™…çš„æ•°æ®ç»“æ„è¿›è¡Œ trait æ–¹æ³•çš„æµ‹è¯•ï¼Œä½†æ ¸å¿ƒçš„æµ‹è¯•ä»£ç éƒ½ç”¨çš„æ³›å‹å‡½æ•°ï¼Œè®©è¿™äº›ä»£ç åªè·Ÿ trait ç›¸å…³ã€‚</p>
<p>è¿™æ ·:</p>
<ul>
<li>ä¸€æ¥å¯ä»¥é¿å…æŸä¸ªå…·ä½“ trait å®ç°çš„å¹²æ‰°</li>
<li>äºŒæ¥åœ¨ä¹‹åæƒ³åŠ å…¥æ›´å¤š trait å®ç°æ—¶ï¼Œå¯ä»¥å…±äº«æµ‹è¯•ä»£ç ã€‚</li>
<li>æ¯”å¦‚æœªæ¥æƒ³æ”¯æŒ DiskTableï¼Œé‚£ä¹ˆåªæ¶ˆåŠ å‡ ä¸ªæµ‹è¯•ä¾‹ï¼Œè°ƒç”¨å·²æœ‰çš„æ³›å‹å‡½æ•°å³å¯ã€‚</li>
</ul>
</div>
</details>
<p>å¥½ï¼Œæå®šæµ‹è¯•ï¼Œç¡®è®¤ trait è®¾è®¡æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬æ¥å†™å…·ä½“å®ç°ã€‚</p>
<h3 id="æ„å»ºmemtable"><a class="header" href="#æ„å»ºmemtable">æ„å»ºMemTable</a></h3>
<details id="admonition-å¯ä»¥åˆ›å»º-srcstoragememoryrs-æ¥æ„å»º-memtable" class="admonition note">
<summary class="admonition-title">
<p>å¯ä»¥åˆ›å»º src/storage/memory.rs æ¥æ„å»º MemTableï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-å¯ä»¥åˆ›å»º-srcstoragememoryrs-æ¥æ„å»º-memtable"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use crate::{KvError, Kvpair, Storage, Value};
use dashmap::{mapref::one::Ref, DashMap};

/// ä½¿ç”¨ DashMap æ„å»ºçš„ MemTableï¼Œå®ç°äº† Storage trait
#[derive(Clone, Debug, Default)]
pub struct MemTable {
    tables: DashMap&lt;String, DashMap&lt;String, Value&gt;&gt;,
}

impl MemTable {
    /// åˆ›å»ºä¸€ä¸ªç¼ºçœçš„ MemTable
    pub fn new() -&gt; Self {
        Self::default()
    }

    /// å¦‚æœåä¸º name çš„ hash table ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºï¼Œå¦åˆ™è¿”å›
    fn get_or_create_table(&amp;self, name: &amp;str) -&gt; Ref&lt;String, DashMap&lt;String, Value&gt;&gt; {
        match self.tables.get(name) {
            Some(table) =&gt; table,
            None =&gt; {
                let entry = self.tables.entry(name.into()).or_default();
                entry.downgrade()
            }
        }
    }
}

impl Storage for MemTable {
    fn get(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt; {
        let table = self.get_or_create_table(table);
        Ok(table.get(key).map(|v| v.value().clone()))
    }

    fn set(&amp;self, table: &amp;str, key: String, value: Value) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt; {
        let table = self.get_or_create_table(table);
        Ok(table.insert(key, value))
    }

    fn contains(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;bool, KvError&gt; {
        let table = self.get_or_create_table(table);
        Ok(table.contains_key(key))
    }

    fn del(&amp;self, table: &amp;str, key: &amp;str) -&gt; Result&lt;Option&lt;Value&gt;, KvError&gt; {
        let table = self.get_or_create_table(table);
        Ok(table.remove(key).map(|(_k, v)| v))
    }

    fn get_all(&amp;self, table: &amp;str) -&gt; Result&lt;Vec&lt;Kvpair&gt;, KvError&gt; {
        let table = self.get_or_create_table(table);
        Ok(table
            .iter()
            .map(|v| Kvpair::new(v.key(), v.value().clone()))
            .collect())
    }

    fn get_iter(&amp;self, _table: &amp;str) -&gt; Result&lt;Box&lt;dyn Iterator&lt;Item = Kvpair&gt;&gt;, KvError&gt; {
        todo!()
    }
}
</code></pre></pre>
<ol>
<li>
<p>é™¤äº† get_iter() å¤–ï¼Œè¿™ä¸ªå®ç°ä»£ç éå¸¸ç®€å•ï¼Œç›¸ä¿¡ä½ çœ‹ä¸€ä¸‹ dashmap çš„æ–‡æ¡£ï¼Œä¹Ÿèƒ½å¾ˆå¿«å†™å‡ºæ¥ã€‚</p>
</li>
<li>
<p>get_iter() å†™èµ·æ¥ç¨å¾®æœ‰äº›éš¾åº¦ï¼Œæˆ‘ä»¬å…ˆæ”¾ä¸‹ä¸è¡¨ï¼Œåé¢è®²ã€‚</p>
</li>
<li>
<p>å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œæƒ³æŒ‘æˆ˜ä¸€ä¸‹ï¼Œæ¬¢è¿å°è¯•ã€‚</p>
</li>
</ol>
</div>
</details>
<p>å®ç°å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•å®ƒæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚</p>
<details id="admonition-è­¦å‘Š-è¦åœ¨-srcstoragemodrs-å¼€å¤´æ·»åŠ ä»£ç " class="admonition warning">
<summary class="admonition-title">
<p>è­¦å‘Šâš ï¸ï¼š è¦åœ¨ src/storage/mod.rs å¼€å¤´æ·»åŠ ä»£ç  </p>
<p><a class="admonition-anchor-link" href="#admonition-è­¦å‘Š-è¦åœ¨-srcstoragemodrs-å¼€å¤´æ·»åŠ ä»£ç "></a></p>
</summary>
<div>
<p>æ³¨æ„ç°åœ¨ src/storage/memory.rs è¿˜æ²¡æœ‰è¢«æ·»åŠ ï¼Œæ‰€ä»¥ cargo å¹¶ä¸ä¼šç¼–è¯‘å®ƒã€‚è¦åœ¨ src/storage/mod.rs å¼€å¤´æ·»åŠ ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">mod memory;

pub use memory::MemTable;
</code></pre></pre>
<p>è¿™æ ·ä»£ç å°±å¯ä»¥ç¼–è¯‘é€šè¿‡äº†ã€‚å› ä¸ºè¿˜æ²¡æœ‰å®ç° get_iter æ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸ªæµ‹è¯•éœ€è¦è¢«æ³¨é‡Šæ‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">// #[test]

// fn memtable_iter_should_work() {

// let store = MemTable::new();

// test_get_iter(store);

// }
</code></pre></pre>
</div>
</details>
<h3 id="æµ‹è¯•"><a class="header" href="#æµ‹è¯•">æµ‹è¯•</a></h3>
<details id="admonition-å¦‚æœä½ è¿è¡Œ-cargo-test-å¯ä»¥çœ‹åˆ°æµ‹è¯•éƒ½é€šè¿‡äº†" class="admonition success">
<summary class="admonition-title">
<p>å¦‚æœä½ è¿è¡Œ cargo test ï¼Œå¯ä»¥çœ‹åˆ°æµ‹è¯•éƒ½é€šè¿‡äº†ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-å¦‚æœä½ è¿è¡Œ-cargo-test-å¯ä»¥çœ‹åˆ°æµ‹è¯•éƒ½é€šè¿‡äº†"></a></p>
</summary>
<div>
<pre><code class="language-shell">\&gt; cargo test

Compiling kv v0.1.0 (/Users/tchen/projects/mycode/rust/geek-time-rust-resources/21/kv)

Finished test [unoptimized + debuginfo] target(s) in 1.95s

Running unittests (/Users/tchen/.target/debug/deps/kv-8d746b0f387a5271)

running 2 tests

test storage::tests::memtable_basic_interface_should_work ... ok

test storage::tests::memtable_get_all_should_work ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in0.00s

Doc-tests kv

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in0.00s
</code></pre>
</div>
</details>
<h2 id="å®ç°å¹¶éªŒè¯-commandservice-trait"><a class="header" href="#å®ç°å¹¶éªŒè¯-commandservice-trait">å®ç°å¹¶éªŒè¯ CommandService trait</a></h2>
<details id="admonition-ç¬”è®°-storage-trait-æˆ‘ä»¬å°±ç®—åŸºæœ¬éªŒè¯é€šè¿‡äº†ç°åœ¨å†æ¥éªŒè¯-commandservice" class="admonition note">
<summary class="admonition-title">
<p>ç¬”è®°ï¼š Storage trait æˆ‘ä»¬å°±ç®—åŸºæœ¬éªŒè¯é€šè¿‡äº†ï¼Œç°åœ¨å†æ¥éªŒè¯ CommandService </p>
<p><a class="admonition-anchor-link" href="#admonition-ç¬”è®°-storage-trait-æˆ‘ä»¬å°±ç®—åŸºæœ¬éªŒè¯é€šè¿‡äº†ç°åœ¨å†æ¥éªŒè¯-commandservice"></a></p>
</summary>
<div>
<p>Storage trait æˆ‘ä»¬å°±ç®—åŸºæœ¬éªŒè¯é€šè¿‡äº†ï¼Œç°åœ¨å†æ¥éªŒè¯ CommandServiceã€‚</p>
<ol>
<li>æˆ‘ä»¬åˆ›å»º src/service ç›®å½•</li>
<li>ä»¥åŠ src/service/mod.rs </li>
<li>å’Œ src/service/command_service.rs æ–‡ä»¶</li>
<li>å¹¶åœ¨ src/service/mod.rs å†™å…¥ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use crate::*;

mod command_service;

/// å¯¹ Command çš„å¤„ç†çš„æŠ½è±¡
pub trait CommandService {
    /// å¤„ç† Commandï¼Œè¿”å› Response
    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse;
}
</code></pre></pre>
<ol start="5">
<li>
<p>ç„¶åï¼Œåœ¨ src/service/command_service.rs ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå†™ä¸€äº›æµ‹è¯•</p>
<p>ä¸ºäº†ç®€å•èµ·è§ï¼Œå°±åˆ— HSETã€HGETã€HGETALL ä¸‰ä¸ªå‘½ä»¤ï¼š</p>
</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use crate::*;

#[cfg(test)]
mod tests {
    use super::*;
    use crate::command_request::RequestData;

    #[test]
    fn hset_should_work() {
        let store = MemTable::new();
        let cmd = CommandRequest::new_hset(&quot;t1&quot;, &quot;hello&quot;, &quot;world&quot;.into());
        let res = dispatch(cmd.clone(), &amp;store);
        assert_res_ok(res, &amp;[Value::default()], &amp;[]);

        let res = dispatch(cmd, &amp;store);
        assert_res_ok(res, &amp;[&quot;world&quot;.into()], &amp;[]);
    }

    #[test]
    fn hget_should_work() {
        let store = MemTable::new();
        let cmd = CommandRequest::new_hset(&quot;score&quot;, &quot;u1&quot;, 10.into());
        dispatch(cmd, &amp;store);
        let cmd = CommandRequest::new_hget(&quot;score&quot;, &quot;u1&quot;);
        let res = dispatch(cmd, &amp;store);
        assert_res_ok(res, &amp;[10.into()], &amp;[]);
    }

    #[test]
    fn hget_with_non_exist_key_should_return_404() {
        let store = MemTable::new();
        let cmd = CommandRequest::new_hget(&quot;score&quot;, &quot;u1&quot;);
        let res = dispatch(cmd, &amp;store);
        assert_res_error(res, 404, &quot;Not found&quot;);
    }

    #[test]
    fn hgetall_should_work() {
        let store = MemTable::new();
        let cmds = vec![
            CommandRequest::new_hset(&quot;score&quot;, &quot;u1&quot;, 10.into()),
            CommandRequest::new_hset(&quot;score&quot;, &quot;u2&quot;, 8.into()),
            CommandRequest::new_hset(&quot;score&quot;, &quot;u3&quot;, 11.into()),
            CommandRequest::new_hset(&quot;score&quot;, &quot;u1&quot;, 6.into()),
        ];
        for cmd in cmds {
            dispatch(cmd, &amp;store);
        }

        let cmd = CommandRequest::new_hgetall(&quot;score&quot;);
        let res = dispatch(cmd, &amp;store);
        let pairs = &amp;[
            Kvpair::new(&quot;u1&quot;, 6.into()),
            Kvpair::new(&quot;u2&quot;, 8.into()),
            Kvpair::new(&quot;u3&quot;, 11.into()),
        ];
        assert_res_ok(res, &amp;[], pairs);
    }

    // ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç† HGET/HGETALL/HSET
    fn dispatch(cmd: CommandRequest, store: &amp;impl Storage) -&gt; CommandResponse {
        match cmd.request_data.unwrap() {
            RequestData::Hget(v) =&gt; v.execute(store),
            RequestData::Hgetall(v) =&gt; v.execute(store),
            RequestData::Hset(v) =&gt; v.execute(store),
            _ =&gt; todo!(),
        }
    }

    // æµ‹è¯•æˆåŠŸè¿”å›çš„ç»“æœ
    fn assert_res_ok(mut res: CommandResponse, values: &amp;[Value], pairs: &amp;[Kvpair]) {
        res.pairs.sort_by(|a, b| a.partial_cmp(b).unwrap());
        assert_eq!(res.status, 200);
        assert_eq!(res.message, &quot;&quot;);
        assert_eq!(res.values, values);
        assert_eq!(res.pairs, pairs);
    }

    // æµ‹è¯•å¤±è´¥è¿”å›çš„ç»“æœ
    fn assert_res_error(res: CommandResponse, code: u32, msg: &amp;str) {
        assert_eq!(res.status, code);
        assert!(res.message.contains(msg));
        assert_eq!(res.values, &amp;[]);
        assert_eq!(res.pairs, &amp;[]);
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-è¿™äº›æµ‹è¯•çš„ä½œç”¨å°±æ˜¯éªŒè¯äº§å“éœ€æ±‚æ¯”å¦‚" class="admonition tip">
<summary class="admonition-title">
<p>è¿™äº›æµ‹è¯•çš„ä½œç”¨å°±æ˜¯éªŒè¯äº§å“éœ€æ±‚ï¼Œæ¯”å¦‚</p>
<p><a class="admonition-anchor-link" href="#admonition-è¿™äº›æµ‹è¯•çš„ä½œç”¨å°±æ˜¯éªŒè¯äº§å“éœ€æ±‚æ¯”å¦‚"></a></p>
</summary>
<div>
<blockquote>
<p>è¿™äº›æµ‹è¯•çš„ä½œç”¨å°±æ˜¯éªŒè¯äº§å“éœ€æ±‚ï¼Œæ¯”å¦‚ï¼š</p>
</blockquote>
<ul>
<li>
<p>HSET æˆåŠŸè¿”å›ä¸Šä¸€æ¬¡çš„å€¼ï¼ˆè¿™å’Œ Redis ç•¥æœ‰ä¸åŒï¼ŒRedis è¿”å›è¡¨ç¤ºå¤šå°‘ key å—å½±å“çš„ä¸€ä¸ªæ•´æ•°ï¼‰</p>
</li>
<li>
<p>HGET è¿”å› Value</p>
</li>
<li>
<p>HGETALL è¿”å›ä¸€ç»„æ— åºçš„ Kvpair</p>
</li>
</ul>
</div>
</details>
<details id="admonition-ç›®å‰è¿™äº›æµ‹è¯•æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„å› ä¸ºé‡Œé¢ä½¿ç”¨äº†ä¸€äº›æœªå®šä¹‰çš„æ–¹æ³•" class="admonition failure">
<summary class="admonition-title">
<p>ç›®å‰è¿™äº›æµ‹è¯•æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå› ä¸ºé‡Œé¢ä½¿ç”¨äº†ä¸€äº›æœªå®šä¹‰çš„æ–¹æ³•</p>
<p><a class="admonition-anchor-link" href="#admonition-ç›®å‰è¿™äº›æµ‹è¯•æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„å› ä¸ºé‡Œé¢ä½¿ç”¨äº†ä¸€äº›æœªå®šä¹‰çš„æ–¹æ³•"></a></p>
</summary>
<div>
<blockquote>
<p>ç›®å‰è¿™äº›æµ‹è¯•æ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„ï¼Œå› ä¸ºé‡Œé¢ä½¿ç”¨äº†ä¸€äº›æœªå®šä¹‰çš„æ–¹æ³•ï¼Œæ¯”å¦‚</p>
</blockquote>
<ul>
<li>10.into()ï¼šæƒ³æŠŠæ•´æ•° 10 è½¬æ¢æˆä¸€ä¸ª Value</li>
<li>CommandRequest::new_hgetall(â€œscoreâ€)ï¼šæƒ³ç”Ÿæˆä¸€ä¸ª HGETALL å‘½ä»¤ã€‚</li>
</ul>
</div>
</details>
<h3 id="ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™"><a class="header" href="#ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™">ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Ÿ</a></h3>
<details id="admonition-å› ä¸ºå¦‚æœæ˜¯-commandservice-æ¥å£çš„ä½¿ç”¨è€…è‡ªç„¶å¸Œæœ›ä½¿ç”¨è¿™ä¸ªæ¥å£çš„æ—¶å€™è°ƒç”¨çš„æ•´ä½“æ„Ÿè§‰éå¸¸ç®€å•æ˜äº†" class="admonition abstract">
<summary class="admonition-title">
<p>å› ä¸ºå¦‚æœæ˜¯ CommandService æ¥å£çš„ä½¿ç”¨è€…ï¼Œè‡ªç„¶å¸Œæœ›ä½¿ç”¨è¿™ä¸ªæ¥å£çš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ•´ä½“æ„Ÿè§‰éå¸¸ç®€å•æ˜äº† </p>
<p><a class="admonition-anchor-link" href="#admonition-å› ä¸ºå¦‚æœæ˜¯-commandservice-æ¥å£çš„ä½¿ç”¨è€…è‡ªç„¶å¸Œæœ›ä½¿ç”¨è¿™ä¸ªæ¥å£çš„æ—¶å€™è°ƒç”¨çš„æ•´ä½“æ„Ÿè§‰éå¸¸ç®€å•æ˜äº†"></a></p>
</summary>
<div>
<p>å› ä¸ºå¦‚æœæ˜¯ CommandService æ¥å£çš„ä½¿ç”¨è€…ï¼Œè‡ªç„¶å¸Œæœ›ä½¿ç”¨è¿™ä¸ªæ¥å£çš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ•´ä½“æ„Ÿè§‰éå¸¸ç®€å•æ˜äº†ã€‚</p>
<p>å¦‚æœæ¥å£æœŸå¾…ä¸€ä¸ª Valueï¼Œä½†åœ¨ä¸Šä¸‹æ–‡ä¸­æ‹¿åˆ°çš„æ˜¯ 10ã€â€œhelloâ€ è¿™æ ·çš„å€¼ï¼Œé‚£æˆ‘ä»¬ä½œä¸ºè®¾è®¡è€…å°±è¦è€ƒè™‘ä¸º Value å®ç° From<T>ï¼Œè¿™æ ·è°ƒç”¨çš„æ—¶å€™æœ€æ–¹ä¾¿ã€‚åŒæ ·çš„ï¼Œå¯¹äºç”Ÿæˆ CommandRequest è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œä¹Ÿå¯ä»¥æ·»åŠ ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œæ¥è®©è°ƒç”¨æ›´æ¸…æ™°ã€‚</p>
<blockquote>
<p>åˆ°ç°åœ¨ä¸ºæ­¢æˆ‘ä»¬å†™äº†ä¸¤è½®æµ‹è¯•äº†ï¼Œç›¸ä¿¡ä½ å¯¹æµ‹è¯•ä»£ç çš„ä½œç”¨æœ‰å¤§æ¦‚ç†è§£ã€‚æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š</p>
</blockquote>
<ol>
<li>éªŒè¯å¹¶å¸®åŠ©æ¥å£è¿­ä»£</li>
<li>éªŒè¯äº§å“éœ€æ±‚</li>
<li>é€šè¿‡ä½¿ç”¨æ ¸å¿ƒé€»è¾‘ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°æ€è€ƒå¤–å›´é€»è¾‘å¹¶åæ¨å…¶å®ç°</li>
</ol>
<blockquote>
<p>å‰ä¸¤ç‚¹æ˜¯æœ€åŸºæœ¬çš„ï¼Œä¹Ÿæ˜¯å¾ˆå¤šäººå¯¹ TDD çš„ç†è§£ï¼Œå…¶å®è¿˜æœ‰æ›´é‡è¦çš„ä¹Ÿå°±æ˜¯ç¬¬ä¸‰ç‚¹ã€‚é™¤äº†å‰é¢çš„è¾…åŠ©å‡½æ•°å¤–ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯•ä»£ç ä¸­è¿˜çœ‹åˆ°äº† dispatch å‡½æ•°ï¼Œå®ƒç›®å‰ç”¨æ¥è¾…åŠ©æµ‹è¯•ã€‚ä½†ç´§æ¥ç€ä½ ä¼šå‘ç°ï¼Œè¿™æ ·çš„è¾…åŠ©å‡½æ•°ï¼Œå¯ä»¥åˆå¹¶åˆ°æ ¸å¿ƒä»£ç ä¸­ã€‚è¿™æ‰æ˜¯â€œæµ‹è¯•é©±åŠ¨å¼€å‘â€çš„å®è´¨ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="åœ¨-srcpbmodrs-ä¸­æ·»åŠ ç›¸å…³çš„å¤–å›´é€»è¾‘"><a class="header" href="#åœ¨-srcpbmodrs-ä¸­æ·»åŠ ç›¸å…³çš„å¤–å›´é€»è¾‘">åœ¨ src/pb/mod.rs ä¸­æ·»åŠ ç›¸å…³çš„å¤–å›´é€»è¾‘</a></h3>
<details id="admonition-ç¬”è®°å¥½æ ¹æ®æµ‹è¯•æˆ‘ä»¬éœ€è¦åœ¨-srcpbmodrs-ä¸­æ·»åŠ ç›¸å…³çš„å¤–å›´é€»è¾‘" class="admonition note">
<summary class="admonition-title">
<p>ç¬”è®°ï¼šå¥½ï¼Œæ ¹æ®æµ‹è¯•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ src/pb/mod.rs ä¸­æ·»åŠ ç›¸å…³çš„å¤–å›´é€»è¾‘</p>
<p><a class="admonition-anchor-link" href="#admonition-ç¬”è®°å¥½æ ¹æ®æµ‹è¯•æˆ‘ä»¬éœ€è¦åœ¨-srcpbmodrs-ä¸­æ·»åŠ ç›¸å…³çš„å¤–å›´é€»è¾‘"></a></p>
</summary>
<div>
<ol>
<li>é¦–å…ˆæ˜¯ CommandRequest çš„ä¸€äº›æ–¹æ³•ï¼Œä¹‹å‰å†™äº† new_hsetï¼Œç°åœ¨å†åŠ å…¥ new_hget å’Œ new_hgetallï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
impl CommandRequest {
    /// åˆ›å»º HGET å‘½ä»¤
    pub fn new_hget(table: impl Into&lt;String&gt;, key: impl Into&lt;String&gt;) -&gt; Self {
        Self {
            request_data: Some(RequestData::Hget(Hget {
                table: table.into(),
                key: key.into(),
            })),
        }
    }

    /// åˆ›å»º HGETALL å‘½ä»¤
    pub fn new_hgetall(table: impl Into&lt;String&gt;) -&gt; Self {
        Self {
            request_data: Some(RequestData::Hgetall(Hgetall {
                table: table.into(),
            })),
        }
    }

    /// åˆ›å»º HSET å‘½ä»¤
    pub fn new_hset(table: impl Into&lt;String&gt;, key: impl Into&lt;String&gt;, value: Value) -&gt; Self {
        Self {
            request_data: Some(RequestData::Hset(Hset {
                table: table.into(),
                pair: Some(Kvpair::new(key, value)),
            })),
        }
    }
}
</code></pre></pre>
<ol start="2">
<li>ç„¶åå†™å¯¹ Value çš„ From<i64> çš„å®ç°ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
/// ä» i64è½¬æ¢æˆ Value
impl From&lt;i64&gt; for Value {
    fn from(i: i64) -&gt; Self {
        Self {
            value: Some(value::Value::Integer(i)),
        }
    }
}
</code></pre></pre>
<ol start="3">
<li>æµ‹è¯•ä»£ç ç›®å‰å°±å¯ä»¥ç¼–è¯‘é€šè¿‡äº†ï¼Œç„¶è€Œæµ‹è¯•æ˜¾ç„¶ä¼šå¤±è´¥ï¼Œå› ä¸ºè¿˜æ²¡æœ‰åšå…·ä½“çš„å®ç°ã€‚æˆ‘ä»¬åœ¨ src/service/command_service.rs ä¸‹æ·»åŠ  trait çš„å®ç°ä»£ç ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
impl CommandService for Hget {
    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {
        match store.get(&amp;self.table, &amp;self.key) {
            Ok(Some(v)) =&gt; v.into(),
            Ok(None) =&gt; KvError::NotFound(self.table, self.key).into(),
            Err(e) =&gt; e.into(),
        }
    }
}

impl CommandService for Hgetall {
    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {
        match store.get_all(&amp;self.table) {
            Ok(v) =&gt; v.into(),
            Err(e) =&gt; e.into(),
        }
    }
}

impl CommandService for Hset {
    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse {
        match self.pair {
            Some(v) =&gt; match store.set(&amp;self.table, v.key, v.value.unwrap_or_default()) {
                Ok(Some(v)) =&gt; v.into(),
                Ok(None) =&gt; Value::default().into(),
                Err(e) =&gt; e.into(),
            },
            None =&gt; Value::default().into(),
        }
    }
}
</code></pre></pre>
<blockquote>
<p>è¿™è‡ªç„¶ä¼šå¼•å‘æ›´å¤šçš„ç¼–è¯‘é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯ç”¨äº† into() æ–¹æ³•ï¼Œå´æ²¡æœ‰å®ç°ç›¸åº”çš„è½¬æ¢ï¼Œæ¯”å¦‚ï¼ŒValue åˆ° CommandResponse çš„è½¬æ¢ã€KvError åˆ° CommandResponse çš„è½¬æ¢ã€Vec<Kvpair> åˆ° CommandResponse çš„è½¬æ¢ç­‰ç­‰ã€‚</p>
</blockquote>
<ol start="4">
<li>æ‰€ä»¥åœ¨ src/pb/mod.rs é‡Œç»§ç»­è¡¥ä¸Šç›¸åº”çš„å¤–å›´é€»è¾‘ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
/// ä» Value è½¬æ¢æˆ CommandResponse
impl From&lt;Value&gt; for CommandResponse {
    fn from(v: Value) -&gt; Self {
        Self {
            status: StatusCode::OK.as_u16() as _,
            values: vec![v],
            ..Default::default()
        }
    }
}

/// ä» Vec&lt;Kvpair&gt; è½¬æ¢æˆ CommandResponse
impl From&lt;Vec&lt;Kvpair&gt;&gt; for CommandResponse {
    fn from(v: Vec&lt;Kvpair&gt;) -&gt; Self {
        Self {
            status: StatusCode::OK.as_u16() as _,
            pairs: v,
            ..Default::default()
        }
    }
}

/// ä» KvError è½¬æ¢æˆ CommandResponse
impl From&lt;KvError&gt; for CommandResponse {
    fn from(e: KvError) -&gt; Self {
        let mut result = Self {
            status: StatusCode::INTERNAL_SERVER_ERROR.as_u16() as _,
            message: e.to_string(),
            values: vec![],
            pairs: vec![],
        };

        match e {
            KvError::NotFound(_, _) =&gt; result.status = StatusCode::NOT_FOUND.as_u16() as _,
            KvError::InvalidCommand(_) =&gt; result.status = StatusCode::BAD_REQUEST.as_u16() as _,
            _ =&gt; {}
        }

        result
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-intoå’Œstructç»•è¿‡å­¤å„¿åŸåˆ™" class="admonition quote">
<summary class="admonition-title">
<p>into()å’Œstructç»•è¿‡å­¤å„¿åŸåˆ™ </p>
<p><a class="admonition-anchor-link" href="#admonition-intoå’Œstructç»•è¿‡å­¤å„¿åŸåˆ™"></a></p>
</summary>
<div>
<p>ä»å‰é¢å†™æ¥å£åˆ°è¿™é‡Œå…·ä½“å®ç°ï¼Œä¸çŸ¥é“ä½ æ˜¯å¦æ„Ÿå—åˆ°äº†è¿™æ ·ä¸€ç§æ¨¡å¼ï¼š</p>
<ul>
<li>åœ¨ Rust ä¸‹ï¼Œä½†å‡¡å‡ºç°ä¸¤ä¸ªæ•°æ®ç»“æ„ v1 åˆ° v2 çš„è½¬æ¢ï¼Œä½ éƒ½å¯ä»¥å…ˆä»¥ v1.into() æ¥è¡¨ç¤ºè¿™ä¸ªé€»è¾‘ï¼Œç»§ç»­å¾€ä¸‹å†™ä»£ç </li>
<li>ä¹‹åå†å»è¡¥ From<T> çš„å®ç°</li>
<li>å¦‚æœ v1 å’Œ v2 éƒ½ä¸æ˜¯ä½ å®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆä½ éœ€è¦æŠŠå…¶ä¸­ä¹‹ä¸€ç”¨ struct åŒ…è£…ä¸€ä¸‹ï¼Œæ¥ç»•è¿‡ä¹‹å‰æåˆ°çš„å­¤å„¿è§„åˆ™ã€‚</li>
</ul>
</div>
</details>
<blockquote>
<p>ç°åœ¨ä»£ç åº”è¯¥å¯ä»¥ç¼–è¯‘é€šè¿‡å¹¶æµ‹è¯•é€šè¿‡äº†ï¼Œä½ å¯ä»¥ cargo test æµ‹è¯•ä¸€ä¸‹ã€‚</p>
</blockquote>
<h2 id="æœ€åçš„æ‹¼å›¾service-ç»“æ„çš„å®ç°"><a class="header" href="#æœ€åçš„æ‹¼å›¾service-ç»“æ„çš„å®ç°">æœ€åçš„æ‹¼å›¾ï¼šService ç»“æ„çš„å®ç°</a></h2>
<p>å¥½ï¼Œæ‰€æœ‰çš„æ¥å£ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯ / æœåŠ¡å™¨çš„åè®®æ¥å£ã€Storage trait å’Œ CommandService trait éƒ½éªŒè¯å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è€ƒè™‘å¦‚ä½•ç”¨ä¸€ä¸ªæ•°æ®ç»“æ„æŠŠæ‰€æœ‰è¿™äº›ä¸œè¥¿ä¸²è”èµ·æ¥ã€‚</p>
<details id="admonition-ç¬”è®°-ä¾æ—§ä»ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹å¦‚ä½•è°ƒç”¨å®ƒä¸ºæ­¤æˆ‘ä»¬åœ¨-srcservicemodrs-é‡Œæ·»åŠ å¦‚ä¸‹çš„æµ‹è¯•ä»£ç " class="admonition note">
<summary class="admonition-title">
<p>ç¬”è®°ï¼š ä¾æ—§ä»ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹å¦‚ä½•è°ƒç”¨å®ƒã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨ src/service/mod.rs é‡Œæ·»åŠ å¦‚ä¸‹çš„æµ‹è¯•ä»£ç ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-ç¬”è®°-ä¾æ—§ä»ä½¿ç”¨è€…çš„è§’åº¦æ¥çœ‹å¦‚ä½•è°ƒç”¨å®ƒä¸ºæ­¤æˆ‘ä»¬åœ¨-srcservicemodrs-é‡Œæ·»åŠ å¦‚ä¸‹çš„æµ‹è¯•ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {
    use super::*;
    use crate::{MemTable, Value};

    #[test]
    fn service_should_works() {
        // æˆ‘ä»¬éœ€è¦ä¸€ä¸ª service ç»“æ„è‡³å°‘åŒ…å« Storage
        let service = Service::new(MemTable::default());

        // service å¯ä»¥è¿è¡Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå®ƒçš„ clone åº”è¯¥æ˜¯è½»é‡çº§çš„
        let cloned = service.clone();

        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨ table t1 ä¸­å†™å…¥ k1, v1
        let handle = thread::spawn(move || {
            let res = cloned.execute(CommandRequest::new_hset(&quot;t1&quot;, &quot;k1&quot;, &quot;v1&quot;.into()));
            assert_res_ok(res, &amp;[Value::default()], &amp;[]);
        });
        handle.join().unwrap();

        // åœ¨å½“å‰çº¿ç¨‹ä¸‹è¯»å– table t1 çš„ k1ï¼Œåº”è¯¥è¿”å› v1
        let res = service.execute(CommandRequest::new_hget(&quot;t1&quot;, &quot;k1&quot;));
        assert_res_ok(res, &amp;[&quot;v1&quot;.into()], &amp;[]);
    }
}

#[cfg(test)]
use crate::{Kvpair, Value};

// æµ‹è¯•æˆåŠŸè¿”å›çš„ç»“æœ
#[cfg(test)]
pub fn assert_res_ok(mut res: CommandResponse, values: &amp;[Value], pairs: &amp;[Kvpair]) {
    res.pairs.sort_by(|a, b| a.partial_cmp(b).unwrap());
    assert_eq!(res.status, 200);
    assert_eq!(res.message, &quot;&quot;);
    assert_eq!(res.values, values);
    assert_eq!(res.pairs, pairs);
}

// æµ‹è¯•å¤±è´¥è¿”å›çš„ç»“æœ
#[cfg(test)]
pub fn assert_res_error(res: CommandResponse, code: u32, msg: &amp;str) {
    assert_eq!(res.status, code);
    assert!(res.message.contains(msg));
    assert_eq!(res.values, &amp;[]);
    assert_eq!(res.pairs, &amp;[]);
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>æ³¨æ„ï¼Œè¿™é‡Œçš„ assert_res_ok() å’Œ assert_res_error() æ˜¯ä» src/service/command_service.rs ä¸­æŒªè¿‡æ¥çš„ã€‚åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä¸å…‰äº§å“ä»£ç éœ€è¦ä¸æ–­é‡æ„ï¼Œæµ‹è¯•ä»£ç ä¹Ÿéœ€è¦é‡æ„æ¥è´¯å½»
DRY æ€æƒ³ã€‚</p>
</blockquote>
<h3 id="å›´ç»•æ¥å£æµ‹è¯•"><a class="header" href="#å›´ç»•æ¥å£æµ‹è¯•">å›´ç»•æ¥å£æµ‹è¯•</a></h3>
<details id="admonition-æç¤ºé‚£ä»€ä¹ˆæ ·çš„æµ‹è¯•ä»£ç æ˜¯ç¨³å®šçš„æµ‹è¯•æ¥å£çš„ä»£ç æ˜¯ç¨³å®šçš„" class="admonition tip">
<summary class="admonition-title">
<p>æç¤ºï¼šé‚£ä»€ä¹ˆæ ·çš„æµ‹è¯•ä»£ç æ˜¯ç¨³å®šçš„ï¼Ÿæµ‹è¯•æ¥å£çš„ä»£ç æ˜¯ç¨³å®šçš„ã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-æç¤ºé‚£ä»€ä¹ˆæ ·çš„æµ‹è¯•ä»£ç æ˜¯ç¨³å®šçš„æµ‹è¯•æ¥å£çš„ä»£ç æ˜¯ç¨³å®šçš„"></a></p>
</summary>
<div>
<p>æˆ‘è§è¿‡å¾ˆå¤šç”Ÿäº§ç¯å¢ƒçš„ä»£ç ï¼Œäº§å“åŠŸèƒ½éƒ¨åˆ†è¿˜è¯´å¾—è¿‡å»ï¼Œä½†æµ‹è¯•ä»£ç åƒæ˜¯ä¸ªç²ªå‘ï¼Œç»å¹´ç´¯æœˆåœ° copy/paste ä½¿å…¶è‡­æ°”ç†å¤©ï¼Œæ¯ä¸ªå¼€å‘è€…åœ¨æ·»åŠ æ–°åŠŸèƒ½çš„æ—¶å€™ï¼Œéƒ½æ©ç€é¼»å­å¾€é‡Œæ‰”ä¸€å¨èµ°äººï¼Œä½¿å¾—ç»´æŠ¤éš¾åº¦è¶Šæ¥è¶Šé«˜ï¼Œæ¯æ¬¡éœ€æ±‚å˜åŠ¨ï¼Œéƒ½æ¶‰åŠä¸€å¤§å¨æµ‹è¯•ä»£ç çš„å˜åŠ¨ï¼Œè¿™æ ·éå¸¸ä¸å¥½ã€‚</p>
<p>æµ‹è¯•ä»£ç çš„è´¨é‡ä¹Ÿè¦å’Œäº§å“ä»£ç çš„è´¨é‡åŒç­‰è¦æ±‚ã€‚å¥½çš„å¼€å‘è€…å†™çš„æµ‹è¯•ä»£ç çš„å¯è¯»æ€§ä¹Ÿæ˜¯éå¸¸å¼ºçš„ã€‚ä½ å¯ä»¥å¯¹æ¯”ä¸Šé¢å†™çš„ä¸‰æ®µæµ‹è¯•ä»£ç å¤šå¤šæ„Ÿå—ã€‚</p>
<p>åœ¨æ’°å†™æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦ç‰¹åˆ«æ³¨æ„ï¼šæµ‹è¯•ä»£ç è¦å›´ç»•ç€ç³»ç»Ÿç¨³å®šçš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æ¥å£ï¼Œæ¥æµ‹è¯•ï¼Œè€Œå°½å¯èƒ½å°‘åœ°æµ‹è¯•å®ç°ã€‚è¿™æ˜¯æˆ‘å¯¹è¿™ä¹ˆå¤šå¹´å·¥ä½œä¸­è¡€æ·‹æ·‹çš„æ•™è®­çš„æ·±åˆ»æ€»ç»“ã€‚</p>
<p>å› ä¸ºäº§å“ä»£ç å’Œæµ‹è¯•ä»£ç ï¼Œä¸¤è€…æ€»éœ€è¦ä¸€ä¸ªæ˜¯ç›¸å¯¹ç¨³å®šçš„ï¼Œæ—¢ç„¶äº§å“ä»£ç ä¼šä¸æ–­åœ°æ ¹æ®éœ€æ±‚å˜åŠ¨ï¼Œæµ‹è¯•ä»£ç å°±å¿…ç„¶éœ€è¦ç¨³å®šä¸€äº›ã€‚</p>
<p>é‚£ä»€ä¹ˆæ ·çš„æµ‹è¯•ä»£ç æ˜¯ç¨³å®šçš„ï¼Ÿæµ‹è¯•æ¥å£çš„ä»£ç æ˜¯ç¨³å®šçš„ã€‚åªè¦æ¥å£ä¸å˜ï¼Œæ— è®ºå…·ä½“å®ç°å¦‚ä½•å˜åŒ–ï¼Œå“ªæ€•ä»Šå¤©å¼•å…¥ä¸€ä¸ªæ–°çš„ç®—æ³•ï¼Œæ˜å¤©é‡å†™å®ç°ï¼Œæµ‹è¯•ä»£ç ä¾æ—§èƒ½å¤Ÿå‡›ç„¶ä¸åŠ¨ï¼Œåšå¥½äº§å“è´¨é‡çš„çœ‹é—¨ç‹—ã€‚</p>
</div>
</details>
<h3 id="ç»§ç»­å†™ä»£ç "><a class="header" href="#ç»§ç»­å†™ä»£ç ">ç»§ç»­å†™ä»£ç </a></h3>
<p>å¥½ï¼Œæˆ‘ä»¬å›æ¥å†™ä»£ç ã€‚åœ¨è¿™æ®µæµ‹è¯•ä¸­ï¼Œå·²ç»æ•²å®šäº† Service è¿™ä¸ªæ•°æ®ç»“æ„çš„ä½¿ç”¨è“å›¾ï¼Œå®ƒå¯ä»¥è·¨çº¿ç¨‹ï¼Œå¯ä»¥è°ƒç”¨ execute æ¥æ‰§è¡ŒæŸä¸ª CommandRequest å‘½ä»¤ï¼Œè¿”å› CommandResponseã€‚</p>
<details id="admonition-æ ¹æ®è¿™äº›æƒ³æ³•åœ¨-srcservicemodrs-é‡Œæ·»åŠ -service-çš„å£°æ˜å’Œå®ç°" class="admonition note">
<summary class="admonition-title">
<p>æ ¹æ®è¿™äº›æƒ³æ³•ï¼Œåœ¨ src/service/mod.rs é‡Œæ·»åŠ  Service çš„å£°æ˜å’Œå®ç°ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-æ ¹æ®è¿™äº›æƒ³æ³•åœ¨-srcservicemodrs-é‡Œæ·»åŠ -service-çš„å£°æ˜å’Œå®ç°"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
/// Service æ•°æ®ç»“æ„
pub struct Service&lt;Store = MemTable&gt; {
    inner: Arc&lt;ServiceInner&lt;Store&gt;&gt;,
}

impl&lt;Store&gt; Clone for Service&lt;Store&gt; {
    fn clone(&amp;self) -&gt; Self {
        Self {
      inner: Arc::clone(&amp;self.inner),
        }
    }
}

/// Service å†…éƒ¨æ•°æ®ç»“æ„
pub struct ServiceInner&lt;Store&gt; {
    store: Store,
}

impl&lt;Store: Storage&gt; Service&lt;Store&gt; {
    pub fn new(store: Store) -&gt; Self {
        Self {
            inner: Arc::new(ServiceInner { store }),
        }
    }

    pub fn execute(&amp;self, cmd: CommandRequest) -&gt; CommandResponse {
        debug!(&quot;Got request: {:?}&quot;, cmd);
        // TODO: å‘é€ on_received äº‹ä»¶
        let res = dispatch(cmd, &amp;self.inner.store);
        debug!(&quot;Executed response: {:?}&quot;, res);
        // TODO: å‘é€ on_executed äº‹ä»¶

        res
    }
}

// ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç† HGET/HGETALL/HSET
pub fn dispatch(cmd: CommandRequest, store: &amp;impl Storage) -&gt; CommandResponse {
    match cmd.request_data {
        Some(RequestData::Hget(param)) =&gt; param.execute(store),
        Some(RequestData::Hgetall(param)) =&gt; param.execute(store),
        Some(RequestData::Hset(param)) =&gt; param.execute(store),
        None =&gt; KvError::InvalidCommand(&quot;Request has no data&quot;.into()).into(),
        _ =&gt; KvError::Internal(&quot;Not implemented&quot;.into()).into(),
    }
}
</code></pre></pre>
<blockquote>
<p>è¿™æ®µä»£ç æœ‰å‡ ä¸ªåœ°æ–¹å€¼å¾—æ³¨æ„ï¼š</p>
</blockquote>
<ul>
<li>
<p>é¦–å…ˆ Service ç»“æ„å†…éƒ¨æœ‰ä¸€ä¸ª ServiceInner å­˜æ”¾å®é™…çš„æ•°æ®ç»“æ„ï¼ŒService åªæ˜¯ç”¨ Arc åŒ…è£¹äº† ServiceInnerã€‚è¿™ä¹Ÿæ˜¯ Rust çš„ä¸€ä¸ªæƒ¯ä¾‹ï¼ŒæŠŠéœ€è¦åœ¨å¤šçº¿ç¨‹ä¸‹ clone çš„ä¸»ä½“å’Œå…¶å†…éƒ¨ç»“æ„åˆ†å¼€ï¼Œè¿™æ ·ä»£ç é€»è¾‘æ›´åŠ æ¸…æ™°ã€‚</p>
</li>
<li>
<p>execute() æ–¹æ³•ç›®å‰å°±æ˜¯è°ƒç”¨äº† dispatchï¼Œä½†å®ƒæœªæ¥æ½œåœ¨å¯ä»¥åšä¸€äº›äº‹ä»¶åˆ†å‘ã€‚è¿™æ ·å¤„ç†ä½“ç°äº† SRPï¼ˆSingle Responsibility Principleï¼‰åŸåˆ™ã€‚</p>
</li>
<li>
<p>dispatch å…¶å®å°±æ˜¯æŠŠæµ‹è¯•ä»£ç çš„ dispatch é€»è¾‘ç§»åŠ¨è¿‡æ¥æ”¹åŠ¨äº†ä¸€ä¸‹ã€‚</p>
</li>
</ul>
<blockquote>
<p>å†ä¸€æ¬¡ï¼Œæˆ‘ä»¬é‡æ„äº†æµ‹è¯•ä»£ç ï¼ŒæŠŠå®ƒçš„è¾…åŠ©å‡½æ•°å˜æˆäº†äº§å“ä»£ç çš„ä¸€éƒ¨åˆ†ã€‚ç°åœ¨ï¼Œä½ å¯ä»¥è¿è¡Œ cargo test æµ‹è¯•ä¸€ä¸‹ï¼Œå¦‚æœä»£ç æ— æ³•ç¼–è¯‘ï¼Œå¯èƒ½æ˜¯ç¼ºä¸€äº› use ä»£ç ï¼Œæ¯”å¦‚ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use crate::{
    command_request::RequestData, CommandRequest, CommandResponse, KvError, MemTable, Storage,
};
use std::sync::Arc;
use tracing::debug;
</code></pre></pre>
</div>
</details>
<h2 id="æ–°çš„-server"><a class="header" href="#æ–°çš„-server">æ–°çš„ server</a></h2>
<details id="admonition-ç°åœ¨å¤„ç†é€»è¾‘å·²ç»éƒ½å®Œæˆäº†å¯ä»¥å†™ä¸ªæ–°çš„-example-æµ‹è¯•æœåŠ¡å™¨ä»£ç " class="admonition note">
<summary class="admonition-title">
<p>ç°åœ¨å¤„ç†é€»è¾‘å·²ç»éƒ½å®Œæˆäº†ï¼Œå¯ä»¥å†™ä¸ªæ–°çš„ example æµ‹è¯•æœåŠ¡å™¨ä»£ç ã€‚ </p>
<p><a class="admonition-anchor-link" href="#admonition-ç°åœ¨å¤„ç†é€»è¾‘å·²ç»éƒ½å®Œæˆäº†å¯ä»¥å†™ä¸ªæ–°çš„-example-æµ‹è¯•æœåŠ¡å™¨ä»£ç "></a></p>
</summary>
<div>
<ol>
<li>æŠŠä¹‹å‰çš„ examples/dummy_server.rs å¤åˆ¶ä¸€ä»½ï¼Œæˆä¸º examples/server.rsï¼Œç„¶åå¼•å…¥ Serviceï¼Œä¸»è¦çš„æ”¹åŠ¨å°±ä¸‰å¥ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
// main å‡½æ•°å¼€å¤´ï¼Œåˆå§‹åŒ– service
let service: Service = Service::new(MemTable::new());
// tokio::spawn ä¹‹å‰ï¼Œå¤åˆ¶ä¸€ä»½ service
let svc = service.clone();
// while loop ä¸­ï¼Œä½¿ç”¨ svc æ¥æ‰§è¡Œ cmd
let res = svc.execute(cmd);
</code></pre></pre>
<ol start="2">
<li>ä½ å¯ä»¥è¯•ç€è‡ªå·±ä¿®æ”¹ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use async_prost::AsyncProstStream;
use futures::prelude::*;
use kv::{CommandRequest, CommandResponse, MemTable, Service};
use tokio::net::TcpListener;
use tracing::info;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();
    let service: Service = Service::new(MemTable::new());
    let addr = &quot;127.0.0.1:9527&quot;;
    let listener = TcpListener::bind(addr).await?;
    info!(&quot;Start listening on {}&quot;, addr);
    loop {
        let (stream, addr) = listener.accept().await?;
        info!(&quot;Client {:?} connected&quot;, addr);
        let svc = service.clone();
        tokio::spawn(async move {
            let mut stream =
                AsyncProstStream::&lt;_, CommandRequest, CommandResponse, _&gt;::from(stream).for_async();
            while let Some(Ok(cmd)) = stream.next().await {
                let res = svc.execute(cmd);
                stream.send(res).await.unwrap();
            }
            info!(&quot;Client {:?} disconnected&quot;, addr);
        });
    }
}
</code></pre></pre>
</div>
</details>
<h2 id="è¿è¡Œ"><a class="header" href="#è¿è¡Œ">è¿è¡Œ</a></h2>
<details id="admonition-ä½¿ç”¨ä¸¤ä¸ªçª—å£åˆ†åˆ«æ¨¡æ‹ŸæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯" class="admonition success">
<summary class="admonition-title">
<p>ä½¿ç”¨ä¸¤ä¸ªçª—å£åˆ†åˆ«æ¨¡æ‹ŸæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ </p>
<p><a class="admonition-anchor-link" href="#admonition-ä½¿ç”¨ä¸¤ä¸ªçª—å£åˆ†åˆ«æ¨¡æ‹ŸæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯"></a></p>
</summary>
<div>
<p>å®Œæˆä¹‹åï¼Œæ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">RUST_LOG=info cargo run --example server --quiet
</code></pre></pre>
<p>ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">RUST_LOG=info cargo run --example server --quiet
</code></pre></pre>
</div>
</details>
<p>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ä¸”å¤„ç†æ­£å¸¸ã€‚</p>
<p>æˆ‘ä»¬çš„ KV server ç¬¬ä¸€ç‰ˆçš„åŸºæœ¬åŠŸèƒ½å°±å®Œå·¥äº†ï¼å½“ç„¶ï¼Œç›®å‰è¿˜åªå¤„ç†äº† 3 ä¸ªå‘½ä»¤ï¼Œå‰©ä¸‹ 6 ä¸ªéœ€è¦ä½ è‡ªå·±å®Œæˆã€‚</p>
<h2 id="åˆæ­¥æ„Ÿå—rustæ’°å†™ä»£ç æœ€ä½³å®è·µ"><a class="header" href="#åˆæ­¥æ„Ÿå—rustæ’°å†™ä»£ç æœ€ä½³å®è·µ">åˆæ­¥æ„Ÿå—Rustæ’°å†™ä»£ç æœ€ä½³å®è·µ</a></h2>
<details id="admonition-æœ‰ä¸¤ç‚¹æˆ‘ä»¬ä¸€å®šè¦è®¤çœŸé¢†ä¼š" class="admonition quote">
<summary class="admonition-title">
<p>æœ‰ä¸¤ç‚¹æˆ‘ä»¬ä¸€å®šè¦è®¤çœŸé¢†ä¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-æœ‰ä¸¤ç‚¹æˆ‘ä»¬ä¸€å®šè¦è®¤çœŸé¢†ä¼š"></a></p>
</summary>
<div>
<p>KV server å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆéš¾çš„é¡¹ç›®ï¼Œä½†æƒ³è¦æŠŠå®ƒå†™å¥½ï¼Œå¹¶ä¸ç®€å•ã€‚å¦‚æœä½ è·Ÿç€è®²è§£ä¸€æ­¥æ­¥èµ°ä¸‹æ¥ï¼Œå¯ä»¥æ„Ÿå—åˆ°ä¸€ä¸ªæœ‰æ½œåœ¨ç”Ÿäº§ç¯å¢ƒè´¨é‡çš„ Rust é¡¹ç›®åº”è¯¥å¦‚ä½•å¼€å‘ã€‚åœ¨è¿™ä¸¤è®²å†…å®¹ä¸­ï¼Œæœ‰ä¸¤ç‚¹æˆ‘ä»¬ä¸€å®šè¦è®¤çœŸé¢†ä¼šã€‚</p>
<ol>
<li>
<p>ä½ è¦å¯¹éœ€æ±‚æœ‰ä¸€ä¸ªæ¸…æ™°çš„æŠŠæ¡ï¼Œæ‰¾å‡ºå…¶ä¸­ä¸ç¨³å®šçš„éƒ¨åˆ†ï¼ˆvariantï¼‰å’Œæ¯”è¾ƒç¨³å®šçš„éƒ¨åˆ†ï¼ˆinvariantï¼‰ã€‚åœ¨ KV server ä¸­ï¼Œä¸ç¨³å®šçš„éƒ¨åˆ†æ˜¯ï¼Œå¯¹å„ç§æ–°çš„å‘½ä»¤çš„æ”¯æŒï¼Œä»¥åŠå¯¹ä¸åŒçš„ storage çš„æ”¯æŒã€‚æ‰€ä»¥éœ€è¦æ„å»ºæ¥å£æ¥æ¶ˆå¼­ä¸ç¨³å®šçš„å› ç´ ï¼Œè®©ä¸ç¨³å®šçš„éƒ¨åˆ†å¯ä»¥ç”¨ä¸€ç§ç¨³å®šçš„æ–¹å¼æ¥ç®¡ç†ã€‚</p>
</li>
<li>
<p>ä»£ç å’Œæµ‹è¯•å¯ä»¥å›´ç»•ç€æ¥å£èºæ—‹å‰è¿›ï¼Œä½¿ç”¨ TDD å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œè¿™ç§èºæ—‹å¼çš„è¿­ä»£ã€‚åœ¨ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ç³»ç»Ÿä¸­ï¼šæ¥å£æ˜¯ç¨³å®šçš„ï¼Œæµ‹è¯•æ¥å£çš„ä»£ç æ˜¯ç¨³å®šçš„ï¼Œå®ç°å¯ä»¥æ˜¯ä¸ç¨³å®šçš„ã€‚åœ¨è¿­ä»£å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¦ä¸æ–­åœ°é‡æ„ï¼Œè®©æµ‹è¯•ä»£ç å’Œäº§å“ä»£ç éƒ½å¾€æœ€ä¼˜çš„æ–¹å‘å‘å±•ã€‚</p>
</li>
</ol>
<p>çºµè§‚æˆ‘ä»¬å†™çš„ KV serverï¼ŒåŒ…æ‹¬æµ‹è¯•åœ¨å†…ï¼Œä½ å¾ˆéš¾å‘ç°æœ‰å‡½æ•°æˆ–è€…æ–¹æ³•è¶…è¿‡ 50 è¡Œï¼Œä»£ç å¯è¯»æ€§éå¸¸å¼ºï¼Œå‡ ä¹ä¸éœ€è¦æ³¨é‡Šï¼Œå°±å¯ä»¥ç†è§£ã€‚å¦å¤–å› ä¸ºéƒ½æ˜¯ç”¨æ¥å£åšçš„äº¤äº’ï¼Œæœªæ¥ç»´æŠ¤å’Œæ·»åŠ æ–°çš„åŠŸèƒ½ï¼Œä¹ŸåŸºæœ¬ä¸Šæ»¡è¶³ OCP åŸåˆ™ï¼Œé™¤äº† dispatch å‡½æ•°éœ€è¦å¾ˆå°çš„ä¿®æ”¹å¤–ï¼Œå…¶å®ƒæ–°çš„ä»£ç éƒ½æ˜¯åœ¨å®ç°ä¸€äº›æ¥å£è€Œå·²ã€‚</p>
<blockquote>
<p>ç›¸ä¿¡ä½ èƒ½åˆæ­¥æ„Ÿå—åˆ°åœ¨ Rust ä¸‹æ’°å†™ä»£ç çš„æœ€ä½³å®è·µã€‚å¦‚æœä½ ä¹‹å‰ç”¨å…¶ä»–è¯­è¨€ï¼Œå·²ç»é‡‡ç”¨äº†ç±»ä¼¼çš„æœ€ä½³å®è·µï¼Œé‚£ä¹ˆå¯ä»¥æ„Ÿå—ä¸€ä¸‹åŒæ ·çš„å®è·µåœ¨ Rust ä¸‹ä½¿ç”¨çš„é‚£ç§ä¼˜é›…ï¼›å¦‚æœä½ ä¹‹å‰ç”±äºç§ç§åŸå› ï¼Œå†™çš„æ˜¯ç±»ä¼¼ä¹‹å‰æ„å¤§åˆ©é¢æ¡ä¼¼çš„ä»£ç ï¼Œé‚£åœ¨å¼€å‘ Rust ç¨‹åºæ—¶ï¼Œä½ å¯ä»¥è¯•ç€æ¥çº³è¿™ç§æ›´ä¼˜é›…çš„å¼€å‘æ–¹å¼ã€‚</p>
</blockquote>
<p>æ¯•ç«Ÿï¼Œç°åœ¨æˆ‘ä»¬æ‰‹ä¸­æœ‰äº†æ›´å…ˆè¿›çš„æ­¦å™¨ï¼Œå°±å¯ä»¥ç”¨æ›´å…ˆè¿›çš„æ‰“æ³•ã€‚</p>
</div>
</details>
<h2 id="ä¸ºå‰©ä¸‹6ä¸ªå‘½ä»¤æ„å»ºæµ‹è¯•å¹¶å®ç°"><a class="header" href="#ä¸ºå‰©ä¸‹6ä¸ªå‘½ä»¤æ„å»ºæµ‹è¯•å¹¶å®ç°">ä¸ºå‰©ä¸‹6ä¸ªå‘½ä»¤æ„å»ºæµ‹è¯•å¹¶å®ç°</a></h2>
<p>ä¸ºå‰©ä¸‹ 6 ä¸ªå‘½ä»¤ HMGETã€HMSETã€HDELã€HMDELã€HEXISTã€HMEXIST æ„å»ºæµ‹è¯•ï¼Œå¹¶å®ç°å®ƒä»¬ã€‚åœ¨æµ‹è¯•å’Œå®ç°è¿‡ç¨‹ä¸­ï¼Œä½ ä¹Ÿè®¸éœ€è¦æ·»åŠ æ›´å¤šçš„ From<T> çš„å®ç°ã€‚</p>
<h2 id="è€ƒè™‘ç”¨çº¿ç¨‹æ± å¤„ç†å¹¶å‘"><a class="header" href="#è€ƒè™‘ç”¨çº¿ç¨‹æ± å¤„ç†å¹¶å‘">è€ƒè™‘ç”¨çº¿ç¨‹æ± å¤„ç†å¹¶å‘</a></h2>
<p>è™½ç„¶æˆ‘ä»¬çš„ KV server ä½¿ç”¨äº† concurrent hashmap æ¥å¤„ç†å¹¶å‘ï¼Œä½†è¿™å¹¶ä¸ä¸€å®šæ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ HashMapã€‚å½“ HGET/HSET ç­‰å‘½ä»¤æ¥ä¸´æ—¶ï¼Œå¯ä»¥å¯¹ key åšä¸ªå“ˆå¸Œï¼Œç„¶ååˆ†æ´¾åˆ° â€œæ‹¥æœ‰â€ é‚£ä¸ª key
çš„çº¿ç¨‹ï¼Œè¿™æ ·ï¼Œå¯ä»¥é¿å…åœ¨å¤„ç†çš„æ—¶å€™åŠ é”ï¼Œæé«˜ç³»ç»Ÿçš„ååã€‚ä½ å¯ä»¥æƒ³æƒ³å¦‚æœç”¨è¿™ç§æ–¹å¼å¤„ç†ï¼Œè¯¥æ€ä¹ˆåšã€‚</p>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="kv1_basic.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="kv3_advanced_traits.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="kv1_basic.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="kv3_advanced_traits.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
