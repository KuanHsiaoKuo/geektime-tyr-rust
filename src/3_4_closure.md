# å››ã€é—­åŒ…ç»“æ„

<!--ts-->
* [å››ã€é—­åŒ…ç»“æ„](#å››é—­åŒ…ç»“æ„)
   * [é—­åŒ…çš„å®šä¹‰](#é—­åŒ…çš„å®šä¹‰)
   * [é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆï¼Ÿ](#é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆ)
      * [åŒ¿åç»“æ„ä½“ï¼š é»˜è®¤å€Ÿç”¨ï¼Œmoveè½¬ç§»](#åŒ¿åç»“æ„ä½“-é»˜è®¤å€Ÿç”¨moveè½¬ç§»)
      * [é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³](#é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³)
      * [å†…å­˜å¸ƒå±€](#å†…å­˜å¸ƒå±€)
      * [ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡](#ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡)
      * [Rustçš„è®¾è®¡å¦‚ä½•ä¿è¯é—­åŒ…æ€§èƒ½](#rustçš„è®¾è®¡å¦‚ä½•ä¿è¯é—­åŒ…æ€§èƒ½)
   * [ä»Rust çš„é—­åŒ…ç±»å‹å¼€å§‹æ€è€ƒ<g-emoji class="g-emoji" alias="thinking" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png">ğŸ¤”</g-emoji>](#ä»rust-çš„é—­åŒ…ç±»å‹å¼€å§‹æ€è€ƒ)
      * [ä½œä¸ºå‡½æ•°çš„å‚æ•°](#ä½œä¸ºå‡½æ•°çš„å‚æ•°)
      * [ä½œä¸ºå‡½æ•°çš„è¿”å›](#ä½œä¸ºå‡½æ•°çš„è¿”å›)
      * [ä¸ºé—­åŒ…å®ç°trait](#ä¸ºé—­åŒ…å®ç°trait)
      * [é—­åŒ…æ ¹æ®ä¸åŒtraitçº¦æŸè¡¨ç°ä¸åŒè¡Œä¸º](#é—­åŒ…æ ¹æ®ä¸åŒtraitçº¦æŸè¡¨ç°ä¸åŒè¡Œä¸º)
         * [FnOnce](#fnonce)
         * [æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ](#æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢)
         * [FnMut](#fnmut)
         * [Fn](#fn)
         * [æ€»ç»“ä¸€ä¸‹ä¸‰ç§traité—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»](#æ€»ç»“ä¸€ä¸‹ä¸‰ç§traité—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»)

<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Mon Oct 17 09:54:10 UTC 2022 -->

<!--te-->

## é—­åŒ…çš„å®šä¹‰

~~~admonish info title="é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µ" collapsible=true
é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µï¼š

- é—­åŒ…æ˜¯å°†å‡½æ•°ï¼Œæˆ–è€…è¯´ä»£ç å’Œå…¶ç¯å¢ƒä¸€èµ·å­˜å‚¨çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚
- é—­åŒ…å¼•ç”¨çš„ä¸Šä¸‹æ–‡ä¸­çš„è‡ªç”±å˜é‡ï¼Œä¼šè¢«æ•è·åˆ°é—­åŒ…çš„ç»“æ„ä¸­ï¼Œæˆä¸ºé—­åŒ…ç±»å‹çš„ä¸€éƒ¨åˆ†
- é—­åŒ…ä¼šæ ¹æ®å†…éƒ¨çš„ä½¿ç”¨æƒ…å†µï¼Œæ•è·ç¯å¢ƒä¸­çš„è‡ªç”±å˜é‡ã€‚
~~~

~~~admonish info title="Rustä¸­é—­åŒ…æ•è·è‡ªç”±å˜é‡çš„ä¸¤ä¸ªæ–¹æ³•" collapsible=true
> åœ¨ Rust é‡Œï¼Œé—­åŒ…å¯ä»¥ç”¨ |args| {code} æ¥è¡¨è¿°ï¼Œå›¾ä¸­é—­åŒ… c æ•è·äº†ä¸Šä¸‹æ–‡ä¸­çš„ a å’Œ bï¼Œå¹¶é€šè¿‡å¼•ç”¨æ¥ä½¿ç”¨è¿™ä¸¤ä¸ªè‡ªç”±å˜é‡ï¼š

![19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ](https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F-4897625.jpg)

> é™¤äº†ç”¨å¼•ç”¨æ¥æ•è·è‡ªç”±å˜é‡ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨ move å…³é”®å­— move |args| {code} ã€‚

~~~

~~~admonish info title="thread::spawnçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä½¿ç”¨moveå…³é”®å­—" collapsible=true
æ¯”å¦‚åˆ›å»ºæ–°çº¿ç¨‹çš„ thread::spawnï¼Œå®ƒçš„å‚æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…ï¼š

```rust, editable

pub fn spawn<F, T>(f: F) -> JoinHandle<T> 
where
    F: FnOnce() -> T,
    F: Send + 'static,
    T: Send + 'static,
```
> ä»”ç»†çœ‹è¿™ä¸ªæ¥å£ï¼š

1. F: FnOnce() â†’ Tï¼Œè¡¨æ˜ F æ˜¯ä¸€ä¸ªæ¥å— 0 ä¸ªå‚æ•°ã€è¿”å› T çš„é—­åŒ…ã€‚FnOnce æˆ‘ä»¬ç¨åå†è¯´ã€‚
2. F: Send + 'staticï¼Œè¯´æ˜é—­åŒ… F è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Œå¹¶ä¸”å®ƒè¿˜èƒ½è¢«å‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚a
3. T: Send + 'staticï¼Œè¯´æ˜é—­åŒ… F è¿”å›çš„æ•°æ®ç»“æ„ Tï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Œå¹¶ä¸”å®ƒè¿˜èƒ½è¢«å‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚

> 1 å’Œ 3 éƒ½å¾ˆå¥½ç†è§£ï¼Œ2 å°±æœ‰äº›è´¹è§£äº†ã€‚ä¸€ä¸ªé—­åŒ…ï¼Œå®ƒä¸å°±æ˜¯ä¸€æ®µä»£ç  + è¢«æ•è·çš„å˜é‡ä¹ˆï¼Ÿéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

æ‹†å¼€çœ‹:
- ä»£ç è‡ªç„¶æ˜¯é™æ€ç”Ÿå‘½å‘¨æœŸ
- é‚£ä¹ˆæ˜¯ä¸æ˜¯æ„å‘³ç€è¢«æ•è·çš„å˜é‡ï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Ÿ

> çš„ç¡®å¦‚æ­¤ã€‚åœ¨ä½¿ç”¨ thread::spawn æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ move å…³é”®å­—ï¼ŒæŠŠå˜é‡çš„æ‰€æœ‰æƒä»å½“å‰ä½œç”¨åŸŸç§»åŠ¨åˆ°é—­åŒ…çš„ä½œç”¨åŸŸï¼Œè®© thread::spawn å¯ä»¥æ­£å¸¸ç¼–è¯‘é€šè¿‡ï¼š

```rust, editable

use std::thread;

fn main() {
    let s = String::from("hello world");

    let handle = thread::spawn(move || {
        println!("moved: {:?}", s);
    });

    handle.join().unwrap();
}
```
~~~

> ä½†ä½ æœ‰æ²¡æœ‰å¥½å¥‡è¿‡ï¼ŒåŠ  move å’Œä¸åŠ  moveï¼Œè¿™ä¸¤ç§é—­åŒ…æœ‰ä»€ä¹ˆæœ¬è´¨ä¸Šçš„ä¸åŒï¼Ÿé—­åŒ…ç©¶ç«Ÿæ˜¯ä¸€ç§ä»€ä¹ˆæ ·çš„æ•°æ®ç±»å‹ï¼Œè®©ç¼–è¯‘å™¨å¯ä»¥åˆ¤æ–­å®ƒæ˜¯å¦æ»¡è¶³ Send + 'static å‘¢ï¼Ÿæˆ‘ä»¬ä»é—­åŒ…çš„æœ¬è´¨ä¸‹æ‰‹æ¥å°è¯•å›ç­”è¿™ä¸¤ä¸ªé—®é¢˜ã€‚

## é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆï¼Ÿ

### åŒ¿åç»“æ„ä½“ï¼š é»˜è®¤å€Ÿç”¨ï¼Œmoveè½¬ç§»

1. é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŒ¿åç»“æ„ä½“ï¼Œé•¿åº¦ä¸æ•è·çš„è‡ªç”±å˜é‡ä¸€è‡´
2. é»˜è®¤æ•è·å¼•ç”¨ï¼Œæ­¤æ—¶ç¼–è¯‘å™¨è¿›è¡Œå€Ÿç”¨è§„åˆ™æ£€æŸ¥
3. moveè½¬ç§»æ‰€æœ‰æƒï¼Œæ­¤æ—¶ç¼–è¯‘å™¨æ ¹æ®æ‰€æœ‰æƒè§„åˆ™æ£€æŸ¥

~~~admonish info title="é—­åŒ…çš„æœ¬è´¨æ˜¯åŒ¿åç»“æ„ä½“ï¼Œmoveä¼šè½¬ç§»è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒ" collapsible=true
åœ¨å®˜æ–¹çš„ Rust reference ä¸­ï¼Œæœ‰è¿™æ ·çš„å®šä¹‰ï¼š
> A closure expression produces a closure value with a unique, anonymous type that cannot be written out. A closure type is approximately equivalent to a struct which contains the captured variables.
---
é—­åŒ…æ˜¯ä¸€ç§åŒ¿åç±»å‹ï¼Œä¸€æ—¦å£°æ˜ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œä½†è¿™ä¸ªç±»å‹æ— æ³•è¢«å…¶å®ƒåœ°æ–¹ä½¿ç”¨ã€‚è¿™ä¸ªç±»å‹å°±åƒä¸€ä¸ªç»“æ„ä½“ï¼Œä¼šåŒ…å«æ‰€æœ‰æ•è·çš„å˜é‡ã€‚
~~~

~~~admonish question title="æ‰€ä»¥é—­åŒ…ç±»ä¼¼ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ä½“ï¼Ÿ" collapsible=true

ä¸ºäº†ææ˜ç™½è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¾—å†™æ®µä»£ç æ¢ç´¢ä¸€ä¸‹ï¼Œå»ºè®®ä½ è·Ÿç€æ•²ä¸€éè®¤çœŸæ€è€ƒï¼ˆä»£ç ï¼‰ï¼š

```rust, editable

use std::{collections::HashMap, mem::size_of_val};
fn main() {
    // é•¿åº¦ä¸º 0
    let c1 = || println!("hello world!");
    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
    let c2 = |i: i32| println!("hello: {}", i);
    let name = String::from("tyr");
    let name1 = name.clone();
    let mut table = HashMap::new();
    table.insert("hello", "world");
    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
    let c3 = || println!("hello: {}", name);
    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
    let c4 = move || println!("hello: {}, {:?}", name1, table);
    let name2 = name.clone();
    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
    let c5 = move || {
        let x = 1;
        let name3 = String::from("lindsey");
        println!("hello: {}, {:?}, {:?}", x, name2, name3);
    };

    println!(
        "c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}",
        size_of_val(&c1),
        size_of_val(&c2),
        size_of_val(&c3),
        size_of_val(&c4),
        size_of_val(&c5),
        size_of_val(&main),
    )
}
```
~~~

~~~admonish question title="æŸ¥çœ‹ä¸Šé¢ä»£ç çš„5ä¸ªé—­åŒ…å¾—å‡ºç»“è®º" collapsible=true
> åˆ†åˆ«ç”Ÿæˆäº† 5 ä¸ªé—­åŒ…ï¼š

1. c1 æ²¡æœ‰å‚æ•°ï¼Œä¹Ÿæ²¡æ•è·ä»»ä½•å˜é‡ï¼Œä»ä»£ç è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œc1 é•¿åº¦ä¸º 0ï¼›
2. c2 æœ‰ä¸€ä¸ª i32 ä½œä¸ºå‚æ•°ï¼Œæ²¡æœ‰æ•è·ä»»ä½•å˜é‡ï¼Œé•¿åº¦ä¹Ÿä¸º 0ï¼Œå¯ä»¥çœ‹å‡ºå‚æ•°è·Ÿé—­åŒ…çš„å¤§å°æ— å…³ï¼›
3. c3 æ•è·äº†ä¸€ä¸ªå¯¹å˜é‡ name çš„å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æ˜¯ &Stringï¼Œé•¿åº¦ä¸º 8ã€‚è€Œ c3 çš„é•¿åº¦ä¹Ÿæ˜¯ 8ï¼›
4. c4 æ•è·äº†å˜é‡ name1 å’Œ tableï¼Œç”±äºç”¨äº† moveï¼Œå®ƒä»¬çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°äº† c4 ä¸­ã€‚c4 é•¿åº¦æ˜¯ 72ï¼Œæ°å¥½ç­‰äº String çš„ 24 å­—èŠ‚ï¼ŒåŠ ä¸Š HashMap çš„ 48 å­—èŠ‚ã€‚
5. c5 æ•è·äº† name2ï¼Œname2 çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°äº† c5ï¼Œè™½ç„¶ c5 æœ‰å±€éƒ¨å˜é‡ï¼Œä½†å®ƒçš„å¤§å°å’Œå±€éƒ¨å˜é‡ä¹Ÿæ— å…³ï¼Œc5 çš„å¤§å°ç­‰äº String çš„ 24 å­—èŠ‚ã€‚

> å¯ä»¥çœ‹åˆ°ï¼š
1. ä¸å¸¦ move æ—¶ï¼Œé—­åŒ…æ•è·çš„æ˜¯å¯¹åº”è‡ªç”±å˜é‡çš„å¼•ç”¨ï¼›
2. å¸¦ move æ—¶ï¼Œå¯¹åº”è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒä¼šè¢«ç§»åŠ¨åˆ°é—­åŒ…ç»“æ„ä¸­ã€‚
~~~

### é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³

> ç»§ç»­åˆ†æè¿™æ®µä»£ç çš„è¿è¡Œç»“æœã€‚

~~~admonish info title="é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³" collapsible=true
è¿˜çŸ¥é“äº†ï¼Œé—­åŒ…çš„å¤§å°è·Ÿå‚æ•°ã€å±€éƒ¨å˜é‡éƒ½æ— å…³ï¼Œåªè·Ÿæ•è·çš„å˜é‡æœ‰å…³:
> å› ä¸ºå®ƒä»¬æ˜¯åœ¨è°ƒç”¨çš„æ—¶åˆ»æ‰åœ¨æ ˆä¸Šäº§ç”Ÿçš„å†…å­˜åˆ†é…ï¼Œè¯´åˆ°åº•å’Œé—­åŒ…ç±»å‹æœ¬èº«æ˜¯æ— å…³çš„ï¼Œæ‰€ä»¥é—­åŒ…çš„å¤§å°è·Ÿå®ƒä»¬è‡ªç„¶æ— å…³ã€‚

```rust, editable

use std::{collections::HashMap, mem::size_of_val};
fn main() {
    // é•¿åº¦ä¸º 0
    let c1 = || println!("hello world!");
    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
    let c2 = |i: i32| println!("hello: {}", i);
    let name = String::from("tyr");
    let name1 = name.clone();
    let mut table = HashMap::new();
    table.insert("hello", "world");
    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
    let c3 = || println!("hello: {}", name);
    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
    let c4 = move || println!("hello: {}, {:?}", name1, table);
    let name2 = name.clone();
    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
    let c5 = move || {
        let x = 1;
        let name3 = String::from("lindsey");
        println!("hello: {}, {:?}, {:?}", x, name2, name3);
    };

    println!(
        "c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}",
        size_of_val(&c1),
        size_of_val(&c2),
        size_of_val(&c3),
        size_of_val(&c4),
        size_of_val(&c5),
        size_of_val(&main),
    )
}
```

~~~

### å†…å­˜å¸ƒå±€

> æ—¢ç„¶é—­åŒ…æ˜¯åŒ¿åç»“æ„ä½“ï¼Œé‚£ä¹ˆå®ƒçš„å†…å­˜å¸ƒå±€ä¸ç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

~~~admonish info title="é—­åŒ…çš„å†…å­˜å¸ƒå±€ä¸ç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" collapsible=true

é‚£ä¸€ä¸ªé—­åŒ…ç±»å‹åœ¨å†…å­˜ä¸­ç©¶ç«Ÿæ˜¯å¦‚ä½•æ’å¸ƒçš„ï¼Œå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

> æˆ‘ä»¬è¦å†æ¬¡ç»“åˆ rust-gdb æ¢ç´¢ï¼Œçœ‹çœ‹ä¸Šé¢çš„ä»£ç åœ¨è¿è¡Œç»“æŸå‰ï¼Œå‡ ä¸ªé•¿åº¦ä¸ä¸º 0 é—­åŒ…å†…å­˜é‡Œéƒ½æ”¾äº†ä»€ä¹ˆï¼š

![19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ](https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F-4897598.png)
---
å¯ä»¥çœ‹åˆ°:
1. c3 çš„ç¡®æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼ŒæŠŠå®ƒæŒ‡å‘çš„å†…å­˜åœ°å€çš„ 24 ä¸ªå­—èŠ‚æ‰“å‡ºæ¥ï¼Œæ˜¯ (ptr | cap | len) çš„æ ‡å‡†ç»“æ„ã€‚å¦‚æœæ‰“å° ptr å¯¹åº”çš„å †å†…å­˜çš„ 3 ä¸ªå­—èŠ‚ï¼Œæ˜¯ â€˜tâ€™ â€˜yâ€™ â€˜râ€™ã€‚
2. è€Œ c4 æ•è·çš„ name å’Œ tableï¼Œå†…å­˜ç»“æ„å’Œä¸‹é¢çš„ç»“æ„ä½“ä¸€æ¨¡ä¸€æ ·ï¼š

```rust, editable

struct Closure4 {
    name: String,  // (ptr|cap|len)=24å­—èŠ‚
    table: HashMap<&str, &str> // (RandomState(16)|mask|ctrl|left|len)=48å­—èŠ‚
}
```

ä¸è¿‡ï¼Œå¯¹äº closure ç±»å‹æ¥è¯´ï¼Œç¼–è¯‘å™¨çŸ¥é“åƒå‡½æ•°ä¸€æ ·è°ƒç”¨é—­åŒ… c4() æ˜¯åˆæ³•çš„ï¼Œå¹¶ä¸”çŸ¥é“æ‰§è¡Œ c4() æ—¶ï¼Œä»£ç åº”è¯¥è·³è½¬åˆ°ä»€ä¹ˆåœ°å€æ¥æ‰§è¡Œã€‚
åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ° nameã€tableï¼Œå¯ä»¥ä»è‡ªå·±çš„æ•°æ®ç»“æ„ä¸­è·å–ã€‚

é‚£ä¹ˆå¤šæƒ³ä¸€æ­¥ï¼Œé—­åŒ…æ•è·å˜é‡çš„é¡ºåºï¼Œå’Œå…¶å†…å­˜ç»“æ„çš„é¡ºåºæ˜¯ä¸€è‡´çš„ä¹ˆï¼Ÿ

çš„ç¡®å¦‚æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è°ƒæ•´é—­åŒ…é‡Œä½¿ç”¨ name1 å’Œ table çš„é¡ºåºï¼š

```rust, editable

let c4 = move || println!("hello: {:?}, {}", table, name1);
```

å…¶æ•°æ®çš„ä½ç½®æ˜¯ç›¸åçš„ï¼Œç±»ä¼¼äºï¼š

```rust, editable

struct Closure4 {
    table: HashMap<&str, &str> // (RandomState(16)|mask|ctrl|left|len)=48å­—èŠ‚
    name: String,  // (ptr|cap|len)=24å­—èŠ‚
}
```

ä» gdb ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°åŒæ ·çš„ç»“æœï¼š

![19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ](https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F.png)

> ä¸è¿‡è¿™åªæ˜¯é€»è¾‘ä¸Šçš„ä½ç½®ï¼ŒRust ç¼–è¯‘å™¨ä¼šé‡æ’å†…å­˜ï¼Œè®©æ•°æ®èƒ½å¤Ÿä»¥æœ€å°çš„ä»£ä»·å¯¹é½ï¼Œæ‰€ä»¥æœ‰äº›æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸­æ•°æ®çš„é¡ºåºå¯èƒ½å’Œ struct å®šä¹‰ä¸ä¸€è‡´ã€‚

æ‰€ä»¥å›åˆ°åˆšæ‰é—­åŒ…å’Œç»“æ„ä½“çš„æ¯”è¾ƒï¼š

1. åœ¨ Rust é‡Œï¼Œé—­åŒ…äº§ç”Ÿçš„åŒ¿åæ•°æ®ç±»å‹ï¼Œæ ¼å¼å’Œ struct æ˜¯ä¸€æ ·çš„ã€‚
2. çœ‹å›¾ä¸­ gdb çš„è¾“å‡ºï¼Œé—­åŒ…æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå¹¶ä¸”é™¤äº†æ•è·çš„æ•°æ®å¤–ï¼Œé—­åŒ…æœ¬èº«ä¸åŒ…å«ä»»ä½•é¢å¤–å‡½æ•°æŒ‡é’ˆæŒ‡å‘é—­åŒ…çš„ä»£ç ã€‚
3. å¦‚æœä½ ç†è§£äº† c3 / c4 è¿™ä¸¤ä¸ªé—­åŒ…ï¼Œc5 æ˜¯å¦‚ä½•æ„é€ çš„å°±å¾ˆå¥½ç†è§£äº†ã€‚

ç°åœ¨ï¼Œä½ æ˜¯ä¸æ˜¯å¯ä»¥å›ç­”ä¸ºä»€ä¹ˆ thread::spawn å¯¹ä¼ å…¥çš„é—­åŒ…çº¦æŸæ˜¯ Send + 'static äº†ï¼Ÿç©¶ç«Ÿä»€ä¹ˆæ ·çš„é—­åŒ…æ»¡è¶³å®ƒå‘¢ï¼Ÿ

> å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨äº† move ä¸” move åˆ°é—­åŒ…å†…çš„æ•°æ®ç»“æ„æ»¡è¶³ Sendï¼Œå› ä¸ºæ­¤æ—¶ï¼Œé—­åŒ…çš„æ•°æ®ç»“æ„æ‹¥æœ‰æ‰€æœ‰æ•°æ®çš„æ‰€æœ‰æƒï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ 'staticã€‚
~~~

çœ‹å®Œ Rust é—­åŒ…çš„å†…å­˜ç»“æ„ï¼Œä½ æ˜¯ä¸æ˜¯æƒ³è¯´â€œå°±è¿™â€ï¼Œæ²¡å•¥ç‹¬ç‰¹ä¹‹å¤„å§ï¼Ÿä½†æ˜¯å¯¹æ¯”å…¶ä»–è¯­è¨€ï¼Œç»“åˆæ¥ä¸‹æ¥æˆ‘çš„è§£é‡Šï¼Œä½ å†ä»”ç»†æƒ³æƒ³å°±ä¼šæœ‰ä¸€ç§â€œè¿™æ€ä¹ˆå¯èƒ½â€çš„æƒŠè®¶ã€‚

### ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡

~~~admonish info title="å…¶ä»–è¯­è¨€é—­åŒ…è®¾è®¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ" collapsible=true
é—­åŒ…æœ€å¤§çš„é—®é¢˜æ˜¯å˜é‡çš„å¤šé‡å¼•ç”¨å¯¼è‡´ç”Ÿå‘½å‘¨æœŸä¸æ˜ç¡®ï¼Œæ‰€ä»¥ä½ å…ˆæƒ³ï¼Œå…¶å®ƒæ”¯æŒé—­åŒ…çš„è¯­è¨€ï¼ˆlambda ä¹Ÿæ˜¯é—­åŒ…ï¼‰ï¼Œå®ƒä»¬çš„é—­åŒ…ä¼šæ”¾åœ¨å“ªé‡Œï¼Ÿ

æ ˆä¸Šä¹ˆï¼Ÿæ˜¯ï¼Œåˆå¥½åƒä¸æ˜¯ã€‚

å› ä¸ºé—­åŒ…è¿™ç©æ„ï¼Œä»å½“å‰ä¸Šä¸‹æ–‡ä¸­æ•è·äº†äº›å˜é‡ï¼Œå˜å¾—æœ‰ç‚¹ä¸ä¼¦ä¸ç±»ï¼Œä¸åƒå‡½æ•°é‚£æ ·æ¸…æ¥šï¼Œå°¤å…¶æ˜¯è¿™äº›è¢«æ•è·çš„å˜é‡ï¼Œå®ƒä»¬çš„å½’å±å’Œç”Ÿå‘½å‘¨æœŸå¤„ç†èµ·æ¥å¾ˆéº»çƒ¦ã€‚æ‰€ä»¥ï¼Œå¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€çš„é—­åŒ…å¾ˆå¤šæ—¶å€™æ— æ³•æ”¾åœ¨æ ˆä¸Šï¼Œéœ€è¦é¢å¤–çš„å †åˆ†é…ã€‚[ä½ å¯ä»¥çœ‹è¿™ä¸ª Golang çš„ä¾‹å­](https://github.com/golang/go/issues/43210)ã€‚


ä¸å…‰ Golangï¼ŒJava / Swift / Python / JavaScript ç­‰è¯­è¨€éƒ½æ˜¯å¦‚æ­¤ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€é—­åŒ…çš„æ€§èƒ½è¦è¿œä½äºå‡½æ•°è°ƒç”¨ã€‚

å› ä¸ºä½¿ç”¨é—­åŒ…å°±æ„å‘³ç€ï¼š
1. é¢å¤–çš„å †å†…å­˜åˆ†é…
2. æ½œåœ¨çš„åŠ¨æ€åˆ†æ´¾ï¼ˆå¾ˆå¤šè¯­è¨€ä¼šæŠŠé—­åŒ…å¤„ç†æˆå‡½æ•°æŒ‡é’ˆï¼‰
3. é¢å¤–çš„å†…å­˜å›æ”¶ã€‚

åœ¨æ€§èƒ½ä¸Šï¼Œå”¯æœ‰ C++ çš„ lambda å’Œ Rust é—­åŒ…ç±»ä¼¼ï¼Œä¸è¿‡ C++ çš„é—­åŒ…è¿˜æœ‰ä¸€äº›åœºæ™¯ä¼šè§¦å‘å †å†…å­˜åˆ†é…ã€‚

Rust / Swift / Kotlin iterator å‡½æ•°å¼ç¼–ç¨‹çš„æ€§èƒ½æµ‹è¯•ï¼š
1. Kotlin è¿è¡Œè¶…æ—¶
2. Swift å¾ˆæ…¢
3. Rust çš„æ€§èƒ½å´å’Œä½¿ç”¨å‘½ä»¤å¼ç¼–ç¨‹çš„ C å‡ ä¹ä¸€æ ·ï¼Œé™¤äº†ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ•ˆæœï¼Œä¹Ÿå› ä¸º Rust é—­åŒ…çš„æ€§èƒ½å’Œå‡½æ•°å·®ä¸å¤šã€‚
~~~

### Rustçš„è®¾è®¡å¦‚ä½•ä¿è¯é—­åŒ…æ€§èƒ½

~~~admonish info title="ä¸ºä½•Rustå¯ä»¥ä¿è¯é—­åŒ…çš„æ€§èƒ½ä¸å‡½æ•°å·®ä¸å¤š: åŒ¿åç»“æ„ä½“ã€å€Ÿç”¨ or è½¬ç§»æ‰€æœ‰æƒ" collapsible=true
> ä¸ºä»€ä¹ˆ Rust å¯ä»¥åšåˆ°è¿™æ ·å‘¢ï¼Ÿ

è¿™åˆè·Ÿ Rust ä»æ ¹æœ¬ä¸Šä½¿ç”¨æ‰€æœ‰æƒå’Œå€Ÿç”¨ï¼Œè§£å†³äº†å†…å­˜å½’å±é—®é¢˜æœ‰å…³ã€‚

åœ¨å…¶ä»–è¯­è¨€ä¸­ï¼Œé—­åŒ…å˜é‡å› ä¸ºå¤šé‡å¼•ç”¨å¯¼è‡´ç”Ÿå‘½å‘¨æœŸä¸æ˜ç¡®ï¼Œä½† Rust ä»ä¸€å¼€å§‹å°±æ¶ˆç­äº†è¿™ä¸ªé—®é¢˜ï¼š

- å¦‚æœä¸ä½¿ç”¨ move è½¬ç§»æ‰€æœ‰æƒï¼š

é—­åŒ…ä¼šå¼•ç”¨ä¸Šä¸‹æ–‡ä¸­çš„å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å—å€Ÿç”¨è§„åˆ™çš„çº¦æŸï¼Œæ‰€ä»¥åªè¦ç¼–è¯‘é€šè¿‡ï¼Œé‚£ä¹ˆé—­åŒ…å¯¹å˜é‡çš„å¼•ç”¨å°±ä¸ä¼šè¶…è¿‡å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ²¡æœ‰å†…å­˜å®‰å…¨é—®é¢˜ã€‚

- å¦‚æœä½¿ç”¨ move è½¬ç§»æ‰€æœ‰æƒï¼š

ä¸Šä¸‹æ–‡ä¸­çš„å˜é‡åœ¨è½¬ç§»åå°±æ— æ³•è®¿é—®ï¼Œé—­åŒ…å®Œå…¨æ¥ç®¡è¿™äº›å˜é‡ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œé—­åŒ…ä¸€è‡´ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šæœ‰å†…å­˜å®‰å…¨é—®é¢˜ã€‚

- åŒ¿åç»“æ„ä½“çš„å¥½å¤„ï¼š

è€Œ Rust ä¸ºæ¯ä¸ªé—­åŒ…ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œåˆä½¿å¾—è°ƒç”¨é—­åŒ…æ—¶å¯ä»¥ç›´æ¥å’Œä»£ç å¯¹åº”ï¼Œçœå»äº†ä½¿ç”¨å‡½æ•°æŒ‡é’ˆå†è½¬ä¸€é“æ‰‹çš„é¢å¤–æ¶ˆè€—ã€‚

> æ‰€ä»¥è¿˜æ˜¯é‚£å¥è¯ï¼Œå½“å›å½’åˆ°æœ€åˆçš„æœ¬åŸï¼Œä½ è§£å†³çš„ä¸æ˜¯å•ä¸ªé—®é¢˜ï¼Œè€Œæ˜¯ç”±æ­¤å¼•å‘çš„æ‰€æœ‰é—®é¢˜ï¼š

æˆ‘ä»¬ä¸å¿…ä¸ºå †å†…å­˜ç®¡ç†è®¾è®¡ GCã€ä¸å¿…ä¸ºå…¶å®ƒèµ„æºçš„å›æ”¶æä¾› defer å…³é”®å­—ã€ä¸å¿…ä¸ºå¹¶å‘å®‰å…¨è¿›è¡Œè¯¸å¤šé™åˆ¶ã€ä¹Ÿä¸å¿…ä¸ºé—­åŒ…æŒ–ç©ºå¿ƒæ€æä¼˜åŒ–ã€‚
~~~

## ä»Rust çš„é—­åŒ…ç±»å‹å¼€å§‹æ€è€ƒğŸ¤”

ç°åœ¨æˆ‘ä»¬ææ˜ç™½äº†é—­åŒ…ç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œåœ¨å†…å­˜ä¸­æ€ä¹ˆè¡¨ç¤ºï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ FnOnce / FnMut / Fn è¿™ä¸‰ç§é—­åŒ…ç±»å‹æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚

> æ—¢ç„¶é—­åŒ…æ˜¯ä¸€ä¸ªåŒ¿åç»“æ„ä½“ç±»å‹ï¼Œå°±å¯ä»¥æœ‰ä¸‰ä¸ªæ€è€ƒï¼š
1. å¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°æˆ–è¿”å›
2. å¯ä»¥å¯¹å…¶æ·»åŠ traitå®ç°ï¼›
3. å¯ä»¥ç”¨åœ¨traitçº¦æŸï¼›äº‹å®ä¸Šï¼Œrustå·²ç»åšäº†è¿™ä»¶äº‹ï¼Œæä¾›Fn/FnMut/FnOnceè¿™ä¸‰ä¸ª
- åœ¨å£°æ˜é—­åŒ…çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦æŒ‡å®šé—­åŒ…è¦æ»¡è¶³çš„çº¦æŸ
- ä½†æ˜¯å½“é—­åŒ…ä½œä¸ºå‡½æ•°çš„å‚æ•°æˆ–è€…æ•°æ®ç»“æ„çš„ä¸€ä¸ªåŸŸæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰è°ƒç”¨è€…ï¼Œå¯¹é—­åŒ…çš„çº¦æŸã€‚

ä¸‹é¢ğŸ‘‡ä¸€ä¸€è¯´æ˜

### ä½œä¸ºå‡½æ•°çš„å‚æ•°

~~~admonish info title="åœ¨å‡½æ•°çš„å‚æ•°ä¸­ä½¿ç”¨é—­åŒ…" collapsible=true
thread::spawn è‡ªä¸å¿…è¯´ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ Iterator trait é‡Œé¢å¤§éƒ¨åˆ†å‡½æ•°éƒ½æ¥å—ä¸€ä¸ªé—­åŒ…ï¼Œ[æ¯”å¦‚ map](https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#682-685)ï¼š
```rust, editable

fn map<B, F>(self, f: F) -> Map<Self, F>
where
    Self: Sized,
    F: FnMut(Self::Item) -> B,
{
    Map::new(self, f)
}
```

1. å¯ä»¥çœ‹åˆ°ï¼ŒIterator çš„ map() æ–¹æ³•æ¥å—ä¸€ä¸ª FnMut
2. å®ƒçš„å‚æ•°æ˜¯ Self::Item
3. è¿”å›å€¼æ˜¯æ²¡æœ‰çº¦æŸçš„æ³›å‹å‚æ•° Bã€‚
4. Self::Item æ˜¯ Iterator::next() æ–¹æ³•åå‡ºæ¥çš„æ•°æ®ï¼Œè¢« map ä¹‹åï¼Œå¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªç»“æœã€‚

æ‰€ä»¥åœ¨å‡½æ•°çš„å‚æ•°ä¸­ä½¿ç”¨é—­åŒ…ï¼Œæ˜¯é—­åŒ…ä¸€ç§éå¸¸å…¸å‹çš„ç”¨æ³•ã€‚
~~~

### ä½œä¸ºå‡½æ•°çš„è¿”å›

~~~admonish info title="åœ¨å‡½æ•°çš„è¿”å›å€¼ä¸­ä½¿ç”¨é—­åŒ…" collapsible=true
å¦å¤–é—­åŒ…ä¹Ÿå¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š

```rust, editable

use std::ops::Mul;

fn main() {
    let c1 = curry(5);
    println!("5 multiply 2 is: {}", c1(2));

    let adder2 = curry(3.14);
    println!("pi multiply 4^2 is: {}", adder2(4. * 4.));
}

fn curry<T>(x: T) -> impl Fn(T) -> T
where
    T: Mul<Output = T> + Copy,
{
    move |y| x * y
}
```
~~~

### ä¸ºé—­åŒ…å®ç°trait

~~~admonish info title="ä¸ºé—­åŒ…å®ç°æŸä¸ª traitï¼Œä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨ã€‚" collapsible=true
é—­åŒ…è¿˜æœ‰ä¸€ç§å¹¶ä¸å°‘è§ï¼Œä½†å¯èƒ½ä¸å¤ªå®¹æ˜“ç†è§£çš„ç”¨æ³•ï¼š

ä¸ºå®ƒå®ç°æŸä¸ª traitï¼Œä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨ã€‚

æ¯”å¦‚è¯´æœ‰äº›æ¥å£æ—¢å¯ä»¥ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“ï¼Œåˆå¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°æˆ–è€…é—­åŒ…ã€‚

> æˆ‘ä»¬çœ‹ä¸€ä¸ª [tonicï¼ˆRust ä¸‹çš„ gRPC åº“ï¼‰](https://github.com/hyperium/tonic)çš„[ä¾‹å­](https://docs.rs/tonic/0.5.2/src/tonic/service/interceptor.rs.html#41-53)

```rust, editable

pub trait Interceptor {
    /// Intercept a request before it is sent, optionally cancelling it.
    fn call(&mut self, request: crate::Request<()>) -> Result<crate::Request<()>, Status>;
}

impl<F> Interceptor for F
where
    F: FnMut(crate::Request<()>) -> Result<crate::Request<()>, Status>,
{
    fn call(&mut self, request: crate::Request<()>) -> Result<crate::Request<()>, Status> {
        self(request)
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼ŒInterceptor æœ‰ä¸€ä¸ª call æ–¹æ³•ï¼Œå®ƒå¯ä»¥è®© gRPC Request è¢«å‘é€å‡ºå»ä¹‹å‰è¢«ä¿®æ”¹ï¼Œä¸€èˆ¬æ˜¯æ·»åŠ å„ç§å¤´ï¼Œæ¯”å¦‚ Authorization å¤´ã€‚

æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œä¸ºå®ƒå®ç° Interceptorï¼Œä¸è¿‡å¤§éƒ¨åˆ†æ—¶å€™ Interceptor å¯ä»¥ç›´æ¥é€šè¿‡ä¸€ä¸ªé—­åŒ…å‡½æ•°å®Œæˆã€‚ä¸ºäº†è®©ä¼ å…¥çš„é—­åŒ…ä¹Ÿèƒ½é€šè¿‡ Interceptor::call() æ¥ç»Ÿä¸€è°ƒç”¨ï¼Œå¯ä»¥ä¸ºç¬¦åˆæŸä¸ªæ¥å£çš„é—­åŒ…å®ç° Interceptor traitã€‚æŒæ¡äº†è¿™ç§ç”¨æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŸäº› trait æŠŠç‰¹å®šçš„ç»“æ„ä½“å’Œé—­åŒ…ç»Ÿä¸€èµ·æ¥è°ƒç”¨ï¼Œæ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ã€‚
~~~

### é—­åŒ…æ ¹æ®ä¸åŒtraitçº¦æŸè¡¨ç°ä¸åŒè¡Œä¸º

> è¿˜ä»¥ thread::spawn ä¸ºä¾‹ï¼Œå®ƒè¦æ±‚ä¼ å…¥çš„é—­åŒ…æ»¡è¶³ FnOnce traitã€‚

#### FnOnce

~~~admonish info title="FnOnceå®šä¹‰->ä¾‹å­è§£æ" collapsible=true
å…ˆæ¥çœ‹ FnOnceã€‚å®ƒçš„[å®šä¹‰](https://doc.rust-lang.org/std/ops/trait.FnOnce.html)å¦‚ä¸‹ï¼š

```rust, editable

pub trait FnOnce<Args> {
    type Output;
    extern "rust-call" fn call_once(self, args: Args) -> Self::Output;
}
```

1. FnOnce æœ‰ä¸€ä¸ªå…³è”ç±»å‹ Outputï¼Œæ˜¾ç„¶ï¼Œå®ƒæ˜¯é—­åŒ…è¿”å›å€¼çš„ç±»å‹ï¼›
2. è¿˜æœ‰ä¸€ä¸ªæ–¹æ³• call_onceï¼Œè¦æ³¨æ„çš„æ˜¯ call_once ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼Œå®ƒä¼šè½¬ç§» self çš„æ‰€æœ‰æƒåˆ° call_once å‡½æ•°ä¸­ã€‚

> è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ FnOnce è¢«ç§°ä½œ Once ï¼šå®ƒåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚å†æ¬¡è°ƒç”¨ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥å˜é‡å·²ç»è¢« move è¿™æ ·çš„å¸¸è§æ‰€æœ‰æƒé”™è¯¯äº†ã€‚

è‡³äº FnOnce çš„å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå« Args çš„æ³›å‹å‚æ•°ï¼Œå®ƒå¹¶æ²¡æœ‰ä»»ä½•çº¦æŸã€‚

çœ‹ä¸€ä¸ªéšå¼çš„ FnOnce çš„ä¾‹å­ï¼š

```rust, editable

fn main() {
    let name = String::from("Tyr");
    // è¿™ä¸ªé—­åŒ…å•¥ä¹Ÿä¸å¹²ï¼Œåªæ˜¯æŠŠæ•è·çš„å‚æ•°è¿”å›å»
    let c = move |greeting: String| (greeting, name);

    let result = c("hello".to_string());

    println!("result: {:?}", result);

    // æ— æ³•å†æ¬¡è°ƒç”¨
    let result = c("hi".to_string());
}
```

1. è¿™ä¸ªé—­åŒ… cï¼Œå•¥ä¹Ÿæ²¡åšï¼Œåªæ˜¯æŠŠæ•è·çš„å‚æ•°è¿”å›ã€‚
2. å°±åƒä¸€ä¸ªç»“æ„ä½“é‡Œï¼ŒæŸä¸ªå­—æ®µè¢«è½¬ç§»èµ°ä¹‹åï¼Œå°±ä¸èƒ½å†è®¿é—®ä¸€æ ·ï¼Œé—­åŒ…å†…éƒ¨çš„æ•°æ®ä¸€æ—¦è¢«è½¬ç§»ï¼Œè¿™ä¸ªé—­åŒ…å°±ä¸å®Œæ•´äº†ï¼Œä¹Ÿå°±æ— æ³•å†æ¬¡ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª FnOnce çš„é—­åŒ…ã€‚

å¦‚æœä¸€ä¸ªé—­åŒ…å¹¶ä¸è½¬ç§»è‡ªå·±çš„å†…éƒ¨æ•°æ®ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯ FnOnceï¼Œç„¶è€Œï¼Œä¸€æ—¦å®ƒè¢«å½“åš FnOnce è°ƒç”¨ï¼Œè‡ªå·±ä¼šè¢«è½¬ç§»åˆ° call_once å‡½æ•°çš„ä½œç”¨åŸŸä¸­ï¼Œä¹‹åå°±æ— æ³•å†æ¬¡è°ƒç”¨äº†ï¼Œæˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š

```rust, editable

fn main() {
    let name = String::from("Tyr");

    // è¿™ä¸ªé—­åŒ…ä¼š clone å†…éƒ¨çš„æ•°æ®è¿”å›ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯ FnOnce
    let c = move |greeting: String| (greeting, name.clone());

    // æ‰€ä»¥ c1 å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡

    println!("c1 call once: {:?}", c("qiao".into()));
    println!("c1 call twice: {:?}", c("bonjour".into()));

    // ç„¶è€Œä¸€æ—¦å®ƒè¢«å½“æˆ FnOnce è¢«è°ƒç”¨ï¼Œå°±æ— æ³•è¢«å†æ¬¡è°ƒç”¨
    println!("result: {:?}", call_once("hi".into(), c));

    // æ— æ³•å†æ¬¡è°ƒç”¨
    // let result = c("hi".to_string());

    // Fn ä¹Ÿå¯ä»¥è¢«å½“æˆ FnOnce è°ƒç”¨ï¼Œåªè¦æ¥å£ä¸€è‡´å°±å¯ä»¥
    println!("result: {:?}", call_once("hola".into(), not_closure));
}

fn call_once(arg: String, c: impl FnOnce(String) -> (String, String)) -> (String, String) {
    c(arg)
}

fn not_closure(arg: String) -> (String, String) {
    (arg, "Rosie".into())
}
```

~~~

#### æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ

~~~admonish info title="æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ" collapsible=true
Args åˆæ˜¯æ€ä¹ˆå’Œ FnOnce çš„çº¦æŸï¼Œæ¯”å¦‚ FnOnce(String) è¿™æ ·çš„å‚æ•°åŒ¹é…å‘¢ï¼Ÿæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå®ƒï¼ˆä¸å®Œå…¨ï¼‰æ¨¡æ‹Ÿäº† FnOnce ä¸­é—­åŒ…çš„ä½¿ç”¨ï¼ˆä»£ç ï¼‰ï¼š
```rust, editable

struct ClosureOnce<Captured, Args, Output> {
    // æ•è·çš„æ•°æ®
    captured: Captured,
    // closure çš„æ‰§è¡Œä»£ç 
    func: fn(Args, Captured) -> Output,
}

impl<Captured, Args, Output> ClosureOnce<Captured, Args, Output> {
    // æ¨¡æ‹Ÿ FnOnce çš„ call_onceï¼Œç›´æ¥æ¶ˆè€— self
    fn call_once(self, greeting: Args) -> Output {
        (self.func)(greeting, self.captured)
    }
}

// ç±»ä¼¼ greeting é—­åŒ…çš„å‡½æ•°ä½“
fn greeting_code1(args: (String,), captured: (String,)) -> (String, String) {
    (args.0, captured.0)
}

fn greeting_code2(args: (String, String), captured: (String, u8)) -> (String, String, String, u8) {
    (args.0, args.1, captured.0, captured.1)
}

fn main() {
    let name = "Tyr".into();
    // æ¨¡æ‹Ÿå˜é‡æ•æ‰
    let c = ClosureOnce {
        captured: (name,),
        func: greeting_code1,
    };

    // æ¨¡æ‹Ÿé—­åŒ…è°ƒç”¨ï¼Œè¿™é‡Œå’Œ FnOnce ä¸å®Œå…¨ä¸€æ ·ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ª tuple æ¥åŒ¹é… Args å‚æ•°
    println!("{:?}", c.call_once(("hola".into(),)));
    // è°ƒç”¨ä¸€æ¬¡åæ— æ³•ç»§ç»­è°ƒç”¨
    // println!("{:?}", clo.call_once("hola".into()));

    // æ›´å¤æ‚ä¸€äº›çš„å¤æ‚çš„é—­åŒ…
    let c1 = ClosureOnce {
        captured: ("Tyr".into(), 18),
        func: greeting_code2,
    };

    println!("{:?}", c1.call_once(("hola".into(), "hallo".into())));
}
```

~~~

#### FnMut

~~~admonish info title="FnMutçš„å®šä¹‰ä¸ä¾‹å­" collapsible=true
ç†è§£äº† FnOnceï¼Œæˆ‘ä»¬å†æ¥çœ‹ FnMutï¼Œ[å®ƒçš„å®šä¹‰å¦‚ä¸‹](https://doc.rust-lang.org/std/ops/trait.FnMut.html)ï¼š

```rust, editable

pub trait FnMut<Args>: FnOnce<Args> {
    extern "rust-call" fn call_mut(
        &mut self, 
        args: Args
    ) -> Self::Output;
}
```

1. é¦–å…ˆï¼ŒFnMut â€œç»§æ‰¿â€äº† FnOnceï¼Œæˆ–è€…è¯´ FnOnce æ˜¯ FnMut çš„ super traitã€‚
2. æ‰€ä»¥ FnMut ä¹Ÿæ‹¥æœ‰ Output è¿™ä¸ªå…³è”ç±»å‹å’Œ call_once è¿™ä¸ªæ–¹æ³•ã€‚
3. æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª call_mut() æ–¹æ³•ã€‚
4. æ³¨æ„ call_mut() ä¼ å…¥ &mut selfï¼Œå®ƒä¸ç§»åŠ¨ selfï¼Œæ‰€ä»¥ FnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ã€‚

> å› ä¸º FnOnce æ˜¯ FnMut çš„ super traitï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ª FnMut é—­åŒ…ï¼Œå¯ä»¥è¢«ä¼ ç»™ä¸€ä¸ªéœ€è¦ FnOnce çš„ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶è°ƒç”¨é—­åŒ…ç›¸å½“äºè°ƒç”¨äº† call_once()ã€‚

å¦‚æœä½ ç†è§£äº†å‰é¢è®²çš„é—­åŒ…çš„å†…å­˜ç»„ç»‡ç»“æ„ï¼Œé‚£ä¹ˆ FnMut å°±ä¸éš¾ç†è§£ï¼Œå°±åƒç»“æ„ä½“å¦‚æœæƒ³æ”¹å˜æ•°æ®éœ€è¦ç”¨ let mut å£°æ˜ä¸€æ ·ï¼Œå¦‚æœä½ æƒ³æ”¹å˜é—­åŒ…æ•è·çš„æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆå°±éœ€è¦ FnMutã€‚

æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š
```rust, editable


fn main() {
    let mut name = String::from("hello");
    let mut name1 = String::from("hola");

    // æ•è· &mut name
    let mut c = || {
        name.push_str(" Tyr");
        println!("c: {}", name);
    };

    // æ•è· mut name1ï¼Œæ³¨æ„ name1 éœ€è¦å£°æ˜æˆ mut
    let mut c1 = move || {
        name1.push_str("!");
        println!("c1: {}", name1);
    };

    c();
    c1();

    call_mut(&mut c);
    call_mut(&mut c1);

    call_once(c);
    call_once(c1);
}

// åœ¨ä½œä¸ºå‚æ•°æ—¶ï¼ŒFnMut ä¹Ÿè¦æ˜¾å¼åœ°ä½¿ç”¨ mutï¼Œæˆ–è€… &mut
fn call_mut(c: &mut impl FnMut()) {
    c();
}

// æƒ³æƒ³çœ‹ï¼Œä¸ºå•¥ call_once ä¸éœ€è¦ mutï¼Ÿ
fn call_once(c: impl FnOnce()) {
    c();
}

```
1. åœ¨å£°æ˜çš„é—­åŒ… c å’Œ c1 é‡Œï¼Œæˆ‘ä»¬ä¿®æ”¹äº†æ•è·çš„ name å’Œ name1ã€‚
2. ä¸åŒçš„æ˜¯ name ä½¿ç”¨äº†å¼•ç”¨ï¼Œè€Œ name1 ç§»åŠ¨äº†æ‰€æœ‰æƒï¼Œè¿™ä¸¤ç§æƒ…å†µå’Œå…¶å®ƒä»£ç ä¸€æ ·ï¼Œä¹Ÿéœ€è¦éµå¾ªæ‰€æœ‰æƒå’Œå€Ÿç”¨æœ‰å…³çš„è§„åˆ™ã€‚
3. æ‰€ä»¥ï¼Œå¦‚æœåœ¨é—­åŒ… c é‡Œå€Ÿç”¨äº† nameï¼Œä½ å°±ä¸èƒ½æŠŠ name ç§»åŠ¨ç»™å¦ä¸€ä¸ªé—­åŒ… c1ã€‚

> è¿™é‡Œä¹Ÿå±•ç¤ºäº†ï¼Œc å’Œ c1 è¿™ä¸¤ä¸ªç¬¦åˆ FnMut çš„é—­åŒ…ï¼Œèƒ½ä½œä¸º FnOnce æ¥è°ƒç”¨ã€‚æˆ‘ä»¬åœ¨ä»£ç ä¸­ä¹Ÿç¡®è®¤äº†ï¼ŒFnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸º call_mut() ä½¿ç”¨çš„æ˜¯ &mut selfï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒã€‚
~~~

#### Fn

~~~admonish info title="Fnçš„å®šä¹‰ä¸ä¾‹å­" collapsible=true
æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ Fn traitã€‚[å®ƒçš„å®šä¹‰å¦‚ä¸‹](https://doc.rust-lang.org/std/ops/trait.Fn.html)ï¼š

```rust, editable

pub trait Fn<Args>: FnMut<Args> {
    extern "rust-call" fn call(&self, args: Args) -> Self::Output;
}
```

1. å¯ä»¥çœ‹åˆ°ï¼Œå®ƒâ€œç»§æ‰¿â€äº† FnMutï¼Œæˆ–è€…è¯´ FnMut æ˜¯ Fn çš„ super traitã€‚
2. è¿™ä¹Ÿå°±æ„å‘³ç€ä»»ä½•éœ€è¦ FnOnce æˆ–è€… FnMut çš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼ å…¥æ»¡è¶³ Fn çš„é—­åŒ…ã€‚

æˆ‘ä»¬ç»§ç»­çœ‹ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š

```rust, editable

fn main() {
    let v = vec![0u8; 1024];
    let v1 = vec![0u8; 1023];

    // Fnï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒ
    let mut c = |x: u64| v.len() as u64 * x;
    // Fnï¼Œç§»åŠ¨æ‰€æœ‰æƒ
    let mut c1 = move |x: u64| v1.len() as u64 * x;

    println!("direct call: {}", c(2));
    println!("direct call: {}", c1(2));

    println!("call: {}", call(3, &c));
    println!("call: {}", call(3, &c1));

    println!("call_mut: {}", call_mut(4, &mut c));
    println!("call_mut: {}", call_mut(4, &mut c1));

    println!("call_once: {}", call_once(5, c));
    println!("call_once: {}", call_once(5, c1));
}

fn call(arg: u64, c: &impl Fn(u64) -> u64) -> u64 {
    c(arg)
}

fn call_mut(arg: u64, c: &mut impl FnMut(u64) -> u64) -> u64 {
    c(arg)
}

fn call_once(arg: u64, c: impl FnOnce(u64) -> u64) -> u64 {
    c(arg)
}
```

~~~

#### æ€»ç»“ä¸€ä¸‹ä¸‰ç§traité—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»

~~~admonish info title="æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»" collapsible=true
![19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ](https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F.jpg)
~~~

