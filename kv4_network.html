<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>ç½‘ç»œå¤„ç† - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_3_0_trait_overview.html"><strong aria-hidden="true">4.2.3.1.</strong> traitæ¦‚è§ˆ</a></li><li class="chapter-item "><a href="2_3_1_trait_impl.html"><strong aria-hidden="true">4.2.3.2.</strong> Trait Impl</a></li><li class="chapter-item "><a href="2_3_2_trait_object.html"><strong aria-hidden="true">4.2.3.3.</strong> Trait Object</a></li><li class="chapter-item "><a href="2_3_3_trait_frequently.html"><strong aria-hidden="true">4.2.3.4.</strong> å¸¸ç”¨trait</a></li><li class="chapter-item "><a href="2_3_4_trait_design.html"><strong aria-hidden="true">4.2.3.5.</strong> Traitè®¾è®¡</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a></li><li class="chapter-item "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a></li><li class="chapter-item "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a></li><li class="chapter-item "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item "><a href="5_2_future_async_await.html"><strong aria-hidden="true">4.5.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">4.5.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html" class="active"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="å››ç½‘ç»œå¤„ç†"><a class="header" href="#å››ç½‘ç»œå¤„ç†">å››ã€ç½‘ç»œå¤„ç†</a></h1>
<!--ts-->
<ul>
<li><a href="#%E5%9B%9B%E7%BD%91%E7%BB%9C%E5%A4%84%E7%90%86">å››ã€ç½‘ç»œå¤„ç†</a>
<ul>
<li><a href="#async-prost">async-prost</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E7%9A%84-frame">å¦‚ä½•å®šä¹‰åè®®çš„ Frameï¼Ÿ</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E6%92%B0%E5%86%99%E5%A4%84%E7%90%86-frame-%E7%9A%84%E4%BB%A3%E7%A0%81">å¦‚ä½•æ’°å†™å¤„ç† Frame çš„ä»£ç ï¼Ÿ</a></li>
<li><a href="#%E8%AE%A9%E7%BD%91%E7%BB%9C%E5%B1%82%E5%8F%AF%E4%BB%A5%E5%83%8F-asyncprost-%E9%82%A3%E6%A0%B7%E6%96%B9%E4%BE%BF%E4%BD%BF%E7%94%A8">è®©ç½‘ç»œå±‚å¯ä»¥åƒ AsyncProst é‚£æ ·æ–¹ä¾¿ä½¿ç”¨</a></li>
<li><a href="#%E6%AD%A3%E5%BC%8F%E5%88%9B%E5%BB%BA-kv-server-%E5%92%8C-kv-client">æ­£å¼åˆ›å»º kv-server å’Œ kv-client</a></li>
<li><a href="#%E5%9B%9E%E9%A1%BE%E7%BD%91%E7%BB%9C%E5%BC%80%E5%8F%91">å›é¡¾ç½‘ç»œå¼€å‘</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sun Oct 16 02:54:10 UTC 2022 -->
<!--te-->
<h2 id="async-prost"><a class="header" href="#async-prost">async-prost</a></h2>
<p>ä¹‹å‰ä¸€ç›´åœ¨ä½¿ç”¨ä¸€ä¸ªç¥ç§˜çš„ <a href="https://github.com/tyrchen/async-prost">async-prost åº“</a>ï¼Œæˆ‘ä»¬ç¥å¥‡åœ°å®Œæˆäº† TCP frame çš„å°åŒ…å’Œè§£åŒ…ã€‚</p>
<details id="admonition-æ˜¯æ€ä¹ˆå®Œæˆçš„å‘¢" class="admonition question">
<summary class="admonition-title">
<p>æ˜¯æ€ä¹ˆå®Œæˆçš„å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-æ˜¯æ€ä¹ˆå®Œæˆçš„å‘¢"></a></p>
</summary>
<div>
<p>async-prost æ˜¯<a href="https://github.com/jonhoo/async-bincode">ä»¿ç…§ Jonhoo çš„ async-bincode</a> åšçš„ä¸€ä¸ªå¤„ç† protobuf frame çš„åº“ï¼Œå®ƒå¯ä»¥å’Œå„ç§ç½‘ç»œåè®®é€‚é…ï¼ŒåŒ…æ‹¬ TCP / WebSocket / HTTP2 ç­‰ã€‚</p>
<blockquote>
<p>ç”±äºè€ƒè™‘é€šç”¨æ€§ï¼Œå®ƒçš„æŠ½è±¡çº§åˆ«æ¯”è¾ƒé«˜ï¼Œç”¨äº†å¤§é‡çš„æ³›å‹å‚æ•°</p>
</blockquote>
<hr />
<p>ä¸»æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<h2 id=""><a class="header" href="#"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/5afafe8646ee8b05b69a463ab5f5554f.png" alt="img" /></a></h2>
<p>ä¸»è¦çš„æ€è·¯:</p>
<ol>
<li>åœ¨åºåˆ—åŒ–æ•°æ®çš„æ—¶å€™ï¼Œæ·»åŠ ä¸€ä¸ªå¤´éƒ¨æ¥æä¾› frame çš„é•¿åº¦</li>
<li>ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå…ˆè¯»å‡ºå¤´éƒ¨ï¼Œè·å¾—é•¿åº¦ï¼Œå†è¯»å–ç›¸åº”çš„æ•°æ®ã€‚</li>
</ol>
</div>
</details>
<blockquote>
<p>è¿™é‡Œè¯•ç€ä¸ä¾èµ– async-prostï¼Œè‡ªå·±å¤„ç†å°åŒ…å’Œè§£åŒ…çš„é€»è¾‘ã€‚
å¦‚æœä½ æŒæ¡äº†è¿™ä¸ªèƒ½åŠ›ï¼Œé…åˆ protobufï¼Œå°±å¯ä»¥è®¾è®¡å‡ºä»»ä½•å¯ä»¥æ‰¿è½½å®é™…ä¸šåŠ¡çš„åè®®äº†ã€‚</p>
</blockquote>
<h2 id="å¦‚ä½•å®šä¹‰åè®®çš„-frame"><a class="header" href="#å¦‚ä½•å®šä¹‰åè®®çš„-frame">å¦‚ä½•å®šä¹‰åè®®çš„ Frameï¼Ÿ</a></h2>
<p>protobuf å¸®æˆ‘ä»¬è§£å†³äº†åè®®æ¶ˆæ¯å¦‚ä½•å®šä¹‰çš„é—®é¢˜ï¼Œç„¶è€Œä¸€ä¸ªæ¶ˆæ¯å’Œå¦ä¸€ä¸ªæ¶ˆæ¯ä¹‹é—´å¦‚ä½•åŒºåˆ†ï¼Œæ˜¯ä¸ªä¼¤è„‘ç­‹çš„äº‹æƒ…ã€‚</p>
<details id="admonition-æˆ‘ä»¬éœ€è¦å®šä¹‰åˆé€‚çš„åˆ†éš”ç¬¦" class="admonition info">
<summary class="admonition-title">
<p>æˆ‘ä»¬éœ€è¦å®šä¹‰åˆé€‚çš„åˆ†éš”ç¬¦ã€‚ </p>
<p><a class="admonition-anchor-link" href="#admonition-æˆ‘ä»¬éœ€è¦å®šä¹‰åˆé€‚çš„åˆ†éš”ç¬¦"></a></p>
</summary>
<div>
<blockquote>
<p>åˆ†éš”ç¬¦ + æ¶ˆæ¯æ•°æ®ï¼Œå°±æ˜¯ä¸€ä¸ª Frameã€‚</p>
</blockquote>
<ol>
<li>å¾ˆå¤šåŸºäº TCP çš„åè®®ä¼šä½¿ç”¨ \r\n åšåˆ†éš”ç¬¦ï¼Œæ¯”å¦‚ FTPï¼›</li>
<li>ä¹Ÿæœ‰ä½¿ç”¨æ¶ˆæ¯é•¿åº¦åšåˆ†éš”ç¬¦çš„ï¼Œæ¯”å¦‚ gRPCï¼›</li>
<li>è¿˜æœ‰æ··ç”¨ä¸¤è€…çš„ï¼Œæ¯”å¦‚ Redis çš„ RESPï¼›</li>
<li>æ›´å¤æ‚çš„å¦‚ HTTPï¼Œheader ä¹‹é—´ä½¿ç”¨ \r\n åˆ†éš”ï¼Œheader / body ä¹‹é—´ä½¿ç”¨ \r\n\r\nï¼Œheader ä¸­ä¼šæä¾› body çš„é•¿åº¦ç­‰ç­‰ã€‚</li>
</ol>
<ul>
<li>â€œ\r\nâ€ è¿™æ ·çš„åˆ†éš”ç¬¦ï¼Œé€‚åˆåè®®æŠ¥æ–‡æ˜¯ ASCII æ•°æ®ï¼›</li>
<li>è€Œé€šè¿‡é•¿åº¦è¿›è¡Œåˆ†éš”ï¼Œé€‚åˆåè®®æŠ¥æ–‡æ˜¯äºŒè¿›åˆ¶æ•°æ®</li>
<li>æˆ‘ä»¬çš„ KV Server æ‰¿è½½çš„ protobuf æ˜¯äºŒè¿›åˆ¶ï¼Œæ‰€ä»¥å°±åœ¨ payload ä¹‹å‰æ”¾ä¸€ä¸ªé•¿åº¦ï¼Œæ¥ä½œä¸º frame çš„åˆ†éš”ã€‚</li>
</ul>
<p>è¿™ä¸ªé•¿åº¦å–ä»€ä¹ˆå¤§å°å‘¢ï¼Ÿ</p>
<ul>
<li>å¦‚æœä½¿ç”¨ 2 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆ payload æœ€å¤§æ˜¯ 64kï¼›</li>
<li>å¦‚æœä½¿ç”¨ 4 ä¸ªå­—èŠ‚ï¼Œpayload å¯ä»¥åˆ° 4Gã€‚</li>
<li>ä¸€èˆ¬çš„åº”ç”¨å– 4 ä¸ªå­—èŠ‚å°±è¶³å¤Ÿäº†ã€‚</li>
<li>å¦‚æœä½ æƒ³è¦æ›´çµæ´»äº›ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/Variable-length_quantity">varint</a>ã€‚</li>
</ul>
</div>
</details>
<p>tokio æœ‰ä¸ª tokio-util åº“ï¼Œå·²ç»å¸®æˆ‘ä»¬å¤„ç†äº†å’Œ frame ç›¸å…³çš„å°åŒ…è§£åŒ…çš„ä¸»è¦éœ€æ±‚ï¼ŒåŒ…æ‹¬ LinesDelimitedï¼ˆå¤„ç† \r\n åˆ†éš”ç¬¦ï¼‰å’Œ LengthDelimitedï¼ˆå¤„ç†é•¿åº¦åˆ†éš”ç¬¦ï¼‰ã€‚</p>
<details id="admonition-æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒçš„-lengthdelimitedcodec-å°è¯•ä¸€ä¸‹" class="admonition note">
<summary class="admonition-title">
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒçš„ LengthDelimitedCodec å°è¯•ä¸€ä¸‹ã€‚ </p>
<p><a class="admonition-anchor-link" href="#admonition-æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒçš„-lengthdelimitedcodec-å°è¯•ä¸€ä¸‹"></a></p>
</summary>
<div>
<ol>
<li>é¦–å…ˆåœ¨ Cargo.toml é‡Œæ·»åŠ ä¾èµ–ï¼š</li>
</ol>
<pre><code class="language-toml">
[dev-dependencies]
...
tokio-util = { version = &quot;0.6&quot;, features = [&quot;codec&quot;]}
...
</code></pre>
<ol start="2">
<li>ç„¶ååˆ›å»º examples/server_with_codec.rs æ–‡ä»¶ï¼Œæ·»å…¥å¦‚ä¸‹ä»£ç ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use futures::prelude::*;
use kv2::{CommandRequest, MemTable, Service, ServiceInner};
use prost::Message;
use tokio::net::TcpListener;
use tokio_util::codec::{Framed, LengthDelimitedCodec};
use tracing::info;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();
    let service: Service = ServiceInner::new(MemTable::new()).into();
    let addr = &quot;127.0.0.1:9527&quot;;
    let listener = TcpListener::bind(addr).await?;
    info!(&quot;Start listening on {}&quot;, addr);
    loop {
        let (stream, addr) = listener.accept().await?;
        info!(&quot;Client {:?} connected&quot;, addr);
        let svc = service.clone();
        tokio::spawn(async move {
            let mut stream = Framed::new(stream, LengthDelimitedCodec::new());
            while let Some(Ok(mut buf)) = stream.next().await {
                let cmd = CommandRequest::decode(&amp;buf[..]).unwrap();
                info!(&quot;Got a new command: {:?}&quot;, cmd);
                let res = svc.execute(cmd);
                buf.clear();
                res.encode(&amp;mut buf).unwrap();
                stream.send(buf.freeze()).await.unwrap();
            }
            info!(&quot;Client {:?} disconnected&quot;, addr);
        });
    }
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>ä½ å¯ä»¥å¯¹æ¯”ä¸€ä¸‹å®ƒå’Œä¹‹å‰çš„ examples/server.rs çš„å·®åˆ«ï¼Œä¸»è¦æ”¹åŠ¨äº†è¿™ä¸€è¡Œï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
// let mut stream = AsyncProstStream::&lt;_, CommandRequest, CommandResponse, _&gt;::from(stream).for_async();
let mut stream = Framed::new(stream, LengthDelimitedCodec::new());
</code></pre></pre>
<details id="admonition-æµ‹è¯•" class="admonition success">
<summary class="admonition-title">
<p>æµ‹è¯• </p>
<p><a class="admonition-anchor-link" href="#admonition-æµ‹è¯•"></a></p>
</summary>
<div>
<ul>
<li>å®Œæˆä¹‹åï¼Œæˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</li>
</ul>
<pre><code class="language-shell">RUST_LOG=info cargo run --example server_with_codec --quiet
</code></pre>
<ul>
<li>ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</li>
</ul>
<pre><code class="language-shell">RUST_LOG=info cargo run --example client --quiet
</code></pre>
<ul>
<li>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ä¸”å¤„ç†æ­£å¸¸</li>
</ul>
</div>
</details>
<details id="admonition-ä½ è¿™ä¼šæ˜¯ä¸æ˜¯æœ‰ç‚¹ç–‘æƒ‘ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯æ²¡åšä»»ä½•ä¿®æ”¹ä¹Ÿèƒ½å’ŒæœåŠ¡å™¨é€šä¿¡" class="admonition question">
<summary class="admonition-title">
<p>ä½ è¿™ä¼šæ˜¯ä¸æ˜¯æœ‰ç‚¹ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆå®¢æˆ·ç«¯æ²¡åšä»»ä½•ä¿®æ”¹ä¹Ÿèƒ½å’ŒæœåŠ¡å™¨é€šä¿¡ï¼Ÿ </p>
<p><a class="admonition-anchor-link" href="#admonition-ä½ è¿™ä¼šæ˜¯ä¸æ˜¯æœ‰ç‚¹ç–‘æƒ‘ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯æ²¡åšä»»ä½•ä¿®æ”¹ä¹Ÿèƒ½å’ŒæœåŠ¡å™¨é€šä¿¡"></a></p>
</summary>
<div>
<p>é‚£æ˜¯å› ä¸ºåœ¨ç›®å‰çš„ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ AsyncProst çš„å®¢æˆ·ç«¯å…¼å®¹ LengthDelimitedCodecã€‚</p>
</div>
</details>
<h2 id="å¦‚ä½•æ’°å†™å¤„ç†-frame-çš„ä»£ç "><a class="header" href="#å¦‚ä½•æ’°å†™å¤„ç†-frame-çš„ä»£ç ">å¦‚ä½•æ’°å†™å¤„ç† Frame çš„ä»£ç ï¼Ÿ</a></h2>
<details id="admonition-æŒ‰ç…§å‰é¢åˆ†ææˆ‘ä»¬åœ¨-protobuf-payload-å‰åŠ ä¸€ä¸ª-4-å­—èŠ‚çš„é•¿åº¦" class="admonition info">
<summary class="admonition-title">
<p>æŒ‰ç…§å‰é¢åˆ†æï¼Œæˆ‘ä»¬åœ¨ protobuf payload å‰åŠ ä¸€ä¸ª 4 å­—èŠ‚çš„é•¿åº¦ã€‚ </p>
<p><a class="admonition-anchor-link" href="#admonition-æŒ‰ç…§å‰é¢åˆ†ææˆ‘ä»¬åœ¨-protobuf-payload-å‰åŠ ä¸€ä¸ª-4-å­—èŠ‚çš„é•¿åº¦"></a></p>
</summary>
<div>
<p>è¿™æ ·å¯¹ç«¯è¯»å–æ•°æ®æ—¶ï¼Œå¯ä»¥å…ˆè¯» 4 å­—èŠ‚ï¼Œç„¶åæ ¹æ®è¯»åˆ°çš„é•¿åº¦ï¼Œè¿›ä¸€æ­¥è¯»å–æ»¡è¶³è¿™ä¸ªé•¿åº¦çš„æ•°æ®ï¼Œä¹‹åå°±å¯ä»¥ç”¨ç›¸åº”çš„æ•°æ®ç»“æ„è§£åŒ…äº†ã€‚</p>
<blockquote>
<p>ä¸ºäº†æ›´è´´è¿‘å®é™…ï¼Œæˆ‘ä»¬æŠŠ 4 å­—èŠ‚é•¿åº¦çš„æœ€é«˜ä½æ‹¿å‡ºæ¥ä½œä¸ºæ˜¯å¦å‹ç¼©çš„ä¿¡å·.
å¦‚æœè®¾ç½®äº†ï¼Œä»£è¡¨åç»­çš„ payload æ˜¯ gzip å‹ç¼©è¿‡çš„ protobufï¼Œå¦åˆ™ç›´æ¥æ˜¯ protobufï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/712735ae12d0cdf39b3dcf5bb242f103.jpg" alt="img" /></p>
</div>
</details>
<details id="admonition-å®ç°å¤„ç†-frame-çš„ä»£ç -commandrequest--commandresponse-åš-frame-çº§åˆ«çš„å¤„ç†" class="admonition note">
<summary class="admonition-title">
<p>å®ç°å¤„ç† Frame çš„ä»£ç : CommandRequest / CommandResponse åš frame çº§åˆ«çš„å¤„ç†</p>
<p><a class="admonition-anchor-link" href="#admonition-å®ç°å¤„ç†-frame-çš„ä»£ç -commandrequest--commandresponse-åš-frame-çº§åˆ«çš„å¤„ç†"></a></p>
</summary>
<div>
<ol>
<li>æŒ‰ç…§æƒ¯ä¾‹ï¼Œè¿˜æ˜¯å…ˆæ¥å®šä¹‰å¤„ç†è¿™ä¸ªé€»è¾‘çš„ traitï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait FrameCoder
where
    Self: Message + Sized + Default,
{
    /// æŠŠä¸€ä¸ª Message encode æˆä¸€ä¸ª frame
    fn encode_frame(&amp;self, buf: &amp;mut BytesMut) -&gt; Result&lt;(), KvError&gt;;
    /// æŠŠä¸€ä¸ªå®Œæ•´çš„ frame decode æˆä¸€ä¸ª Message
    fn decode_frame(buf: &amp;mut BytesMut) -&gt; Result&lt;Self, KvError&gt;;
}
</code></pre></pre>
<p>å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li>
<p>encode_frame() å¯ä»¥æŠŠè¯¸å¦‚ CommandRequest è¿™æ ·çš„æ¶ˆæ¯å°è£…æˆä¸€ä¸ª frameï¼Œå†™å…¥ä¼ è¿›æ¥çš„ BytesMutï¼›</p>
</li>
<li>
<p>decode_frame() å¯ä»¥æŠŠæ”¶åˆ°çš„ä¸€ä¸ªå®Œæ•´çš„ã€æ”¾åœ¨ BytesMut ä¸­çš„æ•°æ®ï¼Œè§£å°è£…æˆè¯¸å¦‚ CommandRequest è¿™æ ·çš„æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p>å¦‚æœè¦å®ç°è¿™ä¸ª traitï¼ŒSelf éœ€è¦å®ç°äº† prost::Messageï¼Œå¤§å°æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”å®ç°äº† Defaultï¼ˆprost çš„éœ€æ±‚ï¼‰ã€‚</p>
</li>
</ul>
<hr />
<ol start="2">
<li>å¥½ï¼Œæˆ‘ä»¬å†å†™å®ç°ä»£ç ã€‚</li>
</ol>
<ul>
<li>
<p>é¦–å…ˆåˆ›å»º src/network ç›®å½•ï¼Œå¹¶åœ¨å…¶ä¸‹æ·»åŠ ä¸¤ä¸ªæ–‡ä»¶mod.rså’Œ frame.rsã€‚</p>
</li>
<li>
<p>ç„¶ååœ¨ src/network/mod.rs é‡Œå¼•å…¥ src/network/frame.rsï¼š</p>
</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
mod frame;
pub use frame::FrameCoder;
</code></pre></pre>
<ul>
<li>åŒæ—¶åœ¨ lib.rs é‡Œå¼•å…¥ networkï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
mod network;
pub use network::*;
</code></pre></pre>
<ul>
<li>
<p>å› ä¸ºè¦å¤„ç† gzip å‹ç¼©ï¼Œè¿˜éœ€è¦åœ¨ Cargo.toml ä¸­å¼•å…¥ <a href="https://github.com/rust-lang/flate2-rs">flate2</a></p>
</li>
<li>
<p>åŒæ—¶ï¼Œå› ä¸ºä»Šå¤©è¿™ä¸€è®²å¼•å…¥äº†ç½‘ç»œç›¸å…³çš„æ“ä½œå’Œæ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ tokio ä» dev-dependencies ç§»åˆ° dependencies é‡Œï¼Œä¸ºç®€å•èµ·è§ï¼Œå°±ç”¨ full featuresï¼š</p>
</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
[dependencies]
...
flate2 = &quot;1&quot; # gzip å‹ç¼©
...
tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] } # å¼‚æ­¥ç½‘ç»œåº“
...
</code></pre></pre>
<ul>
<li>ç„¶åï¼Œåœ¨ src/network/frame.rs é‡Œæ·»åŠ  trait å’Œå®ç° trait çš„ä»£ç ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
use std::io::{Read, Write};

use crate::{CommandRequest, CommandResponse, KvError};
use bytes::{Buf, BufMut, BytesMut};
use flate2::{read::GzDecoder, write::GzEncoder, Compression};
use prost::Message;
use tokio::io::{AsyncRead, AsyncReadExt};
use tracing::debug;

/// é•¿åº¦æ•´ä¸ªå ç”¨ 4 ä¸ªå­—èŠ‚
pub const LEN_LEN: usize = 4;
/// é•¿åº¦å  31 bitï¼Œæ‰€ä»¥æœ€å¤§çš„ frame æ˜¯ 2G
const MAX_FRAME: usize = 2 * 1024 * 1024 * 1024;
/// å¦‚æœ payload è¶…è¿‡äº† 1436 å­—èŠ‚ï¼Œå°±åšå‹ç¼©
const COMPRESSION_LIMIT: usize = 1436;
/// ä»£è¡¨å‹ç¼©çš„ bitï¼ˆæ•´ä¸ªé•¿åº¦ 4 å­—èŠ‚çš„æœ€é«˜ä½ï¼‰
const COMPRESSION_BIT: usize = 1 &lt;&lt; 31;

/// å¤„ç† Frame çš„ encode/decode
pub trait FrameCoder
where
    Self: Message + Sized + Default,
{
    /// æŠŠä¸€ä¸ª Message encode æˆä¸€ä¸ª frame
    fn encode_frame(&amp;self, buf: &amp;mut BytesMut) -&gt; Result&lt;(), KvError&gt; {
        let size = self.encoded_len();

        if size &gt;= MAX_FRAME {
            return Err(KvError::FrameError);
        }

        // æˆ‘ä»¬å…ˆå†™å…¥é•¿åº¦ï¼Œå¦‚æœéœ€è¦å‹ç¼©ï¼Œå†é‡å†™å‹ç¼©åçš„é•¿åº¦
        buf.put_u32(size as _);

        if size &gt; COMPRESSION_LIMIT {
            let mut buf1 = Vec::with_capacity(size);
            self.encode(&amp;mut buf1)?;

            // BytesMut æ”¯æŒé€»è¾‘ä¸Šçš„ splitï¼ˆä¹‹åè¿˜èƒ½ unsplitï¼‰
            // æ‰€ä»¥æˆ‘ä»¬å…ˆæŠŠé•¿åº¦è¿™ 4 å­—èŠ‚æ‹¿èµ°ï¼Œæ¸…é™¤
            let payload = buf.split_off(LEN_LEN);
            buf.clear();

            // å¤„ç† gzip å‹ç¼©ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ flate2 æ–‡æ¡£
            let mut encoder = GzEncoder::new(payload.writer(), Compression::default());
            encoder.write_all(&amp;buf1[..])?;

            // å‹ç¼©å®Œæˆåï¼Œä» gzip encoder ä¸­æŠŠ BytesMut å†æ‹¿å›æ¥
            let payload = encoder.finish()?.into_inner();
            debug!(&quot;Encode a frame: size {}({})&quot;, size, payload.len());

            // å†™å…¥å‹ç¼©åçš„é•¿åº¦
            buf.put_u32((payload.len() | COMPRESSION_BIT) as _);

            // æŠŠ BytesMut å†åˆå¹¶å›æ¥
            buf.unsplit(payload);

            Ok(())
        } else {
            self.encode(buf)?;
            Ok(())
        }
    }

    /// æŠŠä¸€ä¸ªå®Œæ•´çš„ frame decode æˆä¸€ä¸ª Message
    fn decode_frame(buf: &amp;mut BytesMut) -&gt; Result&lt;Self, KvError&gt; {
        // å…ˆå– 4 å­—èŠ‚ï¼Œä»ä¸­æ‹¿å‡ºé•¿åº¦å’Œ compression bit
        let header = buf.get_u32() as usize;
        let (len, compressed) = decode_header(header);
        debug!(&quot;Got a frame: msg len {}, compressed {}&quot;, len, compressed);

        if compressed {
            // è§£å‹ç¼©
            let mut decoder = GzDecoder::new(&amp;buf[..len]);
            let mut buf1 = Vec::with_capacity(len * 2);
            decoder.read_to_end(&amp;mut buf1)?;
            buf.advance(len);

            // decode æˆç›¸åº”çš„æ¶ˆæ¯
            Ok(Self::decode(&amp;buf1[..buf1.len()])?)
        } else {
            let msg = Self::decode(&amp;buf[..len])?;
            buf.advance(len);
            Ok(msg)
        }
    }
}

impl FrameCoder for CommandRequest {}
impl FrameCoder for CommandResponse {}

fn decode_header(header: usize) -&gt; (usize, bool) {
    let len = header &amp; !COMPRESSION_BIT;
    let compressed = header &amp; COMPRESSION_BIT == COMPRESSION_BIT;
    (len, compressed)
}
</code></pre></pre>
<p>è¿™æ®µä»£ç æœ¬èº«å¹¶ä¸éš¾ç†è§£ã€‚</p>
<ul>
<li>æˆ‘ä»¬ç›´æ¥ä¸º FrameCoder æä¾›äº†ç¼ºçœå®ç°</li>
<li>ç„¶å CommandRequest / CommandResponse åšäº†ç©ºå®ç°</li>
<li>å…¶ä¸­ä½¿ç”¨äº†ä¹‹å‰ä»‹ç»è¿‡çš„ bytes åº“é‡Œçš„ BytesMutï¼Œä»¥åŠæ–°å¼•å…¥çš„ GzEncoder / GzDecoderã€‚</li>
<li>ä½ å¯ä»¥æŒ‰ç…§é˜…è¯»æºç çš„æ–¹å¼ï¼Œäº†è§£è¿™å‡ ä¸ªæ•°æ®ç±»å‹çš„ç”¨æ³•ã€‚</li>
<li>æœ€åè¿˜å†™äº†ä¸ªè¾…åŠ©å‡½æ•° decode_header()ï¼Œè®© decode_frame() çš„ä»£ç æ›´ç›´è§‚ä¸€äº›ã€‚</li>
</ul>
</div>
</details>
<details id="admonition-ä¸ºä»€ä¹ˆ-compression_limit-è®¾æˆ-1436" class="admonition question">
<summary class="admonition-title">
<p>ä¸ºä»€ä¹ˆ COMPRESSION_LIMIT è®¾æˆ 1436ï¼Ÿ </p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸ºä»€ä¹ˆ-compression_limit-è®¾æˆ-1436"></a></p>
</summary>
<div>
<ul>
<li>è¿™æ˜¯å› ä¸ºä»¥å¤ªç½‘çš„ MTU æ˜¯ 1500ï¼Œé™¤å» IP å¤´ 20 å­—èŠ‚ã€TCP å¤´ 20 å­—èŠ‚ï¼Œè¿˜å‰© 1460ï¼›</li>
<li>ä¸€èˆ¬ TCP åŒ…ä¼šåŒ…å«ä¸€äº› Optionï¼ˆæ¯”å¦‚ timestampï¼‰ï¼ŒIP åŒ…ä¹Ÿå¯èƒ½åŒ…å«ï¼Œæ‰€ä»¥æˆ‘ä»¬é¢„ç•™ 20 å­—èŠ‚ï¼›</li>
<li>å†å‡å» 4 å­—èŠ‚çš„é•¿åº¦ï¼Œå°±æ˜¯ 1436ï¼Œä¸ç”¨åˆ†ç‰‡çš„æœ€å¤§æ¶ˆæ¯é•¿åº¦ã€‚</li>
<li>å¦‚æœå¤§äºè¿™ä¸ªï¼Œå¾ˆå¯èƒ½ä¼šå¯¼è‡´åˆ†ç‰‡ï¼Œæˆ‘ä»¬å°±å¹²è„†å‹ç¼©ä¸€ä¸‹ã€‚</li>
</ul>
</div>
</details>
<blockquote>
<p>ç°åœ¨ï¼ŒCommandRequest / CommandResponse å°±å¯ä»¥åš frame çº§åˆ«çš„å¤„ç†äº†ï¼Œæˆ‘ä»¬å†™ä¸€äº›æµ‹è¯•éªŒè¯æ˜¯å¦å·¥ä½œã€‚</p>
</blockquote>
<details id="admonition-æˆåŠŸæµ‹è¯•ä»£ç æ¶‰åŠfromå’Œinto" class="admonition success">
<summary class="admonition-title">
<p>æˆåŠŸï¼šæµ‹è¯•ä»£ç ï¼Œæ¶‰åŠFromå’ŒInto</p>
<p><a class="admonition-anchor-link" href="#admonition-æˆåŠŸæµ‹è¯•ä»£ç æ¶‰åŠfromå’Œinto"></a></p>
</summary>
<div>
<p>è¿˜æ˜¯åœ¨ src/network/frame.rs é‡Œï¼Œæ·»åŠ æµ‹è¯•ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {
    use super::*;
    use crate::Value;
    use bytes::Bytes;

    #[test]
    fn command_request_encode_decode_should_work() {
        let mut buf = BytesMut::new();

        let cmd = CommandRequest::new_hdel(&quot;t1&quot;, &quot;k1&quot;);
        cmd.encode_frame(&amp;mut buf).unwrap();

        // æœ€é«˜ä½æ²¡è®¾ç½®
        assert_eq!(is_compressed(&amp;buf), false);

        let cmd1 = CommandRequest::decode_frame(&amp;mut buf).unwrap();
        assert_eq!(cmd, cmd1);
    }

    #[test]
    fn command_response_encode_decode_should_work() {
        let mut buf = BytesMut::new();

        let values: Vec&lt;Value&gt; = vec![1.into(), &quot;hello&quot;.into(), b&quot;data&quot;.into()];
        let res: CommandResponse = values.into();
        res.encode_frame(&amp;mut buf).unwrap();

        // æœ€é«˜ä½æ²¡è®¾ç½®
        assert_eq!(is_compressed(&amp;buf), false);

        let res1 = CommandResponse::decode_frame(&amp;mut buf).unwrap();
        assert_eq!(res, res1);
    }

    #[test]
    fn command_response_compressed_encode_decode_should_work() {
        let mut buf = BytesMut::new();

        let value: Value = Bytes::from(vec![0u8; COMPRESSION_LIMIT + 1]).into();
        let res: CommandResponse = value.into();
        res.encode_frame(&amp;mut buf).unwrap();

        // æœ€é«˜ä½è®¾ç½®äº†
        assert_eq!(is_compressed(&amp;buf), true);

        let res1 = CommandResponse::decode_frame(&amp;mut buf).unwrap();
        assert_eq!(res, res1);
    }

    fn is_compressed(data: &amp;[u8]) -&gt; bool {
        if let &amp;[v] = &amp;data[..1] {
            v &gt;&gt; 7 == 1
        } else {
            false
        }
    }
}
</code></pre></pre>
<blockquote>
<p>è¿™ä¸ªæµ‹è¯•ä»£ç é‡Œé¢æœ‰ä» [u8; N] åˆ° Valueï¼ˆbâ€œdataâ€œ.into()ï¼‰ ä»¥åŠä» Bytes åˆ° Value çš„è½¬æ¢</p>
</blockquote>
<ul>
<li>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ src/pb/mod.rs é‡Œæ·»åŠ  From trait çš„ç›¸åº”å®ç°ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;const N: usize&gt; From&lt;&amp;[u8; N]&gt; for Value {
    fn from(buf: &amp;[u8; N]) -&gt; Self {
        Bytes::copy_from_slice(&amp;buf[..]).into()
    }
}

impl From&lt;Bytes&gt; for Value {
    fn from(buf: Bytes) -&gt; Self {
        Self {
            value: Some(value::Value::Binary(buf)),
        }
    }
}
</code></pre></pre>
<p>è¿è¡Œ cargo test ï¼Œæ‰€æœ‰æµ‹è¯•éƒ½å¯ä»¥é€šè¿‡ã€‚</p>
</div>
</details>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº† Frame çš„åºåˆ—åŒ–ï¼ˆencode_frameï¼‰å’Œååºåˆ—åŒ–ï¼ˆdecode_frameï¼‰ï¼Œå¹¶ä¸”ç”¨æµ‹è¯•ç¡®ä¿å®ƒçš„æ­£ç¡®æ€§ã€‚</p>
<blockquote>
<p>åšç½‘ç»œå¼€å‘çš„æ—¶å€™ï¼Œè¦å°½å¯èƒ½æŠŠå®ç°é€»è¾‘å’Œ IO åˆ†ç¦»ï¼Œè¿™æ ·æœ‰åŠ©äºå¯æµ‹æ€§ä»¥åŠåº”å¯¹æœªæ¥ IO å±‚çš„å˜æ›´ã€‚</p>
</blockquote>
<p>ç›®å‰ï¼Œè¿™ä¸ªä»£ç æ²¡æœ‰è§¦åŠä»»ä½•å’Œ socket IO ç›¸å…³çš„å†…å®¹ï¼Œåªæ˜¯çº¯é€»è¾‘ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å°†å®ƒå’Œæˆ‘ä»¬ç”¨äºå¤„ç†æœåŠ¡å™¨å®¢æˆ·ç«¯çš„ TcpStream è”ç³»èµ·æ¥ã€‚</p>
<p>åœ¨è¿›ä¸€æ­¥å†™ç½‘ç»œç›¸å…³çš„ä»£ç å‰ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼š</p>
<details id="admonition-decode_frame-å‡½æ•°ä½¿ç”¨çš„-bytesmutæ˜¯å¦‚ä½•ä»-socket-é‡Œæ‹¿å‡ºæ¥çš„" class="admonition question">
<summary class="admonition-title">
<p>decode_frame() å‡½æ•°ä½¿ç”¨çš„ BytesMutï¼Œæ˜¯å¦‚ä½•ä» socket é‡Œæ‹¿å‡ºæ¥çš„ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-decode_frame-å‡½æ•°ä½¿ç”¨çš„-bytesmutæ˜¯å¦‚ä½•ä»-socket-é‡Œæ‹¿å‡ºæ¥çš„"></a></p>
</summary>
<div>
<p>æ˜¾ç„¶ï¼Œå…ˆè¯» 4 ä¸ªå­—èŠ‚ï¼Œå–å‡ºé•¿åº¦ Nï¼Œç„¶åå†è¯» N ä¸ªå­—èŠ‚ã€‚</p>
<p>è¿™ä¸ªç»†èŠ‚å’Œ frame å…³ç³»å¾ˆå¤§ï¼Œæ‰€ä»¥è¿˜éœ€è¦åœ¨ src/network/frame.rs é‡Œå†™ä¸ªè¾…åŠ©å‡½æ•° read_frame()ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
/// ä» stream ä¸­è¯»å–ä¸€ä¸ªå®Œæ•´çš„ frame
pub async fn read_frame&lt;S&gt;(stream: &amp;mut S, buf: &amp;mut BytesMut) -&gt; Result&lt;(), KvError&gt;
where
    S: AsyncRead + Unpin + Send,
{
    let header = stream.read_u32().await? as usize;
    let (len, _compressed) = decode_header(header);
    // å¦‚æœæ²¡æœ‰è¿™ä¹ˆå¤§çš„å†…å­˜ï¼Œå°±åˆ†é…è‡³å°‘ä¸€ä¸ª frame çš„å†…å­˜ï¼Œä¿è¯å®ƒå¯ç”¨
    buf.reserve(LEN_LEN + len);
    buf.put_u32(header as _);
    // advance_mut æ˜¯ unsafe çš„åŸå› æ˜¯ï¼Œä»å½“å‰ä½ç½® pos åˆ° pos + lenï¼Œ
    // è¿™æ®µå†…å­˜ç›®å‰æ²¡æœ‰åˆå§‹åŒ–ã€‚æˆ‘ä»¬å°±æ˜¯ä¸ºäº† reserve è¿™æ®µå†…å­˜ï¼Œç„¶åä» stream
    // é‡Œè¯»å–ï¼Œè¯»å–å®Œï¼Œå®ƒå°±æ˜¯åˆå§‹åŒ–çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿™ä¹ˆç”¨æ˜¯å®‰å…¨çš„
    unsafe { buf.advance_mut(len) };
    stream.read_exact(&amp;mut buf[LEN_LEN..]).await?;
    Ok(())
}
</code></pre></pre>
<ul>
<li>åœ¨å†™ read_frame() æ—¶ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å®ƒåªèƒ½è¢«ç”¨äº TcpStreamï¼Œè¿™æ ·å¤ªä¸çµæ´»ï¼Œæ‰€ä»¥ç”¨äº†æ³›å‹å‚æ•° S</li>
<li>è¦æ±‚ä¼ å…¥çš„ S å¿…é¡»æ»¡è¶³ AsyncRead + Unpin + Sendã€‚</li>
</ul>
</div>
</details>
<details id="admonition-è¦æ±‚ä¼ å…¥çš„-s-å¿…é¡»æ»¡è¶³-asyncread--unpin--send-æˆ‘ä»¬æ¥çœ‹çœ‹è¿™-3-ä¸ªçº¦æŸ" class="admonition info">
<summary class="admonition-title">
<p>è¦æ±‚ä¼ å…¥çš„ S å¿…é¡»æ»¡è¶³ AsyncRead + Unpin + Send, æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ 3 ä¸ªçº¦æŸ: </p>
<p><a class="admonition-anchor-link" href="#admonition-è¦æ±‚ä¼ å…¥çš„-s-å¿…é¡»æ»¡è¶³-asyncread--unpin--send-æˆ‘ä»¬æ¥çœ‹çœ‹è¿™-3-ä¸ªçº¦æŸ"></a></p>
</summary>
<div>
<ol>
<li><a href="https://docs.rs/tokio/1.12.0/tokio/io/trait.AsyncRead.html">AsyncRead æ˜¯ tokio ä¸‹çš„ä¸€ä¸ª trait</a>ï¼Œç”¨äºåšå¼‚æ­¥è¯»å–ï¼Œå®ƒæœ‰ä¸€ä¸ªæ–¹æ³• poll_read()ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait AsyncRead {
    fn poll_read(
        self: Pin&lt;&amp;mut Self&gt;, 
        cx: &amp;mut Context&lt;'_&gt;, 
        buf: &amp;mut ReadBuf&lt;'_&gt;
    ) -&gt; Poll&lt;Result&lt;()&gt;&gt;;
}
</code></pre></pre>
<p>ä¸€æ—¦æŸä¸ªæ•°æ®ç»“æ„å®ç°äº† AsyncReadï¼Œå®ƒå°±å¯ä»¥ä½¿ç”¨ AsyncReadExt æä¾›çš„å¤šè¾¾ 29 ä¸ªè¾…åŠ©æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸ºä»»ä½•å®ç°äº† AsyncRead çš„æ•°æ®ç»“æ„ï¼Œéƒ½è‡ªåŠ¨å®ç°äº† AsyncReadExtï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">impl&lt;R: AsyncRead + ?Sized&gt; AsyncReadExt for R {}
</code></pre></pre>
<p>æˆ‘ä»¬è™½ç„¶è¿˜æ²¡æœ‰æ­£å¼å­¦æ€ä¹ˆåšå¼‚æ­¥å¤„ç†ï¼Œä½†æ˜¯ä¹‹å‰å·²ç»çœ‹åˆ°äº†å¾ˆå¤š async/await çš„ä»£ç ã€‚</p>
<blockquote>
<p>å¼‚æ­¥å¤„ç†ï¼Œç›®å‰ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ª<strong>å†…éƒ¨æœ‰ä¸ªçŠ¶æ€æœºçš„æ•°æ®ç»“æ„</strong>:</p>
</blockquote>
<ul>
<li>å¼‚æ­¥è¿è¡Œæ—¶æ ¹æ®éœ€è¦ä¸æ–­åœ°å¯¹å…¶åš poll æ“ä½œï¼Œç›´åˆ°å®ƒè¿”å› Poll::Readyï¼Œè¯´æ˜å¾—åˆ°äº†å¤„ç†ç»“æœï¼›</li>
<li>å¦‚æœå®ƒè¿”å› Poll::Pendingï¼Œè¯´æ˜ç›®å‰è¿˜æ— æ³•ç»§ç»­ï¼Œå¼‚æ­¥è¿è¡Œæ—¶ä¼šå°†å…¶æŒ‚èµ·ï¼Œç­‰ä¸‹æ¬¡æŸä¸ªäº‹ä»¶å°†è¿™ä¸ªä»»åŠ¡å”¤é†’ã€‚</li>
</ul>
<p>å¯¹äº Socket æ¥è¯´ï¼Œè¯»å– socket å°±æ˜¯ä¸€ä¸ªä¸æ–­ poll_read() çš„è¿‡ç¨‹ï¼Œç›´åˆ°è¯»åˆ°äº†æ»¡è¶³ ReadBuf éœ€è¦çš„å†…å®¹ã€‚</p>
<ol start="2">
<li>
<p>è‡³äº Send çº¦æŸï¼Œå¾ˆå¥½ç†è§£ï¼Œ éœ€è¦èƒ½åœ¨ä¸åŒçº¿ç¨‹é—´ç§»åŠ¨æ‰€æœ‰æƒã€‚</p>
</li>
<li>
<p>å¯¹äº Unpin çº¦æŸ</p>
</li>
</ol>
<p>å¦‚æœç¼–è¯‘å™¨æŠ±æ€¨ä¸€ä¸ªæ³›å‹å‚æ•° â€œcannot be unpinnedâ€ ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªæ³›å‹å‚æ•°éœ€è¦åŠ  Unpin çš„çº¦æŸã€‚ä½ å¯ä»¥è¯•ç€æŠŠ Unpin å»æ‰ï¼Œçœ‹çœ‹ç¼–è¯‘å™¨çš„æŠ¥é”™ã€‚</p>
</div>
</details>
<p>å¥½ï¼Œæ—¢ç„¶åˆå†™äº†ä¸€äº›ä»£ç ï¼Œè‡ªç„¶éœ€ä¸ºå…¶æ’°å†™ç›¸åº”çš„æµ‹è¯•ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¦æµ‹ read_frame() å‡½æ•°ï¼Œéœ€è¦ä¸€ä¸ªæ”¯æŒ AsyncRead çš„æ•°æ®ç»“æ„ï¼Œè™½ç„¶ TcpStream æ”¯æŒå®ƒï¼Œä½†æ˜¯æˆ‘ä»¬ä¸åº”è¯¥åœ¨å•å…ƒæµ‹è¯•ä¸­å¼•å…¥å¤ªè¿‡å¤æ‚çš„è¡Œä¸ºã€‚</p>
<details id="admonition-ä¸ºäº†æµ‹è¯•-read_frame-è€Œå»ºç«‹-tcp-è¿æ¥æ˜¾ç„¶æ²¡æœ‰å¿…è¦æ€ä¹ˆåŠ" class="admonition question">
<summary class="admonition-title">
<p>ä¸ºäº†æµ‹è¯• read_frame() è€Œå»ºç«‹ TCP è¿æ¥ï¼Œæ˜¾ç„¶æ²¡æœ‰å¿…è¦ã€‚æ€ä¹ˆåŠï¼Ÿ </p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸ºäº†æµ‹è¯•-read_frame-è€Œå»ºç«‹-tcp-è¿æ¥æ˜¾ç„¶æ²¡æœ‰å¿…è¦æ€ä¹ˆåŠ"></a></p>
</summary>
<div>
<blockquote>
<p>æˆ‘ä»¬èŠè¿‡æµ‹è¯•ä»£ç å’Œäº§å“ä»£ç åŒç­‰çš„é‡è¦æ€§ï¼Œæ‰€ä»¥ï¼Œåœ¨å¼€å‘ä¸­ï¼Œä¹Ÿè¦ä¸ºæµ‹è¯•ä»£ç åˆ›å»ºåˆé€‚çš„ç”Ÿæ€ç¯å¢ƒï¼Œè®©æµ‹è¯•ç®€æ´ã€å¯è¯»æ€§å¼ºã€‚</p>
</blockquote>
<p>é‚£è¿™é‡Œï¼Œæˆ‘ä»¬å°±åˆ›å»ºä¸€ä¸ªç®€å•çš„æ•°æ®ç»“æ„ï¼Œä½¿å…¶å®ç° AsyncReadï¼Œè¿™æ ·å°±å¯ä»¥â€œå•å…ƒâ€æµ‹è¯• read_frame() äº†ã€‚</p>
<p>åœ¨ src/network/frame.rs é‡Œçš„ mod tests ä¸‹åŠ å…¥ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {
    struct DummyStream {
        buf: BytesMut,
    }

    impl AsyncRead for DummyStream {
        fn poll_read(
            self: std::pin::Pin&lt;&amp;mut Self&gt;,
            _cx: &amp;mut std::task::Context&lt;'_&gt;,
            buf: &amp;mut tokio::io::ReadBuf&lt;'_&gt;,
        ) -&gt; std::task::Poll&lt;std::io::Result&lt;()&gt;&gt; {
            // çœ‹çœ‹ ReadBuf éœ€è¦å¤šå¤§çš„æ•°æ®
            let len = buf.capacity();

            // split å‡ºè¿™ä¹ˆå¤§çš„æ•°æ®
            let data = self.get_mut().buf.split_to(len);

            // æ‹·è´ç»™ ReadBuf
            buf.put_slice(&amp;data);

            // ç›´æ¥å®Œå·¥
            std::task::Poll::Ready(Ok(()))
        }
    }
}
</code></pre></pre>
</div>
</details>
<p>å› ä¸ºåªéœ€è¦ä¿è¯ AsyncRead æ¥å£çš„æ­£ç¡®æ€§ï¼Œæ‰€ä»¥ä¸éœ€è¦å¤ªå¤æ‚çš„é€»è¾‘. æˆ‘ä»¬å°±æ”¾ä¸€ä¸ª bufferï¼Œpoll_read() éœ€è¦è¯»å¤šå¤§çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±ç»™å¤šå¤§çš„æ•°æ®ã€‚</p>
<details id="admonition-æœ‰äº†è¿™ä¸ª-dummystreamå°±å¯ä»¥æµ‹è¯•-read_frame-äº†" class="admonition note">
<summary class="admonition-title">
<p>æœ‰äº†è¿™ä¸ª DummyStreamï¼Œå°±å¯ä»¥æµ‹è¯• read_frame() äº†ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-æœ‰äº†è¿™ä¸ª-dummystreamå°±å¯ä»¥æµ‹è¯•-read_frame-äº†"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[tokio::test]
async fn read_frame_should_work() {
    let mut buf = BytesMut::new();
    let cmd = CommandRequest::new_hdel(&quot;t1&quot;, &quot;k1&quot;);
    cmd.encode_frame(&amp;mut buf).unwrap();
    let mut stream = DummyStream { buf };

    let mut data = BytesMut::new();
    read_frame(&amp;mut stream, &amp;mut data).await.unwrap();

    let cmd1 = CommandRequest::decode_frame(&amp;mut data).unwrap();
    assert_eq!(cmd, cmd1);
}
</code></pre></pre>
</div>
</details>
<p>è¿è¡Œ â€œcargo testâ€ï¼Œæµ‹è¯•é€šè¿‡ã€‚</p>
<blockquote>
<p>å¦‚æœä½ çš„ä»£ç æ— æ³•ç¼–è¯‘ï¼Œå¯ä»¥çœ‹çœ‹ç¼–è¯‘é”™è¯¯ï¼Œæ˜¯ä¸æ˜¯ç¼ºäº†ä¸€äº› use è¯­å¥æ¥æŠŠæŸäº›æ•°æ®ç»“æ„å’Œ trait å¼•å…¥ã€‚</p>
</blockquote>
<h2 id="è®©ç½‘ç»œå±‚å¯ä»¥åƒ-asyncprost-é‚£æ ·æ–¹ä¾¿ä½¿ç”¨"><a class="header" href="#è®©ç½‘ç»œå±‚å¯ä»¥åƒ-asyncprost-é‚£æ ·æ–¹ä¾¿ä½¿ç”¨">è®©ç½‘ç»œå±‚å¯ä»¥åƒ AsyncProst é‚£æ ·æ–¹ä¾¿ä½¿ç”¨</a></h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„ frame å·²ç»å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚</p>
<blockquote>
<p>æ¥ä¸‹æ¥è¦æ„æ€ä¸€ä¸‹ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è¯¥å¦‚ä½•å°è£…ã€‚</p>
</blockquote>
<details id="admonition-1-å¯¹äºæœåŠ¡å™¨æˆ‘ä»¬æœŸæœ›å¯ä»¥å¯¹-accept-ä¸‹æ¥çš„-tcpstream-æä¾›ä¸€ä¸ª-process-æ–¹æ³•å¤„ç†åè®®çš„ç»†èŠ‚" class="admonition note">
<summary class="admonition-title">
<ol>
<li>å¯¹äºæœåŠ¡å™¨ï¼Œæˆ‘ä»¬æœŸæœ›å¯ä»¥å¯¹ accept ä¸‹æ¥çš„ TcpStream æä¾›ä¸€ä¸ª process() æ–¹æ³•ï¼Œå¤„ç†åè®®çš„ç»†èŠ‚ï¼š</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-1-å¯¹äºæœåŠ¡å™¨æˆ‘ä»¬æœŸæœ›å¯ä»¥å¯¹-accept-ä¸‹æ¥çš„-tcpstream-æä¾›ä¸€ä¸ª-process-æ–¹æ³•å¤„ç†åè®®çš„ç»†èŠ‚"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();
    let addr = &quot;127.0.0.1:9527&quot;;
    let service: Service = ServiceInner::new(MemTable::new()).into();
    let listener = TcpListener::bind(addr).await?;
    info!(&quot;Start listening on {}&quot;, addr);
    loop {
        let (stream, addr) = listener.accept().await?;
        info!(&quot;Client {:?} connected&quot;, addr);
        let stream = ProstServerStream::new(stream, service.clone());
        tokio::spawn(async move { stream.process().await });
    }
}
</code></pre></pre>
<p>è¿™ä¸ª process() æ–¹æ³•ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ examples/server.rs ä¸­ tokio::spawn é‡Œçš„ while loop çš„å°è£…ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
while let Some(Ok(cmd)) = stream.next().await {
    info!(&quot;Got a new command: {:?}&quot;, cmd);
    let res = svc.execute(cmd);
    stream.send(res).await.unwrap();
}
</code></pre></pre>
</div>
</details>
<details id="admonition-2-å¯¹å®¢æˆ·ç«¯æˆ‘ä»¬ä¹Ÿå¸Œæœ›å¯ä»¥ç›´æ¥-execute-ä¸€ä¸ªå‘½ä»¤å°±èƒ½å¾—åˆ°ç»“æœ" class="admonition note">
<summary class="admonition-title">
<ol start="2">
<li>å¯¹å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›å¯ä»¥ç›´æ¥ execute() ä¸€ä¸ªå‘½ä»¤ï¼Œå°±èƒ½å¾—åˆ°ç»“æœï¼š</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-å¯¹å®¢æˆ·ç«¯æˆ‘ä»¬ä¹Ÿå¸Œæœ›å¯ä»¥ç›´æ¥-execute-ä¸€ä¸ªå‘½ä»¤å°±èƒ½å¾—åˆ°ç»“æœ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();

    let addr = &quot;127.0.0.1:9527&quot;;
    // è¿æ¥æœåŠ¡å™¨
    let stream = TcpStream::connect(addr).await?;

    let mut client = ProstClientStream::new(stream);

    // ç”Ÿæˆä¸€ä¸ª HSET å‘½ä»¤
    let cmd = CommandRequest::new_hset(&quot;table1&quot;, &quot;hello&quot;, &quot;world&quot;.to_string().into());

    // å‘é€ HSET å‘½ä»¤
    let data = client.execute(cmd).await?;
    info!(&quot;Got response {:?}&quot;, data);

    Ok(())
}
</code></pre></pre>
<p>è¿™ä¸ª execute()ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ examples/client.rs ä¸­å‘é€å’Œæ¥æ”¶ä»£ç çš„å°è£…ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
client.send(cmd).await?;
if let Some(Ok(data)) = client.next().await {
    info!(&quot;Got response {:?}&quot;, data);
}
</code></pre></pre>
<p>è¿™æ ·çš„ä»£ç ï¼Œçœ‹èµ·æ¥å¾ˆç®€æ´ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚</p>
</div>
</details>
<ol start="3">
<li>å¥½ï¼Œå…ˆçœ‹æœåŠ¡å™¨å¤„ç†ä¸€ä¸ª TcpStream çš„æ•°æ®ç»“æ„ï¼Œå®ƒéœ€è¦åŒ…å« TcpStreamï¼Œè¿˜æœ‰æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„ç”¨äºå¤„ç†å®¢æˆ·ç«¯å‘½ä»¤çš„ Serviceã€‚</li>
</ol>
<details id="admonition-æ‰€ä»¥è®©æœåŠ¡å™¨å¤„ç†-tcpstream-çš„ç»“æ„åŒ…å«è¿™ä¸¤éƒ¨åˆ†" class="admonition note">
<summary class="admonition-title">
<p>æ‰€ä»¥ï¼Œè®©æœåŠ¡å™¨å¤„ç† TcpStream çš„ç»“æ„åŒ…å«è¿™ä¸¤éƒ¨åˆ†ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-æ‰€ä»¥è®©æœåŠ¡å™¨å¤„ç†-tcpstream-çš„ç»“æ„åŒ…å«è¿™ä¸¤éƒ¨åˆ†"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct ProstServerStream&lt;S&gt; {
    inner: S,
    service: Service,
}
</code></pre></pre>
<ul>
<li>è¿™é‡Œï¼Œä¾æ—§ä½¿ç”¨äº†æ³›å‹å‚æ•° Sã€‚</li>
<li>æœªæ¥ï¼Œå¦‚æœè¦æ”¯æŒ WebSocketï¼Œæˆ–è€…åœ¨ TCP ä¹‹ä¸Šæ”¯æŒ TLSï¼Œå®ƒéƒ½å¯ä»¥è®©æˆ‘ä»¬æ— éœ€æ”¹å˜è¿™ä¸€å±‚çš„ä»£ç ã€‚</li>
</ul>
</div>
</details>
<ol start="4">
<li>æ¥ä¸‹æ¥å°±æ˜¯å…·ä½“çš„å®ç°ã€‚</li>
</ol>
<p>æœ‰äº† frame çš„å°è£…ï¼ŒæœåŠ¡å™¨çš„ process() æ–¹æ³•å’Œå®¢æˆ·ç«¯çš„ execute() æ–¹æ³•éƒ½å¾ˆå®¹æ˜“å®ç°ã€‚</p>
<details id="admonition-æˆ‘ä»¬ç›´æ¥åœ¨-srcnetworkmodrs-é‡Œæ·»åŠ å®Œæ•´ä»£ç " class="admonition note">
<summary class="admonition-title">
<p>æˆ‘ä»¬ç›´æ¥åœ¨ src/network/mod.rs é‡Œæ·»åŠ å®Œæ•´ä»£ç ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-æˆ‘ä»¬ç›´æ¥åœ¨-srcnetworkmodrs-é‡Œæ·»åŠ å®Œæ•´ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
mod frame;
use bytes::BytesMut;
pub use frame::{read_frame, FrameCoder};
use tokio::io::{AsyncRead, AsyncWrite, AsyncWriteExt};
use tracing::info;

use crate::{CommandRequest, CommandResponse, KvError, Service};

/// å¤„ç†æœåŠ¡å™¨ç«¯çš„æŸä¸ª accept ä¸‹æ¥çš„ socket çš„è¯»å†™
pub struct ProstServerStream&lt;S&gt; {
    inner: S,
    service: Service,
}

/// å¤„ç†å®¢æˆ·ç«¯ socket çš„è¯»å†™
pub struct ProstClientStream&lt;S&gt; {
    inner: S,
}

impl&lt;S&gt; ProstServerStream&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send,
{
    pub fn new(stream: S, service: Service) -&gt; Self {
        Self {
            inner: stream,
            service,
        }
    }

    pub async fn process(mut self) -&gt; Result&lt;(), KvError&gt; {
        while let Ok(cmd) = self.recv().await {
            info!(&quot;Got a new command: {:?}&quot;, cmd);
            let res = self.service.execute(cmd);
            self.send(res).await?;
        }
        // info!(&quot;Client {:?} disconnected&quot;, self.addr);
        Ok(())
    }

    async fn send(&amp;mut self, msg: CommandResponse) -&gt; Result&lt;(), KvError&gt; {
        let mut buf = BytesMut::new();
        msg.encode_frame(&amp;mut buf)?;
        let encoded = buf.freeze();
        self.inner.write_all(&amp;encoded[..]).await?;
        Ok(())
    }

    async fn recv(&amp;mut self) -&gt; Result&lt;CommandRequest, KvError&gt; {
        let mut buf = BytesMut::new();
        let stream = &amp;mut self.inner;
        read_frame(stream, &amp;mut buf).await?;
        CommandRequest::decode_frame(&amp;mut buf)
    }
}

impl&lt;S&gt; ProstClientStream&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send,
{
    pub fn new(stream: S) -&gt; Self {
        Self { inner: stream }
    }

    pub async fn execute(&amp;mut self, cmd: CommandRequest) -&gt; Result&lt;CommandResponse, KvError&gt; {
        self.send(cmd).await?;
        Ok(self.recv().await?)
    }

    async fn send(&amp;mut self, msg: CommandRequest) -&gt; Result&lt;(), KvError&gt; {
        let mut buf = BytesMut::new();
        msg.encode_frame(&amp;mut buf)?;
        let encoded = buf.freeze();
        self.inner.write_all(&amp;encoded[..]).await?;
        Ok(())
    }

    async fn recv(&amp;mut self) -&gt; Result&lt;CommandResponse, KvError&gt; {
        let mut buf = BytesMut::new();
        let stream = &amp;mut self.inner;
        read_frame(stream, &amp;mut buf).await?;
        CommandResponse::decode_frame(&amp;mut buf)
    }
}
</code></pre></pre>
</div>
</details>
<p>è¿™æ®µä»£ç ä¸éš¾é˜…è¯»ï¼ŒåŸºæœ¬ä¸Šå’Œ frame çš„æµ‹è¯•ä»£ç å¤§åŒå°å¼‚ã€‚</p>
<details id="admonition-5-å½“ç„¶äº†æˆ‘ä»¬è¿˜æ˜¯éœ€è¦å†™æ®µä»£ç æ¥æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’çš„æ•´ä¸ªæµç¨‹" class="admonition note">
<summary class="admonition-title">
<ol start="5">
<li>å½“ç„¶äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å†™æ®µä»£ç æ¥æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’çš„æ•´ä¸ªæµç¨‹ï¼š </li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-5-å½“ç„¶äº†æˆ‘ä»¬è¿˜æ˜¯éœ€è¦å†™æ®µä»£ç æ¥æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’çš„æ•´ä¸ªæµç¨‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {
    use anyhow::Result;
    use bytes::Bytes;
    use std::net::SocketAddr;
    use tokio::net::{TcpListener, TcpStream};

    use crate::{assert_res_ok, MemTable, ServiceInner, Value};

    use super::*;

    #[tokio::test]
    async fn client_server_basic_communication_should_work() -&gt; anyhow::Result&lt;()&gt; {
        let addr = start_server().await?;

        let stream = TcpStream::connect(addr).await?;
        let mut client = ProstClientStream::new(stream);

        // å‘é€ HSETï¼Œç­‰å¾…å›åº”

        let cmd = CommandRequest::new_hset(&quot;t1&quot;, &quot;k1&quot;, &quot;v1&quot;.into());
        let res = client.execute(cmd).await.unwrap();

        // ç¬¬ä¸€æ¬¡ HSET æœåŠ¡å™¨åº”è¯¥è¿”å› None
        assert_res_ok(res, &amp;[Value::default()], &amp;[]);

        // å†å‘ä¸€ä¸ª HSET
        let cmd = CommandRequest::new_hget(&quot;t1&quot;, &quot;k1&quot;);
        let res = client.execute(cmd).await?;

        // æœåŠ¡å™¨åº”è¯¥è¿”å›ä¸Šä¸€æ¬¡çš„ç»“æœ
        assert_res_ok(res, &amp;[&quot;v1&quot;.into()], &amp;[]);

        Ok(())
    }

    #[tokio::test]
    async fn client_server_compression_should_work() -&gt; anyhow::Result&lt;()&gt; {
        let addr = start_server().await?;

        let stream = TcpStream::connect(addr).await?;
        let mut client = ProstClientStream::new(stream);

        let v: Value = Bytes::from(vec![0u8; 16384]).into();
        let cmd = CommandRequest::new_hset(&quot;t2&quot;, &quot;k2&quot;, v.clone().into());
        let res = client.execute(cmd).await?;

        assert_res_ok(res, &amp;[Value::default()], &amp;[]);

        let cmd = CommandRequest::new_hget(&quot;t2&quot;, &quot;k2&quot;);
        let res = client.execute(cmd).await?;

        assert_res_ok(res, &amp;[v.into()], &amp;[]);

        Ok(())
    }

    async fn start_server() -&gt; Result&lt;SocketAddr&gt; {
        let listener = TcpListener::bind(&quot;127.0.0.1:0&quot;).await.unwrap();
        let addr = listener.local_addr().unwrap();

        tokio::spawn(async move {
            loop {
                let (stream, _) = listener.accept().await.unwrap();
                let service: Service = ServiceInner::new(MemTable::new()).into();
                let server = ProstServerStream::new(stream, service);
                tokio::spawn(server.process());
            }
        });

        Ok(addr)
    }
}
</code></pre></pre>
</div>
</details>
<h2 id="æ­£å¼åˆ›å»º-kv-server-å’Œ-kv-client"><a class="header" href="#æ­£å¼åˆ›å»º-kv-server-å’Œ-kv-client">æ­£å¼åˆ›å»º kv-server å’Œ kv-client</a></h2>
<p>æˆ‘ä»¬ä¹‹å‰å†™äº†å¾ˆå¤šä»£ç ï¼ŒçœŸæ­£å¯è¿è¡Œçš„ server/client éƒ½æ˜¯ examples ä¸‹çš„ä»£ç ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬ç»ˆäºè¦æ­£å¼åˆ›å»º kv-server / kv-client äº†ã€‚</p>
<ol>
<li>é¦–å…ˆåœ¨ Cargo.toml ä¸­ï¼ŒåŠ å…¥ä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼škvsï¼ˆkv-serverï¼‰å’Œ kvcï¼ˆkv-clientï¼‰ã€‚è¿˜éœ€è¦æŠŠä¸€äº›ä¾èµ–ç§»åŠ¨åˆ° dependencies ä¸‹ã€‚</li>
</ol>
<details id="admonition-2-ä¿®æ”¹ä¹‹åcargotoml-é•¿è¿™ä¸ªæ ·å­" class="admonition note">
<summary class="admonition-title">
<ol start="2">
<li>ä¿®æ”¹ä¹‹åï¼ŒCargo.toml é•¿è¿™ä¸ªæ ·å­ï¼š</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-ä¿®æ”¹ä¹‹åcargotoml-é•¿è¿™ä¸ªæ ·å­"></a></p>
</summary>
<div>
<pre><code class="language-toml">
[package]
name = &quot;kv2&quot;
version = &quot;0.1.0&quot;
edition = &quot;2018&quot;

[[bin]]
name = &quot;kvs&quot;
path = &quot;src/server.rs&quot;

[[bin]]
name = &quot;kvc&quot;
path = &quot;src/client.rs&quot;

[dependencies]
anyhow = &quot;1&quot; # é”™è¯¯å¤„ç†
bytes = &quot;1&quot; # é«˜æ•ˆå¤„ç†ç½‘ç»œ buffer çš„åº“
dashmap = &quot;4&quot; # å¹¶å‘ HashMap
flate2 = &quot;1&quot; # gzip å‹ç¼©
http = &quot;0.2&quot; # æˆ‘ä»¬ä½¿ç”¨ HTTP status code æ‰€ä»¥å¼•å…¥è¿™ä¸ªç±»å‹åº“
prost = &quot;0.8&quot; # å¤„ç† protobuf çš„ä»£ç 
sled = &quot;0.34&quot; # sled db
thiserror = &quot;1&quot; # é”™è¯¯å®šä¹‰å’Œå¤„ç†
tokio = { version = &quot;1&quot;, features = [&quot;full&quot; ] } # å¼‚æ­¥ç½‘ç»œåº“
tracing = &quot;0.1&quot; # æ—¥å¿—å¤„ç†
tracing-subscriber = &quot;0.2&quot; # æ—¥å¿—å¤„ç†

[dev-dependencies]
async-prost = &quot;0.2.1&quot; # æ”¯æŒæŠŠ protobuf å°è£…æˆ TCP frame
futures = &quot;0.3&quot; # æä¾› Stream trait
tempfile = &quot;3&quot; # å¤„ç†ä¸´æ—¶ç›®å½•å’Œä¸´æ—¶æ–‡ä»¶
tokio-util = { version = &quot;0.6&quot;, features = [&quot;codec&quot;]}

[build-dependencies]
prost-build = &quot;0.8&quot; # ç¼–è¯‘ protobuf
</code></pre>
</div>
</details>
<ol start="3">
<li>ç„¶åï¼Œåˆ›å»º src/client.rs å’Œ src/server.rsï¼Œåˆ†åˆ«å†™å…¥ä¸‹é¢çš„ä»£ç ã€‚</li>
</ol>
<details id="admonition-srcclientrs" class="admonition note">
<summary class="admonition-title">
<p>src/client.rsï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-srcclientrs"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use kv2::{CommandRequest, ProstClientStream};
use tokio::net::TcpStream;
use tracing::info;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();

    let addr = &quot;127.0.0.1:9527&quot;;
    // è¿æ¥æœåŠ¡å™¨
    let stream = TcpStream::connect(addr).await?;

    let mut client = ProstClientStream::new(stream);

    // ç”Ÿæˆä¸€ä¸ª HSET å‘½ä»¤
    let cmd = CommandRequest::new_hset(&quot;table1&quot;, &quot;hello&quot;, &quot;world&quot;.to_string().into());

    // å‘é€ HSET å‘½ä»¤
    let data = client.execute(cmd).await?;
    info!(&quot;Got response {:?}&quot;, data);

    Ok(())
}
</code></pre></pre>
</div>
</details>
<p>è¿™å’Œä¹‹å‰çš„ client / server çš„ä»£ç å‡ ä¹ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è‡ªå·±æ’°å†™çš„ frame å¤„ç†æ–¹æ³•ã€‚</p>
<details id="admonition-æµ‹è¯•æˆåŠŸ" class="admonition success">
<summary class="admonition-title">
<p>æµ‹è¯•æˆåŠŸï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-æµ‹è¯•æˆåŠŸ"></a></p>
</summary>
<div>
<ul>
<li>å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</li>
</ul>
<pre><code class="language-shell">RUST_LOG=info cargo run --bin kvs --quiet
</code></pre>
<ul>
<li>ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</li>
</ul>
<pre><code class="language-shell">RUST_LOG=info cargo run --bin kvc --quiet
</code></pre>
</div>
</details>
<ul>
<li>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ä¸”å¤„ç†æ­£å¸¸ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çš„ KV server è¶Šæ¥è¶Šåƒå›äº‹äº†ï¼</li>
</ul>
<h2 id="å›é¡¾ç½‘ç»œå¼€å‘"><a class="header" href="#å›é¡¾ç½‘ç»œå¼€å‘">å›é¡¾ç½‘ç»œå¼€å‘</a></h2>
<p>ç½‘ç»œå¼€å‘æ˜¯ Rust ä¸‹ä¸€ä¸ªå¾ˆé‡è¦çš„åº”ç”¨åœºæ™¯ã€‚tokio ä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆæ£’çš„å¼‚æ­¥ç½‘ç»œå¼€å‘çš„æ”¯æŒã€‚</p>
<details id="admonition-ç½‘ç»œå¼€å‘çš„æç¤º1-frameå¦‚ä½•å°è£…2-è‡ªå®šä¹‰æµ‹è¯•æ•°æ®ç»“æ„3-å•å…ƒæµ‹è¯•è¦†ç›–ç‡" class="admonition tip">
<summary class="admonition-title">
<p>ç½‘ç»œå¼€å‘çš„æç¤ºï¼š1. frameå¦‚ä½•å°è£…ï¼›2. è‡ªå®šä¹‰æµ‹è¯•æ•°æ®ç»“æ„ï¼›3. å•å…ƒæµ‹è¯•è¦†ç›–ç‡ </p>
<p><a class="admonition-anchor-link" href="#admonition-ç½‘ç»œå¼€å‘çš„æç¤º1-frameå¦‚ä½•å°è£…2-è‡ªå®šä¹‰æµ‹è¯•æ•°æ®ç»“æ„3-å•å…ƒæµ‹è¯•è¦†ç›–ç‡"></a></p>
</summary>
<div>
<p>åœ¨å¼€å‘ç½‘ç»œåè®®æ—¶ï¼Œä½ è¦ç¡®å®šä½ çš„ frame å¦‚ä½•å°è£…ï¼š</p>
<ul>
<li>ä¸€èˆ¬æ¥è¯´ï¼Œé•¿åº¦ + protobuf è¶³ä»¥åº”ä»˜ç»å¤§å¤šæ•°å¤æ‚çš„åè®®éœ€æ±‚ã€‚</li>
<li>æˆ‘ä»¬è™½ç„¶è¯¦ç»†ä»‹ç»äº†è‡ªå·±è¯¥å¦‚ä½•å¤„ç†ç”¨é•¿åº¦å°è£… frame çš„æ–¹æ³•ï¼Œå…¶å® tokio-util æä¾›äº† <a href="https://docs.rs/tokio-util/0.6.8/tokio_util/codec/length_delimited/index.html">LengthDelimitedCodec</a>ï¼Œå¯ä»¥å®Œæˆä»Šå¤©å…³äº frame éƒ¨åˆ†çš„å¤„ç†ã€‚å¦‚æœä½ è‡ªå·±æ’°å†™ç½‘ç»œç¨‹åºï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒã€‚</li>
</ul>
<p>åœ¨ç½‘ç»œå¼€å‘çš„æ—¶å€™ï¼Œå¦‚ä½•åšå•å…ƒæµ‹è¯•æ˜¯ä¸€å¤§ç—›ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…¶å®ç°çš„æ¥å£ï¼Œå›´ç»•ç€æ¥å£æ¥æ„å»ºæµ‹è¯•æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ TcpStream å®ç°äº† AsycnRead / AsyncWriteã€‚</p>
<p>è€ƒè™‘ç®€æ´å’Œå¯è¯»ï¼Œä¸ºäº†æµ‹è¯• read_frame() ï¼Œæˆ‘ä»¬æ„å»ºäº† DummyStream æ¥ååŠ©æµ‹è¯•ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹å¼å¤„ç†ä½ æ‰€åšé¡¹ç›®çš„æµ‹è¯•éœ€æ±‚ã€‚</p>
<p>ç»“æ„è‰¯å¥½æ¶æ„æ¸…æ™°çš„ä»£ç ï¼Œä¸€å®šæ˜¯å®¹æ˜“æµ‹è¯•çš„ä»£ç ï¼Œçºµè§‚æ•´ä¸ªé¡¹ç›®ï¼Œä» CommandService trait å’Œ Storage trait çš„æµ‹è¯•ï¼Œä¸€è·¯åˆ°ç°åœ¨ç½‘ç»œå±‚çš„æµ‹è¯•ã€‚å¦‚æœä½¿ç”¨ <a href="https://github.com/xd009642/tarpaulin">tarpaulin </a>æ¥çœ‹æµ‹è¯•è¦†ç›–ç‡ï¼Œä½ ä¼šå‘ç°ï¼Œè¿™ä¸ªé¡¹ç›®ç›®å‰å·²ç»æœ‰ 89% äº†ï¼Œå¦‚æœä¸ç®— src/server.rs å’Œ src/client.rs çš„è¯ï¼Œæœ‰æ¥è¿‘ 92% çš„æµ‹è¯•è¦†ç›–ç‡ã€‚å³ä¾¿åœ¨ç”Ÿäº§ç¯å¢ƒçš„ä»£ç é‡Œï¼Œè¿™ä¹Ÿç®—æ˜¯å¾ˆé«˜è´¨é‡çš„æµ‹è¯•è¦†ç›–ç‡äº†ã€‚</p>
<pre><code class="language-shell">INFO cargo_tarpaulin::report: Coverage Results:
|| Tested/Total Lines:
|| src/client.rs: 0/9 +0.00%
|| src/network/frame.rs: 80/82 +0.00%
|| src/network/mod.rs: 65/66 +4.66%
|| src/pb/mod.rs: 54/75 +0.00%
|| src/server.rs: 0/11 +0.00%
|| src/service/command_service.rs: 120/129 +0.00%
|| src/service/mod.rs: 79/84 +0.00%
|| src/storage/memory.rs: 34/37 +0.00%
|| src/storage/mod.rs: 58/58 +0.00%
|| src/storage/sleddb.rs: 40/43 +0.00%
||
89.23% coverage, 530/594 lines covered
</code></pre>
</div>
</details>
<details id="admonition-è€ƒè™‘æ”¯æŒgziplz4å’Œzstd" class="admonition question">
<summary class="admonition-title">
<p>è€ƒè™‘æ”¯æŒgzipã€lz4å’Œzstd</p>
<p><a class="admonition-anchor-link" href="#admonition-è€ƒè™‘æ”¯æŒgziplz4å’Œzstd"></a></p>
</summary>
<div>
<p>åœ¨è®¾è®¡ frame çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬çš„å‹ç¼©æ–¹æ³•ä¸æ­¢ gzip ä¸€ç§ï¼Œè€Œæ˜¯æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯éƒ½ä¼šæ ¹æ®å„è‡ªçš„æƒ…å†µï¼Œåœ¨éœ€è¦çš„æ—¶å€™åšæŸç§ç®—æ³•çš„å‹ç¼©ã€‚å‡è®¾æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¯æŒ gzipã€lz4 å’Œ zstd è¿™ä¸‰ç§å‹ç¼©ç®—æ³•ã€‚é‚£ä¹ˆ frame è¯¥å¦‚ä½•è®¾è®¡å‘¢ï¼Ÿéœ€è¦ç”¨å‡ ä¸ª bit æ¥å­˜æ”¾å‹ç¼©ç®—æ³•çš„ä¿¡æ¯ï¼Ÿ</p>
<p>ç›®å‰æˆ‘ä»¬çš„ client åªé€‚åˆæµ‹è¯•ï¼Œä½ å¯ä»¥å°†å…¶ä¿®æ”¹æˆä¸€ä¸ªå®Œæ•´çš„å‘½ä»¤è¡Œç¨‹åºä¹ˆï¼Ÿå°æç¤ºï¼Œå¯ä»¥ä½¿ç”¨ clap æˆ– structoptï¼Œç”¨æˆ·å¯ä»¥è¾“å…¥ä¸åŒçš„å‘½ä»¤ï¼›æˆ–è€…åšä¸€ä¸ªäº¤äº’å¼çš„å‘½ä»¤è¡Œï¼Œä½¿ç”¨ shellfish æˆ– rustylineï¼Œå°±åƒ redis-cli é‚£æ ·ã€‚</p>
<p>è¯•ç€ä½¿ç”¨ LengthDelimitedCodec æ¥é‡å†™ frame è¿™ä¸€å±‚ã€‚</p>
</div>
</details>
<details id="admonition-å…³äºtarpaulin" class="admonition info">
<summary class="admonition-title">
<p>å…³äºtarpaulin </p>
<p><a class="admonition-anchor-link" href="#admonition-å…³äºtarpaulin"></a></p>
</summary>
<div>
<p>arpaulin æ˜¯ Rust ä¸‹åšæµ‹è¯•è¦†ç›–ç‡çš„å·¥å…·ã€‚å› ä¸ºä½¿ç”¨äº†æ“ä½œç³»ç»Ÿå’Œ CPU çš„ç‰¹æ®ŠæŒ‡ä»¤è¿½è¸ªä»£ç çš„æ‰§è¡Œï¼Œæ‰€ä»¥å®ƒç›®å‰åªæ”¯æŒ x86_64 / Linuxã€‚æµ‹è¯•è¦†ç›–ç‡ä¸€èˆ¬åœ¨ CI ä¸­ä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰ Linux çš„æ”¯æŒä¹Ÿè¶³å¤Ÿäº†ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œçš„ä»£ç ï¼Œéƒ½è¦æ±‚è‡³å°‘æœ‰ 80% ä»¥ä¸Šçš„æµ‹è¯•è¦†ç›–ç‡ã€‚ä¸ºé¡¹ç›®æ„å»ºè¶³å¤Ÿå¥½çš„æµ‹è¯•è¦†ç›–ç‡å¹¶ä¸å®¹æ˜“ï¼Œå› ä¸ºè¿™é¦–å…ˆæ„å‘³ç€å†™å‡ºæ¥çš„ä»£ç è¦å®¹æ˜“æµ‹è¯•ã€‚æ‰€ä»¥ï¼Œå¯¹äºæ–°çš„é¡¹ç›®ï¼Œæœ€å¥½ä¸€å¼€å§‹å°±åœ¨ CI ä¸­ä¸ºæµ‹è¯•è¦†ç›–ç‡è®¾ç½®ä¸€ä¸ªé—¨æ§›ï¼Œè¿™æ ·å¯ä»¥å€’é€¼ç€å¤§å®¶ä¿è¯å•å…ƒæµ‹è¯•çš„æ•°é‡ã€‚åŒæ—¶ï¼Œå•å…ƒæµ‹è¯•åˆä¼šå€’é€¼ä»£ç è¦æœ‰è‰¯å¥½çš„ç»“æ„å’Œè‰¯å¥½çš„æ¥å£ï¼Œå¦åˆ™ä¸å®¹æ˜“æµ‹è¯•ã€‚</p>
</div>
</details>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="kv3_advanced_traits.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="kv5_network_security.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="kv3_advanced_traits.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="kv5_network_security.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
