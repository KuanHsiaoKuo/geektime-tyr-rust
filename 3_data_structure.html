<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>III. æ•°æ®ç»“æ„ - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html" class="active"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="iii-æ•°æ®ç»“æ„"><a class="header" href="#iii-æ•°æ®ç»“æ„">III. æ•°æ®ç»“æ„</a></h1>
<!--ts-->
<ul>
<li><a href="#iii-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">III. æ•°æ®ç»“æ„</a>
<ul>
<li><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%BF%AB%E9%80%9F%E4%B8%80%E8%A7%88">æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ</a></li>
<li><a href="#%E5%88%86%E7%B1%BB%E5%9B%BE">åˆ†ç±»å›¾</a></li>
</ul>
</li>
<li><a href="#%E4%B8%80%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88">ä¸€ã€æ™ºèƒ½æŒ‡é’ˆ</a>
<ul>
<li><a href="#%E6%8C%87%E9%92%88%E8%BF%98%E6%98%AF%E5%BC%95%E7%94%A8">æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨</a></li>
<li><a href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E4%B8%8D%E4%BB%85%E6%98%AF%E6%8C%87%E9%92%88">æ™ºèƒ½æŒ‡é’ˆä¸ä»…æ˜¯æŒ‡é’ˆ</a></li>
<li><a href="#box-%E5%9C%A8%E5%A0%86%E4%B8%8A%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98">Box: åœ¨å †ä¸Šåˆ†é…å†…å­˜</a>
<ul>
<li><a href="#%E5%AE%9E%E7%8E%B0%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8">å®ç°å†…å­˜åˆ†é…å™¨</a></li>
<li><a href="#%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E9%87%8A%E6%94%BE">å†…å­˜å¦‚ä½•é‡Šæ”¾</a></li>
</ul>
</li>
<li><a href="#cowa-b-%E5%86%99%E6%97%B6%E6%8B%B7%E8%B4%9D">Cow&lt;â€™a, B&gt;ï¼š å†™æ—¶æ‹·è´</a>
<ul>
<li><a href="#%E5%AE%9A%E4%B9%89">å®šä¹‰</a></li>
<li><a href="#%E4%B8%A4%E4%B8%AAtraittoownedborrowed">ä¸¤ä¸ªtraitï¼šToOwnedã€Borrowed</a></li>
<li><a href="#toowned">ToOwned</a></li>
<li><a href="#%E5%8C%B9%E9%85%8D%E5%88%86%E5%8F%91">åŒ¹é…åˆ†å‘</a></li>
<li><a href="#cow%E5%9C%A8%E9%9C%80%E8%A6%81%E6%97%B6%E6%89%8D%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%8B%B7%E8%B4%9D">Cowåœ¨éœ€è¦æ—¶æ‰è¿›è¡Œå†…å­˜åˆ†é…æ‹·è´</a></li>
</ul>
</li>
<li><a href="#mutexguard-%E6%95%B0%E6%8D%AE%E5%8A%A0%E9%94%81">MutexGuardï¼š æ•°æ®åŠ é”</a>
<ul>
<li><a href="#mutexguard%E4%B8%8Estringboxcowa-b%E7%9A%84%E5%AF%B9%E6%AF%94">MutexGuardä¸Stringã€Boxã€Cow&lt;â€™a, B&gt;çš„å¯¹æ¯”</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8mutexlock%E8%8E%B7%E5%8F%96">ä½¿ç”¨Mutex::lockè·å–</a></li>
<li><a href="#%E5%AE%9A%E4%B9%89%E4%B8%8Ederefdrop-trait%E5%AE%9E%E7%8E%B0">å®šä¹‰ä¸Derefã€Drop traitå®ç°</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8mutex_mutexguard%E7%9A%84%E4%BE%8B%E5%AD%90">ä½¿ç”¨Mutex_MutexGuardçš„ä¾‹å­</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88">è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8">äºŒã€é›†åˆå®¹å™¨</a>
<ul>
<li><a href="#%E5%AF%B9%E5%AE%B9%E5%99%A8%E8%BF%9B%E8%A1%8C%E5%AE%9A%E4%B9%89">å¯¹å®¹å™¨è¿›è¡Œå®šä¹‰</a></li>
<li><a href="#%E5%AF%B9%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E8%BF%9B%E8%A1%8C%E5%AE%9A%E4%B9%89">å¯¹é›†åˆå®¹å™¨è¿›è¡Œå®šä¹‰</a></li>
<li><a href="#%E5%88%87%E7%89%87">åˆ‡ç‰‡</a>
<ul>
<li><a href="#array-vs-vector">array vs vector</a></li>
<li>[Vec å’Œ &amp;[T]](#vec-å’Œ-t)</li>
<li><a href="#%E8%A7%A3%E5%BC%95%E7%94%A8">è§£å¼•ç”¨</a></li>
<li><a href="#%E5%88%87%E7%89%87%E5%92%8C%E8%BF%AD%E4%BB%A3%E5%99%A8-iterator">åˆ‡ç‰‡å’Œè¿­ä»£å™¨ Iterator</a></li>
<li><a href="#%E7%89%B9%E6%AE%8A%E7%9A%84%E5%88%87%E7%89%87str">ç‰¹æ®Šçš„åˆ‡ç‰‡ï¼š&amp;str</a></li>
<li>[Box&lt;[T]&gt;](#boxt)</li>
<li><a href="#%E5%B8%B8%E7%94%A8%E5%88%87%E7%89%87%E5%AF%B9%E6%AF%94%E5%9B%BE">å¸¸ç”¨åˆ‡ç‰‡å¯¹æ¯”å›¾</a></li>
</ul>
</li>
<li><a href="#%E5%93%88%E5%B8%8C%E8%A1%A8">å“ˆå¸Œè¡¨</a>
<ul>
<li><a href="#%E5%93%88%E5%B8%8C%E8%A1%A8%E8%BF%98%E6%98%AF%E5%88%97%E8%A1%A8">å“ˆå¸Œè¡¨è¿˜æ˜¯åˆ—è¡¨</a></li>
<li><a href="#rust-%E7%9A%84%E5%93%88%E5%B8%8C%E8%A1%A8">Rust çš„å“ˆå¸Œè¡¨</a></li>
</ul>
</li>
<li><a href="#-1"><a target="_blank" rel="noopener noreferrer nofollow" href="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882967.jpg"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882967.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" style="max-width: 100%;"></a>
</a>
<ul>
<li><a href="#hashmap-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">HashMap çš„æ•°æ®ç»“æ„</a></li>
<li><a href="#hashmap-%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">HashMap çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</a></li>
<li><a href="#hashmap-%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">HashMap çš„å†…å­˜å¸ƒå±€</a></li>
<li><a href="#ctrl-%E8%A1%A8">ctrl è¡¨</a></li>
<li><a href="#%E5%93%88%E5%B8%8C%E8%A1%A8%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D%E4%B8%8E%E5%A2%9E%E9%95%BF">å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E5%80%BC">åˆ é™¤ä¸€ä¸ªå€¼</a></li>
<li><a href="#%E8%AE%A9%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%81%9A-hash-key">è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš Hash key</a></li>
<li><a href="#hashset--btreemap--btreeset">HashSet / BTreeMap / BTreeSet</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88-rust-%E7%9A%84-hashmap-%E8%A6%81%E7%BC%BA%E7%9C%81%E9%87%87%E7%94%A8%E5%8A%A0%E5%AF%86%E5%AE%89%E5%85%A8%E7%9A%84%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95">ä¸ºä»€ä¹ˆ Rust çš„ HashMap è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Ÿ</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E4%B8%89%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">ä¸‰ã€é”™è¯¯å¤„ç†</a>
<ul>
<li><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%8C%85%E5%90%AB%E8%BF%99%E4%B9%88%E5%87%A0%E9%83%A8%E5%88%86">é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%BB%E6%B5%81%E6%96%B9%E6%B3%95">é”™è¯¯å¤„ç†çš„ä¸»æµæ–¹æ³•</a></li>
<li><a href="#rust-%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">Rust çš„é”™è¯¯å¤„ç†</a>
<ul>
<li><a href="#rust-%E5%81%B7%E5%B8%88-haskell%E6%9E%84%E5%BB%BA%E4%BA%86%E5%AF%B9%E6%A0%87-maybe-%E7%9A%84-option-%E7%B1%BB%E5%9E%8B%E5%92%8C-%E5%AF%B9%E6%A0%87-either-%E7%9A%84-result-%E7%B1%BB%E5%9E%8B">Rust å·å¸ˆ Haskellï¼Œæ„å»ºäº†å¯¹æ ‡ Maybe çš„ Option ç±»å‹å’Œ å¯¹æ ‡ Either çš„ Result ç±»å‹ã€‚</a></li>
<li><a href="#-%E6%93%8D%E4%BD%9C%E7%AC%A6">? æ“ä½œç¬¦</a></li>
<li><a href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">å‡½æ•°å¼é”™è¯¯å¤„ç†</a></li>
<li><a href="#panic-%E5%92%8C-catch_unwind">panic! å’Œ catch_unwind</a></li>
<li><a href="#error-trait-%E5%92%8C%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BD%AC%E6%8D%A2">Error trait å’Œé”™è¯¯ç±»å‹çš„è½¬æ¢</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%9B%9B%E9%97%AD%E5%8C%85%E7%BB%93%E6%9E%84">å››ã€é—­åŒ…ç»“æ„</a>
<ul>
<li><a href="#%E9%97%AD%E5%8C%85%E7%9A%84%E5%AE%9A%E4%B9%89">é—­åŒ…çš„å®šä¹‰</a></li>
<li><a href="#%E9%97%AD%E5%8C%85%E6%9C%AC%E8%B4%A8%E4%B8%8A%E6%98%AF%E4%BB%80%E4%B9%88">é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="#%E4%B8%8D%E5%90%8C%E8%AF%AD%E8%A8%80%E7%9A%84%E9%97%AD%E5%8C%85%E8%AE%BE%E8%AE%A1">ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡</a></li>
<li><a href="#rust-%E7%9A%84%E9%97%AD%E5%8C%85%E7%B1%BB%E5%9E%8B">Rust çš„é—­åŒ…ç±»å‹</a>
<ul>
<li><a href="#fnonce">FnOnce</a></li>
<li><a href="#%E6%80%8E%E4%B9%88%E7%90%86%E8%A7%A3-fnonce-%E7%9A%84-args-%E6%B3%9B%E5%9E%8B%E5%8F%82%E6%95%B0%E5%91%A2">æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ</a></li>
<li><a href="#fnmut">FnMut</a></li>
<li><a href="#fn">Fn</a></li>
<li><a href="#%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B%E4%B8%89%E7%A7%8D%E9%97%AD%E5%8C%85%E4%BD%BF%E7%94%A8%E7%9A%84%E6%83%85%E5%86%B5%E4%BB%A5%E5%8F%8A%E5%AE%83%E4%BB%AC%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB">æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»</a></li>
</ul>
</li>
<li><a href="#%E9%97%AD%E5%8C%85%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">é—­åŒ…çš„ä½¿ç”¨åœºæ™¯</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sun Oct  9 02:33:18 UTC 2022 -->
<!--te-->
<h2 id="æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ"><a class="header" href="#æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ">æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ</a></h2>
<div id="admonition-æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ" class="admonition tip">
<div class="admonition-title">
<p>æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ</p>
<p><a class="admonition-anchor-link" href="#admonition-æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ"></a></p>
</div>
<div>
<blockquote>
<p>ç”¨40åˆ†é’Ÿçš„æ—¶é—´ï¼Œæ€»ç»“äº†Rustçš„ä¸»è¦æ•°æ®ç»“æ„çš„å†… å­˜å¸ƒå±€ã€‚å®ƒèƒ½å˜æ¸…â€œæ•°æ®æ˜¯å¦‚ä½•åœ¨å †å’Œæ ˆä¸Šå­˜å‚¨â€œçš„æ€è·¯ï¼Œåœ¨è¿™é‡Œä¹Ÿæ¨èç»™ä½ ã€‚
<a href="https://www.youtube.com/watch?v=rDoqT-a6UFg">Visualizing memory layout of Rustâ€™s data types - YouTube</a></p>
</blockquote>
</div>
</div>
<h2 id="åˆ†ç±»å›¾"><a class="header" href="#åˆ†ç±»å›¾">åˆ†ç±»å›¾</a></h2>
<blockquote>
<p>æ•°æ®ç»“æ„å¯ä»¥çœ‹ä½œå¯¹äºç±»å‹ç³»ç»Ÿçš„è¿›ä¸€æ­¥æ•´ç†ï¼Œç»“æ„åŒ–ã€‚è¿™å…¶å®æ˜¯è¿›ä¸€æ­¥æŠ½è±¡ï¼Œä»ç±»å‹ä¸­æå–å‡ºæ—¥å¸¸å¸¸ç”¨çš„å·¥å…·å¹¶åˆ†ç±»ã€‚</p>
</blockquote>
<div id="admonition-ä»ç³»ç»Ÿå®¹å™¨åŸç”Ÿä¸‰ä¸ªçº¬åº¦åˆ†ç±»" class="admonition info">
<div class="admonition-title">
<p>ä»ç³»ç»Ÿ/å®¹å™¨/åŸç”Ÿä¸‰ä¸ªçº¬åº¦åˆ†ç±»</p>
<p><a class="admonition-anchor-link" href="#admonition-ä»ç³»ç»Ÿå®¹å™¨åŸç”Ÿä¸‰ä¸ªçº¬åº¦åˆ†ç±»"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F.jpg" alt="" /></p>
</div>
</div>
<h1 id="ä¸€æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#ä¸€æ™ºèƒ½æŒ‡é’ˆ">ä¸€ã€æ™ºèƒ½æŒ‡é’ˆ</a></h1>
<h2 id="æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨"><a class="header" href="#æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨">æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨</a></h2>
<details id="admonition-å¼•ç”¨æ˜¯ç‰¹æ®Šçš„æŒ‡é’ˆ" class="admonition info">
<summary class="admonition-title">
<p>å¼•ç”¨æ˜¯ç‰¹æ®Šçš„æŒ‡é’ˆ</p>
<p><a class="admonition-anchor-link" href="#admonition-å¼•ç”¨æ˜¯ç‰¹æ®Šçš„æŒ‡é’ˆ"></a></p>
</summary>
<div>
<ol>
<li>æŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒæœ‰å†…å­˜åœ°å€çš„å€¼ï¼Œå¯ä»¥é€šè¿‡è§£å¼•ç”¨æ¥è®¿é—®å®ƒæŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œç†è®ºä¸Šå¯ä»¥è§£å¼•ç”¨åˆ°ä»»æ„æ•°æ®ç±»å‹ï¼›</li>
<li>å¼•ç”¨æ˜¯ä¸€ä¸ªç‰¹æ®Š çš„æŒ‡é’ˆï¼Œå®ƒçš„è§£å¼•ç”¨è®¿é—®æ˜¯å—é™çš„ï¼Œåªèƒ½è§£å¼•ç”¨åˆ°å®ƒå¼•ç”¨æ•°æ®çš„ç±»å‹ï¼Œä¸èƒ½ç”¨ä½œå®ƒç”¨ã€‚</li>
</ol>
</div>
</details>
<h2 id="æ™ºèƒ½æŒ‡é’ˆä¸ä»…æ˜¯æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆä¸ä»…æ˜¯æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆä¸ä»…æ˜¯æŒ‡é’ˆ</a></h2>
<details id="admonition-æ™ºèƒ½æŒ‡é’ˆæŒ‡é’ˆé¢å¤–å¤„ç†èƒ½åŠ›" class="admonition info">
<summary class="admonition-title">
<p>æ™ºèƒ½æŒ‡é’ˆ=æŒ‡é’ˆ+é¢å¤–å¤„ç†èƒ½åŠ›</p>
<p><a class="admonition-anchor-link" href="#admonition-æ™ºèƒ½æŒ‡é’ˆæŒ‡é’ˆé¢å¤–å¤„ç†èƒ½åŠ›"></a></p>
</summary>
<div>
<ol>
<li>åœ¨æŒ‡é’ˆå’Œå¼•ç”¨çš„åŸºç¡€ä¸Šï¼ŒRust å·å¸ˆ C++ï¼Œæä¾›äº†æ™ºèƒ½æŒ‡é’ˆã€‚</li>
<li>æ™ºèƒ½æŒ‡é’ˆæ˜¯ä¸€ä¸ªè¡¨ç°è¡Œä¸ºå¾ˆ åƒæŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼Œä½†é™¤äº†æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆå¤–ï¼Œå®ƒè¿˜æœ‰å…ƒæ•°æ®ä»¥æä¾›é¢å¤–çš„å¤„ç†èƒ½åŠ›ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-æ™ºèƒ½æŒ‡é’ˆèƒ–æŒ‡é’ˆæ‰€æœ‰æƒ" class="admonition info">
<summary class="admonition-title">
<p>æ™ºèƒ½æŒ‡é’ˆ=èƒ–æŒ‡é’ˆ+æ‰€æœ‰æƒ</p>
<p><a class="admonition-anchor-link" href="#admonition-æ™ºèƒ½æŒ‡é’ˆèƒ–æŒ‡é’ˆæ‰€æœ‰æƒ"></a></p>
</summary>
<div>
<ol>
<li>æ™ºèƒ½æŒ‡é’ˆä¸€å®šæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œä½†èƒ–æŒ‡é’ˆä¸ä¸€å®šæ˜¯ä¸€ä¸ª æ™ºèƒ½æŒ‡é’ˆã€‚</li>
<li>æ¯”å¦‚ &amp;str å°±åªæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œå®ƒæœ‰æŒ‡å‘å †å†…å­˜å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼ŒåŒæ—¶è¿˜æœ‰å…³äºå­— ç¬¦ä¸²é•¿åº¦çš„å…ƒæ•°æ®ã€‚</li>
</ol>
<h2 id=""><a class="header" href="#"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/15%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BF%99%E4%BA%9B%E6%B5%93%E7%9C%89%E5%A4%A7%E7%9C%BC%E7%9A%84%E7%BB%93%E6%9E%84%E7%AB%9F%E7%84%B6%E9%83%BD%E6%98%AF%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9F.jpg" alt="" /></a></h2>
<ol>
<li>String é™¤äº†å¤šä¸€ä¸ª capacity å­—æ®µï¼Œä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šã€‚</li>
<li>ä½† String å¯¹ å †ä¸Šçš„å€¼æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;str æ˜¯æ²¡æœ‰æ‰€æœ‰æƒçš„</li>
<li>è¿™æ˜¯ Rust ä¸­æ™ºèƒ½æŒ‡é’ˆå’Œæ™®é€šèƒ–æŒ‡é’ˆçš„åŒº åˆ«ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-æ™ºèƒ½æŒ‡é’ˆå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«" class="admonition info">
<summary class="admonition-title">
<p>æ™ºèƒ½æŒ‡é’ˆå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«</p>
<p><a class="admonition-anchor-link" href="#admonition-æ™ºèƒ½æŒ‡é’ˆå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«"></a></p>
</summary>
<div>
<ol>
<li>Stringç”¨ç»“æ„ä½“å®šä¹‰ï¼Œå…¶å®å°±æ˜¯Vec<u8></li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>pub struct String {
    vec: Vec&lt;u8&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<ol start="2">
<li>å’Œæ™®é€šçš„ç»“æ„ä½“ä¸åŒçš„æ˜¯ï¼Œ<a href="https://doc.rust-lang.org/src/alloc/string.rs.html#2301-2316">String å®ç°äº† Deref å’Œ DerefMut</a>ï¼Œè¿™ä½¿å¾—å®ƒåœ¨è§£å¼•ç”¨çš„æ—¶
å€™ï¼Œä¼šå¾—åˆ° &amp;str</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>impl ops::Deref for String {
    type Target = str;

    fn deref(&amp;self) -&gt; &amp;str {
        unsafe { str::from_utf8_unchecked(&amp;self.vec) }
    }
}

impl ops::DerefMut for String {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut str {
        unsafe { str::from_utf8_unchecked_mut(&amp;mut *self.vec) }
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol start="3">
<li>å¦å¤–ï¼Œç”±äºåœ¨å †ä¸Šåˆ†é…äº†æ•°æ®ï¼ŒString è¿˜éœ€è¦ä¸ºå…¶åˆ†é…çš„èµ„æºåšç›¸åº”çš„å›æ”¶ã€‚è€Œ String å†…éƒ¨ä½¿ç”¨äº†
Vecï¼Œæ‰€ä»¥å®ƒå¯ä»¥<a href="https://doc.rust-lang.org/src/alloc/vec/mod.rs.html#2710-2720">ä¾èµ– Vec çš„èƒ½åŠ›æ¥é‡Šæ”¾å †å†…å­˜</a></li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>unsafe impl&lt;#[may_dangle] T, A: Allocator&gt; Drop for Vec&lt;T, A&gt; {
    fn drop(&amp;mut self) {
        unsafe {
            // use drop for [T]
            // use a raw slice to refer to the elements of the vector as weakest necessary type;
            // could avoid questions of validity in certain cases
            ptr::drop_in_place(ptr::slice_from_raw_parts_mut(self.as_mut_ptr(), self.len))
        }
        // RawVec handles deallocation
    }
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-åœ¨-rust-ä¸­å‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ä¸”å®ç°äº†-derefderefmutdropéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆ" class="admonition info">
<summary class="admonition-title">
<p>åœ¨ Rust ä¸­ï¼Œå‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ï¼Œä¸”å®ç°äº† Deref/DerefMut/Dropï¼Œéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-åœ¨-rust-ä¸­å‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ä¸”å®ç°äº†-derefderefmutdropéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆ"></a></p>
</summary>
<div>
<p>æŒ‰ç…§è¿™ä¸ªå®šä¹‰ï¼Œé™¤äº† Stringï¼Œè¿˜æœ‰å¾ˆå¤šæ™ºèƒ½æŒ‡é’ˆï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>
<p>ç”¨äºåœ¨å †ä¸Š åˆ†é…å†…å­˜çš„ Box<T> å’Œ Vec<T></p>
</li>
<li>
<p>ç”¨äºå¼•ç”¨è®¡æ•°çš„ Rc<T> å’Œ Arc<T> </p>
</li>
<li>
<p>å¾ˆå¤šå…¶ä»–æ•°æ®ç»“ æ„ï¼Œå¦‚ PathBufã€Cow&lt;â€™a, B&gt;ã€MutexGuard<T>ã€RwLockReadGuard<T> å’Œ RwLockWriteGuard ç­‰ä¹Ÿæ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚</p>
</li>
</ol>
</div>
</details>
<h2 id="box-åœ¨å †ä¸Šåˆ†é…å†…å­˜"><a class="header" href="#box-åœ¨å †ä¸Šåˆ†é…å†…å­˜">Box<T>: åœ¨å †ä¸Šåˆ†é…å†…å­˜</a></h2>
<details id="admonition-ä»ccå¾—åˆ°boxçµæ„Ÿ" class="admonition info">
<summary class="admonition-title">
<p>ä»c/c++å¾—åˆ°Box<T>çµæ„Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-ä»ccå¾—åˆ°boxçµæ„Ÿ"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬å…ˆçœ‹ Box<T>ï¼Œå®ƒæ˜¯ Rust ä¸­æœ€åŸºæœ¬çš„åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„æ–¹å¼ï¼Œç»å¤§å¤šæ•°å…¶å®ƒåŒ…å«å †å†… å­˜åˆ†é…çš„æ•°æ®ç±»å‹ï¼Œå†…éƒ¨éƒ½æ˜¯é€šè¿‡ Box<T> å®Œæˆçš„ï¼Œæ¯”å¦‚ Vec<T>ã€‚</p>
<p>ä¸ºä»€ä¹ˆæœ‰ Box<T> çš„è®¾è®¡ï¼Œæˆ‘ä»¬å¾—å…ˆå›å¿†ä¸€ä¸‹åœ¨ C è¯­è¨€ä¸­ï¼Œå †å†…å­˜æ˜¯æ€ä¹ˆåˆ†é…çš„ã€‚</p>
<ol>
<li>
<p>C éœ€è¦ä½¿ç”¨ malloc/calloc/realloc/free æ¥å¤„ç†å†…å­˜çš„åˆ†é…ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¢«åˆ†é…å‡ºæ¥çš„å†…å­˜ åœ¨å‡½æ•°è°ƒç”¨ä¸­æ¥æ¥å›å›ä½¿ç”¨ï¼Œå¯¼è‡´è°åº”è¯¥è´Ÿè´£é‡Šæ”¾è¿™ä»¶äº‹æƒ…å¾ˆéš¾ç¡®å®šï¼Œç»™å¼€å‘è€…é€ æˆäº†æ å¤§çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</p>
</li>
<li>
<p>C++ åœ¨æ­¤åŸºç¡€ä¸Šæ”¹è¿›äº†ä¸€ä¸‹ï¼Œæä¾›äº†ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ î›¼ unique_ptrï¼Œå¯ä»¥åœ¨æŒ‡é’ˆé€€å‡ºä½œç”¨ åŸŸçš„æ—¶å€™é‡Šæ”¾å †å†…å­˜ï¼Œè¿™æ ·ä¿è¯äº†å †å†…å­˜çš„å•ä¸€æ‰€æœ‰æƒã€‚è¿™ä¸ª unique_ptr å°±æ˜¯ Rust çš„ Box<T> çš„å‰èº«ã€‚</p>
</li>
</ol>
<hr />
<p><a href="https://doc.rust-lang.org/src/core/ptr/unique.rs.html#36-44">Box<T> çš„å®šä¹‰</a>é‡Œï¼Œå†…éƒ¨å°±æ˜¯ä¸€ä¸ª Unique<T> ç”¨äºè‡´æ•¬ C++ï¼ŒUnique<T> æ˜¯
ä¸€ä¸ªç§æœ‰çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå®ƒåŒ…è£¹äº†ä¸€ä¸ª *const T æŒ‡é’ˆï¼Œå¹¶å”¯ä¸€æ‹¥æœ‰è¿™ä¸ª æŒ‡é’ˆã€‚</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Unique&lt;T: ?Sized&gt; {
    pointer: *const T,
    // NOTE: this marker has no consequences for variance, but is necessary
    // for dropck to understand that we logically own a `T`.
    //
    // For details, see:
    // https://github.com/rust-lang/rfcs/blob/master/text/0769-sound-generic-drop.md#phantom-data
    _marker: PhantomData&lt;T&gt;,
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-å †ä¸Šåˆ†é…å†…å­˜çš„-box-å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•°-a" class="admonition info">
<summary class="admonition-title">
<p>å †ä¸Šåˆ†é…å†…å­˜çš„ Box<T> å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•° A</p>
<p><a class="admonition-anchor-link" href="#admonition-å †ä¸Šåˆ†é…å†…å­˜çš„-box-å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•°-a"></a></p>
</summary>
<div>
<p>è®¾è®¡å†…å­˜åˆ†é…å™¨çš„ç›®çš„é™¤äº†ä¿è¯æ­£ç¡®æ€§ä¹‹å¤–ï¼Œå°±æ˜¯ä¸ºäº†æœ‰æ•ˆåœ°åˆ©ç”¨å‰©ä½™å†…å­˜ï¼Œå¹¶æ§åˆ¶å†…å­˜ åœ¨åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¢ç‰‡çš„æ•°é‡ã€‚
åœ¨å¤šæ ¸ç¯å¢ƒä¸‹ï¼Œå®ƒè¿˜è¦èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¹¶å‘è¯· æ±‚ã€‚ï¼ˆå¦‚æœä½ å¯¹é€šç”¨å†…å­˜åˆ†é…å™¨æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹å‚è€ƒèµ„æ–™ï¼‰ å †ä¸Šåˆ†é…å†…å­˜çš„ Box<T></p>
<p>å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•° Aï¼Œå°±éœ€è¦æ»¡è¶³ <a href="https://doc.rust-lang.org/std/alloc/trait.Allocator.html">Allocator trait</a>ï¼Œ å¹¶ä¸”é»˜è®¤æ˜¯ Globalï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>pub struct Box&lt;T: ?Sized, A: Allocator = Global&gt;(Unique&lt;T&gt;, A);
<span class="boring">}
</span></code></pre></pre>
<hr />
<p>Allocator trait æä¾›å¾ˆå¤šæ–¹æ³•ï¼š</p>
<ol>
<li>
<p>allocate æ˜¯ä¸»è¦æ–¹æ³•ï¼Œç”¨äºåˆ†é…å†…å­˜ï¼Œå¯¹åº” C çš„ malloc/callocï¼›</p>
</li>
<li>
<p>deallocateï¼Œç”¨äºé‡Šæ”¾å†…å­˜ï¼Œå¯¹åº” C çš„ freeï¼›</p>
</li>
<li>
<p>è¿˜æœ‰ grow / shrinkï¼Œç”¨æ¥æ‰©å¤§æˆ–ç¼©å°å †ä¸Šå·²åˆ†é…çš„å†…å­˜ï¼Œå¯¹åº” C çš„ reallocã€‚</p>
</li>
</ol>
</div>
</details>
<details id="admonition-æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨" class="admonition info">
<summary class="admonition-title">
<p>æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨</p>
<p><a class="admonition-anchor-link" href="#admonition-æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨"></a></p>
</summary>
<div>
<p>å¦‚æœä½ æƒ³æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨ï¼Œå¯ä»¥ä½¿ç”¨ #[global_allocator] æ ‡è®°å®ï¼Œå®šä¹‰ä½ è‡ªå·±çš„å…¨å±€åˆ†é…å™¨ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨ Rust
ä¸‹ä½¿ç”¨<a href="https://crates.io/crates/jemallocator">jemalloc</a>:</p>
<pre><pre class="playground"><code class="language-rust">
use jemallocator::Jemalloc;

#[global_allocator]
static GLOBAL: Jemalloc = Jemalloc;

fn main() {}
</code></pre></pre>
</div>
</details>
<h3 id="å®ç°å†…å­˜åˆ†é…å™¨"><a class="header" href="#å®ç°å†…å­˜åˆ†é…å™¨">å®ç°å†…å­˜åˆ†é…å™¨</a></h3>
<details id="admonition-å†…å­˜åˆ†é…å™¨" class="admonition info">
<summary class="admonition-title">
<p>å†…å­˜åˆ†é…å™¨</p>
<p><a class="admonition-anchor-link" href="#admonition-å†…å­˜åˆ†é…å™¨"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::alloc::{GlobalAlloc, Layout, System};

struct MyAllocator;

unsafe impl GlobalAlloc for MyAllocator {
    unsafe fn alloc(&amp;self, layout: Layout) -&gt; *mut u8 {
        let data = System.alloc(layout);
        eprintln!(&quot;ALLOC: {:p}, size {}&quot;, data, layout.size());
        data
    }

    unsafe fn dealloc(&amp;self, ptr: *mut u8, layout: Layout) {
        System.dealloc(ptr, layout);
        eprintln!(&quot;FREE: {:p}, size {}&quot;, ptr, layout.size());
    }
}

#[global_allocator]
static GLOBAL: MyAllocator = MyAllocator;

#[allow(dead_code)]
struct Matrix {
    // ä½¿ç”¨ä¸è§„åˆ™çš„æ•°å­—å¦‚ 505 å¯ä»¥è®© dbg! çš„æ‰“å°å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºæ¥
    data: [u8; 505],
}

impl Default for Matrix {
    fn default() -&gt; Self {
        Self { data: [0; 505] }
    }
}

fn main() {
    // åœ¨è¿™å¥æ‰§è¡Œä¹‹å‰å·²ç»æœ‰ä¸€äº›å†…å­˜åˆ†é…å’Œé‡Šæ”¾
    let data = Box::new(Matrix::default());
    println!(
        &quot;!!! allocated memory: {:p}, len: {}&quot;,
        &amp;*data,
        std::mem::size_of::&lt;Matrix&gt;()
    );

    // data åœ¨è¿™é‡Œ dropï¼Œå¯ä»¥åœ¨æ‰“å°ä¸­çœ‹åˆ° FREE
    // ä¹‹åè¿˜æœ‰å¾ˆå¤šå…¶å®ƒå†…å­˜è¢«é‡Šæ”¾
}
</code></pre></pre>
<hr />
<ol>
<li>è¿™é‡Œ MyAllocator å°±ç”¨ System allocatorï¼Œç„¶ååŠ  eprintln!()ï¼Œå’Œæˆ‘ ä»¬å¸¸ç”¨çš„ println!() ä¸åŒçš„æ˜¯ï¼Œeprintln!() å°†æ•°æ®æ‰“å°åˆ° stderr</li>
<li>æ³¨æ„è¿™é‡Œä¸èƒ½ä½¿ç”¨ println!() ã€‚å› ä¸º stdout ä¼šæ‰“å°åˆ°ä¸€ä¸ªç”± Mutex äº’æ–¥é”ä¿æŠ¤çš„å…±äº«å…¨ å±€ buffer ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠå†…å­˜çš„åˆ†é…ï¼Œåˆ†é…çš„å†…å­˜åˆä¼šè§¦å‘ println!()ï¼Œæœ€ç»ˆé€ æˆ ç¨‹åºå´©æºƒã€‚è€Œ
eprintln! ç›´æ¥æ‰“å°åˆ° stderrï¼Œä¸ä¼š bufferã€‚</li>
<li>åœ¨ä½¿ç”¨ Box åˆ†é…å †å†…å­˜çš„æ—¶å€™è¦æ³¨æ„ï¼ŒBox::new() æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ä¼ å…¥å®ƒçš„æ•°æ®ä¼šå‡ºç° åœ¨æ ˆä¸Šï¼Œå†ç§»åŠ¨åˆ°å †ä¸Šã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬çš„ Matrix ç»“æ„ä¸æ˜¯ 505 ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¤§ çš„ç»“æ„ï¼Œå°±æœ‰å¯èƒ½å‡ºé—®é¢˜ã€‚</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">// #![feature(dropck_eyepatch)]

// struct MyBox&lt;T&gt;(Box&lt;T&gt;);

// unsafe impl&lt;#[may_dangle] T&gt; Drop for MyBox&lt;T&gt; {
//     fn drop(&amp;mut self) {
//         todo!();
//     }
// }

fn main() {
    // åœ¨å †ä¸Šåˆ†é… 16M å†…å­˜ï¼Œä½†å®ƒä¼šç°åœ¨æ ˆä¸Šå‡ºç°ï¼Œå†ç§»åŠ¨åˆ°å †ä¸Š
    let boxed = Box::new([0u8; 1 &lt;&lt; 24]);
    println!(&quot;len: {}&quot;, boxed.len());
}
</code></pre></pre>
<ul>
<li><code>cargo run --bin box</code>æˆ–è€…åœ¨ playground é‡Œè¿è¡Œï¼Œç›´æ¥æ ˆæº¢å‡º stack overflow</li>
<li>æœ¬åœ°ä½¿ç”¨ â€œcargo run â€“bin box â€”releaseâ€ ç¼–è¯‘æˆ release ä»£ç è¿è¡Œï¼Œä¼šæ­£å¸¸æ‰§è¡Œï¼</li>
</ul>
<blockquote>
<p>è¿™æ˜¯å› ä¸º â€œcargo runâ€ æˆ–è€…åœ¨ playground ä¸‹è¿è¡Œï¼Œé»˜è®¤æ˜¯ debug buildï¼Œå®ƒä¸ä¼šåšä»» ä½• inline çš„ä¼˜åŒ–ï¼Œè€Œ Box::new() çš„å®ç°å°±ä¸€è¡Œä»£ç ï¼Œå¹¶æ³¨æ˜äº†è¦ inlineï¼Œåœ¨ release æ¨¡å¼
ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨ä¼šè¢«ä¼˜åŒ–æ‰, æœ¬è´¨æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨ä¸‹åˆ—æ–¹å¼:</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>#[cfg(not(no_global_oom_handling))]
#[inline(always)]
#[doc(alias = &quot;alloc&quot;)]
#[doc(alias = &quot;malloc&quot;)]
#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
pub fn new(x: T) -&gt; Self {
    box x
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>è¿™é‡Œçš„å…³é”®å­— boxæ˜¯ Rust å†…éƒ¨çš„å…³é”®å­—ï¼Œç”¨æˆ·ä»£ç æ— æ³•è°ƒç”¨ï¼Œå®ƒåªå‡ºç°åœ¨ Rust ä»£ç ä¸­ï¼Œç”¨äºåˆ†é…å †å†…å­˜ï¼Œbox å…³é”®å­—åœ¨ç¼–è¯‘æ—¶ï¼Œä¼šä½¿ç”¨å†…å­˜åˆ†é…å™¨ åˆ†é…å†…å­˜ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="å†…å­˜å¦‚ä½•é‡Šæ”¾"><a class="header" href="#å†…å­˜å¦‚ä½•é‡Šæ”¾">å†…å­˜å¦‚ä½•é‡Šæ”¾</a></h3>
<details id="admonition-boxé»˜è®¤å®ç°çš„drop-trait" class="admonition info">
<summary class="admonition-title">
<p>Box<T>é»˜è®¤å®ç°çš„Drop trait</p>
<p><a class="admonition-anchor-link" href="#admonition-boxé»˜è®¤å®ç°çš„drop-trait"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
unsafe impl&lt;#[may_dangle] T: ?Sized, A: Allocator&gt; Drop for Box&lt;T, A&gt; {
    fn drop(&amp;mut self) {
        // FIXME: Do nothing, drop is currently performed by compiler.
    }
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-å…ˆç¨³å®šæ¥å£å†è¿­ä»£ç¨³å®šå®ç°" class="admonition info">
<summary class="admonition-title">
<p>å…ˆç¨³å®šæ¥å£ï¼Œå†è¿­ä»£ç¨³å®šå®ç°</p>
<p><a class="admonition-anchor-link" href="#admonition-å…ˆç¨³å®šæ¥å£å†è¿­ä»£ç¨³å®šå®ç°"></a></p>
</summary>
<div>
<p>ç›®å‰ drop trait ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥ deallocate çš„ä»£ç ã€‚è¿™æ˜¯ Rust è¯­ è¨€çš„ä¸€ç§ç­–ç•¥ï¼šåœ¨å…·ä½“å®ç°è¿˜æ²¡æœ‰ç¨³å®šä¸‹æ¥ä¹‹å‰ï¼Œæˆ‘å…ˆæŠŠæ¥å£ç¨³å®šï¼Œå®ç°éšç€ä¹‹åçš„è¿­ä»£ æ…¢æ…¢ç¨³å®šã€‚</p>
</div>
</details>
<h2 id="cowa-b-å†™æ—¶æ‹·è´"><a class="header" href="#cowa-b-å†™æ—¶æ‹·è´">Cow&lt;â€™a, B&gt;ï¼š å†™æ—¶æ‹·è´</a></h2>
<div id="admonition-å†™æ—¶å¤åˆ¶copy-on-writeæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™" class="admonition info">
<div class="admonition-title">
<p>å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-writeï¼‰æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™</p>
<p><a class="admonition-anchor-link" href="#admonition-å†™æ—¶å¤åˆ¶copy-on-writeæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™"></a></p>
</div>
<div>
<p>Cow æ˜¯ Rust ä¸‹ç”¨äºæä¾›å†™æ—¶å…‹éš†ï¼ˆClone-on-Writeï¼‰çš„ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒè·Ÿè™šæ‹Ÿå†…å­˜ç®¡ ç†çš„å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-writeï¼‰æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼š</p>
<blockquote>
<p>åŒ…è£¹ä¸€ä¸ªåªè¯»å€Ÿç”¨ï¼Œä½†å¦‚æœè°ƒç”¨è€…éœ€ è¦æ‰€æœ‰æƒæˆ–è€…éœ€è¦ä¿®æ”¹å†…å®¹ï¼Œé‚£ä¹ˆå®ƒä¼š clone å€Ÿç”¨çš„æ•°æ®</p>
</blockquote>
</div>
</div>
<h3 id="å®šä¹‰"><a class="header" href="#å®šä¹‰">å®šä¹‰</a></h3>
<div id="admonition-cowå®šä¹‰" class="admonition info">
<div class="admonition-title">
<p>Cowå®šä¹‰</p>
<p><a class="admonition-anchor-link" href="#admonition-cowå®šä¹‰"></a></p>
</div>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>pub enum Cow&lt;'a, B&gt; where B: 'a + ToOwned + ?Sized {
    Borrowed(&amp;'a B),
    Owned(&lt;B as ToOwned&gt;::Owned),
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>å®ƒæ˜¯ä¸€ä¸ª enumï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªå¯¹ç±»å‹ B çš„åªè¯»å¼•ç”¨ï¼Œæˆ–è€…åŒ…å«å¯¹ç±»å‹ B çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„ æ•°æ®ã€‚</p>
</blockquote>
</div>
</div>
<h3 id="ä¸¤ä¸ªtraittoownedborrowed"><a class="header" href="#ä¸¤ä¸ªtraittoownedborrowed">ä¸¤ä¸ªtraitï¼šToOwnedã€Borrowed</a></h3>
<div id="admonition-cowå®šä¹‰ç”¨åˆ°ä¸¤ä¸ªtraittoownedå’Œborrowed" class="admonition info">
<div class="admonition-title">
<p>Cowå®šä¹‰ç”¨åˆ°ä¸¤ä¸ªtraitï¼šToOwnedå’ŒBorrowed</p>
<p><a class="admonition-anchor-link" href="#admonition-cowå®šä¹‰ç”¨åˆ°ä¸¤ä¸ªtraittoownedå’Œborrowed"></a></p>
</div>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>pub trait ToOwned {
    type Owned: Borrow&lt;Self&gt;;
    #[must_use = &quot;cloning is often expensive and is not expected to have side effects&quot;]
    fn to_owned(&amp;self) -&gt; Self::Owned;

    fn clone_into(&amp;self, target: &amp;mut Self::Owned) { ... }
}

pub trait Borrow&lt;Borrowed&gt; where Borrowed: ?Sized {
    fn borrow(&amp;self) -&gt; &amp;Borrowed;
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>å®ƒæ˜¯ä¸€ä¸ª enumï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªå¯¹ç±»å‹ B çš„åªè¯»å¼•ç”¨ï¼Œæˆ–è€…åŒ…å«å¯¹ç±»å‹ B çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„ æ•°æ®ã€‚</p>
</blockquote>
</div>
</div>
<h3 id="toowned"><a class="header" href="#toowned">ToOwned</a></h3>
<div id="admonition-type-owned-borrow" class="admonition info">
<div class="admonition-title">
<p>type Owned: Borrow<Self></p>
<p><a class="admonition-anchor-link" href="#admonition-type-owned-borrow"></a></p>
</div>
<div>
<ol>
<li>é¦–å…ˆï¼Œtype Owned: Borrow<Self> æ˜¯ä¸€ä¸ªå¸¦æœ‰å…³è”ç±»å‹çš„ trait. è¿™é‡Œ Owned æ˜¯å…³è”ç±»å‹ï¼Œéœ€è¦ä½¿ç”¨è€…å®šä¹‰.</li>
<li>è¿™é‡Œ Owned ä¸èƒ½æ˜¯ä»»æ„ç±»å‹ï¼Œå®ƒå¿…é¡»æ»¡è¶³ Borrow<T> trait</li>
<li><a href="https://doc.rust-lang.org/src/alloc/str.rs.html#215-227">å‚è€ƒstrå¯¹ToOwned traitçš„å®ç°</a>ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>impl ToOwned for str {
    type Owned = String;
    #[inline]
    fn to_owned(&amp;self) -&gt; String {
        unsafe { String::from_utf8_unchecked(self.as_bytes().to_owned()) }
    }

    fn clone_into(&amp;self, target: &amp;mut String) {
        let mut b = mem::take(target).into_bytes();
        self.as_bytes().clone_into(&amp;mut b);
        *target = unsafe { String::from_utf8_unchecked(b) }
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol start="4">
<li>å¯ä»¥çœ‹åˆ°å…³è”ç±»å‹ Owned è¢«å®šä¹‰ä¸º Stringï¼Œè€Œæ ¹æ®è¦æ±‚ï¼ŒString å¿…é¡»å®šä¹‰ Borrowï¼Œé‚£è¿™é‡Œ Borrow é‡Œçš„æ³›å‹å˜é‡ T æ˜¯è°å‘¢ï¼Ÿ</li>
<li>ToOwned è¦æ±‚æ˜¯ Borrowï¼Œè€Œæ­¤åˆ»å®ç° ToOwned çš„ä¸»ä½“æ˜¯ strï¼Œæ‰€ä»¥ Borrow æ˜¯ Borrowï¼Œä¹Ÿå°±æ˜¯è¯´ String è¦å®ç° Borrow</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>impl Borrow&lt;str&gt; for String {
    #[inline]
    fn borrow(&amp;self) -&gt; &amp;str {
        &amp;self[..]
    }
}
<span class="boring">}
</span></code></pre></pre>
</div>
</div>
<div id="admonition-cow-å’Œ-toowned--borrow-ä¹‹é—´çš„å…³ç³»ç¤ºæ„å›¾" class="admonition info">
<div class="admonition-title">
<p>Cow å’Œ ToOwned / Borrow<T> ä¹‹é—´çš„å…³ç³»ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="#admonition-cow-å’Œ-toowned--borrow-ä¹‹é—´çš„å…³ç³»ç¤ºæ„å›¾"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/15%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BF%99%E4%BA%9B%E6%B5%93%E7%9C%89%E5%A4%A7%E7%9C%BC%E7%9A%84%E7%BB%93%E6%9E%84%E7%AB%9F%E7%84%B6%E9%83%BD%E6%98%AF%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9F-4781304.jpg" alt="type Owned: Borrow&lt;Self&gt; " /></p>
</div>
</div>
<h3 id="åŒ¹é…åˆ†å‘"><a class="header" href="#åŒ¹é…åˆ†å‘">åŒ¹é…åˆ†å‘</a></h3>
<div id="admonition-ä¸ºä½•-borrow-è¦å®šä¹‰æˆä¸€ä¸ªæ³›å‹-trait-å‘¢" class="admonition info">
<div class="admonition-title">
<p>ä¸ºä½• Borrow è¦å®šä¹‰æˆä¸€ä¸ªæ³›å‹ trait å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸ºä½•-borrow-è¦å®šä¹‰æˆä¸€ä¸ªæ³›å‹-trait-å‘¢"></a></p>
</div>
<div>
<ol>
<li>ä¾‹å­1ï¼šStringä¸åŒå€Ÿç”¨æ–¹å¼</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use std::borrow::Borrow;

fn main() {
    let s = &quot;hello world!&quot;.to_owned();

    // è¿™é‡Œå¿…é¡»å£°æ˜ç±»å‹ï¼Œå› ä¸º String æœ‰å¤šä¸ª Borrow&lt;T&gt; å®ç°
    // å€Ÿç”¨ä¸º &amp;String
    let r1: &amp;String = s.borrow();
    // å€Ÿç”¨ä¸º &amp;str
    let r2: &amp;str = s.borrow();

    println!(&quot;r1: {:p}, r2: {:p}&quot;, r1, r2);
}
</code></pre></pre>
<blockquote>
<p>String å¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;Stringï¼Œä¹Ÿå¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;str</p>
</blockquote>
<hr />
<ol start="2">
<li>ä¾‹å­2ï¼šCowä¸åŒè§£å¼•ç”¨æ–¹å¼</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>impl&lt;B: ?Sized + ToOwned&gt; Deref for Cow&lt;'_, B&gt; {
    type Target = B;

    fn deref(&amp;self) -&gt; &amp;B {
        match *self {
            Borrowed(borrowed) =&gt; borrowed,
            Owned(ref owned) =&gt; owned.borrow(),
        }
    }
}

<span class="boring">}
</span></code></pre></pre>
<hr />
<p>å®ç°çš„åŸç†å¾ˆç®€å•ï¼Œæ ¹æ® self æ˜¯ Borrowed è¿˜æ˜¯ Ownedï¼Œæˆ‘ä»¬åˆ†åˆ«å–å…¶å†…å®¹ï¼Œç”Ÿæˆå¼• ç”¨ï¼š</p>
<ol>
<li>
<p>å¯¹äº Borrowedï¼Œç›´æ¥å°±æ˜¯å¼•ç”¨ï¼›</p>
</li>
<li>
<p>å¯¹äº Ownedï¼Œè°ƒç”¨å…¶ borrow() æ–¹æ³•ï¼Œè·å¾—å¼•ç”¨ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="admonition-åŒ¹é…åˆ†å‘ä½¿ç”¨matchåŒ¹é…å®ç°é™æ€åŠ¨æ€åˆ†å‘ä¹‹å¤–çš„ç¬¬ä¸‰ç§åˆ†å‘" class="admonition info">
<div class="admonition-title">
<p>åŒ¹é…åˆ†å‘ï¼šä½¿ç”¨matchåŒ¹é…å®ç°é™æ€ã€åŠ¨æ€åˆ†å‘ä¹‹å¤–çš„ç¬¬ä¸‰ç§åˆ†å‘</p>
<p><a class="admonition-anchor-link" href="#admonition-åŒ¹é…åˆ†å‘ä½¿ç”¨matchåŒ¹é…å®ç°é™æ€åŠ¨æ€åˆ†å‘ä¹‹å¤–çš„ç¬¬ä¸‰ç§åˆ†å‘"></a></p>
</div>
<div>
<p>è™½ç„¶ Cow æ˜¯ä¸€ä¸ª enumï¼Œä½†æ˜¯é€šè¿‡ Deref çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ç»Ÿä¸€çš„ ä½“éªŒ.
æ¯”å¦‚ Cow<str>ï¼Œä½¿ç”¨çš„æ„Ÿè§‰å’Œ &amp;str / String æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚
æ³¨æ„ï¼Œè¿™ç§æ ¹æ® enum çš„ä¸åŒçŠ¶æ€æ¥è¿›è¡Œç»Ÿä¸€åˆ†å‘çš„æ–¹æ³•æ˜¯ç¬¬ä¸‰ç§åˆ†å‘æ‰‹æ®µï¼Œå¦å¤–è¿˜å¯ä»¥ä½¿ç”¨æ³›å‹å‚æ•° åšé™æ€åˆ†å‘å’Œä½¿ç”¨ trait object åšåŠ¨æ€åˆ†å‘</p>
</div>
</div>
<h3 id="cowåœ¨éœ€è¦æ—¶æ‰è¿›è¡Œå†…å­˜åˆ†é…æ‹·è´"><a class="header" href="#cowåœ¨éœ€è¦æ—¶æ‰è¿›è¡Œå†…å­˜åˆ†é…æ‹·è´">Cowåœ¨éœ€è¦æ—¶æ‰è¿›è¡Œå†…å­˜åˆ†é…æ‹·è´</a></h3>
<div id="admonition-å†™æ—¶æ‹·è´" class="admonition info">
<div class="admonition-title">
<p>å†™æ—¶æ‹·è´</p>
<p><a class="admonition-anchor-link" href="#admonition-å†™æ—¶æ‹·è´"></a></p>
</div>
<div>
<p>é‚£ä¹ˆ Cow æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p>
<ol>
<li>æ˜¾ç„¶ï¼Œå®ƒå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™æ‰è¿›è¡Œå†…å­˜çš„åˆ†é…å’Œæ‹·è´ï¼Œåœ¨å¾ˆå¤šåº”ç”¨ åœºåˆï¼Œå®ƒå¯ä»¥å¤§å¤§æå‡ç³»ç»Ÿçš„æ•ˆç‡ã€‚</li>
<li>å¦‚æœ Cow&lt;â€™a, B&gt; ä¸­çš„ Owned æ•°æ®ç±»å‹æ˜¯ä¸€ä¸ªéœ€è¦ åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„ç±»å‹ï¼Œå¦‚ Stringã€Vec<T> ç­‰ï¼Œè¿˜èƒ½å‡å°‘å †å†…å­˜åˆ†é…çš„æ¬¡æ•°ã€‚ </li>
<li>ç›¸å¯¹äºæ ˆå†…å­˜çš„åˆ†é…é‡Šæ”¾æ¥è¯´ï¼Œå †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æ•ˆç‡è¦ä½å¾ˆå¤šï¼Œå…¶å†…éƒ¨è¿˜ æ¶‰åŠç³»ç»Ÿè°ƒç”¨å’Œé”ï¼Œå‡å°‘ä¸å¿…è¦çš„å †å†…å­˜åˆ†é…æ˜¯æå‡ç³»ç»Ÿæ•ˆç‡çš„å…³é”®æ‰‹æ®µã€‚</li>
<li>è€Œ Rust çš„ Cow&lt;â€™a, B&gt;ï¼Œåœ¨å¸®åŠ©ä½ è¾¾æˆè¿™ä¸ªæ•ˆæœçš„åŒæ—¶ï¼Œä½¿ç”¨ä½“éªŒè¿˜éå¸¸ç®€å•èˆ’æœã€‚</li>
</ol>
</div>
</div>
<details id="admonition-ä¸¾ä¾‹ä½¿ç”¨cowè¿›è¡Œurlè§£æ" class="admonition info">
<summary class="admonition-title">
<p>ä¸¾ä¾‹ä½¿ç”¨Cowè¿›è¡ŒURLè§£æ</p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸¾ä¾‹ä½¿ç”¨cowè¿›è¡Œurlè§£æ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::borrow::Cow;

use url::Url;
fn main() {
    let url = Url::parse(&quot;https://tyr.com/rust?page=1024&amp;sort=desc&amp;extra=hello%20world&quot;).unwrap();
    let mut pairs = url.query_pairs();

    assert_eq!(pairs.count(), 3);

    let (mut k, v) = pairs.next().unwrap();
    // å› ä¸º k, v éƒ½æ˜¯ Cow&lt;str&gt; ä»–ä»¬ç”¨èµ·æ¥æ„Ÿè§‰å’Œ &amp;str æˆ–è€… String ä¸€æ ·
    // æ­¤åˆ»ï¼Œä»–ä»¬éƒ½æ˜¯ Borrowed
    println!(&quot;key: {}, v: {}&quot;, k, v);
    // å½“ä¿®æ”¹å‘ç”Ÿæ—¶ï¼Œk å˜æˆ Owned
    k.to_mut().push_str(&quot;_lala&quot;);

    print_pairs((k, v));

    print_pairs(pairs.next().unwrap());
    print_pairs(pairs.next().unwrap());
}

fn print_pairs(pair: (Cow&lt;str&gt;, Cow&lt;str&gt;)) {
    println!(&quot;key: {}, value: {}&quot;, show_cow(pair.0), show_cow(pair.1));
}

fn show_cow(cow: Cow&lt;str&gt;) -&gt; String {
    match cow {
        Cow::Borrowed(v) =&gt; format!(&quot;Borrowed {}&quot;, v),
        Cow::Owned(v) =&gt; format!(&quot;Owned {}&quot;, v),
    }
}
</code></pre></pre>
<hr />
<blockquote>
<p>åœ¨è§£æ URL çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°† querystring ä¸­çš„å‚æ•°ï¼Œæå–æˆ KV pair æ¥è¿›ä¸€æ­¥ä½¿ ç”¨ã€‚
ç»å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œæå–å‡ºæ¥çš„ KV éƒ½æ˜¯æ–°çš„å­—ç¬¦ä¸²ï¼Œåœ¨æ¯ç§’é’Ÿå¤„ç†å‡ å k ç”šè‡³ä¸Šç™¾ k è¯·æ±‚çš„ç³»ç»Ÿä¸­ï¼Œä½ å¯ä»¥æƒ³è±¡è¿™ä¼šå¸¦æ¥å¤šå°‘æ¬¡å †å†…å­˜çš„åˆ†é…ã€‚ 
ä½†åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Cow ç±»å‹è½»æ¾é«˜æ•ˆå¤„ç†å®ƒï¼Œåœ¨è¯»å– URL çš„è¿‡ç¨‹ä¸­ï¼š</p>
</blockquote>
<ol>
<li>æ¯è§£æå‡ºä¸€ä¸ª key æˆ–è€… valueï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª &amp;str æŒ‡å‘ URL ä¸­ç›¸åº”çš„ä½ç½®ï¼Œç„¶åç”¨ Cow å°è£…å®ƒ </li>
<li>è€Œå½“è§£æå‡ºæ¥çš„å†…å®¹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ decode æ—¶ï¼Œæ¯”å¦‚ â€œhello%20worldâ€ï¼Œæˆ‘ä»¬ å¯ä»¥ç”Ÿæˆä¸€ä¸ªè§£æåçš„ Stringï¼ŒåŒæ ·ç”¨ Cow å°è£…å®ƒã€‚</li>
</ol>
</div>
</details>
<details id="admonition-ä¸¾ä¾‹serdeä½¿ç”¨cowè¿›è¡Œåºåˆ—åŒ–ååºåˆ—åŒ–" class="admonition info">
<summary class="admonition-title">
<p>ä¸¾ä¾‹serdeä½¿ç”¨Cowè¿›è¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–</p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸¾ä¾‹serdeä½¿ç”¨cowè¿›è¡Œåºåˆ—åŒ–ååºåˆ—åŒ–"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use serde::Deserialize;
use std::borrow::Cow;

#[allow(dead_code)]
#[derive(Debug, Deserialize)]
struct User&lt;'input&gt; {
    #[serde(borrow)]
    name: Cow&lt;'input, str&gt;,
    age: u8,
}

fn main() {
    let input = r#&quot;{ &quot;name&quot;: &quot;Tyr&quot;, &quot;age&quot;: 18 }&quot;#;
    let user: User = serde_json::from_str(input).unwrap();

    match user.name {
        Cow::Borrowed(x) =&gt; println!(&quot;borrowed {}&quot;, x),
        Cow::Owned(x) =&gt; println!(&quot;owned {}&quot;, x),
    }
}
</code></pre></pre>
</div>
</details>
<h2 id="mutexguard-æ•°æ®åŠ é”"><a class="header" href="#mutexguard-æ•°æ®åŠ é”">MutexGuard<T>ï¼š æ•°æ®åŠ é”</a></h2>
<h3 id="mutexguardä¸stringboxcowa-bçš„å¯¹æ¯”"><a class="header" href="#mutexguardä¸stringboxcowa-bçš„å¯¹æ¯”">MutexGuardä¸Stringã€Box<T>ã€Cow&lt;â€™a, B&gt;çš„å¯¹æ¯”</a></h3>
<details id="admonition-derefdrop" class="admonition info">
<summary class="admonition-title">
<p>Deref+Drop</p>
<p><a class="admonition-anchor-link" href="#admonition-derefdrop"></a></p>
</summary>
<div>
<p>Stringã€Box<T>ã€Cow&lt;â€™a, B&gt; ç­‰æ™ºèƒ½æŒ‡é’ˆï¼Œéƒ½æ˜¯é€šè¿‡ Deref æ¥æ ä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œ 
MutexGuard<T> æ˜¯å¦å¤–ä¸€ç±»å¾ˆæœ‰æ„æ€çš„æ™ºèƒ½æŒ‡é’ˆï¼š</p>
<ol>
<li>å®ƒä¸ä½†é€šè¿‡ Deref æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ</li>
<li>è¿˜é€šè¿‡ Drop trait æ¥ç¡®ä¿ï¼Œä½¿ç”¨åˆ°çš„å†…å­˜ä»¥å¤–çš„èµ„æºåœ¨é€€å‡º æ—¶è¿›è¡Œé‡Šæ”¾ã€‚</li>
</ol>
</div>
</details>
<h3 id="ä½¿ç”¨mutexlockè·å–"><a class="header" href="#ä½¿ç”¨mutexlockè·å–">ä½¿ç”¨Mutex::lockè·å–</a></h3>
<details id="admonition-mutexguardè¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨-mutexlock-æ—¶ç”Ÿæˆçš„" class="admonition info">
<summary class="admonition-title">
<p>MutexGuardè¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨ Mutex::lock æ—¶ç”Ÿæˆçš„</p>
<p><a class="admonition-anchor-link" href="#admonition-mutexguardè¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨-mutexlock-æ—¶ç”Ÿæˆçš„"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn lock(&amp;self) -&gt; LockResult&lt;MutexGuard&lt;'_, T&gt;&gt; {
    unsafe {
        self.inner.raw_lock();
        MutexGuard::new(self)
    }
}
</code></pre></pre>
<hr />
<p><a href="https://doc.rust-lang.org/src/std/sync/mutex.rs.html#279-284">rustæ–‡æ¡£</a></p>
<ol>
<li>é¦–å…ˆï¼Œå®ƒä¼šå–å¾—é”èµ„æºï¼Œå¦‚æœæ‹¿ä¸åˆ°ï¼Œä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼›</li>
<li>å¦‚æœæ‹¿åˆ°äº†ï¼Œä¼šæŠŠ Mutex ç»“æ„çš„å¼• ç”¨ä¼ é€’ç»™ MutexGuardã€‚</li>
</ol>
</div>
</details>
<h3 id="å®šä¹‰ä¸derefdrop-traitå®ç°"><a class="header" href="#å®šä¹‰ä¸derefdrop-traitå®ç°">å®šä¹‰ä¸Derefã€Drop traitå®ç°</a></h3>
<details id="admonition-mutexguard-çš„å®šä¹‰ä»¥åŠå®ƒçš„-deref-å’Œ-drop-çš„å®ç°" class="admonition info">
<summary class="admonition-title">
<p>MutexGuard çš„å®šä¹‰ä»¥åŠå®ƒçš„ Deref å’Œ Drop çš„å®ç°</p>
<p><a class="admonition-anchor-link" href="#admonition-mutexguard-çš„å®šä¹‰ä»¥åŠå®ƒçš„-deref-å’Œ-drop-çš„å®ç°"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// è¿™é‡Œç”¨ must_useï¼Œå½“ä½ å¾—åˆ°äº†å´ä¸ä½¿ç”¨ MutexGuard æ—¶ä¼šæŠ¥è­¦
#[must_use = &quot;if unused the Mutex will immediately unlock&quot;]
pub struct MutexGuard&lt;'a, T: ?Sized + 'a&gt; {
    lock: &amp;'a Mutex&lt;T&gt;,
    poison: poison::Guard,
}

impl&lt;T: ?Sized&gt; Deref for MutexGuard&lt;'_, T&gt; {
    type Target = T;

    fn deref(&amp;self) -&gt; &amp;T {
        unsafe { &amp;*self.lock.data.get() }
    }
}

impl&lt;T: ?Sized&gt; DerefMut for MutexGuard&lt;'_, T&gt; {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut T {
        unsafe { &amp;mut *self.lock.data.get() }
    }
}

impl&lt;T: ?Sized&gt; Drop for MutexGuard&lt;'_, T&gt; {
    #[inline]
    fn drop(&amp;mut self) {
        unsafe {
            self.lock.poison.done(&amp;self.poison);
            self.lock.inner.raw_unlock();
        }
    }
}
</code></pre></pre>
<hr />
<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>å½“ MutexGuard ç»“æŸæ—¶ï¼ŒMutex ä¼šåš unlock</li>
<li>è¿™æ ·ç”¨æˆ·åœ¨ä½¿ç”¨ Mutex æ—¶ï¼Œå¯ä»¥ä¸å¿…å…³å¿ƒä½•æ—¶é‡Šæ”¾è¿™ä¸ªäº’æ–¥é”ã€‚</li>
<li>å› ä¸ºæ— è®ºä½ åœ¨è°ƒç”¨æ ˆä¸Šæ€æ ·ä¼ é€’ MutexGuard ï¼Œå“ªæ€•åœ¨é”™è¯¯å¤„ç†æµç¨‹ä¸Šæå‰é€€å‡ºï¼ŒRust æœ‰æ‰€æœ‰æƒæœºåˆ¶ï¼Œå¯ä»¥ç¡®ä¿åªè¦ MutexGuard ç¦»å¼€ä½œç”¨åŸŸï¼Œé”å°±ä¼šè¢«é‡Šæ”¾</li>
</ol>
</div>
</details>
<h3 id="ä½¿ç”¨mutex_mutexguardçš„ä¾‹å­"><a class="header" href="#ä½¿ç”¨mutex_mutexguardçš„ä¾‹å­">ä½¿ç”¨Mutex_MutexGuardçš„ä¾‹å­</a></h3>
<details id="admonition-mutex--mutexguard-example" class="admonition info">
<summary class="admonition-title">
<p>Mutex &amp; MutexGuard example</p>
<p><a class="admonition-anchor-link" href="#admonition-mutex--mutexguard-example"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use lazy_static::lazy_static;
use std::borrow::Cow;
use std::collections::HashMap;
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

// lazy_static å®å¯ä»¥ç”Ÿæˆå¤æ‚çš„ static å¯¹è±¡
lazy_static! {
    // ä¸€èˆ¬æƒ…å†µä¸‹ Mutex å’Œ Arc ä¸€èµ·åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æä¾›å¯¹å…±äº«å†…å­˜çš„ä½¿ç”¨
    // å¦‚æœä½ æŠŠ Mutex å£°æ˜æˆ staticï¼Œå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯é™æ€çš„ï¼Œä¸éœ€è¦ Arc
    static ref METRICS: Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt; =
        Mutex::new(HashMap::new());
}

fn main() {
    // ç”¨ Arc æ¥æä¾›å¹¶å‘ç¯å¢ƒä¸‹çš„å…±äº«æ‰€æœ‰æƒï¼ˆä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼‰
    let metrics: Arc&lt;Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt;&gt; =
        Arc::new(Mutex::new(HashMap::new()));
    for _ in 0..32 {
        let m = metrics.clone();
        thread::spawn(move || {
            let mut g = m.lock().unwrap();
            // æ­¤æ—¶åªæœ‰æ‹¿åˆ° MutexGuard çš„çº¿ç¨‹å¯ä»¥è®¿é—® HashMap
            let data = &amp;mut *g;
            // Cow å®ç°äº†å¾ˆå¤šæ•°æ®ç»“æ„çš„ From traitï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ &quot;hello&quot;.into() ç”Ÿæˆ Cow
            let entry = data.entry(&quot;hello&quot;.into()).or_insert(0);
            *entry += 1;
            // MutexGuard è¢« Dropï¼Œé”è¢«é‡Šæ”¾
        });
    }

    thread::sleep(Duration::from_millis(100));

    println!(&quot;metrics: {:?}&quot;, metrics.lock().unwrap());
}
</code></pre></pre>
<hr />
<blockquote>
<p>åœ¨è§£æ URL çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°† querystring ä¸­çš„å‚æ•°ï¼Œæå–æˆ KV pair æ¥è¿›ä¸€æ­¥ä½¿ ç”¨ã€‚
ç»å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œæå–å‡ºæ¥çš„ KV éƒ½æ˜¯æ–°çš„å­—ç¬¦ä¸²ï¼Œåœ¨æ¯ç§’é’Ÿå¤„ç†å‡ å k ç”šè‡³ä¸Šç™¾ k è¯·æ±‚çš„ç³»ç»Ÿä¸­ï¼Œä½ å¯ä»¥æƒ³è±¡è¿™ä¼šå¸¦æ¥å¤šå°‘æ¬¡å †å†…å­˜çš„åˆ†é…ã€‚ 
ä½†åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Cow ç±»å‹è½»æ¾é«˜æ•ˆå¤„ç†å®ƒï¼Œåœ¨è¯»å– URL çš„è¿‡ç¨‹ä¸­ï¼š</p>
</blockquote>
<ol>
<li>æ¯è§£æå‡ºä¸€ä¸ª key æˆ–è€… valueï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª &amp;str æŒ‡å‘ URL ä¸­ç›¸åº”çš„ä½ç½®ï¼Œç„¶åç”¨ Cow å°è£…å®ƒ </li>
<li>è€Œå½“è§£æå‡ºæ¥çš„å†…å®¹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ decode æ—¶ï¼Œæ¯”å¦‚ â€œhello%20worldâ€ï¼Œæˆ‘ä»¬ å¯ä»¥ç”Ÿæˆä¸€ä¸ªè§£æåçš„ Stringï¼ŒåŒæ ·ç”¨ Cow å°è£…å®ƒã€‚</li>
</ol>
</div>
</details>
<details id="admonition-ä½ å¯ä»¥æŠŠ-mutexguard-çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ä½†ä½ æ— æ³•æŠŠ-mutexguard-æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹" class="admonition info">
<summary class="admonition-title">
<p>ä½ å¯ä»¥æŠŠ MutexGuard çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä½†ä½ æ— æ³•æŠŠ MutexGuard æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½ å¯ä»¥æŠŠ-mutexguard-çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ä½†ä½ æ— æ³•æŠŠ-mutexguard-æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::sync::Mutex;

fn main() {
    //
    let m = Mutex::new(Mutex::new(1));
    let g = m.lock().unwrap();
    {
        rayon::join(
            || {
                let mut g1 = g.lock().unwrap();
                *g1 += 1;
                println!(&quot;Thread 1: {:?}&quot;, *g1);
            },
            || {
                let mut g1 = g.lock().unwrap();
                *g1 += 1;
                println!(&quot;Thread 1: {:?}&quot;, *g1);
            },
        );
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-mutexguard-çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”" class="admonition info">
<summary class="admonition-title">
<p>MutexGuard çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”</p>
<p><a class="admonition-anchor-link" href="#admonition-mutexguard-çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”"></a></p>
</summary>
<div>
<ul>
<li>r2d2ç±»ä¼¼å®ç°ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ï¼š<a href="https://github.com/sfackler/r2d2/blob/master/src/lib.rs#L611-L638">æºç </a></li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;M&gt; Drop for PooledConnection&lt;M&gt;
where
    M: ManageConnection,
{
    fn drop(&amp;mut self) {
        self.pool.put_back(self.checkout, self.conn.take().unwrap());
    }
}

impl&lt;M&gt; Deref for PooledConnection&lt;M&gt;
where
    M: ManageConnection,
{
    type Target = M::Connection;

    fn deref(&amp;self) -&gt; &amp;M::Connection {
        &amp;self.conn.as_ref().unwrap().conn
    }
}

impl&lt;M&gt; DerefMut for PooledConnection&lt;M&gt;
where
    M: ManageConnection,
{
    fn deref_mut(&amp;mut self) -&gt; &amp;mut M::Connection {
        &amp;mut self.conn.as_mut().unwrap().conn
    }
}
<span class="boring">}
</span></code></pre></pre>
<ul>
<li>ç±»ä¼¼ MutexGuard çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”ã€‚æ¯”å¦‚è¦åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ï¼Œä½ å¯ä»¥åœ¨ Drop trait ä¸­ï¼Œå›æ”¶ checkout å‡ºæ¥çš„è¿æ¥ï¼Œå°†å…¶å†æ”¾å›è¿æ¥æ± ã€‚</li>
</ul>
</div>
</details>
<h2 id="è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ">è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ</a></h2>
<details id="admonition-mystringç»“æ„ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>MyStringç»“æ„ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="#admonition-mystringç»“æ„ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/15%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BF%99%E4%BA%9B%E6%B5%93%E7%9C%89%E5%A4%A7%E7%9C%BC%E7%9A%84%E7%BB%93%E6%9E%84%E7%AB%9F%E7%84%B6%E9%83%BD%E6%98%AF%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9F-4783668.jpg" alt="MyString" /></p>
</div>
</details>
<details id="admonition-mystringå®ç°ä»£ç " class="admonition info">
<summary class="admonition-title">
<p>MyStringå®ç°ä»£ç </p>
<p><a class="admonition-anchor-link" href="#admonition-mystringå®ç°ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::{fmt, ops::Deref, str};

const MINI_STRING_MAX_LEN: usize = 30;

// MyString é‡Œï¼ŒString æœ‰ 3 ä¸ª wordï¼Œä¾› 24 å­—èŠ‚ï¼Œæ‰€ä»¥å®ƒä»¥ 8 å­—èŠ‚å¯¹é½
// æ‰€ä»¥ enum çš„ tag + padding æœ€å°‘ 8 å­—èŠ‚ï¼Œæ•´ä¸ªç»“æ„å  32 å­—èŠ‚ã€‚
// MiniString å¯ä»¥æœ€å¤šæœ‰ 30 å­—èŠ‚ï¼ˆå†åŠ ä¸Š 1 å­—èŠ‚é•¿åº¦å’Œ 1å­—èŠ‚ tagï¼‰ï¼Œå°±æ˜¯ 32 å­—èŠ‚.
struct MiniString {
    len: u8,
    data: [u8; MINI_STRING_MAX_LEN],
}

impl MiniString {
    // è¿™é‡Œ new æ¥å£ä¸æš´éœ²å‡ºå»ï¼Œä¿è¯ä¼ å…¥çš„ v çš„å­—èŠ‚é•¿åº¦å°äºç­‰äº 30
    fn new(v: impl AsRef&lt;str&gt;) -&gt; Self {
        let bytes = v.as_ref().as_bytes();
        // æˆ‘ä»¬åœ¨æ‹·è´å†…å®¹æ—¶ä¸€å®šè¦è¦ä½¿ç”¨å­—ç¬¦ä¸²çš„å­—èŠ‚é•¿åº¦
        let len = bytes.len();
        let mut data = [0u8; MINI_STRING_MAX_LEN];
        data[..len].copy_from_slice(bytes);
        Self {
            len: len as u8,
            data,
        }
    }
}

impl Deref for MiniString {
    type Target = str;

    fn deref(&amp;self) -&gt; &amp;Self::Target {
        // ç”±äºç”Ÿæˆ MiniString çš„æ¥å£æ˜¯éšè—çš„ï¼Œå®ƒåªèƒ½æ¥è‡ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¸‹é¢è¿™è¡Œæ˜¯å®‰å…¨çš„
        str::from_utf8(&amp;self.data[..self.len as usize]).unwrap()
        // ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ unsafe ç‰ˆæœ¬
        // unsafe { str::from_utf8_unchecked(&amp;self.data[..self.len as usize]) }
    }
}

impl fmt::Debug for MiniString {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        // è¿™é‡Œç”±äºå®ç°äº† Deref traitï¼Œå¯ä»¥ç›´æ¥å¾—åˆ°ä¸€ä¸ª &amp;str è¾“å‡º
        write!(f, &quot;{}&quot;, self.deref())
    }
}

#[derive(Debug)]
enum MyString {
    Inline(MiniString),
    Standard(String),
}

// å®ç° Deref æ¥å£å¯¹ä¸¤ç§ä¸åŒçš„åœºæ™¯ç»Ÿä¸€å¾—åˆ° &amp;str
impl Deref for MyString {
    type Target = str;

    fn deref(&amp;self) -&gt; &amp;Self::Target {
        match *self {
            MyString::Inline(ref v) =&gt; v.deref(),
            MyString::Standard(ref v) =&gt; v.deref(),
        }
    }
}

// impl From&lt;&amp;str&gt; for MyString {
//     fn from(s: &amp;str) -&gt; Self {
//         match s.len() &gt; MINI_STRING_MAX_LEN {
//             true =&gt; Self::Standard(s.to_owned()),
//             _ =&gt; Self::Inline(MiniString::new(s)),
//         }
//     }
// }

// impl From&lt;String&gt; for MyString {
//     fn from(s: String) -&gt; Self {
//         match s.len() &gt; MINI_STRING_MAX_LEN {
//             true =&gt; Self::Standard(s),
//             _ =&gt; Self::Inline(MiniString::new(s)),
//         }
//     }
// }

impl&lt;T&gt; From&lt;T&gt; for MyString
where
    T: AsRef&lt;str&gt;,
{
    fn from(s: T) -&gt; Self {
        match s.as_ref().len() &gt; MINI_STRING_MAX_LEN {
            true =&gt; Self::Standard(s.as_ref().to_owned()),
            _ =&gt; Self::Inline(MiniString::new(s)),
        }
    }
}

impl fmt::Display for MyString {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, &quot;{}&quot;, self.deref())
    }
}

impl MyString {
    pub fn push_str(&amp;mut self, s: &amp;str) {
        match *self {
            MyString::Inline(ref mut v) =&gt; {
                let len = v.len as usize;
                let len1 = s.len();
                if len + len1 &gt; MINI_STRING_MAX_LEN {
                    let mut owned = v.deref().to_string();
                    owned.push_str(s);
                    *self = MyString::Standard(owned);
                } else {
                    let total = len + len1;
                    v.data[len..len + len1].copy_from_slice(s.as_bytes());
                    v.len = total as u8;
                }
            }
            MyString::Standard(ref mut v) =&gt; v.push_str(s),
        }
    }
}

fn main() {
    let len1 = std::mem::size_of::&lt;MyString&gt;();
    let len2 = std::mem::size_of::&lt;MiniString&gt;();
    println!(&quot;Len: MyString {}, MiniString {}&quot;, len1, len2);

    let s1: MyString = &quot;hello world&quot;.into();
    let s2: MyString = &quot;è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²&quot;.into();

    // debug è¾“å‡º
    println!(&quot;s1: {:?}, s2: {:?}&quot;, s1, s2);
    // display è¾“å‡º
    println!(
        &quot;s1: {}({} bytes, {} chars), s2: {}({} bytes, {} chars)&quot;,
        s1,
        s1.len(),
        s1.chars().count(),
        s2,
        s2.len(),
        s2.chars().count()
    );

    // MyString å¯ä»¥ä½¿ç”¨ä¸€åˆ‡ &amp;str æ¥å£ï¼Œæ„Ÿè°¢ Rust çš„è‡ªåŠ¨ Deref
    assert!(s1.ends_with(&quot;world&quot;));
    assert!(s2.starts_with('è¿™'));

    let s = String::from(&quot;è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²&quot;);
    println!(&quot;s: {:p}&quot;, &amp;*s);
    // From&lt;T: AsRef&lt;str&gt;&gt; çš„å®ç°ä¼šå¯¼è‡´é¢å¤–çš„å¤åˆ¶
    let s3: MyString = s.into();
    println!(&quot;s3: {:p}&quot;, &amp;*s3);

    let mut s4: MyString = &quot;Hello Tyr! &quot;.into();
    println!(&quot;s4: {:?}&quot;, s4);
    s4.push_str(&quot;è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²&quot;);
    println!(&quot;s4: {:?}&quot;, s4);
}
</code></pre></pre>
<hr />
<p>ä¸ºäº†è®© MyString è¡¨ç°è¡Œä¸ºå’Œ &amp;str ä¸€è‡´:</p>
<ol>
<li>æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç° Deref trait è®© MyString å¯ä»¥è¢«è§£å¼•ç”¨æˆ &amp;strã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®ç° Debug/Display å’Œ From<T> traitï¼Œè®© MyString ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ã€‚</li>
<li>è¿™ä¸ªç®€å•å®ç°çš„ MyStringï¼Œä¸ç®¡å®ƒå†…éƒ¨çš„æ•°æ®æ˜¯çº¯æ ˆä¸Šçš„ MiniString ç‰ˆæœ¬ï¼Œè¿˜æ˜¯åŒ…å«å † ä¸Šå†…å­˜çš„ String ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„ä½“éªŒå’Œ &amp;str éƒ½ä¸€è‡´ï¼Œä»…ä»…ç‰ºç‰²äº†ä¸€ç‚¹ç‚¹æ•ˆç‡å’Œå†…å­˜ï¼Œå°±å¯
ä»¥è®©å°å®¹é‡çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨åœ¨æ ˆä¸Šå¹¶ä¸”è‡ªå¦‚åœ°ä½¿ç”¨ã€‚</li>
<li><a href="https://github.com/bodil/smartstring">smartstring</a> çš„ç¬¬ä¸‰æ–¹åº“å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Œè¿˜åšäº†ä¼˜åŒ–ã€‚</li>
</ol>
</div>
</details>
<h1 id="äºŒé›†åˆå®¹å™¨"><a class="header" href="#äºŒé›†åˆå®¹å™¨">äºŒã€é›†åˆå®¹å™¨</a></h1>
<h2 id="å¯¹å®¹å™¨è¿›è¡Œå®šä¹‰"><a class="header" href="#å¯¹å®¹å™¨è¿›è¡Œå®šä¹‰">å¯¹å®¹å™¨è¿›è¡Œå®šä¹‰</a></h2>
<details id="admonition-å®¹å™¨æ•°æ®ç»“æ„å¦‚ä½•ç†è§£" class="admonition tip">
<summary class="admonition-title">
<p>å®¹å™¨æ•°æ®ç»“æ„å¦‚ä½•ç†è§£</p>
<p><a class="admonition-anchor-link" href="#admonition-å®¹å™¨æ•°æ®ç»“æ„å¦‚ä½•ç†è§£"></a></p>
</summary>
<div>
<p>æåˆ°å®¹å™¨ï¼Œå¾ˆå¯èƒ½ä½ é¦–å…ˆä¼šæƒ³åˆ°çš„å°±æ˜¯æ•°ç»„ã€åˆ—è¡¨è¿™äº›å¯ä»¥éå†çš„å®¹å™¨ï¼Œä½†å…¶å®åªè¦æŠŠæŸ ç§ç‰¹å®šçš„æ•°æ®å°è£…åœ¨æŸä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„å°±æ˜¯ä¸€ä¸ªå®¹å™¨ã€‚æ¯”å¦‚ Option<T>ï¼Œå®ƒ æ˜¯ä¸€ä¸ªåŒ…è£¹äº† T å­˜åœ¨æˆ–ä¸å­˜åœ¨çš„å®¹å™¨ï¼Œè€Œ Cow æ˜¯ä¸€ä¸ªå°è£…äº†å†…éƒ¨æ•°æ® B æˆ–è¢«å€Ÿç”¨æˆ–æ‹¥æœ‰ æ‰€æœ‰æƒçš„å®¹å™¨ã€‚</p>
</div>
</details>
<h2 id="å¯¹é›†åˆå®¹å™¨è¿›è¡Œå®šä¹‰"><a class="header" href="#å¯¹é›†åˆå®¹å™¨è¿›è¡Œå®šä¹‰">å¯¹é›†åˆå®¹å™¨è¿›è¡Œå®šä¹‰</a></h2>
<details id="admonition-æŠŠæ‹¥æœ‰ç›¸åŒç±»å‹å¯¹æ•°æ®æ”¾åœ¨ä¸€èµ·ç»Ÿä¸€å¤„ç†" class="admonition tip">
<summary class="admonition-title">
<p>æŠŠæ‹¥æœ‰ç›¸åŒç±»å‹å¯¹æ•°æ®æ”¾åœ¨ä¸€èµ·ï¼Œç»Ÿä¸€å¤„ç†</p>
<p><a class="admonition-anchor-link" href="#admonition-æŠŠæ‹¥æœ‰ç›¸åŒç±»å‹å¯¹æ•°æ®æ”¾åœ¨ä¸€èµ·ç»Ÿä¸€å¤„ç†"></a></p>
</summary>
<div>
<p>é›†åˆå®¹å™¨ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æŠŠä¸€ç³»åˆ—æ‹¥æœ‰ç›¸åŒç±»å‹çš„æ•°æ®æ”¾åœ¨ä¸€èµ·ï¼Œç»Ÿä¸€å¤„ç†ï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>
<p>æˆ‘ä»¬ç†Ÿæ‚‰çš„å­—ç¬¦ä¸² Stringã€æ•°ç»„ [T; n]ã€åˆ—è¡¨ Vec<T> å’Œå“ˆå¸Œè¡¨ HashMap&lt;K, V&gt; ç­‰ï¼›</p>
</li>
<li>
<p>è™½ç„¶åˆ°å¤„åœ¨ä½¿ç”¨ï¼Œä½†è¿˜å¹¶ä¸ç†Ÿæ‚‰çš„åˆ‡ç‰‡ sliceï¼›</p>
</li>
<li>
<p>åœ¨å…¶ä»–è¯­è¨€ä¸­ä½¿ç”¨è¿‡ï¼Œä½†åœ¨ Rust ä¸­è¿˜æ²¡æœ‰ç”¨è¿‡çš„å¾ªç¯ç¼“å†²åŒº VecDeque<T>ã€åŒå‘åˆ— è¡¨ LinkedList<T> ç­‰ã€‚</p>
</li>
</ol>
<blockquote>
<p>è¿™äº›é›†åˆå®¹å™¨æœ‰å¾ˆå¤šå…±æ€§ï¼Œæ¯”å¦‚å¯ä»¥è¢«éå†ã€å¯ä»¥è¿›è¡Œ map-reduce æ“ä½œã€å¯ä»¥ä»ä¸€ç§ç±» å‹è½¬æ¢æˆå¦ä¸€ç§ç±»å‹ç­‰ç­‰ã€‚</p>
</blockquote>
</div>
</details>
<h2 id="åˆ‡ç‰‡"><a class="header" href="#åˆ‡ç‰‡">åˆ‡ç‰‡</a></h2>
<details id="admonition-åˆ‡ç‰‡åˆ°åº•æ˜¯ä»€ä¹ˆ" class="admonition tip">
<summary class="admonition-title">
<p>åˆ‡ç‰‡åˆ°åº•æ˜¯ä»€ä¹ˆ</p>
<p><a class="admonition-anchor-link" href="#admonition-åˆ‡ç‰‡åˆ°åº•æ˜¯ä»€ä¹ˆ"></a></p>
</summary>
<div>
<p>åœ¨ Rust é‡Œï¼Œåˆ‡ç‰‡æ˜¯æè¿°ä¸€ç»„å±äºåŒä¸€ç±»å‹ã€é•¿åº¦ä¸ç¡®å®šçš„ã€åœ¨å†…å­˜ä¸­è¿ç»­å­˜æ”¾çš„æ•°æ®ç»“ æ„ï¼Œç”¨ [T] æ¥è¡¨è¿°ã€‚å› ä¸ºé•¿åº¦ä¸ç¡®å®šï¼Œæ‰€ä»¥åˆ‡ç‰‡æ˜¯ä¸ª DSTï¼ˆDynamically Sized Typeï¼‰ã€‚</p>
<p>åˆ‡ç‰‡ä¸€èˆ¬åªå‡ºç°åœ¨æ•°æ®ç»“æ„çš„å®šä¹‰ä¸­ï¼Œä¸èƒ½ç›´æ¥è®¿é—®ï¼Œåœ¨ä½¿ç”¨ä¸­ä¸»è¦ç”¨ä»¥ä¸‹å½¢å¼ï¼š</p>
<ul>
<li>
<p>&amp;[T]ï¼šè¡¨ç¤ºä¸€ä¸ªåªè¯»çš„åˆ‡ç‰‡å¼•ç”¨ã€‚</p>
</li>
<li>
<p>&amp;mut [T]ï¼šè¡¨ç¤ºä¸€ä¸ªå¯å†™çš„åˆ‡ç‰‡å¼•ç”¨ã€‚</p>
</li>
<li>
<p>Box&lt;[T]&gt;ï¼šä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„åˆ‡ç‰‡ã€‚</p>
</li>
</ul>
</div>
</details>
<details id="admonition-åˆ‡ç‰‡ä¸æ•°æ®çš„å…³ç³»" class="admonition tip">
<summary class="admonition-title">
<p>åˆ‡ç‰‡ä¸æ•°æ®çš„å…³ç³»</p>
<p><a class="admonition-anchor-link" href="#admonition-åˆ‡ç‰‡ä¸æ•°æ®çš„å…³ç³»"></a></p>
</summary>
<div>
<h2 id="æ€ä¹ˆç†è§£åˆ‡ç‰‡å‘¢æˆ‘æ‰“ä¸ªæ¯”æ–¹åˆ‡ç‰‡ä¹‹äºå…·ä½“çš„æ•°æ®ç»“æ„å°±åƒæ•°æ®åº“ä¸­çš„è§†å›¾ä¹‹äºè¡¨-ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ç§å·¥å…·è®©æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€è®¿é—®è¡Œä¸ºç›¸åŒç»“æ„ç±»ä¼¼ä½†æœ‰äº›è®¸å·®å¼‚çš„ç±»-å‹"><a class="header" href="#æ€ä¹ˆç†è§£åˆ‡ç‰‡å‘¢æˆ‘æ‰“ä¸ªæ¯”æ–¹åˆ‡ç‰‡ä¹‹äºå…·ä½“çš„æ•°æ®ç»“æ„å°±åƒæ•°æ®åº“ä¸­çš„è§†å›¾ä¹‹äºè¡¨-ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ç§å·¥å…·è®©æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€è®¿é—®è¡Œä¸ºç›¸åŒç»“æ„ç±»ä¼¼ä½†æœ‰äº›è®¸å·®å¼‚çš„ç±»-å‹">æ€ä¹ˆç†è§£åˆ‡ç‰‡å‘¢ï¼Ÿæˆ‘æ‰“ä¸ªæ¯”æ–¹ï¼Œåˆ‡ç‰‡ä¹‹äºå…·ä½“çš„æ•°æ®ç»“æ„ï¼Œå°±åƒæ•°æ®åº“ä¸­çš„è§†å›¾ä¹‹äºè¡¨ã€‚ ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ç§å·¥å…·ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€è®¿é—®è¡Œä¸ºç›¸åŒã€ç»“æ„ç±»ä¼¼ä½†æœ‰äº›è®¸å·®å¼‚çš„ç±» å‹ã€‚</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let arr = [1, 2, 3, 4, 5];
    let vec = vec![1, 2, 3, 4, 5];
    let s1 = &amp;arr[1..3];
    let s2 = &amp;vec[1..3];
    println!(&quot;s1: {:?}, s2: {:?}&quot;, s1, s2);

    // &amp;[T] å’Œ &amp;[T] æ˜¯å¦ç›¸ç­‰å–å†³äºé•¿åº¦å’Œå†…å®¹æ˜¯å¦ç›¸ç­‰
    assert_eq!(s1, s2);
    // &amp;[T] å¯ä»¥å’Œ Vec&lt;T&gt;/[T;n] æ¯”è¾ƒï¼Œä¹Ÿä¼šçœ‹é•¿åº¦å’Œå†…å®¹
    assert_eq!(&amp;arr[..], vec);
    assert_eq!(&amp;vec[..], arr);
}
</code></pre></pre>
<ol>
<li>å¯¹äº array å’Œ vectorï¼Œè™½ç„¶æ˜¯ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œä¸€ä¸ªæ”¾åœ¨æ ˆä¸Šï¼Œä¸€ä¸ªæ”¾åœ¨å †ä¸Šï¼Œä½†å®ƒä»¬çš„ åˆ‡ç‰‡æ˜¯ç±»ä¼¼çš„ï¼›</li>
<li>è€Œä¸”å¯¹äºç›¸åŒå†…å®¹æ•°æ®çš„ç›¸åŒåˆ‡ç‰‡ï¼Œæ¯”å¦‚ &amp;arr[1â€¦3] å’Œ &amp;vec[1â€¦3]ï¼Œè¿™ ä¸¤è€…æ˜¯ç­‰ä»·çš„ã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œåˆ‡ç‰‡å’Œå¯¹åº”çš„æ•°æ®ç»“æ„ä¹Ÿå¯ä»¥ç›´æ¥æ¯”è¾ƒï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬ä¹‹é—´å® ç°äº† PartialEq trait
<img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4785008.jpg" alt="åˆ‡ç‰‡ä¸å…·ä½“æ•°æ®çš„å…³ç³»" /></li>
</ol>
</div>
</details>
<h3 id="array-vs-vector"><a class="header" href="#array-vs-vector">array vs vector</a></h3>
<details id="admonition-arrayå’Œvectorçš„åŒºåˆ«ä¸è”ç³»" class="admonition info">
<summary class="admonition-title">
<p>arrayå’Œvectorçš„åŒºåˆ«ä¸è”ç³»</p>
<p><a class="admonition-anchor-link" href="#admonition-arrayå’Œvectorçš„åŒºåˆ«ä¸è”ç³»"></a></p>
</summary>
<div>
<p>å¯¹äº array å’Œ vectorï¼Œè™½ç„¶æ˜¯ä¸åŒçš„æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ”¾åœ¨æ ˆä¸Š</li>
<li>ä¸€ä¸ªæ”¾åœ¨å †ä¸Š</li>
</ul>
<blockquote>
<p>ä½†å®ƒä»¬çš„åˆ‡ç‰‡æ˜¯ç±»ä¼¼çš„, è€Œä¸”å¯¹äºç›¸åŒå†…å®¹æ•°æ®çš„ç›¸åŒåˆ‡ç‰‡</p>
</blockquote>
<ul>
<li>æ¯”å¦‚ &amp;arr[1â€¦3] å’Œ &amp;vec[1â€¦3]ï¼Œè¿™ä¸¤è€…æ˜¯ç­‰ä»·çš„ã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œåˆ‡ç‰‡å’Œå¯¹åº”çš„æ•°æ®ç»“æ„ä¹Ÿå¯ä»¥ç›´æ¥æ¯”è¾ƒï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬ä¹‹é—´å®ç°äº† PartialEq traitï¼ˆæºç å‚è€ƒèµ„æ–™ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>ä¸‹å›¾æ¯”è¾ƒæ¸…æ™°åœ°å‘ˆç°äº†åˆ‡ç‰‡å’Œæ•°æ®ä¹‹é—´çš„å…³ç³»ï¼š
<img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4866674.jpg" alt="åˆ‡ç‰‡å’Œæ•°æ®ä¹‹é—´çš„å…³ç³»" /></p>
</blockquote>
</div>
</details>
<h3 id="vec-å’Œ-t"><a class="header" href="#vec-å’Œ-t">Vec<T> å’Œ &amp;[T]</a></h3>
<details id="admonition-tä¸vectå…³ç³»" class="admonition tip">
<summary class="admonition-title">
<p>&amp;[T]ä¸&amp;Vec[T]å…³ç³»</p>
<p><a class="admonition-anchor-link" href="#admonition-tä¸vectå…³ç³»"></a></p>
</summary>
<div>
<p>![&amp;[T]å’Œ&amp;Vec[T]](https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4785147.jpg)</p>
</div>
</details>
<h3 id="è§£å¼•ç”¨"><a class="header" href="#è§£å¼•ç”¨">è§£å¼•ç”¨</a></h3>
<details id="admonition-æ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹å¯ä»¥æ ¹æ®éœ€è¦è§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>æ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹å¯ä»¥æ ¹æ®éœ€è¦è§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹</p>
<p><a class="admonition-anchor-link" href="#admonition-æ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹å¯ä»¥æ ¹æ®éœ€è¦è§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹"></a></p>
</summary>
<div>
<p>åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ï¼Œè§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹ã€‚</p>
<ul>
<li>æ¯”å¦‚ Vec<T> å’Œ [T; n] ä¼šè½¬åŒ–æˆä¸º &amp;[T]ï¼Œè¿™æ˜¯å› ä¸º Vec<T> å®ç°äº† Deref traitï¼Œè€Œ array å†…å»ºäº†åˆ° &amp;[T] çš„è§£å¼•ç”¨ã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥å†™ä¸€æ®µä»£ç éªŒè¯è¿™ä¸€è¡Œä¸ºï¼ˆä»£ç ï¼‰ï¼š</li>
</ul>
<hr />
<pre><pre class="playground"><code class="language-rust  editable">
use std::fmt;
fn main() {
    let v = vec![1, 2, 3, 4];

    // Vec å®ç°äº† Derefï¼Œ&amp;Vec&lt;T&gt; ä¼šè¢«è‡ªåŠ¨è§£å¼•ç”¨ä¸º &amp;[T]ï¼Œç¬¦åˆæ¥å£å®šä¹‰
    print_slice(&amp;v);
    // ç›´æ¥æ˜¯ &amp;[T]ï¼Œç¬¦åˆæ¥å£å®šä¹‰
    print_slice(&amp;v[..]);

    // &amp;Vec&lt;T&gt; æ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(&amp;v);
    // &amp;[T] æ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(&amp;v[..]);
    // Vec&lt;T&gt; ä¹Ÿæ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(v);

    let arr = [1, 2, 3, 4];
    // æ•°ç»„è™½æ²¡æœ‰å®ç° Derefï¼Œä½†å®ƒçš„è§£å¼•ç”¨å°±æ˜¯ &amp;[T]
    print_slice(&amp;arr);
    print_slice(&amp;arr[..]);
    print_slice1(&amp;arr);
    print_slice1(&amp;arr[..]);
    print_slice1(arr);
}

// æ³¨æ„ä¸‹é¢çš„æ³›å‹å‡½æ•°çš„ä½¿ç”¨
fn print_slice&lt;T: fmt::Debug&gt;(s: &amp;[T]) {
    println!(&quot;{:?}&quot;, s);
}

fn print_slice1&lt;T, U&gt;(s: T)
where
    T: AsRef&lt;[U]&gt;,
    U: fmt::Debug,
{
    println!(&quot;{:?}&quot;, s.as_ref());
}
</code></pre></pre>
<hr />
<blockquote>
<p>è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œé€šè¿‡è§£å¼•ç”¨ï¼Œè¿™å‡ ä¸ªå’Œåˆ‡ç‰‡æœ‰å…³çš„æ•°æ®ç»“æ„éƒ½ä¼šè·å¾—åˆ‡ç‰‡çš„æ‰€æœ‰èƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼šbinary_searchã€chunksã€concatã€containsã€start_withã€end_withã€group_byã€iterã€joinã€sortã€splitã€swap ç­‰ä¸€ç³»åˆ—ä¸°å¯Œçš„åŠŸèƒ½ï¼Œ</p>
</blockquote>
</div>
</details>
<h3 id="åˆ‡ç‰‡å’Œè¿­ä»£å™¨-iterator"><a class="header" href="#åˆ‡ç‰‡å’Œè¿­ä»£å™¨-iterator">åˆ‡ç‰‡å’Œè¿­ä»£å™¨ Iterator</a></h3>
<details id="admonition-è¿­ä»£å™¨å¯ä»¥è¯´æ˜¯åˆ‡ç‰‡çš„å­ªç”Ÿå…„å¼Ÿ" class="admonition info">
<summary class="admonition-title">
<p>è¿­ä»£å™¨å¯ä»¥è¯´æ˜¯åˆ‡ç‰‡çš„å­ªç”Ÿå…„å¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-è¿­ä»£å™¨å¯ä»¥è¯´æ˜¯åˆ‡ç‰‡çš„å­ªç”Ÿå…„å¼Ÿ"></a></p>
</summary>
<div>
<p>è¿­ä»£å™¨å¯ä»¥è¯´æ˜¯åˆ‡ç‰‡çš„å­ªç”Ÿå…„å¼Ÿã€‚åˆ‡ç‰‡æ˜¯é›†åˆæ•°æ®çš„è§†å›¾ï¼Œè€Œè¿­ä»£å™¨å®šä¹‰äº†å¯¹é›†åˆæ•°æ®çš„å„ç§å„æ ·çš„è®¿é—®æ“ä½œã€‚</p>
<p>Iterator trait æœ‰å¤§é‡çš„æ–¹æ³•ï¼Œä½†ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€è¦å®šä¹‰å®ƒçš„å…³è”ç±»å‹ Item å’Œ next() æ–¹æ³•ã€‚</p>
<ul>
<li>Item å®šä¹‰äº†æ¯æ¬¡æˆ‘ä»¬ä»è¿­ä»£å™¨ä¸­å–å‡ºçš„æ•°æ®ç±»å‹ï¼›</li>
<li>next() æ˜¯ä»è¿­ä»£å™¨é‡Œå–ä¸‹ä¸€ä¸ªå€¼çš„æ–¹æ³•ã€‚å½“ä¸€ä¸ªè¿­ä»£å™¨çš„ next() æ–¹æ³•è¿”å› None æ—¶ï¼Œè¡¨æ˜è¿­ä»£å™¨ä¸­æ²¡æœ‰æ•°æ®äº†ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>#[must_use = &quot;iterators are lazy and do nothing unless consumed&quot;]
pub trait Iterator {
    type Item;
    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;;
    // å¤§é‡ç¼ºçœçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ size_hint, count, chain, zip, map, 
    // filter, for_each, skip, take_while, flat_map, flatten
    // collect, partition ç­‰
    ... 
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-å¯¹-vec-ä½¿ç”¨-iter-æ–¹æ³•å¹¶è¿›è¡Œå„ç§-map--filter--take-æ“ä½œ" class="admonition info">
<summary class="admonition-title">
<p>å¯¹ Vec<T> ä½¿ç”¨ iter() æ–¹æ³•ï¼Œå¹¶è¿›è¡Œå„ç§ map / filter / take æ“ä½œ</p>
<p><a class="admonition-anchor-link" href="#admonition-å¯¹-vec-ä½¿ç”¨-iter-æ–¹æ³•å¹¶è¿›è¡Œå„ç§-map--filter--take-æ“ä½œ"></a></p>
</summary>
<div>
<p>ä¸€ä¸ªä¾‹å­ï¼šå¯¹ Vec<T> ä½¿ç”¨ iter() æ–¹æ³•ï¼Œå¹¶è¿›è¡Œå„ç§ map / filter / take æ“ä½œã€‚åœ¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œè¿™æ ·çš„å†™æ³•å¾ˆå¸¸è§ï¼Œä»£ç çš„å¯è¯»æ€§å¾ˆå¼ºã€‚Rust ä¹Ÿæ”¯æŒè¿™ç§å†™æ³•ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
fn main() {
    // è¿™é‡Œ Vec&lt;T&gt; åœ¨è°ƒç”¨ iter() æ—¶è¢«è§£å¼•ç”¨æˆ &amp;[T]ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—® iter()
    let result = vec![1, 2, 3, 4]
        .iter()
        .map(|v| v * v)
        .filter(|v| *v &lt; 16)
        .take(1)
        .collect::&lt;Vec&lt;_&gt;&gt;();

    println!(&quot;{:?}&quot;, result);
}
</code></pre></pre>
</div>
</details>
<details id="admonition-rustçš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£è¿™æ˜¯å¦‚ä½•å®ç°çš„" class="admonition info">
<summary class="admonition-title">
<p>Rustçš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£ï¼Œè¿™æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-rustçš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£è¿™æ˜¯å¦‚ä½•å®ç°çš„"></a></p>
</summary>
<div>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ Rust ä¸‹çš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£ï¼ˆlazy interfaceï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ®µä»£ç ç›´åˆ°è¿è¡Œåˆ° collect æ—¶æ‰çœŸæ­£å¼€å§‹æ‰§è¡Œï¼Œä¹‹å‰çš„éƒ¨åˆ†ä¸è¿‡æ˜¯åœ¨ä¸æ–­åœ°ç”Ÿæˆæ–°çš„ç»“æ„ï¼Œæ¥ç´¯ç§¯å¤„ç†é€»è¾‘è€Œå·²ã€‚ä½ å¯èƒ½å¥½å¥‡ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>åŸæ¥ï¼ŒIterator å¤§éƒ¨åˆ†æ–¹æ³•éƒ½è¿”å›ä¸€ä¸ªå®ç°äº† Iterator çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·ä¸€è·¯é“¾å¼ä¸‹å»ï¼Œåœ¨ Rust æ ‡å‡†åº“ä¸­ï¼Œè¿™äº›æ•°æ®ç»“æ„è¢«ç§°ä¸º <a href="https://doc.rust-lang.org/src/core/iter/adapters/mod.rs.html">Iterator Adapter</a>ã€‚æ¯”å¦‚ä¸Šé¢çš„ map æ–¹æ³•ï¼Œå®ƒè¿”å› Map ç»“æ„ï¼Œè€Œ Map ç»“æ„å®ç°äº† <a href="https://doc.rust-lang.org/src/core/iter/adapters/map.rs.html#93-133">Iteratorï¼ˆæºç ï¼‰</a>ã€‚
æ•´ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼ˆé“¾æ¥å‡ä¸ºæºç èµ„æ–™ï¼‰ï¼š</p>
<ol>
<li>åœ¨ collect() æ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒ<a href="https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#1744-1749">å®é™…è¯•å›¾ä½¿ç”¨ FromIterator ä»è¿­ä»£å™¨ä¸­æ„å»ºä¸€ä¸ªé›†åˆç±»å‹</a>ï¼Œè¿™ä¼šä¸æ–­è°ƒç”¨ next() è·å–ä¸‹ä¸€ä¸ªæ•°æ®ï¼›</li>
<li>æ­¤æ—¶çš„ Iterator æ˜¯ Takeï¼ŒTake è°ƒè‡ªå·±çš„ next()ï¼Œä¹Ÿå°±æ˜¯å®ƒä¼š<a href="https://doc.rust-lang.org/src/core/iter/adapters/take.rs.html#34-41">è°ƒç”¨ Filter çš„ next()</a>ï¼›</li>
<li>Filter çš„ next() å®é™…ä¸Š<a href="https://time.geekbang.org/column/article/422975">è°ƒç”¨è‡ªå·±å†…éƒ¨çš„ iter çš„ find()</a>ï¼Œæ­¤æ—¶å†…éƒ¨çš„ iter æ˜¯ Mapï¼Œfind() ä¼šä½¿ç”¨ <a href="https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#2312-2325">try_fold()</a>ï¼Œå®ƒä¼š<a href="https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#2382-2406">ç»§ç»­è°ƒç”¨ next()</a>ï¼Œä¹Ÿå°±æ˜¯ Map çš„ next()ï¼›</li>
<li>Map çš„ next() ä¼š<a href="https://time.geekbang.org/column/article/422975">è°ƒç”¨å…¶å†…éƒ¨çš„ iter å– next() ç„¶åæ‰§è¡Œ map å‡½æ•°</a>ã€‚è€Œæ­¤æ—¶å†…éƒ¨çš„ iter æ¥è‡ª Vec<i32>ã€‚</li>
</ol>
<p>æ‰€ä»¥ï¼Œåªæœ‰åœ¨ collect() æ—¶ï¼Œæ‰è§¦å‘ä»£ç ä¸€å±‚å±‚è°ƒç”¨ä¸‹å»ï¼Œå¹¶ä¸”è°ƒç”¨ä¼šæ ¹æ®éœ€è¦éšæ—¶ç»“æŸã€‚è¿™æ®µä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨äº† take(1)ï¼Œæ•´ä¸ªè°ƒç”¨é“¾å¾ªç¯ä¸€æ¬¡ï¼Œå°±èƒ½æ»¡è¶³ take(1) ä»¥åŠæ‰€æœ‰ä¸­é—´è¿‡ç¨‹çš„è¦æ±‚ï¼Œæ‰€ä»¥å®ƒåªä¼šå¾ªç¯ä¸€æ¬¡ã€‚</p>
</div>
</details>
<details id="admonition-rustçš„å‡½æ•°å¼ç¼–ç¨‹å†™æ³•æ€§èƒ½å¦‚ä½•" class="admonition info">
<summary class="admonition-title">
<p>Rustçš„å‡½æ•°å¼ç¼–ç¨‹å†™æ³•æ€§èƒ½å¦‚ä½•ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-rustçš„å‡½æ•°å¼ç¼–ç¨‹å†™æ³•æ€§èƒ½å¦‚ä½•"></a></p>
</summary>
<div>
<p>ä½ å¯èƒ½ä¼šæœ‰ç–‘æƒ‘ï¼šè¿™ç§å‡½æ•°å¼ç¼–ç¨‹çš„å†™æ³•ï¼Œä»£ç æ˜¯æ¼‚äº®äº†ï¼Œç„¶è€Œè¿™ä¹ˆå¤šæ— è°“çš„å‡½æ•°è°ƒç”¨ï¼Œæ€§èƒ½è‚¯å®šå¾ˆå·®å§ï¼Ÿæ¯•ç«Ÿï¼Œå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€çš„ä¸€å¤§æ¶åå°±æ˜¯æ€§èƒ½å·®ã€‚</p>
<p>è¿™ä¸ªä½ å®Œå…¨ä¸ç”¨æ‹…å¿ƒï¼Œ Rust å¤§é‡ä½¿ç”¨äº† inline ç­‰ä¼˜åŒ–æŠ€å·§ï¼Œè¿™æ ·éå¸¸æ¸…æ™°å‹å¥½çš„è¡¨è¾¾æ–¹å¼ï¼Œæ€§èƒ½å’Œ C è¯­è¨€çš„ for å¾ªç¯å·®åˆ«ä¸å¤§ã€‚</p>
</div>
</details>
<details id="admonition-rustçš„iteratoré™¤äº†æ ‡å‡†åº“è¿˜æœ‰itertoolsæä¾›æ›´å¤šåŠŸèƒ½" class="admonition info">
<summary class="admonition-title">
<p>Rustçš„iteratoré™¤äº†æ ‡å‡†åº“ï¼Œè¿˜æœ‰itertoolsæä¾›æ›´å¤šåŠŸèƒ½</p>
<p><a class="admonition-anchor-link" href="#admonition-rustçš„iteratoré™¤äº†æ ‡å‡†åº“è¿˜æœ‰itertoolsæä¾›æ›´å¤šåŠŸèƒ½"></a></p>
</summary>
<div>
<p>å¦‚æœæ ‡å‡†åº“ä¸­çš„åŠŸèƒ½è¿˜ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½ å¯ä»¥çœ‹çœ‹ itertoolsï¼Œå®ƒæ˜¯å’Œ Python ä¸‹ itertools åŒåä¸”åŠŸèƒ½ç±»ä¼¼çš„å·¥å…·ï¼Œæä¾›äº†å¤§é‡é¢å¤–çš„ adapterã€‚å¯ä»¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use itertools::Itertools;

fn main() {
    let err_str = &quot;bad happened&quot;;
    let input = vec![Ok(21), Err(err_str), Ok(7)];
    let it = input
        .into_iter()
        .filter_map_ok(|i| if i &gt; 10 { Some(i * 2) } else { None });
    // ç»“æœåº”è¯¥æ˜¯ï¼švec![Ok(42), Err(err_str)]
    println!(&quot;{:?}&quot;, it.collect::&lt;Vec&lt;_&gt;&gt;());
}
</code></pre></pre>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä»ä¸€ç»„ Future ä¸­æ±‡èšå‡ºä¸€ç»„ç»“æœï¼Œé‡Œé¢æœ‰æˆåŠŸæ‰§è¡Œçš„ç»“æœï¼Œä¹Ÿæœ‰å¤±è´¥çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœæƒ³å¯¹æˆåŠŸçš„ç»“æœè¿›ä¸€æ­¥åš filter/mapï¼Œé‚£ä¹ˆæ ‡å‡†åº“å°±æ— æ³•å¸®å¿™äº†ï¼Œå°±éœ€è¦ç”¨ itertools é‡Œçš„ filter_map_ok()ã€‚</p>
</div>
</details>
<h3 id="ç‰¹æ®Šçš„åˆ‡ç‰‡str"><a class="header" href="#ç‰¹æ®Šçš„åˆ‡ç‰‡str">ç‰¹æ®Šçš„åˆ‡ç‰‡ï¼š&amp;str</a></h3>
<details id="admonition-stringstringå’Œstrçš„åŒºåˆ«ä¸è”ç³»" class="admonition info">
<summary class="admonition-title">
<p>Stringã€&amp;Stringå’Œ&amp;strçš„åŒºåˆ«ä¸è”ç³»</p>
<p><a class="admonition-anchor-link" href="#admonition-stringstringå’Œstrçš„åŒºåˆ«ä¸è”ç³»"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ç§ç‰¹æ®Šçš„åˆ‡ç‰‡ï¼š&amp;strã€‚ä¹‹å‰è®²è¿‡ï¼ŒString æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Vec<u8>ï¼Œæ‰€ä»¥åœ¨ String ä¸Šåšåˆ‡ç‰‡ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ &amp;strã€‚</p>
<p>å¯¹äº Stringã€&amp;Stringã€&amp;strï¼Œå¾ˆå¤šäººä¹Ÿç»å¸¸åˆ†ä¸æ¸…å®ƒä»¬çš„åŒºåˆ«ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰çš„ä¸€ç¯‡åŠ é¤ä¸­ç®€å•èŠäº†è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ä¸Šä¸€è®²æ™ºèƒ½æŒ‡é’ˆä¸­ï¼Œä¹Ÿå¯¹æ¯”è¿‡ String å’Œ &amp;strã€‚å¯¹äº &amp;String å’Œ &amp;strï¼Œå¦‚æœä½ ç†è§£äº†ä¸Šæ–‡ä¸­ &amp;Vec<T> å’Œ &amp;[T] çš„åŒºåˆ«ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š
<img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4867212.jpg" alt="&amp;Stringå’Œ&amp;str" /></p>
</div>
</details>
<details id="admonition-stringåœ¨è§£å¼•ç”¨æ—¶ä¼šè½¬æ¢æˆstr" class="admonition info">
<summary class="admonition-title">
<p>Stringåœ¨è§£å¼•ç”¨æ—¶ä¼šè½¬æ¢æˆ&amp;str</p>
<p><a class="admonition-anchor-link" href="#admonition-stringåœ¨è§£å¼•ç”¨æ—¶ä¼šè½¬æ¢æˆstr"></a></p>
</summary>
<div>
<p>String åœ¨è§£å¼•ç”¨æ—¶ï¼Œä¼šè½¬æ¢æˆ &amp;strã€‚å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç éªŒè¯ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::fmt;
fn main() {
    let s = String::from(&quot;hello&quot;);
    // &amp;String ä¼šè¢«è§£å¼•ç”¨æˆ &amp;str
    print_slice(&amp;s);
    // &amp;s[..] å’Œ s.as_str() ä¸€æ ·ï¼Œéƒ½ä¼šå¾—åˆ° &amp;str
    print_slice(&amp;s[..]);

    // String æ”¯æŒ AsRef&lt;str&gt;
    print_slice1(&amp;s);
    print_slice1(&amp;s[..]);
    print_slice1(s.clone());

    // String ä¹Ÿå®ç°äº† AsRef&lt;[u8]&gt;ï¼Œæ‰€ä»¥ä¸‹é¢çš„ä»£ç æˆç«‹
    // æ‰“å°å‡ºæ¥æ˜¯ [104, 101, 108, 108, 111]
    print_slice2(&amp;s);
    print_slice2(&amp;s[..]);
    print_slice2(s);
}

fn print_slice(s: &amp;str) {
    println!(&quot;{:?}&quot;, s);
}

fn print_slice1&lt;T: AsRef&lt;str&gt;&gt;(s: T) {
    println!(&quot;{:?}&quot;, s.as_ref());
}

fn print_slice2&lt;T, U&gt;(s: T)
where
    T: AsRef&lt;[U]&gt;,
    U: fmt::Debug,
{
    println!(&quot;{:?}&quot;, s.as_ref());
}
</code></pre></pre>
</div>
</details>
<details id="admonition-å­—ç¬¦çš„åˆ—è¡¨å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå…³ç³»å’ŒåŒºåˆ«" class="admonition info">
<summary class="admonition-title">
<p>å­—ç¬¦çš„åˆ—è¡¨å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå…³ç³»å’ŒåŒºåˆ«</p>
<p><a class="admonition-anchor-link" href="#admonition-å­—ç¬¦çš„åˆ—è¡¨å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå…³ç³»å’ŒåŒºåˆ«"></a></p>
</summary>
<div>
<p>é‚£ä¹ˆå­—ç¬¦çš„åˆ—è¡¨å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå…³ç³»å’ŒåŒºåˆ«ï¼Ÿæˆ‘ä»¬ç›´æ¥å†™ä¸€æ®µä»£ç æ¥çœ‹çœ‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::iter::FromIterator;

fn main() {
    let arr = ['h', 'e', 'l', 'l', 'o'];
    let vec = vec!['h', 'e', 'l', 'l', 'o'];
    let s = String::from(&quot;hello&quot;);
    let s1 = &amp;arr[1..3];
    let s2 = &amp;vec[1..3];
    // &amp;str æœ¬èº«å°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ slice
    let s3 = &amp;s[1..3];
    println!(&quot;s1: {:?}, s2: {:?}, s3: {:?}&quot;, s1, s2, s3);

    // &amp;[char] å’Œ &amp;[char] æ˜¯å¦ç›¸ç­‰å–å†³äºé•¿åº¦å’Œå†…å®¹æ˜¯å¦ç›¸ç­‰
    assert_eq!(s1, s2);
    // &amp;[char] å’Œ &amp;str ä¸èƒ½ç›´æ¥å¯¹æ¯”ï¼Œæˆ‘ä»¬æŠŠ s3 å˜æˆ Vec&lt;char&gt;
    assert_eq!(s2, s3.chars().collect::&lt;Vec&lt;_&gt;&gt;());
    // &amp;[char] å¯ä»¥é€šè¿‡è¿­ä»£å™¨è½¬æ¢æˆ Stringï¼ŒString å’Œ &amp;str å¯ä»¥ç›´æ¥å¯¹æ¯”
    assert_eq!(String::from_iter(s2), s3);
}
</code></pre></pre>
<hr />
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå­—ç¬¦åˆ—è¡¨å¯ä»¥é€šè¿‡è¿­ä»£å™¨è½¬æ¢æˆ Stringï¼ŒString ä¹Ÿå¯ä»¥é€šè¿‡ chars() å‡½æ•°è½¬æ¢æˆå­—ç¬¦åˆ—è¡¨ï¼Œå¦‚æœä¸è½¬æ¢ï¼ŒäºŒè€…ä¸èƒ½æ¯”è¾ƒã€‚</p>
</blockquote>
<hr />
<p>ä¸‹å›¾æŠŠæ•°ç»„ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²ä»¥åŠå®ƒä»¬çš„åˆ‡ç‰‡æ”¾åœ¨ä¸€èµ·æ¯”è¾ƒï¼Œå¯ä»¥æ›´å¥½åœ°ç†è§£å®ƒä»¬çš„åŒºåˆ«ï¼š
<img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4867332.jpg" alt="æ•°ç»„ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²å’Œå„è‡ªçš„åˆ‡ç‰‡" /></p>
</div>
</details>
<h3 id="boxt"><a class="header" href="#boxt">Box&lt;[T]&gt;</a></h3>
<details id="admonition-boxå’Œvectå¯¹æ¯”" class="admonition info">
<summary class="admonition-title">
<p>Box&lt;[T]&gt;å’ŒVec<T>&amp;[T]å¯¹æ¯”</p>
<p><a class="admonition-anchor-link" href="#admonition-boxå’Œvectå¯¹æ¯”"></a></p>
</summary>
<div>
<p>åˆ‡ç‰‡ä¸»è¦æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li>åˆ‡ç‰‡çš„åªè¯»å¼•ç”¨ &amp;[T]</li>
<li>åˆ‡ç‰‡çš„å¯å˜å¼•ç”¨ &amp;mut [T]: å’Œ&amp;[T]ç±»ä¼¼</li>
<li>Box&lt;[T]&gt;</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ Box&lt;[T]&gt;ã€‚</p>
<p>Box&lt;[T]&gt; æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„å­˜åœ¨ï¼Œå®ƒå’Œ Vec<T> æœ‰ä¸€ç‚¹ç‚¹å·®åˆ«ï¼š</p>
<ul>
<li>Vec<T> æœ‰é¢å¤–çš„ capacityï¼Œå¯ä»¥å¢é•¿ï¼›</li>
<li>è€Œ Box&lt;[T]&gt; ä¸€æ—¦ç”Ÿæˆå°±å›ºå®šä¸‹æ¥ï¼Œæ²¡æœ‰ capacityï¼Œä¹Ÿæ— æ³•å¢é•¿ã€‚</li>
</ul>
<p>Box&lt;[T]&gt; å’Œåˆ‡ç‰‡çš„å¼•ç”¨ &amp;[T] ä¹Ÿå¾ˆç±»ä¼¼ï¼š</p>
<ol>
<li>å®ƒä»¬éƒ½æ˜¯åœ¨æ ˆä¸Šæœ‰ä¸€ä¸ªåŒ…å«é•¿åº¦çš„èƒ–æŒ‡é’ˆï¼ŒæŒ‡å‘å­˜å‚¨æ•°æ®çš„å†…å­˜ä½ç½®ã€‚</li>
<li>åŒºåˆ«æ˜¯ï¼šBox&lt;[T]&gt; åªä¼šæŒ‡å‘å †ï¼Œ&amp;[T] æŒ‡å‘çš„ä½ç½®å¯ä»¥æ˜¯æ ˆä¹Ÿå¯ä»¥æ˜¯å †ï¼›</li>
<li>æ­¤å¤–ï¼ŒBox&lt;[T]&gt; å¯¹æ•°æ®å…·æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;[T] åªæ˜¯ä¸€ä¸ªå€Ÿç”¨ã€‚</li>
</ol>
<hr />
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4867436.jpg" alt="" /></p>
</div>
</details>
<details id="admonition-é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ-box-å‘¢" class="admonition info">
<summary class="admonition-title">
<p>é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ Box&lt;[T]&gt; å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ-box-å‘¢"></a></p>
</summary>
<div>
<p>é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ Box&lt;[T]&gt; å‘¢ï¼Ÿ
ç›®å‰å¯ç”¨çš„æ¥å£å°±åªæœ‰ä¸€ä¸ªï¼šä»å·²æœ‰çš„ Vec<T> ä¸­è½¬æ¢ã€‚æˆ‘ä»¬çœ‹ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::ops::Deref;

fn main() {
    let mut v1 = vec![1, 2, 3, 4];
    v1.push(5);
    println!(&quot;cap should be 8: {}&quot;, v1.capacity());

    // ä» Vec&lt;T&gt; è½¬æ¢æˆ Box&lt;[T]&gt;ï¼Œæ­¤æ—¶ä¼šä¸¢å¼ƒå¤šä½™çš„ capacity
    let b1 = v1.into_boxed_slice();
    let mut b2 = b1.clone();

    let v2 = b1.into_vec();
    println!(&quot;cap should be exactly 5: {}&quot;, v2.capacity());

    assert!(b2.deref() == v2);

    // Box&lt;[T]&gt; å¯ä»¥æ›´æ”¹å…¶å†…éƒ¨æ•°æ®ï¼Œä½†æ— æ³• push
    b2[0] = 2;
    // b2.push(6);
    println!(&quot;b2: {:?}&quot;, b2);

    // æ³¨æ„ Box&lt;[T]&gt; å’Œ Box&lt;[T; n]&gt; å¹¶ä¸ç›¸åŒ
    let b3 = Box::new([2, 2, 3, 4, 5]);
    println!(&quot;b3: {:?}&quot;, b3);

    // b2 å’Œ b3 ç›¸ç­‰ï¼Œä½† b3.deref() å’Œ v2 æ— æ³•æ¯”è¾ƒ
    assert!(b2 == b3);
    // assert!(b3.deref() == v2);
}
</code></pre></pre>
<hr />
<p>è¿è¡Œä»£ç å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>Vec<T> å¯ä»¥é€šè¿‡ into_boxed_slice() è½¬æ¢æˆ Box&lt;[T]&gt;</li>
<li>Box&lt;[T]&gt; ä¹Ÿå¯ä»¥é€šè¿‡ into_vec() è½¬æ¢å› Vec<T>ã€‚</li>
</ol>
<p>è¿™ä¸¤ä¸ªè½¬æ¢éƒ½æ˜¯å¾ˆè½»é‡çš„è½¬æ¢ï¼Œåªæ˜¯å˜æ¢ä¸€ä¸‹ç»“æ„ï¼Œä¸æ¶‰åŠæ•°æ®çš„æ‹·è´ã€‚</p>
<p>åŒºåˆ«æ˜¯:</p>
<ol>
<li>å½“ Vec<T> è½¬æ¢æˆ Box&lt;[T]&gt; æ—¶ï¼Œæ²¡æœ‰ä½¿ç”¨åˆ°çš„å®¹é‡å°±ä¼šè¢«ä¸¢å¼ƒï¼Œæ‰€ä»¥æ•´ä½“å ç”¨çš„å†…å­˜å¯èƒ½ä¼šé™ä½ã€‚</li>
<li>è€Œä¸” Box&lt;[T]&gt; æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§æ˜¯ï¼Œä¸åƒ Box&lt;[T;n]&gt; é‚£æ ·åœ¨ç¼–è¯‘æ—¶å°±è¦ç¡®å®šå¤§å°ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸç”Ÿæˆï¼Œä»¥åå¤§å°ä¸ä¼šå†æ”¹å˜ã€‚</li>
</ol>
<p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬éœ€è¦åœ¨å †ä¸Šåˆ›å»ºå›ºå®šå¤§å°çš„é›†åˆæ•°æ®ï¼Œä¸”ä¸å¸Œæœ›è‡ªåŠ¨å¢é•¿ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥å…ˆåˆ›å»º Vec<T>ï¼Œå†è½¬æ¢æˆ Box&lt;[T]&gt;ã€‚</p>
<blockquote>
<p>tokio åœ¨æä¾› broadcast channel æ—¶ï¼Œå°±ä½¿ç”¨äº† Box&lt;[T]&gt; è¿™ä¸ªç‰¹æ€§ï¼Œä½ æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è‡ªå·±çœ‹çœ‹<a href="https://github.com/tokio-rs/tokio/blob/master/tokio/src/sync/broadcast.rs#L447">æºç </a>ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="å¸¸ç”¨åˆ‡ç‰‡å¯¹æ¯”å›¾"><a class="header" href="#å¸¸ç”¨åˆ‡ç‰‡å¯¹æ¯”å›¾">å¸¸ç”¨åˆ‡ç‰‡å¯¹æ¯”å›¾</a></h3>
<div id="admonition-strtnvectmuttçš„åŒºåˆ«ä¸è”ç³»å›¾" class="admonition info">
<div class="admonition-title">
<p>&amp;strã€[T;n]ã€Vec<T>ã€&amp;[T]ã€&amp;mut[T]çš„åŒºåˆ«ä¸è”ç³»å›¾ </p>
<p><a class="admonition-anchor-link" href="#admonition-strtnvectmuttçš„åŒºåˆ«ä¸è”ç³»å›¾"></a></p>
</div>
<div>
<p>ä¸‹å›¾æè¿°äº†åˆ‡ç‰‡å’Œæ•°ç»„ [T;n]ã€åˆ—è¡¨ Vec<T>ã€åˆ‡ç‰‡å¼•ç”¨ &amp;[T] /&amp;mut [T]ï¼Œä»¥åŠåœ¨å †ä¸Šåˆ†é…çš„åˆ‡ç‰‡ Box&lt;[T]&gt; ä¹‹é—´çš„å…³ç³»ã€‚</p>
<blockquote>
<p>å»ºè®®èŠ±äº›æ—¶é—´ç†è§£è¿™å¼ å›¾ï¼Œä¹Ÿå¯ä»¥ç”¨ç›¸åŒçš„æ–¹å¼å»æ€»ç»“å­¦åˆ°çš„å…¶ä»–æœ‰å…³è”çš„æ•°æ®ç»“æ„ã€‚</p>
</blockquote>
<hr />
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4867546.jpg" alt="" /></p>
</div>
</div>
<h2 id="å“ˆå¸Œè¡¨"><a class="header" href="#å“ˆå¸Œè¡¨">å“ˆå¸Œè¡¨</a></h2>
<h3 id="å“ˆå¸Œè¡¨è¿˜æ˜¯åˆ—è¡¨"><a class="header" href="#å“ˆå¸Œè¡¨è¿˜æ˜¯åˆ—è¡¨">å“ˆå¸Œè¡¨è¿˜æ˜¯åˆ—è¡¨</a></h3>
<details id="admonition-å“ˆå¸Œè¡¨å’Œåˆ—è¡¨çš„é€‰æ‹©" class="admonition info">
<summary class="admonition-title">
<p>å“ˆå¸Œè¡¨å’Œåˆ—è¡¨çš„é€‰æ‹©</p>
<p><a class="admonition-anchor-link" href="#admonition-å“ˆå¸Œè¡¨å’Œåˆ—è¡¨çš„é€‰æ‹©"></a></p>
</summary>
<div>
<h2 id="æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨å’Œåˆ—è¡¨ç±»ä¼¼éƒ½ç”¨äºå¤„ç†éœ€è¦éšæœºè®¿é—®çš„æ•°æ®ç»“æ„å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”é‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨å¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”é‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨"><a class="header" href="#æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨å’Œåˆ—è¡¨ç±»ä¼¼éƒ½ç”¨äºå¤„ç†éœ€è¦éšæœºè®¿é—®çš„æ•°æ®ç»“æ„å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”é‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨å¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”é‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨">æˆ‘ä»¬çŸ¥é“ï¼Œå“ˆå¸Œè¡¨å’Œåˆ—è¡¨ç±»ä¼¼ï¼Œéƒ½ç”¨äºå¤„ç†éœ€è¦éšæœºè®¿é—®çš„æ•°æ®ç»“æ„ã€‚å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨ï¼Œå¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨ã€‚</a></h2>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882989.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></p>
</div>
</details>
<h3 id="rust-çš„å“ˆå¸Œè¡¨"><a class="header" href="#rust-çš„å“ˆå¸Œè¡¨">Rust çš„å“ˆå¸Œè¡¨</a></h3>
<details id="admonition-å“ˆå¸Œè¡¨çš„æ ¸å¿ƒç‰¹ç‚¹ä¸è§£å†³" class="admonition info">
<summary class="admonition-title">
<p>å“ˆå¸Œè¡¨çš„æ ¸å¿ƒç‰¹ç‚¹ä¸è§£å†³</p>
<p><a class="admonition-anchor-link" href="#admonition-å“ˆå¸Œè¡¨çš„æ ¸å¿ƒç‰¹ç‚¹ä¸è§£å†³"></a></p>
</summary>
<div>
<p>å“ˆå¸Œè¡¨æœ€æ ¸å¿ƒçš„ç‰¹ç‚¹å°±æ˜¯ï¼šå·¨é‡çš„å¯èƒ½è¾“å…¥å’Œæœ‰é™çš„å“ˆå¸Œè¡¨å®¹é‡ã€‚è¿™å°±ä¼šå¼•å‘å“ˆå¸Œå†²çªï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªæˆ–è€…å¤šä¸ªè¾“å…¥çš„å“ˆå¸Œè¢«æ˜ å°„åˆ°äº†åŒä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦èƒ½å¤Ÿå¤„ç†å“ˆå¸Œå†²çªã€‚</p>
<p>è¦è§£å†³å†²çªï¼Œé¦–å…ˆå¯ä»¥é€šè¿‡æ›´å¥½çš„ã€åˆ†å¸ƒæ›´å‡åŒ€çš„å“ˆå¸Œå‡½æ•°ï¼Œä»¥åŠä½¿ç”¨æ›´å¤§çš„å“ˆå¸Œè¡¨æ¥ç¼“è§£å†²çªï¼Œä½†æ— æ³•å®Œå…¨è§£å†³ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨å†²çªè§£å†³æœºåˆ¶ã€‚</p>
</div>
</details>
<p>å¦‚ä½•è§£å†³å†²çªï¼Ÿ</p>
<p>ç†è®ºä¸Šï¼Œä¸»è¦çš„å†²çªè§£å†³æœºåˆ¶æœ‰é“¾åœ°å€æ³•ï¼ˆchainingï¼‰å’Œå¼€æ”¾å¯»å€æ³•ï¼ˆopen addressingï¼‰ã€‚</p>
<ul>
<li>é“¾åœ°å€æ³•ï¼Œæˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå°±æ˜¯æŠŠè½åœ¨åŒä¸€ä¸ªå“ˆå¸Œä¸Šçš„æ•°æ®ç”¨å•é“¾è¡¨æˆ–è€…åŒé“¾è¡¨è¿æ¥èµ·æ¥ã€‚è¿™æ ·åœ¨æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå…ˆæ‰¾åˆ°å¯¹åº”çš„å“ˆå¸Œæ¡¶ï¼ˆhash bucketï¼‰ï¼Œç„¶åå†åœ¨å†²çªé“¾ä¸ŠæŒ¨ä¸ªæ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„é¡¹ã€‚</li>
</ul>
<blockquote>
<p>å†²çªé“¾å¤„ç†å“ˆå¸Œå†²çªéå¸¸ç›´è§‚ï¼Œå¾ˆå®¹æ˜“ç†è§£å’Œæ’°å†™ä»£ç ï¼Œä½†ç¼ºç‚¹æ˜¯å“ˆå¸Œè¡¨å’Œå†²çªé“¾ä½¿ç”¨äº†ä¸åŒçš„å†…å­˜ï¼Œå¯¹ç¼“å­˜ä¸å‹å¥½ã€‚</p>
</blockquote>
<hr />
<h2 id="-1"><a class="header" href="#-1"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882976.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></a></h2>
<ul>
<li>
<p>å¼€æ”¾å¯»å€æ³•æŠŠæ•´ä¸ªå“ˆå¸Œè¡¨çœ‹åšä¸€ä¸ªå¤§æ•°ç»„ï¼Œä¸å¼•å…¥é¢å¤–çš„å†…å­˜ï¼Œå½“å†²çªäº§ç”Ÿæ—¶ï¼ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æŠŠæ•°æ®æ’å…¥åˆ°å…¶å®ƒç©ºé—²çš„ä½ç½®ã€‚æ¯”å¦‚çº¿æ€§æ¢å¯»ï¼ˆlinear probingï¼‰åœ¨å‡ºç°å“ˆå¸Œå†²çªæ—¶ï¼Œä¸æ–­å¾€åæ¢å¯»ï¼Œç›´åˆ°æ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ã€‚</p>
</li>
<li>
<p>è€ŒäºŒæ¬¡æ¢æŸ¥ï¼Œç†è®ºä¸Šæ˜¯åœ¨å†²çªå‘ç”Ÿæ—¶ï¼Œä¸æ–­æ¢å¯»å“ˆå¸Œä½ç½®åŠ å‡ n çš„äºŒæ¬¡æ–¹ï¼Œæ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ï¼Œæˆ‘ä»¬çœ‹å›¾ï¼Œæ›´å®¹æ˜“ç†è§£ï¼š</p>
</li>
</ul>
<hr />
<h2 id="-2"><a class="header" href="#-2"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882967.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></a></h2>
<blockquote>
<p>å›¾ä¸­ç¤ºæ„æ˜¯ç†è®ºä¸Šçš„å¤„ç†æ–¹æ³•ï¼Œå®é™…ä¸ºäº†æ€§èƒ½ä¼šæœ‰å¾ˆå¤šä¸åŒçš„å¤„ç†ã€‚</p>
</blockquote>
<h3 id="hashmap-çš„æ•°æ®ç»“æ„"><a class="header" href="#hashmap-çš„æ•°æ®ç»“æ„">HashMap çš„æ•°æ®ç»“æ„</a></h3>
<details id="admonition-æ·±å…¥rustå“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„hashmap-hashbrown-rawtable" class="admonition info">
<summary class="admonition-title">
<p>æ·±å…¥Rustå“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ï¼šHashMap-&gt;hashbrown-&gt;RawTable</p>
<p><a class="admonition-anchor-link" href="#admonition-æ·±å…¥rustå“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„hashmap-hashbrown-rawtable"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ Rust å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œæ‰“å¼€æ ‡å‡†åº“çš„ <a href="https://doc.rust-lang.org/src/std/collections/hash/map.rs.html#206-208">æºä»£ç </a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use hashbrown::hash_map as base;

#[derive(Clone)]
pub struct RandomState {
    k0: u64,
    k1: u64,
}

pub struct HashMap&lt;K, V, S = RandomState&gt; {
    base: base::HashMap&lt;K, V, S&gt;,
}
</code></pre></pre>
<hr />
<p>å¯ä»¥çœ‹åˆ°ï¼ŒHashMap æœ‰ä¸‰ä¸ªæ³›å‹å‚æ•°:</p>
<ol>
<li>K å’Œ V ä»£è¡¨ key / value çš„ç±»å‹</li>
<li>S æ˜¯å“ˆå¸Œç®—æ³•çš„çŠ¶æ€ï¼Œå®ƒé»˜è®¤æ˜¯ RandomStateï¼Œå ä¸¤ä¸ª u64ã€‚</li>
</ol>
<blockquote>
<p>RandomState ä½¿ç”¨ SipHash ä½œä¸ºç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼ˆcryptographically secure hashingï¼‰ã€‚</p>
</blockquote>
<p>ä»å®šä¹‰ä¸­è¿˜èƒ½çœ‹åˆ°ï¼ŒRust çš„ HashMap å¤ç”¨äº† hashbrown çš„ HashMap: 
hashbrown æ˜¯ Rust ä¸‹å¯¹ <a href="https://abseil.io/blog/20180927-swisstables">Google Swiss Table</a> çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆå®ç°ï¼Œæˆ‘ä»¬<a href="https://docs.rs/hashbrown/0.11.2/src/hashbrown/map.rs.html#192-195">æ‰“å¼€ hashbrown çš„ä»£ç </a>ï¼Œçœ‹å®ƒçš„ç»“æ„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">pub struct HashMap&lt;K, V, S = DefaultHashBuilder, A: Allocator + Clone = Global&gt; {
    pub(crate) hash_builder: S,
    pub(crate) table: RawTable&lt;(K, V), A&gt;,
}
</code></pre></pre>
<hr />
<p>å¯ä»¥çœ‹åˆ°ï¼ŒHashMap é‡Œæœ‰ä¸¤ä¸ªåŸŸ:</p>
<ol>
<li>ä¸€ä¸ªæ˜¯ hash_builderï¼Œç±»å‹æ˜¯åˆšæ‰æˆ‘ä»¬æåˆ°çš„æ ‡å‡†åº“ä½¿ç”¨çš„ RandomState</li>
<li>è¿˜æœ‰ä¸€ä¸ªæ˜¯å…·ä½“çš„ RawTableï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct RawTable&lt;T, A: Allocator + Clone = Global&gt; {
    table: RawTableInner&lt;A&gt;,
    // Tell dropck that we own instances of T.
    marker: PhantomData&lt;T&gt;,
}

struct RawTableInner&lt;A&gt; {
    // Mask to get an index from a hash value. The value is one less than the
    // number of buckets in the table.
    bucket_mask: usize,

    // [Padding], T1, T2, ..., Tlast, C1, C2, ...
    //                                ^ points here
    ctrl: NonNull&lt;u8&gt;,

    // Number of elements that can be inserted before we need to grow the table
    growth_left: usize,

    // Number of elements in the table, only really used by len()
    items: usize,

    alloc: A,
}
</code></pre></pre>
<p>RawTable ä¸­ï¼Œå®é™…ä¸Šæœ‰æ„ä¹‰çš„æ•°æ®ç»“æ„æ˜¯ RawTableInner:</p>
<blockquote>
<p>å‰å››ä¸ªå­—æ®µå¾ˆé‡è¦ï¼š</p>
</blockquote>
<ol>
<li>usize çš„ bucket_maskï¼Œæ˜¯å“ˆå¸Œè¡¨ä¸­å“ˆå¸Œæ¡¶çš„æ•°é‡å‡ä¸€ï¼›</li>
<li>åå­—å« ctrl çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘å“ˆå¸Œè¡¨å †å†…å­˜æœ«ç«¯çš„ ctrl åŒºï¼›</li>
<li>usize çš„å­—æ®µ growth_leftï¼ŒæŒ‡å“ˆå¸Œè¡¨åœ¨ä¸‹æ¬¡è‡ªåŠ¨å¢é•¿å‰è¿˜èƒ½å­˜å‚¨å¤šå°‘æ•°æ®ï¼›</li>
<li>Usize çš„ itemsï¼Œè¡¨æ˜å“ˆå¸Œè¡¨ç°åœ¨æœ‰å¤šå°‘æ•°æ®ã€‚</li>
</ol>
<blockquote>
<p>è¿™é‡Œæœ€åçš„ alloc å­—æ®µï¼Œå’Œ RawTable çš„ marker ä¸€æ ·ï¼Œåªæ˜¯ä¸€ä¸ªç”¨æ¥å ä½çš„ç±»å‹ï¼Œå®ƒç”¨æ¥åˆ†é…åœ¨å †ä¸Šçš„å†…å­˜ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="hashmap-çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•"><a class="header" href="#hashmap-çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•">HashMap çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</a></h3>
<details id="admonition-hashmapåŸºæœ¬ä½¿ç”¨æ–¹æ³•" class="admonition info">
<summary class="admonition-title">
<p>HashMapåŸºæœ¬ä½¿ç”¨æ–¹æ³•</p>
<p><a class="admonition-anchor-link" href="#admonition-hashmapåŸºæœ¬ä½¿ç”¨æ–¹æ³•"></a></p>
</summary>
<div>
<p>æ•°æ®ç»“æ„ææ¸…æ¥šï¼Œæˆ‘ä»¬å†çœ‹å…·ä½“ä½¿ç”¨æ–¹æ³•ã€‚Rust å“ˆå¸Œè¡¨çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—å¾ˆæ–¹ä¾¿çš„æ–¹æ³•ï¼Œä½¿ç”¨èµ·æ¥å’Œå…¶å®ƒè¯­è¨€éå¸¸ç±»ä¼¼ï¼Œä½ åªè¦çœ‹çœ‹æ–‡æ¡£ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬æ¥å†™æ®µä»£ç ï¼Œå°è¯•ä¸€ä¸‹ï¼ˆä»£ç ï¼‰ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::collections::HashMap;

fn main() {
    let mut map = HashMap::new();
    explain(&quot;empty&quot;, &amp;map);

    map.insert('a', 1);
    explain(&quot;added 1&quot;, &amp;map);

    map.insert('b', 2);
    map.insert('c', 3);
    explain(&quot;added 3&quot;, &amp;map);

    map.insert('d', 4);
    explain(&quot;added 4&quot;, &amp;map);

    // get æ—¶éœ€è¦ä½¿ç”¨å¼•ç”¨ï¼Œå¹¶ä¸”ä¹Ÿè¿”å›å¼•ç”¨
    assert_eq!(map.get(&amp;'a'), Some(&amp;1));
    assert_eq!(map.get_key_value(&amp;'b'), Some((&amp;'b', &amp;2)));

    map.remove(&amp;'a');
    // åˆ é™¤åå°±æ‰¾ä¸åˆ°äº†
    assert_eq!(map.contains_key(&amp;'a'), false);
    assert_eq!(map.get(&amp;'a'), None);
    explain(&quot;removed&quot;, &amp;map);
    // shrink åå“ˆå¸Œè¡¨å˜å°
    map.shrink_to_fit();
    explain(&quot;shrinked&quot;, &amp;map);
}

fn explain&lt;K, V&gt;(name: &amp;str, map: &amp;HashMap&lt;K, V&gt;) {
    println!(&quot;{}: len: {}, cap: {}&quot;, name, map.len(), map.capacity());
}
</code></pre></pre>
<hr />
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå½“ HashMap::new() æ—¶ï¼Œå®ƒå¹¶æ²¡æœ‰åˆ†é…ç©ºé—´ï¼Œå®¹é‡ä¸ºé›¶</li>
<li>éšç€å“ˆå¸Œè¡¨ä¸æ–­æ’å…¥æ•°æ®ï¼Œå®ƒä¼šä»¥ 2 çš„å¹‚å‡ä¸€çš„æ–¹å¼å¢é•¿ï¼Œæœ€å°æ˜¯ 3ã€‚</li>
<li>å½“åˆ é™¤è¡¨ä¸­çš„æ•°æ®æ—¶ï¼ŒåŸæœ‰çš„è¡¨å¤§å°ä¸å˜ï¼Œåªæœ‰æ˜¾å¼åœ°è°ƒç”¨ shrink_to_fitï¼Œæ‰ä¼šè®©å“ˆå¸Œè¡¨å˜å°ã€‚</li>
</ol>
</div>
</details>
<h3 id="hashmap-çš„å†…å­˜å¸ƒå±€"><a class="header" href="#hashmap-çš„å†…å­˜å¸ƒå±€">HashMap çš„å†…å­˜å¸ƒå±€</a></h3>
<details id="admonition-ctrlè¡¨çš„å˜åŒ–å€ŸåŠ©stdmemtransmuteæŸ¥çœ‹å†…å­˜å¸ƒå±€" class="admonition info">
<summary class="admonition-title">
<p>ctrlè¡¨çš„å˜åŒ–ï¼šå€ŸåŠ©std::mem::transmuteæŸ¥çœ‹å†…å­˜å¸ƒå±€</p>
<p><a class="admonition-anchor-link" href="#admonition-ctrlè¡¨çš„å˜åŒ–å€ŸåŠ©stdmemtransmuteæŸ¥çœ‹å†…å­˜å¸ƒå±€"></a></p>
</summary>
<div>
<p>é€šè¿‡ HashMap çš„å…¬å¼€æ¥å£æ— æ³•çœ‹åˆ° HashMap åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•å¸ƒå±€ï¼Œè¿˜æ˜¯éœ€è¦å€ŸåŠ© std::mem::transmute æ–¹æ³•ï¼Œæ¥æŠŠæ•°æ®ç»“æ„æ‰“å‡ºæ¥ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬æŠŠåˆšæ‰çš„ä»£ç æ”¹ä¸€æ”¹ï¼ˆä»£ç ï¼‰ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::collections::HashMap;

fn main() {
    let map = HashMap::new();
    let mut map = explain(&quot;empty&quot;, map);

    map.insert('a', 1);
    let mut map = explain(&quot;added 1&quot;, map);
    map.insert('b', 2);
    map.insert('c', 3);

    let mut map = explain(&quot;added 3&quot;, map);

    map.insert('d', 4);

    let mut map = explain(&quot;added 4&quot;, map);

    map.remove(&amp;'a');

    explain(&quot;final&quot;, map);
}

// HashMap ç»“æ„æœ‰ä¸¤ä¸ª u64 çš„ RandomStateï¼Œç„¶åæ˜¯å››ä¸ª usizeï¼Œ
// åˆ†åˆ«æ˜¯ bucket_mask, ctrl, growth_left å’Œ items
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain&lt;K, V&gt;(name: &amp;str, map: HashMap&lt;K, V&gt;) -&gt; HashMap&lt;K, V&gt; {
    let arr: [usize; 6] = unsafe { std::mem::transmute(map) };
    println!(
        &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
        name, arr[2], arr[3], arr[4], arr[5]
    );
    unsafe { std::mem::transmute(arr) }
}
</code></pre></pre>
<hr />
<p>è¿è¡Œä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code class="language-shell">empty: bucket_mask 0x0, ctrl 0x1056df820, growth_left: 0, items: 0

added 1: bucket_mask 0x3, ctrl 0x7fa0d1405e30, growth_left: 2, items: 1

added 3: bucket_mask 0x3, ctrl 0x7fa0d1405e30, growth_left: 0, items: 3

added 4: bucket_mask 0x7, ctrl 0x7fa0d1405e90, growth_left: 3, items: 4

final: bucket_mask 0x7, ctrl 0x7fa0d1405e90, growth_left: 4, items: 3
</code></pre>
<blockquote>
<p>å‘ç°åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œctrl å¯¹åº”çš„å †åœ°å€å‘ç”Ÿäº†æ”¹å˜ã€‚</p>
</blockquote>
<ul>
<li>åœ¨æˆ‘çš„ OS X ä¸‹ï¼Œä¸€å¼€å§‹å“ˆå¸Œè¡¨ä¸ºç©ºï¼Œctrl åœ°å€çœ‹ä¸Šå»æ˜¯ä¸€ä¸ª TEXT/RODATA æ®µçš„åœ°å€ï¼Œåº”è¯¥æ˜¯æŒ‡å‘äº†ä¸€ä¸ªé»˜è®¤çš„ç©ºè¡¨åœ°å€ï¼›</li>
<li>æ’å…¥ç¬¬ä¸€ä¸ªæ•°æ®åï¼Œå“ˆå¸Œè¡¨åˆ†é…äº† 4 ä¸ª bucketï¼Œctrl åœ°å€å‘ç”Ÿæ”¹å˜ï¼›</li>
<li>åœ¨æ’å…¥ä¸‰ä¸ªæ•°æ®åï¼Œgrowth_left ä¸ºé›¶</li>
<li>å†æ’å…¥æ—¶ï¼Œå“ˆå¸Œè¡¨é‡æ–°åˆ†é…ï¼Œctrl åœ°å€ç»§ç»­æ”¹å˜ã€‚</li>
</ul>
<blockquote>
<p>åœ¨æ¢ç´¢ HashMap æ•°æ®ç»“æ„æ—¶ï¼Œè¯´è¿‡ ctrl æ˜¯ä¸€ä¸ªæŒ‡å‘å“ˆå¸Œè¡¨å †åœ°å€æœ«ç«¯ ctrl åŒºçš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªåœ°å€ï¼Œè®¡ç®—å‡ºå“ˆå¸Œè¡¨å †åœ°å€çš„èµ·å§‹åœ°å€ã€‚</p>
</blockquote>
<p>å› ä¸ºå“ˆå¸Œè¡¨æœ‰ 8 ä¸ª bucketï¼ˆ0x7 + 1ï¼‰ï¼Œæ¯ä¸ª bucket å¤§å°æ˜¯ keyï¼ˆcharï¼‰ + valueï¼ˆi32ï¼‰ çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¸€å…±æ˜¯ 64 ä¸ªå­—èŠ‚ã€‚
å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œé€šè¿‡ ctrl åœ°å€å‡å» 64ï¼Œå°±å¯ä»¥å¾—åˆ°å“ˆå¸Œè¡¨çš„å †å†…å­˜èµ·å§‹åœ°å€ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ rust-gdb / rust-lldb æ¥æ‰“å°è¿™ä¸ªå†…å­˜ã€‚</p>
<blockquote>
<p>å¯ä»¥ç”¨ Linux ä¸‹çš„ rust-gdb è®¾ç½®æ–­ç‚¹ï¼Œä¾æ¬¡æŸ¥çœ‹å“ˆå¸Œè¡¨æœ‰ä¸€ä¸ªã€ä¸‰ä¸ªã€å››ä¸ªå€¼ï¼Œä»¥åŠåˆ é™¤ä¸€ä¸ªå€¼çš„çŠ¶æ€ï¼š</p>
</blockquote>
<pre><code class="language-shell">
â¯ rust-gdb ~/.target/debug/hashmap2
GNU gdb (Ubuntu 9.2-0ubuntu2) 9.2
...
(gdb) b hashmap2.rs:32
Breakpoint 1 at 0xa43e: file src/hashmap2.rs, line 32.
(gdb) r
Starting program: /home/tchen/.target/debug/hashmap2
...
# æœ€åˆçš„çŠ¶æ€ï¼Œå“ˆå¸Œè¡¨ä¸ºç©º
empty: bucket_mask 0x0, ctrl 0x555555597be0, growth_left: 0, items: 0

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) c
Continuing.
# æ’å…¥äº†ä¸€ä¸ªå…ƒç´ åï¼Œbucket æœ‰ 4 ä¸ªï¼ˆ0x3+1ï¼‰ï¼Œå †åœ°å€èµ·å§‹ä½ç½® 0x5555555a7af0 - 4*8(0x20)
added 1: bucket_mask 0x3, ctrl 0x5555555a7af0, growth_left: 2, items: 1

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x /12x 0x5555555a7ad0
0x5555555a7ad0:  0x00000061  0x00000001  0x00000000  0x00000000
0x5555555a7ae0:  0x00000000  0x00000000  0x00000000  0x00000000
0x5555555a7af0:  0x0affffff  0xffffffff  0xffffffff  0xffffffff
(gdb) c
Continuing.
# æ’å…¥äº†ä¸‰ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ²¡æœ‰å‰©ä½™ç©ºé—´ï¼Œå †åœ°å€èµ·å§‹ä½ç½®ä¸å˜ 0x5555555a7af0 - 4*8(0x20)
added 3: bucket_mask 0x3, ctrl 0x5555555a7af0, growth_left: 0, items: 3

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x /12x 0x5555555a7ad0
0x5555555a7ad0:  0x00000061  0x00000001  0x00000062  0x00000002
0x5555555a7ae0:  0x00000000  0x00000000  0x00000063  0x00000003
0x5555555a7af0:  0x0a72ff02  0xffffffff  0xffffffff  0xffffffff
(gdb) c
Continuing.
# æ’å…¥ç¬¬å››ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ‰©å®¹ï¼Œå †åœ°å€èµ·å§‹ä½ç½®å˜ä¸º 0x5555555a7b50 - 8*8(0x40)
added 4: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 3, items: 4

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x /20x 0x5555555a7b10
0x5555555a7b10:  0x00000061  0x00000001  0x00000000  0x00000000
0x5555555a7b20:  0x00000064  0x00000004  0x00000063  0x00000003
0x5555555a7b30:  0x00000000  0x00000000  0x00000062  0x00000002
0x5555555a7b40:  0x00000000  0x00000000  0x00000000  0x00000000
0x5555555a7b50:  0xff72ffff  0x0aff6502  0xffffffff  0xffffffff
(gdb) c
Continuing.
# åˆ é™¤ a åï¼Œå‰©ä½™ 4 ä¸ªä½ç½®ã€‚æ³¨æ„ ctrl bit çš„å˜åŒ–ï¼Œä»¥åŠ 0x61 0x1 å¹¶æ²¡æœ‰è¢«æ¸…é™¤
final: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 4, items: 3

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x /20x 0x5555555a7b10
0x5555555a7b10:  0x00000061  0x00000001  0x00000000  0x00000000
0x5555555a7b20:  0x00000064  0x00000004  0x00000063  0x00000003
0x5555555a7b30:  0x00000000  0x00000000  0x00000062  0x00000002
0x5555555a7b40:  0x00000000  0x00000000  0x00000000  0x00000000
0x5555555a7b50:  0xff72ffff  0xffff6502  0xffffffff  0xffffffff
</code></pre>
<hr />
<p>è¿™æ®µè¾“å‡ºè•´è—äº†å¾ˆå¤šä¿¡æ¯ï¼Œç»“åˆç¤ºæ„å›¾æ¥ä»”ç»†æ¢³ç†ã€‚</p>
<ol>
<li>é¦–å…ˆï¼Œæ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´  â€˜aâ€™: 1 åï¼Œå“ˆå¸Œè¡¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882958.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></p>
<ul>
<li>key â€˜aâ€™ çš„ hash å’Œ bucket_mask 0x3 è¿ç®—åå¾—åˆ°ç¬¬ 0 ä¸ªä½ç½®æ’å…¥ã€‚</li>
<li>åŒæ—¶ï¼Œè¿™ä¸ª hash çš„å¤´ 7 ä½å–å‡ºæ¥ï¼Œåœ¨ ctrl è¡¨ä¸­å¯¹åº”çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 0 ä¸ªå­—èŠ‚ï¼ŒæŠŠè¿™ä¸ªå€¼å†™å…¥ã€‚</li>
</ul>
<p>è¦ç†è§£è¿™ä¸ªæ­¥éª¤ï¼Œå…³é”®å°±æ˜¯è¦ææ¸…æ¥šè¿™ä¸ª ctrl è¡¨æ˜¯ä»€ä¹ˆã€‚</p>
</div>
</details>
<h3 id="ctrl-è¡¨"><a class="header" href="#ctrl-è¡¨">ctrl è¡¨</a></h3>
<details id="admonition-ctrl-è¡¨çš„ä¸»è¦ç›®çš„ä¸è®¾è®¡" class="admonition info">
<summary class="admonition-title">
<p>ctrl è¡¨çš„ä¸»è¦ç›®çš„ä¸è®¾è®¡</p>
<p><a class="admonition-anchor-link" href="#admonition-ctrl-è¡¨çš„ä¸»è¦ç›®çš„ä¸è®¾è®¡"></a></p>
</summary>
<div>
<p>ctrl è¡¨çš„ä¸»è¦ç›®çš„æ˜¯å¿«é€ŸæŸ¥æ‰¾ã€‚å®ƒçš„è®¾è®¡éå¸¸ä¼˜é›…ï¼Œå€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
<p>ä¸€å¼  ctrl è¡¨é‡Œ:</p>
<ul>
<li>æœ‰è‹¥å¹²ä¸ª 128bit æˆ–è€…è¯´ 16 ä¸ªå­—èŠ‚çš„åˆ†ç»„ï¼ˆgroupï¼‰</li>
<li>group é‡Œçš„æ¯ä¸ªå­—èŠ‚å« ctrl byteï¼Œå¯¹åº”ä¸€ä¸ª bucketï¼Œé‚£ä¹ˆä¸€ä¸ª group å¯¹åº” 16 ä¸ª bucketã€‚</li>
<li>å¦‚æœä¸€ä¸ª bucket å¯¹åº”çš„ ctrl byte é¦–ä½ä¸ä¸º 1ï¼Œå°±è¡¨ç¤ºè¿™ä¸ª ctrl byte è¢«ä½¿ç”¨ï¼›</li>
<li>å¦‚æœæ‰€æœ‰ä½éƒ½æ˜¯ 1ï¼Œæˆ–è€…è¯´è¿™ä¸ªå­—èŠ‚æ˜¯ 0xffï¼Œé‚£ä¹ˆå®ƒæ˜¯ç©ºé—²çš„ã€‚</li>
</ul>
<blockquote>
<p>ä¸€ç»„ control byte çš„æ•´ä¸ª 128 bit çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤è¢«åŠ è½½è¿›æ¥ï¼Œç„¶åå’ŒæŸä¸ªå€¼è¿›è¡Œ maskï¼Œæ‰¾åˆ°å®ƒæ‰€åœ¨çš„ä½ç½®ã€‚è¿™å°±æ˜¯HashMapçš„ SIMD æŸ¥è¡¨ã€‚</p>
</blockquote>
<blockquote>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œç°ä»£ CPU éƒ½æ”¯æŒå•æŒ‡ä»¤å¤šæ•°æ®é›†çš„æ“ä½œï¼Œè€Œ Rust å……åˆ†åˆ©ç”¨äº† CPU è¿™ç§èƒ½åŠ›ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥è®©å¤šä¸ªç›¸å…³çš„æ•°æ®è½½å…¥åˆ°ç¼“å­˜ä¸­å¤„ç†ï¼Œå¤§å¤§åŠ å¿«æŸ¥è¡¨çš„é€Ÿåº¦ã€‚æ‰€ä»¥ï¼ŒRust çš„å“ˆå¸Œè¡¨æŸ¥è¯¢çš„æ•ˆç‡éå¸¸é«˜ã€‚</p>
</blockquote>
<p>å…·ä½“æ€ä¹ˆæ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ HashMap æ˜¯å¦‚ä½•é€šè¿‡ ctrl è¡¨æ¥è¿›è¡Œæ•°æ®æŸ¥è¯¢çš„ã€‚</p>
<blockquote>
<p>å‡è®¾è¿™å¼ è¡¨é‡Œå·²ç»æ·»åŠ äº†ä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬ç°åœ¨è¦æŸ¥æ‰¾ key ä¸º â€˜câ€™ çš„æ•°æ®ï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882948.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></p>
<ol>
<li>æŠŠ h è·Ÿ bucket_mask åšä¸ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ï¼Œå›¾ä¸­æ˜¯ 139ï¼›</li>
<li>æ‹¿ç€è¿™ä¸ª 139ï¼Œæ‰¾åˆ°å¯¹åº”çš„ ctrl group çš„èµ·å§‹ä½ç½®ï¼Œå› ä¸º ctrl group ä»¥ 16 ä¸ºä¸€ç»„ï¼Œæ‰€ä»¥è¿™é‡Œæ‰¾åˆ° 128ï¼›</li>
<li>ç”¨ SIMD æŒ‡ä»¤åŠ è½½ä» 128 å¯¹åº”åœ°å€å¼€å§‹çš„ 16 ä¸ªå­—èŠ‚ï¼›</li>
<li>å¯¹ hash å–å¤´ 7 ä¸ª bitï¼Œç„¶åå’Œåˆšåˆšå–å‡ºçš„ 16 ä¸ªå­—èŠ‚ä¸€èµ·åšä¸ï¼Œæ‰¾åˆ°å¯¹åº”çš„åŒ¹é…ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå®ƒï¼ˆä»¬ï¼‰å¾ˆå¤§æ¦‚ç‡æ˜¯è¦æ‰¾çš„å€¼ï¼›</li>
<li>å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆä»¥äºŒæ¬¡æ¢æŸ¥ï¼ˆä»¥ 16 çš„å€æ•°ä¸æ–­ç´¯ç§¯ï¼‰çš„æ–¹å¼å¾€åæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚</li>
</ol>
<blockquote>
<p>æ‰€ä»¥ï¼Œå½“ HashMap æ’å…¥å’Œåˆ é™¤æ•°æ®ï¼Œä»¥åŠå› æ­¤å¯¼è‡´é‡æ–°åˆ†é…çš„æ—¶å€™ï¼Œä¸»è¦å·¥ä½œå°±æ˜¯åœ¨ç»´æŠ¤è¿™å¼  ctrl è¡¨å’Œæ•°æ®çš„å¯¹åº”ã€‚</p>
</blockquote>
<blockquote>
<p>å› ä¸º ctrl è¡¨æ˜¯æ‰€æœ‰æ“ä½œæœ€å…ˆè§¦åŠçš„å†…å­˜ï¼Œæ‰€ä»¥ï¼Œåœ¨ HashMap çš„ç»“æ„ä¸­ï¼Œå †å†…å­˜çš„æŒ‡é’ˆç›´æ¥æŒ‡å‘ ctrl è¡¨ï¼Œè€Œä¸æ˜¯æŒ‡å‘å †å†…å­˜çš„èµ·å§‹ä½ç½®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å†…å­˜çš„è®¿é—®ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿"><a class="header" href="#å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿">å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿</a></h3>
<details id="admonition-æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨åœ¨åŠ å…¥-d-4-æ—¶hash-mapæ˜¯å¦‚ä½•å¢é•¿çš„" class="admonition info">
<summary class="admonition-title">
<p>æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨ï¼Œåœ¨åŠ å…¥ â€˜dâ€™: 4 æ—¶ï¼Œhash mapæ˜¯å¦‚ä½•å¢é•¿çš„</p>
<p><a class="admonition-anchor-link" href="#admonition-æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨åœ¨åŠ å…¥-d-4-æ—¶hash-mapæ˜¯å¦‚ä½•å¢é•¿çš„"></a></p>
</summary>
<div>
<p>åœ¨æ’å…¥ç¬¬ä¸€æ¡æ•°æ®åï¼Œå“ˆå¸Œè¡¨åªæœ‰ 4 ä¸ª bucketï¼Œæ‰€ä»¥åªæœ‰å¤´ 4 ä¸ªå­—èŠ‚çš„ ctrl è¡¨æœ‰ç”¨ã€‚éšç€å“ˆå¸Œè¡¨çš„å¢é•¿ï¼Œbucket ä¸å¤Ÿï¼Œå°±ä¼šå¯¼è‡´é‡æ–°åˆ†é…ã€‚ç”±äº bucket_mask æ°¸è¿œæ¯” bucket æ•°é‡å°‘ 1ï¼Œæ‰€ä»¥æ’å…¥ä¸‰ä¸ªå…ƒç´ åå°±ä¼šé‡æ–°åˆ†é…ã€‚</p>
<p>æ ¹æ® rust-gdb ä¸­å¾—åˆ°çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬çœ‹æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨ï¼Œåœ¨åŠ å…¥ â€˜dâ€™: 4 æ—¶ï¼Œæ˜¯å¦‚ä½•å¢é•¿çš„: </p>
<ol>
<li>é¦–å…ˆï¼Œå“ˆå¸Œè¡¨ä¼šæŒ‰å¹‚æ‰©å®¹ï¼Œä» 4 ä¸ª bucket æ‰©å±•åˆ° 8 ä¸ª bucketã€‚</li>
</ol>
<p>è¿™ä¼šå¯¼è‡´åˆ†é…æ–°çš„å †å†…å­˜ï¼Œç„¶ååŸæ¥çš„ ctrl table å’Œå¯¹åº”çš„ kv æ•°æ®ä¼šè¢«ç§»åŠ¨åˆ°æ–°çš„å†…å­˜ä¸­ã€‚</p>
<ul>
<li>è¿™ä¸ªä¾‹å­é‡Œå› ä¸º char å’Œ i32 å®ç°äº† Copy traitï¼Œæ‰€ä»¥æ˜¯æ‹·è´ï¼›</li>
<li>å¦‚æœ key çš„ç±»å‹æ˜¯ Stringï¼Œé‚£ä¹ˆåªæœ‰ String çš„ 24 ä¸ªå­—èŠ‚ (ptr|cap|len) çš„ç»“æ„è¢«ç§»åŠ¨ï¼ŒString çš„å®é™…å†…å­˜ä¸éœ€è¦å˜åŠ¨ã€‚</li>
<li>åœ¨ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠå“ˆå¸Œçš„é‡åˆ†é…ã€‚</li>
<li>ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œâ€˜aâ€™ / â€˜câ€™ çš„ç›¸å¯¹ä½ç½®å’Œå®ƒä»¬çš„ ctrl byte æ²¡æœ‰å˜åŒ–ï¼Œä½†é‡æ–°åš hash åï¼Œâ€˜bâ€™ çš„ ctrl byte å’Œä½ç½®éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼š</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882903-4882936.jpg" alt="" /></p>
</div>
</details>
<h3 id="åˆ é™¤ä¸€ä¸ªå€¼"><a class="header" href="#åˆ é™¤ä¸€ä¸ªå€¼">åˆ é™¤ä¸€ä¸ªå€¼</a></h3>
<details id="admonition-å“ˆå¸Œè¡¨åˆ é™¤æ—¶å†…å­˜å¦‚ä½•é‡Šæ”¾" class="admonition info">
<summary class="admonition-title">
<p>å“ˆå¸Œè¡¨åˆ é™¤æ—¶å†…å­˜å¦‚ä½•é‡Šæ”¾ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-å“ˆå¸Œè¡¨åˆ é™¤æ—¶å†…å­˜å¦‚ä½•é‡Šæ”¾"></a></p>
</summary>
<div>
<p>æ˜ç™½äº†å“ˆå¸Œè¡¨æ˜¯å¦‚ä½•å¢é•¿çš„ï¼Œæˆ‘ä»¬å†æ¥çœ‹åˆ é™¤çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<p>å½“è¦åœ¨å“ˆå¸Œè¡¨ä¸­åˆ é™¤ä¸€ä¸ªå€¼æ—¶ï¼Œæ•´ä¸ªè¿‡ç¨‹å’ŒæŸ¥æ‰¾ç±»ä¼¼:</p>
<ol>
<li>å…ˆè¦æ‰¾åˆ°è¦è¢«åˆ é™¤çš„ key æ‰€åœ¨çš„ä½ç½®ã€‚</li>
<li>åœ¨æ‰¾åˆ°å…·ä½“ä½ç½®åï¼Œå¹¶ä¸éœ€è¦å®é™…æ¸…é™¤å†…å­˜ï¼Œåªéœ€è¦å°†å®ƒçš„ ctrl byte è®¾å› 0xffï¼ˆæˆ–è€…æ ‡è®°æˆåˆ é™¤çŠ¶æ€ï¼‰ã€‚è¿™æ ·ï¼Œè¿™ä¸ª bucket å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨äº†</li>
</ol>
<blockquote>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“ key/value æœ‰é¢å¤–çš„å†…å­˜æ—¶ï¼Œæ¯”å¦‚ Stringï¼Œå®ƒçš„å†…å­˜ä¸ä¼šç«‹å³å›æ”¶ï¼Œåªæœ‰åœ¨ä¸‹ä¸€æ¬¡å¯¹åº”çš„ bucket è¢«ä½¿ç”¨æ—¶ï¼Œè®© HashMap ä¸å†æ‹¥æœ‰è¿™ä¸ª String çš„æ‰€æœ‰æƒä¹‹åï¼Œè¿™ä¸ª String çš„å†…å­˜æ‰è¢«å›æ”¶ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢çš„ç¤ºæ„å›¾ï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882903.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿™å¹¶ä¸ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Œé¡¶å¤šæ˜¯å†…å­˜å ç”¨ç‡ç¨é«˜ä¸€äº›ã€‚ä½†æŸäº›æç«¯æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åœ¨å“ˆå¸Œè¡¨ä¸­æ·»åŠ å¤§é‡å†…å®¹ï¼Œåˆåˆ é™¤å¤§é‡å†…å®¹åè¿è¡Œï¼Œè¿™æ—¶ä½ å¯ä»¥é€šè¿‡ shrink_to_fit / shrink_to é‡Šæ”¾æ‰ä¸éœ€è¦çš„å†…å­˜ã€‚</p>
</div>
</details>
<h3 id="è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš-hash-key"><a class="header" href="#è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš-hash-key">è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš Hash key</a></h3>
<details id="admonition-è‡ªå®šä¹‰æ•°æ®ç»“æ„éœ€è¦å®ç°hashpartialeqeqè¿™ä¸‰ä¸ªtrait" class="admonition info">
<summary class="admonition-title">
<p>è‡ªå®šä¹‰æ•°æ®ç»“æ„éœ€è¦å®ç°Hashã€PartialEqã€Eqè¿™ä¸‰ä¸ªtrait</p>
<p><a class="admonition-anchor-link" href="#admonition-è‡ªå®šä¹‰æ•°æ®ç»“æ„éœ€è¦å®ç°hashpartialeqeqè¿™ä¸‰ä¸ªtrait"></a></p>
</summary>
<div>
<p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„æˆä¸º HashMap çš„ keyã€‚æ­¤æ—¶ï¼Œè¦ä½¿ç”¨åˆ°ä¸‰ä¸ª traitï¼š<a href="https://doc.rust-lang.org/std/hash/trait.Hash.html">Hash</a>ã€<a href="https://doc.rust-lang.org/std/cmp/trait.PartialEq.html">PartialEq</a>ã€<a href="https://doc.rust-lang.org/std/cmp/trait.Eq.html">Eq</a>ï¼Œä¸è¿‡è¿™ä¸‰ä¸ª trait éƒ½å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®è‡ªåŠ¨ç”Ÿæˆã€‚å…¶ä¸­ï¼š</p>
<ol>
<li>å®ç°äº† Hash ï¼Œå¯ä»¥è®©æ•°æ®ç»“æ„è®¡ç®—å“ˆå¸Œï¼›</li>
<li>å®ç°äº† PartialEq/Eqï¼Œå¯ä»¥è®©æ•°æ®ç»“æ„è¿›è¡Œç›¸ç­‰å’Œä¸ç›¸ç­‰çš„æ¯”è¾ƒã€‚</li>
<li>Eq å®ç°äº†æ¯”è¾ƒçš„è‡ªåæ€§ï¼ˆa == aï¼‰ã€å¯¹ç§°æ€§ï¼ˆa == b åˆ™ b == aï¼‰ä»¥åŠä¼ é€’æ€§ï¼ˆa == bï¼Œb == cï¼Œåˆ™ a == cï¼‰</li>
<li>PartialEq æ²¡æœ‰å®ç°è‡ªåæ€§ã€‚</li>
</ol>
<p>æˆ‘ä»¬å¯ä»¥å†™ä¸ªä¾‹å­ï¼Œçœ‹çœ‹è‡ªå®šä¹‰æ•°æ®ç»“æ„å¦‚ä½•æ”¯æŒ HashMapï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{
    collections::{hash_map::DefaultHasher, HashMap},
    hash::{Hash, Hasher},
};

// å¦‚æœè¦æ”¯æŒ Hashï¼Œå¯ä»¥ç”¨ #[derive(Hash)]ï¼Œå‰ææ˜¯æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Hash
// å¦‚æœè¦èƒ½ä½œä¸º HashMap çš„ keyï¼Œè¿˜éœ€è¦ PartialEq å’Œ Eq
#[derive(Debug, Hash, PartialEq, Eq)]
struct Student&lt;'a&gt; {
    name: &amp;'a str,
    age: u8,
}

impl&lt;'a&gt; Student&lt;'a&gt; {
    pub fn new(name: &amp;'a str, age: u8) -&gt; Self {
        Self { name, age }
    }
}
fn main() {
    let mut hasher = DefaultHasher::new();
    let student = Student::new(&quot;Tyr&quot;, 18);
    // å®ç°äº† Hash çš„æ•°æ®ç»“æ„å¯ä»¥ç›´æ¥è°ƒç”¨ hash æ–¹æ³•
    student.hash(&amp;mut hasher);
    let mut map = HashMap::new();
    // å®ç°äº† Hash / PartialEq / Eq çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º HashMap çš„ key
    map.insert(student, vec![&quot;Math&quot;, &quot;Writing&quot;]);
    println!(&quot;hash: 0x{:x}, map: {:?}&quot;, hasher.finish(), map);
}
</code></pre></pre>
</div>
</details>
<h3 id="hashset--btreemap--btreeset"><a class="header" href="#hashset--btreemap--btreeset">HashSet / BTreeMap / BTreeSet</a></h3>
<details id="admonition-hashsetåªç”¨äºç¡®è®¤å­˜åœ¨å­˜æ”¾æ— åºé›†åˆ" class="admonition info">
<summary class="admonition-title">
<p>HashSetåªç”¨äºç¡®è®¤å­˜åœ¨ï¼Œå­˜æ”¾æ— åºé›†åˆ</p>
<p><a class="admonition-anchor-link" href="#admonition-hashsetåªç”¨äºç¡®è®¤å­˜åœ¨å­˜æ”¾æ— åºé›†åˆ"></a></p>
</summary>
<div>
<p>æœ‰æ—¶æˆ‘ä»¬åªéœ€è¦ç®€å•ç¡®è®¤å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœç”¨ HashMap å°±æœ‰äº›æµªè´¹ç©ºé—´äº†ã€‚è¿™æ—¶å¯ä»¥ç”¨ HashSetï¼Œå®ƒå°±æ˜¯ç®€åŒ–çš„ HashMapï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æ— åºçš„é›†åˆï¼Œå®šä¹‰ç›´æ¥æ˜¯ HashMap&lt;K, ()&gt;ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use hashbrown::hash_set as base;

pub struct HashSet&lt;T, S = RandomState&gt; {
    base: base::HashSet&lt;T, S&gt;,
}

pub struct HashSet&lt;T, S = DefaultHashBuilder, A: Allocator + Clone = Global&gt; {
    pub(crate) map: HashMap&lt;T, (), S, A&gt;,
}
</code></pre></pre>
<blockquote>
<p>ä½¿ç”¨ HashSet æŸ¥çœ‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºé›†åˆçš„æ•ˆç‡éå¸¸é«˜ã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-btreemapå’Œbtreesetéƒ½æ˜¯ç”¨äºæŸ¥æ‰¾å­˜æ”¾æœ‰åºé›†åˆ" class="admonition info">
<summary class="admonition-title">
<p>BTreeMapå’ŒBTreeSetéƒ½æ˜¯ç”¨äºæŸ¥æ‰¾ï¼Œå­˜æ”¾æœ‰åºé›†åˆ</p>
<p><a class="admonition-anchor-link" href="#admonition-btreemapå’Œbtreesetéƒ½æ˜¯ç”¨äºæŸ¥æ‰¾å­˜æ”¾æœ‰åºé›†åˆ"></a></p>
</summary>
<div>
<p>BTreeMap æ˜¯å†…éƒ¨ä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/B-tree">B-tree</a> æ¥ç»„ç»‡å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ã€‚å¦å¤– BTreeSet å’Œ HashSet ç±»ä¼¼ï¼Œæ˜¯ BTreeMap çš„ç®€åŒ–ç‰ˆï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æœ‰åºé›†åˆã€‚
æˆ‘ä»¬è¿™é‡Œé‡ç‚¹çœ‹ä¸‹ BTreeMapï¼Œå®ƒçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct BTreeMap&lt;K, V&gt; {
    root: Option&lt;Root&lt;K, V&gt;&gt;,
    length: usize,
}

pub type Root&lt;K, V&gt; = NodeRef&lt;marker::Owned, K, V, marker::LeafOrInternal&gt;;

pub struct NodeRef&lt;BorrowType, K, V, Type&gt; {
    height: usize,
    node: NonNull&lt;LeafNode&lt;K, V&gt;&gt;,
    _marker: PhantomData&lt;(BorrowType, Type)&gt;,
}

struct LeafNode&lt;K, V&gt; {
    parent: Option&lt;NonNull&lt;InternalNode&lt;K, V&gt;&gt;&gt;,
    parent_idx: MaybeUninit&lt;u16&gt;,
    len: u16,
    keys: [MaybeUninit&lt;K&gt;; CAPACITY],
    vals: [MaybeUninit&lt;V&gt;; CAPACITY],
}

struct InternalNode&lt;K, V&gt; {
    data: LeafNode&lt;K, V&gt;,
    edges: [MaybeUninit&lt;BoxedNode&lt;K, V&gt;&gt;; 2 * B],
}
</code></pre></pre>
<blockquote>
<p>å’Œ HashMap ä¸åŒçš„æ˜¯ï¼ŒBTreeMap æ˜¯æœ‰åºçš„ã€‚æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰:</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::collections::BTreeMap;

fn main() {
    let map = BTreeMap::new();
    let mut map = explain(&quot;empty&quot;, map);

    for i in 0..16usize {
        map.insert(format!(&quot;Tyr {}&quot;, i), i);
    }

    let mut map = explain(&quot;added&quot;, map);

    map.remove(&quot;Tyr 1&quot;);

    let map = explain(&quot;remove 1&quot;, map);

    for item in map.iter() {
        println!(&quot;{:?}&quot;, item);
    }
}

// BTreeMap ç»“æ„æœ‰ heightï¼Œnode å’Œ length
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain&lt;K, V&gt;(name: &amp;str, map: BTreeMap&lt;K, V&gt;) -&gt; BTreeMap&lt;K, V&gt; {
    let arr: [usize; 3] = unsafe { std::mem::transmute(map) };
    println!(
        &quot;{}: height: {}, root node: 0x{:x}, len: 0x{:x}&quot;,
        name, arr[0], arr[1], arr[2]
    );
    unsafe { std::mem::transmute(arr) }
}
</code></pre></pre>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨éå†æ—¶ï¼ŒBTreeMap ä¼šæŒ‰ç…§ key çš„é¡ºåºæŠŠå€¼æ‰“å°å‡ºæ¥ã€‚å¦‚æœä½ æƒ³è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º BTreeMap çš„ keyï¼Œé‚£ä¹ˆéœ€è¦å®ç° PartialOrd å’Œ Ordï¼Œè¿™ä¸¤è€…çš„å…³ç³»å’Œ PartialEq / Eq ç±»ä¼¼ï¼ŒPartialOrd ä¹Ÿæ²¡æœ‰å®ç°è‡ªåæ€§ã€‚åŒæ ·çš„ï¼ŒPartialOrd å’Œ Ord ä¹Ÿå¯ä»¥é€šè¿‡æ´¾ç”Ÿå®æ¥å®ç°ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="ä¸ºä»€ä¹ˆ-rust-çš„-hashmap-è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•"><a class="header" href="#ä¸ºä»€ä¹ˆ-rust-çš„-hashmap-è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•">ä¸ºä»€ä¹ˆ Rust çš„ HashMap è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Ÿ</a></h3>
<details id="admonition-ä¸ºä»€ä¹ˆ-rust-çš„-hashmap-è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•" class="admonition info">
<summary class="admonition-title">
<p>ä¸ºä»€ä¹ˆ Rust çš„ HashMap è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸ºä»€ä¹ˆ-rust-çš„-hashmap-è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨åœ¨è½¯ä»¶ç³»ç»Ÿä¸­çš„é‡è¦åœ°ä½ï¼Œä½†å“ˆå¸Œè¡¨åœ¨æœ€åæƒ…å†µä¸‹ï¼Œå¦‚æœç»å¤§å¤šæ•° key çš„ hash éƒ½ç¢°æ’åœ¨ä¸€èµ·ï¼Œæ€§èƒ½ä¼šåˆ° O(n)ï¼Œè¿™ä¼šæå¤§æ‹–ç´¯ç³»ç»Ÿçš„æ•ˆç‡ã€‚</p>
<p>æ¯”å¦‚ 1M å¤§å°çš„ session è¡¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹æŸ¥è¡¨é€Ÿåº¦æ˜¯ O(1)ï¼Œä½†æç«¯æƒ…å†µä¸‹ï¼Œéœ€è¦æ¯”è¾ƒ 1M ä¸ªæ•°æ®åæ‰èƒ½æ‰¾åˆ°ï¼Œè¿™æ ·çš„ç³»ç»Ÿå°±å®¹æ˜“è¢« DoS æ”»å‡»ã€‚æ‰€ä»¥å¦‚æœä¸æ˜¯åŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼Œåªè¦é»‘å®¢çŸ¥é“å“ˆå¸Œç®—æ³•ï¼Œå°±å¯ä»¥æ„é€ å‡ºå¤§é‡çš„ key äº§ç”Ÿè¶³å¤Ÿå¤šçš„å“ˆå¸Œç¢°æ’ï¼Œé€ æˆç›®æ ‡ç³»ç»Ÿ DoSã€‚</p>
<p>SipHash å°±æ˜¯ä¸ºäº†å›åº” DoS æ”»å‡»è€Œåˆ›å»ºçš„å“ˆå¸Œç®—æ³•ï¼Œè™½ç„¶å’Œ sha2 è¿™æ ·çš„åŠ å¯†å“ˆå¸Œä¸åŒï¼ˆä¸è¦å°† SipHash ç”¨äºåŠ å¯†ï¼ï¼‰ï¼Œä½†å®ƒå¯ä»¥æä¾›ç±»ä¼¼ç­‰çº§çš„å®‰å…¨æ€§ã€‚æŠŠ SipHash ä½œä¸º HashMap çš„ç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼ŒRust å¯ä»¥é¿å…å¼€å‘è€…åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è¢« DoSï¼Œå°±åƒæ›¾ç»åœ¨ Web ä¸–ç•Œå‘ç”Ÿçš„é‚£æ ·ã€‚
å½“ç„¶ï¼Œè¿™ä¸€åˆ‡çš„ä»£ä»·æ˜¯æ€§èƒ½æŸè€—ï¼Œè™½ç„¶ SipHash éå¸¸å¿«ï¼Œä½†å®ƒæ¯” hashbrown ç¼ºçœä½¿ç”¨çš„ Ahash æ…¢äº†ä¸å°‘ã€‚å¦‚æœä½ ç¡®å®šä½¿ç”¨çš„ HashMap ä¸éœ€è¦ DoS é˜²æŠ¤ï¼ˆæ¯”å¦‚ä¸€ä¸ªå®Œå…¨å†…éƒ¨ä½¿ç”¨çš„ HashMapï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ Ahash æ¥æ›¿æ¢ã€‚ä½ åªéœ€è¦ä½¿ç”¨ Ahash æä¾›çš„ RandomState å³å¯ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use ahash::{AHasher, RandomState};
use std::collections::HashMap;
let mut map: HashMap&lt;char, i32, RandomState&gt; = HashMap::default();
map.insert('a', 1);
</code></pre></pre>
</div>
</details>
<h1 id="ä¸‰é”™è¯¯å¤„ç†"><a class="header" href="#ä¸‰é”™è¯¯å¤„ç†">ä¸‰ã€é”™è¯¯å¤„ç†</a></h1>
<h2 id="é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†"><a class="header" href="#é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†">é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†</a></h2>
<details id="admonition-é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†" class="admonition info">
<summary class="admonition-title">
<p>é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†</p>
<p><a class="admonition-anchor-link" href="#admonition-é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†"></a></p>
</summary>
<div>
<p>åœ¨ä¸€é—¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ§åˆ¶æµç¨‹æ˜¯è¯­è¨€çš„æ ¸å¿ƒæµç¨‹ï¼Œè€Œé”™è¯¯å¤„ç†åˆæ˜¯æ§åˆ¶æµç¨‹çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p>
<p>è¯­è¨€ä¼˜ç§€çš„é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œä¼šå¤§å¤§å‡å°‘é”™è¯¯å¤„ç†å¯¹æ•´ä½“æµç¨‹çš„ç ´åï¼Œè®©æˆ‘ä»¬å†™ä»£ç æ›´è¡Œäº‘æµæ°´ï¼Œè¯»èµ·æ¥å¿ƒæ™ºè´Ÿæ‹…ä¹Ÿæ›´å°ã€‚</p>
<p>å¯¹æˆ‘ä»¬å¼€å‘è€…æ¥è¯´ï¼Œé”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†ï¼š</p>
<ol>
<li>é”™è¯¯æ•è·åï¼Œå¯ä»¥ç«‹åˆ»å¤„ç†</li>
<li>ä¹Ÿå¯ä»¥å»¶è¿Ÿåˆ°ä¸å¾—ä¸å¤„ç†çš„åœ°æ–¹å†å¤„ç†ï¼Œè¿™å°±æ¶‰åŠåˆ°é”™è¯¯çš„ä¼ æ’­ï¼ˆpropagateï¼‰ã€‚</li>
<li>æœ€åï¼Œæ ¹æ®ä¸åŒçš„é”™è¯¯ç±»å‹ï¼Œç»™ç”¨æˆ·è¿”å›åˆé€‚çš„ã€å¸®åŠ©ä»–ä»¬ç†è§£é—®é¢˜æ‰€åœ¨çš„é”™è¯¯æ¶ˆæ¯ã€‚</li>
</ol>
<hr />
<h2 id="-3"><a class="header" href="#-3"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895295.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></a></h2>
<blockquote>
<p>ä½œä¸ºä¸€é—¨æå…¶æ³¨é‡ç”¨æˆ·ä½“éªŒçš„ç¼–ç¨‹è¯­è¨€ï¼ŒRust ä»å…¶å®ƒä¼˜ç§€çš„è¯­è¨€ä¸­ï¼Œå°¤å…¶æ˜¯ Haskell ï¼Œå¸æ”¶äº†é”™è¯¯å¤„ç†çš„ç²¾é«“ï¼Œå¹¶ä»¥è‡ªå·±ç‹¬åˆ°çš„æ–¹å¼å±•ç°å‡ºæ¥ã€‚</p>
</blockquote>
</div>
</details>
<h2 id="é”™è¯¯å¤„ç†çš„ä¸»æµæ–¹æ³•"><a class="header" href="#é”™è¯¯å¤„ç†çš„ä¸»æµæ–¹æ³•">é”™è¯¯å¤„ç†çš„ä¸»æµæ–¹æ³•</a></h2>
<details id="admonition-é”™è¯¯å¤„ç†çš„ä¸‰ç§ä¸»æµæ–¹æ³•ä»¥åŠå…¶ä»–è¯­è¨€æ˜¯å¦‚ä½•åº”ç”¨è¿™äº›æ–¹æ³•çš„" class="admonition info">
<summary class="admonition-title">
<p>é”™è¯¯å¤„ç†çš„ä¸‰ç§ä¸»æµæ–¹æ³•ä»¥åŠå…¶ä»–è¯­è¨€æ˜¯å¦‚ä½•åº”ç”¨è¿™äº›æ–¹æ³•çš„ã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-é”™è¯¯å¤„ç†çš„ä¸‰ç§ä¸»æµæ–¹æ³•ä»¥åŠå…¶ä»–è¯­è¨€æ˜¯å¦‚ä½•åº”ç”¨è¿™äº›æ–¹æ³•çš„"></a></p>
</summary>
<div>
<ol>
<li>ä½¿ç”¨è¿”å›å€¼ï¼ˆé”™è¯¯ç ï¼‰</li>
</ol>
<p>ä½¿ç”¨è¿”å›å€¼æ¥è¡¨å¾é”™è¯¯ï¼Œæ˜¯æœ€å¤è€ä¹Ÿæ˜¯æœ€å®ç”¨çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒçš„ä½¿ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œä»å‡½æ•°è¿”å›å€¼ï¼Œåˆ°æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨çš„é”™è¯¯ç  errnoã€è¿›ç¨‹é€€å‡ºçš„é”™è¯¯ç  retvalï¼Œç”šè‡³ HTTP API çš„çŠ¶æ€ç ï¼Œéƒ½èƒ½çœ‹åˆ°è¿™ç§æ–¹æ³•çš„èº«å½±ã€‚</p>
<blockquote>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ C è¯­è¨€ä¸­ï¼Œå¦‚æœ fopen(filename) æ— æ³•æ‰“å¼€æ–‡ä»¶ï¼Œä¼šè¿”å› NULLï¼Œè°ƒç”¨è€…é€šè¿‡åˆ¤æ–­è¿”å›å€¼æ˜¯å¦ä¸º NULLï¼Œæ¥è¿›è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†ã€‚</p>
</blockquote>
<blockquote>
<p>æˆ‘ä»¬å†çœ‹ä¸ªä¾‹å­ï¼š</p>
</blockquote>
<pre><code class="language-c">
size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream)
</code></pre>
<p>å•çœ‹è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¾ˆéš¾ç›´è§‚äº†è§£ï¼Œå½“è¯»æ–‡ä»¶å‡ºé”™æ—¶ï¼Œé”™è¯¯æ˜¯å¦‚ä½•è¿”å›çš„ã€‚ä»æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥ï¼Œå¦‚æœè¿”å›çš„ size_t å’Œä¼ å…¥çš„ size_t ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆè¦ä¹ˆå‘ç”Ÿäº†é”™è¯¯ï¼Œè¦ä¹ˆæ˜¯è¯»åˆ°æ–‡ä»¶å°¾ï¼ˆEOFï¼‰ï¼Œè°ƒç”¨è€…è¦è¿›ä¸€æ­¥é€šè¿‡ ferror æ‰èƒ½å¾—åˆ°æ›´è¯¦ç»†çš„é”™è¯¯ã€‚</p>
<p>åƒ C è¿™æ ·ï¼Œé€šè¿‡è¿”å›å€¼æºå¸¦é”™è¯¯ä¿¡æ¯ï¼Œæœ‰å¾ˆå¤šå±€é™ã€‚è¿”å›å€¼æœ‰å®ƒåŸæœ¬çš„è¯­ä¹‰ï¼Œå¼ºè¡ŒæŠŠé”™è¯¯ç±»å‹åµŒå…¥åˆ°è¿”å›å€¼åŸæœ¬çš„è¯­ä¹‰ä¸­ï¼Œéœ€è¦å…¨é¢ä¸”å®æ—¶æ›´æ–°çš„æ–‡æ¡£ï¼Œæ¥ç¡®ä¿å¼€å‘è€…èƒ½æ­£ç¡®åŒºåˆ«å¯¹å¾…ï¼Œæ­£å¸¸è¿”å›å’Œé”™è¯¯è¿”å›ã€‚</p>
<p>æ‰€ä»¥ Golang å¯¹å…¶åšäº†æ‰©å±•ï¼Œåœ¨å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œå¯ä»¥ä¸“é—¨æºå¸¦ä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚æ¯”å¦‚ä¸Šæ–‡çš„ freadï¼Œåœ¨ Golang ä¸‹å¯ä»¥è¿™ä¹ˆå®šä¹‰ï¼š</p>
<pre><code class="language-go">
func Fread(file *File, b []byte) (n int, err error)
</code></pre>
<p>Golang è¿™æ ·ï¼ŒåŒºåˆ†å¼€é”™è¯¯è¿”å›å’Œæ­£å¸¸è¿”å›ï¼Œç›¸å¯¹ C æ¥è¯´è¿›äº†ä¸€å¤§æ­¥ã€‚</p>
<blockquote>
<p>ä½†æ˜¯ä½¿ç”¨è¿”å›å€¼çš„æ–¹å¼ï¼Œå§‹ç»ˆæœ‰ä¸ªè‡´å‘½çš„é—®é¢˜ï¼šåœ¨è°ƒç”¨è€…è°ƒç”¨æ—¶ï¼Œé”™è¯¯å°±å¿…é¡»å¾—åˆ°å¤„ç†æˆ–è€…æ˜¾å¼çš„ä¼ æ’­ã€‚</p>
</blockquote>
<p>å¦‚æœå‡½æ•° A è°ƒç”¨äº†å‡½æ•° Bï¼Œåœ¨ A è¿”å›é”™è¯¯çš„æ—¶å€™ï¼Œå°±è¦æŠŠ B çš„é”™è¯¯è½¬æ¢æˆ A çš„é”™è¯¯ï¼Œæ˜¾ç¤ºå‡ºæ¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895283.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<p>è¿™æ ·å†™å‡ºæ¥çš„ä»£ç ä¼šéå¸¸å†—é•¿ï¼Œå¯¹æˆ‘ä»¬å¼€å‘è€…çš„ç”¨æˆ·ä½“éªŒä¸å¤ªå¥½ã€‚å¦‚æœä¸å¤„ç†ï¼Œåˆä¼šä¸¢æ‰è¿™ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œé€ æˆéšæ‚£ã€‚</p>
<p>å¦å¤–ï¼Œå¤§éƒ¨åˆ†ç”Ÿäº§ç¯å¢ƒä¸‹çš„é”™è¯¯æ˜¯åµŒå¥—çš„ã€‚ä¸€ä¸ª SQL æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºçš„é”™è¯¯ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨å‡ºé”™ï¼Œè€Œæ›´æ·±å±‚æ¬¡çš„é”™è¯¯å¯èƒ½æ˜¯ï¼Œè¿æ¥æ•°æ®åº“æœåŠ¡å™¨çš„ TLS session çŠ¶æ€å¼‚å¸¸ã€‚</p>
<p>å…¶å®çŸ¥é“æœåŠ¡å™¨å‡ºé”™ä¹‹å¤–ï¼Œæˆ‘ä»¬æ›´éœ€è¦æ¸…æ¥šæœåŠ¡å™¨å‡ºé”™çš„å†…åœ¨åŸå› ã€‚</p>
<ul>
<li>å› ä¸ºæœåŠ¡å™¨å‡ºé”™è¿™ä¸ªè¡¨å±‚é”™è¯¯ä¼šæä¾›ç»™æœ€ç»ˆç”¨æˆ·ï¼Œè€Œå‡ºé”™çš„æ·±å±‚åŸå› è¦æä¾›ç»™æˆ‘ä»¬è‡ªå·±ï¼ŒæœåŠ¡çš„ç»´æŠ¤è€…ã€‚</li>
<li>ä½†æ˜¯è¿™æ ·çš„åµŒå¥—é”™è¯¯åœ¨ C / Golang éƒ½æ˜¯å¾ˆéš¾å®Œç¾è¡¨è¿°çš„ã€‚</li>
</ul>
<hr />
<ol start="2">
<li>ä½¿ç”¨å¼‚å¸¸</li>
</ol>
<p>å› ä¸ºè¿”å›å€¼ä¸åˆ©äºé”™è¯¯çš„ä¼ æ’­ï¼Œæœ‰è¯¸å¤šé™åˆ¶ï¼ŒJava ç­‰å¾ˆå¤šè¯­è¨€ä½¿ç”¨å¼‚å¸¸æ¥å¤„ç†é”™è¯¯ã€‚</p>
<p>ä½ å¯ä»¥æŠŠå¼‚å¸¸çœ‹æˆä¸€ç§å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰ï¼š</p>
<ol>
<li>é”™è¯¯çš„äº§ç”Ÿå’Œé”™è¯¯çš„å¤„ç†å®Œå…¨è¢«åˆ†éš”å¼€</li>
<li>è°ƒç”¨è€…ä¸å¿…å…³å¿ƒé”™è¯¯ï¼Œè€Œè¢«è°ƒè€…ä¹Ÿä¸å¼ºæ±‚è°ƒç”¨è€…å…³å¿ƒé”™è¯¯ã€‚</li>
</ol>
<ul>
<li>ç¨‹åºä¸­ä»»ä½•å¯èƒ½å‡ºé”™çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼›</li>
<li>è€Œå¼‚å¸¸å¯ä»¥é€šè¿‡æ ˆå›æº¯ï¼ˆstack unwindï¼‰è¢«ä¸€å±‚å±‚è‡ªåŠ¨ä¼ é€’ï¼Œç›´åˆ°é‡åˆ°æ•è·å¼‚å¸¸çš„åœ°æ–¹ï¼Œ</li>
<li>å¦‚æœå›æº¯åˆ° main å‡½æ•°è¿˜æ— äººæ•è·ï¼Œç¨‹åºå°±ä¼šå´©æºƒã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895270.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<p>ä½¿ç”¨å¼‚å¸¸æ¥è¿”å›é”™è¯¯å¯ä»¥æå¤§åœ°ç®€åŒ–é”™è¯¯å¤„ç†çš„æµç¨‹ï¼Œå®ƒè§£å†³äº†è¿”å›å€¼çš„ä¼ æ’­é—®é¢˜ã€‚</p>
<p>ç„¶è€Œï¼Œä¸Šå›¾ä¸­å¼‚å¸¸è¿”å›çš„è¿‡ç¨‹çœ‹ä¸Šå»å¾ˆç›´è§‚ï¼Œå°±åƒæ•°æ®åº“ä¸­çš„äº‹åŠ¡ï¼ˆtransactionï¼‰åœ¨å‡ºé”™æ—¶ä¼šè¢«æ•´ä½“æ’¤é”€ï¼ˆrollbackï¼‰ä¸€æ ·ã€‚</p>
<blockquote>
<p>ä½†å®é™…ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹è¿œæ¯”ä½ æƒ³è±¡çš„å¤æ‚ï¼Œè€Œä¸”éœ€è¦é¢å¤–æ“å¿ƒ<a href="https://www.lighterra.com/papers/exceptionsharmful/">å¼‚å¸¸å®‰å…¨ï¼ˆexception safetyï¼‰</a>ã€‚
æˆ‘ä»¬çœ‹ä¸‹é¢ç”¨æ¥åˆ‡æ¢èƒŒæ™¯å›¾ç‰‡çš„ï¼ˆä¼ªï¼‰ä»£ç ï¼š</p>
</blockquote>
<pre><code class="language-c++">
void transition(...) {
  lock(&amp;mutex);
  delete background;
  ++changed;
  background = new Background(...);
  unlock(&amp;mutex);
}
</code></pre>
<p>è¯•æƒ³, å¦‚æœåœ¨åˆ›å»ºæ–°çš„èƒŒæ™¯æ—¶å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œä¼šè·³è¿‡åç»­çš„å¤„ç†æµç¨‹ï¼Œä¸€è·¯æ ˆå›æº¯åˆ° try catch çš„ä»£ç ï¼Œé‚£ä¹ˆï¼Œè¿™é‡Œé”ä½çš„ mutex æ— æ³•å¾—åˆ°é‡Šæ”¾ï¼Œè€Œå·²æœ‰çš„èƒŒæ™¯è¢«æ¸…ç©ºï¼Œæ–°çš„èƒŒæ™¯æ²¡æœ‰åˆ›å»ºï¼Œç¨‹åºè¿›å…¥åˆ°ä¸€ä¸ªå¥‡æ€ªçš„çŠ¶æ€ã€‚</p>
<p>ç¡®å®åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç”¨å¼‚å¸¸æ›´å®¹æ˜“å†™ä»£ç ï¼Œä½†å½“å¼‚å¸¸å®‰å…¨æ— æ³•ä¿è¯æ—¶ï¼Œç¨‹åºçš„æ­£ç¡®æ€§ä¼šå—åˆ°å¾ˆå¤§çš„æŒ‘æˆ˜ã€‚å› æ­¤ï¼Œä½ åœ¨ä½¿ç”¨å¼‚å¸¸å¤„ç†æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„å¼‚å¸¸å®‰å…¨ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ã€‚</p>
<p>å¼‚å¸¸å¤„ç†å¦å¤–ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜æ˜¯ï¼šå¼€å‘è€…ä¼šæ»¥ç”¨å¼‚å¸¸ã€‚åªè¦æœ‰é”™è¯¯ï¼Œä¸è®ºæ˜¯å¦ä¸¥é‡ã€æ˜¯å¦å¯æ¢å¤ï¼Œéƒ½ä¸€è‚¡è„‘æŠ›ä¸ªå¼‚å¸¸ã€‚åˆ°äº†éœ€è¦çš„åœ°æ–¹ï¼Œæ•è·ä¸€ä¸‹äº†ä¹‹ã€‚æ®Šä¸çŸ¥ï¼Œå¼‚å¸¸å¤„ç†çš„å¼€é”€è¦æ¯”å¤„ç†è¿”å›å€¼å¤§å¾—å¤šï¼Œæ»¥ç”¨ä¼šæœ‰å¾ˆå¤šé¢å¤–çš„å¼€é”€ã€‚</p>
</div>
</details>
<ol start="3">
<li>ä½¿ç”¨ç±»å‹ç³»ç»Ÿ</li>
</ol>
<p>ç¬¬ä¸‰ç§é”™è¯¯å¤„ç†çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨ç±»å‹ç³»ç»Ÿã€‚å…¶å®ï¼Œåœ¨ä½¿ç”¨è¿”å›å€¼å¤„ç†é”™è¯¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ç±»å‹ç³»ç»Ÿçš„é›å½¢ã€‚</p>
<p>é”™è¯¯ä¿¡æ¯æ—¢ç„¶å¯ä»¥é€šè¿‡å·²æœ‰çš„ç±»å‹æºå¸¦ï¼Œæˆ–è€…é€šè¿‡å¤šè¿”å›å€¼çš„æ–¹å¼æä¾›ï¼Œé‚£ä¹ˆé€šè¿‡ç±»å‹æ¥è¡¨å¾é”™è¯¯ï¼Œä½¿ç”¨ä¸€ä¸ªå†…éƒ¨åŒ…å«æ­£å¸¸è¿”å›ç±»å‹å’Œé”™è¯¯è¿”å›ç±»å‹çš„å¤åˆç±»å‹ï¼Œé€šè¿‡ç±»å‹ç³»ç»Ÿæ¥å¼ºåˆ¶é”™è¯¯çš„å¤„ç†å’Œä¼ é€’ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è¾¾åˆ°æ›´å¥½çš„æ•ˆæœå‘¢ï¼Ÿ</p>
<p>çš„ç¡®å¦‚æ­¤ã€‚è¿™ç§æ–¹å¼è¢«å¤§é‡ä½¿ç”¨åœ¨æœ‰å¼ºå¤§ç±»å‹ç³»ç»Ÿæ”¯æŒçš„å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¦‚ Haskell/Scala/Swiftã€‚å…¶ä¸­æœ€å…¸å‹çš„åŒ…å«äº†é”™è¯¯ç±»å‹çš„å¤åˆç±»å‹æ˜¯ Haskell çš„ Maybe å’Œ Either ç±»å‹ã€‚</p>
<ul>
<li>
<p>Maybe ç±»å‹å…è®¸æ•°æ®åŒ…å«ä¸€ä¸ªå€¼ï¼ˆJustï¼‰æˆ–è€…æ²¡æœ‰å€¼ï¼ˆNothingï¼‰ï¼Œè¿™å¯¹ç®€å•çš„ä¸éœ€è¦ç±»å‹çš„é”™è¯¯å¾ˆæœ‰ç”¨ã€‚è¿˜æ˜¯ä»¥æ‰“å¼€æ–‡ä»¶ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬åªå…³å¿ƒæˆåŠŸæ‰“å¼€æ–‡ä»¶çš„å¥æŸ„ï¼Œé‚£ä¹ˆ Maybe å°±è¶³å¤Ÿäº†ã€‚</p>
</li>
<li>
<p>å½“æˆ‘ä»¬éœ€è¦æ›´ä¸ºå¤æ‚çš„é”™è¯¯å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Either ç±»å‹ã€‚å®ƒå…è®¸æ•°æ®æ˜¯ Left a æˆ–è€… Right b ã€‚å…¶ä¸­ï¼Œa æ˜¯è¿è¡Œå‡ºé”™çš„æ•°æ®ç±»å‹ï¼Œb å¯ä»¥æ˜¯æˆåŠŸçš„æ•°æ®ç±»å‹ã€‚</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895260.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹æ³•ä¾æ—§æ˜¯é€šè¿‡è¿”å›å€¼è¿”å›é”™è¯¯ï¼Œä½†æ˜¯é”™è¯¯è¢«åŒ…è£¹åœ¨ä¸€ä¸ªå®Œæ•´çš„ã€å¿…é¡»å¤„ç†çš„ç±»å‹ä¸­ï¼Œæ¯” Golang çš„æ–¹æ³•æ›´å®‰å…¨ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å‰é¢æåˆ°ï¼Œä½¿ç”¨è¿”å›å€¼è¿”å›é”™è¯¯çš„ä¸€å¤§ç¼ºç‚¹æ˜¯ï¼Œé”™è¯¯éœ€è¦è¢«è°ƒç”¨è€…ç«‹å³å¤„ç†æˆ–è€…æ˜¾å¼ä¼ é€’ã€‚ä½†æ˜¯ä½¿ç”¨ Maybe / Either è¿™æ ·çš„ç±»å‹æ¥å¤„ç†é”™è¯¯çš„å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å‡½æ•°å¼ç¼–ç¨‹çš„æ–¹æ³•ç®€åŒ–é”™è¯¯çš„å¤„ç†ï¼Œæ¯”å¦‚ mapã€fold
ç­‰å‡½æ•°ï¼Œè®©ä»£ç ç›¸å¯¹ä¸é‚£ä¹ˆå†—ä½™ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¾ˆå¤šä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œå¦‚â€œç£ç›˜å†™æ»¡ï¼Œæ— æ³•å†™å…¥â€çš„é”™è¯¯ï¼Œä½¿ç”¨å¼‚å¸¸å¤„ç†å¯ä»¥é¿å…ä¸€å±‚å±‚ä¼ é€’é”™è¯¯ï¼Œè®©ä»£ç ç®€æ´é«˜æ•ˆï¼Œæ‰€ä»¥å¤§å¤šæ•°ä½¿ç”¨ç±»å‹ç³»ç»Ÿæ¥å¤„ç†é”™è¯¯çš„è¯­è¨€ï¼Œä¼šåŒæ—¶ä½¿ç”¨å¼‚å¸¸å¤„ç†ä½œä¸ºè¡¥å……ã€‚</p>
<h2 id="rust-çš„é”™è¯¯å¤„ç†"><a class="header" href="#rust-çš„é”™è¯¯å¤„ç†">Rust çš„é”™è¯¯å¤„ç†</a></h2>
<p>ç”±äºè¯ç”Ÿçš„å¹´ä»£æ¯”è¾ƒæ™šï¼ŒRust æœ‰æœºä¼šä»å·²æœ‰çš„è¯­è¨€ä¸­å­¦ä¹ åˆ°å„ç§é”™è¯¯å¤„ç†çš„ä¼˜åŠ£ã€‚å¯¹äº Rust æ¥è¯´ï¼Œç›®å‰çš„å‡ ç§æ–¹å¼ç›¸æ¯”è€Œè¨€ï¼Œæœ€ä½³çš„æ–¹æ³•æ˜¯ï¼Œä½¿ç”¨ç±»å‹ç³»ç»Ÿæ¥æ„å»ºä¸»è¦çš„é”™è¯¯å¤„ç†æµç¨‹ã€‚</p>
<h3 id="rust-å·å¸ˆ-haskellæ„å»ºäº†å¯¹æ ‡-maybe-çš„-option-ç±»å‹å’Œ-å¯¹æ ‡-either-çš„-result-ç±»å‹"><a class="header" href="#rust-å·å¸ˆ-haskellæ„å»ºäº†å¯¹æ ‡-maybe-çš„-option-ç±»å‹å’Œ-å¯¹æ ‡-either-çš„-result-ç±»å‹">Rust å·å¸ˆ Haskellï¼Œæ„å»ºäº†å¯¹æ ‡ Maybe çš„ Option ç±»å‹å’Œ å¯¹æ ‡ Either çš„ Result ç±»å‹ã€‚</a></h3>
<details id="admonition-rust-å·å¸ˆ-haskellæ„å»ºäº†å¯¹æ ‡-maybe-çš„-option-ç±»å‹å’Œ-å¯¹æ ‡-either-çš„-result-ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>Rust å·å¸ˆ Haskellï¼Œæ„å»ºäº†å¯¹æ ‡ Maybe çš„ Option ç±»å‹å’Œ å¯¹æ ‡ Either çš„ Result ç±»å‹</p>
<p><a class="admonition-anchor-link" href="#admonition-rust-å·å¸ˆ-haskellæ„å»ºäº†å¯¹æ ‡-maybe-çš„-option-ç±»å‹å’Œ-å¯¹æ ‡-either-çš„-result-ç±»å‹"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895260.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<ul>
<li>Option æ˜¯ä¸€ä¸ª enumï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
pub enum Option&lt;T&gt; {
    None,
    Some(T),
}
</code></pre></pre>
<blockquote>
<p>å®ƒå¯ä»¥æ‰¿è½½æœ‰å€¼ / æ— å€¼è¿™ç§æœ€ç®€å•çš„é”™è¯¯ç±»å‹ã€‚</p>
</blockquote>
<ul>
<li>Result æ˜¯ä¸€ä¸ªæ›´åŠ å¤æ‚çš„ enumï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
#[must_use = &quot;this `Result` may be an `Err` variant, which should be handled&quot;]
pub enum Result&lt;T, E&gt; {
    Ok(T),
    Err(E),
}
</code></pre></pre>
<blockquote>
<p>å½“å‡½æ•°å‡ºé”™æ—¶ï¼Œå¯ä»¥è¿”å› Err(E)ï¼Œå¦åˆ™ Ok(T)ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼ŒResult ç±»å‹å£°æ˜æ—¶è¿˜æœ‰ä¸ª must_use çš„æ ‡æ³¨ï¼Œç¼–è¯‘å™¨ä¼šå¯¹æœ‰ must_use æ ‡æ³¨çš„æ‰€æœ‰ç±»å‹åšç‰¹æ®Šå¤„ç†ï¼šå¦‚æœè¯¥ç±»å‹å¯¹åº”çš„å€¼æ²¡æœ‰è¢«æ˜¾å¼ä½¿ç”¨ï¼Œåˆ™ä¼šå‘Šè­¦ã€‚è¿™æ ·ï¼Œä¿è¯é”™è¯¯è¢«å¦¥å–„å¤„ç†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/e2100e3f17a9587c4d4bf50523c10653.png" alt="img" /></p>
<p>è¿™é‡Œï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨ read_file å‡½æ•°æ—¶ï¼Œç›´æ¥ä¸¢å¼ƒè¿”å›å€¼ï¼Œç”±äº #[must_use] çš„æ ‡æ³¨ï¼ŒRust ç¼–è¯‘å™¨æŠ¥è­¦ï¼Œè¦æ±‚æˆ‘ä»¬ä½¿ç”¨å…¶è¿”å›å€¼ã€‚</p>
</div>
</details>
<h3 id="-æ“ä½œç¬¦"><a class="header" href="#-æ“ä½œç¬¦">? æ“ä½œç¬¦</a></h3>
<details id="admonition--æ“ä½œç¬¦çš„ç”±æ¥" class="admonition info">
<summary class="admonition-title">
<p>? æ“ä½œç¬¦çš„ç”±æ¥</p>
<p><a class="admonition-anchor-link" href="#admonition--æ“ä½œç¬¦çš„ç”±æ¥"></a></p>
</summary>
<div>
<p>è¿™è™½ç„¶å¯ä»¥æå¤§é¿å…é—å¿˜é”™è¯¯çš„æ˜¾ç¤ºå¤„ç†ï¼Œä½†å¦‚æœæˆ‘ä»¬å¹¶ä¸å…³å¿ƒé”™è¯¯ï¼Œåªéœ€è¦ä¼ é€’é”™è¯¯ï¼Œè¿˜æ˜¯ä¼šå†™å‡ºåƒ C æˆ–è€… Golang ä¸€æ ·æ¯”è¾ƒå†—ä½™çš„ä»£ç ã€‚æ€ä¹ˆåŠï¼Ÿ</p>
<p>å¥½åœ¨ Rust é™¤äº†æœ‰å¼ºå¤§çš„ç±»å‹ç³»ç»Ÿå¤–ï¼Œè¿˜å…·å¤‡å…ƒç¼–ç¨‹çš„èƒ½åŠ›ã€‚æ—©æœŸ Rust æä¾›äº† try! å®æ¥ç®€åŒ–é”™è¯¯çš„æ˜¾å¼å¤„ç†ï¼Œåæ¥ä¸ºäº†è¿›ä¸€æ­¥æå‡ç”¨æˆ·ä½“éªŒï¼Œtry! è¢«è¿›åŒ–æˆ ? æ“ä½œç¬¦ã€‚</p>
<p>æ‰€ä»¥åœ¨ Rust ä»£ç ä¸­ï¼Œå¦‚æœä½ åªæƒ³ä¼ æ’­é”™è¯¯ï¼Œä¸æƒ³å°±åœ°å¤„ç†ï¼Œå¯ä»¥ç”¨ ? æ“ä½œç¬¦ï¼Œæ¯”å¦‚ï¼ˆä»£ç ï¼‰:</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::fs::File;
use std::io::Read;

fn read_file(name: &amp;str) -&gt; Result&lt;String, std::io::Error&gt; {
  let mut f = File::open(name)?;
  let mut contents = String::new();
  f.read_to_string(&amp;mut contents)?;
  Ok(contents)
}
</code></pre></pre>
<blockquote>
<p>é€šè¿‡ ? æ“ä½œç¬¦ï¼ŒRust è®©é”™è¯¯ä¼ æ’­çš„ä»£ä»·å’Œå¼‚å¸¸å¤„ç†ä¸ç›¸ä¸Šä¸‹ï¼ŒåŒæ—¶åˆé¿å…äº†å¼‚å¸¸å¤„ç†çš„è¯¸å¤šé—®é¢˜ã€‚</p>
</blockquote>
<hr />
<p>? æ“ä½œç¬¦å†…éƒ¨è¢«å±•å¼€æˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
match result {
  Ok(v) =&gt; v,
  Err(e) =&gt; return Err(e.into())
}
</code></pre></pre>
<blockquote>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°å†™å‡ºç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼Œç®€æ´æ˜“æ‡‚ï¼Œå¯è¯»æ€§å¾ˆå¼ºï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
fut
  .await?
  .process()?
  .next()
  .await?;
</code></pre></pre>
<p>æ•´ä¸ªä»£ç çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895239.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<p>è™½ç„¶ ? æ“ä½œç¬¦ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œä½†ä½ è¦æ³¨æ„åœ¨ä¸åŒçš„é”™è¯¯ç±»å‹ä¹‹é—´æ˜¯æ— æ³•ç›´æ¥ä½¿ç”¨çš„ï¼Œéœ€è¦å®ç° From trait åœ¨äºŒè€…ä¹‹é—´å»ºç«‹èµ·è½¬æ¢çš„æ¡¥æ¢ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„éº»çƒ¦ã€‚</p>
</div>
</details>
<h3 id="å‡½æ•°å¼é”™è¯¯å¤„ç†"><a class="header" href="#å‡½æ•°å¼é”™è¯¯å¤„ç†">å‡½æ•°å¼é”™è¯¯å¤„ç†</a></h3>
<details id="admonition-map--map_err--and_then-ä½¿ç”¨å‡½æ•°å¼é”™è¯¯å¤„ç†" class="admonition info">
<summary class="admonition-title">
<p>map / map_err / and_then: ä½¿ç”¨å‡½æ•°å¼é”™è¯¯å¤„ç†</p>
<p><a class="admonition-anchor-link" href="#admonition-map--map_err--and_then-ä½¿ç”¨å‡½æ•°å¼é”™è¯¯å¤„ç†"></a></p>
</summary>
<div>
<p>Rust è¿˜ä¸º Option å’Œ Result æä¾›äº†å¤§é‡çš„è¾…åŠ©å‡½æ•°ï¼Œå¦‚ map / map_err / and_thenï¼Œä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¤„ç†æ•°æ®ç»“æ„ä¸­éƒ¨åˆ†æƒ…å†µã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<p>é€šè¿‡è¿™äº›å‡½æ•°ï¼Œä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹é”™è¯¯å¤„ç†å¼•å…¥ <a href="https://www.slideshare.net/ScottWlaschin/railway-oriented-programming">Railroad oriented programming èŒƒå¼</a>ã€‚æ¯”å¦‚ç”¨æˆ·æ³¨å†Œçš„æµç¨‹ï¼Œä½ éœ€è¦æ ¡éªŒç”¨æˆ·è¾“å…¥ï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè½¬æ¢ï¼Œç„¶åå­˜å…¥æ•°æ®åº“ä¸­ã€‚ä½ å¯ä»¥è¿™ä¹ˆæ’°å†™è¿™ä¸ªæµç¨‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
Ok(data)
  .and_then(validate)
  .and_then(process)
  .map(transform)
  .and_then(store)
  .map_error(...)
</code></pre></pre>
<blockquote>
<p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/image-20221004225336162.png" alt="image-20221004225336162" /></p>
<p>æ­¤å¤–ï¼ŒOption å’Œ Result çš„äº’ç›¸è½¬æ¢ä¹Ÿå¾ˆæ–¹æ¢ï¼Œè¿™ä¹Ÿå¾—ç›Šäº Rust æ„å»ºçš„å¼ºå¤§çš„å‡½æ•°å¼ç¼–ç¨‹çš„èƒ½åŠ›ã€‚</p>
</div>
</details>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯é€šè¿‡ ? æ“ä½œç¬¦ï¼Œè¿˜æ˜¯å‡½æ•°å¼ç¼–ç¨‹è¿›è¡Œé”™è¯¯å¤„ç†ï¼ŒRust éƒ½åŠ›æ±‚è®©é”™è¯¯å¤„ç†çµæ´»é«˜æ•ˆï¼Œè®©å¼€å‘è€…ä½¿ç”¨èµ·æ¥ç®€å•ç›´è§‚ã€‚</p>
<h3 id="panic-å’Œ-catch_unwind"><a class="header" href="#panic-å’Œ-catch_unwind">panic! å’Œ catch_unwind</a></h3>
<details id="admonition-rust-ä¹Ÿæä¾›äº†ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†èƒ½åŠ›-panicå’Œcatch_unwind" class="admonition info">
<summary class="admonition-title">
<p>Rust ä¹Ÿæä¾›äº†ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†èƒ½åŠ›: panic!å’Œcatch_unwind</p>
<p><a class="admonition-anchor-link" href="#admonition-rust-ä¹Ÿæä¾›äº†ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†èƒ½åŠ›-panicå’Œcatch_unwind"></a></p>
</summary>
<div>
<p>ä½¿ç”¨ Option å’Œ Result æ˜¯ Rust ä¸­å¤„ç†é”™è¯¯çš„é¦–é€‰ï¼Œç»å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¹Ÿåº”è¯¥ä½¿ç”¨ï¼Œä½† Rust ä¹Ÿæä¾›äº†ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†èƒ½åŠ›ã€‚</p>
<p>åœ¨ Rust çœ‹æ¥ï¼Œä¸€æ—¦ä½ éœ€è¦æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£æŠ›å‡ºçš„ä¸€å®šæ˜¯ä¸¥é‡çš„é”™è¯¯ã€‚æ‰€ä»¥ï¼ŒRust è·Ÿ Golang ä¸€æ ·ï¼Œä½¿ç”¨äº†è¯¸å¦‚ panic! è¿™æ ·çš„å­—çœ¼è­¦ç¤ºå¼€å‘è€…ï¼šæƒ³æ¸…æ¥šäº†å†ä½¿ç”¨æˆ‘ã€‚åœ¨ä½¿ç”¨ Option å’Œ Result ç±»å‹æ—¶ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥å¯¹å…¶ unwarp() æˆ–è€… expect()ï¼Œå¼ºåˆ¶æŠŠ Option<T> å’Œ Result&lt;T, E&gt; è½¬æ¢æˆ Tï¼Œå¦‚æœæ— æ³•å®Œæˆè¿™ç§è½¬æ¢ï¼Œä¹Ÿä¼š panic! å‡ºæ¥ã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œpanic! æ˜¯ä¸å¯æ¢å¤æˆ–è€…ä¸æƒ³æ¢å¤çš„é”™è¯¯ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ­¤åˆ»ï¼Œç¨‹åºç»ˆæ­¢è¿è¡Œå¹¶å¾—åˆ°å´©æºƒä¿¡æ¯ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œå®ƒè§£æ<a href="https://noiseprotocol.org/noise.html#protocol-names-and-modifiers"> noise protocol</a>çš„åè®®å˜é‡ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let params: NoiseParams = &quot;Noise_XX_25519_AESGCM_SHA256&quot;.parse().unwrap();
</code></pre></pre>
<h2 id="å¦‚æœå¼€å‘è€…ä¸å°å¿ƒæŠŠåè®®å˜é‡å†™é”™äº†æœ€ä½³çš„æ–¹å¼æ˜¯ç«‹åˆ»-panic-å‡ºæ¥è®©é”™è¯¯ç«‹åˆ»æš´éœ²ä»¥ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜"><a class="header" href="#å¦‚æœå¼€å‘è€…ä¸å°å¿ƒæŠŠåè®®å˜é‡å†™é”™äº†æœ€ä½³çš„æ–¹å¼æ˜¯ç«‹åˆ»-panic-å‡ºæ¥è®©é”™è¯¯ç«‹åˆ»æš´éœ²ä»¥ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜">å¦‚æœå¼€å‘è€…ä¸å°å¿ƒæŠŠåè®®å˜é‡å†™é”™äº†ï¼Œæœ€ä½³çš„æ–¹å¼æ˜¯ç«‹åˆ» panic! å‡ºæ¥ï¼Œè®©é”™è¯¯ç«‹åˆ»æš´éœ²ï¼Œä»¥ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</a></h2>
<p>æœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿåƒå¼‚å¸¸å¤„ç†é‚£æ ·èƒ½å¤Ÿæ ˆå›æº¯ï¼ŒæŠŠç¯å¢ƒæ¢å¤åˆ°æ•è·å¼‚å¸¸çš„ä¸Šä¸‹æ–‡ã€‚Rust æ ‡å‡†åº“ä¸‹æä¾›äº† catch_unwind() ï¼ŒæŠŠè°ƒç”¨æ ˆå›æº¯åˆ° catch_unwind è¿™ä¸€åˆ»ï¼Œä½œç”¨å’Œå…¶å®ƒè¯­è¨€çš„ try {â€¦} catch {â€¦} ä¸€æ ·ã€‚è§å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::panic;

fn main() {
    let result = panic::catch_unwind(|| {
        println!(&quot;hello!&quot;);
    });
    assert!(result.is_ok());
    let result = panic::catch_unwind(|| {
        panic!(&quot;oh no!&quot;);
    });
    assert!(result.is_err());
    println!(&quot;panic captured: {:#?}&quot;, result);
}
</code></pre></pre>
<p>å½“ç„¶ï¼Œå’Œå¼‚å¸¸å¤„ç†ä¸€æ ·ï¼Œå¹¶ä¸æ„å‘³ç€ä½ å¯ä»¥æ»¥ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œæˆ‘æƒ³ï¼Œè¿™ä¹Ÿæ˜¯ Rust æŠŠæŠ›å‡ºå¼‚å¸¸ç§°ä½œ panic! ï¼Œè€Œæ•è·å¼‚å¸¸ç§°ä½œ catch_unwind çš„åŸå› ï¼Œè®©åˆå­¦è€…æœ›è€Œç”Ÿç•ï¼Œä¸æ•¢è½»æ˜“ä½¿ç”¨ã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„ç”¨æˆ·ä½“éªŒã€‚</p>
<p>catch_unwind åœ¨æŸäº›åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨:</p>
<ol>
<li>æ¯”å¦‚ä½ åœ¨ä½¿ç”¨ Rust ä¸º erlang VM æ’°å†™ NIFï¼Œä½ ä¸å¸Œæœ› Rust ä»£ç ä¸­çš„ä»»ä½• panic! å¯¼è‡´ erlang VM å´©æºƒã€‚å› ä¸ºå´©æºƒæ˜¯ä¸€ä¸ªéå¸¸ä¸å¥½çš„ä½“éªŒï¼Œå®ƒè¿èƒŒäº† erlang çš„è®¾è®¡åŸåˆ™ï¼šprocess å¯ä»¥ let it crashï¼Œä½†é”™è¯¯ä»£ç ä¸è¯¥å¯¼è‡´ VM å´©æºƒã€‚</li>
<li>æ­¤åˆ»ï¼Œä½ å°±å¯ä»¥æŠŠ Rust ä»£ç æ•´ä¸ªå°è£…åœ¨ catch_unwind() å‡½æ•°æ‰€éœ€è¦ä¼ å…¥çš„é—­åŒ…ä¸­ã€‚è¿™æ ·ï¼Œä¸€æ—¦ä»»ä½•ä»£ç ä¸­ï¼ŒåŒ…æ‹¬ç¬¬ä¸‰æ–¹ crates çš„ä»£ç ï¼Œå«æœ‰èƒ½å¤Ÿå¯¼è‡´ panic! çš„ä»£ç ï¼Œéƒ½ä¼šè¢«æ•è·ï¼Œå¹¶è¢«è½¬æ¢ä¸ºä¸€ä¸ª Resultã€‚</li>
</ol>
</div>
</details>
<h3 id="error-trait-å’Œé”™è¯¯ç±»å‹çš„è½¬æ¢"><a class="header" href="#error-trait-å’Œé”™è¯¯ç±»å‹çš„è½¬æ¢">Error trait å’Œé”™è¯¯ç±»å‹çš„è½¬æ¢</a></h3>
<details id="admonition-ä½¿ç”¨error-traitè‡ªå®šä¹‰é”™è¯¯ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨Error traitè‡ªå®šä¹‰é”™è¯¯ç±»å‹</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½¿ç”¨error-traitè‡ªå®šä¹‰é”™è¯¯ç±»å‹"></a></p>
</summary>
<div>
<p>ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬è®²åˆ° Result&lt;T, E&gt; é‡Œ E æ˜¯ä¸€ä¸ªä»£è¡¨é”™è¯¯çš„æ•°æ®ç±»å‹ã€‚ä¸ºäº†è§„èŒƒè¿™ä¸ªä»£è¡¨é”™è¯¯çš„æ•°æ®ç±»å‹çš„è¡Œä¸ºï¼ŒRust å®šä¹‰äº† Error traitï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Error: Debug + Display {
    fn source(&amp;self) -&gt; Option&lt;&amp;(dyn Error + 'static)&gt; { ... }
    fn backtrace(&amp;self) -&gt; Option&lt;&amp;Backtrace&gt; { ... }
    fn description(&amp;self) -&gt; &amp;str { ... }
    fn cause(&amp;self) -&gt; Option&lt;&amp;dyn Error&gt; { ... }
}
</code></pre></pre>
<p>æˆ‘ä»¬å¯ä»¥å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„æ•°æ®ç±»å‹ï¼Œç„¶åä¸ºå…¶å®ç° Error traitã€‚</p>
</div>
</details>
<details id="admonition-ä½¿ç”¨thiserrorå’Œanyhowç®€åŒ–æ­¥éª¤" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨thiserrorå’Œanyhowç®€åŒ–æ­¥éª¤</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½¿ç”¨thiserrorå’Œanyhowç®€åŒ–æ­¥éª¤"></a></p>
</summary>
<div>
<p>ä¸è¿‡ï¼Œè¿™æ ·çš„å·¥ä½œå·²ç»æœ‰äººæ›¿æˆ‘ä»¬ç®€åŒ–äº†ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ thiserrorå’Œ anyhowæ¥ç®€åŒ–è¿™ä¸ªæ­¥éª¤ã€‚</p>
<ul>
<li>thiserror æä¾›äº†ä¸€ä¸ªæ´¾ç”Ÿå®ï¼ˆderive macroï¼‰æ¥ç®€åŒ–é”™è¯¯ç±»å‹çš„å®šä¹‰ï¼Œæ¯”å¦‚ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
use thiserror::Error;
#[derive(Error, Debug)]
#[non_exhaustive]
pub enum DataStoreError {
    #[error(&quot;data store disconnected&quot;)]
    Disconnect(#[from] io::Error),
    #[error(&quot;the data for key `{0}` is not available&quot;)]
    Redaction(String),
    #[error(&quot;invalid header (expected {expected:?}, found {found:?})&quot;)]
    InvalidHeader {
        expected: String,
        found: String,
    },
    #[error(&quot;unknown data store error&quot;)]
    Unknown,
}
</code></pre></pre>
<p>å¦‚æœä½ åœ¨æ’°å†™ä¸€ä¸ª Rust åº“ï¼Œé‚£ä¹ˆ thiserror å¯ä»¥å¾ˆå¥½åœ°ååŠ©ä½ å¯¹è¿™ä¸ªåº“é‡Œæ‰€æœ‰å¯èƒ½å‘ç”Ÿçš„é”™è¯¯è¿›è¡Œå»ºæ¨¡ã€‚</p>
<ul>
<li>anyhow å®ç°äº† anyhow::Error å’Œä»»æ„ç¬¦åˆ Error trait çš„é”™è¯¯ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œè®©ä½ å¯ä»¥ä½¿ç”¨ ? æ“ä½œç¬¦ï¼Œä¸å¿…å†æ‰‹å·¥è½¬æ¢é”™è¯¯ç±»å‹ã€‚</li>
</ul>
<blockquote>
<p>anyhow è¿˜å¯ä»¥è®©ä½ å¾ˆå®¹æ˜“åœ°æŠ›å‡ºä¸€äº›ä¸´æ—¶çš„é”™è¯¯ï¼Œè€Œä¸å¿…è´¹åŠ›å®šä¹‰é”™è¯¯ç±»å‹ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬ä¸æå€¡æ»¥ç”¨è¿™ä¸ªèƒ½åŠ›ã€‚</p>
</blockquote>
<p>ä½œä¸ºä¸€åä¸¥è‚ƒçš„å¼€å‘è€…ï¼Œæˆ‘éå¸¸å»ºè®®ä½ åœ¨å¼€å‘å‰ï¼Œå…ˆç”¨ç±»ä¼¼ thiserror çš„åº“å®šä¹‰å¥½ä½ é¡¹ç›®ä¸­ä¸»è¦çš„é”™è¯¯ç±»å‹ï¼Œå¹¶éšç€é¡¹ç›®çš„æ·±å…¥ï¼Œä¸æ–­å¢åŠ æ–°çš„é”™è¯¯ç±»å‹ï¼Œè®©ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ½œåœ¨é”™è¯¯éƒ½æ— æ‰€éå½¢ã€‚</p>
</div>
</details>
<h1 id="å››é—­åŒ…ç»“æ„"><a class="header" href="#å››é—­åŒ…ç»“æ„">å››ã€é—­åŒ…ç»“æ„</a></h1>
<h2 id="é—­åŒ…çš„å®šä¹‰"><a class="header" href="#é—­åŒ…çš„å®šä¹‰">é—­åŒ…çš„å®šä¹‰</a></h2>
<details id="admonition-é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µ" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µ</p>
<p><a class="admonition-anchor-link" href="#admonition-é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µ"></a></p>
</summary>
<div>
<p>é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µï¼š</p>
<ul>
<li>é—­åŒ…æ˜¯å°†å‡½æ•°ï¼Œæˆ–è€…è¯´ä»£ç å’Œå…¶ç¯å¢ƒä¸€èµ·å­˜å‚¨çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚</li>
<li>é—­åŒ…å¼•ç”¨çš„ä¸Šä¸‹æ–‡ä¸­çš„è‡ªç”±å˜é‡ï¼Œä¼šè¢«æ•è·åˆ°é—­åŒ…çš„ç»“æ„ä¸­ï¼Œæˆä¸ºé—­åŒ…ç±»å‹çš„ä¸€éƒ¨åˆ†</li>
<li>é—­åŒ…ä¼šæ ¹æ®å†…éƒ¨çš„ä½¿ç”¨æƒ…å†µï¼Œæ•è·ç¯å¢ƒä¸­çš„è‡ªç”±å˜é‡ã€‚</li>
</ul>
</div>
</details>
<details id="admonition-rustä¸­é—­åŒ…æ•è·è‡ªç”±å˜é‡çš„ä¸¤ä¸ªæ–¹æ³•" class="admonition info">
<summary class="admonition-title">
<p>Rustä¸­é—­åŒ…æ•è·è‡ªç”±å˜é‡çš„ä¸¤ä¸ªæ–¹æ³•</p>
<p><a class="admonition-anchor-link" href="#admonition-rustä¸­é—­åŒ…æ•è·è‡ªç”±å˜é‡çš„ä¸¤ä¸ªæ–¹æ³•"></a></p>
</summary>
<div>
<blockquote>
<p>åœ¨ Rust é‡Œï¼Œé—­åŒ…å¯ä»¥ç”¨ |args| {code} æ¥è¡¨è¿°ï¼Œå›¾ä¸­é—­åŒ… c æ•è·äº†ä¸Šä¸‹æ–‡ä¸­çš„ a å’Œ bï¼Œå¹¶é€šè¿‡å¼•ç”¨æ¥ä½¿ç”¨è¿™ä¸¤ä¸ªè‡ªç”±å˜é‡ï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F-4897625.jpg" alt="19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ" /></p>
<blockquote>
<p>é™¤äº†ç”¨å¼•ç”¨æ¥æ•è·è‡ªç”±å˜é‡ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨ move å…³é”®å­— move |args| {code} ã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-threadspawnçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ä½¿ç”¨moveå…³é”®å­—" class="admonition info">
<summary class="admonition-title">
<p>thread::spawnçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä½¿ç”¨moveå…³é”®å­—</p>
<p><a class="admonition-anchor-link" href="#admonition-threadspawnçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ä½¿ç”¨moveå…³é”®å­—"></a></p>
</summary>
<div>
<p>æ¯”å¦‚åˆ›å»ºæ–°çº¿ç¨‹çš„ thread::spawnï¼Œå®ƒçš„å‚æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt; 
where
    F: FnOnce() -&gt; T,
    F: Send + 'static,
    T: Send + 'static,
</code></pre></pre>
<blockquote>
<p>ä»”ç»†çœ‹è¿™ä¸ªæ¥å£ï¼š</p>
</blockquote>
<ol>
<li>F: FnOnce() â†’ Tï¼Œè¡¨æ˜ F æ˜¯ä¸€ä¸ªæ¥å— 0 ä¸ªå‚æ•°ã€è¿”å› T çš„é—­åŒ…ã€‚FnOnce æˆ‘ä»¬ç¨åå†è¯´ã€‚</li>
<li>F: Send + â€™staticï¼Œè¯´æ˜é—­åŒ… F è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Œå¹¶ä¸”å®ƒè¿˜èƒ½è¢«å‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚a</li>
<li>T: Send + â€™staticï¼Œè¯´æ˜é—­åŒ… F è¿”å›çš„æ•°æ®ç»“æ„ Tï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Œå¹¶ä¸”å®ƒè¿˜èƒ½è¢«å‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</li>
</ol>
<blockquote>
<p>1 å’Œ 3 éƒ½å¾ˆå¥½ç†è§£ï¼Œ2 å°±æœ‰äº›è´¹è§£äº†ã€‚ä¸€ä¸ªé—­åŒ…ï¼Œå®ƒä¸å°±æ˜¯ä¸€æ®µä»£ç  + è¢«æ•è·çš„å˜é‡ä¹ˆï¼Ÿéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p>
</blockquote>
<p>æ‹†å¼€çœ‹:</p>
<ul>
<li>ä»£ç è‡ªç„¶æ˜¯é™æ€ç”Ÿå‘½å‘¨æœŸ</li>
<li>é‚£ä¹ˆæ˜¯ä¸æ˜¯æ„å‘³ç€è¢«æ•è·çš„å˜é‡ï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Ÿ</li>
</ul>
<blockquote>
<p>çš„ç¡®å¦‚æ­¤ã€‚åœ¨ä½¿ç”¨ thread::spawn æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ move å…³é”®å­—ï¼ŒæŠŠå˜é‡çš„æ‰€æœ‰æƒä»å½“å‰ä½œç”¨åŸŸç§»åŠ¨åˆ°é—­åŒ…çš„ä½œç”¨åŸŸï¼Œè®© thread::spawn å¯ä»¥æ­£å¸¸ç¼–è¯‘é€šè¿‡ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::thread;

fn main() {
    let s = String::from(&quot;hello world&quot;);

    let handle = thread::spawn(move || {
        println!(&quot;moved: {:?}&quot;, s);
    });

    handle.join().unwrap();
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>ä½†ä½ æœ‰æ²¡æœ‰å¥½å¥‡è¿‡ï¼ŒåŠ  move å’Œä¸åŠ  moveï¼Œè¿™ä¸¤ç§é—­åŒ…æœ‰ä»€ä¹ˆæœ¬è´¨ä¸Šçš„ä¸åŒï¼Ÿé—­åŒ…ç©¶ç«Ÿæ˜¯ä¸€ç§ä»€ä¹ˆæ ·çš„æ•°æ®ç±»å‹ï¼Œè®©ç¼–è¯‘å™¨å¯ä»¥åˆ¤æ–­å®ƒæ˜¯å¦æ»¡è¶³ Send + â€™static å‘¢ï¼Ÿæˆ‘ä»¬ä»é—­åŒ…çš„æœ¬è´¨ä¸‹æ‰‹æ¥å°è¯•å›ç­”è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p>
</blockquote>
<h2 id="é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆ"><a class="header" href="#é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆ">é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆï¼Ÿ</a></h2>
<details id="admonition-é—­åŒ…çš„æœ¬è´¨æ˜¯åŒ¿åç»“æ„ä½“moveä¼šè½¬ç§»è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒ" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…çš„æœ¬è´¨æ˜¯åŒ¿åç»“æ„ä½“ï¼Œmoveä¼šè½¬ç§»è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒ</p>
<p><a class="admonition-anchor-link" href="#admonition-é—­åŒ…çš„æœ¬è´¨æ˜¯åŒ¿åç»“æ„ä½“moveä¼šè½¬ç§»è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒ"></a></p>
</summary>
<div>
<p>åœ¨å®˜æ–¹çš„ Rust reference ä¸­ï¼Œæœ‰è¿™æ ·çš„å®šä¹‰ï¼š</p>
<blockquote>
<p>A closure expression produces a closure value with a unique, anonymous type that cannot be written out. A closure type is approximately equivalent to a struct which contains the captured variables.</p>
</blockquote>
<hr />
<p>é—­åŒ…æ˜¯ä¸€ç§åŒ¿åç±»å‹ï¼Œä¸€æ—¦å£°æ˜ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œä½†è¿™ä¸ªç±»å‹æ— æ³•è¢«å…¶å®ƒåœ°æ–¹ä½¿ç”¨ã€‚è¿™ä¸ªç±»å‹å°±åƒä¸€ä¸ªç»“æ„ä½“ï¼Œä¼šåŒ…å«æ‰€æœ‰æ•è·çš„å˜é‡ã€‚</p>
<p>æ‰€ä»¥é—­åŒ…ç±»ä¼¼ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ä½“ï¼Ÿ</p>
<p>ä¸ºäº†ææ˜ç™½è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¾—å†™æ®µä»£ç æ¢ç´¢ä¸€ä¸‹ï¼Œå»ºè®®ä½ è·Ÿç€æ•²ä¸€éè®¤çœŸæ€è€ƒï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{collections::HashMap, mem::size_of_val};
fn main() {
    // é•¿åº¦ä¸º 0
    let c1 = || println!(&quot;hello world!&quot;);
    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
    let c2 = |i: i32| println!(&quot;hello: {}&quot;, i);
    let name = String::from(&quot;tyr&quot;);
    let name1 = name.clone();
    let mut table = HashMap::new();
    table.insert(&quot;hello&quot;, &quot;world&quot;);
    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
    let c3 = || println!(&quot;hello: {}&quot;, name);
    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
    let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
    let name2 = name.clone();
    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
    let c5 = move || {
        let x = 1;
        let name3 = String::from(&quot;lindsey&quot;);
        println!(&quot;hello: {}, {:?}, {:?}&quot;, x, name2, name3);
    };

    println!(
        &quot;c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}&quot;,
        size_of_val(&amp;c1),
        size_of_val(&amp;c2),
        size_of_val(&amp;c3),
        size_of_val(&amp;c4),
        size_of_val(&amp;c5),
        size_of_val(&amp;main),
    )
}
</code></pre></pre>
<blockquote>
<p>åˆ†åˆ«ç”Ÿæˆäº† 5 ä¸ªé—­åŒ…ï¼š</p>
</blockquote>
<ol>
<li>c1 æ²¡æœ‰å‚æ•°ï¼Œä¹Ÿæ²¡æ•è·ä»»ä½•å˜é‡ï¼Œä»ä»£ç è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œc1 é•¿åº¦ä¸º 0ï¼›</li>
<li>c2 æœ‰ä¸€ä¸ª i32 ä½œä¸ºå‚æ•°ï¼Œæ²¡æœ‰æ•è·ä»»ä½•å˜é‡ï¼Œé•¿åº¦ä¹Ÿä¸º 0ï¼Œå¯ä»¥çœ‹å‡ºå‚æ•°è·Ÿé—­åŒ…çš„å¤§å°æ— å…³ï¼›</li>
<li>c3 æ•è·äº†ä¸€ä¸ªå¯¹å˜é‡ name çš„å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æ˜¯ &amp;Stringï¼Œé•¿åº¦ä¸º 8ã€‚è€Œ c3 çš„é•¿åº¦ä¹Ÿæ˜¯ 8ï¼›</li>
<li>c4 æ•è·äº†å˜é‡ name1 å’Œ tableï¼Œç”±äºç”¨äº† moveï¼Œå®ƒä»¬çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°äº† c4 ä¸­ã€‚c4 é•¿åº¦æ˜¯ 72ï¼Œæ°å¥½ç­‰äº String çš„ 24 å­—èŠ‚ï¼ŒåŠ ä¸Š HashMap çš„ 48 å­—èŠ‚ã€‚</li>
<li>c5 æ•è·äº† name2ï¼Œname2 çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°äº† c5ï¼Œè™½ç„¶ c5 æœ‰å±€éƒ¨å˜é‡ï¼Œä½†å®ƒçš„å¤§å°å’Œå±€éƒ¨å˜é‡ä¹Ÿæ— å…³ï¼Œc5 çš„å¤§å°ç­‰äº String çš„ 24 å­—èŠ‚ã€‚</li>
</ol>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸å¸¦ move æ—¶ï¼Œé—­åŒ…æ•è·çš„æ˜¯å¯¹åº”è‡ªç”±å˜é‡çš„å¼•ç”¨ï¼›å¸¦ move æ—¶ï¼Œå¯¹åº”è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒä¼šè¢«ç§»åŠ¨åˆ°é—­åŒ…ç»“æ„ä¸­ã€‚</p>
</blockquote>
</div>
</details>
<p>ç»§ç»­åˆ†æè¿™æ®µä»£ç çš„è¿è¡Œç»“æœã€‚</p>
<details id="admonition-é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³</p>
<p><a class="admonition-anchor-link" href="#admonition-é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³"></a></p>
</summary>
<div>
<p>è¿˜çŸ¥é“äº†ï¼Œé—­åŒ…çš„å¤§å°è·Ÿå‚æ•°ã€å±€éƒ¨å˜é‡éƒ½æ— å…³ï¼Œåªè·Ÿæ•è·çš„å˜é‡æœ‰å…³:</p>
<blockquote>
<p>å› ä¸ºå®ƒä»¬æ˜¯åœ¨è°ƒç”¨çš„æ—¶åˆ»æ‰åœ¨æ ˆä¸Šäº§ç”Ÿçš„å†…å­˜åˆ†é…ï¼Œè¯´åˆ°åº•å’Œé—­åŒ…ç±»å‹æœ¬èº«æ˜¯æ— å…³çš„ï¼Œæ‰€ä»¥é—­åŒ…çš„å¤§å°è·Ÿå®ƒä»¬è‡ªç„¶æ— å…³ã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{collections::HashMap, mem::size_of_val};
fn main() {
    // é•¿åº¦ä¸º 0
    let c1 = || println!(&quot;hello world!&quot;);
    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
    let c2 = |i: i32| println!(&quot;hello: {}&quot;, i);
    let name = String::from(&quot;tyr&quot;);
    let name1 = name.clone();
    let mut table = HashMap::new();
    table.insert(&quot;hello&quot;, &quot;world&quot;);
    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
    let c3 = || println!(&quot;hello: {}&quot;, name);
    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
    let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
    let name2 = name.clone();
    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
    let c5 = move || {
        let x = 1;
        let name3 = String::from(&quot;lindsey&quot;);
        println!(&quot;hello: {}, {:?}, {:?}&quot;, x, name2, name3);
    };

    println!(
        &quot;c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}&quot;,
        size_of_val(&amp;c1),
        size_of_val(&amp;c2),
        size_of_val(&amp;c3),
        size_of_val(&amp;c4),
        size_of_val(&amp;c5),
        size_of_val(&amp;main),
    )
}
</code></pre></pre>
</div>
</details>
<details id="admonition-é—­åŒ…çš„å†…å­˜å¸ƒå±€ä¸ç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…çš„å†…å­˜å¸ƒå±€ä¸ç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-é—­åŒ…çš„å†…å­˜å¸ƒå±€ä¸ç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«"></a></p>
</summary>
<div>
<p>é‚£ä¸€ä¸ªé—­åŒ…ç±»å‹åœ¨å†…å­˜ä¸­ç©¶ç«Ÿæ˜¯å¦‚ä½•æ’å¸ƒçš„ï¼Œå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<blockquote>
<p>æˆ‘ä»¬è¦å†æ¬¡ç»“åˆ rust-gdb æ¢ç´¢ï¼Œçœ‹çœ‹ä¸Šé¢çš„ä»£ç åœ¨è¿è¡Œç»“æŸå‰ï¼Œå‡ ä¸ªé•¿åº¦ä¸ä¸º 0 é—­åŒ…å†…å­˜é‡Œéƒ½æ”¾äº†ä»€ä¹ˆï¼š</p>
</blockquote>
<h2 id="-4"><a class="header" href="#-4"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F-4897598.png" alt="19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ" /></a></h2>
<p>å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>c3 çš„ç¡®æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼ŒæŠŠå®ƒæŒ‡å‘çš„å†…å­˜åœ°å€çš„ 24 ä¸ªå­—èŠ‚æ‰“å‡ºæ¥ï¼Œæ˜¯ (ptr | cap | len) çš„æ ‡å‡†ç»“æ„ã€‚å¦‚æœæ‰“å° ptr å¯¹åº”çš„å †å†…å­˜çš„ 3 ä¸ªå­—èŠ‚ï¼Œæ˜¯ â€˜tâ€™ â€˜yâ€™ â€˜râ€™ã€‚</li>
<li>è€Œ c4 æ•è·çš„ name å’Œ tableï¼Œå†…å­˜ç»“æ„å’Œä¸‹é¢çš„ç»“æ„ä½“ä¸€æ¨¡ä¸€æ ·ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
struct Closure4 {
    name: String,  // (ptr|cap|len)=24å­—èŠ‚
    table: HashMap&lt;&amp;str, &amp;str&gt; // (RandomState(16)|mask|ctrl|left|len)=48å­—èŠ‚
}
</code></pre></pre>
<p>ä¸è¿‡ï¼Œå¯¹äº closure ç±»å‹æ¥è¯´ï¼Œç¼–è¯‘å™¨çŸ¥é“åƒå‡½æ•°ä¸€æ ·è°ƒç”¨é—­åŒ… c4() æ˜¯åˆæ³•çš„ï¼Œå¹¶ä¸”çŸ¥é“æ‰§è¡Œ c4() æ—¶ï¼Œä»£ç åº”è¯¥è·³è½¬åˆ°ä»€ä¹ˆåœ°å€æ¥æ‰§è¡Œã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ° nameã€tableï¼Œå¯ä»¥ä»è‡ªå·±çš„æ•°æ®ç»“æ„ä¸­è·å–ã€‚</p>
<p>é‚£ä¹ˆå¤šæƒ³ä¸€æ­¥ï¼Œé—­åŒ…æ•è·å˜é‡çš„é¡ºåºï¼Œå’Œå…¶å†…å­˜ç»“æ„çš„é¡ºåºæ˜¯ä¸€è‡´çš„ä¹ˆï¼Ÿ</p>
<p>çš„ç¡®å¦‚æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è°ƒæ•´é—­åŒ…é‡Œä½¿ç”¨ name1 å’Œ table çš„é¡ºåºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let c4 = move || println!(&quot;hello: {:?}, {}&quot;, table, name1);
</code></pre></pre>
<p>å…¶æ•°æ®çš„ä½ç½®æ˜¯ç›¸åçš„ï¼Œç±»ä¼¼äºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Closure4 {
    table: HashMap&lt;&amp;str, &amp;str&gt; // (RandomState(16)|mask|ctrl|left|len)=48å­—èŠ‚
    name: String,  // (ptr|cap|len)=24å­—èŠ‚
}
</code></pre></pre>
<p>ä» gdb ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°åŒæ ·çš„ç»“æœï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F.png" alt="19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ" /></p>
<blockquote>
<p>ä¸è¿‡è¿™åªæ˜¯é€»è¾‘ä¸Šçš„ä½ç½®ï¼ŒRust ç¼–è¯‘å™¨ä¼šé‡æ’å†…å­˜ï¼Œè®©æ•°æ®èƒ½å¤Ÿä»¥æœ€å°çš„ä»£ä»·å¯¹é½ï¼Œæ‰€ä»¥æœ‰äº›æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸­æ•°æ®çš„é¡ºåºå¯èƒ½å’Œ struct å®šä¹‰ä¸ä¸€è‡´ã€‚</p>
</blockquote>
<p>æ‰€ä»¥å›åˆ°åˆšæ‰é—­åŒ…å’Œç»“æ„ä½“çš„æ¯”è¾ƒã€‚</p>
<p>åœ¨ Rust é‡Œï¼Œé—­åŒ…äº§ç”Ÿçš„åŒ¿åæ•°æ®ç±»å‹ï¼Œæ ¼å¼å’Œ struct æ˜¯ä¸€æ ·çš„ã€‚çœ‹å›¾ä¸­ gdb çš„è¾“å‡ºï¼Œé—­åŒ…æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå¹¶ä¸”é™¤äº†æ•è·çš„æ•°æ®å¤–ï¼Œé—­åŒ…æœ¬èº«ä¸åŒ…å«ä»»ä½•é¢å¤–å‡½æ•°æŒ‡é’ˆæŒ‡å‘é—­åŒ…çš„ä»£ç ã€‚å¦‚æœä½ ç†è§£äº† c3 / c4 è¿™ä¸¤ä¸ªé—­åŒ…ï¼Œc5 æ˜¯å¦‚ä½•æ„é€ çš„å°±å¾ˆå¥½ç†è§£äº†ã€‚</p>
<p>ç°åœ¨ï¼Œä½ æ˜¯ä¸æ˜¯å¯ä»¥å›ç­”ä¸ºä»€ä¹ˆ thread::spawn å¯¹ä¼ å…¥çš„é—­åŒ…çº¦æŸæ˜¯ Send + â€™static äº†ï¼Ÿç©¶ç«Ÿä»€ä¹ˆæ ·çš„é—­åŒ…æ»¡è¶³å®ƒå‘¢ï¼Ÿ</p>
<blockquote>
<p>å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨äº† move ä¸” move åˆ°é—­åŒ…å†…çš„æ•°æ®ç»“æ„æ»¡è¶³ Sendï¼Œå› ä¸ºæ­¤æ—¶ï¼Œé—­åŒ…çš„æ•°æ®ç»“æ„æ‹¥æœ‰æ‰€æœ‰æ•°æ®çš„æ‰€æœ‰æƒï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ â€™staticã€‚</p>
</blockquote>
</div>
</details>
<p>çœ‹å®Œ Rust é—­åŒ…çš„å†…å­˜ç»“æ„ï¼Œä½ æ˜¯ä¸æ˜¯æƒ³è¯´â€œå°±è¿™â€ï¼Œæ²¡å•¥ç‹¬ç‰¹ä¹‹å¤„å§ï¼Ÿä½†æ˜¯å¯¹æ¯”å…¶ä»–è¯­è¨€ï¼Œç»“åˆæ¥ä¸‹æ¥æˆ‘çš„è§£é‡Šï¼Œä½ å†ä»”ç»†æƒ³æƒ³å°±ä¼šæœ‰ä¸€ç§â€œè¿™æ€ä¹ˆå¯èƒ½â€çš„æƒŠè®¶ã€‚</p>
<h2 id="ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡"><a class="header" href="#ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡">ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡</a></h2>
<details id="admonition-å…¶ä»–è¯­è¨€é—­åŒ…è®¾è®¡æœ‰ä»€ä¹ˆé—®é¢˜ä¸ºä½•rustå¯ä»¥ä¿è¯é—­åŒ…çš„æ€§èƒ½ä¸å‡½æ•°å·®ä¸å¤š" class="admonition info">
<summary class="admonition-title">
<p>å…¶ä»–è¯­è¨€é—­åŒ…è®¾è®¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿä¸ºä½•Rustå¯ä»¥ä¿è¯é—­åŒ…çš„æ€§èƒ½ä¸å‡½æ•°å·®ä¸å¤š</p>
<p><a class="admonition-anchor-link" href="#admonition-å…¶ä»–è¯­è¨€é—­åŒ…è®¾è®¡æœ‰ä»€ä¹ˆé—®é¢˜ä¸ºä½•rustå¯ä»¥ä¿è¯é—­åŒ…çš„æ€§èƒ½ä¸å‡½æ•°å·®ä¸å¤š"></a></p>
</summary>
<div>
<p>é—­åŒ…æœ€å¤§çš„é—®é¢˜æ˜¯å˜é‡çš„å¤šé‡å¼•ç”¨å¯¼è‡´ç”Ÿå‘½å‘¨æœŸä¸æ˜ç¡®ï¼Œæ‰€ä»¥ä½ å…ˆæƒ³ï¼Œå…¶å®ƒæ”¯æŒé—­åŒ…çš„è¯­è¨€ï¼ˆlambda ä¹Ÿæ˜¯é—­åŒ…ï¼‰ï¼Œå®ƒä»¬çš„é—­åŒ…ä¼šæ”¾åœ¨å“ªé‡Œï¼Ÿ</p>
<p>æ ˆä¸Šä¹ˆï¼Ÿæ˜¯ï¼Œåˆå¥½åƒä¸æ˜¯ã€‚</p>
<p>å› ä¸ºé—­åŒ…è¿™ç©æ„ï¼Œä»å½“å‰ä¸Šä¸‹æ–‡ä¸­æ•è·äº†äº›å˜é‡ï¼Œå˜å¾—æœ‰ç‚¹ä¸ä¼¦ä¸ç±»ï¼Œä¸åƒå‡½æ•°é‚£æ ·æ¸…æ¥šï¼Œå°¤å…¶æ˜¯è¿™äº›è¢«æ•è·çš„å˜é‡ï¼Œå®ƒä»¬çš„å½’å±å’Œç”Ÿå‘½å‘¨æœŸå¤„ç†èµ·æ¥å¾ˆéº»çƒ¦ã€‚æ‰€ä»¥ï¼Œå¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€çš„é—­åŒ…å¾ˆå¤šæ—¶å€™æ— æ³•æ”¾åœ¨æ ˆä¸Šï¼Œéœ€è¦é¢å¤–çš„å †åˆ†é…ã€‚<a href="https://github.com/golang/go/issues/43210">ä½ å¯ä»¥çœ‹è¿™ä¸ª Golang çš„ä¾‹å­</a>ã€‚</p>
<p>ä¸å…‰ Golangï¼ŒJava / Swift / Python / JavaScript ç­‰è¯­è¨€éƒ½æ˜¯å¦‚æ­¤ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€é—­åŒ…çš„æ€§èƒ½è¦è¿œä½äºå‡½æ•°è°ƒç”¨ã€‚</p>
<p>å› ä¸ºä½¿ç”¨é—­åŒ…å°±æ„å‘³ç€ï¼š</p>
<ol>
<li>é¢å¤–çš„å †å†…å­˜åˆ†é…</li>
<li>æ½œåœ¨çš„åŠ¨æ€åˆ†æ´¾ï¼ˆå¾ˆå¤šè¯­è¨€ä¼šæŠŠé—­åŒ…å¤„ç†æˆå‡½æ•°æŒ‡é’ˆï¼‰</li>
<li>é¢å¤–çš„å†…å­˜å›æ”¶ã€‚</li>
</ol>
<p>åœ¨æ€§èƒ½ä¸Šï¼Œå”¯æœ‰ C++ çš„ lambda å’Œ Rust é—­åŒ…ç±»ä¼¼ï¼Œä¸è¿‡ C++ çš„é—­åŒ…è¿˜æœ‰ä¸€äº›åœºæ™¯ä¼šè§¦å‘å †å†…å­˜åˆ†é…ã€‚</p>
<p>Rust / Swift / Kotlin iterator å‡½æ•°å¼ç¼–ç¨‹çš„æ€§èƒ½æµ‹è¯•ï¼š</p>
<ol>
<li>Kotlin è¿è¡Œè¶…æ—¶</li>
<li>Swift å¾ˆæ…¢</li>
<li>Rust çš„æ€§èƒ½å´å’Œä½¿ç”¨å‘½ä»¤å¼ç¼–ç¨‹çš„ C å‡ ä¹ä¸€æ ·ï¼Œé™¤äº†ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ•ˆæœï¼Œä¹Ÿå› ä¸º Rust é—­åŒ…çš„æ€§èƒ½å’Œå‡½æ•°å·®ä¸å¤šã€‚</li>
</ol>
<blockquote>
<p>ä¸ºä»€ä¹ˆ Rust å¯ä»¥åšåˆ°è¿™æ ·å‘¢ï¼Ÿ</p>
</blockquote>
<p>è¿™åˆè·Ÿ Rust ä»æ ¹æœ¬ä¸Šä½¿ç”¨æ‰€æœ‰æƒå’Œå€Ÿç”¨ï¼Œè§£å†³äº†å†…å­˜å½’å±é—®é¢˜æœ‰å…³ã€‚</p>
<p>åœ¨å…¶ä»–è¯­è¨€ä¸­ï¼Œé—­åŒ…å˜é‡å› ä¸ºå¤šé‡å¼•ç”¨å¯¼è‡´ç”Ÿå‘½å‘¨æœŸä¸æ˜ç¡®ï¼Œä½† Rust ä»ä¸€å¼€å§‹å°±æ¶ˆç­äº†è¿™ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>
<p>å¦‚æœä¸ä½¿ç”¨ move è½¬ç§»æ‰€æœ‰æƒï¼Œé—­åŒ…ä¼šå¼•ç”¨ä¸Šä¸‹æ–‡ä¸­çš„å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å—å€Ÿç”¨è§„åˆ™çš„çº¦æŸï¼Œæ‰€ä»¥åªè¦ç¼–è¯‘é€šè¿‡ï¼Œé‚£ä¹ˆé—­åŒ…å¯¹å˜é‡çš„å¼•ç”¨å°±ä¸ä¼šè¶…è¿‡å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ²¡æœ‰å†…å­˜å®‰å…¨é—®é¢˜ã€‚</p>
</li>
<li>
<p>å¦‚æœä½¿ç”¨ move è½¬ç§»æ‰€æœ‰æƒï¼Œä¸Šä¸‹æ–‡ä¸­çš„å˜é‡åœ¨è½¬ç§»åå°±æ— æ³•è®¿é—®ï¼Œé—­åŒ…å®Œå…¨æ¥ç®¡è¿™äº›å˜é‡ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œé—­åŒ…ä¸€è‡´ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šæœ‰å†…å­˜å®‰å…¨é—®é¢˜ã€‚</p>
</li>
<li>
<p>è€Œ Rust ä¸ºæ¯ä¸ªé—­åŒ…ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œåˆä½¿å¾—è°ƒç”¨é—­åŒ…æ—¶å¯ä»¥ç›´æ¥å’Œä»£ç å¯¹åº”ï¼Œçœå»äº†ä½¿ç”¨å‡½æ•°æŒ‡é’ˆå†è½¬ä¸€é“æ‰‹çš„é¢å¤–æ¶ˆè€—ã€‚</p>
</li>
</ul>
<blockquote>
<p>æ‰€ä»¥è¿˜æ˜¯é‚£å¥è¯ï¼Œå½“å›å½’åˆ°æœ€åˆçš„æœ¬åŸï¼Œä½ è§£å†³çš„ä¸æ˜¯å•ä¸ªé—®é¢˜ï¼Œè€Œæ˜¯ç”±æ­¤å¼•å‘çš„æ‰€æœ‰é—®é¢˜ã€‚æˆ‘ä»¬ä¸å¿…ä¸ºå †å†…å­˜ç®¡ç†è®¾è®¡ GCã€ä¸å¿…ä¸ºå…¶å®ƒèµ„æºçš„å›æ”¶æä¾› defer å…³é”®å­—ã€ä¸å¿…ä¸ºå¹¶å‘å®‰å…¨è¿›è¡Œè¯¸å¤šé™åˆ¶ã€ä¹Ÿä¸å¿…ä¸ºé—­åŒ…æŒ–ç©ºå¿ƒæ€æä¼˜åŒ–ã€‚</p>
</blockquote>
</div>
</details>
<h2 id="rust-çš„é—­åŒ…ç±»å‹"><a class="header" href="#rust-çš„é—­åŒ…ç±»å‹">Rust çš„é—­åŒ…ç±»å‹</a></h2>
<p>ç°åœ¨æˆ‘ä»¬ææ˜ç™½äº†é—­åŒ…ç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œåœ¨å†…å­˜ä¸­æ€ä¹ˆè¡¨ç¤ºï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ FnOnce / FnMut / Fn è¿™ä¸‰ç§é—­åŒ…ç±»å‹æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p>
<p>åœ¨å£°æ˜é—­åŒ…çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦æŒ‡å®šé—­åŒ…è¦æ»¡è¶³çš„çº¦æŸï¼Œä½†æ˜¯å½“é—­åŒ…ä½œä¸ºå‡½æ•°çš„å‚æ•°æˆ–è€…æ•°æ®ç»“æ„çš„ä¸€ä¸ªåŸŸæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰è°ƒç”¨è€…ï¼Œå¯¹é—­åŒ…çš„çº¦æŸã€‚</p>
<p>è¿˜ä»¥ thread::spawn ä¸ºä¾‹ï¼Œå®ƒè¦æ±‚ä¼ å…¥çš„é—­åŒ…æ»¡è¶³ FnOnce traitã€‚</p>
<h3 id="fnonce"><a class="header" href="#fnonce">FnOnce</a></h3>
<details id="admonition-fnonceå®šä¹‰-ä¾‹å­è§£æ" class="admonition info">
<summary class="admonition-title">
<p>FnOnceå®šä¹‰-&gt;ä¾‹å­è§£æ</p>
<p><a class="admonition-anchor-link" href="#admonition-fnonceå®šä¹‰-ä¾‹å­è§£æ"></a></p>
</summary>
<div>
<p>å…ˆæ¥çœ‹ FnOnceã€‚å®ƒçš„<a href="https://doc.rust-lang.org/std/ops/trait.FnOnce.html">å®šä¹‰</a>å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait FnOnce&lt;Args&gt; {
    type Output;
    extern &quot;rust-call&quot; fn call_once(self, args: Args) -&gt; Self::Output;
}
</code></pre></pre>
<ol>
<li>FnOnce æœ‰ä¸€ä¸ªå…³è”ç±»å‹ Outputï¼Œæ˜¾ç„¶ï¼Œå®ƒæ˜¯é—­åŒ…è¿”å›å€¼çš„ç±»å‹ï¼›</li>
<li>è¿˜æœ‰ä¸€ä¸ªæ–¹æ³• call_onceï¼Œè¦æ³¨æ„çš„æ˜¯ call_once ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼Œå®ƒä¼šè½¬ç§» self çš„æ‰€æœ‰æƒåˆ° call_once å‡½æ•°ä¸­ã€‚</li>
</ol>
<blockquote>
<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ FnOnce è¢«ç§°ä½œ Once ï¼šå®ƒåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚å†æ¬¡è°ƒç”¨ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥å˜é‡å·²ç»è¢« move è¿™æ ·çš„å¸¸è§æ‰€æœ‰æƒé”™è¯¯äº†ã€‚</p>
</blockquote>
<p>è‡³äº FnOnce çš„å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå« Args çš„æ³›å‹å‚æ•°ï¼Œå®ƒå¹¶æ²¡æœ‰ä»»ä½•çº¦æŸã€‚</p>
<p>çœ‹ä¸€ä¸ªéšå¼çš„ FnOnce çš„ä¾‹å­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let name = String::from(&quot;Tyr&quot;);
    // è¿™ä¸ªé—­åŒ…å•¥ä¹Ÿä¸å¹²ï¼Œåªæ˜¯æŠŠæ•è·çš„å‚æ•°è¿”å›å»
    let c = move |greeting: String| (greeting, name);

    let result = c(&quot;hello&quot;.to_string());

    println!(&quot;result: {:?}&quot;, result);

    // æ— æ³•å†æ¬¡è°ƒç”¨
    let result = c(&quot;hi&quot;.to_string());
}
</code></pre></pre>
<ol>
<li>è¿™ä¸ªé—­åŒ… cï¼Œå•¥ä¹Ÿæ²¡åšï¼Œåªæ˜¯æŠŠæ•è·çš„å‚æ•°è¿”å›ã€‚</li>
<li>å°±åƒä¸€ä¸ªç»“æ„ä½“é‡Œï¼ŒæŸä¸ªå­—æ®µè¢«è½¬ç§»èµ°ä¹‹åï¼Œå°±ä¸èƒ½å†è®¿é—®ä¸€æ ·ï¼Œé—­åŒ…å†…éƒ¨çš„æ•°æ®ä¸€æ—¦è¢«è½¬ç§»ï¼Œè¿™ä¸ªé—­åŒ…å°±ä¸å®Œæ•´äº†ï¼Œä¹Ÿå°±æ— æ³•å†æ¬¡ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª FnOnce çš„é—­åŒ…ã€‚</li>
</ol>
<p>å¦‚æœä¸€ä¸ªé—­åŒ…å¹¶ä¸è½¬ç§»è‡ªå·±çš„å†…éƒ¨æ•°æ®ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯ FnOnceï¼Œç„¶è€Œï¼Œä¸€æ—¦å®ƒè¢«å½“åš FnOnce è°ƒç”¨ï¼Œè‡ªå·±ä¼šè¢«è½¬ç§»åˆ° call_once å‡½æ•°çš„ä½œç”¨åŸŸä¸­ï¼Œä¹‹åå°±æ— æ³•å†æ¬¡è°ƒç”¨äº†ï¼Œæˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let name = String::from(&quot;Tyr&quot;);

    // è¿™ä¸ªé—­åŒ…ä¼š clone å†…éƒ¨çš„æ•°æ®è¿”å›ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯ FnOnce
    let c = move |greeting: String| (greeting, name.clone());

    // æ‰€ä»¥ c1 å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡

    println!(&quot;c1 call once: {:?}&quot;, c(&quot;qiao&quot;.into()));
    println!(&quot;c1 call twice: {:?}&quot;, c(&quot;bonjour&quot;.into()));

    // ç„¶è€Œä¸€æ—¦å®ƒè¢«å½“æˆ FnOnce è¢«è°ƒç”¨ï¼Œå°±æ— æ³•è¢«å†æ¬¡è°ƒç”¨
    println!(&quot;result: {:?}&quot;, call_once(&quot;hi&quot;.into(), c));

    // æ— æ³•å†æ¬¡è°ƒç”¨
    // let result = c(&quot;hi&quot;.to_string());

    // Fn ä¹Ÿå¯ä»¥è¢«å½“æˆ FnOnce è°ƒç”¨ï¼Œåªè¦æ¥å£ä¸€è‡´å°±å¯ä»¥
    println!(&quot;result: {:?}&quot;, call_once(&quot;hola&quot;.into(), not_closure));
}

fn call_once(arg: String, c: impl FnOnce(String) -&gt; (String, String)) -&gt; (String, String) {
    c(arg)
}

fn not_closure(arg: String) -&gt; (String, String) {
    (arg, &quot;Rosie&quot;.into())
}
</code></pre></pre>
</div>
</details>
<h3 id="æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢"><a class="header" href="#æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢">æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ</a></h3>
<details id="admonition-æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢" class="admonition info">
<summary class="admonition-title">
<p>æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢"></a></p>
</summary>
<div>
<p>Args åˆæ˜¯æ€ä¹ˆå’Œ FnOnce çš„çº¦æŸï¼Œæ¯”å¦‚ FnOnce(String) è¿™æ ·çš„å‚æ•°åŒ¹é…å‘¢ï¼Ÿæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå®ƒï¼ˆä¸å®Œå…¨ï¼‰æ¨¡æ‹Ÿäº† FnOnce ä¸­é—­åŒ…çš„ä½¿ç”¨ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct ClosureOnce&lt;Captured, Args, Output&gt; {
    // æ•è·çš„æ•°æ®
    captured: Captured,
    // closure çš„æ‰§è¡Œä»£ç 
    func: fn(Args, Captured) -&gt; Output,
}

impl&lt;Captured, Args, Output&gt; ClosureOnce&lt;Captured, Args, Output&gt; {
    // æ¨¡æ‹Ÿ FnOnce çš„ call_onceï¼Œç›´æ¥æ¶ˆè€— self
    fn call_once(self, greeting: Args) -&gt; Output {
        (self.func)(greeting, self.captured)
    }
}

// ç±»ä¼¼ greeting é—­åŒ…çš„å‡½æ•°ä½“
fn greeting_code1(args: (String,), captured: (String,)) -&gt; (String, String) {
    (args.0, captured.0)
}

fn greeting_code2(args: (String, String), captured: (String, u8)) -&gt; (String, String, String, u8) {
    (args.0, args.1, captured.0, captured.1)
}

fn main() {
    let name = &quot;Tyr&quot;.into();
    // æ¨¡æ‹Ÿå˜é‡æ•æ‰
    let c = ClosureOnce {
        captured: (name,),
        func: greeting_code1,
    };

    // æ¨¡æ‹Ÿé—­åŒ…è°ƒç”¨ï¼Œè¿™é‡Œå’Œ FnOnce ä¸å®Œå…¨ä¸€æ ·ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ª tuple æ¥åŒ¹é… Args å‚æ•°
    println!(&quot;{:?}&quot;, c.call_once((&quot;hola&quot;.into(),)));
    // è°ƒç”¨ä¸€æ¬¡åæ— æ³•ç»§ç»­è°ƒç”¨
    // println!(&quot;{:?}&quot;, clo.call_once(&quot;hola&quot;.into()));

    // æ›´å¤æ‚ä¸€äº›çš„å¤æ‚çš„é—­åŒ…
    let c1 = ClosureOnce {
        captured: (&quot;Tyr&quot;.into(), 18),
        func: greeting_code2,
    };

    println!(&quot;{:?}&quot;, c1.call_once((&quot;hola&quot;.into(), &quot;hallo&quot;.into())));
}
</code></pre></pre>
</div>
</details>
<h3 id="fnmut"><a class="header" href="#fnmut">FnMut</a></h3>
<details id="admonition-fnmutçš„å®šä¹‰ä¸ä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>FnMutçš„å®šä¹‰ä¸ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="#admonition-fnmutçš„å®šä¹‰ä¸ä¾‹å­"></a></p>
</summary>
<div>
<p>ç†è§£äº† FnOnceï¼Œæˆ‘ä»¬å†æ¥çœ‹ FnMutï¼Œ<a href="https://doc.rust-lang.org/std/ops/trait.FnMut.html">å®ƒçš„å®šä¹‰å¦‚ä¸‹</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait FnMut&lt;Args&gt;: FnOnce&lt;Args&gt; {
    extern &quot;rust-call&quot; fn call_mut(
        &amp;mut self, 
        args: Args
    ) -&gt; Self::Output;
}
</code></pre></pre>
<ol>
<li>é¦–å…ˆï¼ŒFnMut â€œç»§æ‰¿â€äº† FnOnceï¼Œæˆ–è€…è¯´ FnOnce æ˜¯ FnMut çš„ super traitã€‚</li>
<li>æ‰€ä»¥ FnMut ä¹Ÿæ‹¥æœ‰ Output è¿™ä¸ªå…³è”ç±»å‹å’Œ call_once è¿™ä¸ªæ–¹æ³•ã€‚</li>
<li>æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª call_mut() æ–¹æ³•ã€‚</li>
<li>æ³¨æ„ call_mut() ä¼ å…¥ &amp;mut selfï¼Œå®ƒä¸ç§»åŠ¨ selfï¼Œæ‰€ä»¥ FnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ã€‚</li>
</ol>
<blockquote>
<p>å› ä¸º FnOnce æ˜¯ FnMut çš„ super traitï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ª FnMut é—­åŒ…ï¼Œå¯ä»¥è¢«ä¼ ç»™ä¸€ä¸ªéœ€è¦ FnOnce çš„ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶è°ƒç”¨é—­åŒ…ç›¸å½“äºè°ƒç”¨äº† call_once()ã€‚</p>
</blockquote>
<p>å¦‚æœä½ ç†è§£äº†å‰é¢è®²çš„é—­åŒ…çš„å†…å­˜ç»„ç»‡ç»“æ„ï¼Œé‚£ä¹ˆ FnMut å°±ä¸éš¾ç†è§£ï¼Œå°±åƒç»“æ„ä½“å¦‚æœæƒ³æ”¹å˜æ•°æ®éœ€è¦ç”¨ let mut å£°æ˜ä¸€æ ·ï¼Œå¦‚æœä½ æƒ³æ”¹å˜é—­åŒ…æ•è·çš„æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆå°±éœ€è¦ FnMutã€‚</p>
<p>æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">

fn main() {
    let mut name = String::from(&quot;hello&quot;);
    let mut name1 = String::from(&quot;hola&quot;);

    // æ•è· &amp;mut name
    let mut c = || {
        name.push_str(&quot; Tyr&quot;);
        println!(&quot;c: {}&quot;, name);
    };

    // æ•è· mut name1ï¼Œæ³¨æ„ name1 éœ€è¦å£°æ˜æˆ mut
    let mut c1 = move || {
        name1.push_str(&quot;!&quot;);
        println!(&quot;c1: {}&quot;, name1);
    };

    c();
    c1();

    call_mut(&amp;mut c);
    call_mut(&amp;mut c1);

    call_once(c);
    call_once(c1);
}

// åœ¨ä½œä¸ºå‚æ•°æ—¶ï¼ŒFnMut ä¹Ÿè¦æ˜¾å¼åœ°ä½¿ç”¨ mutï¼Œæˆ–è€… &amp;mut
fn call_mut(c: &amp;mut impl FnMut()) {
    c();
}

// æƒ³æƒ³çœ‹ï¼Œä¸ºå•¥ call_once ä¸éœ€è¦ mutï¼Ÿ
fn call_once(c: impl FnOnce()) {
    c();
}

</code></pre></pre>
<ol>
<li>åœ¨å£°æ˜çš„é—­åŒ… c å’Œ c1 é‡Œï¼Œæˆ‘ä»¬ä¿®æ”¹äº†æ•è·çš„ name å’Œ name1ã€‚</li>
<li>ä¸åŒçš„æ˜¯ name ä½¿ç”¨äº†å¼•ç”¨ï¼Œè€Œ name1 ç§»åŠ¨äº†æ‰€æœ‰æƒï¼Œè¿™ä¸¤ç§æƒ…å†µå’Œå…¶å®ƒä»£ç ä¸€æ ·ï¼Œä¹Ÿéœ€è¦éµå¾ªæ‰€æœ‰æƒå’Œå€Ÿç”¨æœ‰å…³çš„è§„åˆ™ã€‚</li>
<li>æ‰€ä»¥ï¼Œå¦‚æœåœ¨é—­åŒ… c é‡Œå€Ÿç”¨äº† nameï¼Œä½ å°±ä¸èƒ½æŠŠ name ç§»åŠ¨ç»™å¦ä¸€ä¸ªé—­åŒ… c1ã€‚</li>
</ol>
<blockquote>
<p>è¿™é‡Œä¹Ÿå±•ç¤ºäº†ï¼Œc å’Œ c1 è¿™ä¸¤ä¸ªç¬¦åˆ FnMut çš„é—­åŒ…ï¼Œèƒ½ä½œä¸º FnOnce æ¥è°ƒç”¨ã€‚æˆ‘ä»¬åœ¨ä»£ç ä¸­ä¹Ÿç¡®è®¤äº†ï¼ŒFnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸º call_mut() ä½¿ç”¨çš„æ˜¯ &amp;mut selfï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒã€‚</p>
</blockquote>
</div>
</details>
<h3 id="fn"><a class="header" href="#fn">Fn</a></h3>
<details id="admonition-fnçš„å®šä¹‰ä¸ä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>Fnçš„å®šä¹‰ä¸ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="#admonition-fnçš„å®šä¹‰ä¸ä¾‹å­"></a></p>
</summary>
<div>
<p>æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ Fn traitã€‚<a href="https://doc.rust-lang.org/std/ops/trait.Fn.html">å®ƒçš„å®šä¹‰å¦‚ä¸‹</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Fn&lt;Args&gt;: FnMut&lt;Args&gt; {
    extern &quot;rust-call&quot; fn call(&amp;self, args: Args) -&gt; Self::Output;
}
</code></pre></pre>
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒâ€œç»§æ‰¿â€äº† FnMutï¼Œæˆ–è€…è¯´ FnMut æ˜¯ Fn çš„ super traitã€‚</li>
<li>è¿™ä¹Ÿå°±æ„å‘³ç€ä»»ä½•éœ€è¦ FnOnce æˆ–è€… FnMut çš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼ å…¥æ»¡è¶³ Fn çš„é—­åŒ…ã€‚</li>
</ol>
<p>æˆ‘ä»¬ç»§ç»­çœ‹ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let v = vec![0u8; 1024];
    let v1 = vec![0u8; 1023];

    // Fnï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒ
    let mut c = |x: u64| v.len() as u64 * x;
    // Fnï¼Œç§»åŠ¨æ‰€æœ‰æƒ
    let mut c1 = move |x: u64| v1.len() as u64 * x;

    println!(&quot;direct call: {}&quot;, c(2));
    println!(&quot;direct call: {}&quot;, c1(2));

    println!(&quot;call: {}&quot;, call(3, &amp;c));
    println!(&quot;call: {}&quot;, call(3, &amp;c1));

    println!(&quot;call_mut: {}&quot;, call_mut(4, &amp;mut c));
    println!(&quot;call_mut: {}&quot;, call_mut(4, &amp;mut c1));

    println!(&quot;call_once: {}&quot;, call_once(5, c));
    println!(&quot;call_once: {}&quot;, call_once(5, c1));
}

fn call(arg: u64, c: &amp;impl Fn(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}

fn call_mut(arg: u64, c: &amp;mut impl FnMut(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}

fn call_once(arg: u64, c: impl FnOnce(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}
</code></pre></pre>
</div>
</details>
<h3 id="æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»"><a class="header" href="#æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»">æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»</a></h3>
<details id="admonition-æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»" class="admonition info">
<summary class="admonition-title">
<p>æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»</p>
<p><a class="admonition-anchor-link" href="#admonition-æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F.jpg" alt="19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ" /></p>
</div>
</details>
<h2 id="é—­åŒ…çš„ä½¿ç”¨åœºæ™¯"><a class="header" href="#é—­åŒ…çš„ä½¿ç”¨åœºæ™¯">é—­åŒ…çš„ä½¿ç”¨åœºæ™¯</a></h2>
<details id="admonition-åœ¨å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸­ä½¿ç”¨é—­åŒ…" class="admonition info">
<summary class="admonition-title">
<p>åœ¨å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸­ä½¿ç”¨é—­åŒ…</p>
<p><a class="admonition-anchor-link" href="#admonition-åœ¨å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸­ä½¿ç”¨é—­åŒ…"></a></p>
</summary>
<div>
<p>thread::spawn è‡ªä¸å¿…è¯´ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ Iterator trait é‡Œé¢å¤§éƒ¨åˆ†å‡½æ•°éƒ½æ¥å—ä¸€ä¸ªé—­åŒ…ï¼Œ<a href="https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#682-685">æ¯”å¦‚ map</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn map&lt;B, F&gt;(self, f: F) -&gt; Map&lt;Self, F&gt;
where
    Self: Sized,
    F: FnMut(Self::Item) -&gt; B,
{
    Map::new(self, f)
}
</code></pre></pre>
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼ŒIterator çš„ map() æ–¹æ³•æ¥å—ä¸€ä¸ª FnMut</li>
<li>å®ƒçš„å‚æ•°æ˜¯ Self::Item</li>
<li>è¿”å›å€¼æ˜¯æ²¡æœ‰çº¦æŸçš„æ³›å‹å‚æ•° Bã€‚</li>
<li>Self::Item æ˜¯ Iterator::next() æ–¹æ³•åå‡ºæ¥çš„æ•°æ®ï¼Œè¢« map ä¹‹åï¼Œå¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªç»“æœã€‚</li>
</ol>
<p>æ‰€ä»¥åœ¨å‡½æ•°çš„å‚æ•°ä¸­ä½¿ç”¨é—­åŒ…ï¼Œæ˜¯é—­åŒ…ä¸€ç§éå¸¸å…¸å‹çš„ç”¨æ³•ã€‚å¦å¤–é—­åŒ…ä¹Ÿå¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::ops::Mul;

fn main() {
    let c1 = curry(5);
    println!(&quot;5 multiply 2 is: {}&quot;, c1(2));

    let adder2 = curry(3.14);
    println!(&quot;pi multiply 4^2 is: {}&quot;, adder2(4. * 4.));
}

fn curry&lt;T&gt;(x: T) -&gt; impl Fn(T) -&gt; T
where
    T: Mul&lt;Output = T&gt; + Copy,
{
    move |y| x * y
}
</code></pre></pre>
</div>
</details>
<details id="admonition-ä¸ºé—­åŒ…å®ç°æŸä¸ª-traitä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨" class="admonition info">
<summary class="admonition-title">
<p>ä¸ºé—­åŒ…å®ç°æŸä¸ª traitï¼Œä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨ã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸ºé—­åŒ…å®ç°æŸä¸ª-traitä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨"></a></p>
</summary>
<div>
<p>æœ€åï¼Œé—­åŒ…è¿˜æœ‰ä¸€ç§å¹¶ä¸å°‘è§ï¼Œä½†å¯èƒ½ä¸å¤ªå®¹æ˜“ç†è§£çš„ç”¨æ³•ï¼š</p>
<p>ä¸ºå®ƒå®ç°æŸä¸ª traitï¼Œä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨ã€‚</p>
<p>æ¯”å¦‚è¯´æœ‰äº›æ¥å£æ—¢å¯ä»¥ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“ï¼Œåˆå¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°æˆ–è€…é—­åŒ…ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬çœ‹ä¸€ä¸ª <a href="https://github.com/hyperium/tonic">tonicï¼ˆRust ä¸‹çš„ gRPC åº“ï¼‰</a>çš„<a href="https://docs.rs/tonic/0.5.2/src/tonic/service/interceptor.rs.html#41-53">ä¾‹å­</a></p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Interceptor {
    /// Intercept a request before it is sent, optionally cancelling it.
    fn call(&amp;mut self, request: crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt;;
}

impl&lt;F&gt; Interceptor for F
where
    F: FnMut(crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt;,
{
    fn call(&amp;mut self, request: crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt; {
        self(request)
    }
}
</code></pre></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼ŒInterceptor æœ‰ä¸€ä¸ª call æ–¹æ³•ï¼Œå®ƒå¯ä»¥è®© gRPC Request è¢«å‘é€å‡ºå»ä¹‹å‰è¢«ä¿®æ”¹ï¼Œä¸€èˆ¬æ˜¯æ·»åŠ å„ç§å¤´ï¼Œæ¯”å¦‚ Authorization å¤´ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œä¸ºå®ƒå®ç° Interceptorï¼Œä¸è¿‡å¤§éƒ¨åˆ†æ—¶å€™ Interceptor å¯ä»¥ç›´æ¥é€šè¿‡ä¸€ä¸ªé—­åŒ…å‡½æ•°å®Œæˆã€‚ä¸ºäº†è®©ä¼ å…¥çš„é—­åŒ…ä¹Ÿèƒ½é€šè¿‡ Interceptor::call() æ¥ç»Ÿä¸€è°ƒç”¨ï¼Œå¯ä»¥ä¸ºç¬¦åˆæŸä¸ªæ¥å£çš„é—­åŒ…å®ç° Interceptor traitã€‚æŒæ¡äº†è¿™ç§ç”¨æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŸäº› trait æŠŠç‰¹å®šçš„ç»“æ„ä½“å’Œé—­åŒ…ç»Ÿä¸€èµ·æ¥è°ƒç”¨ï¼Œæ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ã€‚</p>
</div>
</details>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="2_3_trait.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="4_macros.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="2_3_trait.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="4_macros.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
