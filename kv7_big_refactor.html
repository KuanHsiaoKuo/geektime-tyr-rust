<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>é‡å¤§é‡æ„ - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_3_0_trait_overview.html"><strong aria-hidden="true">4.2.3.1.</strong> traitæ¦‚è§ˆ</a></li><li class="chapter-item "><a href="2_3_1_trait_impl.html"><strong aria-hidden="true">4.2.3.2.</strong> Trait Impl</a></li><li class="chapter-item "><a href="2_3_2_trait_object.html"><strong aria-hidden="true">4.2.3.3.</strong> Trait Object</a></li><li class="chapter-item "><a href="2_3_3_trait_frequently.html"><strong aria-hidden="true">4.2.3.4.</strong> å¸¸ç”¨trait</a></li><li class="chapter-item "><a href="2_3_4_trait_design.html"><strong aria-hidden="true">4.2.3.5.</strong> Traitè®¾è®¡</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a></li><li class="chapter-item "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a></li><li class="chapter-item "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a></li><li class="chapter-item "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item "><a href="5_2_future_async_await.html"><strong aria-hidden="true">4.5.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">4.5.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html" class="active"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="ä¸ƒå¦‚ä½•åšå¤§çš„é‡æ„"><a class="header" href="#ä¸ƒå¦‚ä½•åšå¤§çš„é‡æ„">ä¸ƒã€å¦‚ä½•åšå¤§çš„é‡æ„ï¼Ÿ</a></h1>
<!--ts-->
<ul>
<li><a href="#%E4%B8%83%E5%A6%82%E4%BD%95%E5%81%9A%E5%A4%A7%E7%9A%84%E9%87%8D%E6%9E%84">ä¸ƒã€å¦‚ä½•åšå¤§çš„é‡æ„ï¼Ÿ</a>
<ul>
<li><a href="#%E7%8E%B0%E6%9C%89%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90">ç°æœ‰æ¶æ„åˆ†æ</a></li>
<li><a href="#%E8%A6%81%E6%94%AF%E6%8C%81-pubsub%E7%8E%B0%E6%9C%89%E6%9E%B6%E6%9E%84%E6%9C%89%E4%B8%A4%E4%B8%AA%E5%BE%88%E5%A4%A7%E7%9A%84%E9%97%AE%E9%A2%98">è¦æ”¯æŒ Pub/Subï¼Œç°æœ‰æ¶æ„æœ‰ä¸¤ä¸ªå¾ˆå¤§çš„é—®é¢˜ã€‚</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-yamux-%E5%81%9A%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8">ä½¿ç”¨ yamux åšå¤šè·¯å¤ç”¨</a></li>
<li><a href="#%E6%94%AF%E6%8C%81-pubsub">æ”¯æŒ pub/sub</a>
<ul>
<li><a href="#pubsub-%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1">Pub/Sub å¦‚ä½•è®¾è®¡ï¼Ÿ</a></li>
<li><a href="#pubsub-%E7%9A%84%E5%AE%9E%E7%8E%B0">Pub/Sub çš„å®ç°</a></li>
<li><a href="#%E5%9C%A8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E4%B8%AD%E5%BC%95%E5%85%A5-pubsub">åœ¨å¤„ç†æµç¨‹ä¸­å¼•å…¥ Pub/Sub</a></li>
<li><a href="#%E7%BB%A7%E7%BB%AD%E9%87%8D%E6%9E%84%E5%BC%A5%E8%A1%A5%E8%AE%BE%E8%AE%A1%E4%B8%8A%E7%9A%84%E5%B0%8F%E9%97%AE%E9%A2%98">ç»§ç»­é‡æ„ï¼šå¼¥è¡¥è®¾è®¡ä¸Šçš„å°é—®é¢˜</a></li>
<li><a href="#%E8%AE%A9%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%83%BD%E6%9B%B4%E5%A5%BD%E5%9C%B0%E4%BD%BF%E7%94%A8%E6%96%B0%E7%9A%84%E6%8E%A5%E5%8F%A3">è®©å®¢æˆ·ç«¯èƒ½æ›´å¥½åœ°ä½¿ç”¨æ–°çš„æ¥å£</a></li>
</ul>
</li>
<li><a href="#%E4%BD%A0%E5%8F%AF%E4%BB%A5%E4%BB%94%E7%BB%86%E9%98%85%E8%AF%BB%E8%BF%99%E4%B8%80%E8%8A%82%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E5%A5%BD%E5%A5%BD%E5%93%81%E5%91%B3%E8%BF%99%E4%BA%9B%E6%8E%A5%E5%8F%A3%E7%9A%84%E8%AE%BE%E8%AE%A1">ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€èŠ‚ä¸­çš„ä»£ç ï¼Œå¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡ã€‚</a></li>
<li><a href="#%E4%B8%80%E4%BA%9B%E7%9B%B8%E5%85%B3%E8%80%83%E8%99%91">ä¸€äº›ç›¸å…³è€ƒè™‘</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sat Oct 15 10:13:55 UTC 2022 -->
<!--te-->
<h2 id="ç°æœ‰æ¶æ„åˆ†æ"><a class="header" href="#ç°æœ‰æ¶æ„åˆ†æ">ç°æœ‰æ¶æ„åˆ†æ</a></h2>
<details id="admonition-å…ˆç®€å•å›é¡¾ä¸€ä¸‹-redis-å¯¹-pubsub-çš„æ”¯æŒ" class="admonition info">
<summary class="admonition-title">
<p>å…ˆç®€å•å›é¡¾ä¸€ä¸‹ Redis å¯¹ Pub/Sub çš„æ”¯æŒ </p>
<p><a class="admonition-anchor-link" href="#admonition-å…ˆç®€å•å›é¡¾ä¸€ä¸‹-redis-å¯¹-pubsub-çš„æ”¯æŒ"></a></p>
</summary>
<div>
<ol>
<li>å®¢æˆ·ç«¯å¯ä»¥éšæ—¶å‘èµ· SUBSCRIBEã€PUBLISH å’Œ UNSUBSCRIBEã€‚</li>
<li>å¦‚æœå®¢æˆ·ç«¯ A å’Œ B SUBSCRIBE äº†ä¸€ä¸ªå« lobby çš„ä¸»é¢˜ï¼Œå®¢æˆ·ç«¯ C å¾€ lobby é‡Œå‘äº† â€œhelloâ€ï¼ŒA å’Œ B éƒ½å°†ç«‹å³æ”¶åˆ°è¿™ä¸ªä¿¡æ¯ã€‚</li>
<li>ä½¿ç”¨èµ·æ¥æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</li>
</ol>
<pre><code class="language-shell">A: SUBSCRIBE &quot;lobby&quot;
A: SUBSCRIBE &quot;ç‹è€…è£è€€&quot;
B: SUBSCRIBE &quot;lobby&quot;
C: PUBLISH &quot;lobby&quot; &quot;hello&quot;
// A/B éƒ½æ”¶åˆ° &quot;hello&quot;
B: UNSUBSCRIBE &quot;lobby&quot;
B: SUBSCRIBE &quot;ç‹è€…è£è€€&quot;
D: PUBLISH &quot;lobby&quot; &quot;goodbye&quot;
// åªæœ‰ A æ”¶åˆ° &quot;goodbye&quot;
C: PUBLISH &quot;ç‹è€…è£è€€&quot; &quot;good game&quot;
// A/B éƒ½æ”¶åˆ° &quot;good game&quot;
</code></pre>
</div>
</details>
<details id="admonition--å¸¦ç€è¿™ä¸ªéœ€æ±‚æˆ‘ä»¬é‡æ–°å®¡è§†ç›®å‰çš„æ¶æ„" class="admonition abstract">
<summary class="admonition-title">
<blockquote>
<p>å¸¦ç€è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬é‡æ–°å®¡è§†ç›®å‰çš„æ¶æ„ï¼š</p>
</blockquote>
<p><a class="admonition-anchor-link" href="#admonition--å¸¦ç€è¿™ä¸ªéœ€æ±‚æˆ‘ä»¬é‡æ–°å®¡è§†ç›®å‰çš„æ¶æ„"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/82da823b4eb16935fdeyy727e3b3262c-20221005230003663.jpg" alt="img" /></p>
</div>
</details>
<h2 id="è¦æ”¯æŒ-pubsubç°æœ‰æ¶æ„æœ‰ä¸¤ä¸ªå¾ˆå¤§çš„é—®é¢˜"><a class="header" href="#è¦æ”¯æŒ-pubsubç°æœ‰æ¶æ„æœ‰ä¸¤ä¸ªå¾ˆå¤§çš„é—®é¢˜">è¦æ”¯æŒ Pub/Subï¼Œç°æœ‰æ¶æ„æœ‰ä¸¤ä¸ªå¾ˆå¤§çš„é—®é¢˜ã€‚</a></h2>
<details id="admonition-1-commandserviceæ˜¯åŒæ­¥å¤„ç†" class="admonition info">
<summary class="admonition-title">
<ol>
<li>CommandServiceæ˜¯åŒæ­¥å¤„ç† </li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-1-commandserviceæ˜¯åŒæ­¥å¤„ç†"></a></p>
</summary>
<div>
<p>é¦–å…ˆï¼ŒCommandService æ˜¯ä¸€ä¸ªåŒæ­¥çš„å¤„ç†ï¼Œæ¥ä¸€ä¸ªå‘½ä»¤ï¼Œç«‹åˆ»å°±èƒ½è®¡ç®—å‡ºä¸€ä¸ªå€¼è¿”å›ã€‚ä½†ç°åœ¨æ¥ä¸€ä¸ª SUBSCRIBE å‘½ä»¤ï¼Œå®ƒæœŸå¾…çš„ä¸æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œæ˜¯æœªæ¥å¯èƒ½äº§ç”Ÿçš„è‹¥å¹²ä¸ªå€¼ã€‚è€Œ Stream ä»£è¡¨æœªæ¥å¯èƒ½äº§ç”Ÿçš„ä¸€ç³»åˆ—å€¼ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿”å›ä¸€ä¸ªå¼‚æ­¥çš„ Streamã€‚</p>
<p>å› æ­¤ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ€è·¯ï¼š</p>
<ol>
<li>è¦ä¹ˆéœ€è¦ç‰ºç‰² CommandService è¿™ä¸ª trait æ¥é€‚åº”æ–°çš„éœ€æ±‚</li>
<li>è¦ä¹ˆæ„å»ºä¸€ä¸ªæ–°çš„ã€å’Œ CommandService trait å¹¶åˆ—çš„ traitï¼Œæ¥å¤„ç†å’Œ Pub/Sub æœ‰å…³çš„å‘½ä»¤ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-å…¶æ¬¡å¦‚æœç›´æ¥åœ¨-tcptls-ä¹‹ä¸Šæ„å»º-pubsub-çš„æ”¯æŒæˆ‘ä»¬éœ€è¦åœ¨-request-å’Œ-response-ä¹‹é—´å»ºç«‹æµçš„æ¦‚å¿µä¸ºä»€ä¹ˆå‘¢" class="admonition info">
<summary class="admonition-title">
<p>å…¶æ¬¡ï¼Œå¦‚æœç›´æ¥åœ¨ TCP/TLS ä¹‹ä¸Šæ„å»º Pub/Sub çš„æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Request å’Œ Response ä¹‹é—´å»ºç«‹â€œæµâ€çš„æ¦‚å¿µï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ </p>
<p><a class="admonition-anchor-link" href="#admonition-å…¶æ¬¡å¦‚æœç›´æ¥åœ¨-tcptls-ä¹‹ä¸Šæ„å»º-pubsub-çš„æ”¯æŒæˆ‘ä»¬éœ€è¦åœ¨-request-å’Œ-response-ä¹‹é—´å»ºç«‹æµçš„æ¦‚å¿µä¸ºä»€ä¹ˆå‘¢"></a></p>
</summary>
<div>
<p>ä¹‹å‰æˆ‘ä»¬çš„åè®®è¿è¡Œæ¨¡å¼æ˜¯åŒæ­¥çš„ï¼Œä¸€æ¥ä¸€å›ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/7byy9cdb2c3651e4cd77bdda89a52968.jpg" alt="img" /></p>
<p>ä½†æ˜¯ï¼Œå¦‚æœç»§ç»­é‡‡ç”¨è¿™æ ·çš„æ–¹å¼ï¼Œå°±ä¼šæœ‰åº”ç”¨å±‚çš„ <a href="https://en.wikipedia.org/wiki/Head-of-line_blocking">head of line blockingï¼ˆé˜Ÿå¤´é˜»å¡ï¼‰é—®é¢˜</a>ï¼š</p>
<ul>
<li>
<p>ä¸€ä¸ª SUBSCRIBE å‘½ä»¤ï¼Œå› ä¸ºå…¶è¿”å›ç»“æœä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™æ‰ç»“æŸï¼Œä¼šé˜»å¡åç»­çš„æ‰€æœ‰å‘½ä»¤ã€‚</p>
</li>
<li>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªè¿æ¥é‡Œï¼Œåˆ’åˆ†å‡ºå¾ˆå¤šå½¼æ­¤ç‹¬ç«‹çš„â€œæµâ€ï¼Œè®©å®ƒä»¬çš„æ”¶å‘ä¸å—å½±å“ï¼š</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/67659457626d12eba6e26b37ayy08edb.jpg" alt="img" /></p>
</div>
</details>
<details id="admonition-æµå¼å¤„ç†çš„çš„å…¸å‹åè®®ä½¿ç”¨äº†å¤šè·¯å¤ç”¨çš„http2æœ‰ä¸¤ä¸ªæ–¹æ¡ˆé€‰æ‹©" class="admonition tip">
<summary class="admonition-title">
<p>æµå¼å¤„ç†çš„çš„å…¸å‹åè®®ä½¿ç”¨äº†å¤šè·¯å¤ç”¨çš„HTTP/2ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ¡ˆé€‰æ‹© </p>
<p><a class="admonition-anchor-link" href="#admonition-æµå¼å¤„ç†çš„çš„å…¸å‹åè®®ä½¿ç”¨äº†å¤šè·¯å¤ç”¨çš„http2æœ‰ä¸¤ä¸ªæ–¹æ¡ˆé€‰æ‹©"></a></p>
</summary>
<div>
<p>è¿™ç§æµå¼å¤„ç†çš„å…¸å‹åè®®æ˜¯ä½¿ç”¨äº†å¤šè·¯å¤ç”¨ï¼ˆmultiplexï¼‰çš„ HTTP/2ã€‚æ‰€ä»¥ï¼š</p>
<ol>
<li>
<p>ä¸€ç§æ–¹æ¡ˆæ˜¯æˆ‘ä»¬å¯ä»¥æŠŠ KV server æ„å»ºåœ¨ä½¿ç”¨ HTTP/2 çš„ gRPC ä¸Šã€‚ä¸è¿‡ï¼ŒHTTP æ˜¯ä¸ªå¤ªè¿‡åºæ‚çš„åè®®ï¼Œå¯¹äº KV server è¿™ç§æ€§èƒ½éå¸¸é‡è¦çš„æœåŠ¡æ¥è¯´ï¼Œä¸å¿…è¦çš„é¢å¤–å¼€é”€å¤ªå¤šï¼Œæ‰€ä»¥å®ƒä¸å¤ªé€‚åˆã€‚</p>
</li>
<li>
<p>å¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ <a href="https://github.com/hashicorp/yamux/blob/master/spec.md">Yamux åè®®</a>ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„ã€å’Œ HTTP/2 å†…éƒ¨å¤šè·¯å¤ç”¨æœºåˆ¶éå¸¸ç±»ä¼¼çš„åè®®ã€‚å¦‚æœä½¿ç”¨å®ƒï¼Œæ•´ä¸ªåè®®çš„äº¤äº’çœ‹ä¸Šå»æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/31f3efcd510ff6a3yy0caf32dbfd8667.jpg" alt="img" /></p>
<blockquote>
<p>Yamux é€‚åˆä¸å¸Œæœ›å¼•å…¥ HTTP çš„ç¹æ–‡ç¼›èŠ‚ï¼ˆå¤§é‡çš„å¤´ä¿¡æ¯ï¼‰ï¼Œåœ¨ TCP å±‚åšå¤šè·¯å¤ç”¨çš„åœºæ™¯ï¼Œè¿™é‡Œå°±ç”¨å®ƒæ¥æ”¯æŒæˆ‘ä»¬æ‰€è¦å®ç°çš„ Pub/Subã€‚</p>
</blockquote>
</div>
</details>
<h2 id="ä½¿ç”¨-yamux-åšå¤šè·¯å¤ç”¨"><a class="header" href="#ä½¿ç”¨-yamux-åšå¤šè·¯å¤ç”¨">ä½¿ç”¨ yamux åšå¤šè·¯å¤ç”¨</a></h2>
<p>Rust ä¸‹æœ‰lip2på‡ºå“çš„ <a href="https://github.com/libp2p/rust-yamux">rust-yamux</a> è¿™ä¸ªåº“ï¼Œæ¥æ”¯æŒ yamuxã€‚</p>
<details id="admonition-é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜éœ€è¦-tokio-utilå®ƒæä¾›äº†-tokio-ä¸‹çš„-trait-å’Œ-futures-ä¸‹çš„-trait-çš„å…¼å®¹èƒ½åŠ›" class="admonition note">
<summary class="admonition-title">
<p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ tokio-utilï¼Œå®ƒæä¾›äº† tokio ä¸‹çš„ trait å’Œ futures ä¸‹çš„ trait çš„å…¼å®¹èƒ½åŠ›ã€‚ </p>
<p><a class="admonition-anchor-link" href="#admonition-é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜éœ€è¦-tokio-utilå®ƒæä¾›äº†-tokio-ä¸‹çš„-trait-å’Œ-futures-ä¸‹çš„-trait-çš„å…¼å®¹èƒ½åŠ›"></a></p>
</summary>
<div>
<ol>
<li>åœ¨ Cargo.toml ä¸­å¼•å…¥å®ƒä»¬ï¼š</li>
</ol>
<pre><code class="language-toml">
[dependencies]
...
tokio-util = { version = &quot;0.6&quot;, features = [&quot;compat&quot;]} # tokio å’Œ futures çš„å…¼å®¹æ€§åº“
...
yamux = &quot;0.9&quot; # yamux å¤šè·¯å¤ç”¨æ”¯æŒ
...
</code></pre>
<ol start="2">
<li>ç„¶ååˆ›å»º src/network/multiplex.rsï¼ˆè®°å¾—åœ¨ mod.rs é‡Œå¼•ç”¨ï¼‰ï¼Œæ·»å…¥å¦‚ä¸‹ä»£ç ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use futures::{future, Future, TryStreamExt};
use std::marker::PhantomData;
use tokio::io::{AsyncRead, AsyncWrite};
use tokio_util::compat::{Compat, FuturesAsyncReadCompatExt, TokioAsyncReadCompatExt};
use yamux::{Config, Connection, ConnectionError, Control, Mode, WindowUpdateMode};

/// Yamux æ§åˆ¶ç»“æ„
pub struct YamuxCtrl&lt;S&gt; {
    /// yamux controlï¼Œç”¨äºåˆ›å»ºæ–°çš„ stream
    ctrl: Control,
    _conn: PhantomData&lt;S&gt;,
}

impl&lt;S&gt; YamuxCtrl&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send + 'static,
{
    /// åˆ›å»º yamux å®¢æˆ·ç«¯
    pub fn new_client(stream: S, config: Option&lt;Config&gt;) -&gt; Self {
        Self::new(stream, config, true, |_stream| future::ready(Ok(())))
    }

    /// åˆ›å»º yamux æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æˆ‘ä»¬éœ€è¦å…·ä½“å¤„ç† stream
    pub fn new_server&lt;F, Fut&gt;(stream: S, config: Option&lt;Config&gt;, f: F) -&gt; Self
    where
        F: FnMut(yamux::Stream) -&gt; Fut,
        F: Send + 'static,
        Fut: Future&lt;Output = Result&lt;(), ConnectionError&gt;&gt; + Send + 'static,
    {
        Self::new(stream, config, false, f)
    }

    // åˆ›å»º YamuxCtrl
    fn new&lt;F, Fut&gt;(stream: S, config: Option&lt;Config&gt;, is_client: bool, f: F) -&gt; Self
    where
        F: FnMut(yamux::Stream) -&gt; Fut,
        F: Send + 'static,
        Fut: Future&lt;Output = Result&lt;(), ConnectionError&gt;&gt; + Send + 'static,
    {
        let mode = if is_client {
            Mode::Client
        } else {
            Mode::Server
        };

        // åˆ›å»º config
        let mut config = config.unwrap_or_default();
        config.set_window_update_mode(WindowUpdateMode::OnRead);

        // åˆ›å»º configï¼Œyamux::Stream ä½¿ç”¨çš„æ˜¯ futures çš„ trait æ‰€ä»¥éœ€è¦ compat() åˆ° tokio çš„ trait
        let conn = Connection::new(stream.compat(), config, mode);

        // åˆ›å»º yamux ctrl
        let ctrl = conn.control();

        // pull æ‰€æœ‰ stream ä¸‹çš„æ•°æ®
        tokio::spawn(yamux::into_stream(conn).try_for_each_concurrent(None, f));

        Self {
            ctrl,
            _conn: PhantomData::default(),
        }
    }

    /// æ‰“å¼€ä¸€ä¸ªæ–°çš„ stream
    pub async fn open_stream(&amp;mut self) -&gt; Result&lt;Compat&lt;yamux::Stream&gt;, ConnectionError&gt; {
        let stream = self.ctrl.open_stream().await?;
        Ok(stream.compat())
    }
}
</code></pre></pre>
<p>è¿™æ®µä»£ç æä¾›äº† Yamux çš„åŸºæœ¬å¤„ç†ã€‚å¦‚æœæœ‰äº›åœ°æ–¹ä½ çœ‹ä¸æ˜ç™½ï¼Œæ¯”å¦‚ WindowUpdateModeï¼Œyamux::into_stream() ç­‰ï¼Œå¾ˆæ­£å¸¸ï¼Œéœ€è¦çœ‹çœ‹ <a href="https://github.com/libp2p/rust-yamux">yamux crate çš„æ–‡æ¡£å’Œä¾‹å­</a>(ç”±äºè¿™ä¸ªåº“æ²¡æœ‰å‘å¸ƒï¼Œæ‰€ä»¥åªèƒ½cloneæœ¬åœ°è¿è¡Œcargo docæŸ¥çœ‹)ã€‚</p>
</div>
</details>
<details id="admonition--è¿™é‡Œæœ‰ä¸€ä¸ªå¤æ‚çš„æ¥å£æˆ‘ä»¬ç¨å¾®è§£é‡Šä¸€ä¸‹" class="admonition example">
<summary class="admonition-title">
<blockquote>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªå¤æ‚çš„æ¥å£ï¼Œæˆ‘ä»¬ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼š</p>
</blockquote>
<p><a class="admonition-anchor-link" href="#admonition--è¿™é‡Œæœ‰ä¸€ä¸ªå¤æ‚çš„æ¥å£æˆ‘ä»¬ç¨å¾®è§£é‡Šä¸€ä¸‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn new_server&lt;F, Fut&gt;(stream: S, config: Option&lt;Config&gt;, f: F) -&gt; Self
where
    F: FnMut(yamux::Stream) -&gt; Fut,
    F: Send + 'static,
    Fut: Future&lt;Output = Result&lt;(), ConnectionError&gt;&gt; + Send + 'static,
{
    Self::new(stream, config, false, f)
}
</code></pre></pre>
<p>å®ƒçš„æ„æ€æ˜¯:</p>
<ul>
<li>å‚æ•° f æ˜¯ä¸€ä¸ª FnMut é—­åŒ…</li>
<li>æ¥å—ä¸€ä¸ª yamux::Stream å‚æ•°</li>
<li>è¿”å› Future</li>
</ul>
<p>è¿™æ ·çš„ç»“æ„æˆ‘ä»¬ä¹‹å‰è§è¿‡ï¼Œä¹‹æ‰€ä»¥æ¥å£è¿™ä¹ˆå¤æ‚ï¼Œæ˜¯å› ä¸º Rust è¿˜æ²¡æœ‰æŠŠ async é—­åŒ…ç¨³å®šä¸‹æ¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœè¦æƒ³å†™ä¸€ä¸ª async || {}ï¼Œè¿™æ˜¯æœ€ä½³çš„æ–¹å¼ã€‚</p>
</div>
</details>
<details id="admonition-æµ‹è¯•é€šè¿‡" class="admonition success">
<summary class="admonition-title">
<p>æµ‹è¯•é€šè¿‡ </p>
<p><a class="admonition-anchor-link" href="#admonition-æµ‹è¯•é€šè¿‡"></a></p>
</summary>
<div>
<p>è¿˜æ˜¯å†™ä¸€æ®µæµ‹è¯•æµ‹ä¸€ä¸‹ï¼ˆç¯‡å¹…å…³ç³»ï¼Œå®Œæ•´çš„ä»£ç å°±ä¸æ”¾äº†ï¼Œä½ å¯ä»¥åˆ° GitHub repo ä¸‹å¯¹ç…§ diff_yamux çœ‹ä¿®æ”¹ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[tokio::test]
async fn yamux_ctrl_client_server_should_work() -&gt; Result&lt;()&gt; {
    // åˆ›å»ºä½¿ç”¨äº† TLS çš„ yamux server
    let acceptor = tls_acceptor(false)?;
    let addr = start_yamux_server(&quot;127.0.0.1:0&quot;, acceptor, MemTable::new()).await?;

    let connector = tls_connector(false)?;
    let stream = TcpStream::connect(addr).await?;
    let stream = connector.connect(stream).await?;
    // åˆ›å»ºä½¿ç”¨äº† TLS çš„ yamux client
    let mut ctrl = YamuxCtrl::new_client(stream, None);

    // ä» client ctrl ä¸­æ‰“å¼€ä¸€ä¸ªæ–°çš„ yamux stream
    let stream = ctrl.open_stream().await?;
    // å°è£…æˆ ProstClientStream
    let mut client = ProstClientStream::new(stream);

    let cmd = CommandRequest::new_hset(&quot;t1&quot;, &quot;k1&quot;, &quot;v1&quot;.into());
    client.execute(cmd).await.unwrap();

    let cmd = CommandRequest::new_hget(&quot;t1&quot;, &quot;k1&quot;);
    let res = client.execute(cmd).await.unwrap();
    assert_res_ok(res, &amp;[&quot;v1&quot;.into()], &amp;[]);

    Ok(())
}
</code></pre></pre>
<p>å¯ä»¥çœ‹åˆ°:</p>
<ul>
<li>ç»è¿‡ç®€å•çš„å°è£…ï¼Œyamux å°±å¾ˆè‡ªç„¶åœ°èå…¥åˆ°æˆ‘ä»¬ç°æœ‰çš„æ¶æ„ä¸­</li>
<li>å› ä¸º open_stream() å¾—åˆ°çš„æ˜¯ç¬¦åˆ tokio AsyncRead / AsyncWrite çš„ streamï¼Œæ‰€ä»¥å®ƒå¯ä»¥ç›´æ¥é…åˆ ProstClientStream ä½¿ç”¨ã€‚</li>
<li>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç½‘ç»œå±‚åˆæ”¹åŠ¨äº†ä¸€ä¸‹ï¼Œä½†åé¢é€»è¾‘ä¾ç„¶ä¸ç”¨å˜ã€‚</li>
</ul>
<p>è¿è¡Œ cargo test ï¼Œæ‰€æœ‰æµ‹è¯•éƒ½èƒ½é€šè¿‡ã€‚</p>
</div>
</details>
<h2 id="æ”¯æŒ-pubsub"><a class="header" href="#æ”¯æŒ-pubsub">æ”¯æŒ pub/sub</a></h2>
<p>å¥½ï¼Œç°åœ¨ç½‘ç»œå±‚å·²ç»æ”¯æŒäº† yamuxï¼Œä¸ºå¤šè·¯å¤ç”¨æ‰“ä¸‹äº†åŸºç¡€ã€‚æˆ‘ä»¬æ¥çœ‹ pub/sub å…·ä½“æ€ä¹ˆå®ç°ã€‚</p>
<details id="admonition-é¦–å…ˆä¿®æ”¹-abiprotoåŠ å…¥æ–°çš„å‡ ä¸ªå‘½ä»¤" class="admonition note">
<summary class="admonition-title">
<p>é¦–å…ˆä¿®æ”¹ abi.protoï¼ŒåŠ å…¥æ–°çš„å‡ ä¸ªå‘½ä»¤ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-é¦–å…ˆä¿®æ”¹-abiprotoåŠ å…¥æ–°çš„å‡ ä¸ªå‘½ä»¤"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚
message CommandRequest {
  oneof request_data {
    ...
    Subscribe subscribe = 10;
    Unsubscribe unsubscribe = 11;
    Publish publish = 12;
  }
}

// subscribe åˆ°æŸä¸ªä¸»é¢˜ï¼Œä»»ä½•å‘å¸ƒåˆ°è¿™ä¸ªä¸»é¢˜çš„æ•°æ®éƒ½ä¼šè¢«æ”¶åˆ°
// æˆåŠŸåï¼Œç¬¬ä¸€ä¸ªè¿”å›çš„ CommandResponseï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªå”¯ä¸€çš„ subscription id
message Subscribe { string topic = 1; }

// å–æ¶ˆå¯¹æŸä¸ªä¸»é¢˜çš„è®¢é˜…
message Unsubscribe {
  string topic = 1;
  uint32 id = 2;
}

// å‘å¸ƒæ•°æ®åˆ°æŸä¸ªä¸»é¢˜
message Publish {
  string topic = 1;
  repeated Value data = 2;
}
</code></pre></pre>
</div>
</details>
<p>å‘½ä»¤çš„å“åº”æˆ‘ä»¬ä¸ç”¨æ”¹å˜ã€‚å½“å®¢æˆ·ç«¯ Subscribe æ—¶ï¼Œè¿”å›çš„ stream é‡Œçš„ç¬¬ä¸€ä¸ªå€¼åŒ…å«è®¢é˜… IDï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDï¼Œè¿™æ ·ï¼Œå®¢æˆ·ç«¯åç»­å¯ä»¥ç”¨ Unsubscribe å–æ¶ˆã€‚</p>
<h3 id="pubsub-å¦‚ä½•è®¾è®¡"><a class="header" href="#pubsub-å¦‚ä½•è®¾è®¡">Pub/Sub å¦‚ä½•è®¾è®¡ï¼Ÿ</a></h3>
<details id="admonition-é‚£ä¹ˆpubsub-è¯¥å¦‚ä½•å®ç°å‘¢" class="admonition question">
<summary class="admonition-title">
<p>é‚£ä¹ˆï¼ŒPub/Sub è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ </p>
<p><a class="admonition-anchor-link" href="#admonition-é‚£ä¹ˆpubsub-è¯¥å¦‚ä½•å®ç°å‘¢"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸¤å¼ è¡¨ï¼š</p>
<ul>
<li>ä¸€å¼  Topic Tableï¼Œå­˜æ”¾ä¸»é¢˜å’Œå¯¹åº”çš„è®¢é˜…åˆ—è¡¨ï¼›</li>
<li>ä¸€å¼  Subscription Tableï¼Œå­˜æ”¾è®¢é˜… ID å’Œ channel çš„å‘é€ç«¯ã€‚</li>
</ul>
<ol>
<li>å½“ SUBSCRIBE æ—¶ï¼Œæˆ‘ä»¬è·å–ä¸€ä¸ªè®¢é˜… IDï¼Œæ’å…¥åˆ° Topic Table</li>
<li>ç„¶åå†åˆ›å»ºä¸€ä¸ª MPSC channelï¼ŒæŠŠ channel çš„å‘é€ç«¯å’Œè®¢é˜… ID å­˜å…¥ subscription tableã€‚</li>
</ol>
<p>è¿™æ ·ï¼š</p>
<ul>
<li>å½“æœ‰äºº PUBLISH æ—¶ï¼Œå¯ä»¥ä» Topic table ä¸­æ‰¾åˆ°å¯¹åº”çš„è®¢é˜… ID çš„åˆ—è¡¨</li>
<li>ç„¶åå¾ªç¯ä» subscription table ä¸­æ‰¾åˆ°å¯¹åº”çš„ Senderï¼Œå¾€é‡Œé¢å†™å…¥æ•°æ®ã€‚</li>
<li>æ­¤æ—¶ï¼Œchannel çš„ Receiver ç«¯ä¼šå¾—åˆ°æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ä¼šè¢« yamux stream poll åˆ°ï¼Œç„¶åå‘ç»™å®¢æˆ·ç«¯ã€‚</li>
</ul>
</div>
</details>
<div id="admonition-æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º" class="admonition abstract">
<div class="admonition-title">
<p>æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/7ce3046af823dbbdaa7b47d12d04ce30.jpg" alt="img" /></p>
</div>
</div>
<details id="admonition-æœ‰äº†è¿™ä¸ªåŸºæœ¬è®¾è®¡æˆ‘ä»¬å¯ä»¥ç€æ‰‹æ¥å£å’Œæ•°æ®ç»“æ„çš„æ„å»ºäº†" class="admonition note">
<summary class="admonition-title">
<p>æœ‰äº†è¿™ä¸ªåŸºæœ¬è®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥ç€æ‰‹æ¥å£å’Œæ•°æ®ç»“æ„çš„æ„å»ºäº†ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-æœ‰äº†è¿™ä¸ªåŸºæœ¬è®¾è®¡æˆ‘ä»¬å¯ä»¥ç€æ‰‹æ¥å£å’Œæ•°æ®ç»“æ„çš„æ„å»ºäº†"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
/// ä¸‹ä¸€ä¸ª subscription id
static NEXT_ID: AtomicU32 = AtomicU32::new(1);

/// è·å–ä¸‹ä¸€ä¸ª subscription id
fn get_next_subscription_id() -&gt; u32 {
    NEXT_ID.fetch_add(1, Ordering::Relaxed)
}

pub trait Topic: Send + Sync + 'static {
    /// è®¢é˜…æŸä¸ªä¸»é¢˜
    fn subscribe(self, name: String) -&gt; mpsc::Receiver&lt;Arc&lt;CommandResponse&gt;&gt;;
    /// å–æ¶ˆå¯¹ä¸»é¢˜çš„è®¢é˜…
    fn unsubscribe(self, name: String, id: u32);
    /// å¾€ä¸»é¢˜é‡Œå‘å¸ƒä¸€ä¸ªæ•°æ®
    fn publish(self, name: String, value: Arc&lt;CommandResponse&gt;);
}

/// ç”¨äºä¸»é¢˜å‘å¸ƒå’Œè®¢é˜…çš„æ•°æ®ç»“æ„
#[derive(Default)]
pub struct Broadcaster {
    /// æ‰€æœ‰çš„ä¸»é¢˜åˆ—è¡¨
    topics: DashMap&lt;String, DashSet&lt;u32&gt;&gt;,
    /// æ‰€æœ‰çš„è®¢é˜…åˆ—è¡¨
    subscriptions: DashMap&lt;u32, mpsc::Sender&lt;Arc&lt;CommandResponse&gt;&gt;&gt;,
}
</code></pre></pre>
<blockquote>
<p>è¿™é‡Œï¼Œsubscription_id æˆ‘ä»¬ç”¨ä¸€ä¸ª AtomicU32 æ¥è¡¨è¿°ã€‚</p>
</blockquote>
<ul>
<li>å¯¹äºè¿™æ ·ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDï¼Œå¾ˆå¤šåŒå­¦å–œæ¬¢ç”¨ UUID4 æ¥è¡¨è¿°ã€‚</li>
<li>æ³¨æ„ä½¿ç”¨ UUID çš„è¯ï¼Œå­˜å‚¨æ—¶ä¸€å®šä¸è¦å­˜å®ƒçš„å­—ç¬¦ä¸²è¡¨ç°å½¢å¼ï¼Œå¤ªæµªè´¹å†…å­˜ä¸”æ¯æ¬¡éƒ½æœ‰é¢å¤–çš„å †åˆ†é…ï¼Œåº”è¯¥ç”¨å®ƒ u128 çš„è¡¨ç°å½¢å¼ã€‚</li>
<li>ä¸è¿‡å³ä¾¿ u128ï¼Œä¹Ÿæ¯” u32 æµªè´¹å¾ˆå¤šç©ºé—´</li>
</ul>
<p>å‡è®¾æŸä¸ªä¸»é¢˜ M ä¸‹æœ‰ä¸€ä¸‡ä¸ªè®¢é˜…ï¼Œè¦å¾€è¿™ä¸ª M é‡Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œå°±æ„å‘³ç€æ•´ä¸ª DashSet<u32> çš„ä¸€æ¬¡æ‹·è´ï¼Œä¹˜ä¸Šä¸€ä¸‡ï¼Œu32 çš„è¯åš 40k å†…å­˜çš„æ‹·è´ï¼Œè€Œ u128 è¦åš 160k å†…å­˜çš„æ‹·è´ã€‚è¿™ä¸ªæ€§èƒ½ä¸Šçš„å·®è·å°±å¾ˆæ˜æ˜¾äº†ã€‚</p>
<ul>
<li>å¦å¤–ï¼Œæˆ‘ä»¬æŠŠ CommandResponse å°è£…è¿›äº†ä¸€ä¸ª Arcã€‚</li>
</ul>
<p>å¦‚æœä¸€æ¡æ¶ˆæ¯è¦å‘é€ç»™ä¸€ä¸‡ä¸ªå®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¸Œæœ›è¿™æ¡æ¶ˆæ¯è¢«å¤åˆ¶åï¼Œå†è¢«å‘é€ï¼Œè€Œæ˜¯ç›´æ¥å‘é€åŒä¸€ä»½æ•°æ®ã€‚</p>
</div>
</details>
<blockquote>
<p>è¿™é‡Œå¯¹ Pub/Sub çš„æ¥å£ï¼Œæ„å»ºäº†ä¸€ä¸ª Topic traitã€‚è™½ç„¶ç›®å‰æˆ‘ä»¬åªæœ‰ Broadcaster ä¼šå®ç° Topic traitï¼Œä½†æœªæ¥ä¹Ÿè®¸ä¼šæ¢ä¸åŒçš„å®ç°æ–¹å¼ï¼Œæ‰€ä»¥ï¼ŒæŠ½è±¡å‡º Topic trait å¾ˆæœ‰æ„ä¹‰ã€‚</p>
</blockquote>
<h3 id="pubsub-çš„å®ç°"><a class="header" href="#pubsub-çš„å®ç°">Pub/Sub çš„å®ç°</a></h3>
<details id="admonition-åˆ›å»º-srcservicetopicrsè®°å¾—åœ¨-modrs-é‡Œå¼•ç”¨å¹¶æ·»å…¥" class="admonition note">
<summary class="admonition-title">
<p>åˆ›å»º src/service/topic.rsï¼ˆè®°å¾—åœ¨ mod.rs é‡Œå¼•ç”¨ï¼‰ï¼Œå¹¶æ·»å…¥ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-åˆ›å»º-srcservicetopicrsè®°å¾—åœ¨-modrs-é‡Œå¼•ç”¨å¹¶æ·»å…¥"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use dashmap::{DashMap, DashSet};
use std::sync::{
    atomic::{AtomicU32, Ordering},
    Arc,
};
use tokio::sync::mpsc;
use tracing::{debug, info, warn};

use crate::{CommandResponse, Value};

/// topic é‡Œæœ€å¤§å­˜æ”¾çš„æ•°æ®
const BROADCAST_CAPACITY: usize = 128;

/// ä¸‹ä¸€ä¸ª subscription id
static NEXT_ID: AtomicU32 = AtomicU32::new(1);

/// è·å–ä¸‹ä¸€ä¸ª subscription id
fn get_next_subscription_id() -&gt; u32 {
    NEXT_ID.fetch_add(1, Ordering::Relaxed)
}

pub trait Topic: Send + Sync + 'static {
    /// è®¢é˜…æŸä¸ªä¸»é¢˜
    fn subscribe(self, name: String) -&gt; mpsc::Receiver&lt;Arc&lt;CommandResponse&gt;&gt;;
    /// å–æ¶ˆå¯¹ä¸»é¢˜çš„è®¢é˜…
    fn unsubscribe(self, name: String, id: u32);
    /// å¾€ä¸»é¢˜é‡Œå‘å¸ƒä¸€ä¸ªæ•°æ®
    fn publish(self, name: String, value: Arc&lt;CommandResponse&gt;);
}

/// ç”¨äºä¸»é¢˜å‘å¸ƒå’Œè®¢é˜…çš„æ•°æ®ç»“æ„
#[derive(Default)]
pub struct Broadcaster {
    /// æ‰€æœ‰çš„ä¸»é¢˜åˆ—è¡¨
    topics: DashMap&lt;String, DashSet&lt;u32&gt;&gt;,
    /// æ‰€æœ‰çš„è®¢é˜…åˆ—è¡¨
    subscriptions: DashMap&lt;u32, mpsc::Sender&lt;Arc&lt;CommandResponse&gt;&gt;&gt;,
}

impl Topic for Arc&lt;Broadcaster&gt; {
    fn subscribe(self, name: String) -&gt; mpsc::Receiver&lt;Arc&lt;CommandResponse&gt;&gt; {
        let id = {
            let entry = self.topics.entry(name).or_default();
            let id = get_next_subscription_id();
            entry.value().insert(id);
            id
        };

        // ç”Ÿæˆä¸€ä¸ª mpsc channel
        let (tx, rx) = mpsc::channel(BROADCAST_CAPACITY);

        let v: Value = (id as i64).into();

        // ç«‹åˆ»å‘é€ subscription id åˆ° rx
        let tx1 = tx.clone();
        tokio::spawn(async move {
            if let Err(e) = tx1.send(Arc::new(v.into())).await {
                // TODO: è¿™ä¸ªå¾ˆå°æ¦‚ç‡å‘ç”Ÿï¼Œä½†ç›®å‰æˆ‘ä»¬æ²¡æœ‰å–„å
                warn!(&quot;Failed to send subscription id: {}. Error: {:?}&quot;, id, e);
            }
        });

        // æŠŠ tx å­˜å…¥ subscription table
        self.subscriptions.insert(id, tx);
        debug!(&quot;Subscription {} is added&quot;, id);

        // è¿”å› rx ç»™ç½‘ç»œå¤„ç†çš„ä¸Šä¸‹æ–‡
        rx
    }

    fn unsubscribe(self, name: String, id: u32) {
        if let Some(v) = self.topics.get_mut(&amp;name) {
            // åœ¨ topics è¡¨é‡Œæ‰¾åˆ° topic çš„ subscription idï¼Œåˆ é™¤
            v.remove(&amp;id);

            // å¦‚æœè¿™ä¸ª topic ä¸ºç©ºï¼Œåˆ™ä¹Ÿåˆ é™¤ topic
            if v.is_empty() {
                info!(&quot;Topic: {:?} is deleted&quot;, &amp;name);
                drop(v);
                self.topics.remove(&amp;name);
            }
        }

        debug!(&quot;Subscription {} is removed!&quot;, id);
        // åœ¨ subscription è¡¨ä¸­åŒæ ·åˆ é™¤
        self.subscriptions.remove(&amp;id);
    }

    fn publish(self, name: String, value: Arc&lt;CommandResponse&gt;) {
        tokio::spawn(async move {
            match self.topics.get(&amp;name) {
                Some(chan) =&gt; {
                    // å¤åˆ¶æ•´ä¸ª topic ä¸‹æ‰€æœ‰çš„ subscription id
                    // è¿™é‡Œæˆ‘ä»¬æ¯ä¸ª id æ˜¯ u32ï¼Œå¦‚æœä¸€ä¸ª topic ä¸‹æœ‰ 10k è®¢é˜…ï¼Œå¤åˆ¶çš„æˆæœ¬
                    // ä¹Ÿå°±æ˜¯ 40k å †å†…å­˜ï¼ˆå¤–åŠ ä¸€äº›æ§åˆ¶ç»“æ„ï¼‰ï¼Œæ‰€ä»¥æ•ˆç‡ä¸ç®—å·®
                    // è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨ NEXT_ID æ¥æ§åˆ¶ subscription id çš„ç”Ÿæˆ
                    let chan = chan.value().clone();

                    // å¾ªç¯å‘é€
                    for id in chan.into_iter() {
                        if let Some(tx) = self.subscriptions.get(&amp;id) {
                            if let Err(e) = tx.send(value.clone()).await {
                                warn!(&quot;Publish to {} failed! error: {:?}&quot;, id, e);
                            }
                        }
                    }
                }
                None =&gt; {}
            }
        });
    }
}
</code></pre></pre>
</div>
</details>
<p>è¿™æ®µä»£ç å°±æ˜¯ Pub/Sub çš„æ ¸å¿ƒåŠŸèƒ½äº†ã€‚ä½ å¯ä»¥å¯¹ç…§ç€ä¸Šé¢çš„è®¾è®¡å›¾å’Œä»£ç ä¸­çš„è¯¦ç»†æ³¨é‡Šå»ç†è§£ã€‚</p>
<details id="admonition-æˆ‘ä»¬æ¥å†™ä¸€ä¸ªæµ‹è¯•ç¡®ä¿å®ƒæ­£å¸¸å·¥ä½œ" class="admonition success">
<summary class="admonition-title">
<p>æˆ‘ä»¬æ¥å†™ä¸€ä¸ªæµ‹è¯•ç¡®ä¿å®ƒæ­£å¸¸å·¥ä½œï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-æˆ‘ä»¬æ¥å†™ä¸€ä¸ªæµ‹è¯•ç¡®ä¿å®ƒæ­£å¸¸å·¥ä½œ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {
    use std::convert::TryInto;

    use crate::assert_res_ok;

    use super::*;

    #[tokio::test]
    async fn pub_sub_should_work() {
        let b = Arc::new(Broadcaster::default());
        let lobby = &quot;lobby&quot;.to_string();

        // subscribe
        let mut stream1 = b.clone().subscribe(lobby.clone());
        let mut stream2 = b.clone().subscribe(lobby.clone());

        // publish
        let v: Value = &quot;hello&quot;.into();
        b.clone().publish(lobby.clone(), Arc::new(v.clone().into()));

        // subscribers åº”è¯¥èƒ½æ”¶åˆ° publish çš„æ•°æ®
        let id1: i64 = stream1.recv().await.unwrap().as_ref().try_into().unwrap();
        let id2: i64 = stream2.recv().await.unwrap().as_ref().try_into().unwrap();

        assert!(id1 != id2);

        let res1 = stream1.recv().await.unwrap();
        let res2 = stream2.recv().await.unwrap();

        assert_eq!(res1, res2);
        assert_res_ok(&amp;res1, &amp;[v.clone()], &amp;[]);

        // å¦‚æœ subscriber å–æ¶ˆè®¢é˜…ï¼Œåˆ™æ”¶ä¸åˆ°æ–°æ•°æ®
        b.clone().unsubscribe(lobby.clone(), id1 as _);

        // publish
        let v: Value = &quot;world&quot;.into();
        b.clone().publish(lobby.clone(), Arc::new(v.clone().into()));

        assert!(stream1.recv().await.is_none());
        let res2 = stream2.recv().await.unwrap();
        assert_res_ok(&amp;res2, &amp;[v.clone()], &amp;[]);
    }
}
</code></pre></pre>
</div>
</details>
<p>è¿™ä¸ªæµ‹è¯•éœ€è¦ä¸€ç³»åˆ—æ–°çš„æ”¹åŠ¨ï¼Œæ¯”å¦‚ assert_res_ok() çš„æ¥å£å˜åŒ–äº†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ src/pb/mod.rs é‡Œæ·»åŠ æ–°çš„ TryFrom æ”¯æŒç­‰ç­‰ï¼Œè¯¦ç»†ä»£ç ä½ å¯ä»¥çœ‹ repo é‡Œçš„ diff_topicã€‚</p>
<h3 id="åœ¨å¤„ç†æµç¨‹ä¸­å¼•å…¥-pubsub"><a class="header" href="#åœ¨å¤„ç†æµç¨‹ä¸­å¼•å…¥-pubsub">åœ¨å¤„ç†æµç¨‹ä¸­å¼•å…¥ Pub/Sub</a></h3>
<p>å¥½ï¼Œå†æ¥çœ‹å®ƒå’Œç”¨æˆ·ä¼ å…¥çš„ CommandRequest å¦‚ä½•å‘ç”Ÿå…³ç³»ã€‚</p>
<details id="admonition-æˆ‘ä»¬ä¹‹å‰è®¾è®¡äº†-commandservice-traitå®ƒè™½ç„¶å¯ä»¥å¤„ç†å…¶å®ƒå‘½ä»¤ä½†å¯¹-pubsub-ç›¸å…³çš„å‡ ä¸ªæ–°å‘½ä»¤æ— æ³•å¤„ç†å› ä¸ºæ¥å£æ²¡æœ‰ä»»ä½•å’Œ-topic-æœ‰å…³çš„å‚æ•°" class="admonition note">
<summary class="admonition-title">
<p>æˆ‘ä»¬ä¹‹å‰è®¾è®¡äº† CommandService traitï¼Œå®ƒè™½ç„¶å¯ä»¥å¤„ç†å…¶å®ƒå‘½ä»¤ï¼Œä½†å¯¹ Pub/Sub ç›¸å…³çš„å‡ ä¸ªæ–°å‘½ä»¤æ— æ³•å¤„ç†ï¼Œå› ä¸ºæ¥å£æ²¡æœ‰ä»»ä½•å’Œ Topic æœ‰å…³çš„å‚æ•°ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-æˆ‘ä»¬ä¹‹å‰è®¾è®¡äº†-commandservice-traitå®ƒè™½ç„¶å¯ä»¥å¤„ç†å…¶å®ƒå‘½ä»¤ä½†å¯¹-pubsub-ç›¸å…³çš„å‡ ä¸ªæ–°å‘½ä»¤æ— æ³•å¤„ç†å› ä¸ºæ¥å£æ²¡æœ‰ä»»ä½•å’Œ-topic-æœ‰å…³çš„å‚æ•°"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
/// å¯¹ Command çš„å¤„ç†çš„æŠ½è±¡
pub trait CommandService {
    /// å¤„ç† Commandï¼Œè¿”å› Response
    fn execute(self, store: &amp;impl Storage) -&gt; CommandResponse;
}
</code></pre></pre>
<p>ä½†æ˜¯å¦‚æœç›´æ¥ä¿®æ”¹è¿™ä¸ªæ¥å£ï¼Œå¯¹å·²æœ‰çš„ä»£ç å°±éå¸¸ä¸å‹å¥½ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å¯¹æ¯”ç€åˆ›å»ºä¸€ä¸ªæ–°çš„ traitï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">pub type StreamingResponse = Pin&lt;Box&lt;dyn Stream&lt;Item = Arc&lt;CommandResponse&gt;&gt; + Send&gt;&gt;;
pub trait TopicService {
    /// å¤„ç† Commandï¼Œè¿”å› Response
    fn execute&lt;T&gt;(self, chan: impl Topic) -&gt; StreamingResponse;
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>å› ä¸º Stream æ˜¯ä¸€ä¸ª traitï¼Œåœ¨ trait çš„æ–¹æ³•é‡Œæˆ‘ä»¬æ— æ³•è¿”å›ä¸€ä¸ª impl Streamï¼Œæ‰€ä»¥ç”¨ trait objectï¼šPin&lt;Box&lt;dyn Stream&gt;&gt;ã€‚</p>
</blockquote>
<details id="admonition-å®ç°å®ƒå¾ˆç®€å•æˆ‘ä»¬åˆ›å»º-srcservicetopic_servicersè®°å¾—åœ¨-modrs-å¼•ç”¨ç„¶åæ·»åŠ " class="admonition note">
<summary class="admonition-title">
<p>å®ç°å®ƒå¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆ›å»º src/service/topic_service.rsï¼ˆè®°å¾—åœ¨ mod.rs å¼•ç”¨ï¼‰ï¼Œç„¶åæ·»åŠ ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-å®ç°å®ƒå¾ˆç®€å•æˆ‘ä»¬åˆ›å»º-srcservicetopic_servicersè®°å¾—åœ¨-modrs-å¼•ç”¨ç„¶åæ·»åŠ "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use futures::{stream, Stream};
use std::{pin::Pin, sync::Arc};
use tokio_stream::wrappers::ReceiverStream;

use crate::{CommandResponse, Publish, Subscribe, Topic, Unsubscribe};

pub type StreamingResponse = Pin&lt;Box&lt;dyn Stream&lt;Item = Arc&lt;CommandResponse&gt;&gt; + Send&gt;&gt;;

pub trait TopicService {
    /// å¤„ç† Commandï¼Œè¿”å› Response
    fn execute&lt;T, S&gt;(self, topic: impl Topic) -&gt; StreamingResponse;
}

impl TopicService for Subscribe {
    fn execute&lt;T, S&gt;(self, topic: impl Topic) -&gt; StreamingResponse {
        let rx = topic.subscribe(self.topic);
        Box::pin(ReceiverStream::new(rx))
    }
}

impl TopicService for Unsubscribe {
    fn execute&lt;T, S&gt;(self, topic: impl Topic) -&gt; StreamingResponse {
        topic.unsubscribe(self.topic, self.id);
        Box::pin(stream::once(async { Arc::new(CommandResponse::ok()) }))
    }
}

impl TopicService for Publish {
    fn execute&lt;T, S&gt;(self, topic: impl Topic) -&gt; StreamingResponse {
        topic.publish(self.topic, Arc::new(self.data.into()));
        Box::pin(stream::once(async { Arc::new(CommandResponse::ok()) }))
    }
}
</code></pre></pre>
</div>
</details>
<ul>
<li>æˆ‘ä»¬ä½¿ç”¨äº† <a href="https://docs.rs/tokio-stream/0.1.7/tokio_stream/">tokio-stream</a> çš„ wrapper æŠŠä¸€ä¸ª mpsc::Receiver è½¬æ¢æˆ
ReceiverStream, è¿™æ · Subscribe çš„å¤„ç†å°±èƒ½è¿”å›ä¸€ä¸ª Streamã€‚</li>
<li>å¯¹äº Unsubscribe å’Œ Publishï¼Œå®ƒä»¬éƒ½è¿”å›å•ä¸ªå€¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ stream::once å°†å…¶ç»Ÿä¸€èµ·æ¥ã€‚</li>
</ul>
<details id="admonition-åŒæ ·åœ°è¦åœ¨-srcpbmodrs-é‡Œæ·»åŠ ä¸€äº›æ–°çš„æ–¹æ³•æ¯”å¦‚-commandresponseokå®ƒè¿”å›ä¸€ä¸ªçŠ¶æ€ç æ˜¯-ok-çš„-response" class="admonition note">
<summary class="admonition-title">
<p>åŒæ ·åœ°ï¼Œè¦åœ¨ src/pb/mod.rs é‡Œæ·»åŠ ä¸€äº›æ–°çš„æ–¹æ³•ï¼Œæ¯”å¦‚ CommandResponse::ok()ï¼Œå®ƒè¿”å›ä¸€ä¸ªçŠ¶æ€ç æ˜¯ OK çš„ responseï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-åŒæ ·åœ°è¦åœ¨-srcpbmodrs-é‡Œæ·»åŠ ä¸€äº›æ–°çš„æ–¹æ³•æ¯”å¦‚-commandresponseokå®ƒè¿”å›ä¸€ä¸ªçŠ¶æ€ç æ˜¯-ok-çš„-response"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
impl CommandResponse {
    pub fn ok() -&gt; Self {
        let mut result = CommandResponse::default();
        result.status = StatusCode::OK.as_u16() as _;
        result
    }
}
</code></pre></pre>
</div>
</details>
<p>å¥½ï¼Œæ¥ä¸‹æ¥çœ‹ src/service/mod.rsï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åº”ç€åŸæ¥çš„ dispatch åšä¸€ä¸ª dispatch_streamã€‚</p>
<details id="admonition-åŒæ ·åœ°å·²æœ‰çš„æ¥å£åº”è¯¥å°‘åŠ¨æˆ‘ä»¬å¹³è¡Œæ·»åŠ ä¸€ä¸ªæ–°çš„" class="admonition note">
<summary class="admonition-title">
<p>åŒæ ·åœ°ï¼Œå·²æœ‰çš„æ¥å£åº”è¯¥å°‘åŠ¨ï¼Œæˆ‘ä»¬å¹³è¡Œæ·»åŠ ä¸€ä¸ªæ–°çš„ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-åŒæ ·åœ°å·²æœ‰çš„æ¥å£åº”è¯¥å°‘åŠ¨æˆ‘ä»¬å¹³è¡Œæ·»åŠ ä¸€ä¸ªæ–°çš„"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
/// ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç†æ‰€æœ‰ HGET/HSET/HDEL/HEXIST
pub fn dispatch(cmd: CommandRequest, store: &amp;impl Storage) -&gt; CommandResponse {
    match cmd.request_data {
        Some(RequestData::Hget(param)) =&gt; param.execute(store),
        Some(RequestData::Hgetall(param)) =&gt; param.execute(store),
        Some(RequestData::Hmget(param)) =&gt; param.execute(store),
        Some(RequestData::Hset(param)) =&gt; param.execute(store),
        Some(RequestData::Hmset(param)) =&gt; param.execute(store),
        Some(RequestData::Hdel(param)) =&gt; param.execute(store),
        Some(RequestData::Hmdel(param)) =&gt; param.execute(store),
        Some(RequestData::Hexist(param)) =&gt; param.execute(store),
        Some(RequestData::Hmexist(param)) =&gt; param.execute(store),
        None =&gt; KvError::InvalidCommand(&quot;Request has no data&quot;.into()).into(),
        // å¤„ç†ä¸äº†çš„è¿”å›ä¸€ä¸ªå•¥éƒ½ä¸åŒ…æ‹¬çš„ Responseï¼Œè¿™æ ·åç»­å¯ä»¥ç”¨ dispatch_stream å¤„ç†
        _ =&gt; CommandResponse::default(),
    }
}

/// ä» Request ä¸­å¾—åˆ° Responseï¼Œç›®å‰å¤„ç†æ‰€æœ‰ PUBLISH/SUBSCRIBE/UNSUBSCRIBE
pub fn dispatch_stream(cmd: CommandRequest, topic: impl Topic) -&gt; StreamingResponse {
    match cmd.request_data {
        Some(RequestData::Publish(param)) =&gt; param.execute(topic),
        Some(RequestData::Subscribe(param)) =&gt; param.execute(topic),
        Some(RequestData::Unsubscribe(param)) =&gt; param.execute(topic),
        // å¦‚æœèµ°åˆ°è¿™é‡Œï¼Œå°±æ˜¯ä»£ç é€»è¾‘çš„é—®é¢˜ï¼Œç›´æ¥ crash å‡ºæ¥
        _ =&gt; unreachable!(),
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ–°çš„æ¥å£service-ç»“æ„ä¹Ÿéœ€è¦ç›¸åº”æ”¹åŠ¨" class="admonition note">
<summary class="admonition-title">
<p>ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ–°çš„æ¥å£ï¼ŒService ç»“æ„ä¹Ÿéœ€è¦ç›¸åº”æ”¹åŠ¨ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ–°çš„æ¥å£service-ç»“æ„ä¹Ÿéœ€è¦ç›¸åº”æ”¹åŠ¨"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
/// Service æ•°æ®ç»“æ„
pub struct Service&lt;Store = MemTable&gt; {
    inner: Arc&lt;ServiceInner&lt;Store&gt;&gt;,
    broadcaster: Arc&lt;Broadcaster&gt;,
}

impl&lt;Store&gt; Clone for Service&lt;Store&gt; {
    fn clone(&amp;self) -&gt; Self {
        Self {
            inner: Arc::clone(&amp;self.inner),
            broadcaster: Arc::clone(&amp;self.broadcaster),
        }
    }
}

impl&lt;Store: Storage&gt; From&lt;ServiceInner&lt;Store&gt;&gt; for Service&lt;Store&gt; {
    fn from(inner: ServiceInner&lt;Store&gt;) -&gt; Self {
        Self {
            inner: Arc::new(inner),
            broadcaster: Default::default(),
        }
    }
}

impl&lt;Store: Storage&gt; Service&lt;Store&gt; {
    pub fn execute(&amp;self, cmd: CommandRequest) -&gt; StreamingResponse {
        debug!(&quot;Got request: {:?}&quot;, cmd);
        self.inner.on_received.notify(&amp;cmd);
        let mut res = dispatch(cmd, &amp;self.inner.store);

        if res == CommandResponse::default() {
            dispatch_stream(cmd, Arc::clone(&amp;self.broadcaster))
        } else {
            debug!(&quot;Executed response: {:?}&quot;, res);
            self.inner.on_executed.notify(&amp;res);
            self.inner.on_before_send.notify(&amp;mut res);
            if !self.inner.on_before_send.is_empty() {
                debug!(&quot;Modified response: {:?}&quot;, res);
            }

            Box::pin(stream::once(async { Arc::new(res) }))
        }
    }
}
</code></pre></pre>
</div>
</details>
<p>è¿™é‡Œï¼Œä¸ºäº†å¤„ç† Pub/Subï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªç ´åæ€§çš„æ›´æ–°:</p>
<ul>
<li>execute() æ–¹æ³•çš„è¿”å›å€¼å˜æˆäº† StreamingResponse</li>
<li>è¿™å°±æ„å‘³ç€æ‰€æœ‰å›´ç»•ç€è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼ŒåŒ…æ‹¬æµ‹è¯•ï¼Œéƒ½éœ€è¦ç›¸åº”æ›´æ–°ã€‚</li>
<li>è¿™æ˜¯è¿«ä¸å¾—å·²çš„ï¼Œä¸è¿‡é€šè¿‡æ„å»ºå’Œ CommandService / dispatch å¹³è¡Œçš„ TopicService / dispatch_streamï¼Œæˆ‘ä»¬å·²ç»è®©è¿™ä¸ªç ´åæ€§æ›´æ–°å°½å¯èƒ½åœ°åœ¨æ¯”è¾ƒé«˜å±‚ï¼Œå¦åˆ™ï¼Œæ”¹åŠ¨ä¼šæ›´å¤§ã€‚</li>
</ul>
<p>ç›®å‰ï¼Œä»£ç æ— æ³•ç¼–è¯‘é€šè¿‡ï¼Œè¿™æ˜¯å› ä¸ºå¦‚ä¸‹çš„ä»£ç ï¼Œres ç°åœ¨æ˜¯ä¸ª streamï¼Œ</p>
<details id="admonition-æˆ‘ä»¬éœ€è¦å¤„ç†ä¸€ä¸‹" class="admonition note">
<summary class="admonition-title">
<p>æˆ‘ä»¬éœ€è¦å¤„ç†ä¸€ä¸‹ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-æˆ‘ä»¬éœ€è¦å¤„ç†ä¸€ä¸‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;S&gt; ProstServerStream&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send + 'static,
{
    ...

    pub async fn process(mut self) -&gt; Result&lt;(), KvError&gt; {
        let stream = &amp;mut self.inner;
        while let Some(Ok(cmd)) = stream.next().await {
            info!(&quot;Got a new command: {:?}&quot;, cmd);
            let mut res = self.service.execute(cmd);
            while let Some(data) = res.next().await {
                // ç›®å‰ data æ˜¯ Arc&lt;CommandResponse&gt;ï¼Œ
                // æ‰€ä»¥æˆ‘ä»¬ send æœ€å¥½ç”¨ &amp;CommandResponse
                stream.send(&amp;data).await.unwrap();
            }
        }
        // info!(&quot;Client {:?} disconnected&quot;, self.addr);
        Ok(())
    }
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>å½“ç„¶ï¼Œè¿™æ ·çš„æ”¹åŠ¨ä¹Ÿæ„å‘³ç€ï¼ŒåŸæœ¬çš„å‡½æ•°éœ€è¦å˜æˆ asyncã€‚</p>
</blockquote>
<p>å¦‚æœæ˜¯ä¸ª testï¼Œéœ€è¦ä½¿ç”¨ #[tokio::test]ã€‚ä½ å¯ä»¥è‡ªå·±è¯•ç€æŠŠæ‰€æœ‰ç›¸å…³çš„ä»£ç éƒ½æ”¹ä¸€ä¸‹ã€‚</p>
<div id="admonition-error-rendering-admonishment" class="admonition bug">
<div class="admonition-title">
<p>Error rendering admonishment</p>
<p><a class="admonition-anchor-link" href="#admonition-error-rendering-admonishment"></a></p>
</div>
<div>
<p>Failed with: TOML parsing error: expected an equals, found a newline at line 1 column 6</p>
<p>Original markdown input:</p>
<pre><code>~~~admonish note title=&quot;å½“ä½ æ”¹åˆ° src/network/mod.rs é‡Œ ProstServerStream çš„ process æ–¹æ³•é‡Œé¢çš„stream.send(data) æ—¶ï¼Œæˆ‘ä»¬ç›®å‰çš„ data æ˜¯ Arc&lt;CommandResponse&gt;ï¼š
 &quot; collapsible=true
```rust, editable

impl&lt;S&gt; ProstServerStream&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send + 'static,
{
    ...

    pub async fn process(mut self) -&gt; Result&lt;(), KvError&gt; {
        let stream = &amp;mut self.inner;
        while let Some(Ok(cmd)) = stream.next().await {
            info!(&quot;Got a new command: {:?}&quot;, cmd);
            let mut res = self.service.execute(cmd);
            while let Some(data) = res.next().await {
                // ç›®å‰ data æ˜¯ Arc&lt;CommandResponse&gt;ï¼Œ
                // æ‰€ä»¥æˆ‘ä»¬ send æœ€å¥½ç”¨ &amp;CommandResponse
                stream.send(&amp;data).await.unwrap();
            }
        }
        // info!(&quot;Client {:?} disconnected&quot;, self.addr);
        Ok(())
    }
}
```
~~~
</code></pre>
</div>
</div>
<p>æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹ src/network/stream.rsï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
// impl&lt;S, In, Out&gt; Sink&lt;Out&gt; for ProstStream&lt;S, In, Out&gt;
impl&lt;S, In, Out&gt; Sink&lt;&amp;Out&gt; for ProstStream&lt;S, In, Out&gt;
</code></pre></pre>
<p>è¿™ä¼šå¼•å‘ä¸€ç³»åˆ—çš„å˜åŠ¨ï¼Œä½ å¯ä»¥è¯•ç€è‡ªå·±æ”¹ä¸€ä¸‹ã€‚</p>
<p>å¦‚æœä½ æŠŠæ‰€æœ‰ç¼–è¯‘é”™è¯¯éƒ½æ”¹æ­£ï¼Œcargo test ä¼šå…¨éƒ¨é€šè¿‡ã€‚ä½ ä¹Ÿå¯ä»¥çœ‹ repo é‡Œçš„ diff_serviceï¼Œçœ‹çœ‹æ‰€æœ‰æ”¹åŠ¨çš„ä»£ç ã€‚</p>
<h3 id="ç»§ç»­é‡æ„å¼¥è¡¥è®¾è®¡ä¸Šçš„å°é—®é¢˜"><a class="header" href="#ç»§ç»­é‡æ„å¼¥è¡¥è®¾è®¡ä¸Šçš„å°é—®é¢˜">ç»§ç»­é‡æ„ï¼šå¼¥è¡¥è®¾è®¡ä¸Šçš„å°é—®é¢˜</a></h3>
<p>ç°åœ¨çœ‹ä¸Šå»å¤§åŠŸå‘Šæˆï¼Œä½†ä½ æœ‰æ²¡æœ‰æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨æ’°å†™ src/service/topic_service.rs æ—¶ï¼Œæ²¡æœ‰å†™æµ‹è¯•ã€‚ä½ ä¹Ÿè®¸ä¼šè¯´ï¼šè¿™æ®µä»£ç å¦‚æ­¤ç®€å•ï¼Œè¿˜æœ‰å¿…è¦æµ‹è¯•ä¹ˆï¼Ÿ</p>
<blockquote>
<p>è¿˜æ˜¯é‚£å¥è¯ï¼Œæµ‹è¯•æ˜¯ä½“éªŒå’Œæ„Ÿå—æ¥å£å®Œå¤‡æ€§çš„ä¸€ç§æ‰‹æ®µã€‚æµ‹è¯•å¹¶ä¸æ˜¯ä¸ºäº†æµ‹è¯•å®ç°æœ¬èº«ï¼Œè€Œæ˜¯çœ‹æ¥å£æ˜¯å¦å¥½ç”¨ï¼Œæ˜¯å¦é—æ¼äº†æŸäº›äº§å“éœ€æ±‚ã€‚</p>
</blockquote>
<details id="admonition-æµ‹è¯•" class="admonition success">
<summary class="admonition-title">
<p>æµ‹è¯•</p>
<p><a class="admonition-anchor-link" href="#admonition-æµ‹è¯•"></a></p>
</summary>
<div>
<p>å½“å¼€å§‹å†™æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šæ€è€ƒï¼š</p>
<ul>
<li>unsubscribe æ¥å£å¦‚æœé‡åˆ°ä¸å­˜åœ¨çš„ subscriptionï¼Œè¦ä¸è¦è¿”å›ä¸€ä¸ª 404ï¼Ÿ</li>
<li>publish çš„æ—¶å€™é‡åˆ°é”™è¯¯ï¼Œæ˜¯ä¸æ˜¯æ„å‘³ç€å®¢æˆ·ç«¯éæ­£å¸¸é€€å‡ºäº†ï¼Ÿ</li>
<li>æˆ‘ä»¬è¦ä¸è¦æŠŠå®ƒä» subscription ä¸­ç§»é™¤æ‰ï¼Ÿ</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {
    use super::*;
    use crate::{assert_res_error, assert_res_ok, dispatch_stream, Broadcaster, CommandRequest};
    use futures::StreamExt;
    use std::{convert::TryInto, time::Duration};
    use tokio::time;

    #[tokio::test]
    async fn dispatch_publish_should_work() {
        let topic = Arc::new(Broadcaster::default());
        let cmd = CommandRequest::new_publish(&quot;lobby&quot;, vec![&quot;hello&quot;.into()]);
        let mut res = dispatch_stream(cmd, topic);
        let data = res.next().await.unwrap();
        assert_res_ok(&amp;data, &amp;[], &amp;[]);
    }

    #[tokio::test]
    async fn dispatch_subscribe_should_work() {
        let topic = Arc::new(Broadcaster::default());
        let cmd = CommandRequest::new_subscribe(&quot;lobby&quot;);
        let mut res = dispatch_stream(cmd, topic);
        let id: i64 = res.next().await.unwrap().as_ref().try_into().unwrap();
        assert!(id &gt; 0);
    }

    #[tokio::test]
    async fn dispatch_subscribe_abnormal_quit_should_be_removed_on_next_publish() {
        let topic = Arc::new(Broadcaster::default());
        let id = {
            let cmd = CommandRequest::new_subscribe(&quot;lobby&quot;);
            let mut res = dispatch_stream(cmd, topic.clone());
            let id: i64 = res.next().await.unwrap().as_ref().try_into().unwrap();
            drop(res);
            id as u32
        };

        // publish æ—¶ï¼Œè¿™ä¸ª subscription å·²ç»å¤±æ•ˆï¼Œæ‰€ä»¥ä¼šè¢«åˆ é™¤
        let cmd = CommandRequest::new_publish(&quot;lobby&quot;, vec![&quot;hello&quot;.into()]);
        dispatch_stream(cmd, topic.clone());
        time::sleep(Duration::from_millis(10)).await;

        // å¦‚æœå†å°è¯•åˆ é™¤ï¼Œåº”è¯¥è¿”å› KvError
        let result = topic.unsubscribe(&quot;lobby&quot;.into(), id);
        assert!(result.is_err());
    }

    #[tokio::test]
    async fn dispatch_unsubscribe_should_work() {
        let topic = Arc::new(Broadcaster::default());
        let cmd = CommandRequest::new_subscribe(&quot;lobby&quot;);
        let mut res = dispatch_stream(cmd, topic.clone());
        let id: i64 = res.next().await.unwrap().as_ref().try_into().unwrap();

        let cmd = CommandRequest::new_unsubscribe(&quot;lobby&quot;, id as _);
        let mut res = dispatch_stream(cmd, topic);
        let data = res.next().await.unwrap();

        assert_res_ok(&amp;data, &amp;[], &amp;[]);
    }

    #[tokio::test]
    async fn dispatch_unsubscribe_random_id_should_error() {
        let topic = Arc::new(Broadcaster::default());

        let cmd = CommandRequest::new_unsubscribe(&quot;lobby&quot;, 9527);
        let mut res = dispatch_stream(cmd, topic);
        let data = res.next().await.unwrap();

        assert_res_error(&amp;data, 404, &quot;Not found: subscription 9527&quot;);
    }
}
</code></pre></pre>
<p>åœ¨æ’°å†™è¿™äº›æµ‹è¯•ï¼Œå¹¶è¯•å›¾ä½¿æµ‹è¯•é€šè¿‡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆè¿›ä¸€æ­¥é‡æ„äº†ä»£ç ã€‚å…·ä½“çš„ä»£ç å˜æ›´ï¼Œä½ å¯ä»¥å‚è€ƒ repo é‡Œçš„ diff_refactorã€‚</p>
</div>
</details>
<h3 id="è®©å®¢æˆ·ç«¯èƒ½æ›´å¥½åœ°ä½¿ç”¨æ–°çš„æ¥å£"><a class="header" href="#è®©å®¢æˆ·ç«¯èƒ½æ›´å¥½åœ°ä½¿ç”¨æ–°çš„æ¥å£">è®©å®¢æˆ·ç«¯èƒ½æ›´å¥½åœ°ä½¿ç”¨æ–°çš„æ¥å£</a></h3>
<details id="admonition-ç›®å‰æˆ‘ä»¬-prostclientstream-è¿˜æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„-execute-æ–¹æ³•" class="admonition note">
<summary class="admonition-title">
<p>ç›®å‰ï¼Œæˆ‘ä»¬ ProstClientStream è¿˜æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„ execute() æ–¹æ³•ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-ç›®å‰æˆ‘ä»¬-prostclientstream-è¿˜æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„-execute-æ–¹æ³•"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;S&gt; ProstClientStream&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send,
{
    ...

    pub async fn execute(&amp;mut self, cmd: CommandRequest) -&gt; Result&lt;CommandResponse, KvError&gt; {
        let stream = &amp;mut self.inner;
        stream.send(&amp;cmd).await?;

        match stream.next().await {
            Some(v) =&gt; v,
            None =&gt; Err(KvError::Internal(&quot;Didn't get any response&quot;.into())),
        }
    }
}
</code></pre></pre>
</div>
</details>
<p>å®ƒå¹¶æ²¡æœ‰å¦¥å–„å¤„ç† SUBSCRIBEã€‚</p>
<p>ä¸ºäº†æ”¯æŒ SUBSCRIBEï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæ¥å£ï¼š</p>
<ul>
<li>execute_unary</li>
<li>execute_streamingã€‚</li>
</ul>
<details id="admonition-åœ¨-srcnetworkmodrs-ä¿®æ”¹è¿™ä¸ªä»£ç " class="admonition note">
<summary class="admonition-title">
<p>åœ¨ src/network/mod.rs ä¿®æ”¹è¿™ä¸ªä»£ç ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-åœ¨-srcnetworkmodrs-ä¿®æ”¹è¿™ä¸ªä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;S&gt; ProstClientStream&lt;S&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send + 'static,
{
    ...

    pub async fn execute_unary(
        &amp;mut self,
        cmd: &amp;CommandRequest,
    ) -&gt; Result&lt;CommandResponse, KvError&gt; {
        let stream = &amp;mut self.inner;
        stream.send(cmd).await?;

        match stream.next().await {
            Some(v) =&gt; v,
            None =&gt; Err(KvError::Internal(&quot;Didn't get any response&quot;.into())),
        }
    }

    pub async fn execute_streaming(self, cmd: &amp;CommandRequest) -&gt; Result&lt;StreamResult, KvError&gt; {
        let mut stream = self.inner;

        stream.send(cmd).await?;
        stream.close().await?;

        StreamResult::new(stream).await
    }
}
</code></pre></pre>
<p>æ³¨æ„:</p>
<ul>
<li>å› ä¸º execute_streaming é‡Œè¿”å› Box:pin(stream)</li>
<li>æˆ‘ä»¬éœ€è¦å¯¹ ProstClientStream çš„ S é™åˆ¶æ˜¯ â€™staticï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ±æ€¨</li>
<li>è¿™ä¸ªæ”¹åŠ¨ä¼šå¯¼è‡´ä½¿ç”¨ execute() æ–¹æ³•çš„æµ‹è¯•éƒ½æ— æ³•ç¼–è¯‘ï¼Œä½ å¯ä»¥è¯•ç€ä¿®æ”¹æ‰å®ƒä»¬ã€‚</li>
</ul>
</div>
</details>
<p>æ­¤å¤–æˆ‘ä»¬è¿˜åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶ src/network/stream_result.rsï¼Œç”¨æ¥å¸®åŠ©å®¢æˆ·ç«¯æ›´å¥½åœ°ä½¿ç”¨ execute_streaming() æ¥å£ã€‚æ‰€æœ‰æ”¹åŠ¨çš„å…·ä½“ä»£ç å¯ä»¥çœ‹ repo ä¸­çš„ diff_clientã€‚</p>
<details id="admonition-æµ‹è¯•-1" class="admonition note">
<summary class="admonition-title">
<p>æµ‹è¯• </p>
<p><a class="admonition-anchor-link" href="#admonition-æµ‹è¯•-1"></a></p>
</summary>
<div>
<p>ç°åœ¨ï¼Œä»£ç ä¸€åˆ‡å°±ç»ª:</p>
<ol>
<li>æ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</li>
</ol>
<pre><code class="language-shell">RUST_LOG=info cargo run --bin kvs --quiet
</code></pre>
<ol start="2">
<li>ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</li>
</ol>
<pre><code class="language-shell">RUST_LOG=info cargo run --bin kvc --quiet
</code></pre>
</div>
</details>
<blockquote>
<p>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå³ä¾¿æ··åˆ HSET/HGET å’Œ PUBLISH/SUBSCRIBE å‘½ä»¤ï¼Œä¸€åˆ‡éƒ½ä¾æ—§å¤„ç†æ­£å¸¸ï¼ä»Šå¤©æˆ‘ä»¬åšäº†ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é‡æ„ï¼Œä½†æ¯”é¢„æƒ³ä¸­å¯¹åŸæœ‰ä»£ç çš„æ”¹åŠ¨è¦å°ï¼Œè¿™ç®€ç›´å¤ªæ£’äº†ï¼</p>
</blockquote>
<h2 id="ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€èŠ‚ä¸­çš„ä»£ç å¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡"><a class="header" href="#ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€èŠ‚ä¸­çš„ä»£ç å¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡">ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€èŠ‚ä¸­çš„ä»£ç ï¼Œå¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡ã€‚</a></h2>
<details id="admonition-ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€èŠ‚ä¸­çš„ä»£ç å¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡" class="admonition abstract">
<summary class="admonition-title">
<p>ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€èŠ‚ä¸­çš„ä»£ç ï¼Œå¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡ã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€èŠ‚ä¸­çš„ä»£ç å¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡"></a></p>
</summary>
<div>
<p>å½“ä¸€ä¸ªé¡¹ç›®è¶Šæ¥è¶Šå¤æ‚ï¼Œä¸”æ–°åŠ çš„åŠŸèƒ½å¹¶ä¸èƒ½å¾ˆå¥½åœ°èå…¥å·²æœ‰çš„ç³»ç»Ÿæ—¶ï¼Œå¤§çš„é‡æ„æ˜¯ä¸å¯é¿å…çš„ã€‚åœ¨é‡æ„çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€å®šè¦é¦–å…ˆè¦å¼„æ¸…æ¥šç°æœ‰çš„æµç¨‹å’Œæ¶æ„ï¼Œç„¶åå†æ€è€ƒå¦‚ä½•é‡æ„ï¼Œè¿™æ ·å¯¹ç³»ç»Ÿçš„ä¾µå…¥æ‰æ˜¯æœ€å°çš„ã€‚</p>
<p>é‡æ„ä¸€èˆ¬ä¼šå¸¦æ¥å¯¹ç°æœ‰æµ‹è¯•çš„ç ´åï¼Œåœ¨ä¿®å¤è¢«ç ´åçš„æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬è¦æ³¨æ„ä¸è¦å˜åŠ¨åŸæœ‰æµ‹è¯•çš„é€»è¾‘ã€‚åœ¨åšå› ä¸ºæ–°åŠŸèƒ½æ·»åŠ å¯¼è‡´çš„é‡æ„æ—¶ï¼Œå¦‚æœä¼´éšç€å¤§é‡æµ‹è¯•çš„åˆ é™¤å’Œå¤§é‡æ–°æµ‹è¯•çš„æ·»åŠ ï¼Œé‚£ä¹ˆï¼Œè¯´æ˜è¦ä¹ˆåŸæ¥çš„æµ‹è¯•å†™å¾—å¾ˆæœ‰é—®é¢˜ï¼Œè¦ä¹ˆé‡æ„å¯¹åŸæœ‰ç³»ç»Ÿçš„ä¾µå…¥æ€§å¤ªå¼ºã€‚æˆ‘ä»¬è¦å°½é‡é¿å…è¿™ç§äº‹æƒ…å‘ç”Ÿã€‚</p>
<p>åœ¨æ¶æ„å’Œè®¾è®¡éƒ½ç›¸å¯¹ä¸é”™çš„æƒ…å†µä¸‹ï¼Œæ’°å†™ä»£ç çš„ç»ˆæç›®æ ‡æ˜¯å¯¹ä½¿ç”¨è€…å‹å¥½çš„æŠ½è±¡ã€‚æ‰€è°“å¯¹ä½¿ç”¨è€…å‹å¥½çš„æŠ½è±¡ï¼Œæ˜¯æŒ‡è®©åˆ«äººè°ƒç”¨æˆ‘ä»¬å†™çš„æ¥å£æ—¶ï¼Œä¸ç”¨æƒ³å¤ªå¤šï¼Œæ¥å£æœ¬èº«å°±æ˜¯è‡ªè§£é‡Šçš„ã€‚</p>
<p>å¦‚æœä½ ä»”ç»†é˜…è¯» diff_clientï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼ StreamResult è¿™æ ·çš„æŠ½è±¡ã€‚å®ƒé¿å…äº†è°ƒç”¨è€…éœ€è¦äº†è§£å¦‚ä½•æ‰‹å·¥ä» Stream ä¸­å–ç¬¬ä¸€ä¸ªå€¼ä½œä¸º subscription_id è¿™æ ·çš„å®ç°ç»†èŠ‚ï¼Œç›´æ¥æ›¿è°ƒç”¨è€…å®Œæˆäº†è¿™ä¸ªå·¥ä½œï¼Œå¹¶ä»¥ä¸€ä¸ªä¼˜é›…çš„ ID æš´éœ²ç»™è°ƒç”¨è€…ã€‚</p>
<p>ä½ å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸€èŠ‚ä¸­çš„ä»£ç ï¼Œå¥½å¥½å“å‘³è¿™äº›æ¥å£çš„è®¾è®¡ã€‚å®ƒä»¬å¹¶éå®Œç¾ï¼Œä¸–ä¸Šæ²¡æœ‰å®Œç¾çš„ä»£ç ï¼Œåªæœ‰ä¸æ–­å®Œå–„çš„ä»£ç ã€‚å¦‚æœæŠŠä¸€è¡Œè¡Œä»£ç æ¯”ä½œä¸€æ®µæ®µæ–‡å­—ï¼Œèµ·ç å®ƒä»¬éƒ½éœ€è¦åŠªåŠ›åœ°æ¨æ•²å’Œä¸æ–­åœ°è¿­ä»£ã€‚</p>
</div>
</details>
<h2 id="ä¸€äº›ç›¸å…³è€ƒè™‘"><a class="header" href="#ä¸€äº›ç›¸å…³è€ƒè™‘">ä¸€äº›ç›¸å…³è€ƒè™‘</a></h2>
<details id="admonition-æ€è€ƒç”¨gcå¤„ç†å®¢æˆ·ç«¯æ„å¤–ç»ˆæ­¢" class="admonition question">
<summary class="admonition-title">
<p>æ€è€ƒç”¨GCå¤„ç†å®¢æˆ·ç«¯æ„å¤–ç»ˆæ­¢</p>
<p><a class="admonition-anchor-link" href="#admonition-æ€è€ƒç”¨gcå¤„ç†å®¢æˆ·ç«¯æ„å¤–ç»ˆæ­¢"></a></p>
</summary>
<div>
<p>ç°åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿå¯¹ Pub/Sub å·²ç»æœ‰æ¯”è¾ƒå®Œæ•´çš„æ”¯æŒï¼Œä½†ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œæœ‰ä¸€ä¸ªæ½œåœ¨çš„å†…å­˜æ³„æ¼çš„ bugã€‚å¦‚æœå®¢æˆ·ç«¯ A subscribe äº† Topic Mï¼Œä½†å®¢æˆ·ç«¯æ„å¤–ç»ˆæ­¢ï¼Œä¸”éšåä¹Ÿæ²¡æœ‰ä»»ä½•äººå¾€ Topic M publish æ¶ˆæ¯ã€‚è¿™æ ·ï¼ŒA çš„ subscription å°±ä¸€ç›´æ”¾åœ¨è¡¨ä¸­ã€‚ä½ èƒ½åšä¸€ä¸ª GC æ¥å¤„ç†è¿™ç§æƒ…å†µä¹ˆï¼Ÿ</p>
<p>Redis è¿˜æ”¯æŒ PSUBSCRIBEï¼Œä¹Ÿå°±æ˜¯è¯´é™¤äº†å¯ä»¥ subscribe â€œchatâ€ è¿™æ ·å›ºå®šçš„ topicï¼Œè¿˜å¯ä»¥æ˜¯ â€œchat.*â€ï¼Œä¸€å¹¶è®¢é˜…æ‰€æœ‰ â€œchatâ€ã€â€œchat.rustâ€ã€â€œchat.elixirâ€ ã€‚æƒ³æƒ³çœ‹ï¼Œå¦‚æœè¦æ”¯æŒ PSUBSCRIBEï¼Œä½ è¯¥æ€ä¹ˆè®¾è®¡ Broadcaster é‡Œçš„ä¸¤å¼ è¡¨ï¼Ÿ</p>
</div>
</details>
<details id="admonition-tokio-æœ¬èº«ä¸å°±æ˜¯-æ”¯æŒäº†å¤šè·¯å¤ç”¨å—ç”¨-yamuxæ¥æ•´åˆå¤šè·¯å¤ç”¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ" class="admonition question">
<summary class="admonition-title">
<p>tokio æœ¬èº«ä¸å°±æ˜¯ æ”¯æŒäº†å¤šè·¯å¤ç”¨å—ï¼Ÿç”¨ yamuxæ¥æ•´åˆå¤šè·¯å¤ç”¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ? </p>
<p><a class="admonition-anchor-link" href="#admonition-tokio-æœ¬èº«ä¸å°±æ˜¯-æ”¯æŒäº†å¤šè·¯å¤ç”¨å—ç”¨-yamuxæ¥æ•´åˆå¤šè·¯å¤ç”¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ"></a></p>
</summary>
<div>
<p>yamux æ˜¯ä¸€ä¸ªå…·ä½“çš„ç½‘ç»œåè®®ï¼Œå®ƒåœ¨ TCP ä¹‹ä¸Šå¯ä»¥è¿è¡Œå¤šä¸ªäº’ä¸å¹²æ‰°çš„ streamï¼ˆå°±åƒ HTTP/2ï¼‰ï¼›tokio æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œå¯ä»¥åœ¨ N ä¸ªçº¿ç¨‹ä¸Šè·‘ M ä¸ª tokio taskã€‚æˆ‘ä»¬åˆ©ç”¨ tokio çš„å¼‚æ­¥èƒ½åŠ›æ¥æ‰¿è½½ Yamux åè®®ã€‚</p>
</div>
</details>
<details id="admonition-érustå†™çš„å®¢æˆ·ç«¯å¯å¦è¿›è¡Œé€šä¿¡" class="admonition note">
<summary class="admonition-title">
<p>érustå†™çš„å®¢æˆ·ç«¯å¯å¦è¿›è¡Œé€šä¿¡ï¼Ÿ </p>
<p><a class="admonition-anchor-link" href="#admonition-érustå†™çš„å®¢æˆ·ç«¯å¯å¦è¿›è¡Œé€šä¿¡"></a></p>
</summary>
<div>
<p>yamux æ˜¯ä¸ªåè®®ï¼Œæ¯”å¦‚ä½ å¯ä»¥ç”¨ nodejs client, python client è®¿é—®ã€‚ä½ å½“ç„¶éœ€è¦ä½¿ç”¨æ”¯æŒ yamux åè®®çš„åº“ï¼Œæ¯”å¦‚ <a href="https://www.npmjs.com/package/yamux-js">yamux-js</a>ã€‚è¿™å°±è·Ÿä½ è¦è®¿é—® http serverï¼Œéœ€è¦ç¬¦åˆåè®®è§„èŒƒçš„ http client ä¸€æ ·ã€‚</p>
</div>
</details>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="kv6_async_refactor.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="kv8_config_ci_cd.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="kv6_async_refactor.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="kv8_config_ci_cd.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
