<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js navy">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>å¹¶å‘åŸè¯­(Concurrency Primitives) - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('navy')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item expanded "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item expanded "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item expanded "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item expanded "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item expanded "><a href="2_2_generic_overview.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹æ¦‚è§ˆï¼šå°±åƒå‡½æ•°</a></li><li class="chapter-item expanded "><a href="2_3_trait_overview.html"><strong aria-hidden="true">4.2.3.</strong> traitæ¦‚è§ˆ</a></li><li class="chapter-item expanded "><a href="2_4_0_three_polymorphics.html"><strong aria-hidden="true">4.2.4.</strong> ä¸‰ç§å¤šæ€å½¢å¼</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_4_1_generic_usage.html"><strong aria-hidden="true">4.2.4.1.</strong> å‚æ•°å¤šæ€-Generics: &lt;&gt;</a></li><li class="chapter-item "><a href="2_4_2_trait_impl.html"><strong aria-hidden="true">4.2.4.2.</strong> ç‰¹è®¾å¤šæ€-Trait impl/bound: self</a></li><li class="chapter-item "><a href="2_4_3_trait_object.html"><strong aria-hidden="true">4.2.4.3.</strong> å­ç±»å‹å¤šæ€Trait object: &self</a></li><li class="chapter-item "><a href="2_4_4_comprehensive_polymorphics.html"><strong aria-hidden="true">4.2.4.4.</strong> å¤æ‚å¤šæ€ç»¼åˆä½¿ç”¨å®ä¾‹</a></li></ol></li><li class="chapter-item expanded "><a href="2_5_trait_frequently.html"><strong aria-hidden="true">4.2.5.</strong> å¸¸ç”¨trait</a></li><li class="chapter-item expanded "><a href="2_6_trait_design.html"><strong aria-hidden="true">4.2.6.</strong> Traitè®¾è®¡</a></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_1_box.html"><strong aria-hidden="true">4.3.1.1.</strong> Box</a></li><li class="chapter-item "><a href="3_1_2_cow.html"><strong aria-hidden="true">4.3.1.2.</strong> Cow&lt;'a, B&gt;</a></li><li class="chapter-item "><a href="3_1_3_mutex_guard.html"><strong aria-hidden="true">4.3.1.3.</strong> MutexGuard&lt;'_, T&gt;</a></li></ol></li><li class="chapter-item expanded "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_2_1_slice.html"><strong aria-hidden="true">4.3.2.1.</strong> åˆ‡ç‰‡</a></li><li class="chapter-item "><a href="3_2_2_hashmap.html"><strong aria-hidden="true">4.3.2.2.</strong> å“ˆå¸Œè¡¨</a></li></ol></li><li class="chapter-item expanded "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_3_1_error_content.html"><strong aria-hidden="true">4.3.3.1.</strong> é”™è¯¯å¤„ç†å†…å®¹å’Œä¸»æµæ–¹æ³•</a></li><li class="chapter-item "><a href="3_3_2_rust_error_handling.html"><strong aria-hidden="true">4.3.3.2.</strong> Rustå¦‚ä½•å¤„ç†é”™è¯¯: ?/unwrap/expect</a></li></ol></li><li class="chapter-item expanded "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="rust_advanced_topics.html"><strong aria-hidden="true">5.</strong> Rusté«˜çº§è¯é¢˜</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">5.1.</strong> I. å®ç¼–ç¨‹</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="4_1_macros_classify.html"><strong aria-hidden="true">5.1.1.</strong> å®åˆ†ç±»</a></li><li class="chapter-item expanded "><a href="4_2_declarative_macros.html"><strong aria-hidden="true">5.1.2.</strong> å£°æ˜å®</a></li><li class="chapter-item expanded "><a href="4_3_procedural_macros.html"><strong aria-hidden="true">5.1.3.</strong> è¿‡ç¨‹å®</a></li></ol></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">5.2.</strong> II. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="5_1_concurrency_primitives.html" class="active"><strong aria-hidden="true">5.2.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item expanded "><a href="5_2_future_async_await.html"><strong aria-hidden="true">5.2.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item expanded "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">5.2.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">5.3.</strong> III. æ··åˆç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="7_network.html"><strong aria-hidden="true">5.4.</strong> IV. ç½‘ç»œå¼€å‘</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="7_1_protocols.html"><strong aria-hidden="true">5.4.1.</strong> ç½‘ç»œåè®®</a></li><li class="chapter-item expanded "><a href="7_2_network_models.html"><strong aria-hidden="true">5.4.2.</strong> ç½‘ç»œæ¨¡å‹</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="big_wheels.html"><strong aria-hidden="true">6.</strong> å¤§è½®å­</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">6.1.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">6.1.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">6.1.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">6.1.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">6.1.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">6.1.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">6.1.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">6.1.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">6.1.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.2.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li></ol></li><li class="chapter-item expanded "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar">æ—¥ä¸è§å¢ æœˆæœ‰æ¸è¿› | å”¯å‰ƒçœŸæˆ‘ æ–¹æœ‰æˆæ•ˆï½œ æƒŠæ¶›æ‹æ¡ˆ åƒå±‚é›ªèµ· | <a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> | ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="å¹¶å‘åŸè¯­"><a class="header" href="#å¹¶å‘åŸè¯­">å¹¶å‘åŸè¯­</a></h1>
<details id="admonition-summarize-made-by-cursor" class="admonition abstract">
<summary class="admonition-title">
<p>Summarize made by cursor</p>
<p><a class="admonition-anchor-link" href="#admonition-summarize-made-by-cursor"></a></p>
</summary>
<div>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Rust ä¸­çš„å¹¶å‘åŸè¯­:</p>
<ol>
<li>åŒ…æ‹¬è‡ªç”±ç«äº‰æ¨¡å¼ã€map/reduce æ¨¡å¼å’Œ DAG æ¨¡å¼ã€‚</li>
<li>åœ¨è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨äº’æ–¥é”æ¥ä¿æŠ¤æŸä¸ªä¸´ç•ŒåŒºï¼Œä½¿è¿›å…¥ä¸´ç•ŒåŒºçš„ä»»åŠ¡æ‹¥æœ‰ç‹¬å è®¿é—®çš„æƒé™ã€‚</li>
<li>åœ¨ map/reduce æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åŸå­é”æ¥ä¿è¯ä»»åŠ¡çš„åŒæ­¥ã€‚</li>
<li>åœ¨ DAG æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨æ¡ä»¶å˜é‡æ¥ä¿è¯ä»»åŠ¡çš„åŒæ­¥ã€‚ </li>
<li>æœ¬æ–‡è¿˜ä»‹ç»äº† Rust ä¸­çš„å‡ ç§å¹¶å‘åŸè¯­ï¼ŒåŒ…æ‹¬ Atomicã€Mutexã€Condvarã€Channel å’Œ Actor modelã€‚æœ€åï¼Œæœ¬æ–‡è¿˜ä»‹ç»äº†å¦‚ä½•ç”¨ Rust å®ç°ä¸€ä¸ªåŸºæœ¬çš„ MPSC Channelã€‚</li>
</ol>
</div>
</details>
<div id="admonition-questions-made-by-cursor" class="admonition question">
<div class="admonition-title">
<p>Questions made by cursor</p>
<p><a class="admonition-anchor-link" href="#admonition-questions-made-by-cursor"></a></p>
</div>
<div>
<ol>
<li>Rustä¸­çš„å¹¶å‘åŸè¯­æœ‰å“ªäº›ï¼Ÿ</li>
<li>Rustä¸­çš„è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹éœ€è¦ç”¨ä»€ä¹ˆæ¥ä¿æŠ¤æŸä¸ªä¸´ç•ŒåŒºï¼Ÿ</li>
<li>Rustä¸­çš„map/reduceæ¨¡å¼ä¸‹éœ€è¦ç”¨ä»€ä¹ˆæ¥ä¿è¯ä»»åŠ¡çš„åŒæ­¥ï¼Ÿ</li>
<li>Rustä¸­çš„DAGæ¨¡å¼ä¸‹éœ€è¦ç”¨ä»€ä¹ˆæ¥ä¿è¯ä»»åŠ¡çš„åŒæ­¥ï¼Ÿ</li>
<li>Rustä¸­çš„å‡ ç§å¹¶å‘åŸè¯­æœ‰å“ªäº›ï¼Ÿ</li>
<li>Rustä¸­å¦‚ä½•ç”¨å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC Channelï¼Ÿ</li>
</ol>
</div>
</div>
<details id="admonition-answers-made-by-cursor" class="admonition tip">
<summary class="admonition-title">
<p>Answers made by cursor</p>
<p><a class="admonition-anchor-link" href="#admonition-answers-made-by-cursor"></a></p>
</summary>
<div>
<ol>
<li>Rustä¸­çš„å¹¶å‘åŸè¯­æœ‰å“ªäº›ï¼Ÿ 
Atomicã€Mutexã€Condvarã€Channel å’Œ Actor modelã€‚</li>
<li>Rustä¸­çš„è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹éœ€è¦ç”¨ä»€ä¹ˆæ¥ä¿æŠ¤æŸä¸ªä¸´ç•ŒåŒºï¼Ÿ
äº’æ–¥é” Mutexã€‚</li>
<li>Rustä¸­çš„map/reduceæ¨¡å¼ä¸‹éœ€è¦ç”¨ä»€ä¹ˆæ¥ä¿è¯ä»»åŠ¡çš„åŒæ­¥ï¼Ÿ
åŸå­é” Atomicã€‚</li>
<li>Rustä¸­çš„DAGæ¨¡å¼ä¸‹éœ€è¦ç”¨ä»€ä¹ˆæ¥ä¿è¯ä»»åŠ¡çš„åŒæ­¥ï¼Ÿ
æ¡ä»¶å˜é‡ Condvarã€‚</li>
<li>Rustä¸­çš„å‡ ç§å¹¶å‘åŸè¯­æœ‰å“ªäº›ï¼Ÿ
Atomicã€Mutexã€Condvarã€Channel å’Œ Actor modelã€‚</li>
<li>Rustä¸­å¦‚ä½•ç”¨å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC Channelï¼Ÿ
å¯ä»¥ä½¿ç”¨ std::sync::mpsc::channel å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ª MPSC Channelï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„ MPSC Channelã€‚</li>
</ol>
</div>
</details>
<!--ts-->
<ul>
<li><a href="#%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD">å¹¶å‘åŸè¯­</a></li>
<li><a href="#%E5%B9%B6%E5%8F%91%E7%9A%84%E9%9A%BE%E7%82%B9%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E5%92%8C%E6%A0%B8%E5%BF%83">å¹¶å‘çš„éš¾ç‚¹ã€å·¥ä½œæ¨¡å¼å’Œæ ¸å¿ƒ</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E6%A2%B3%E7%90%86%E4%B9%9F%E5%B0%B1%E6%98%AF%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD">å¸¸è§å¹¶å‘æ¨¡å‹æ¢³ç†ï¼Œä¹Ÿå°±æ˜¯å¹¶å‘åŸè¯­</a></li>
<li><a href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%80%E8%87%AA%E7%94%B1%E7%AB%9E%E4%BA%89-atomic--mutex">å·¥ä½œæ¨¡å¼ä¸€ã€è‡ªç”±ç«äº‰: Atomic &amp; Mutex</a>
<ul>
<li><a href="#atomic%E8%A7%A3%E5%86%B3%E7%8B%AC%E5%8D%A0%E9%97%AE%E9%A2%98">Atomicè§£å†³ç‹¬å é—®é¢˜</a></li>
</ul>
</li>
<li><a href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%BA%8C%E9%99%90%E5%88%B6%E9%A1%BA%E5%BA%8F%E5%B9%B6%E5%8F%91-mapreduce">å·¥ä½œæ¨¡å¼äºŒã€é™åˆ¶é¡ºåºå¹¶å‘: map/reduce</a>
<ul>
<li><a href="#atomic%E8%BF%98%E5%AD%98%E5%9C%A82%E4%B8%AA%E9%97%AE%E9%A2%98">Atomicè¿˜å­˜åœ¨2ä¸ªé—®é¢˜</a></li>
<li><a href="#%E7%94%A8cas%E6%93%8D%E4%BD%9Cordering%E8%A7%A3%E5%86%B3%E4%B8%A4%E4%B8%AA%E9%97%AE%E9%A2%98">ç”¨CASæ“ä½œ+Orderingè§£å†³ä¸¤ä¸ªé—®é¢˜</a>
<ul>
<li><a href="#cas%E6%93%8D%E4%BD%9C%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%981">CASæ“ä½œè§£å†³é—®é¢˜1</a></li>
<li><a href="#ordering%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%982cas%E9%9C%80%E8%A6%81ordering%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E%E6%93%8D%E4%BD%9C%E7%9A%84%E5%86%85%E5%AD%98%E9%A1%BA%E5%BA%8F">Orderingè§£å†³é—®é¢˜2ï¼šCASéœ€è¦Orderingå‚æ•°è¯´æ˜æ“ä½œçš„å†…å­˜é¡ºåº</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E8%BF%87%E7%A8%8B">è§£å†³è¿‡ç¨‹</a></li>
<li><a href="#%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%BC%98%E5%8C%96">ä¸´ç•ŒåŒºä¼˜åŒ–</a></li>
</ul>
</li>
<li><a href="#atomic%E8%BF%98%E6%9C%89%E4%BB%80%E4%B9%88%E7%94%A8">Atomicè¿˜æœ‰ä»€ä¹ˆç”¨</a></li>
<li><a href="#%E6%9B%B4%E9%AB%98%E5%B1%82%E9%9D%A2%E7%9A%84atomic-mutexmutual-exclusive">æ›´é«˜å±‚é¢çš„Atomic: Mutex(Mutual Exclusive)</a></li>
<li><a href="#atomic%E5%92%8Cmutex%E7%9A%84%E8%81%94%E7%B3%BB">Atomicå’ŒMutexçš„è”ç³»</a></li>
</ul>
</li>
<li><a href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%89%E9%99%90%E5%88%B6%E4%BE%9D%E8%B5%96%E5%B9%B6%E5%8F%91dag-%E6%A8%A1%E5%BC%8F">å·¥ä½œæ¨¡å¼ä¸‰ã€é™åˆ¶ä¾èµ–å¹¶å‘ï¼šDAG æ¨¡å¼</a>
<ul>
<li><a href="#atomic%E5%92%8Cmutex%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3dag%E6%A8%A1%E5%BC%8F-%E6%89%80%E4%BB%A5%E6%9C%89condvar">Atomicå’ŒMutexä¸èƒ½è§£å†³DAGæ¨¡å¼, æ‰€ä»¥æœ‰Condvar</a></li>
<li><a href="#condvar%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8">condvarä»‹ç»ä¸ä½¿ç”¨</a></li>
<li><a href="#%E5%A4%8D%E6%9D%82dag%E6%A8%A1%E5%BC%8Fchannel-or-actor">å¤æ‚DAGæ¨¡å¼ï¼šChannel or Actor</a>
<ul>
<li><a href="#channel">Channel</a>
<ul>
<li><a href="#channel%E5%88%86%E7%B1%BB">Channelåˆ†ç±»</a></li>
</ul>
</li>
<li><a href="#actor">Actor</a></li>
<li><a href="#channelactor%E5%AF%B9%E6%AF%94%E4%B8%8E%E8%81%94%E7%B3%BB">Channel/Actorå¯¹æ¯”ä¸è”ç³»</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E8%87%B3%E4%BA%8Easyncawait%E5%8F%88%E6%98%AF%E5%8F%A6%E4%B8%80%E4%B8%AA%E6%95%85%E4%BA%8B">è‡³äºasync/awaitï¼Œåˆæ˜¯å¦ä¸€ä¸ªæ•…äº‹</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%9F%BA%E6%9C%AC%E7%9A%84mpsc-channel">è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC Channel</a>
<ul>
<li><a href="#%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E7%9A%84%E8%AE%BE%E8%AE%A1">æµ‹è¯•é©±åŠ¨çš„è®¾è®¡</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0-mpsc-channel">å®ç° MPSC channel</a></li>
<li><a href="#%E5%9B%9E%E9%A1%BE%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91">å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘</a></li>
</ul>
</li>
<li><a href="#%E5%B0%8F%E7%BB%93%E4%B8%80%E4%B8%8B%E5%90%84%E7%A7%8D%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯</a></li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Apr 26 15:36:20 UTC 2023 -->
<!--te-->
<h1 id="å¹¶å‘çš„éš¾ç‚¹å·¥ä½œæ¨¡å¼å’Œæ ¸å¿ƒ"><a class="header" href="#å¹¶å‘çš„éš¾ç‚¹å·¥ä½œæ¨¡å¼å’Œæ ¸å¿ƒ">å¹¶å‘çš„éš¾ç‚¹ã€å·¥ä½œæ¨¡å¼å’Œæ ¸å¿ƒ</a></h1>
<details id="admonition-å¤„ç†å¹¶å‘çš„éš¾ç‚¹åœ¨å“ªé‡Œ" class="admonition info">
<summary class="admonition-title">
<p>å¤„ç†å¹¶å‘çš„éš¾ç‚¹åœ¨å“ªé‡Œï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-å¤„ç†å¹¶å‘çš„éš¾ç‚¹åœ¨å“ªé‡Œ"></a></p>
</summary>
<div>
<p>å…¶å®æœ‰å¾ˆå¤šå’Œå¹¶å‘ç›¸å…³çš„å†…å®¹ã€‚æ¯”å¦‚ç”¨ std::thread æ¥åˆ›å»ºçº¿ç¨‹ã€ç”¨ std::sync ä¸‹çš„å¹¶å‘åŸè¯­ï¼ˆMutexï¼‰æ¥å¤„ç†å¹¶å‘è¿‡ç¨‹ä¸­çš„åŒæ­¥é—®é¢˜ã€ç”¨ Send/Sync trait æ¥ä¿è¯å¹¶å‘çš„å®‰å…¨ç­‰ç­‰ã€‚</p>
<p>åœ¨å¤„ç†å¹¶å‘çš„è¿‡ç¨‹ä¸­ï¼Œéš¾ç‚¹å¹¶ä¸åœ¨äºå¦‚ä½•åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥åˆ†é…å·¥ä½œï¼Œåœ¨äºå¦‚ä½•åœ¨è¿™äº›å¹¶å‘çš„ä»»åŠ¡ä¸­è¿›è¡ŒåŒæ­¥ã€‚</p>
</div>
</details>
<details id="admonition-è¡ç”Ÿå‡ºå“ªäº›å·¥ä½œæ¨¡å¼" class="admonition question">
<summary class="admonition-title">
<p>è¡ç”Ÿå‡ºå“ªäº›å·¥ä½œæ¨¡å¼</p>
<p><a class="admonition-anchor-link" href="#admonition-è¡ç”Ÿå‡ºå“ªäº›å·¥ä½œæ¨¡å¼"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬æ¥çœ‹å¹¶å‘çŠ¶æ€ä¸‹å‡ ç§å¸¸è§çš„å·¥ä½œæ¨¡å¼ï¼šè‡ªç”±ç«äº‰æ¨¡å¼ã€map/reduce æ¨¡å¼ã€DAG æ¨¡å¼</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/33%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F-4950283.jpg" alt="33ï½œå¹¶å‘å¤„ç†ï¼ˆä¸Šï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
</div>
</details>
<details id="admonition-1-è‡ªç”±ç«äº‰-atomic--mutex" class="admonition info">
<summary class="admonition-title">
<ol>
<li>è‡ªç”±ç«äº‰: Atomic &amp; Mutex</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-1-è‡ªç”±ç«äº‰-atomic--mutex"></a></p>
</summary>
<div>
<p>åœ¨è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªå¹¶å‘ä»»åŠ¡ä¼šç«äº‰åŒä¸€ä¸ªä¸´ç•ŒåŒºçš„è®¿é—®æƒã€‚</p>
<blockquote>
<p>ä»»åŠ¡ä¹‹é—´åœ¨ä½•æ—¶ã€ä»¥ä½•ç§æ–¹å¼å»è®¿é—®ä¸´ç•ŒåŒºï¼Œæ˜¯ä¸ç¡®å®šçš„ï¼Œæˆ–è€…è¯´æ˜¯æœ€ä¸ºçµæ´»çš„ï¼Œåªè¦åœ¨è¿›å…¥ä¸´ç•ŒåŒºæ—¶è·å¾—ç‹¬å è®¿é—®å³å¯ã€‚</p>
</blockquote>
</div>
</details>
<blockquote>
<p>åœ¨è‡ªç”±ç«äº‰çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é™åˆ¶å¹¶å‘çš„åŒæ­¥æ¨¡å¼ï¼Œå…¸å‹çš„æœ‰ map/reduce æ¨¡å¼å’Œ DAG æ¨¡å¼ï¼š</p>
</blockquote>
<details id="admonition-2-é™åˆ¶é¡ºåºå¹¶å‘-mapreduce" class="admonition info">
<summary class="admonition-title">
<ol start="2">
<li>é™åˆ¶é¡ºåºå¹¶å‘: map/reduce</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-é™åˆ¶é¡ºåºå¹¶å‘-mapreduce"></a></p>
</summary>
<div>
<p>map/reduce æ¨¡å¼ï¼ŒæŠŠå·¥ä½œæ‰“æ•£ï¼ŒæŒ‰ç…§ç›¸åŒçš„å¤„ç†å®Œæˆåï¼Œå†æŒ‰ç…§ä¸€å®šçš„é¡ºåºå°†ç»“æœç»„ç»‡èµ·æ¥ï¼›</p>
</div>
</details>
<details id="admonition-3-é™åˆ¶ä¾èµ–å¹¶å‘dag-æ¨¡å¼" class="admonition info">
<summary class="admonition-title">
<ol start="3">
<li>é™åˆ¶ä¾èµ–å¹¶å‘ï¼šDAG æ¨¡å¼</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-3-é™åˆ¶ä¾èµ–å¹¶å‘dag-æ¨¡å¼"></a></p>
</summary>
<div>
<p>DAG æ¨¡å¼ï¼ŒæŠŠå·¥ä½œåˆ‡æˆä¸ç›¸äº¤çš„ã€æœ‰ä¾èµ–å…³ç³»çš„å­ä»»åŠ¡ï¼Œç„¶åæŒ‰ä¾èµ–å…³ç³»å¹¶å‘æ‰§è¡Œã€‚</p>
</div>
</details>
<details id="admonition-è¿™äº›å·¥ä½œæ¨¡å¼çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆ" class="admonition question">
<summary class="admonition-title">
<p>è¿™äº›å·¥ä½œæ¨¡å¼çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-è¿™äº›å·¥ä½œæ¨¡å¼çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆ"></a></p>
</summary>
<div>
<blockquote>
<p>è¿™ä¸‰ç§åŸºæœ¬æ¨¡å¼ç»„åˆèµ·æ¥ï¼Œå¯ä»¥å¤„ç†éå¸¸å¤æ‚çš„å¹¶å‘åœºæ™¯ã€‚
æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬å¤„ç†å¤æ‚é—®é¢˜çš„æ—¶å€™:</p>
</blockquote>
<ul>
<li>åº”è¯¥å…ˆå˜æ¸…å…¶è„‰ç»œ</li>
<li>ç”¨åˆ†æ²»çš„æ€æƒ³æŠŠé—®é¢˜æ‹†è§£æˆæ­£äº¤çš„å­é—®é¢˜</li>
<li>ç„¶åç»„åˆåˆé€‚çš„å¹¶å‘æ¨¡å¼æ¥å¤„ç†è¿™äº›å­é—®é¢˜ã€‚</li>
</ul>
</div>
</details>
<h1 id="å¸¸è§å¹¶å‘æ¨¡å‹æ¢³ç†ä¹Ÿå°±æ˜¯å¹¶å‘åŸè¯­"><a class="header" href="#å¸¸è§å¹¶å‘æ¨¡å‹æ¢³ç†ä¹Ÿå°±æ˜¯å¹¶å‘åŸè¯­">å¸¸è§å¹¶å‘æ¨¡å‹æ¢³ç†ï¼Œä¹Ÿå°±æ˜¯å¹¶å‘åŸè¯­</a></h1>
<ul>
<li><a href="https://www.quora.com/What-are-concurrency-primitives">What are concurrency primitives? - Quora</a></li>
</ul>
<details id="admonition-åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢" class="admonition question">
<summary class="admonition-title">
<p>åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåï¼Œéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢</p>
<p><a class="admonition-anchor-link" href="#admonition-åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢"></a></p>
</summary>
<div>
<p>åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåï¼Œéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢ï¼š</p>
<ol>
<li>Atomicï¼šåŸå­é”</li>
<li>Mutexï¼šäº’æ–¥é”</li>
<li>Condvarï¼šæ¡ä»¶å˜é‡</li>
</ol>
<ul>
<li>æ¡ä»¶å˜é‡è¡¨ç¤ºé˜»å¡çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä½¿å…¶åœ¨ç­‰å¾…äº‹ä»¶å‘ç”Ÿæ—¶ä¸æ¶ˆè€— CPU æ—¶é—´ã€‚</li>
<li>æ¡ä»¶å˜é‡é€šå¸¸ä¸å¸ƒå°”è°“è¯(æ¡ä»¶)å’Œäº’æ–¥é”ç›¸å…³è”ã€‚</li>
<li>åœ¨ç¡®å®šçº¿ç¨‹å¿…é¡»é˜»å¡ä¹‹å‰ï¼Œå§‹ç»ˆåœ¨äº’æ–¥é”å†…éƒ¨éªŒè¯è°“è¯ã€‚</li>
</ul>
<ol start="4">
<li>Channel </li>
<li>Actor model</li>
</ol>
</div>
</details>
<h1 id="å·¥ä½œæ¨¡å¼ä¸€è‡ªç”±ç«äº‰-atomic--mutex"><a class="header" href="#å·¥ä½œæ¨¡å¼ä¸€è‡ªç”±ç«äº‰-atomic--mutex">å·¥ä½œæ¨¡å¼ä¸€ã€è‡ªç”±ç«äº‰: Atomic &amp; Mutex</a></h1>
<h2 id="atomicè§£å†³ç‹¬å é—®é¢˜"><a class="header" href="#atomicè§£å†³ç‹¬å é—®é¢˜">Atomicè§£å†³ç‹¬å é—®é¢˜</a></h2>
<p>Atomic æ˜¯æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºç¡€ï¼Œå®ƒä¸ºå¹¶å‘ä»»åŠ¡çš„åŒæ­¥å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚</p>
<blockquote>
<p>è°ˆåˆ°åŒæ­¥ï¼Œç›¸ä¿¡ä½ é¦–å…ˆä¼šæƒ³åˆ°é”
æ‰€ä»¥åœ¨å…·ä½“ä»‹ç» atomic ä¹‹å‰ï¼Œæˆ‘ä»¬ä»æœ€åŸºæœ¬çš„é”è¯¥å¦‚ä½•å®ç°è®²èµ·ã€‚
è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨äº’æ–¥é”æ¥ä¿æŠ¤æŸä¸ªä¸´ç•ŒåŒºï¼Œä½¿è¿›å…¥ä¸´ç•ŒåŒºçš„ä»»åŠ¡æ‹¥æœ‰ç‹¬å è®¿é—®çš„æƒé™ã€‚</p>
</blockquote>
<details id="admonition-äº’æ–¥é”ä»£ç ç¤ºä¾‹-è¿™æ®µä»£ç æ¨¡æ‹Ÿäº†-mutex-çš„å®ç°å®ƒçš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯-lock-æ–¹æ³•" class="admonition info">
<summary class="admonition-title">
<p>äº’æ–¥é”ä»£ç ç¤ºä¾‹: è¿™æ®µä»£ç æ¨¡æ‹Ÿäº† Mutex çš„å®ç°ï¼Œå®ƒçš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯ lock() æ–¹æ³•ã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-äº’æ–¥é”ä»£ç ç¤ºä¾‹-è¿™æ®µä»£ç æ¨¡æ‹Ÿäº†-mutex-çš„å®ç°å®ƒçš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯-lock-æ–¹æ³•"></a></p>
</summary>
<div>
<blockquote>
<p>ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œåœ¨è·å–è¿™æŠŠé”çš„æ—¶å€™ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå°±ä¸€ç›´æ­»å¾ªç¯ï¼Œç›´åˆ°æ‹¿åˆ°é”ä¸ºæ­¢ï¼ˆä»£ç ï¼‰ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{cell::RefCell, fmt, sync::Arc, thread};

struct Lock&lt;T&gt; {
    locked: RefCell&lt;bool&gt;,
    data: RefCell&lt;T&gt;,
}

impl&lt;T&gt; fmt::Debug for Lock&lt;T&gt;
where
    T: fmt::Debug,
{
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, &quot;Lock&lt;{:?}&gt;&quot;, self.data.borrow())
    }
}

// SAFETY: æˆ‘ä»¬ç¡®ä¿¡ Lock&lt;T&gt; å¾ˆå®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«
unsafe impl&lt;T&gt; Sync for Lock&lt;T&gt; {}

impl&lt;T&gt; Lock&lt;T&gt; {
    pub fn new(data: T) -&gt; Self {
        Self {
            data: RefCell::new(data),
            locked: RefCell::new(false),
        }
    }

    pub fn lock(&amp;self, op: impl FnOnce(&amp;mut T)) {
        // å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin
        while *self.locked.borrow() != false {} // **1

        // æ‹¿åˆ°ï¼Œèµ¶ç´§åŠ é”
        *self.locked.borrow_mut() = true; // **2

        // å¼€å§‹å¹²æ´»
        op(&amp;mut self.data.borrow_mut()); // **3

        // è§£é”
        *self.locked.borrow_mut() = false; // **4
    }
}

fn main() {
    let data = Arc::new(Lock::new(0));

    let data1 = data.clone();
    let t1 = thread::spawn(move || {
        data1.lock(|v| *v += 10);
    });

    let data2 = data.clone();
    let t2 = thread::spawn(move || {
        data2.lock(|v| *v *= 10);
    });
    t1.join().unwrap();
    t2.join().unwrap();

    println!(&quot;data: {:?}&quot;, data);
}
</code></pre></pre>
<p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼ŒMutex åœ¨è°ƒç”¨ lock() åï¼Œä¼šå¾—åˆ°ä¸€ä¸ª MutexGuard çš„ RAII ç»“æ„.
è¿™é‡Œä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œè¦æ±‚è°ƒç”¨è€…ä¼ å…¥ä¸€ä¸ªé—­åŒ…ï¼Œæ¥å¤„ç†åŠ é”åçš„äº‹åŠ¡ã€‚</p>
<blockquote>
<p>åœ¨ lock() æ–¹æ³•é‡Œ:</p>
</blockquote>
<ul>
<li>æ‹¿ä¸åˆ°é”çš„å¹¶å‘ä»»åŠ¡ä¼šä¸€ç›´ spin</li>
<li>æ‹¿åˆ°é”çš„ä»»åŠ¡å¯ä»¥å¹²æ´»</li>
<li>å¹²å®Œæ´»åä¼šè§£é”</li>
<li>è¿™æ ·ä¹‹å‰ spin çš„ä»»åŠ¡ä¼šç«äº‰åˆ°é”ï¼Œè¿›å…¥ä¸´ç•ŒåŒºã€‚</li>
</ul>
</div>
</details>
<h1 id="å·¥ä½œæ¨¡å¼äºŒé™åˆ¶é¡ºåºå¹¶å‘-mapreduce"><a class="header" href="#å·¥ä½œæ¨¡å¼äºŒé™åˆ¶é¡ºåºå¹¶å‘-mapreduce">å·¥ä½œæ¨¡å¼äºŒã€é™åˆ¶é¡ºåºå¹¶å‘: map/reduce</a></h1>
<h2 id="atomicè¿˜å­˜åœ¨2ä¸ªé—®é¢˜"><a class="header" href="#atomicè¿˜å­˜åœ¨2ä¸ªé—®é¢˜">Atomicè¿˜å­˜åœ¨2ä¸ªé—®é¢˜</a></h2>
<blockquote>
<p>è¿™æ ·çš„å®ç°çœ‹ä¸Šå»ä¼¼ä¹é—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯ä½ ç»†æƒ³ï¼Œå®ƒæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
</blockquote>
<details id="admonition-1-å¯èƒ½åŒæ—¶æ‹¿åˆ°é”" class="admonition info">
<summary class="admonition-title">
<ol>
<li>å¯èƒ½åŒæ—¶æ‹¿åˆ°é”</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-1-å¯èƒ½åŒæ—¶æ‹¿åˆ°é”"></a></p>
</summary>
<div>
<ul>
<li>
<p>åœ¨å¤šæ ¸æƒ…å†µä¸‹ï¼Œ**1 å’Œ **2 ä¹‹é—´ï¼Œæœ‰å¯èƒ½å…¶å®ƒçº¿ç¨‹ä¹Ÿç¢°å·§ spin ç»“æŸï¼ŒæŠŠ locked ä¿®æ”¹ä¸º trueã€‚è¿™æ ·ï¼Œå­˜åœ¨å¤šä¸ªçº¿ç¨‹æ‹¿åˆ°è¿™æŠŠé”ï¼Œç ´åäº†ä»»ä½•çº¿ç¨‹éƒ½æœ‰ç‹¬å è®¿é—®çš„ä¿è¯ã€‚</p>
</li>
<li>
<p>å³ä¾¿åœ¨å•æ ¸æƒ…å†µä¸‹ï¼Œ**1 å’Œ **2 ä¹‹é—´ï¼Œä¹Ÿå¯èƒ½å› ä¸ºæ“ä½œç³»ç»Ÿçš„å¯æŠ¢å å¼è°ƒåº¦ï¼Œå¯¼è‡´é—®é¢˜ 1 å‘ç”Ÿã€‚</p>
</li>
</ul>
</div>
</details>
<details id="admonition-2-cpuä¹±åºæ‰§è¡Œå¯èƒ½ç ´åé”" class="admonition info">
<summary class="admonition-title">
<ol start="2">
<li>CPUä¹±åºæ‰§è¡Œå¯èƒ½ç ´åé”</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-cpuä¹±åºæ‰§è¡Œå¯èƒ½ç ´åé”"></a></p>
</summary>
<div>
<ul>
<li>
<p>å¦‚ä»Šçš„ç¼–è¯‘å™¨ä¼šæœ€å¤§ç¨‹åº¦ä¼˜åŒ–ç”Ÿæˆçš„æŒ‡ä»¤ï¼Œå¦‚æœæ“ä½œä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯èƒ½ä¼šç”Ÿæˆä¹±åºçš„æœºå™¨ç ï¼Œæ¯”å¦‚**3 è¢«ä¼˜åŒ–æ”¾åœ¨ **1 ä¹‹å‰ï¼Œä»è€Œç ´åäº†è¿™ä¸ª lock çš„ä¿è¯ã€‚</p>
</li>
<li>
<p>å³ä¾¿ç¼–è¯‘å™¨ä¸åšä¹±åºå¤„ç†ï¼ŒCPU ä¹Ÿä¼šæœ€å¤§ç¨‹åº¦åšæŒ‡ä»¤çš„ä¹±åºæ‰§è¡Œï¼Œè®©æµæ°´çº¿çš„æ•ˆç‡æœ€é«˜ã€‚åŒæ ·ä¼šå‘ç”Ÿ 3 çš„é—®é¢˜ã€‚</p>
</li>
</ul>
</div>
</details>
<blockquote>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å®ç°è¿™ä¸ªé”çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚å¯èƒ½å¤§éƒ¨åˆ†æ—¶é—´å¦‚æˆ‘ä»¬æ‰€æ„¿ï¼Œä½†ä¼šéšæœºå‡ºç°å¥‡å¥‡æ€ªæ€ªçš„è¡Œä¸ºã€‚</p>
</blockquote>
<p>ä¸€æ—¦è¿™æ ·çš„äº‹æƒ…å‘ç”Ÿï¼Œbug å¯èƒ½ä¼šä»¥å„ç§ä¸åŒçš„é¢è²Œå‡ºç°åœ¨ç³»ç»Ÿçš„å„ä¸ªè§’è½ã€‚
è€Œä¸”ï¼Œè¿™æ ·çš„ bug å‡ ä¹æ˜¯æ— è§£çš„ï¼Œå› ä¸ºå®ƒå¾ˆéš¾ç¨³å®šå¤ç°ï¼Œè¡¨ç°è¡Œä¸ºå¾ˆä¸ä¸€è‡´ï¼Œç”šè‡³ï¼Œåªåœ¨æŸä¸ª CPU ä¸‹å‡ºç°ã€‚</p>
<blockquote>
<p>è¿™é‡Œå†å¼ºè°ƒä¸€ä¸‹ unsafe ä»£ç éœ€è¦è¶³å¤Ÿä¸¥è°¨ï¼Œéœ€è¦éå¸¸æœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆå»å®¡æŸ¥.
è¿™æ®µä»£ç ä¹‹æ‰€ä»¥ç ´åäº†å¹¶å‘å®‰å…¨æ€§ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬é”™è¯¯åœ°è®¤ä¸ºï¼šä¸º Lock<T> å®ç° Syncï¼Œæ˜¯å®‰å…¨çš„ã€‚</p>
</blockquote>
<blockquote>
<p>ä¸ºäº†è§£å†³ä¸Šé¢è¿™æ®µä»£ç çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ CPU å±‚é¢åšä¸€äº›ä¿è¯ï¼Œè®©æŸäº›æ“ä½œæˆä¸ºåŸå­æ“ä½œã€‚</p>
</blockquote>
<h2 id="ç”¨casæ“ä½œorderingè§£å†³ä¸¤ä¸ªé—®é¢˜"><a class="header" href="#ç”¨casæ“ä½œorderingè§£å†³ä¸¤ä¸ªé—®é¢˜">ç”¨CASæ“ä½œ+Orderingè§£å†³ä¸¤ä¸ªé—®é¢˜</a></h2>
<p>å› ä¸º CAS å’Œ ordering éƒ½æ˜¯ç³»ç»Ÿçº§çš„æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œæè¿°çš„ Ordering çš„ç”¨é€”åœ¨å„ç§è¯­è¨€ä¸­éƒ½å¤§åŒå°å¼‚ã€‚
å¯¹äº Rust æ¥è¯´ï¼Œå®ƒçš„ atomic åŸè¯­<a href="https://en.cppreference.com/w/cpp/atomic/memory_order">ç»§æ‰¿äº C++</a>ã€‚
å¦‚æœè¯» Rust çš„æ–‡æ¡£ä½ æ„Ÿè§‰äº‘é‡Œé›¾é‡Œï¼Œé‚£ä¹ˆ C++ å…³äº ordering çš„æ–‡æ¡£è¦æ¸…æ™°å¾—å¤šã€‚</p>
<h3 id="casæ“ä½œè§£å†³é—®é¢˜1"><a class="header" href="#casæ“ä½œè§£å†³é—®é¢˜1">CASæ“ä½œè§£å†³é—®é¢˜1</a></h3>
<details id="admonition-casæ˜¯ä»€ä¹ˆ" class="admonition question">
<summary class="admonition-title">
<p>CASæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-casæ˜¯ä»€ä¹ˆ"></a></p>
</summary>
<div>
<p>å¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤è¯»å–æŸä¸ªå†…å­˜åœ°å€ï¼Œåˆ¤æ–­å…¶å€¼æ˜¯å¦ç­‰äºæŸä¸ªå‰ç½®å€¼ï¼Œå¦‚æœç›¸ç­‰ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæ–°çš„å€¼ã€‚</p>
<p>è¿™å°±æ˜¯ Compare-and-swap æ“ä½œï¼Œç®€ç§°CASã€‚</p>
<blockquote>
<p>å®ƒæ˜¯æ“ä½œç³»ç»Ÿçš„å‡ ä¹æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºçŸ³ï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å®ç°ä¸€ä¸ªå¯ä»¥æ­£å¸¸å·¥ä½œçš„é”ã€‚</p>
</blockquote>
<p>Rustä¸“é—¨ä¸º<code>std::sync::atomic</code>ä¸­çš„æ•°æ®ç»“æ„æä¾›äº†CASæ“ä½œæ–¹æ³•compare_exhange</p>
</div>
</details>
<h3 id="orderingè§£å†³é—®é¢˜2caséœ€è¦orderingå‚æ•°è¯´æ˜æ“ä½œçš„å†…å­˜é¡ºåº"><a class="header" href="#orderingè§£å†³é—®é¢˜2caséœ€è¦orderingå‚æ•°è¯´æ˜æ“ä½œçš„å†…å­˜é¡ºåº">Orderingè§£å†³é—®é¢˜2ï¼šCASéœ€è¦Orderingå‚æ•°è¯´æ˜æ“ä½œçš„å†…å­˜é¡ºåº</a></h3>
<details id="admonition-orderingæšä¸¾ä½“è¯´æ˜-å¯¹é”çš„5ä¸ªæ“ä½œ" class="admonition info">
<summary class="admonition-title">
<p>Orderingæšä¸¾ä½“è¯´æ˜: å¯¹é”çš„5ä¸ªæ“ä½œ</p>
<p><a class="admonition-anchor-link" href="#admonition-orderingæšä¸¾ä½“è¯´æ˜-å¯¹é”çš„5ä¸ªæ“ä½œ"></a></p>
</summary>
<div>
<p>è¿™å°±æ˜¯è¿™ä¸ªå‡½æ•°é‡Œé¢å¤–çš„ä¸¤ä¸ªå’Œ <a href="https://doc.rust-lang.org/std/sync/atomic/enum.Ordering.html">Ordering</a> æœ‰å…³çš„å¥‡æ€ªå‚æ•°ã€‚</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub enum Ordering {
    Relaxed,
    Release,
    Acquire,
    AcqRel,
    SeqCst,
}
</code></pre></pre>
<blockquote>
<p>æ–‡æ¡£é‡Œè§£é‡Šäº†å‡ ç§ Ordering çš„ç”¨é€”ï¼Œç¨ç¨æ‰©å±•ä¸€ä¸‹ã€‚</p>
</blockquote>
<ol>
<li>
<p>ç¬¬ä¸€ä¸ª Relaxedï¼Œè¿™æ˜¯æœ€å®½æ¾çš„è§„åˆ™ï¼Œå®ƒå¯¹ç¼–è¯‘å™¨å’Œ CPU ä¸åšä»»ä½•é™åˆ¶ï¼Œå¯ä»¥ä¹±åºæ‰§è¡Œã€‚</p>
</li>
<li>
<p>Releaseï¼Œå½“æˆ‘ä»¬å†™å…¥æ•°æ®ï¼ˆæ¯”å¦‚ä¸Šé¢ä»£ç é‡Œçš„ storeï¼‰çš„æ—¶å€™ï¼Œå¦‚æœç”¨äº† Release orderï¼Œé‚£ä¹ˆï¼š</p>
</li>
</ol>
<ul>
<li>å¯¹äºå½“å‰çº¿ç¨‹ï¼Œä»»ä½•è¯»å–æˆ–å†™å…¥æ“ä½œéƒ½ä¸èƒ½è¢«ä¹±åºæ’åœ¨è¿™ä¸ª store ä¹‹åã€‚</li>
<li>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­é‡Œï¼ŒCPU æˆ–è€…ç¼–è¯‘å™¨ä¸èƒ½æŠŠ **3 æŒªåˆ° **4 ä¹‹åæ‰§è¡Œã€‚</li>
</ul>
<ol start="3">
<li>å¯¹äºå…¶å®ƒçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨äº† Acquire æ¥è¯»å–è¿™ä¸ª atomic çš„æ•°æ®ï¼Œ é‚£ä¹ˆå®ƒä»¬çœ‹åˆ°çš„æ˜¯ä¿®æ”¹åçš„ç»“æœã€‚</li>
</ol>
<ul>
<li>ä¸‹é¢ä»£ç æˆ‘ä»¬åœ¨ compare_exchange é‡Œä½¿ç”¨äº† Acquire æ¥è¯»å–ï¼Œæ‰€ä»¥èƒ½ä¿è¯è¯»åˆ°æœ€æ–°çš„å€¼ã€‚</li>
<li>è€Œ Acquire æ˜¯å½“æˆ‘ä»¬è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœç”¨äº† Acquire orderï¼Œé‚£ä¹ˆï¼š
<ul>
<li>å¯¹äºå½“å‰çº¿ç¨‹ï¼Œä»»ä½•è¯»å–æˆ–è€…å†™å…¥æ“ä½œéƒ½ä¸èƒ½è¢«ä¹±åºæ’åœ¨è¿™ä¸ªè¯»å–ä¹‹å‰ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­é‡Œï¼ŒCPU æˆ–è€…ç¼–è¯‘å™¨ä¸èƒ½æŠŠ **3 æŒªåˆ° **1 ä¹‹å‰æ‰§è¡Œã€‚</li>
<li>å¯¹äºå…¶å®ƒçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨äº† Release æ¥ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆï¼Œä¿®æ”¹çš„å€¼å¯¹å½“å‰çº¿ç¨‹å¯è§ã€‚</li>
</ul>
</li>
</ul>
<ol start="4">
<li>ç¬¬å››ä¸ª AcqRel æ˜¯ Acquire å’Œ Release çš„ç»“åˆï¼ŒåŒæ—¶æ‹¥æœ‰ Acquire å’Œ Release çš„ä¿è¯ã€‚</li>
</ol>
<ul>
<li>è¿™ä¸ªä¸€èˆ¬ç”¨åœ¨ fetch_xxx ä¸Šï¼Œæ¯”å¦‚ä½ è¦å¯¹ä¸€ä¸ª atomic è‡ªå¢ 1ï¼Œä½ å¸Œæœ›è¿™ä¸ªæ“ä½œä¹‹å‰å’Œä¹‹åçš„è¯»å–æˆ–å†™å…¥æ“ä½œä¸ä¼šè¢«ä¹±åºï¼Œå¹¶ä¸”æ“ä½œçš„ç»“æœå¯¹å…¶å®ƒçº¿ç¨‹å¯è§ã€‚</li>
</ul>
<ol start="5">
<li>æœ€åçš„ SeqCst æ˜¯æœ€ä¸¥æ ¼çš„ orderingï¼Œé™¤äº† AcqRel çš„ä¿è¯å¤–ï¼Œå®ƒè¿˜ä¿è¯æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ‰€æœ‰ SeqCst æ“ä½œçš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚</li>
</ol>
</div>
</details>
<h3 id="è§£å†³è¿‡ç¨‹"><a class="header" href="#è§£å†³è¿‡ç¨‹">è§£å†³è¿‡ç¨‹</a></h3>
<blockquote>
<p>æ‰€ä»¥ï¼Œåˆšæ‰çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€å¼€å§‹çš„å¾ªç¯æ”¹æˆï¼š</p>
</blockquote>
<details id="admonition-atomiccasordering-ç¡®ä¿åŸå­æ“ä½œé¡ºåº" class="admonition info">
<summary class="admonition-title">
<p>Atomic+CAS+ordering: ç¡®ä¿åŸå­æ“ä½œé¡ºåº</p>
<p><a class="admonition-anchor-link" href="#admonition-atomiccasordering-ç¡®ä¿åŸå­æ“ä½œé¡ºåº"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
while self
  .locked
  .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)
  .is_err() {}
</code></pre></pre>
<p>è¿™å¥çš„æ„æ€æ˜¯ï¼š</p>
<ol>
<li>å¦‚æœ locked å½“å‰çš„å€¼æ˜¯ falseï¼Œå°±å°†å…¶æ”¹æˆ trueã€‚</li>
<li>è¿™æ•´ä¸ªæ“ä½œåœ¨ä¸€æ¡æŒ‡ä»¤é‡Œå®Œæˆï¼Œä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹æ‰“æ–­æˆ–è€…ä¿®æ”¹ï¼›</li>
<li>å¦‚æœ locked çš„å½“å‰å€¼ä¸æ˜¯ falseï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›é”™è¯¯ï¼Œæˆ‘ä»¬ä¼šåœ¨æ­¤ä¸åœ spinï¼Œç›´åˆ°å‰ç½®æ¡ä»¶å¾—åˆ°æ»¡è¶³ã€‚</li>
</ol>
<ul>
<li>è¿™é‡Œï¼Œcompare_exchange æ˜¯ Rust æä¾›çš„ CAS æ“ä½œï¼Œå®ƒä¼šè¢«ç¼–è¯‘æˆ CPU çš„å¯¹åº” CAS æŒ‡ä»¤ã€‚</li>
</ul>
<blockquote>
<p>å½“è¿™å¥æ‰§è¡ŒæˆåŠŸåï¼Œlocked å¿…ç„¶ä¼šè¢«æ”¹å˜ä¸º trueï¼Œæˆ‘ä»¬æˆåŠŸæ‹¿åˆ°äº†é”ï¼Œè€Œä»»ä½•å…¶ä»–çº¿ç¨‹éƒ½ä¼šåœ¨è¿™å¥è¯ä¸Š spinã€‚</p>
</blockquote>
<p>åŒæ ·åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œç›¸åº”åœ°éœ€è¦ä½¿ç”¨ atomic çš„ç‰ˆæœ¬ï¼Œè€Œéç›´æ¥èµ‹å€¼æˆ falseï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
self.locked.store(false, Ordering::Release);
</code></pre></pre>
</div>
</details>
<p>å½“ç„¶ï¼Œä¸ºäº†é…åˆè¿™æ ·çš„æ”¹åŠ¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠ locked ä» bool æ”¹æˆ AtomicBoolã€‚</p>
<blockquote>
<p>åœ¨ Rust é‡Œï¼Œstd::sync::atomic æœ‰å¤§é‡çš„ atomic æ•°æ®ç»“æ„ï¼Œå¯¹åº”å„ç§åŸºç¡€ç»“æ„ã€‚</p>
</blockquote>
<details id="admonition-atomicboolcompare_exchangeorderingå‚æ•°æˆ‘ä»¬çœ‹ä½¿ç”¨äº†-atomicbool-çš„æ–°å®ç°ä»£ç " class="admonition info">
<summary class="admonition-title">
<p>AtomicBool+compare_exchange+Orderingå‚æ•°ï¼šæˆ‘ä»¬çœ‹ä½¿ç”¨äº† AtomicBool çš„æ–°å®ç°ï¼ˆä»£ç ï¼‰ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-atomicboolcompare_exchangeorderingå‚æ•°æˆ‘ä»¬çœ‹ä½¿ç”¨äº†-atomicbool-çš„æ–°å®ç°ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{
    cell::RefCell,
    fmt,
    sync::{
        atomic::{AtomicBool, Ordering},
        Arc,
    },
    thread,
};

struct Lock&lt;T&gt; {
    locked: AtomicBool,
    data: RefCell&lt;T&gt;,
}

impl&lt;T&gt; fmt::Debug for Lock&lt;T&gt;
where
    T: fmt::Debug,
{
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, &quot;Lock&lt;{:?}&gt;&quot;, self.data.borrow())
    }
}

// SAFETY: æˆ‘ä»¬ç¡®ä¿¡ Lock&lt;T&gt; å¾ˆå®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«
unsafe impl&lt;T&gt; Sync for Lock&lt;T&gt; {}

impl&lt;T&gt; Lock&lt;T&gt; {
    pub fn new(data: T) -&gt; Self {
        Self {
            data: RefCell::new(data),
            locked: AtomicBool::new(false),
        }
    }

    pub fn lock(&amp;self, op: impl FnOnce(&amp;mut T)) {
        // å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin
        while self
            .locked
            .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)
            .is_err()
        {} // **1

        // å·²ç»æ‹¿åˆ°å¹¶åŠ é”ï¼Œå¼€å§‹å¹²æ´»
        op(&amp;mut self.data.borrow_mut()); // **3

        // è§£é”
        self.locked.store(false, Ordering::Release);
    }
}

fn main() {
    let data = Arc::new(Lock::new(0));

    let data1 = data.clone();
    let t1 = thread::spawn(move || {
        data1.lock(|v| *v += 10);
    });

    let data2 = data.clone();
    let t2 = thread::spawn(move || {
        data2.lock(|v| *v *= 10);
    });
    t1.join().unwrap();
    t2.join().unwrap();

    println!(&quot;data: {:?}&quot;, data);
}
</code></pre></pre>
</div>
</details>
<p>å¯ä»¥çœ‹åˆ°:</p>
<details id="admonition-é€šè¿‡ä½¿ç”¨-compare_exchangeordering-è§„é¿äº†åŒæ—¶æ‹¿åˆ°é”å’Œcpuä¹±åºè¿™ä¸¤ä¸ªé—®é¢˜" class="admonition info">
<summary class="admonition-title">
<p>é€šè¿‡ä½¿ç”¨ compare_exchange+Ordering ï¼Œè§„é¿äº†åŒæ—¶æ‹¿åˆ°é”å’ŒCPUä¹±åºè¿™ä¸¤ä¸ªé—®é¢˜</p>
<p><a class="admonition-anchor-link" href="#admonition-é€šè¿‡ä½¿ç”¨-compare_exchangeordering-è§„é¿äº†åŒæ—¶æ‹¿åˆ°é”å’Œcpuä¹±åºè¿™ä¸¤ä¸ªé—®é¢˜"></a></p>
</summary>
<div>
<ul>
<li>ä¹‹å‰ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin
while *self.locked.borrow() != false {} // **1
<span class="boring">}
</span></code></pre></pre>
<ul>
<li>ä½¿ç”¨compare_exchange</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin
while self
.locked
.compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)
.is_err()
{} // **1
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<h3 id="ä¸´ç•ŒåŒºä¼˜åŒ–"><a class="header" href="#ä¸´ç•ŒåŒºä¼˜åŒ–">ä¸´ç•ŒåŒºä¼˜åŒ–</a></h3>
<details id="admonition-å…¶å®ä¸Šé¢è·å–é”çš„-spin-è¿‡ç¨‹æ€§èƒ½ä¸å¤Ÿå¥½æ›´å¥½çš„æ–¹å¼æ˜¯è¿™æ ·å¤„ç†ä¸€ä¸‹" class="admonition info">
<summary class="admonition-title">
<p>å…¶å®ä¸Šé¢è·å–é”çš„ spin è¿‡ç¨‹æ€§èƒ½ä¸å¤Ÿå¥½ï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯è¿™æ ·å¤„ç†ä¸€ä¸‹ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-å…¶å®ä¸Šé¢è·å–é”çš„-spin-è¿‡ç¨‹æ€§èƒ½ä¸å¤Ÿå¥½æ›´å¥½çš„æ–¹å¼æ˜¯è¿™æ ·å¤„ç†ä¸€ä¸‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
while self
    .locked
    .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)
    .is_err()
{
    // æ€§èƒ½ä¼˜åŒ–ï¼šcompare_exchange éœ€è¦ç‹¬å è®¿é—®ï¼Œå½“æ‹¿ä¸åˆ°é”æ—¶ï¼Œæˆ‘ä»¬
    // å…ˆä¸åœæ£€æµ‹ locked çš„çŠ¶æ€ï¼Œç›´åˆ°å…¶ unlocked åï¼Œå†å°è¯•æ‹¿é”
    while self.locked.load(Ordering::Relaxed) == true {}
}
</code></pre></pre>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ while loop é‡Œï¼ŒåˆåµŒå…¥äº†ä¸€ä¸ª loopã€‚</p>
<ol>
<li>è¿™æ˜¯å› ä¸º CAS æ˜¯ä¸ªä»£ä»·æ¯”è¾ƒé«˜çš„æ“ä½œï¼Œå®ƒéœ€è¦è·å¾—å¯¹åº”å†…å­˜çš„ç‹¬å è®¿é—®ï¼ˆexclusive accessï¼‰</li>
<li>æˆ‘ä»¬å¸Œæœ›å¤±è´¥çš„æ—¶å€™åªæ˜¯ç®€å•è¯»å– atomic çš„çŠ¶æ€ï¼Œåªæœ‰ç¬¦åˆæ¡ä»¶çš„æ—¶å€™å†å»åšç‹¬å è®¿é—®ï¼Œè¿›è¡Œ CASã€‚</li>
<li>æ‰€ä»¥ï¼Œçœ‹ä¸Šå»å¤šåšäº†ä¸€å±‚å¾ªç¯ï¼Œå®é™…ä»£ç çš„æ•ˆç‡æ›´é«˜ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-ä»¥ä¸‹æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ­¥çš„è¿‡ç¨‹ä¸€å¼€å§‹-t1-æ‹¿åˆ°é”t2-spinä¹‹å-t1-é‡Šæ”¾é”t2-è¿›å…¥åˆ°ä¸´ç•ŒåŒºæ‰§è¡Œ" class="admonition info">
<summary class="admonition-title">
<p>ä»¥ä¸‹æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ­¥çš„è¿‡ç¨‹ï¼Œä¸€å¼€å§‹ t1 æ‹¿åˆ°é”ã€t2 spinï¼Œä¹‹å t1 é‡Šæ”¾é”ã€t2 è¿›å…¥åˆ°ä¸´ç•ŒåŒºæ‰§è¡Œï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-ä»¥ä¸‹æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ­¥çš„è¿‡ç¨‹ä¸€å¼€å§‹-t1-æ‹¿åˆ°é”t2-spinä¹‹å-t1-é‡Šæ”¾é”t2-è¿›å…¥åˆ°ä¸´ç•ŒåŒºæ‰§è¡Œ"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/33%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F-4950274.jpg" alt="33ï½œå¹¶å‘å¤„ç†ï¼ˆä¸Šï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
</div>
</details>
<blockquote>
<p>è®²åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¯¹ atomic ä»¥åŠå…¶èƒŒåçš„ CAS æœ‰åˆæ­¥çš„äº†è§£äº†ã€‚</p>
</blockquote>
<h2 id="atomicè¿˜æœ‰ä»€ä¹ˆç”¨"><a class="header" href="#atomicè¿˜æœ‰ä»€ä¹ˆç”¨">Atomicè¿˜æœ‰ä»€ä¹ˆç”¨</a></h2>
<details id="admonition-1-å…¨å±€idç”Ÿæˆå™¨" class="admonition info">
<summary class="admonition-title">
<ol>
<li>å…¨å±€IDç”Ÿæˆå™¨</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-1-å…¨å±€idç”Ÿæˆå™¨"></a></p>
</summary>
<div>
<p>é‚£ä¹ˆï¼Œatomic é™¤äº†åšå…¶å®ƒå¹¶å‘åŸè¯­ï¼Œè¿˜æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p>
<p>æˆ‘ä¸ªäººç”¨çš„æœ€å¤šçš„æ˜¯åšå„ç§ lock-free çš„æ•°æ®ç»“æ„ã€‚æ¯”å¦‚ï¼Œéœ€è¦ä¸€ä¸ªå…¨å±€çš„ ID ç”Ÿæˆå™¨ã€‚å½“ç„¶å¯ä»¥ä½¿ç”¨ UUID è¿™æ ·çš„æ¨¡å—æ¥ç”Ÿæˆå”¯ä¸€çš„ IDï¼Œä½†å¦‚æœæˆ‘ä»¬åŒæ—¶éœ€è¦è¿™ä¸ª ID æ˜¯æœ‰åºçš„ï¼Œé‚£ä¹ˆ AtomicUsize å°±æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</p>
<p>ä½ å¯ä»¥ç”¨ fetch_add æ¥å¢åŠ è¿™ä¸ª IDï¼Œè€Œ fetch_add è¿”å›çš„ç»“æœå°±å¯ä»¥ç”¨äºå½“å‰çš„ IDã€‚è¿™æ ·ï¼Œä¸éœ€è¦åŠ é”ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸­å®‰å…¨ä½¿ç”¨çš„ ID ç”Ÿæˆå™¨ã€‚</p>
</div>
</details>
<details id="admonition-2-è®°å½•ç³»ç»Ÿçš„å„ç§-metrics" class="admonition info">
<summary class="admonition-title">
<ol start="2">
<li>è®°å½•ç³»ç»Ÿçš„å„ç§ metrics</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-è®°å½•ç³»ç»Ÿçš„å„ç§-metrics"></a></p>
</summary>
<div>
<p>å¦å¤–ï¼Œatomic è¿˜å¯ä»¥ç”¨äºè®°å½•ç³»ç»Ÿçš„å„ç§ metricsã€‚æ¯”å¦‚ä¸€ä¸ªç®€å•çš„ in-memory Metrics æ¨¡å—ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{
    collections::HashMap,
    sync::atomic::{AtomicUsize, Ordering},
};

// server statistics
pub struct Metrics(HashMap&lt;&amp;'static str, AtomicUsize&gt;);

impl Metrics {
    pub fn new(names: &amp;[&amp;'static str]) -&gt; Self {
        let mut metrics: HashMap&lt;&amp;'static str, AtomicUsize&gt; = HashMap::new();
        for name in names.iter() {
            metrics.insert(name, AtomicUsize::new(0));
        }
        Self(metrics)
    }

    pub fn inc(&amp;self, name: &amp;'static str) {
        if let Some(m) = self.0.get(name) {
            m.fetch_add(1, Ordering::Relaxed);
        }
    }

    pub fn add(&amp;self, name: &amp;'static str, val: usize) {
        if let Some(m) = self.0.get(name) {
            m.fetch_add(val, Ordering::Relaxed);
        }
    }

    pub fn dec(&amp;self, name: &amp;'static str) {
        if let Some(m) = self.0.get(name) {
            m.fetch_sub(1, Ordering::Relaxed);
        }
    }

    pub fn snapshot(&amp;self) -&gt; Vec&lt;(&amp;'static str, usize)&gt; {
        self.0
            .iter()
            .map(|(k, v)| (*k, v.load(Ordering::Relaxed)))
            .collect()
    }
}
</code></pre></pre>
<p>å®ƒå…è®¸ä½ åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€çš„ metrics è¡¨ï¼Œç„¶ååœ¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹ï¼Œæ— é”åœ°æ“ä½œç›¸åº”çš„ metricsï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use lazy_static::lazy_static;
use std::{
    collections::HashMap,
    sync::atomic::{AtomicUsize, Ordering},
};

lazy_static! {
    pub(crate) static ref METRICS: Metrics = Metrics::new(&amp;[
        &quot;topics&quot;,
        &quot;clients&quot;,
        &quot;peers&quot;,
        &quot;broadcasts&quot;,
        &quot;servers&quot;,
        &quot;states&quot;,
        &quot;subscribers&quot;
    ]);
}

// server statistics
pub struct Metrics(HashMap&lt;&amp;'static str, AtomicUsize&gt;);

impl Metrics {
    pub fn new(names: &amp;[&amp;'static str]) -&gt; Self {
        let mut metrics: HashMap&lt;&amp;'static str, AtomicUsize&gt; = HashMap::new();
        for name in names.iter() {
            metrics.insert(name, AtomicUsize::new(0));
        }
        Self(metrics)
    }

    pub fn inc(&amp;self, name: &amp;'static str) {
        if let Some(m) = self.0.get(name) {
            m.fetch_add(1, Ordering::Relaxed);
        }
    }

    pub fn add(&amp;self, name: &amp;'static str, val: usize) {
        if let Some(m) = self.0.get(name) {
            m.fetch_add(val, Ordering::Relaxed);
        }
    }

    pub fn dec(&amp;self, name: &amp;'static str) {
        if let Some(m) = self.0.get(name) {
            m.fetch_sub(1, Ordering::Relaxed);
        }
    }

    pub fn snapshot(&amp;self) -&gt; Vec&lt;(&amp;'static str, usize)&gt; {
        self.0
            .iter()
            .map(|(k, v)| (*k, v.load(Ordering::Relaxed)))
            .collect()
    }
}

fn main() {
    METRICS.inc(&quot;topics&quot;);
    METRICS.inc(&quot;subscribers&quot;);

    println!(&quot;{:?}&quot;, METRICS.snapshot());
}

</code></pre></pre>
</div>
</details>
<h2 id="æ›´é«˜å±‚é¢çš„atomic-mutexmutual-exclusive"><a class="header" href="#æ›´é«˜å±‚é¢çš„atomic-mutexmutual-exclusive">æ›´é«˜å±‚é¢çš„Atomic: Mutex(Mutual Exclusive)</a></h2>
<p>Atomic è™½ç„¶å¯ä»¥å¤„ç†è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹åŠ é”çš„éœ€æ±‚ï¼Œä½†æ¯•ç«Ÿç”¨èµ·æ¥ä¸é‚£ä¹ˆæ–¹ä¾¿.</p>
<blockquote>
<p>æˆ‘ä»¬éœ€è¦æ›´é«˜å±‚çš„å¹¶å‘åŸè¯­ï¼Œæ¥ä¿è¯è½¯ä»¶ç³»ç»Ÿæ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå…±äº«èµ„æºçš„è®¿é—®:</p>
</blockquote>
<p>ä½¿å¾—æ¯ä¸ªçº¿ç¨‹åœ¨è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ï¼Œå¯ä»¥ç‹¬å æˆ–è€…è¯´äº’æ–¥è®¿é—®ï¼ˆmutual exclusive accessï¼‰ã€‚</p>
<details id="admonition-atomicæœ‰ä»€ä¹ˆé™åˆ¶mutexåˆå¦‚ä½•è§£å†³" class="admonition info">
<summary class="admonition-title">
<p>Atomicæœ‰ä»€ä¹ˆé™åˆ¶ï¼ŒMutexåˆå¦‚ä½•è§£å†³ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-atomicæœ‰ä»€ä¹ˆé™åˆ¶mutexåˆå¦‚ä½•è§£å†³"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬çŸ¥é“:</p>
<ol>
<li>å¯¹äºä¸€ä¸ªå…±äº«èµ„æºï¼Œå¦‚æœæ‰€æœ‰çº¿ç¨‹åªåšè¯»æ“ä½œï¼Œé‚£ä¹ˆæ— éœ€äº’æ–¥ï¼Œå¤§å®¶éšæ—¶å¯ä»¥è®¿é—®</li>
</ol>
<ul>
<li>å¾ˆå¤š immutable languageï¼ˆå¦‚ Erlang / Elixirï¼‰åšäº†è¯­è¨€å±‚é¢çš„åªè¯»ä¿è¯ï¼Œç¡®ä¿äº†å¹¶å‘ç¯å¢ƒä¸‹çš„æ— é”æ“ä½œã€‚</li>
<li>è¿™ç‰ºç‰²äº†ä¸€äº›æ•ˆç‡ï¼ˆå¸¸è§çš„ list/hashmap éœ€è¦ä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>ï¼‰ï¼Œé¢å¤–åšäº†ä¸å°‘å†…å­˜æ‹·è´ï¼Œæ¢æ¥äº†å¹¶å‘æ§åˆ¶ä¸‹çš„ç®€å•è½»çµã€‚</li>
</ul>
<ol start="2">
<li>ç„¶è€Œï¼Œä¸€æ—¦æœ‰ä»»ä½•ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è¦ä¿®æ”¹å…±äº«èµ„æºï¼Œä¸ä½†å†™è€…ä¹‹é—´è¦äº’æ–¥ï¼Œè¯»å†™ä¹‹é—´ä¹Ÿéœ€è¦äº’æ–¥ã€‚</li>
</ol>
<ul>
<li>æ¯•ç«Ÿå¦‚æœè¯»å†™ä¹‹é—´ä¸äº’æ–¥çš„è¯ï¼Œè¯»è€…è½»åˆ™è¯»åˆ°è„æ•°æ®ï¼Œé‡åˆ™ä¼šè¯»åˆ°å·²ç»è¢«ç ´åçš„æ•°æ®ï¼Œå¯¼è‡´ crashã€‚</li>
<li>æ¯”å¦‚è¯»è€…è¯»åˆ°é“¾è¡¨é‡Œçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå†™è€…æ°å·§æŠŠè¿™ä¸ªèŠ‚ç‚¹çš„å†…å­˜é‡Šæ”¾æ‰äº†ï¼Œå¦‚æœä¸åšäº’æ–¥è®¿é—®ï¼Œç³»ç»Ÿä¸€å®šä¼šå´©æºƒã€‚</li>
</ul>
<blockquote>
<p>æ‰€ä»¥æ“ä½œç³»ç»Ÿæä¾›äº†ç”¨æ¥è§£å†³è¿™ç§è¯»å†™äº’æ–¥é—®é¢˜çš„åŸºæœ¬å·¥å…·ï¼šMutexï¼ˆRwLock æˆ‘ä»¬æ”¾ä¸‹ä¸è¡¨ï¼‰ã€‚</p>
</blockquote>
<p>å…¶å®ä¸Šæ–‡ä¸­ï¼Œä¸ºäº†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ atomicï¼Œæˆ‘ä»¬åˆ¶ä½œäº†ä¸€ä¸ªéå¸¸ç²—ç³™ç®€å•çš„ SpinLockï¼Œå°±å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå¹¿ä¹‰çš„ Mutexã€‚SpinLockï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯çº¿ç¨‹é€šè¿‡ CPU ç©ºè½¬ï¼ˆspinï¼Œå°±åƒå‰é¢çš„ while loopï¼‰å¿™ç­‰ï¼ˆbusy waitï¼‰ï¼Œæ¥ç­‰å¾…æŸä¸ªä¸´ç•ŒåŒºå¯ç”¨çš„ä¸€ç§é”ã€‚</p>
<blockquote>
<p>ç„¶è€Œï¼Œè¿™ç§é€šè¿‡ SpinLock åšäº’æ–¥çš„å®ç°æ–¹å¼æœ‰ä½¿ç”¨åœºæ™¯çš„é™åˆ¶ï¼šå¦‚æœå—ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¤ªå¤§ï¼Œé‚£ä¹ˆæ•´ä½“çš„æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ï¼Œ CPU å¿™ç­‰ï¼Œæµªè´¹èµ„æºè¿˜ä¸å¹²å®äº‹ï¼Œä¸é€‚åˆä½œä¸ºä¸€ç§é€šç”¨çš„å¤„ç†æ–¹æ³•ã€‚</p>
</blockquote>
<p>æ›´é€šç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š</p>
<ol>
<li>å½“å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ª Mutex æ—¶ï¼Œè·å¾—é”çš„çº¿ç¨‹å¾—åˆ°ä¸´ç•ŒåŒºçš„è®¿é—®ï¼Œå…¶å®ƒçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œæ”¾å…¥è¯¥ Mutex ä¸Šçš„ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é‡Œ</li>
<li>å½“è·å¾—é”çš„çº¿ç¨‹å®Œæˆå·¥ä½œï¼Œé€€å‡ºä¸´ç•ŒåŒºæ—¶ï¼ŒMutex ä¼šç»™ç­‰å¾…é˜Ÿåˆ—å‘ä¸€ä¸ªä¿¡å·ï¼ŒæŠŠé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªçº¿ç¨‹å”¤é†’ï¼Œäºæ˜¯è¿™ä¸ªçº¿ç¨‹å¯ä»¥è¿›è¡Œåç»­çš„è®¿é—®ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/33%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F.jpg" alt="33ï½œå¹¶å‘å¤„ç†ï¼ˆä¸Šï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
</div>
</details>
<h2 id="atomicå’Œmutexçš„è”ç³»"><a class="header" href="#atomicå’Œmutexçš„è”ç³»">Atomicå’ŒMutexçš„è”ç³»</a></h2>
<details id="admonition-atomicmutexsemaphoreçš„è”ç³»" class="admonition info">
<summary class="admonition-title">
<p>Atomicã€Mutexã€semaphoreçš„è”ç³»</p>
<p><a class="admonition-anchor-link" href="#admonition-atomicmutexsemaphoreçš„è”ç³»"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬å‰é¢ä¹Ÿè®²è¿‡ï¼Œçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä»£ä»·å¾ˆå¤§ï¼Œæ‰€ä»¥é¢‘ç¹å°†çº¿ç¨‹æŒ‚èµ·å†å”¤é†’ï¼Œä¼šé™ä½æ•´ä¸ªç³»ç»Ÿçš„æ•ˆç‡ã€‚</p>
<blockquote>
<p>æ‰€ä»¥å¾ˆå¤š Mutex å…·ä½“çš„å®ç°ä¼šå°† SpinLockï¼ˆç¡®åˆ‡åœ°è¯´æ˜¯ spin waitï¼‰å’Œçº¿ç¨‹æŒ‚èµ·ç»“åˆä½¿ç”¨ï¼š
çº¿ç¨‹çš„ lock è¯·æ±‚å¦‚æœæ‹¿ä¸åˆ°ä¼šå…ˆå°è¯• spin ä¸€ä¼šï¼Œç„¶åå†æŒ‚èµ·æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚</p>
</blockquote>
<p>Rust ä¸‹çš„ <a href="https://github.com/Amanieu/parking_lot">parking_lot </a>å°±æ˜¯è¿™æ ·å®ç°çš„ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™æ ·å®ç°ä¼šå¸¦æ¥å…¬å¹³æ€§çš„é—®é¢˜ï¼š</p>
<ol>
<li>å¦‚æœæ–°æ¥çš„çº¿ç¨‹æ°å·§åœ¨ spin è¿‡ç¨‹ä¸­æ‹¿åˆ°äº†é”</li>
<li>è€Œå½“å‰ç­‰å¾…é˜Ÿåˆ—ä¸­è¿˜æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ç­‰å¾…é”</li>
<li>é‚£ä¹ˆç­‰å¾…çš„çº¿ç¨‹åªèƒ½ç»§ç»­ç­‰å¾…ä¸‹å»</li>
<li>è¿™ä¸ç¬¦åˆ FIFOï¼Œä¸é€‚åˆé‚£äº›éœ€è¦ä¸¥æ ¼æŒ‰å…ˆæ¥ååˆ°æ’é˜Ÿçš„ä½¿ç”¨åœºæ™¯ã€‚</li>
<li>ä¸ºæ­¤ï¼Œparking_lot æä¾›äº† fair mutexã€‚</li>
</ol>
<p>Mutex çš„å®ç°ä¾èµ–äº CPU æä¾›çš„ atomicã€‚</p>
<blockquote>
<p>ä½ å¯ä»¥æŠŠ Mutex æƒ³è±¡æˆä¸€ä¸ªç²’åº¦æ›´å¤§çš„ atomicï¼Œåªä¸è¿‡è¿™ä¸ª atomic æ— æ³•ç”± CPU ä¿è¯ï¼Œè€Œæ˜¯é€šè¿‡è½¯ä»¶ç®—æ³•æ¥å®ç°ã€‚</p>
</blockquote>
<blockquote>
<p>ä¸¤ä¸ªåŸºæœ¬çš„å¹¶å‘åŸè¯­ Atomic å’Œ Mutex:</p>
</blockquote>
<ul>
<li>Atomic æ˜¯ä¸€åˆ‡å¹¶å‘åŒæ­¥çš„åŸºç¡€</li>
<li>é€šè¿‡ CPU æä¾›ç‰¹æ®Šçš„ CAS æŒ‡ä»¤ï¼Œæ“ä½œç³»ç»Ÿå’Œåº”ç”¨è½¯ä»¶å¯ä»¥æ„å»ºæ›´åŠ é«˜å±‚çš„å¹¶å‘åŸè¯­ï¼Œæ¯”å¦‚ SpinLock å’Œ Mutexã€‚</li>
</ul>
<blockquote>
<p>SpinLock å’Œ Mutex æœ€å¤§çš„ä¸åŒæ˜¯:</p>
</blockquote>
<ul>
<li>ä½¿ç”¨ SpinLockï¼Œçº¿ç¨‹åœ¨å¿™ç­‰ï¼ˆbusy waitï¼‰</li>
<li>è€Œä½¿ç”¨ Mutex lockï¼Œçº¿ç¨‹åœ¨ç­‰å¾…é”çš„æ—¶å€™ä¼šè¢«è°ƒåº¦å‡ºå»ï¼Œç­‰é”å¯ç”¨æ—¶å†è¢«è°ƒåº¦å›æ¥ã€‚</li>
</ul>
<blockquote>
<p>å¬ä¸Šå» SpinLock ä¼¼ä¹æ•ˆç‡å¾ˆä½ï¼Œå…¶å®ä¸æ˜¯ï¼Œè¿™è¦å…·ä½“çœ‹é”çš„ä¸´ç•ŒåŒºå¤§å°ã€‚</p>
</blockquote>
<ul>
<li>å¦‚æœä¸´ç•ŒåŒºè¦æ‰§è¡Œçš„ä»£ç å¾ˆå°‘ï¼Œé‚£ä¹ˆå’Œ Mutex lock å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆcontext switchï¼‰ç›¸æ¯”ï¼ŒSpinLock æ˜¯å€¼å¾—çš„ã€‚</li>
<li>åœ¨ Linux Kernel ä¸­ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬åªèƒ½ä½¿ç”¨ SpinLockã€‚</li>
</ul>
<blockquote>
<p>è‡³äºæ“ä½œç³»ç»Ÿé‡Œå¦ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µä¿¡å·é‡ï¼ˆsemaphoreï¼‰ï¼Œä½ å¯ä»¥è®¤ä¸ºæ˜¯ Mutex æ›´é€šç”¨çš„è¡¨ç°å½¢å¼ã€‚</p>
</blockquote>
<p>æ¯”å¦‚åœ¨æ–°å† ç–«æƒ…ä¸‹ï¼Œå›¾ä¹¦é¦†è¦æ§åˆ¶åŒæ—¶åœ¨é¦†å†…çš„äººæ•°ï¼Œå¦‚æœæ»¡äº†ï¼Œå…¶ä»–äººå°±å¿…é¡»æ’é˜Ÿï¼Œå‡ºæ¥ä¸€ä¸ªæ‰èƒ½å†è¿›ä¸€ä¸ªã€‚
è¿™é‡Œï¼Œå¦‚æœæ€»äººæ•°é™åˆ¶ä¸º 1ï¼Œå°±æ˜¯ Mutexï¼Œå¦‚æœ &gt; 1ï¼Œå°±æ˜¯ semaphoreã€‚</p>
</div>
</details>
<h1 id="å·¥ä½œæ¨¡å¼ä¸‰é™åˆ¶ä¾èµ–å¹¶å‘dag-æ¨¡å¼"><a class="header" href="#å·¥ä½œæ¨¡å¼ä¸‰é™åˆ¶ä¾èµ–å¹¶å‘dag-æ¨¡å¼">å·¥ä½œæ¨¡å¼ä¸‰ã€é™åˆ¶ä¾èµ–å¹¶å‘ï¼šDAG æ¨¡å¼</a></h1>
<h2 id="atomicå’Œmutexä¸èƒ½è§£å†³dagæ¨¡å¼-æ‰€ä»¥æœ‰condvar"><a class="header" href="#atomicå’Œmutexä¸èƒ½è§£å†³dagæ¨¡å¼-æ‰€ä»¥æœ‰condvar">Atomicå’ŒMutexä¸èƒ½è§£å†³DAGæ¨¡å¼, æ‰€ä»¥æœ‰Condvar</a></h2>
<details id="admonition-atomicå’Œmutexä¸»è¦ç”¨äºå“ªç§å·¥ä½œæ¨¡å¼åŸºäºä»€ä¹ˆéœ€æ±‚æå‡ºcondvaråŸè¯­" class="admonition info">
<summary class="admonition-title">
<p>Atomicå’ŒMutexä¸»è¦ç”¨äºå“ªç§å·¥ä½œæ¨¡å¼ï¼ŸåŸºäºä»€ä¹ˆéœ€æ±‚æå‡ºCondvaråŸè¯­ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-atomicå’Œmutexä¸»è¦ç”¨äºå“ªç§å·¥ä½œæ¨¡å¼åŸºäºä»€ä¹ˆéœ€æ±‚æå‡ºcondvaråŸè¯­"></a></p>
</summary>
<div>
<p>å¯¹äºå¹¶å‘çŠ¶æ€ä¸‹è¿™ä¸‰ç§å¸¸è§çš„å·¥ä½œæ¨¡å¼ï¼š</p>
<ul>
<li>è‡ªç”±ç«äº‰æ¨¡å¼</li>
<li>map/reduce æ¨¡å¼</li>
<li>DAG æ¨¡å¼</li>
</ul>
<p>æˆ‘ä»¬çš„éš¾ç‚¹æ˜¯å¦‚ä½•åœ¨è¿™äº›å¹¶å‘çš„ä»»åŠ¡ä¸­è¿›è¡ŒåŒæ­¥:</p>
<ul>
<li>atomic / Mutex è§£å†³äº†è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹å¹¶å‘ä»»åŠ¡çš„åŒæ­¥é—®é¢˜</li>
<li>ä¹Ÿèƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³ map/reduce æ¨¡å¼ä¸‹çš„åŒæ­¥é—®é¢˜ï¼Œå› ä¸ºæ­¤æ—¶åŒæ­¥åªå‘ç”Ÿåœ¨ map å’Œ reduce ä¸¤ä¸ªé˜¶æ®µã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/34%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F-4951814.jpg" alt="34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
<blockquote>
<p>ç„¶è€Œï¼Œå®ƒä»¬æ²¡æœ‰è§£å†³ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ DAG æ¨¡å¼ï¼šå¦‚æœè¿™ç§è®¿é—®éœ€è¦æŒ‰ç…§ä¸€å®šé¡ºåºè¿›è¡Œæˆ–è€…å‰åæœ‰ä¾èµ–å…³ç³»ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ</p>
</blockquote>
<p>è¿™ä¸ªé—®é¢˜çš„å…¸å‹åœºæ™¯æ˜¯ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å¼ï¼š</p>
<ol>
<li>ç”Ÿäº§è€…ç”Ÿäº§å‡ºæ¥å†…å®¹åï¼Œéœ€è¦æœ‰æœºåˆ¶é€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ã€‚</li>
<li>æ¯”å¦‚ socket ä¸Šæœ‰æ•°æ®äº†ï¼Œé€šçŸ¥å¤„ç†çº¿ç¨‹æ¥å¤„ç†æ•°æ®ï¼Œå¤„ç†å®Œæˆä¹‹åï¼Œå†é€šçŸ¥ socket æ”¶å‘çš„çº¿ç¨‹å‘é€æ•°æ®ã€‚</li>
</ol>
<blockquote>
<p>æ‰€ä»¥ï¼Œæ“ä½œç³»ç»Ÿè¿˜æä¾›äº† Condvarã€‚</p>
</blockquote>
</div>
</details>
<h2 id="condvarä»‹ç»ä¸ä½¿ç”¨"><a class="header" href="#condvarä»‹ç»ä¸ä½¿ç”¨">condvarä»‹ç»ä¸ä½¿ç”¨</a></h2>
<details id="admonition-condvarä»‹ç»ä¸ä½¿ç”¨" class="admonition info">
<summary class="admonition-title">
<p>Condvarä»‹ç»ä¸ä½¿ç”¨</p>
<p><a class="admonition-anchor-link" href="#admonition-condvarä»‹ç»ä¸ä½¿ç”¨"></a></p>
</summary>
<div>
<p>Condvar æœ‰ä¸¤ç§çŠ¶æ€ï¼š</p>
<ol>
<li>ç­‰å¾…ï¼ˆwaitï¼‰ï¼šçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶ã€‚</li>
<li>é€šçŸ¥ï¼ˆnotifyï¼‰ï¼šå½“ condvar çš„æ¡ä»¶æ»¡è¶³æ—¶ï¼Œå½“å‰çº¿ç¨‹é€šçŸ¥å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥è¢«å”¤é†’ã€‚é€šçŸ¥å¯ä»¥æ˜¯å•ä¸ªé€šçŸ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªé€šçŸ¥ï¼Œç”šè‡³å¹¿æ’­ï¼ˆé€šçŸ¥æ‰€æœ‰äººï¼‰ã€‚</li>
</ol>
<p>åœ¨å®è·µä¸­ï¼ŒCondvar å¾€å¾€å’Œ Mutex ä¸€èµ·ä½¿ç”¨ï¼š</p>
<ul>
<li>Mutex ç”¨äºä¿è¯æ¡ä»¶åœ¨è¯»å†™æ—¶äº’æ–¥</li>
<li>Condvar ç”¨äºæ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::sync::{Arc, Condvar, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    let pair = Arc::new((Mutex::new(false), Condvar::new()));
    let pair2 = Arc::clone(&amp;pair);

    thread::spawn(move || {
        let (lock, cvar) = &amp;*pair2;
        let mut started = lock.lock().unwrap();
        *started = true;
        eprintln!(&quot;I'm a happy worker!&quot;);
        // é€šçŸ¥ä¸»çº¿ç¨‹
        cvar.notify_one();
        loop {
            thread::sleep(Duration::from_secs(1));
            println!(&quot;working...&quot;);
        }
    });

    let (lock, cvar) = &amp;*pair;
    // ä½¿ç”¨äº’æ–¥é”ä½œä¸ºå˜é‡
    let mut started = lock.lock().unwrap();
    while !*started {
        // ç­‰å¾…å·¥ä½œçº¿ç¨‹çš„é€šçŸ¥
        started = cvar.wait(started).unwrap();
    }
    eprintln!(&quot;Worker started!&quot;);
}
</code></pre></pre>
<ol>
<li>
<p>è¿™æ®µä»£ç é€šè¿‡ condvarï¼Œæˆ‘ä»¬å®ç°äº† worker çº¿ç¨‹åœ¨æ‰§è¡Œåˆ°ä¸€å®šé˜¶æ®µåé€šçŸ¥ä¸»çº¿ç¨‹ï¼Œç„¶åä¸»çº¿ç¨‹å†åšä¸€äº›äº‹æƒ…ã€‚</p>
</li>
<li>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª Mutex ä½œä¸ºäº’æ–¥æ¡ä»¶ï¼Œç„¶ååœ¨ <a href="https://doc.rust-lang.org/src/std/sync/condvar.rs.html#184-191">cvar.wait() </a>ä¸­ä¼ å…¥è¿™ä¸ª Mutexã€‚</p>
</li>
</ol>
<p>è¿™ä¸ªæ¥å£éœ€è¦ä¸€ä¸ª MutexGuardï¼Œä»¥ä¾¿äºçŸ¥é“éœ€è¦å”¤é†’å“ªä¸ª Mutex ä¸‹ç­‰å¾…çš„çº¿ç¨‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn wait&lt;'a, T&gt;(
    &amp;self,
    guard: MutexGuard&lt;'a, T&gt;
) -&gt; LockResult&lt;MutexGuard&lt;'a, T&gt;&gt;
</code></pre></pre>
</div>
</details>
<h2 id="å¤æ‚dagæ¨¡å¼channel-or-actor"><a class="header" href="#å¤æ‚dagæ¨¡å¼channel-or-actor">å¤æ‚DAGæ¨¡å¼ï¼šChannel or Actor</a></h2>
<h3 id="channel"><a class="header" href="#channel">Channel</a></h3>
<details id="admonition-mutexå’Œcondvarçš„å±€é™æ€§åœ¨å“ªchannelå¦‚ä½•è§£å†³çš„" class="admonition info">
<summary class="admonition-title">
<p>Mutexå’ŒCondvarçš„å±€é™æ€§åœ¨å“ªï¼ŸChannelå¦‚ä½•è§£å†³çš„ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-mutexå’Œcondvarçš„å±€é™æ€§åœ¨å“ªchannelå¦‚ä½•è§£å†³çš„"></a></p>
</summary>
<div>
<p>ä½†æ˜¯ç”¨ Mutex å’Œ Condvar æ¥å¤„ç†å¤æ‚çš„ DAG å¹¶å‘æ¨¡å¼ä¼šæ¯”è¾ƒåƒåŠ›ã€‚æ‰€ä»¥ï¼ŒRust è¿˜æä¾›äº†å„ç§å„æ ·çš„ Channel ç”¨äºå¤„ç†å¹¶å‘ä»»åŠ¡ä¹‹é—´çš„é€šè®¯ã€‚</p>
<p>ç”±äº Golang ä¸é—ä½™åŠ›åœ°æ¨å¹¿ï¼ŒChannel å¯èƒ½æ˜¯æœ€å¹¿ä¸ºäººçŸ¥çš„å¹¶å‘æ‰‹æ®µã€‚ç›¸å¯¹äº Mutexï¼ŒChannel çš„æŠ½è±¡ç¨‹åº¦æœ€é«˜ï¼Œæ¥å£æœ€ä¸ºç›´è§‚ï¼Œä½¿ç”¨èµ·æ¥çš„å¿ƒç†è´Ÿæ‹…ä¹Ÿæ²¡é‚£ä¹ˆå¤§ã€‚ä½¿ç”¨ Mutex æ—¶ï¼Œä½ éœ€è¦å¾ˆå°å¿ƒåœ°é¿å…æ­»é”ï¼Œæ§åˆ¶ä¸´ç•ŒåŒºçš„å¤§å°ï¼Œé˜²æ­¢ä¸€åˆ‡å¯èƒ½å‘ç”Ÿçš„æ„å¤–ã€‚</p>
<blockquote>
<p>è™½ç„¶åœ¨ Rust é‡Œï¼Œæˆ‘ä»¬å¯ä»¥â€œæ— ç•å¹¶å‘â€ï¼ˆFearless concurrencyï¼‰â€”â€” å½“ä»£ç ç¼–è¯‘é€šè¿‡ï¼Œç»å¤§å¤šæ•°å¹¶å‘é—®é¢˜éƒ½å¯ä»¥è§„é¿ï¼Œä½†æ€§èƒ½ä¸Šçš„é—®é¢˜ã€é€»è¾‘ä¸Šçš„æ­»é”è¿˜éœ€è¦å¼€å‘è€…ç…§æ–™ã€‚</p>
</blockquote>
<p>Channel æŠŠé”å°è£…åœ¨äº†é˜Ÿåˆ—å†™å…¥å’Œè¯»å–çš„å°å—åŒºåŸŸå†…ï¼Œç„¶åæŠŠè¯»è€…å’Œå†™è€…å®Œå…¨åˆ†ç¦»ï¼Œä½¿å¾—è¯»è€…è¯»å–æ•°æ®å’Œå†™è€…å†™å…¥æ•°æ®ï¼Œå¯¹å¼€å‘è€…è€Œè¨€ï¼Œé™¤äº†æ½œåœ¨çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¤–ï¼Œå®Œå…¨å’Œé”æ— å…³ï¼Œå°±åƒè®¿é—®ä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—ä¸€æ ·ã€‚æ‰€ä»¥ï¼Œå¯¹äºå¤§éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”¨ Channel æˆ–è€…ç±»ä¼¼çš„æ€æƒ³æ¥å¤„ç†ï¼ˆæ¯”å¦‚ actor modelï¼‰ã€‚</p>
</div>
</details>
<h4 id="channelåˆ†ç±»"><a class="header" href="#channelåˆ†ç±»">Channelåˆ†ç±»</a></h4>
<details id="admonition-channelæ ¹æ®ä½¿ç”¨åœºæ™¯å¦‚ä½•åˆ†ç±»" class="admonition question">
<summary class="admonition-title">
<p>Channelæ ¹æ®ä½¿ç”¨åœºæ™¯å¦‚ä½•åˆ†ç±»ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-channelæ ¹æ®ä½¿ç”¨åœºæ™¯å¦‚ä½•åˆ†ç±»"></a></p>
</summary>
<div>
<p>Channel åœ¨å…·ä½“å®ç°çš„æ—¶å€™ï¼Œæ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œä¼šé€‰æ‹©ä¸åŒçš„å·¥å…·ã€‚Rust æä¾›äº†ä»¥ä¸‹å››ç§ Channelï¼š</p>
<ol>
<li>oneshotï¼šè¿™å¯èƒ½æ˜¯æœ€ç®€å•çš„ Channelï¼Œå†™è€…å°±åªå‘ä¸€æ¬¡æ•°æ®ï¼Œè€Œè¯»è€…ä¹Ÿåªè¯»ä¸€æ¬¡ã€‚</li>
</ol>
<p>è¿™ç§ä¸€æ¬¡æ€§çš„ã€å¤šä¸ªçº¿ç¨‹é—´çš„åŒæ­¥å¯ä»¥ç”¨ oneshot channel å®Œæˆã€‚ç”±äº oneshot ç‰¹æ®Šçš„ç”¨é€”ï¼Œå®ç°çš„æ—¶å€™å¯ä»¥ç›´æ¥ç”¨ atomic swap æ¥å®Œæˆã€‚</p>
<ol start="2">
<li>rendezvousï¼šå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ Channel æ¥æ§åˆ¶çº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå¹¶ä¸éœ€è¦å‘é€æ•°æ®ã€‚</li>
</ol>
<p>rendezvous channel æ˜¯ channel size ä¸º 0 çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</p>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ Mutex + Condvar å®ç°å°±è¶³å¤Ÿäº†ï¼Œåœ¨å…·ä½“å®ç°ä¸­ï¼Œrendezvous channel å…¶å®ä¹Ÿå°±æ˜¯ Mutex + Condvar çš„ä¸€ä¸ªåŒ…è£…ã€‚</p>
<ol start="3">
<li>boundedï¼šbounded channel æœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†é˜Ÿåˆ—æœ‰ä¸Šé™ã€‚</li>
</ol>
<p>ä¸€æ—¦é˜Ÿåˆ—è¢«å†™æ»¡äº†ï¼Œå†™è€…ä¹Ÿéœ€è¦è¢«æŒ‚èµ·ç­‰å¾…ã€‚å½“é˜»å¡å‘ç”Ÿåï¼Œè¯»è€…ä¸€æ—¦è¯»å–æ•°æ®ï¼Œchannel å†…éƒ¨å°±ä¼šä½¿ç”¨ Condvar çš„ notify_one é€šçŸ¥å†™è€…ï¼Œå”¤é†’æŸä¸ªå†™è€…ä½¿å…¶èƒ½å¤Ÿç»§ç»­å†™å…¥ã€‚</p>
<p>å› æ­¤ï¼Œå®ç°ä¸­ï¼Œä¸€èˆ¬ä¼šç”¨åˆ° Mutex + Condvar + VecDeque æ¥å®ç°ï¼›å¦‚æœä¸ç”¨ Condvarï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ thread::park + thread::notify æ¥å®Œæˆï¼ˆflume çš„åšæ³•ï¼‰ï¼›å¦‚æœä¸ç”¨ VecDequeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒå‘é“¾è¡¨æˆ–è€…å…¶å®ƒçš„ ring buffer çš„å®ç°ã€‚</p>
<ol start="4">
<li>unboundedï¼šqueue æ²¡æœ‰ä¸Šé™ï¼Œå¦‚æœå†™æ»¡äº†ï¼Œå°±è‡ªåŠ¨æ‰©å®¹ã€‚
æˆ‘ä»¬çŸ¥é“ï¼ŒRust çš„å¾ˆå¤šæ•°æ®ç»“æ„å¦‚ Vec ã€VecDeque éƒ½æ˜¯è‡ªåŠ¨æ‰©å®¹çš„ã€‚unbounded å’Œ bounded ç›¸æ¯”ï¼Œé™¤äº†ä¸é˜»å¡å†™è€…ï¼Œå…¶å®ƒå®ç°éƒ½å¾ˆç±»ä¼¼ã€‚</li>
</ol>
<blockquote>
<p>æ‰€æœ‰è¿™äº› channel ç±»å‹ï¼ŒåŒæ­¥å’Œå¼‚æ­¥çš„å®ç°æ€è·¯å¤§åŒå°å¼‚ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºæŒ‚èµ· / å”¤é†’çš„å¯¹è±¡ï¼š</p>
</blockquote>
<ul>
<li>åœ¨åŒæ­¥çš„ä¸–ç•Œé‡Œï¼ŒæŒ‚èµ· / å”¤é†’çš„å¯¹è±¡æ˜¯çº¿ç¨‹ï¼›</li>
<li>è€Œå¼‚æ­¥çš„ä¸–ç•Œé‡Œï¼Œæ˜¯ç²’åº¦å¾ˆå°çš„ taskã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/34%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F-4951803.jpg" alt="34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
</div>
</details>
<details id="admonition-channelæ ¹æ®è¯»å†™è€…æ•°é‡åˆ†åˆ«å¦‚ä½•åˆ†ç±»" class="admonition info">
<summary class="admonition-title">
<p>Channelæ ¹æ®è¯»å†™è€…æ•°é‡åˆ†åˆ«å¦‚ä½•åˆ†ç±»ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-channelæ ¹æ®è¯»å†™è€…æ•°é‡åˆ†åˆ«å¦‚ä½•åˆ†ç±»"></a></p>
</summary>
<div>
<p>æ ¹æ® Channel è¯»è€…å’Œå†™è€…çš„æ•°é‡ï¼ŒChannel åˆå¯ä»¥åˆ†ä¸ºï¼š</p>
<ul>
<li>
<p>SPSCï¼šSingle-Producer Single-Consumer
å•ç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚æœ€ç®€å•ï¼Œå¯ä»¥ä¸ä¾èµ–äº Mutexï¼Œåªç”¨ atomics å°±å¯ä»¥å®ç°ã€‚</p>
</li>
<li>
<p>SPMCï¼šSingle-Producer Multi-Consumer
å•ç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨æ¶ˆè´¹è€…è¿™ä¾§è¯»å–æ—¶åŠ é”ã€‚</p>
</li>
<li>
<p>MPSCï¼šMulti-Producer Single-Consumer
å¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…è¿™ä¾§å†™å…¥æ—¶åŠ é”ã€‚</p>
</li>
<li>
<p>MPMCï¼šMulti-Producer Multi-Consumer
å¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…å†™å…¥æˆ–è€…æ¶ˆè´¹è€…è¯»å–æ—¶åŠ é”ã€‚</p>
</li>
</ul>
<blockquote>
<p>åœ¨ä¼—å¤š Channel ç±»å‹ä¸­ï¼Œä½¿ç”¨æœ€å¹¿çš„æ˜¯ MPSC channel, å› ä¸ºå¾€å¾€æˆ‘ä»¬å¸Œæœ›é€šè¿‡å•æ¶ˆè´¹è€…æ¥ä¿è¯ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯çš„æ•°æ®ç»“æ„æœ‰ç‹¬å çš„å†™è®¿é—®ã€‚</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/34%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F.jpg" alt="34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
<p>æ¯”å¦‚ï¼Œ<a href="https://github.com/tyrchen/xunmi/blob/master/src/indexer.rs#L50">åœ¨ xunmi çš„å®ç°ä¸­</a>: </p>
<ol>
<li>index writer å†…éƒ¨æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹çš„å®ç°</li>
<li>ä½†åœ¨ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å®ƒçš„å¯å†™å¼•ç”¨ã€‚</li>
</ol>
<p>å¦‚æœè¦èƒ½å¤Ÿåœ¨å„ç§ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ index writerï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸å°†å…¶ç”¨ Arc&lt;Mutex<T>&gt; åŒ…è£¹èµ·æ¥.</p>
<p>ä½†è¿™æ ·åœ¨ç´¢å¼•å¤§é‡æ•°æ®æ—¶æ•ˆç‡å¤ªä½</p>
</div>
</details>
<details id="admonition-mpsc-channelä½¿ç”¨ç¤ºä¾‹index-writer" class="admonition info">
<summary class="admonition-title">
<p>MPSC channelä½¿ç”¨ç¤ºä¾‹ï¼šindex writer</p>
<p><a class="admonition-anchor-link" href="#admonition-mpsc-channelä½¿ç”¨ç¤ºä¾‹index-writer"></a></p>
</summary>
<div>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ MPSC channelï¼Œè®©å„ç§ä¸Šä¸‹æ–‡éƒ½æŠŠæ•°æ®å‘é€ç»™å•ä¸€çš„çº¿ç¨‹ï¼Œä½¿ç”¨ index writer ç´¢å¼•ï¼Œè¿™æ ·å°±é¿å…äº†é”ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct IndexInner {
    index: Index,
    reader: IndexReader,
    config: IndexConfig,
    updater: Sender&lt;Input&gt;,
}

pub struct IndexUpdater {
    sender: Sender&lt;Input&gt;,
    t2s: bool,
    schema: Schema,
}

impl Indexer {
    // æ‰“å¼€æˆ–è€…åˆ›å»ºä¸€ä¸ª index
    pub fn open_or_create(config: IndexConfig) -&gt; Result&lt;Self&gt; {
        let schema = config.schema.clone();
        let index = if let Some(dir) = &amp;config.path {
            fs::create_dir_all(dir)?;
            let dir = MmapDirectory::open(dir)?;
            Index::open_or_create(dir, schema.clone())?
        } else {
            Index::create_in_ram(schema.clone())
        };

        Self::set_tokenizer(&amp;index, &amp;config);

        let mut writer = index.writer(config.writer_memory)?;

        // åˆ›å»ºä¸€ä¸ª unbounded MPSC channel
        let (s, r) = unbounded::&lt;Input&gt;();

        // å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä» channel çš„ reader ä¸­è¯»å–æ•°æ®
        thread::spawn(move || {
            for input in r {
                // ç„¶åç”¨ index writer å¤„ç†è¿™ä¸ª input
                if let Err(e) = input.process(&amp;mut writer, &amp;schema) {
                    warn!(&quot;Failed to process input. Error: {:?}&quot;, e);
                }
            }
        });

        // æŠŠ channel çš„ sender éƒ¨åˆ†å­˜å…¥ IndexInner ç»“æ„
        Self::new(index, config, s)
    }

    pub fn get_updater(&amp;self) -&gt; IndexUpdater {
        let t2s = TextLanguage::Chinese(true) == self.config.text_lang;
        // IndexUpdater å†…éƒ¨åŒ…å« channel çš„ sender éƒ¨åˆ†
        // ç”±äºæ˜¯ MPSC channelï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç®€å• clone ä¸€ä¸‹ sender
        // è¿™ä¹Ÿæ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä»»æ„å¤šä¸ª IndexUpdater åœ¨ä¸åŒä¸Šä¸‹æ–‡å‘é€æ•°æ®
        // è€Œæ•°æ®æœ€ç»ˆéƒ½ä¼šé€šè¿‡ channel ç»™åˆ°ä¸Šé¢åˆ›å»ºçš„çº¿ç¨‹ï¼Œç”± index writer å¤„ç†
        IndexUpdater::new(self.updater.clone(), self.index.schema(), t2s)
    }
}
</code></pre></pre>
</div>
</details>
<h3 id="actor"><a class="header" href="#actor">Actor</a></h3>
<details id="admonition-ç®€å•ä»‹ç»actorå¹¶ä¸¾ä¾‹" class="admonition info">
<summary class="admonition-title">
<p>ç®€å•ä»‹ç»Actorï¼Œå¹¶ä¸¾ä¾‹</p>
<p><a class="admonition-anchor-link" href="#admonition-ç®€å•ä»‹ç»actorå¹¶ä¸¾ä¾‹"></a></p>
</summary>
<div>
<p>æœ€åæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ <a href="https://en.wikipedia.org/wiki/Actor_model">actor model</a>ï¼Œå®ƒåœ¨ä¸šç•Œä¸»è¦çš„ä½¿ç”¨è€…æ˜¯ Erlang VM ä»¥åŠ <a href="https://akka.io/">akka</a>ã€‚actor æ˜¯ä¸€ç§æœ‰æ ˆåç¨‹:</p>
<ol>
<li>æ¯ä¸ª actorï¼Œæœ‰è‡ªå·±çš„ä¸€ä¸ªç‹¬ç«‹çš„ã€è½»é‡çº§çš„è°ƒç”¨æ ˆ</li>
<li>ä»¥åŠä¸€ä¸ªç”¨æ¥æ¥å—æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆmailbox æˆ–è€… message queueï¼‰</li>
<li>å¤–ç•Œè·Ÿ actor æ‰“äº¤é“çš„å”¯ä¸€æ‰‹æ®µå°±æ˜¯ï¼Œç»™å®ƒå‘é€æ¶ˆæ¯ã€‚</li>
</ol>
<p>Rust æ ‡å‡†åº“æ²¡æœ‰ actor çš„å®ç°ï¼Œä½†æ˜¯ç¤¾åŒºé‡Œæœ‰æ¯”è¾ƒæˆç†Ÿçš„ <a href="https://github.com/actix/actix">actix</a>ï¼ˆå¤§åé¼é¼çš„ actix-web å°±æ˜¯åŸºäº actix å®ç°çš„ï¼‰ï¼Œä»¥åŠ <a href="https://github.com/bastion-rs/bastion">bastion</a>ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç ç”¨ actix å®ç°äº†ä¸€ä¸ªç®€å•çš„ DummyActorï¼Œå®ƒå¯ä»¥æ¥æ”¶ä¸€ä¸ª InMsgï¼Œè¿”å›ä¸€ä¸ª OutMsgï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use actix::prelude::*;
use anyhow::Result;

// actor å¯ä»¥å¤„ç†çš„æ¶ˆæ¯
#[derive(Message, Debug, Clone, PartialEq)]
#[rtype(result = &quot;OutMsg&quot;)]
enum InMsg {
    Add((usize, usize)),
    Concat((String, String)),
}

#[derive(MessageResponse, Debug, Clone, PartialEq)]
enum OutMsg {
    Num(usize),
    Str(String),
}

// Actor
struct DummyActor;

impl Actor for DummyActor {
    type Context = Context&lt;Self&gt;;
}

// å®ç°å¤„ç† InMsg çš„ Handler trait
impl Handler&lt;InMsg&gt; for DummyActor {
    type Result = OutMsg; // &lt;-  è¿”å›çš„æ¶ˆæ¯

    fn handle(&amp;mut self, msg: InMsg, _ctx: &amp;mut Self::Context) -&gt; Self::Result {
        match msg {
            InMsg::Add((a, b)) =&gt; OutMsg::Num(a + b),
            InMsg::Concat((mut s1, s2)) =&gt; {
                s1.push_str(&amp;s2);
                OutMsg::Str(s1)
            }
        }
    }
}

#[actix::main]
async fn main() -&gt; Result&lt;()&gt; {
    let addr = DummyActor.start();
    let res = addr.send(InMsg::Add((21, 21))).await?;
    let res1 = addr
        .send(InMsg::Concat((&quot;hello, &quot;.into(), &quot;world&quot;.into())))
        .await?;

    println!(&quot;res: {:?}, res1: {:?}&quot;, res, res1);

    Ok(())
}
</code></pre></pre>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹ DummyActorï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° Actor trait å’Œ Handler<InMsg> trait ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="channelactorå¯¹æ¯”ä¸è”ç³»"><a class="header" href="#channelactorå¯¹æ¯”ä¸è”ç³»">Channel/Actorå¯¹æ¯”ä¸è”ç³»</a></h3>
<ul>
<li><a href="https://homepages.inf.ed.ac.uk/slindley/papers/acca.pdf">Mixing Metaphors: Actors as Channels and Channels as Actors</a><a href="x-devonthink-item://E0179117-18AC-4BBC-B1B0-B0A96895F745">dté“¾æ¥</a></li>
<li><a href="https://cstheory.stackexchange.com/questions/184/whats-the-difference-between-the-actor-model-of-concurrency-and-communicating-s">Whatâ€™s the difference between the Actor Model of Concurrency and Communicating Sequential Processes - Theoretical Computer Science Stack Exchange</a></li>
<li>Rustçš„å¼‚æ­¥ç¼–ç¨‹ä¸»è¦ä½¿ç”¨asyncæ¨¡å‹ï¼š
<a href="https://rust-lang.github.io/async-book/01_getting_started/02_why_async.html#async-vs-other-concurrency-models">Why Async? - Asynchronous Programming in Rust</a></li>
</ul>
<h1 id="è‡³äºasyncawaitåˆæ˜¯å¦ä¸€ä¸ªæ•…äº‹"><a class="header" href="#è‡³äºasyncawaitåˆæ˜¯å¦ä¸€ä¸ªæ•…äº‹">è‡³äºasync/awaitï¼Œåˆæ˜¯å¦ä¸€ä¸ªæ•…äº‹</a></h1>
<ul>
<li><a href="https://www.zhihu.com/question/65647171">async/awaitå¼‚æ­¥æ¨¡å‹æ˜¯å¦ä¼˜äºstackful coroutineæ¨¡å‹ï¼Ÿ - çŸ¥ä¹</a></li>
<li><a href="https://code2life.top/2021/05/31/0062-concurrent-model-async-programming/">ç™½è¯å¹¶å‘æ¨¡å‹å’Œå¼‚æ­¥ç¼–ç¨‹èŒƒå¼ Â· Joeyâ€™s Tech Notes &amp; Blogs</a></li>
</ul>
<h1 id="è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„mpsc-channel"><a class="header" href="#è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„mpsc-channel">è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC Channel</a></h1>
<p>ä¹‹å‰æˆ‘ä»¬è°ˆè®ºäº†å¦‚ä½•åœ¨æœç´¢å¼•æ“çš„ Index writer ä¸Šä½¿ç”¨ MPSC channelï¼š</p>
<ol>
<li>è¦æ›´æ–° index çš„ä¸Šä¸‹æ–‡æœ‰å¾ˆå¤šï¼ˆå¯ä»¥æ˜¯çº¿ç¨‹ä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼‰</li>
<li>è€Œ IndexWriter åªèƒ½æ˜¯å”¯ä¸€çš„ã€‚</li>
<li>ä¸ºäº†é¿å…åœ¨è®¿é—® IndexWriter æ—¶åŠ é”ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MPSC channel</li>
<li>åœ¨å¤šä¸ªä¸Šä¸‹æ–‡ä¸­ç»™ channel å‘æ¶ˆæ¯ï¼Œç„¶ååœ¨å”¯ä¸€æ‹¥æœ‰ IndexWriter çš„çº¿ç¨‹ä¸­è¯»å–è¿™äº›æ¶ˆæ¯ï¼Œéå¸¸é«˜æ•ˆã€‚</li>
</ol>
<p>å¥½ï¼Œæ¥çœ‹çœ‹ä»Šå¤©è¦å®ç°çš„ MPSC channel çš„åŸºæœ¬åŠŸèƒ½ã€‚ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œæˆ‘ä»¬åªå…³å¿ƒ unbounded MPSC
channelã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“é˜Ÿåˆ—å®¹é‡ä¸å¤Ÿæ—¶ï¼Œä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæ‰€ä»¥ï¼Œä»»ä½•æ—¶å€™ç”Ÿäº§è€…å†™å…¥æ•°æ®éƒ½ä¸ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œæ¶ˆè´¹è€…ä¼šè¢«é˜»å¡ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/35%EF%BD%9C%E5%AE%9E%E6%93%8D%E9%A1%B9%E7%9B%AE%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%9F%BA%E6%9C%AC%E7%9A%84MPSC%20channel%EF%BC%9F.jpg" alt="35ï½œå®æ“é¡¹ç›®ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC channelï¼Ÿ" /></p>
<h2 id="æµ‹è¯•é©±åŠ¨çš„è®¾è®¡"><a class="header" href="#æµ‹è¯•é©±åŠ¨çš„è®¾è®¡">æµ‹è¯•é©±åŠ¨çš„è®¾è®¡</a></h2>
<p>ä¹‹å‰æˆ‘ä»¬ä¼šä»éœ€æ±‚çš„è§’åº¦æ¥è®¾è®¡æ¥å£å’Œæ•°æ®ç»“æ„ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¢ç§æ–¹å¼ï¼Œå®Œå…¨ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦ï¼Œç”¨ä½¿ç”¨å®ä¾‹ï¼ˆæµ‹è¯•ï¼‰æ¥é©±åŠ¨æ¥å£å’Œæ•°æ®ç»“æ„çš„è®¾è®¡ã€‚</p>
<details id="admonition-éœ€æ±‚1-åŸºæœ¬çš„-sendrecv" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚1: åŸºæœ¬çš„ send/recv</p>
<p><a class="admonition-anchor-link" href="#admonition-éœ€æ±‚1-åŸºæœ¬çš„-sendrecv"></a></p>
</summary>
<div>
<p>è¦å®ç°åˆšæ‰è¯´çš„ MPSC channelï¼Œéƒ½æœ‰ä»€ä¹ˆéœ€æ±‚å‘¢ï¼Ÿé¦–å…ˆï¼Œç”Ÿäº§è€…å¯ä»¥äº§ç”Ÿæ•°æ®ï¼Œæ¶ˆè´¹è€…èƒ½å¤Ÿæ¶ˆè´¹äº§ç”Ÿå‡ºæ¥çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯åŸºæœ¬çš„ send/recvï¼Œæˆ‘ä»¬ä»¥ä¸‹é¢è¿™ä¸ªå•å…ƒæµ‹è¯• 1 æ¥æè¿°è¿™ä¸ªéœ€æ±‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn channel_should_work() {
    let (mut s, mut r) = unbounded();
    s.send(&quot;hello world!&quot;.to_string()).unwrap();
    let msg = r.recv().unwrap();
    assert_eq!(msg, &quot;hello world!&quot;);
}
</code></pre></pre>
<ol>
<li>è¿™é‡Œï¼Œé€šè¿‡ unbounded() æ–¹æ³•ï¼Œ å¯ä»¥åˆ›å»ºä¸€ä¸ª sender å’Œä¸€ä¸ª receiver</li>
<li>sender æœ‰ send() æ–¹æ³•ï¼Œå¯ä»¥å‘é€æ•°æ®</li>
<li>receiver æœ‰ recv() æ–¹æ³•ï¼Œå¯ä»¥æ¥å—æ•°æ®ã€‚</li>
<li>æ•´ä½“çš„æ¥å£ï¼Œæˆ‘ä»¬è®¾è®¡å’Œ std::sync::mpsc ä¿æŒä¸€è‡´ï¼Œé¿å…ä½¿ç”¨è€…ä½¿ç”¨ä¸Šçš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</li>
</ol>
<p>ä¸ºäº†å®ç°è¿™æ ·ä¸€ä¸ªæ¥å£ï¼Œéœ€è¦ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å‘¢ï¼Ÿ</p>
<ol>
<li>é¦–å…ˆï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¼šå…±äº«ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨ VecDequeã€‚</li>
<li>æ˜¾ç„¶ï¼Œè¿™ä¸ªé˜Ÿåˆ—åœ¨æ’å…¥å’Œå–å‡ºæ•°æ®æ—¶éœ€è¦äº’æ–¥ï¼Œæ‰€ä»¥éœ€è¦ç”¨ Mutex æ¥ä¿æŠ¤å®ƒã€‚</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
}

pub struct Sender&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}

pub struct Receiver&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}
</code></pre></pre>
<p>è¿™æ ·çš„æ•°æ®ç»“æ„åº”è¯¥å¯ä»¥æ»¡è¶³å•å…ƒæµ‹è¯• 1ã€‚</p>
</div>
</details>
<details id="admonition-éœ€æ±‚2-å…è®¸å¤šä¸ª-sender-å¾€-channel-é‡Œå‘é€æ•°æ®" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚2: å…è®¸å¤šä¸ª sender å¾€ channel é‡Œå‘é€æ•°æ® </p>
<p><a class="admonition-anchor-link" href="#admonition-éœ€æ±‚2-å…è®¸å¤šä¸ª-sender-å¾€-channel-é‡Œå‘é€æ•°æ®"></a></p>
</summary>
<div>
<p>ç”±äºéœ€è¦çš„æ˜¯ MPSCï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å…è®¸å¤šä¸ª sender å¾€ channel é‡Œå‘é€æ•°æ®ï¼Œç”¨å•å…ƒæµ‹è¯• 2 æ¥æè¿°è¿™ä¸ªéœ€æ±‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn multiple_senders_should_work() {
    let (mut s, mut r) = unbounded();
    let mut s1 = s.clone();
    let mut s2 = s.clone();
    let t = thread::spawn(move || {
        s.send(1).unwrap();
    });
    let t1 = thread::spawn(move || {
        s1.send(2).unwrap();
    });
    let t2 = thread::spawn(move || {
        s2.send(3).unwrap();
    });
    for handle in [t, t1, t2] {
        handle.join().unwrap();
    }

    let mut result = [r.recv().unwrap(), r.recv().unwrap(), r.recv().unwrap()];
    // åœ¨è¿™ä¸ªæµ‹è¯•é‡Œï¼Œæ•°æ®åˆ°è¾¾çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ’ä¸ªåºå† assert
    result.sort();

    assert_eq!(result, [1, 2, 3]);
}
</code></pre></pre>
<p>è¿™ä¸ªéœ€æ±‚ï¼Œåˆšæ‰çš„æ•°æ®ç»“æ„å°±å¯ä»¥æ»¡è¶³ï¼Œåªæ˜¯ Sender éœ€è¦å®ç° Clone traitã€‚ä¸è¿‡æˆ‘ä»¬åœ¨å†™è¿™ä¸ªæµ‹è¯•çš„æ—¶å€™ç¨å¾®æœ‰äº›åˆ«æ‰­ï¼Œå› ä¸ºè¿™ä¸€è¡Œæœ‰ä¸æ–­é‡å¤çš„ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let mut result = [r.recv().unwrap(), r.recv().unwrap(), r.recv().unwrap()];
</code></pre></pre>
<p>æ³¨æ„ï¼Œæµ‹è¯•ä»£ç çš„ DRY ä¹Ÿå¾ˆé‡è¦ï¼Œæˆ‘ä»¬ä¹‹å‰å¼ºè°ƒè¿‡ã€‚æ‰€ä»¥ï¼Œå½“å†™ä¸‹è¿™ä¸ªæµ‹è¯•çš„æ—¶å€™ï¼Œä¹Ÿè®¸ä¼šæƒ³ï¼Œæˆ‘ä»¬å¯å¦æä¾› Iterator çš„å®ç°ï¼Ÿæ©è¿™ä¸ªæƒ³æ³•å…ˆæš‚å­˜ä¸‹æ¥ã€‚</p>
</div>
</details>
<details id="admonition-éœ€æ±‚3-å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™receiver-æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚3: å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™ï¼Œreceiver æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡</p>
<p><a class="admonition-anchor-link" href="#admonition-éœ€æ±‚3-å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™receiver-æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡"></a></p>
</summary>
<div>
<p>æ¥ä¸‹æ¥è€ƒè™‘å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™ï¼Œreceiver æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡è¿™ä¸ªéœ€æ±‚ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•å¯¹è¿™ä¸ªéœ€æ±‚è¿›è¡Œæµ‹è¯•å‘¢ï¼Ÿè¿™å¹¶ä¸ç®€å•ï¼Œæˆ‘ä»¬æ²¡æœ‰æ¯”è¾ƒç›´è§‚çš„æ–¹å¼æ¥æ£€æµ‹çº¿ç¨‹çš„çŠ¶æ€ã€‚</p>
<p>ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æµ‹â€œçº¿ç¨‹æ˜¯å¦é€€å‡ºâ€æ¥é—´æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«é˜»å¡ã€‚</p>
<p>ç†ç”±å¾ˆç®€å•:</p>
<ol>
<li>å¦‚æœçº¿ç¨‹æ²¡æœ‰ç»§ç»­å·¥ä½œï¼Œåˆæ²¡æœ‰é€€å‡ºï¼Œé‚£ä¹ˆä¸€å®šè¢«é˜»å¡ä½äº†ã€‚</li>
<li>é˜»å¡ä½ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­å‘é€æ•°æ®ï¼Œæ¶ˆè´¹è€…æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­å·¥ä½œ</li>
<li>æ‰€ä»¥æœ€ç»ˆé˜Ÿåˆ—é•¿åº¦åº”è¯¥ä¸º 0ã€‚æˆ‘ä»¬çœ‹å•å…ƒæµ‹è¯• 3ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn receiver_should_be_blocked_when_nothing_to_read() {
    let (mut s, r) = unbounded();
    let mut s1 = s.clone();
    thread::spawn(move || {
        for (idx, i) in r.into_iter().enumerate() {
            // å¦‚æœè¯»åˆ°æ•°æ®ï¼Œç¡®ä¿å®ƒå’Œå‘é€çš„æ•°æ®ä¸€è‡´
            assert_eq!(idx, i);
        }
        // è¯»ä¸åˆ°åº”è¯¥ä¼‘çœ ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€å¥ï¼Œæ‰§è¡Œåˆ°è¿™ä¸€å¥è¯´æ˜é€»è¾‘å‡ºé”™
        assert!(false);
    });

    thread::spawn(move || {
        for i in 0..100usize {
            s.send(i).unwrap();
        }
    });

    // 1ms è¶³å¤Ÿè®©ç”Ÿäº§è€…å‘å®Œ 100 ä¸ªæ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹å®Œ 100 ä¸ªæ¶ˆæ¯å¹¶é˜»å¡
    thread::sleep(Duration::from_millis(1));

    // å†æ¬¡å‘é€æ•°æ®ï¼Œå”¤é†’æ¶ˆè´¹è€…
    for i in 100..200usize {
        s1.send(i).unwrap();
    }

    // ç•™ç‚¹æ—¶é—´è®© receiver å¤„ç†
    thread::sleep(Duration::from_millis(1));

    // å¦‚æœ receiver è¢«æ­£å¸¸å”¤é†’å¤„ç†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—é‡Œçš„æ•°æ®ä¼šéƒ½è¢«è¯»å®Œ
    assert_eq!(s1.total_queued_items(), 0);
}
</code></pre></pre>
<p>è¿™ä¸ªæµ‹è¯•ä»£ç ä¸­:</p>
<ol>
<li>æˆ‘ä»¬å‡å®š receiver å®ç°äº† Iterator</li>
<li>è¿˜å‡å®š sender æä¾›äº†ä¸€ä¸ªæ–¹æ³• total_queued_items()ã€‚è¿™äº›å¯ä»¥åœ¨å®ç°çš„æ—¶å€™å†å¤„ç†ã€‚</li>
</ol>
<p>ä½ å¯ä»¥èŠ±äº›æ—¶é—´ä»”ç»†çœ‹çœ‹è¿™æ®µä»£ç ï¼Œæƒ³æƒ³å…¶ä¸­çš„å¤„ç†é€»è¾‘ã€‚è™½ç„¶ä»£ç å¾ˆç®€å•ï¼Œä¸éš¾ç†è§£ï¼Œä½†æ˜¯æŠŠä¸€ä¸ªå®Œæ•´çš„éœ€æ±‚è½¬åŒ–æˆåˆé€‚çš„æµ‹è¯•ä»£ç ï¼Œè¿˜æ˜¯è¦é¢‡è´¹äº›å¿ƒæ€çš„ã€‚</p>
<p>å¥½ï¼Œå¦‚æœè¦èƒ½æ”¯æŒé˜Ÿåˆ—ä¸ºç©ºæ—¶é˜»å¡ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Condvarã€‚</p>
<p>æ‰€ä»¥ Shared<T> éœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
}
</code></pre></pre>
<p>è¿™æ ·å½“å®ç° Receiver çš„ recv() æ–¹æ³•åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯»ä¸åˆ°æ•°æ®æ—¶é˜»å¡çº¿ç¨‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
// æ‹¿åˆ°é”
let mut inner = self.shared.queue.lock().unwrap();
// ... å‡è®¾è¯»ä¸åˆ°æ•°æ®
// ä½¿ç”¨ condvar å’Œ MutexGuard é˜»å¡å½“å‰çº¿ç¨‹
self.shared.available.wait(inner)
</code></pre></pre>
</div>
</details>
<details id="admonition-éœ€æ±‚4-receiveræ²¡æœ‰æ•°æ®å¯è¯»" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚4: Receiveræ²¡æœ‰æ•°æ®å¯è¯»</p>
<p><a class="admonition-anchor-link" href="#admonition-éœ€æ±‚4-receiveræ²¡æœ‰æ•°æ®å¯è¯»"></a></p>
</summary>
<div>
<p>é¡ºç€åˆšæ‰çš„å¤šä¸ª sender æƒ³ï¼Œå¦‚æœç°åœ¨æ‰€æœ‰ Sender éƒ½é€€å‡ºä½œç”¨åŸŸï¼ŒReceiver ç»§ç»­æ¥æ”¶ï¼Œåˆ°æ²¡æœ‰æ•°æ®å¯è¯»äº†ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿæ˜¯ä¸æ˜¯åº”è¯¥äº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼Œè®©è°ƒç”¨è€…çŸ¥é“ï¼Œç°åœ¨ channel çš„å¦ä¸€ä¾§å·²ç»æ²¡æœ‰ç”Ÿäº§è€…äº†ï¼Œå†è¯»ä¹Ÿè¯»ä¸å‡ºæ•°æ®äº†ï¼Ÿ</p>
<p>æˆ‘ä»¬æ¥å†™å•å…ƒæµ‹è¯• 4ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn last_sender_drop_should_error_when_receive() {
    let (s, mut r) = unbounded();
    let s1 = s.clone();
    let senders = [s, s1];
    let total = senders.len();

    // sender å³ç”¨å³æŠ›
    for mut sender in senders {
        thread::spawn(move || {
            sender.send(&quot;hello&quot;).unwrap();
            // sender åœ¨æ­¤è¢«ä¸¢å¼ƒ
        })
        .join()
        .unwrap();
    }

    // è™½ç„¶æ²¡æœ‰ sender äº†ï¼Œæ¥æ”¶è€…ä¾ç„¶å¯ä»¥æ¥å—å·²ç»åœ¨é˜Ÿåˆ—é‡Œçš„æ•°æ®
    for _ in 0..total {
        r.recv().unwrap();
    }

    // ç„¶è€Œï¼Œè¯»å–æ›´å¤šæ•°æ®æ—¶ä¼šå‡ºé”™
    assert!(r.recv().is_err());
}
</code></pre></pre>
<p>è¿™ä¸ªæµ‹è¯•ä¾æ—§å¾ˆç®€å•ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œä½¿ç”¨ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å¯ä»¥è¾¾åˆ°è¿™æ ·çš„ç›®çš„:</p>
<ol>
<li>é¦–å…ˆï¼Œæ¯æ¬¡ Clone æ—¶ï¼Œè¦å¢åŠ  Sender çš„è®¡æ•°ï¼›</li>
<li>åœ¨ Sender Drop æ—¶ï¼Œå‡å°‘è¿™ä¸ªè®¡æ•°ï¼›</li>
<li>ç„¶åï¼Œæˆ‘ä»¬ä¸º Receiver æä¾›ä¸€ä¸ªæ–¹æ³• total_senders()ï¼Œæ¥è¯»å– Sender çš„è®¡æ•°</li>
<li>å½“è®¡æ•°ä¸º 0ï¼Œä¸”é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œrecv() æ–¹æ³•å°±æŠ¥é”™ã€‚</li>
</ol>
<blockquote>
<p>æœ‰äº†è¿™ä¸ªæ€è·¯ï¼Œä½ æƒ³ä¸€æƒ³ï¼Œè¿™ä¸ªè®¡æ•°å™¨ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿç”¨é”ä¿æŠ¤ä¹ˆï¼Ÿ</p>
</blockquote>
<p>å“ˆï¼Œä½ ä¸€å®šæƒ³åˆ°äº†å¯ä»¥ä½¿ç”¨ atomicsã€‚å¯¹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ AtomicUsizeã€‚æ‰€ä»¥ï¼ŒShared æ•°æ®ç»“æ„éœ€è¦æ›´æ–°ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
    senders: AtomicUsize,
}
</code></pre></pre>
</div>
</details>
<details id="admonition-éœ€æ±‚5-æ²¡æœ‰receiverå¤„ç†æ•°æ®" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚5: æ²¡æœ‰Receiverå¤„ç†æ•°æ®</p>
<p><a class="admonition-anchor-link" href="#admonition-éœ€æ±‚5-æ²¡æœ‰receiverå¤„ç†æ•°æ®"></a></p>
</summary>
<div>
<p>æ—¢ç„¶æ²¡æœ‰ Sender äº†è¦æŠ¥é”™ï¼Œé‚£ä¹ˆå¦‚æœæ²¡æœ‰ Receiver äº†ï¼ŒSender å‘é€æ—¶æ˜¯ä¸æ˜¯ä¹Ÿåº”è¯¥é”™è¯¯è¿”å›ï¼Ÿè¿™ä¸ªéœ€æ±‚å’Œä¸Šé¢ç±»ä¼¼ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚çœ‹æ„é€ çš„å•å…ƒæµ‹è¯• 5ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn receiver_drop_should_error_when_send() {
    let (mut s1, mut s2) = {
        let (s, _) = unbounded();
        let s1 = s.clone();
        let s2 = s.clone();
        (s1, s2)
    };

    assert!(s1.send(1).is_err());
    assert!(s2.send(1).is_err());
}
</code></pre></pre>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª channelï¼Œäº§ç”Ÿä¸¤ä¸ª Sender åä¾¿ç«‹å³ä¸¢å¼ƒ Receiverã€‚ä¸¤ä¸ª Sender åœ¨å‘é€æ—¶éƒ½ä¼šå‡ºé”™ã€‚</p>
<p>åŒæ ·çš„ï¼ŒShared æ•°æ®ç»“æ„è¦æ›´æ–°ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
    senders: AtomicUsize,
    receivers: AtomicUsize,
}
</code></pre></pre>
</div>
</details>
<h2 id="å®ç°-mpsc-channel"><a class="header" href="#å®ç°-mpsc-channel">å®ç° MPSC channel</a></h2>
<p>ç°åœ¨å†™äº†äº”ä¸ªå•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬å·²ç»æŠŠéœ€æ±‚æ‘¸é€äº†ï¼Œå¹¶ä¸”æœ‰äº†åŸºæœ¬çš„æ¥å£å’Œæ•°æ®ç»“æ„çš„è®¾è®¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å†™å®ç°çš„ä»£ç ã€‚</p>
<details id="admonition-åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®" class="admonition info">
<summary class="admonition-title">
<p>åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®</p>
<p><a class="admonition-anchor-link" href="#admonition-åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®"></a></p>
</summary>
<div>
<pre><code class="language-shell">cargo new con_utils --lib
</code></pre>
<ol>
<li>åœ¨ cargo.toml ä¸­æ·»åŠ  anyhow ä½œä¸ºä¾èµ–ã€‚</li>
<li>åœ¨ lib.rs é‡Œï¼Œæˆ‘ä»¬å°±å†™å…¥ä¸€å¥ï¼špub mod channel , ç„¶ååˆ›å»º src/channel.rs</li>
<li>æŠŠåˆšæ‰è®¾è®¡æ—¶ä½¿ç”¨çš„ test caseã€è®¾è®¡çš„æ•°æ®ç»“æ„ï¼Œä»¥åŠ test case é‡Œä½¿ç”¨åˆ°çš„æ¥å£ï¼Œç”¨ä»£ç å…¨éƒ¨æ”¾è¿›æ¥ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use std::{
    collections::VecDeque,
    sync::{atomic::AtomicUsize, Arc, Condvar, Mutex},
};

/// å‘é€è€…
pub struct Sender&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}

/// æ¥æ”¶è€…
pub struct Receiver&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}

/// å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´å…±äº«ä¸€ä¸ª VecDequeï¼Œç”¨ Mutex äº’æ–¥ï¼Œç”¨ Condvar é€šçŸ¥
/// åŒæ—¶ï¼Œæˆ‘ä»¬è®°å½•æœ‰å¤šå°‘ä¸ª senders å’Œ receivers

struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
    senders: AtomicUsize,
    receivers: AtomicUsize,
}

impl&lt;T&gt; Sender&lt;T&gt; {
    /// ç”Ÿäº§è€…å†™å…¥ä¸€ä¸ªæ•°æ®
    pub fn send(&amp;mut self, t: T) -&gt; Result&lt;()&gt; {
        todo!()
    }

    pub fn total_receivers(&amp;self) -&gt; usize {
        todo!()
    }

    pub fn total_queued_items(&amp;self) -&gt; usize {
        todo!()
    }
}

impl&lt;T&gt; Receiver&lt;T&gt; {
    pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {
        todo!()
    }

    pub fn total_senders(&amp;self) -&gt; usize {
        todo!()
    }
}

impl&lt;T&gt; Iterator for Receiver&lt;T&gt; {
    type Item = T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        todo!()
    }
}

/// å…‹éš† sender
impl&lt;T&gt; Clone for Sender&lt;T&gt; {
    fn clone(&amp;self) -&gt; Self {
        todo!()
    }
}

/// Drop sender
impl&lt;T&gt; Drop for Sender&lt;T&gt; {
    fn drop(&amp;mut self) {
        todo!()
    }
}

impl&lt;T&gt; Drop for Receiver&lt;T&gt; {
    fn drop(&amp;mut self) {
        todo!()
    }
}

/// åˆ›å»ºä¸€ä¸ª unbounded channel
pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    todo!()
}

#[cfg(test)]
mod tests {
    use std::{thread, time::Duration};

    use super::*;
    // æ­¤å¤„çœç•¥æ‰€æœ‰ test case
}
</code></pre></pre>
</div>
</details>
<details id="admonition-å®ç°å•å…ƒæµ‹è¯•ç›¸å…³åŠŸèƒ½" class="admonition info">
<summary class="admonition-title">
<p>å®ç°å•å…ƒæµ‹è¯•ç›¸å…³åŠŸèƒ½</p>
<p><a class="admonition-anchor-link" href="#admonition-å®ç°å•å…ƒæµ‹è¯•ç›¸å…³åŠŸèƒ½"></a></p>
</summary>
<div>
<p>ç›®å‰è¿™ä¸ªä»£ç è™½ç„¶èƒ½å¤Ÿç¼–è¯‘é€šè¿‡ï¼Œä½†å› ä¸ºæ²¡æœ‰ä»»ä½•å®ç°ï¼Œæ‰€ä»¥ cargo test å…¨éƒ¨å‡ºé”™ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ä¸€ç‚¹ç‚¹å®ç°åŠŸèƒ½ã€‚</p>
<ol>
<li>åˆ›å»º unbounded channel</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    let shared = Shared::default();
    let shared = Arc::new(shared);
    (
        Sender {
            shared: shared.clone(),
        },
        Receiver { shared },
    )
}

const INITIAL_SIZE: usize = 32;
impl&lt;T&gt; Default for Shared&lt;T&gt; {
    fn default() -&gt; Self {
        Self {
            queue: Mutex::new(VecDeque::with_capacity(INITIAL_SIZE)),
            available: Condvar::new(),
            senders: AtomicUsize::new(1),
            receivers: AtomicUsize::new(1),
        }
    }
}
</code></pre></pre>
<p>å› ä¸ºè¿™é‡Œä½¿ç”¨ default() åˆ›å»ºäº† Shared<T> ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºå…¶å®ç° Defaultã€‚åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬æœ‰ 1 ä¸ªç”Ÿäº§è€…å’Œ 1 ä¸ªæ¶ˆè´¹è€…ã€‚</p>
<ol start="2">
<li>å®ç°æ¶ˆè´¹è€…</li>
</ol>
<p>å¯¹äºæ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦å®ç° recv æ–¹æ³•ã€‚</p>
<p>åœ¨ recv ä¸­:</p>
<ul>
<li>å¦‚æœé˜Ÿåˆ—ä¸­æœ‰æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼›</li>
<li>å¦‚æœæ²¡æ•°æ®ï¼Œä¸”æ‰€æœ‰ç”Ÿäº§è€…éƒ½ç¦»å¼€äº†ï¼Œæˆ‘ä»¬å°±è¿”å›é”™è¯¯ï¼›</li>
<li>å¦‚æœæ²¡æ•°æ®ï¼Œä½†è¿˜æœ‰ç”Ÿäº§è€…ï¼Œæˆ‘ä»¬å°±é˜»å¡æ¶ˆè´¹è€…çš„çº¿ç¨‹ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Receiver&lt;T&gt; {
    pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {
        // æ‹¿åˆ°é˜Ÿåˆ—çš„é”
        let mut inner = self.shared.queue.lock().unwrap();
        loop {
            match inner.pop_front() {
                // è¯»åˆ°æ•°æ®è¿”å›ï¼Œé”è¢«é‡Šæ”¾
                Some(t) =&gt; {
                    return Ok(t);
                }
                // è¯»ä¸åˆ°æ•°æ®ï¼Œå¹¶ä¸”ç”Ÿäº§è€…éƒ½é€€å‡ºäº†ï¼Œé‡Šæ”¾é”å¹¶è¿”å›é”™è¯¯
                None if self.total_senders() == 0 =&gt; return Err(anyhow!(&quot;no sender left&quot;)),
                // è¯»ä¸åˆ°æ•°æ®ï¼ŒæŠŠé”æäº¤ç»™ available Condvarï¼Œå®ƒä¼šé‡Šæ”¾é”å¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾… notify
                None =&gt; {
                    // å½“ Condvar è¢«å”¤é†’åä¼šè¿”å› MutexGuardï¼Œæˆ‘ä»¬å¯ä»¥ loop å›å»æ‹¿æ•°æ®
                    // è¿™æ˜¯ä¸ºä»€ä¹ˆ Condvar è¦åœ¨ loop é‡Œä½¿ç”¨
                    inner = self
                        .shared
                        .available
                        .wait(inner)
                        .map_err(|_| anyhow!(&quot;lock poisoned&quot;))?;
                }
            }
        }
    }

    pub fn total_senders(&amp;self) -&gt; usize {
        self.shared.senders.load(Ordering::SeqCst)
    }
}
</code></pre></pre>
<p>æ³¨æ„çœ‹è¿™é‡Œ Condvar çš„ä½¿ç”¨ã€‚</p>
<ul>
<li>åœ¨ wait() æ–¹æ³•é‡Œï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª MutexGuardï¼Œç„¶åé‡Šæ”¾è¿™ä¸ª Mutexï¼ŒæŒ‚èµ·çº¿ç¨‹ã€‚</li>
<li>ç­‰å¾—åˆ°é€šçŸ¥åï¼Œå®ƒä¼šå†è·å–é”ï¼Œå¾—åˆ°ä¸€ä¸ª MutexGuardï¼Œè¿”å›ã€‚æ‰€ä»¥è¿™é‡Œæ˜¯ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
inner = self.shared.available.wait(inner).map_err(|_| anyhow!(&quot;lock poisoned&quot;))?;
</code></pre></pre>
<p>å› ä¸º recv() ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥é˜»å¡å›æ¥ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å¾ªç¯å›å»æ‹¿æ•°æ®ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆè¿™æ®µé€»è¾‘è¦è¢« loop {} åŒ…è£¹ã€‚æˆ‘ä»¬å‰é¢åœ¨è®¾è®¡æ—¶è€ƒè™‘è¿‡ï¼šå½“å‘é€è€…å‘é€æ•°æ®æ—¶ï¼Œåº”è¯¥é€šçŸ¥è¢«é˜»å¡çš„æ¶ˆè´¹è€…ã€‚æ‰€ä»¥ï¼Œåœ¨å®ç° Sender çš„ send() æ—¶ï¼Œéœ€è¦åšç›¸åº”çš„ notify å¤„ç†ã€‚</p>
<p>è®°å¾—è¿˜è¦å¤„ç†æ¶ˆè´¹è€…çš„ dropï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Drop for Receiver&lt;T&gt; {
    fn drop(&amp;mut self) {
        self.shared.receivers.fetch_sub(1, Ordering::AcqRel);
    }
}
</code></pre></pre>
<p>å¾ˆç®€å•ï¼Œæ¶ˆè´¹è€…ç¦»å¼€æ—¶ï¼Œå°† receivers å‡ä¸€ã€‚</p>
</div>
</details>
<details id="admonition-å®ç°ç”Ÿäº§è€…åŠŸèƒ½" class="admonition info">
<summary class="admonition-title">
<p>å®ç°ç”Ÿäº§è€…åŠŸèƒ½</p>
<p><a class="admonition-anchor-link" href="#admonition-å®ç°ç”Ÿäº§è€…åŠŸèƒ½"></a></p>
</summary>
<div>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ç”Ÿäº§è€…çš„åŠŸèƒ½æ€ä¹ˆå®ç°ã€‚</p>
<ol>
<li>é¦–å…ˆï¼Œåœ¨æ²¡æœ‰æ¶ˆè´¹è€…çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥æŠ¥é”™ã€‚</li>
<li>æ­£å¸¸åº”è¯¥ä½¿ç”¨ thiserror å®šä¹‰è‡ªå·±çš„é”™è¯¯ï¼Œä¸è¿‡è¿™é‡Œä¸ºäº†ç®€åŒ–ä»£ç ï¼Œå°±ä½¿ç”¨ anyhow! å®äº§ç”Ÿä¸€ä¸ª adhoc çš„é”™è¯¯ã€‚</li>
<li>å¦‚æœæ¶ˆè´¹è€…è¿˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è·å– VecDeque çš„é”ï¼ŒæŠŠæ•°æ®å‹å…¥ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Sender&lt;T&gt; {
    /// ç”Ÿäº§è€…å†™å…¥ä¸€ä¸ªæ•°æ®
    pub fn send(&amp;mut self, t: T) -&gt; Result&lt;()&gt; {
        // å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…äº†ï¼Œå†™å…¥æ—¶å‡ºé”™
        if self.total_receivers() == 0 {
            return Err(anyhow!(&quot;no receiver left&quot;));
        }

        // åŠ é”ï¼Œè®¿é—® VecDequeï¼Œå‹å…¥æ•°æ®ï¼Œç„¶åç«‹åˆ»é‡Šæ”¾é”
        let was_empty = {
            let mut inner = self.shared.queue.lock().unwrap();
            let empty = inner.is_empty();
            inner.push_back(t);
            empty
        };

        // é€šçŸ¥ä»»æ„ä¸€ä¸ªè¢«æŒ‚èµ·ç­‰å¾…çš„æ¶ˆè´¹è€…æœ‰æ•°æ®
        if was_empty {
            self.shared.available.notify_one();
        }

        Ok(())
    }

    pub fn total_receivers(&amp;self) -&gt; usize {
        self.shared.receivers.load(Ordering::SeqCst)
    }

    pub fn total_queued_items(&amp;self) -&gt; usize {
        let queue = self.shared.queue.lock().unwrap();
        queue.len()
    }
}
</code></pre></pre>
<p>è¿™é‡Œï¼Œè·å– total_receivers æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Ordering::SeqCstï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°åŒæ ·é¡ºåºçš„å¯¹ receivers çš„æ“ä½œã€‚è¿™ä¸ªå€¼æ˜¯æœ€æ–°çš„å€¼ã€‚</p>
<p>åœ¨å‹å…¥æ•°æ®æ—¶ï¼Œéœ€è¦åˆ¤æ–­ä¸€ä¸‹ä¹‹å‰æ˜¯é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå› ä¸ºé˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ notify_one() æ¥å”¤é†’æ¶ˆè´¹è€…ã€‚è¿™ä¸ªéå¸¸é‡è¦ï¼Œå¦‚æœæ²¡å¤„ç†çš„è¯ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹è€…é˜»å¡åæ— æ³•å¤åŸæ¥æ”¶æ•°æ®ã€‚</p>
<blockquote>
<p>ç”±äºæˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªç”Ÿäº§è€…ï¼Œæ‰€ä»¥è¦å…è®¸å®ƒ cloneï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Clone for Sender&lt;T&gt; {
    fn clone(&amp;self) -&gt; Self {
        self.shared.senders.fetch_add(1, Ordering::AcqRel);
        Self {
            shared: Arc::clone(&amp;self.shared),
        }
    }
}
</code></pre></pre>
<p>å®ç° Clone trait çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä½†è®°å¾—è¦æŠŠ shared.senders åŠ  1ï¼Œä½¿å…¶ä¿æŒå’Œå½“å‰çš„ senders çš„æ•°é‡ä¸€è‡´ã€‚</p>
<blockquote>
<p>å½“ç„¶ï¼Œåœ¨ drop çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿè¦ç»´æŠ¤ shared.senders ä½¿å…¶å‡ 1ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Drop for Sender&lt;T&gt; {
    fn drop(&amp;mut self) {
        self.shared.senders.fetch_sub(1, Ordering::AcqRel);
        
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-å…¶ä»–åŠŸèƒ½å®ç°" class="admonition info">
<summary class="admonition-title">
<p>å…¶ä»–åŠŸèƒ½å®ç°</p>
<p><a class="admonition-anchor-link" href="#admonition-å…¶ä»–åŠŸèƒ½å®ç°"></a></p>
</summary>
<div>
<p>ç›®å‰è¿˜ç¼ºä¹ Receiver çš„ Iterator çš„å®ç°ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ next() é‡Œè°ƒç”¨ recv() æ–¹æ³•ï¼ŒRust æä¾›äº†æ”¯æŒåœ¨ Option / Result ä¹‹é—´å¾ˆæ–¹ä¾¿è½¬æ¢çš„å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ ok() æ¥å°† Result è½¬æ¢æˆ Optionï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Iterator for Receiver&lt;T&gt; {
    type Item = T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.recv().ok()
    }
}
</code></pre></pre>
<p>å¥½ï¼Œç›®å‰æ‰€æœ‰éœ€è¦å®ç°çš„ä»£ç éƒ½å®ç°å®Œæ¯•ï¼Œ cargo test æµ‹è¯•ä¸€ä¸‹ã€‚wowï¼æµ‹è¯•ä¸€æ¬¡æ€§é€šè¿‡ï¼è¿™ä¹Ÿå¤ªé¡ºåˆ©äº†å§ï¼</p>
<p>æœ€åæ¥ä»”ç»†å®¡è§†ä¸€ä¸‹ä»£ç ã€‚å¾ˆå¿«ï¼Œæˆ‘ä»¬å‘ç° Sender çš„ Drop å®ç°ä¼¼ä¹æœ‰ç‚¹é—®é¢˜ã€‚å¦‚æœ Receiver è¢«é˜»å¡ï¼Œè€Œæ­¤åˆ»æ‰€æœ‰ Sender éƒ½èµ°äº†ï¼Œé‚£ä¹ˆ Receiver å°±æ²¡æœ‰äººå”¤é†’ï¼Œä¼šå¸¦æ¥èµ„æºçš„æ³„éœ²ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆè¾¹è¾¹è§’è§’çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¹‹å‰çš„æµ‹è¯•æ²¡æœ‰è¦†ç›–åˆ°ã€‚</p>
<p>æˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªåœºæ™¯è®©è¿™ä¸ªé—®é¢˜æš´éœ²ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn receiver_shall_be_notified_when_all_senders_exit() {
    let (s, mut r) = unbounded::&lt;usize&gt;();
    // ç”¨äºä¸¤ä¸ªçº¿ç¨‹åŒæ­¥
    let (mut sender, mut receiver) = unbounded::&lt;usize&gt;();
    let t1 = thread::spawn(move || {
        // ä¿è¯ r.recv() å…ˆäº t2 çš„ drop æ‰§è¡Œ
        sender.send(0).unwrap();
        assert!(r.recv().is_err());
    });

    thread::spawn(move || {
        receiver.recv().unwrap();
        drop(s);
    });

    t1.join().unwrap();
}
</code></pre></pre>
<p>åœ¨æˆ‘è¿›ä¸€æ­¥è§£é‡Šä¹‹å‰ï¼Œä½ å¯ä»¥åœä¸‹æ¥æƒ³æƒ³:</p>
<ol>
<li>ä¸ºä»€ä¹ˆè¿™ä¸ªæµ‹è¯•å¯ä»¥ä¿è¯æš´éœ²è¿™ä¸ªé—®é¢˜ï¼Ÿ</li>
<li>å®ƒæ˜¯æ€ä¹ˆæš´éœ²çš„ï¼Ÿ</li>
<li>å¦‚æœæƒ³ä¸åˆ°ï¼Œå† cargo test çœ‹çœ‹ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ã€‚</li>
</ol>
<p>æ¥ä¸€èµ·åˆ†æåˆ†æï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ t1 å’Œ t2ï¼Œåˆ†åˆ«è®©å®ƒä»¬å¤„ç†æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ã€‚t1 è¯»å–æ•°æ®ï¼Œæ­¤æ—¶æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥ä¼šé˜»å¡ï¼Œè€Œ t2 ç›´æ¥æŠŠç”Ÿäº§è€… drop æ‰ã€‚æ‰€ä»¥ï¼Œæ­¤åˆ»å¦‚æœæ²¡æœ‰äººå”¤é†’ t1ï¼Œé‚£ä¹ˆ t1.join() å°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œå› ä¸º t1 ä¸€ç›´æ²¡æœ‰é€€å‡ºã€‚</p>
<blockquote>
<p>æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯ä¸€å®šæ˜¯ t1 r.recv()å…ˆæ‰§è¡Œå¯¼è‡´é˜»å¡ã€t2 å† drop(s)ï¼Œæˆ‘ä»¬ï¼ˆeat your own dog foodï¼‰ç”¨å¦ä¸€ä¸ª channel æ¥æ§åˆ¶ä¸¤ä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºã€‚è¿™æ˜¯ä¸€ç§å¾ˆé€šç”¨çš„åšæ³•ï¼Œä½ å¯ä»¥å¥½å¥½ç¢ç£¨ä¸€ä¸‹ã€‚</p>
</blockquote>
<p>è¿è¡Œ cargo test åï¼Œæµ‹è¯•è¢«é˜»å¡ã€‚è¿™æ˜¯å› ä¸ºï¼Œt1 æ²¡æœ‰æœºä¼šå¾—åˆ°å”¤é†’ï¼Œæ‰€ä»¥è¿™ä¸ªæµ‹è¯•å°±åœåœ¨é‚£é‡Œä¸åŠ¨äº†ã€‚</p>
<p>è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¦¥å–„å¤„ç† Sender çš„ Dropï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Drop for Sender&lt;T&gt; {
    fn drop(&amp;mut self) {
        let old = self.shared.senders.fetch_sub(1, Ordering::AcqRel);
        // sender èµ°å…‰äº†ï¼Œå”¤é†’ receiver è¯»å–æ•°æ®ï¼ˆå¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰çš„è¯ï¼‰ï¼Œè¯»ä¸åˆ°å°±å‡ºé”™
        if old &lt;= 1 {
            // å› ä¸ºæˆ‘ä»¬å®ç°çš„æ˜¯ MPSCï¼Œreceiver åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ notify_all å®é™…ç­‰ä»· notify_one
            self.shared.available.notify_all();
        }
    }
}
</code></pre></pre>
<p>è¿™é‡Œï¼Œå¦‚æœå‡ä¸€ä¹‹å‰ï¼Œæ—§çš„ senders çš„æ•°é‡å°äºç­‰äº 1ï¼Œæ„å‘³ç€ç°åœ¨æ˜¯æœ€åä¸€ä¸ª Sender è¦ç¦»å¼€äº†ï¼Œä¸ç®¡æ€æ ·æˆ‘ä»¬éƒ½è¦å”¤é†’ Receiver ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† notify_all()ã€‚å¦‚æœ Receiver ä¹‹å‰å·²ç»è¢«é˜»å¡ï¼Œæ­¤åˆ»å°±èƒ½è¢«å”¤é†’ã€‚ä¿®æ”¹å®Œæˆï¼Œcargo test ä¸€åˆ‡æ­£å¸¸ã€‚</p>
</div>
</details>
<details id="admonition-å¯¹é”è¿›è¡Œæ€§èƒ½ä¼˜åŒ–" class="admonition info">
<summary class="admonition-title">
<p>å¯¹é”è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</p>
<p><a class="admonition-anchor-link" href="#admonition-å¯¹é”è¿›è¡Œæ€§èƒ½ä¼˜åŒ–"></a></p>
</summary>
<div>
<p>ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œç›®å‰æˆ‘ä»¬çš„ MPSC unbounded channel æ²¡æœ‰å¤ªå¤šçš„é—®é¢˜ï¼Œå¯ä»¥åº”ç”¨åœ¨ä»»ä½•éœ€è¦ MPSC channel çš„åœºæ™¯ã€‚ç„¶è€Œï¼Œæ¯æ¬¡è¯»å†™éƒ½éœ€è¦è·å–é”ï¼Œè™½ç„¶é”çš„ç²’åº¦å¾ˆå°ï¼Œä½†è¿˜æ˜¯è®©æ•´ä½“çš„æ€§èƒ½æ‰“äº†ä¸ªæŠ˜æ‰£ã€‚æœ‰æ²¡æœ‰å¯èƒ½ä¼˜åŒ–é”å‘¢ï¼Ÿ</p>
<p>ä¹‹å‰æˆ‘ä»¬è®²åˆ°ï¼Œä¼˜åŒ–é”çš„æ‰‹æ®µæ— éæ˜¯å‡å°ä¸´ç•ŒåŒºçš„å¤§å°ï¼Œè®©æ¯æ¬¡åŠ é”çš„æ—¶é—´å¾ˆçŸ­ï¼Œè¿™æ ·å†²çªçš„å‡ ç‡å°±å˜å°ã€‚å¦å¤–ï¼Œå°±æ˜¯é™ä½åŠ é”çš„é¢‘ç‡ï¼Œå¯¹äºæ¶ˆè´¹è€…æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¸€æ¬¡æ€§æŠŠé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è¯»å®Œç¼“å­˜èµ·æ¥ï¼Œä»¥ååœ¨éœ€è¦çš„æ—¶å€™ä»ç¼“å­˜ä¸­è¯»å–ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§å‡å°‘æ¶ˆè´¹è€…åŠ é”çš„é¢‘æ¬¡ã€‚</p>
<p>é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Receiver çš„ç»“æ„ä¸­æ”¾ä¸€ä¸ª cacheï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct Receiver&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
    cache: VecDeque&lt;T&gt;,
}
</code></pre></pre>
<p>å¦‚æœä½ ä¹‹å‰æœ‰ C è¯­è¨€å¼€å‘çš„ç»éªŒï¼Œä¹Ÿè®¸ä¼šæƒ³ï¼Œåˆ°äº†è¿™ä¸€æ­¥ï¼Œä½•å¿…æŠŠ queue ä¸­çš„æ•°æ®å…¨éƒ¨è¯»å‡ºæ¥ï¼Œå­˜å…¥ Receiver çš„ cache å‘¢ï¼Ÿè¿™æ ·æ•ˆç‡å¤ªä½ï¼Œå¦‚æœèƒ½å¤Ÿç›´æ¥ swap ä¸¤ä¸ªç»“æ„å†…éƒ¨çš„æŒ‡é’ˆï¼Œè¿™æ ·ï¼Œå³ä¾¿é˜Ÿåˆ—ä¸­æœ‰å†å¤šçš„æ•°æ®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª O(1) çš„æ“ä½œã€‚</p>
<p>Rust æœ‰ç±»ä¼¼çš„ <a href="https://doc.rust-lang.org/std/mem/fn.swap.html">std::mem::swap</a> æ–¹æ³•ã€‚æ¯”å¦‚</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::mem;

fn main() {
    let mut x = &quot;hello world&quot;.to_string();
    let mut y = &quot;goodbye world&quot;.to_string();
    
    mem::swap(&amp;mut x, &amp;mut y);
    
    assert_eq!(&quot;goodbye world&quot;, x);
    assert_eq!(&quot;hello world&quot;, y);
}
</code></pre></pre>
<blockquote>
<p>å¥½ï¼Œäº†è§£äº† swap æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä¿®æ”¹ Receiver çš„ recv() æ–¹æ³•æ¥æå‡æ€§èƒ½ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {
    // æ— é” fast path
    if let Some(v) = self.cache.pop_front() {
        return Ok(v);
    }

    // æ‹¿åˆ°é˜Ÿåˆ—çš„é”
    let mut inner = self.shared.queue.lock().unwrap();
    loop {
        match inner.pop_front() {
            // è¯»åˆ°æ•°æ®è¿”å›ï¼Œé”è¢«é‡Šæ”¾
            Some(t) =&gt; {
                // å¦‚æœå½“å‰é˜Ÿåˆ—ä¸­è¿˜æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±æŠŠæ¶ˆè´¹è€…è‡ªèº«ç¼“å­˜çš„é˜Ÿåˆ—ï¼ˆç©ºï¼‰å’Œå…±äº«é˜Ÿåˆ— swap ä¸€ä¸‹
                // è¿™æ ·ä¹‹åå†è¯»å–ï¼Œå°±å¯ä»¥ä» self.queue ä¸­æ— é”è¯»å–
                if !inner.is_empty() {
                    std::mem::swap(&amp;mut self.cache, &amp;mut inner);
                }
                return Ok(t);
            }
            // è¯»ä¸åˆ°æ•°æ®ï¼Œå¹¶ä¸”ç”Ÿäº§è€…éƒ½é€€å‡ºäº†ï¼Œé‡Šæ”¾é”å¹¶è¿”å›é”™è¯¯
            None if self.total_senders() == 0 =&gt; return Err(anyhow!(&quot;no sender left&quot;)),
            // è¯»ä¸åˆ°æ•°æ®ï¼ŒæŠŠé”æäº¤ç»™ available Condvarï¼Œå®ƒä¼šé‡Šæ”¾é”å¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾… notify
            None =&gt; {
                // å½“ Condvar è¢«å”¤é†’åä¼šè¿”å› MutexGuardï¼Œæˆ‘ä»¬å¯ä»¥ loop å›å»æ‹¿æ•°æ®
                // è¿™æ˜¯ä¸ºä»€ä¹ˆ Condvar è¦åœ¨ loop é‡Œä½¿ç”¨
                inner = self
                    .shared
                    .available
                    .wait(inner)
                    .map_err(|_| anyhow!(&quot;lock poisoned&quot;))?;
            }
        }
    }
}
</code></pre></pre>
<ol>
<li>å½“ cache ä¸­æœ‰æ•°æ®æ—¶ï¼Œæ€»æ˜¯ä» cache ä¸­è¯»å–ï¼›</li>
<li>å½“ cache ä¸­æ²¡æœ‰ï¼Œæˆ‘ä»¬æ‹¿åˆ°é˜Ÿåˆ—çš„é”ï¼Œè¯»å–ä¸€ä¸ªæ•°æ®</li>
<li>ç„¶åçœ‹çœ‹é˜Ÿåˆ—æ˜¯å¦è¿˜æœ‰æ•°æ®ï¼Œæœ‰çš„è¯ï¼Œå°± swap cache å’Œ queueï¼Œç„¶åè¿”å›ä¹‹å‰è¯»å–çš„æ•°æ®ã€‚</li>
</ol>
<p>å¥½ï¼Œåšå®Œè¿™ä¸ªé‡æ„å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ cargo testï¼Œçœ‹çœ‹å·²æœ‰çš„æµ‹è¯•æ˜¯å¦æ­£å¸¸ã€‚å¦‚æœä½ é‡åˆ°æŠ¥é”™ï¼Œåº”è¯¥æ˜¯ cache æ²¡æœ‰åˆå§‹åŒ–ï¼Œä½ å¯ä»¥è‡ªè¡Œè§£å†³ï¼Œä¹Ÿå¯ä»¥å‚è€ƒï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    let shared = Shared::default();
    let shared = Arc::new(shared);
    (
        Sender {
            shared: shared.clone(),
        },
        Receiver {
            shared,
            cache: VecDeque::with_capacity(INITIAL_SIZE),
        },
    )
}
</code></pre></pre>
<p>è™½ç„¶ç°æœ‰çš„æµ‹è¯•å…¨æ•°é€šè¿‡ï¼Œä½†æˆ‘ä»¬å¹¶æ²¡æœ‰ä¸ºè¿™ä¸ªä¼˜åŒ–å†™æµ‹è¯•ï¼Œè¿™é‡Œè¡¥ä¸ªæµ‹è¯•ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
    fn channel_fast_path_should_work() {
    let (mut s, mut r) = unbounded();
    for i in 0..10usize {
        s.send(i).unwrap();
    }

    assert!(r.cache.is_empty());
    // è¯»å–ä¸€ä¸ªæ•°æ®ï¼Œæ­¤æ—¶åº”è¯¥ä¼šå¯¼è‡´ swapï¼Œcache ä¸­æœ‰æ•°æ®
    assert_eq!(0, r.recv().unwrap());
    // è¿˜æœ‰ 9 ä¸ªæ•°æ®åœ¨ cache ä¸­
    assert_eq!(r.cache.len(), 9);
    // åœ¨ queue é‡Œæ²¡æœ‰æ•°æ®äº†
    assert_eq!(s.total_queued_items(), 0);

    // ä» cache é‡Œè¯»å–å‰©ä¸‹çš„æ•°æ®
    for (idx, i) in r.into_iter().take(9).enumerate() {
        assert_eq!(idx + 1, i);
    }
}
</code></pre></pre>
<p>è¿™ä¸ªæµ‹è¯•å¾ˆç®€å•ï¼Œè¯¦ç»†æ³¨é‡Šä¹Ÿéƒ½å†™ä¸Šäº†ã€‚</p>
</div>
</details>
<details id="admonition-å®Œæ•´ä»£ç " class="admonition info">
<summary class="admonition-title">
<p>å®Œæ•´ä»£ç </p>
<p><a class="admonition-anchor-link" href="#admonition-å®Œæ•´ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use anyhow::{anyhow, Result};
use std::{
    collections::VecDeque,
    sync::{
        atomic::{AtomicUsize, Ordering},
        Arc, Condvar, Mutex,
    },
};

/// å‘é€è€…
pub struct Sender&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}

/// æ¥æ”¶è€…
pub struct Receiver&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
    cache: VecDeque&lt;T&gt;,
}

/// å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´å…±äº«ä¸€ä¸ª VecDequeï¼Œç”¨ Mutex äº’æ–¥ï¼Œç”¨ Condvar é€šçŸ¥
/// åŒæ—¶ï¼Œæˆ‘ä»¬è®°å½•æœ‰å¤šå°‘ä¸ª senders å’Œ receivers

struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
    senders: AtomicUsize,
    receivers: AtomicUsize,
}

const INITIAL_SIZE: usize = 32;
impl&lt;T&gt; Default for Shared&lt;T&gt; {
    fn default() -&gt; Self {
        Self {
            queue: Mutex::new(VecDeque::with_capacity(INITIAL_SIZE)),
            available: Condvar::new(),
            senders: AtomicUsize::new(1),
            receivers: AtomicUsize::new(1),
        }
    }
}

impl&lt;T&gt; Sender&lt;T&gt; {
    /// ç”Ÿäº§è€…å†™å…¥ä¸€ä¸ªæ•°æ®
    pub fn send(&amp;mut self, t: T) -&gt; Result&lt;()&gt; {
        // å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…äº†ï¼Œå†™å…¥æ—¶å‡ºé”™
        if self.total_receivers() == 0 {
            return Err(anyhow!(&quot;no receiver left&quot;));
        }

        // åŠ é”ï¼Œè®¿é—® VecDequeï¼Œå‹å…¥æ•°æ®ï¼Œç„¶åç«‹åˆ»é‡Šæ”¾é”
        let was_empty = {
            let mut inner = self.shared.queue.lock().unwrap();
            let empty = inner.is_empty();
            inner.push_back(t);
            empty
        };

        // é€šçŸ¥ä»»æ„ä¸€ä¸ªè¢«æŒ‚èµ·ç­‰å¾…çš„æ¶ˆè´¹è€…æœ‰æ•°æ®
        if was_empty {
            self.shared.available.notify_one();
        }

        Ok(())
    }

    pub fn total_receivers(&amp;self) -&gt; usize {
        self.shared.receivers.load(Ordering::SeqCst)
    }

    pub fn total_queued_items(&amp;self) -&gt; usize {
        let queue = self.shared.queue.lock().unwrap();
        queue.len()
    }
}

/// å…‹éš† sender
impl&lt;T&gt; Clone for Sender&lt;T&gt; {
    fn clone(&amp;self) -&gt; Self {
        self.shared.senders.fetch_add(1, Ordering::AcqRel);
        Self {
            shared: Arc::clone(&amp;self.shared),
        }
    }
}

/// Drop sender
impl&lt;T&gt; Drop for Sender&lt;T&gt; {
    fn drop(&amp;mut self) {
        let old = self.shared.senders.fetch_sub(1, Ordering::AcqRel);
        // sender èµ°å…‰äº†ï¼Œå”¤é†’ receiver è¯»å–æ•°æ®ï¼ˆå¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰çš„è¯ï¼‰ï¼Œè¯»ä¸åˆ°å°±å‡ºé”™
        if old &lt;= 1 {
            // å› ä¸ºæˆ‘ä»¬å®ç°çš„æ˜¯ MPSCï¼Œreceiver åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ notify_all å®é™…ç­‰ä»· notify_one
            self.shared.available.notify_all();
        }
    }
}

impl&lt;T&gt; Receiver&lt;T&gt; {
    pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {
        // æ— é” fast path
        if let Some(v) = self.cache.pop_front() {
            return Ok(v);
        }

        // æ‹¿åˆ°é˜Ÿåˆ—çš„é”
        let mut inner = self.shared.queue.lock().unwrap();
        loop {
            match inner.pop_front() {
                // è¯»åˆ°æ•°æ®è¿”å›ï¼Œé”è¢«é‡Šæ”¾
                Some(t) =&gt; {
                    // å¦‚æœå½“å‰é˜Ÿåˆ—ä¸­è¿˜æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±æŠŠæ¶ˆè´¹è€…è‡ªèº«ç¼“å­˜çš„é˜Ÿåˆ—ï¼ˆç©ºï¼‰å’Œå…±äº«é˜Ÿåˆ— swap ä¸€ä¸‹
                    // è¿™æ ·ä¹‹åå†è¯»å–ï¼Œå°±å¯ä»¥ä» self.queue ä¸­æ— é”è¯»å–
                    if !inner.is_empty() {
                        std::mem::swap(&amp;mut self.cache, &amp;mut inner);
                    }
                    return Ok(t);
                }
                // è¯»ä¸åˆ°æ•°æ®ï¼Œå¹¶ä¸”ç”Ÿäº§è€…éƒ½é€€å‡ºäº†ï¼Œé‡Šæ”¾é”å¹¶è¿”å›é”™è¯¯
                None if self.total_senders() == 0 =&gt; return Err(anyhow!(&quot;no sender left&quot;)),
                // è¯»ä¸åˆ°æ•°æ®ï¼ŒæŠŠé”æäº¤ç»™ available Condvarï¼Œå®ƒä¼šé‡Šæ”¾é”å¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾… notify
                None =&gt; {
                    // å½“ Condvar è¢«å”¤é†’åä¼šè¿”å› MutexGuardï¼Œæˆ‘ä»¬å¯ä»¥ loop å›å»æ‹¿æ•°æ®
                    // è¿™æ˜¯ä¸ºä»€ä¹ˆ Condvar è¦åœ¨ loop é‡Œä½¿ç”¨
                    inner = self
                        .shared
                        .available
                        .wait(inner)
                        .map_err(|_| anyhow!(&quot;lock poisoned&quot;))?;
                }
            }
        }
    }

    pub fn total_senders(&amp;self) -&gt; usize {
        self.shared.senders.load(Ordering::SeqCst)
    }
}

impl&lt;T&gt; Iterator for Receiver&lt;T&gt; {
    type Item = T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.recv().ok()
    }
}

impl&lt;T&gt; Drop for Receiver&lt;T&gt; {
    fn drop(&amp;mut self) {
        self.shared.receivers.fetch_sub(1, Ordering::AcqRel);
        // å› ä¸º sender ä¸ä¼šé˜»å¡ï¼Œæ‰€ä»¥ receiver ç¦»å¼€ä¸éœ€è¦å”¤é†’ sender
    }
}

/// åˆ›å»ºä¸€ä¸ª unbounded channel
pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    let shared = Shared::default();
    let shared = Arc::new(shared);
    (
        Sender {
            shared: shared.clone(),
        },
        Receiver {
            shared,
            cache: VecDeque::with_capacity(INITIAL_SIZE),
        },
    )
}

#[cfg(test)]
mod tests {
    use std::{thread, time::Duration};

    use super::*;

    #[test]
    fn channel_should_work() {
        let (mut s, mut r) = unbounded();
        s.send(&quot;hello world!&quot;.to_string()).unwrap();
        let msg = r.recv().unwrap();
        assert_eq!(msg, &quot;hello world!&quot;);
    }

    #[test]
    fn multiple_senders_should_work() {
        let (mut s, mut r) = unbounded();
        let mut s1 = s.clone();
        let mut s2 = s.clone();
        let t = thread::spawn(move || {
            s.send(1).unwrap();
        });
        let t1 = thread::spawn(move || {
            s1.send(2).unwrap();
        });
        let t2 = thread::spawn(move || {
            s2.send(3).unwrap();
        });
        for handle in [t, t1, t2] {
            handle.join().unwrap();
        }

        let mut result = [r.recv().unwrap(), r.recv().unwrap(), r.recv().unwrap()];
        // åœ¨è¿™ä¸ªæµ‹è¯•é‡Œï¼Œæ•°æ®åˆ°è¾¾çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ’ä¸ªåºå† assert
        result.sort_unstable();

        assert_eq!(result, [1, 2, 3]);
    }

    #[test]
    #[allow(clippy::all)]
    fn receiver_should_be_blocked_when_nothing_to_read() {
        let (mut s, r) = unbounded();
        let mut s1 = s.clone();
        thread::spawn(move || {
            for (idx, i) in r.into_iter().enumerate() {
                // å¦‚æœè¯»åˆ°æ•°æ®ï¼Œç¡®ä¿å®ƒå’Œå‘é€çš„æ•°æ®ä¸€è‡´
                assert_eq!(idx, i);
            }
            // è¯»ä¸åˆ°åº”è¯¥ä¼‘çœ ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€å¥ï¼Œæ‰§è¡Œåˆ°è¿™ä¸€å¥è¯´æ˜é€»è¾‘å‡ºé”™
            assert!(false);
        });

        thread::spawn(move || {
            for i in 0..100usize {
                s.send(i).unwrap();
            }
            // é˜²æ­¢æ‰€æœ‰ sender éƒ½ç¦»å¼€
            loop {}
        });

        // 1ms è¶³å¤Ÿè®©ç”Ÿäº§è€…å‘å®Œ 100 ä¸ªæ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹å®Œ 100 ä¸ªæ¶ˆæ¯å¹¶é˜»å¡
        thread::sleep(Duration::from_millis(1));

        // å†æ¬¡å‘é€æ•°æ®ï¼Œå”¤é†’æ¶ˆè´¹è€…
        for i in 100..200usize {
            s1.send(i).unwrap();
        }

        // ç•™ç‚¹æ—¶é—´è®© receiver å¤„ç†
        thread::sleep(Duration::from_millis(1));

        // å¦‚æœ receiver è¢«æ­£å¸¸å”¤é†’å¤„ç†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—é‡Œçš„æ•°æ®ä¼šéƒ½è¢«è¯»å®Œ
        assert_eq!(s1.total_queued_items(), 0);
    }

    #[test]
    fn last_sender_drop_should_error_when_receive() {
        let (s, mut r) = unbounded();
        let s1 = s.clone();
        let senders = [s, s1];
        let total = senders.len();

        // sender å³ç”¨å³æŠ›
        for mut sender in senders {
            thread::spawn(move || {
                sender.send(&quot;hello&quot;).unwrap();
                // sender åœ¨æ­¤è¢«ä¸¢å¼ƒ
            })
            .join()
            .unwrap();
        }

        // è™½ç„¶æ²¡æœ‰ sender äº†ï¼Œæ¥æ”¶è€…ä¾ç„¶å¯ä»¥æ¥å—å·²ç»åœ¨é˜Ÿåˆ—é‡Œçš„æ•°æ®
        for _ in 0..total {
            r.recv().unwrap();
        }

        // ç„¶è€Œï¼Œè¯»å–æ›´å¤šæ•°æ®æ—¶ä¼šå‡ºé”™
        assert!(r.recv().is_err());
    }

    #[test]
    fn receiver_drop_should_error_when_send() {
        let (mut s1, mut s2) = {
            let (s, _) = unbounded();
            let s1 = s.clone();
            (s1, s)
        };

        assert!(s1.send(1).is_err());
        assert!(s2.send(1).is_err());
    }

    #[test]
    fn receiver_shall_be_notified_when_all_senders_exit() {
        let (s, mut r) = unbounded::&lt;usize&gt;();
        // ç”¨äºä¸¤ä¸ªçº¿ç¨‹åŒæ­¥
        let (mut sender, mut receiver) = unbounded::&lt;usize&gt;();
        let t1 = thread::spawn(move || {
            // ä¿è¯ r.recv() å…ˆäº t2 çš„ drop æ‰§è¡Œ
            sender.send(0).unwrap();
            assert!(r.recv().is_err());
        });

        thread::spawn(move || {
            receiver.recv().unwrap();
            drop(s);
        });

        t1.join().unwrap();
    }

    #[test]
    fn channel_fast_path_should_work() {
        let (mut s, mut r) = unbounded();
        for i in 0..10usize {
            s.send(i).unwrap();
        }

        assert!(r.cache.is_empty());
        // è¯»å–ä¸€ä¸ªæ•°æ®ï¼Œæ­¤æ—¶åº”è¯¥ä¼šå¯¼è‡´ swapï¼Œcache ä¸­æœ‰æ•°æ®
        assert_eq!(0, r.recv().unwrap());
        // è¿˜æœ‰ 9 ä¸ªæ•°æ®åœ¨ cache ä¸­
        assert_eq!(r.cache.len(), 9);
        // åœ¨ queue é‡Œæ²¡æœ‰æ•°æ®äº†
        assert_eq!(s.total_queued_items(), 0);

        // ä» cache é‡Œè¯»å–å‰©ä¸‹çš„æ•°æ®
        for (idx, i) in r.into_iter().take(9).enumerate() {
            assert_eq!(idx + 1, i);
        }
    }
}
</code></pre></pre>
</div>
</details>
<h2 id="å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘"><a class="header" href="#å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘">å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘</a></h2>
<details id="admonition-å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘" class="admonition info">
<summary class="admonition-title">
<p>å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘</p>
<p><a class="admonition-anchor-link" href="#admonition-å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘"></a></p>
</summary>
<div>
<p>è¿™é‡Œå®Œå…¨é¡ºç€éœ€æ±‚å†™æµ‹è¯•ï¼Œç„¶ååœ¨å†™æµ‹è¯•çš„è¿‡ç¨‹ä¸­è¿›è¡Œæ•°æ®ç»“æ„å’Œæ¥å£çš„è®¾è®¡ã€‚å’Œæ™®é€šçš„ TDD ä¸åŒçš„æ˜¯ï¼Œå…ˆä¸€å£æ°”æŠŠä¸»è¦éœ€æ±‚æ¶‰åŠçš„è¡Œä¸ºç”¨æµ‹è¯•æ¥è¡¨è¿°ï¼Œç„¶åé€šè¿‡è¿™ä¸ªè¡¨è¿°ï¼Œæ„å»ºåˆé€‚çš„æ¥å£ï¼Œä»¥åŠèƒ½å¤Ÿè¿è¡Œè¿™ä¸ªæ¥å£çš„æ•°æ®ç»“æ„ã€‚</p>
<p>åœ¨å¼€å‘äº§å“çš„æ—¶å€™ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ‰‹æ®µï¼Œå¯ä»¥è®©æˆ‘ä»¬é€šè¿‡æµ‹è¯•å®Œå–„è®¾è®¡ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªèƒ½å¤Ÿè®©æµ‹è¯•ç¼–è¯‘é€šè¿‡çš„ã€å®Œå…¨æ²¡æœ‰å®ç°ä»£ç ã€åªæœ‰æ¥å£çš„ç‰ˆæœ¬ã€‚ä¹‹åï¼Œæˆ‘ä»¬å†ä¸€ä¸ªæ¥å£ä¸€ä¸ªæ¥å£å®ç°ï¼Œå…¨éƒ¨å®ç°å®Œæˆä¹‹åï¼Œè¿è¡Œæµ‹è¯•ï¼Œçœ‹çœ‹æ˜¯å¦å‡ºé—®é¢˜ã€‚</p>
<p>åœ¨è¿™é‡Œä½ å¯ä»¥å¤šå¤šå…³æ³¨æ„å»ºæµ‹è¯•ç”¨ä¾‹çš„æŠ€å·§ã€‚ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘åå¤å¼ºè°ƒè¿‡å•å…ƒæµ‹è¯•çš„é‡è¦æ€§ï¼Œä¹Ÿä»¥èº«ä½œåˆ™åœ¨å‡ ä¸ªé‡è¦çš„å®æ“ä¸­éƒ½æœ‰è¯¦å°½åœ°æµ‹è¯•ã€‚ä¸è¿‡ç›¸æ¯”ä¹‹å‰å†™çš„æµ‹è¯•ï¼Œè¿™ä¸€è®²ä¸­çš„æµ‹è¯•è¦æ›´éš¾å†™ä¸€äº›ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘åœºæ™¯ä¸‹é‚£äº›è¾¹è¾¹è§’è§’çš„åŠŸèƒ½æµ‹è¯•ã€‚</p>
<p>ä¸è¦å°çœ‹æµ‹è¯•ä»£ç ï¼Œæœ‰æ—¶å€™æ„é€ æµ‹è¯•ä»£ç æ¯”æ’°å†™åŠŸèƒ½ä»£ç è¿˜è¦çƒ§è„‘ã€‚ä½†æ˜¯ï¼Œå½“ä½ æœ‰äº†æ‰å®çš„å•å…ƒæµ‹è¯•è¦†ç›–åï¼Œå†åšé‡æ„ï¼Œæ¯”å¦‚æœ€åæˆ‘ä»¬åšå’Œæ€§èƒ½ç›¸å…³çš„é‡æ„ï¼Œå°±å˜å¾—è½»æ¾å¾ˆå¤šï¼Œå› ä¸ºåªè¦cargo testé€šè¿‡ï¼Œèµ·ç è¿™ä¸ªé‡æ„æ²¡æœ‰å¼•èµ·ä»»ä½•å›å½’é—®é¢˜ï¼ˆregression bugï¼‰ã€‚</p>
<p>å½“ç„¶ï¼Œé‡æ„æ²¡æœ‰å¼•å…¥å›å½’é—®é¢˜ï¼Œå¹¶ä¸æ„å‘³ç€é‡æ„å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘æ’°å†™æ–°çš„æµ‹è¯•ï¼Œè¦†ç›–é‡æ„å¸¦æ¥çš„æ”¹åŠ¨ã€‚</p>
</div>
</details>
<h1 id="å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯"><a class="header" href="#å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯">å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯</a></h1>
<details id="admonition-å¦‚ä½•æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ä½¿ç”¨atomicmutexrwlocksemaphorecondvarchannelactor" class="admonition info">
<summary class="admonition-title">
<p>å¦‚ä½•æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ä½¿ç”¨Atomicã€Mutexã€RwLockã€Semaphoreã€Condvarã€Channelã€Actor</p>
<p><a class="admonition-anchor-link" href="#admonition-å¦‚ä½•æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ä½¿ç”¨atomicmutexrwlocksemaphorecondvarchannelactor"></a></p>
</summary>
<div>
<blockquote>
<p>Atomicã€Mutexã€RwLockã€Semaphoreã€Condvarã€Channelã€Actorã€‚</p>
</blockquote>
<ol>
<li>Atomic åœ¨å¤„ç†ç®€å•çš„åŸç”Ÿç±»å‹æ—¶éå¸¸æœ‰ç”¨ï¼Œå¦‚æœä½ å¯ä»¥é€šè¿‡ AtomicXXX ç»“æ„è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆå®ƒä»¬æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</li>
<li>å½“ä½ çš„æ•°æ®ç»“æ„æ— æ³•ç®€å•é€šè¿‡ AtomicXXX è¿›è¡ŒåŒæ­¥ï¼Œä½†ä½ åˆçš„ç¡®éœ€è¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆ Mutex / RwLock å¯ä»¥æ˜¯ä¸€ç§é€‰æ‹©ã€‚ä¸è¿‡ï¼Œä½ éœ€è¦è€ƒè™‘é”çš„ç²’åº¦ï¼Œç²’åº¦å¤ªå¤§çš„ Mutex / RwLock æ•ˆç‡å¾ˆä½ã€‚</li>
<li>å¦‚æœä½ æœ‰ N ä»½èµ„æºå¯ä»¥ä¾›å¤šä¸ªå¹¶å‘ä»»åŠ¡ç«äº‰ä½¿ç”¨ï¼Œé‚£ä¹ˆï¼ŒSemaphore æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚æ¯”å¦‚ä½ è¦åšä¸€ä¸ª DB è¿æ¥æ± ã€‚</li>
<li>å½“ä½ éœ€è¦åœ¨å¹¶å‘ä»»åŠ¡ä¸­é€šçŸ¥ã€åä½œæ—¶ï¼ŒCondvar æä¾›äº†æœ€åŸºæœ¬çš„é€šçŸ¥æœºåˆ¶ï¼Œè€Œ Channel æŠŠè¿™ä¸ªé€šçŸ¥æœºåˆ¶è¿›ä¸€æ­¥å¹¿æ³›æ‰©å±•å¼€ï¼Œäºæ˜¯ä½ å¯ä»¥ç”¨ Condvar è¿›è¡Œç‚¹å¯¹ç‚¹çš„åŒæ­¥ï¼Œç”¨ Channel åšä¸€å¯¹å¤šã€å¤šå¯¹ä¸€ã€å¤šå¯¹å¤šçš„åŒæ­¥ã€‚</li>
</ol>
<blockquote>
<p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åšå¤§éƒ¨åˆ†å¤æ‚çš„ç³»ç»Ÿè®¾è®¡æ—¶ï¼ŒChannel å¾€å¾€æ˜¯æœ€æœ‰åŠ›çš„æ­¦å™¨ï¼Œé™¤äº†å¯ä»¥è®©æ•°æ®ç©¿æ¢­äºå„ä¸ªçº¿ç¨‹ã€å„ä¸ªå¼‚æ­¥ä»»åŠ¡é—´ï¼Œå®ƒçš„æ¥å£è¿˜å¯ä»¥å¾ˆä¼˜é›…åœ°è·Ÿ stream é€‚é…ã€‚</p>
</blockquote>
<p>å¦‚æœè¯´åœ¨åšæ•´ä¸ªåç«¯çš„ç³»ç»Ÿæ¶æ„æ—¶ï¼Œæˆ‘ä»¬ç€çœ¼çš„æ˜¯ï¼šæœ‰å“ªäº›æœåŠ¡ã€æœåŠ¡å’ŒæœåŠ¡ä¹‹é—´å¦‚ä½•é€šè®¯ã€æ•°æ®å¦‚ä½•æµåŠ¨ã€æœåŠ¡å’ŒæœåŠ¡é—´å¦‚ä½•åŒæ­¥ï¼›
é‚£ä¹ˆåœ¨åšæŸä¸€ä¸ªæœåŠ¡çš„æ¶æ„æ—¶ï¼Œç€çœ¼çš„æ˜¯æœ‰å“ªäº›åŠŸèƒ½æ€§çš„çº¿ç¨‹ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰ã€å®ƒä»¬ä¹‹é—´çš„æ¥å£æ˜¯ä»€ä¹ˆæ ·å­ã€æ•°æ®å¦‚ä½•æµåŠ¨ã€å¦‚ä½•åŒæ­¥ã€‚</p>
<p>åœ¨è¿™é‡Œï¼ŒChannel å…¼å…·æ¥å£ã€åŒæ­¥å’Œæ•°æ®æµä¸‰ç§åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘è¯´æ˜¯æœ€æœ‰åŠ›çš„æ­¦å™¨ã€‚</p>
<p>ç„¶è€Œå®ƒä¸è¯¥æ˜¯å”¯ä¸€çš„æ­¦å™¨ã€‚æˆ‘ä»¬é¢ä¸´çš„çœŸå®ä¸–ç•Œçš„å¹¶å‘é—®é¢˜æ˜¯å¤šæ ·çš„ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿåº”è¯¥æ˜¯å¤šæ ·çš„ï¼Œè®¡ç®—æœºç§‘å­¦å®¶ä»¬åœ¨è¿‡å»çš„å‡ åå¹´é‡Œä¸æ–­æ¢ç´¢ï¼Œæ„å»ºäº†ä¸€ç³»åˆ—çš„å¹¶å‘åŸè¯­ï¼Œä¹Ÿè¯´æ˜äº†å¾ˆéš¾æœ‰ä¸€ç§é“¶å¼¹è§£å†³æ‰€æœ‰é—®é¢˜ã€‚</p>
<p>å°±è¿ Mutex æœ¬èº«ï¼Œåœ¨å®ç°ä¸­ï¼Œè¿˜ä¼šæ ¹æ®ä¸åŒçš„åœºæ™¯åšä¸åŒçš„å¦¥åï¼ˆæ¯”å¦‚åš faireness çš„å¦¥åï¼‰ï¼Œå› ä¸ºè¿™ä¸ªä¸–ç•Œå°±æ˜¯è¿™æ ·ï¼Œé±¼ä¸ç†ŠæŒä¸å¯å…¼å¾—ï¼Œæ²¡æœ‰å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œåªæœ‰å¦¥åå‡ºæ¥çš„è§£å†³æ–¹æ¡ˆã€‚æ‰€ä»¥ Channel ä¸æ˜¯é“¶å¼¹ï¼Œactor model ä¸æ˜¯é“¶å¼¹ï¼Œlock ä¸æ˜¯é“¶å¼¹ã€‚</p>
<p>ä¸€é—¨å¥½çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¯ä»¥æä¾›å¤§éƒ¨åˆ†åœºæ™¯ä¸‹çš„æœ€ä½³å®è·µï¼ˆå¦‚ Erlang/Golangï¼‰ï¼Œä½†ä¸è¯¥è¥é€ ä¸€ç§æ°”æ°›ï¼Œåªæœ‰æŸä¸ªæœ€ä½³å®è·µæ‰æ˜¯å”¯ä¸€æ–¹æ¡ˆã€‚æˆ‘å¾ˆå–œæ¬¢ Erlang çš„ actor model å’Œ Golang çš„ Channelï¼Œä½†å¾ˆå¯æƒœï¼Œå®ƒä»¬è¿‡åˆ†ä¾èµ–ç‰¹å®šçš„ã€å”¯ä¸€çš„å¹¶å‘æ–¹æ¡ˆï¼Œä½¿å¾—å¼€å‘è€…æ‹¿ç€æ¦”å¤´ï¼Œçœ‹ä»€ä¹ˆéƒ½æ˜¯é’‰å­ã€‚</p>
<p>ç›¸åï¼ŒRust æä¾›å‡ ä¹ä½ éœ€è¦çš„æ‰€æœ‰è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”å¹¶ä¸é¼“å¹å®ƒä»¬çš„ä¼˜åŠ£ï¼Œå®Œå…¨äº¤ç”±ä½ æŒ‰éœ€é€‰æ‹©ã€‚æˆ‘åœ¨ç”¨ Rust æ’°å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼ŒChannel ä»ç„¶æ˜¯ç¬¬ä¸€é€‰æ‹©ï¼Œä½†æˆ‘è¿˜æ˜¯ä¼šåœ¨åˆé€‚çš„æ—¶å€™ä½¿ç”¨ Mutexã€RwLockã€Semaphoreã€Condvarã€Atomic ç­‰å·¥å…·ï¼Œè€Œä¸æ˜¯è¯•å›¾ç¬¨æ‹™åœ°ç”¨ Channel å åŠ  Channel æ¥åº”å¯¹æ‰€æœ‰çš„åœºæ™¯ã€‚</p>
</div>
</details>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="5_concurrency_async.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="5_2_future_async_await.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="5_concurrency_async.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="5_2_future_async_await.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
