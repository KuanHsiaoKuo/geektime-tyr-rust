<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>宏分类 - Anatomy In First Rust Programming Class 🦀</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="以rust编程第一课的代码为例进行基础代码分析">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> 源码阅读逻辑</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldb调试或查看内存结构</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rust核心深入</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. 从栈堆、所有权、生命周期开始内存管理</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> 从堆栈开始</a></li><li class="chapter-item "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> 四大编程基础概念</a></li><li class="chapter-item "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> 所有权</a></li><li class="chapter-item "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> 生命周期</a></li><li class="chapter-item "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> 从创建到消亡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. 类型系统</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> 类型系统特点</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> 泛型</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_3_0_trait_overview.html"><strong aria-hidden="true">4.2.3.1.</strong> trait概览</a></li><li class="chapter-item "><a href="2_3_1_trait_impl.html"><strong aria-hidden="true">4.2.3.2.</strong> Trait Impl</a></li><li class="chapter-item "><a href="2_3_2_trait_object.html"><strong aria-hidden="true">4.2.3.3.</strong> Trait Object</a></li><li class="chapter-item "><a href="2_3_3_trait_frequently.html"><strong aria-hidden="true">4.2.3.4.</strong> 常用trait</a></li><li class="chapter-item "><a href="2_3_4_trait_design.html"><strong aria-hidden="true">4.2.3.5.</strong> Trait设计</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. 数据结构</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> 智能指针</a></li><li class="chapter-item "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> 集合容器</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_2_1_slice.html"><strong aria-hidden="true">4.3.2.1.</strong> 切片</a></li><li class="chapter-item "><a href="3_2_2_hashmap.html"><strong aria-hidden="true">4.3.2.2.</strong> 哈希表</a></li></ol></li><li class="chapter-item "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> 错误处理</a></li><li class="chapter-item "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> 闭包</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. 宏编程</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="4_1_macros_classify.html" class="active"><strong aria-hidden="true">4.4.1.</strong> 宏分类</a></li><li class="chapter-item "><a href="4_2_declarative_macros.html"><strong aria-hidden="true">4.4.2.</strong> 声明宏</a></li><li class="chapter-item "><a href="4_3_procedural_macros.html"><strong aria-hidden="true">4.4.3.</strong> 过程宏</a></li></ol></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. 并发与异步</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> 并发原语(Concurrency Primitives)</a></li><li class="chapter-item "><a href="5_2_future_async_await.html"><strong aria-hidden="true">4.5.2.</strong> 异步：Future/Async/Await</a></li><li class="chapter-item "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">4.5.3.</strong> 深入async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. 混合编程</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv server设计与实现</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> 基本流程</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> 实现并验证协议层</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> 高级trait改造</a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> 网络处理</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> 网络安全</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> 异步改造</a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> 重大重构</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> 配置、测试、监控、CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> 构建自己的类axum异步Web框架</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class 🦀</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">保持批判，有所取舍，知行合一, 方见真我</a> -- 练武不练功
                到头一场空 -- 《赛博英雄传》 </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <style>.extended-markdown-table {
    display: grid;
}

.extended-markdown-table > div {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 3px 20px;
    border-bottom: 1px solid var(--table-border-color);
    border-right: 1px solid var(--table-border-color);
}

.extended-markdown-table > div.extended-markdown-left-border {
    border-left: 1px solid var(--table-border-color);
}

.extended-markdown-table > div.extended-markdown-header {
    text-align: center;
    background: var(--table-header-bg);
    border-bottom: 1px solid var(--table-header-bg);
    border-right: 1px solid var(--table-header-bg);
    font-weight: bold;
}

.extended-markdown-table > div.extended-markdown-header.extended-markdown-left-border {
    border-left: 1px solid var(--table-header-bg);
}
</style>
<h1 id="宏的分类"><a class="header" href="#宏的分类">宏的分类</a></h1>
<!--ts-->
<ul>
<li><a href="#%E5%AE%8F%E7%9A%84%E5%88%86%E7%B1%BB">宏的分类</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%B3%B3%E9%81%93%E5%9B%BE">使用泳道图</a></li>
<li><a href="#%E8%A1%A8%E6%A0%BC">表格</a></li>
<li><a href="#%E5%A3%B0%E6%98%8E%E5%AE%8Fdeclarative-macros-macro_rulesbang">声明宏(declarative macros): macro_rules!(bang)</a></li>
<li><a href="#%E5%A3%B0%E6%98%8E%E5%AE%8F%E7%9A%84%E7%BC%BA%E9%99%B7%E8%80%8C%E5%90%8E%E6%9C%89%E4%BA%86%E8%BF%87%E7%A8%8B%E5%AE%8F">声明宏的缺陷，而后有了过程宏</a></li>
<li><a href="#%E8%BF%87%E7%A8%8B%E5%AE%8F%E6%B7%B1%E5%BA%A6%E5%AE%9A%E5%88%B6%E4%B8%8E%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81">过程宏：深度定制与生成代码</a>
<ul>
<li><a href="#1-%E5%87%BD%E6%95%B0%E5%AE%8F">1. 函数宏</a></li>
<li><a href="#2-%E5%B1%9E%E6%80%A7%E5%AE%8F">2. 属性宏</a></li>
<li><a href="#3-%E6%B4%BE%E7%94%9F%E5%AE%8F">3. 派生宏</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct 19 09:31:57 UTC 2022 -->
<!--te-->
<h2 id="使用泳道图"><a class="header" href="#使用泳道图">使用泳道图</a></h2>
<details id="admonition-宏编程使用对比泳道图" class="admonition info">
<summary class="admonition-title">
<p>宏编程使用对比泳道图</p>
<p><a class="admonition-anchor-link" href="#admonition-宏编程使用对比泳道图"></a></p>
</summary>
<div>
<figure><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2964px" preserveAspectRatio="none" style="width:892px;height:2964px;background:#FFFFFF;" version="1.1" viewBox="0 0 892 2964" width="892px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="42.5938" id="_title" style="stroke:none;stroke-width:1.0;" width="192" x="348.5" y="15"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="98" x="395.5" y="32.9951">两类四种宏对比</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="182" x="353.5" y="49.292">（具体内容看详细版泳道图）</text><rect fill="none" height="41.9063" style="stroke:none;stroke-width:1.0;" width="859" x="15" y="66.3389"/><ellipse cx="128.5" cy="341.1201" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="47.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="131" x="63" y="371.1201"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="107" x="77" y="392.2588">基于TokenStream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="73" y="406.2275">定义过程函数宏</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="88.5" y="439.0576"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="98.5" y="460.1963">打开过程宏</text><ellipse cx="128.5" cy="720.9014" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="215" x="21" y="750.9014"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="191" x="35" y="772.04">手工抽取TokenStream定义派生宏</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="84" x="86.5" y="804.8701"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="100.5" y="826.0088">打开过程宏</text><ellipse cx="128.5" cy="1510.0576" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="47.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="193" x="32" y="1540.0576"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="169" x="46" y="1561.1963">syn/quote抽取TokenStream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="42" y="1575.165">为DeriveInput定义派生宏</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="84" x="86.5" y="1607.9951"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="100.5" y="1629.1338">打开过程宏</text><ellipse cx="128.5" cy="2189.3701" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="47.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="193" x="32" y="2219.3701"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="169" x="46" y="2240.5088">syn/quote抽取TokenStream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="42" y="2254.4775">为DeriveInput定义属性宏</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="84" x="86.5" y="2287.3076"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="100.5" y="2308.4463">打开过程宏</text><line style="stroke:#000000;stroke-width:1.5;" x1="15" x2="15" y1="66.3389" y2="2952.4951"/><rect fill="#FAEBD7" height="2886.1563" style="stroke:#FAEBD7;stroke-width:1.0;" width="271" x="240" y="66.3389"/><rect fill="#F1F1F1" height="113.8125" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="202" x="275" y="858.8389"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="156" x="285" y="879.9775">使用anyhow与askama抽取</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="131" x="285" y="893.9463">TokenStream中的信息</text><line style="stroke:#181818;stroke-width:1.0;" x1="275" x2="477" y1="901.7764" y2="901.7764"/><line style="stroke:#181818;stroke-width:1.0;" x1="275" x2="477" y1="903.7764" y2="903.7764"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="182" x="285" y="917.915">1. 分别定义BuilderContext和Fd</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="135" x="285" y="931.8838">2. BuilderContext处理:</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="97" x="317" y="945.8525">jinja模版数据结构</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="105" x="285" y="959.8213">3. Fd描述每个field</text><rect fill="#AAAAAA" height="75.875" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="303.5" y="992.6514"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="125" x="313.5" y="1013.79">templates/builder.j2</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="313.5" y="1027.7588"> </text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="116" x="313.5" y="1041.7275">编写与tokenstream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="93" x="313.5" y="1055.6963">对应的jinja2模版</text><rect fill="#F1F1F1" height="169.6875" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="227" x="262.5" y="1088.5264"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="272.5" y="1109.665">实现对应抽取方法</text><line style="stroke:#181818;stroke-width:1.0;" x1="262.5" x2="489.5" y1="1117.4951" y2="1117.4951"/><line style="stroke:#181818;stroke-width:1.0;" x1="262.5" x2="489.5" y1="1119.4951" y2="1119.4951"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="194" x="272.5" y="1133.6338">1. Fd实现new方法处理TokenTree</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="191" x="272.5" y="1147.6025">2. BuilderContext实现下列方法：</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="37" x="272.5" y="1161.5713">- new:</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="175" x="304.5" y="1175.54">从 TokenStream 中提取信息，</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="119" x="304.5" y="1189.5088">构建 BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="54" x="272.5" y="1203.4775">- render:</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="165" x="304.5" y="1217.4463">把jinja2模版渲染成字符串代码</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="142" x="304.5" y="1231.415">&gt; render里面用到split和</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="127" x="320.5" y="1245.3838">get_struct_fields方法</text><rect fill="#F1F1F1" height="71.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="202" x="275" y="1661.9639"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="118" x="285" y="1683.1025">使用syn与quote抽取</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="131" x="285" y="1697.0713">TokenStream中的信息</text><line style="stroke:#181818;stroke-width:1.0;" x1="275" x2="477" y1="1704.9014" y2="1704.9014"/><line style="stroke:#181818;stroke-width:1.0;" x1="275" x2="477" y1="1706.9014" y2="1706.9014"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="182" x="285" y="1721.04">1. 同样定义BuilderContext和Fd</text><rect fill="#F1F1F1" height="183.6563" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="219" x="266.5" y="1753.8701"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="108" x="276.5" y="1775.0088">不需要自己手动定义</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="132" x="276.5" y="1788.9775">抽取模版，直接实现方法</text><line style="stroke:#181818;stroke-width:1.0;" x1="266.5" x2="485.5" y1="1796.8076" y2="1796.8076"/><line style="stroke:#181818;stroke-width:1.0;" x1="266.5" x2="485.5" y1="1798.8076" y2="1798.8076"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="191" x="276.5" y="1812.9463">1. 比起手动方式，BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="162" x="292.5" y="1826.915">和Fd还需要实现From Trait。</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="187" x="276.5" y="1840.8838">2. 接着Fd就不需要再处理，主要在</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="91" x="292.5" y="1854.8525">BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="179" x="276.5" y="1868.8213">3. BuilderContext实现下列方法</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="124" x="292.5" y="1882.79">- render: 用到quote!</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="183" x="292.5" y="1896.7588">- gen_optionized_fields(&amp;self)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="135" x="292.5" y="1910.7275">- gen_methods(&amp;self)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="128" x="292.5" y="1924.6963">- gen_assigns(&amp;self)</text><rect fill="#F1F1F1" height="85.875" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="260" x="246" y="2341.2764"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="118" x="256" y="2362.415">使用syn与quote抽取</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="131" x="256" y="2376.3838">TokenStream中的信息</text><line style="stroke:#181818;stroke-width:1.0;" x1="246" x2="506" y1="2384.2139" y2="2384.2139"/><line style="stroke:#181818;stroke-width:1.0;" x1="246" x2="506" y1="2386.2139" y2="2386.2139"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="199" x="256" y="2400.3525">1. 定义Opts、Fd、BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="240" x="256" y="2414.3213">2. 比起派生宏，多了Opts用于捕获Fd的属性</text><rect fill="#F1F1F1" height="155.7188" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="250" x="251" y="2447.1514"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="261" y="2468.29">不需要自己手动定</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="132" x="261" y="2482.2588">抽取模版，直接实现方法</text><line style="stroke:#181818;stroke-width:1.0;" x1="251" x2="501" y1="2490.0889" y2="2490.0889"/><line style="stroke:#181818;stroke-width:1.0;" x1="251" x2="501" y1="2492.0889" y2="2492.0889"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="230" x="261" y="2506.2275">1. 和派生宏一样，给Fd、BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="150" x="277" y="2520.1963">和Fd还需要实现From Trait</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="215" x="261" y="2534.165">2. BuilderContext同样实现下列方法：</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="124" x="277" y="2548.1338">- render: 用到quote!</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="183" x="277" y="2562.1025">- gen_optionized_fields(&amp;self)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="135" x="277" y="2576.0713">- gen_methods(&amp;self)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="128" x="277" y="2590.04">- gen_assigns(&amp;self)</text><line style="stroke:#000000;stroke-width:1.5;" x1="240" x2="240" y1="66.3389" y2="2952.4951"/><ellipse cx="605" cy="123.2451" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="565" y="153.2451"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="575" y="174.3838">定义声明宏</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="565" y="493.0264"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="575" y="514.165">定义过程宏</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="553" y="1278.2139"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="563" y="1299.3525">定义过程派生宏</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="553" y="1957.5264"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="563" y="1978.665">定义过程派生宏</text><rect fill="#F1F1F1" height="151.75" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="176" x="517" y="2622.8701"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="527" y="2644.0088">定义过程派生宏</text><line style="stroke:#181818;stroke-width:1.0;" x1="517" x2="693" y1="2651.8389" y2="2651.8389"/><line style="stroke:#181818;stroke-width:1.0;" x1="517" x2="693" y1="2653.8389" y2="2653.8389"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="527" y="2667.9775">和派生宏不同的是</text><line style="stroke:#181818;stroke-width:1.0;" x1="517" x2="693" y1="2675.8076" y2="2675.8076"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="72" x="527" y="2691.9463">这里多了一个</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="155" x="527" y="2705.915">attributes(builder) 属性，</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="527" y="2719.8838">这是告诉编译器，</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="108" x="527" y="2733.8525">请允许代码中出现的</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="12" x="527" y="2747.8213">1.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="87" x="543" y="2747.8213">[builder(...)]，</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="156" x="527" y="2761.79">它是我这个宏认识并要处理的</text><line style="stroke:#000000;stroke-width:1.5;" x1="511" x2="511" y1="66.3389" y2="2952.4951"/><rect fill="#F1F1F1" height="71.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="127" x="722" y="207.2139"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="732" y="228.3525">使用声明宏</text><line style="stroke:#181818;stroke-width:1.0;" x1="722" x2="849" y1="236.1826" y2="236.1826"/><line style="stroke:#181818;stroke-width:1.0;" x1="722" x2="849" y1="238.1826" y2="238.1826"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="107" x="732" y="252.3213">没有TokenStream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="48" x="732" y="266.29">难以调试</text><ellipse cx="785.5" cy="310.1201" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="785.5" cy="310.1201" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="745.5" y="546.9951"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="755.5" y="568.1338">使用过程宏</text><rect fill="#F1F1F1" height="57.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="704" y="600.9639"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="714" y="622.1025">Terminal</text><line style="stroke:#181818;stroke-width:1.0;" x1="704" x2="867" y1="629.9326" y2="629.9326"/><line style="stroke:#181818;stroke-width:1.0;" x1="704" x2="867" y1="631.9326" y2="631.9326"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="714" y="646.0713">查看打印的TokenStream</text><ellipse cx="785.5" cy="689.9014" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="785.5" cy="689.9014" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="733.5" y="1332.1826"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="743.5" y="1353.3213">使用派生宏抽取</text><rect fill="#F1F1F1" height="61.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="103" x="734" y="1386.1514"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="744" y="1407.29">Terminal</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="744" y="1421.2588">查看打印的</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="83" x="744" y="1435.2275">TokenStream</text><ellipse cx="785.5" cy="1479.0576" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="785.5" cy="1479.0576" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="733.5" y="2011.4951"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="743.5" y="2032.6338">使用派生宏抽取</text><rect fill="#F1F1F1" height="61.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="91" x="740" y="2065.4639"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="750" y="2086.6025">Terminal</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="750" y="2100.5713">查看打印的</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="71" x="750" y="2114.54">DeriveInput</text><ellipse cx="785.5" cy="2158.3701" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="785.5" cy="2158.3701" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="733.5" y="2794.6201"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="743.5" y="2815.7588">使用派生宏抽取</text><rect fill="#F1F1F1" height="61.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="91" x="740" y="2848.5889"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="750" y="2869.7275">Terminal</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="750" y="2883.6963">查看打印的</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="71" x="750" y="2897.665">DeriveInput</text><ellipse cx="785.5" cy="2941.4951" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="785.5" cy="2941.4951" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.5;" x1="698" x2="698" y1="66.3389" y2="2952.4951"/><line style="stroke:#000000;stroke-width:1.5;" x1="872" x2="872" y1="66.3389" y2="2952.4951"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="351.1201" y2="371.1201"/><polygon fill="#181818" points="124.5,361.1201,128.5,371.1201,132.5,361.1201,128.5,365.1201" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="419.0576" y2="439.0576"/><polygon fill="#181818" points="124.5,429.0576,128.5,439.0576,132.5,429.0576,128.5,433.0576" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="730.9014" y2="750.9014"/><polygon fill="#181818" points="124.5,740.9014,128.5,750.9014,132.5,740.9014,128.5,744.9014" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="784.8701" y2="804.8701"/><polygon fill="#181818" points="124.5,794.8701,128.5,804.8701,132.5,794.8701,128.5,798.8701" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="1520.0576" y2="1540.0576"/><polygon fill="#181818" points="124.5,1530.0576,128.5,1540.0576,132.5,1530.0576,128.5,1534.0576" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="1587.9951" y2="1607.9951"/><polygon fill="#181818" points="124.5,1597.9951,128.5,1607.9951,132.5,1597.9951,128.5,1601.9951" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="2199.3701" y2="2219.3701"/><polygon fill="#181818" points="124.5,2209.3701,128.5,2219.3701,132.5,2209.3701,128.5,2213.3701" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="2267.3076" y2="2287.3076"/><polygon fill="#181818" points="124.5,2277.3076,128.5,2287.3076,132.5,2277.3076,128.5,2281.3076" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="972.6514" y2="992.6514"/><polygon fill="#181818" points="372,982.6514,376,992.6514,380,982.6514,376,986.6514" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="1068.5264" y2="1088.5264"/><polygon fill="#181818" points="372,1078.5264,376,1088.5264,380,1078.5264,376,1082.5264" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="1733.8701" y2="1753.8701"/><polygon fill="#181818" points="372,1743.8701,376,1753.8701,380,1743.8701,376,1747.8701" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="2427.1514" y2="2447.1514"/><polygon fill="#181818" points="372,2437.1514,376,2447.1514,380,2437.1514,376,2441.1514" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="133.2451" y2="153.2451"/><polygon fill="#181818" points="601,143.2451,605,153.2451,609,143.2451,605,147.2451" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="279.1201" y2="299.1201"/><polygon fill="#181818" points="781.5,289.1201,785.5,299.1201,789.5,289.1201,785.5,293.1201" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="580.9639" y2="600.9639"/><polygon fill="#181818" points="781.5,590.9639,785.5,600.9639,789.5,590.9639,785.5,594.9639" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="658.9014" y2="678.9014"/><polygon fill="#181818" points="781.5,668.9014,785.5,678.9014,789.5,668.9014,785.5,672.9014" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="1366.1514" y2="1386.1514"/><polygon fill="#181818" points="781.5,1376.1514,785.5,1386.1514,789.5,1376.1514,785.5,1380.1514" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="1448.0576" y2="1468.0576"/><polygon fill="#181818" points="781.5,1458.0576,785.5,1468.0576,789.5,1458.0576,785.5,1462.0576" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="2045.4639" y2="2065.4639"/><polygon fill="#181818" points="781.5,2055.4639,785.5,2065.4639,789.5,2055.4639,785.5,2059.4639" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="2127.3701" y2="2147.3701"/><polygon fill="#181818" points="781.5,2137.3701,785.5,2147.3701,789.5,2137.3701,785.5,2141.3701" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="2828.5889" y2="2848.5889"/><polygon fill="#181818" points="781.5,2838.5889,785.5,2848.5889,789.5,2838.5889,785.5,2842.5889" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="2910.4951" y2="2930.4951"/><polygon fill="#181818" points="781.5,2920.4951,785.5,2930.4951,789.5,2920.4951,785.5,2924.4951" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="187.2139" y2="192.2139"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="785.5" y1="192.2139" y2="192.2139"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="192.2139" y2="207.2139"/><polygon fill="#181818" points="781.5,197.2139,785.5,207.2139,789.5,197.2139,785.5,201.2139" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="473.0264" y2="478.0264"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="605" y1="478.0264" y2="478.0264"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="478.0264" y2="493.0264"/><polygon fill="#181818" points="601,483.0264,605,493.0264,609,483.0264,605,487.0264" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="526.9951" y2="531.9951"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="785.5" y1="531.9951" y2="531.9951"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="531.9951" y2="546.9951"/><polygon fill="#181818" points="781.5,536.9951,785.5,546.9951,789.5,536.9951,785.5,540.9951" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="838.8389" y2="843.8389"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="376" y1="843.8389" y2="843.8389"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="843.8389" y2="858.8389"/><polygon fill="#181818" points="372,848.8389,376,858.8389,380,848.8389,376,852.8389" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="1258.2139" y2="1263.2139"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="605" y1="1263.2139" y2="1263.2139"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="1263.2139" y2="1278.2139"/><polygon fill="#181818" points="601,1268.2139,605,1278.2139,609,1268.2139,605,1272.2139" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="1312.1826" y2="1317.1826"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="785.5" y1="1317.1826" y2="1317.1826"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="1317.1826" y2="1332.1826"/><polygon fill="#181818" points="781.5,1322.1826,785.5,1332.1826,789.5,1322.1826,785.5,1326.1826" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="1641.9639" y2="1646.9639"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="376" y1="1646.9639" y2="1646.9639"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="1646.9639" y2="1661.9639"/><polygon fill="#181818" points="372,1651.9639,376,1661.9639,380,1651.9639,376,1655.9639" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="1937.5264" y2="1942.5264"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="605" y1="1942.5264" y2="1942.5264"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="1942.5264" y2="1957.5264"/><polygon fill="#181818" points="601,1947.5264,605,1957.5264,609,1947.5264,605,1951.5264" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="1991.4951" y2="1996.4951"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="785.5" y1="1996.4951" y2="1996.4951"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="1996.4951" y2="2011.4951"/><polygon fill="#181818" points="781.5,2001.4951,785.5,2011.4951,789.5,2001.4951,785.5,2005.4951" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="2321.2764" y2="2326.2764"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="376" y1="2326.2764" y2="2326.2764"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="2326.2764" y2="2341.2764"/><polygon fill="#181818" points="372,2331.2764,376,2341.2764,380,2331.2764,376,2335.2764" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="376" y1="2602.8701" y2="2607.8701"/><line style="stroke:#181818;stroke-width:1.0;" x1="376" x2="605" y1="2607.8701" y2="2607.8701"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="2607.8701" y2="2622.8701"/><polygon fill="#181818" points="601,2612.8701,605,2622.8701,609,2612.8701,605,2616.8701" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="605" y1="2774.6201" y2="2779.6201"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="785.5" y1="2779.6201" y2="2779.6201"/><line style="stroke:#181818;stroke-width:1.0;" x1="785.5" x2="785.5" y1="2779.6201" y2="2794.6201"/><polygon fill="#181818" points="781.5,2784.6201,785.5,2794.6201,789.5,2784.6201,785.5,2788.6201" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="99" x="81" y="83.0469">Cargo.toml</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="31" x="274.5" y="83.0469">src/</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="214" x="268.5" y="104">&lt;抽取字段与方法定义&gt;.rs</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="74" x="570.5" y="83.0469">src/lib.rs</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="90" x="743" y="83.0469">examples/</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="72" x="737" y="104">调用代码</text></g></svg></figure>
</div>
</details>
<h2 id="表格"><a class="header" href="#表格">表格</a></h2>
<div class="extended-markdown-table"><div class="extended-markdown-header extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 1; grid-row-end: 2">Macros</div><div class="extended-markdown-header" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 1; grid-row-end: 2">Define</div><div class="extended-markdown-header" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 1; grid-row-end: 2">Usage</div><div class="extended-markdown-header" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 1; grid-row-end: 2">note</div><div class="extended-markdown-header" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 1; grid-row-end: 2">Example</div><div class="extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 2; grid-row-end: 3">Declarative Macro</div><div class="" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 2; grid-row-end: 3">#[macro_export]/macro_rules! macro_name{}</div><div class="" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 2; grid-row-end: 3">macro_name!()</div><div class="" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 2; grid-row-end: 3"></div><div class="" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 2; grid-row-end: 3">println!</div><div class="extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 3; grid-row-end: 4">Function Macro</div><div class="" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 3; grid-row-end: 4">#[proc_macros]/pub fn macro_name</div><div class="" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 3; grid-row-end: 4">macro_name!()</div><div class="" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 3; grid-row-end: 4">advanced declarative macro</div><div class="" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 3; grid-row-end: 4"></div><div class="extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 4; grid-row-end: 5">Derive Macro</div><div class="" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 4; grid-row-end: 5">#[proc_macros_derive(DeriveMacroName)]/pub  fn other_fn_name</div><div class="" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 4; grid-row-end: 5">DeriveMacroName!()</div><div class="" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 4; grid-row-end: 5"></div><div class="" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 4; grid-row-end: 5">#[derive(Debug)]</div><div class="extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 5; grid-row-end: 6">Attritubte Macro</div><div class="" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 5; grid-row-end: 6">#[proc_macros_derive(AttributeMacroName, attributes(attr_name))]/pub  fn other_fn_name</div><div class="" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 5; grid-row-end: 6">Only Diff with DeriveMacro when define struct</div><div class="" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 5; grid-row-end: 6"></div><div class="" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 5; grid-row-end: 6"></div></div>
<h2 id="声明宏declarative-macros-macro_rulesbang"><a class="header" href="#声明宏declarative-macros-macro_rulesbang">声明宏(declarative macros): macro_rules!(bang)</a></h2>
<blockquote>
<p>对代码模版做简单替换
声明宏可以用 macro_rules! 来描述, 如果重复性的代码无法用函数来封装，那么声明宏就是一个好的选择</p>
</blockquote>
<h2 id="声明宏的缺陷而后有了过程宏"><a class="header" href="#声明宏的缺陷而后有了过程宏">声明宏的缺陷，而后有了过程宏</a></h2>
<ul>
<li><a href="https://blog.logrocket.com/macros-in-rust-a-tutorial-with-examples/#limitationsofdeclarativemacros">Macros in Rust: A tutorial with examples - LogRocket Blog</a></li>
</ul>
<details id="admonition-为什么过程宏和声明宏那么像" class="admonition tip">
<summary class="admonition-title">
<p>为什么过程宏和声明宏那么像</p>
<p><a class="admonition-anchor-link" href="#admonition-为什么过程宏和声明宏那么像"></a></p>
</summary>
<div>
<blockquote>
<p>过程宏的缺陷</p>
</blockquote>
<ol>
<li>缺乏对宏自动完成和扩展的支持 </li>
<li>调试声明性宏很困难 </li>
<li>修改能力有限 </li>
<li>较大的二进制文件 </li>
<li>更长的编译时间（这适用于声明性宏和过程宏）</li>
</ol>
<blockquote>
<p>过程宏是语法树级别的转换
过程宏是宏的更高级版本。过程宏允许你扩展现有的 Rust 语法。它接受任意输入并返回有效的 Rust 代码。 
过程宏是将 TokenStream 作为输入并返回另一个 Token Stream 的函数。过程宏操作输入 TokenStream 以产生输出流。</p>
</blockquote>
</div>
</details>
<h2 id="过程宏深度定制与生成代码"><a class="header" href="#过程宏深度定制与生成代码">过程宏：深度定制与生成代码</a></h2>
<details id="admonition-陈天b站视频另外提供详细演示" class="admonition info">
<summary class="admonition-title">
<p>陈天B站视频另外提供详细演示</p>
<p><a class="admonition-anchor-link" href="#admonition-陈天b站视频另外提供详细演示"></a></p>
</summary>
<div>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Za411q7LQ">Rust 过程宏(1): 如何硬生生解析和手写过程宏</a></li>
</ul>
<blockquote>
<p>主要以如何使用 function-like macro 在不依赖于 syn / quote 的情况下，把 Json Schema 在编译期转换成 Rust struct。主要目的是让大家熟悉基本的处理 TokenStream 的思路</p>
</blockquote>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Fu411m7W7">Rust 过程宏(2): 使用 syn/quote 撰写过程宏</a></li>
</ul>
<blockquote>
<p>主要通过一个 derive Builder 宏，来展示使用 syn/quote 如何开发过程宏。</p>
</blockquote>
<ul>
<li><a href="https://www.bilibili.com/video/BV1dr4y1v74n">Rust 过程宏(3): 使用 darling 处理 attributes</a></li>
</ul>
<blockquote>
<p>做个收尾，对上一讲的 derive macro 支持 attributes。 我们可以直接解析 attributes 相关的 TokenStream，也可以使用 darling 这个很方便的库，直接把 attributes 像
Clap/Structopts 那样收集到一个数据结构中，然后再进一步处理。</p>
</blockquote>
</div>
</details>
<details id="admonition-总结" class="admonition info">
<summary class="admonition-title">
<p>总结</p>
<p><a class="admonition-anchor-link" href="#admonition-总结"></a></p>
</summary>
<div>
<p>这三讲的内容虽然简单，但足以应付大家绝大多数宏编程的需求。
其实我们现在对 syn 库的使用还只是一个皮毛，我们还没有深入
去撰写自己的数据结构去实现 Parse trait，像 DeriveInput 
那样可以直接把 TokenStream 转换成我们想要的东西。</p>
<p>大家感兴趣的话，可以自行去看 syn 库的文档。</p>
</div>
</details>
<h3 id="1-函数宏"><a class="header" href="#1-函数宏">1. 函数宏</a></h3>
<details id="admonition-看起来像函数的宏但在编译期进行处理" class="admonition info">
<summary class="admonition-title">
<p>看起来像函数的宏，但在编译期进行处理.</p>
<p><a class="admonition-anchor-link" href="#admonition-看起来像函数的宏但在编译期进行处理"></a></p>
</summary>
<div>
<blockquote>
<p>sqlx 用函数宏来处理SQL query、tokio使用属性宏 #[tokio::main] 来引入 runtime。
它们可以帮助目标代码的实现逻辑变得更加简单， 但一般除非特别必要，否则并不推荐写。
并没有特定的使用场景</p>
</blockquote>
</div>
</details>
<h3 id="2-属性宏"><a class="header" href="#2-属性宏">2. 属性宏</a></h3>
<p>可以在其他代码块上添加属性，为代码块提供更多功能。</p>
<h3 id="3-派生宏"><a class="header" href="#3-派生宏">3. 派生宏</a></h3>
<p>为 derive属性添加新的功能。这是我们平时使用最多的宏，比如 #[derive(Debug)].</p>
<blockquote>
<p>如果你定义的 trait 别人实现起来有固定的模式可循，那么可以考虑为其构建派生宏</p>
</blockquote>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="4_macros.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="4_2_declarative_macros.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="4_macros.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="4_2_declarative_macros.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
