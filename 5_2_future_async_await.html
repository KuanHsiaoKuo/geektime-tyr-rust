<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>å¼‚æ­¥ï¼šFuture/Async/Await - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a></li><li class="chapter-item "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a></li><li class="chapter-item "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a></li><li class="chapter-item "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item expanded "><a href="5_2_future_async_await.html" class="active"><strong aria-hidden="true">4.5.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">4.5.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="future"><a class="header" href="#future">Future</a></h1>
<!--ts-->
<ul>
<li><a href="#future">Future</a>
<ul>
<li><a href="#actor%E6%98%AF%E6%9C%89%E6%A0%88%E5%8D%8F%E7%A8%8Bfuture%E6%98%AF%E6%97%A0%E6%A0%88%E5%8D%8F%E7%A8%8B">actoræ˜¯æœ‰æ ˆåç¨‹ï¼ŒFutureæ˜¯æ— æ ˆåç¨‹</a></li>
<li><a href="#rust%E7%9A%84future">Rustçš„Future</a></li>
<li><a href="#future%E5%92%8Casyncawait">Futureå’Œasync/await</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-future">ä¸ºä»€ä¹ˆéœ€è¦ Futureï¼Ÿ</a></li>
<li><a href="#%E6%B7%B1%E5%85%A5%E6%80%9D%E8%B7%AF">æ·±å…¥æ€è·¯</a></li>
<li><a href="#%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3">æ·±å…¥äº†è§£</a></li>
<li><a href="#executor">executor</a></li>
<li><a href="#reactor-pattern">reactor pattern</a></li>
<li><a href="#%E6%80%8E%E4%B9%88%E7%94%A8-future-%E5%81%9A%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86">æ€ä¹ˆç”¨ Future åšå¼‚æ­¥å¤„ç†ï¼Ÿ</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-future-%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">ä½¿ç”¨ Future çš„æ³¨æ„äº‹é¡¹</a></li>
<li><a href="#%E5%AF%B9%E6%AF%94%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0future">å¯¹æ¯”çº¿ç¨‹å­¦ä¹ Future</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%A0%87%E5%87%86%E5%BA%93%E7%9A%84-mutex-%E4%B8%8D%E8%83%BD%E8%B7%A8%E8%B6%8A-await">ä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„ Mutex ä¸èƒ½è·¨è¶Š awaitï¼Ÿ</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Fri Oct 14 08:06:13 UTC 2022 -->
<!--te-->
<h2 id="actoræ˜¯æœ‰æ ˆåç¨‹futureæ˜¯æ— æ ˆåç¨‹"><a class="header" href="#actoræ˜¯æœ‰æ ˆåç¨‹futureæ˜¯æ— æ ˆåç¨‹">actoræ˜¯æœ‰æ ˆåç¨‹ï¼ŒFutureæ˜¯æ— æ ˆåç¨‹</a></h2>
<details id="admonition-actoræ˜¯æœ‰æ ˆåç¨‹futureæ˜¯æ— æ ˆåç¨‹" class="admonition info">
<summary class="admonition-title">
<p>actoræ˜¯æœ‰æ ˆåç¨‹ï¼ŒFutureæ˜¯æ— æ ˆåç¨‹</p>
<p><a class="admonition-anchor-link" href="#admonition-actoræ˜¯æœ‰æ ˆåç¨‹futureæ˜¯æ— æ ˆåç¨‹"></a></p>
</summary>
<div>
<p>å¾…è¡¥å……</p>
</div>
</details>
<h2 id="rustçš„future"><a class="header" href="#rustçš„future">Rustçš„Future</a></h2>
<details id="admonition-rust-çš„-future-è·Ÿ-javascript-çš„-promisepythonçš„futureéå¸¸ç›¸ä¼¼" class="admonition info">
<summary class="admonition-title">
<p>Rust çš„ Future è·Ÿ JavaScript çš„ Promiseã€Pythonçš„Futureéå¸¸ç›¸ä¼¼</p>
<p><a class="admonition-anchor-link" href="#admonition-rust-çš„-future-è·Ÿ-javascript-çš„-promisepythonçš„futureéå¸¸ç›¸ä¼¼"></a></p>
</summary>
<div>
<p>å…¶å® Rust çš„ Future è·Ÿ JavaScript çš„ Promise éå¸¸ç±»ä¼¼ã€‚</p>
<p>å¦‚æœä½ ç†Ÿæ‚‰ JavaScriptï¼Œåº”è¯¥ç†Ÿæ‚‰ Promise çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨äº†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»æ‰èƒ½å¾—åˆ°çš„ç»“æœçš„å€¼ï¼ŒPromise ä¸€èˆ¬å­˜åœ¨ä¸‰ä¸ªçŠ¶æ€ï¼›</p>
<ol>
<li>ç­‰å¾…ï¼ˆpendingï¼‰çŠ¶æ€</li>
<li>Promise å·²è¿è¡Œï¼Œä½†è¿˜æœªç»“æŸï¼›</li>
<li>ç»“æŸçŠ¶æ€ï¼ŒPromise æˆåŠŸè§£æå‡ºä¸€ä¸ªå€¼ï¼Œæˆ–è€…æ‰§è¡Œå¤±è´¥ã€‚</li>
</ol>
<p>åªä¸è¿‡ JavaScript çš„ Promise å’Œçº¿ç¨‹ç±»ä¼¼ï¼Œä¸€æ—¦åˆ›å»ºå°±å¼€å§‹æ‰§è¡Œï¼Œå¯¹ Promise await åªæ˜¯ä¸ºäº†â€œç­‰å¾…â€å¹¶è·å–è§£æå‡ºæ¥çš„å€¼ï¼›è€Œ Rust çš„ Futureï¼Œåªæœ‰åœ¨ä¸»åŠ¨ await åæ‰å¼€å§‹æ‰§è¡Œã€‚</p>
</div>
</details>
<h2 id="futureå’Œasyncawait"><a class="header" href="#futureå’Œasyncawait">Futureå’Œasync/await</a></h2>
<details id="admonition-ä¸€èˆ¬è€Œè¨€asyncawaitå’Œfutureæ˜¯ä»€ä¹ˆå…³ç³»" class="admonition info">
<summary class="admonition-title">
<p>ä¸€èˆ¬è€Œè¨€ï¼Œasync/awaitå’ŒFutureæ˜¯ä»€ä¹ˆå…³ç³»</p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸€èˆ¬è€Œè¨€asyncawaitå’Œfutureæ˜¯ä»€ä¹ˆå…³ç³»"></a></p>
</summary>
<div>
<p>è®²åˆ°è¿™é‡Œä¼°è®¡ä½ ä¹Ÿçœ‹å‡ºæ¥äº†ï¼Œè°ˆ Future çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ€»ä¼šè°ˆåˆ° async/awaitã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼š</p>
<ol>
<li>async å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡</li>
<li>è€Œ await åˆ™è§¦å‘è¿™ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚</li>
<li>å¤§å¤šæ•°è¯­è¨€ï¼ŒåŒ…æ‹¬ Rustï¼Œasync/await éƒ½æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼ˆsyntactic sugarï¼‰</li>
<li>å®ƒä»¬ä½¿ç”¨çŠ¶æ€æœºå°† Promise/Future è¿™æ ·çš„ç»“æ„åŒ…è£…èµ·æ¥è¿›è¡Œå¤„ç†ã€‚</li>
</ol>
</div>
</details>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦-future"><a class="header" href="#ä¸ºä»€ä¹ˆéœ€è¦-future">ä¸ºä»€ä¹ˆéœ€è¦ Futureï¼Ÿ</a></h2>
<details id="admonition-ä¸ºä»€ä¹ˆéœ€è¦futureé‚£ä¸ç”¨asyncawaitæœ‰ä»€ä¹ˆé—®é¢˜" class="admonition info">
<summary class="admonition-title">
<p>ä¸ºä»€ä¹ˆéœ€è¦Futureï¼Œé‚£ä¸ç”¨async/awaitæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸ºä»€ä¹ˆéœ€è¦futureé‚£ä¸ç”¨asyncawaitæœ‰ä»€ä¹ˆé—®é¢˜"></a></p>
</summary>
<div>
<p>é¦–å…ˆï¼Œè°ˆä¸€è°ˆä¸ºä»€ä¹ˆéœ€è¦ Future è¿™æ ·çš„å¹¶å‘ç»“æ„ã€‚</p>
<p>åœ¨ Future å‡ºç°ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ Rust ä»£ç éƒ½æ˜¯åŒæ­¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<ol>
<li>å½“ä½ æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼ŒCPU å¤„ç†å®Œå‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªæŒ‡ä»¤æ‰ä¼šè¿”å›ã€‚</li>
<li>å¦‚æœè¿™ä¸ªå‡½æ•°é‡Œæœ‰ IO çš„æ“ä½œï¼Œå®é™…ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠå‡½æ•°å¯¹åº”çš„çº¿ç¨‹æŒ‚èµ·ï¼Œæ”¾åœ¨ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­</li>
<li>ç›´åˆ° IO æ“ä½œå®Œæˆï¼Œæ‰æ¢å¤è¿™ä¸ªçº¿ç¨‹ï¼Œå¹¶ä»æŒ‚èµ·çš„ä½ç½®ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</li>
</ol>
<blockquote>
<p>è¿™ä¸ªæ¨¡å‹éå¸¸ç®€å•ç›´è§‚ï¼Œä»£ç æ˜¯ä¸€è¡Œä¸€è¡Œæ‰§è¡Œçš„ï¼Œå¼€å‘è€…å¹¶ä¸éœ€è¦è€ƒè™‘å“ªäº›æ“ä½œä¼šé˜»å¡ï¼Œå“ªäº›ä¸ä¼šï¼Œåªå…³å¿ƒä»–çš„ä¸šåŠ¡é€»è¾‘å°±å¥½ã€‚</p>
</blockquote>
<blockquote>
<p>ç„¶è€Œï¼Œéšç€ CPU æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œæ–°ä¸–çºªåº”ç”¨è½¯ä»¶çš„ä¸»è¦çŸ›ç›¾ä¸å†æ˜¯ CPU ç®—åŠ›ä¸è¶³ï¼Œè€Œæ˜¯è¿‡äºå……æ²›çš„ CPU ç®—åŠ›å’Œæå‡ç¼“æ…¢çš„ IO é€Ÿåº¦ä¹‹é—´çš„çŸ›ç›¾ã€‚å¦‚æœæœ‰å¤§é‡çš„ IO æ“ä½œï¼Œä½ çš„ç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´å¹¶æ²¡æœ‰åœ¨è¿ç®—ï¼Œè€Œæ˜¯åœ¨ä¸æ–­åœ°ç­‰å¾… IOã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use serde_yaml::Value;
use std::fs;

fn main() -&gt; Result&lt;()&gt; {
    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1
    let content1 = fs::read_to_string(&quot;./Cargo.toml&quot;)?;
    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2
    let content2 = fs::read_to_string(&quot;./Cargo.lock&quot;)?;

    // è®¡ç®—
    let yaml1 = toml2yaml(&amp;content1)?;
    let yaml2 = toml2yaml(&amp;content2)?;

    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3
    fs::write(&quot;/tmp/Cargo.yml&quot;, &amp;yaml1)?;
    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4
    fs::write(&quot;/tmp/Cargo.lock&quot;, &amp;yaml2)?;

    // æ‰“å°
    println!(&quot;{}&quot;, yaml1);
    println!(&quot;{}&quot;, yaml2);

    Ok(())
}

fn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {
    let value: Value = toml::from_str(&amp;content)?;
    Ok(serde_yaml::to_string(&amp;value)?)
}
</code></pre></pre>
<blockquote>
<p>è¿™æ®µä»£ç è¯»å– Cargo.toml å’Œ Cargo.lock å°†å…¶è½¬æ¢æˆ yamlï¼Œå†åˆ†åˆ«å†™å…¥åˆ° /tmp ä¸‹ã€‚</p>
</blockquote>
<p>è™½ç„¶è¯´è¿™æ®µä»£ç çš„é€»è¾‘å¹¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ€§èƒ½æœ‰å¾ˆå¤§çš„é—®é¢˜:</p>
<ol>
<li>åœ¨è¯» Cargo.toml æ—¶ï¼Œæ•´ä¸ªä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ° Cargo.toml è¯»å®Œï¼Œæ‰èƒ½ç»§ç»­è¯»ä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„æ–‡ä»¶ã€‚</li>
<li>æ•´ä¸ªä¸»çº¿ç¨‹ï¼Œåªæœ‰åœ¨è¿è¡Œ toml2yaml çš„æ—¶é—´ç‰‡å†…ï¼Œæ‰çœŸæ­£åœ¨æ‰§è¡Œè®¡ç®—ä»»åŠ¡ï¼Œä¹‹å‰çš„è¯»å–æ–‡ä»¶ä»¥åŠä¹‹åçš„å†™å…¥æ–‡ä»¶ï¼ŒCPU éƒ½åœ¨é—²ç½®ã€‚</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/38%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9AFuture%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AE%83%E5%92%8Casyncawait%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%9F-4959308.jpg" alt="38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasyncawaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" /></p>
<p>å½“ç„¶ï¼Œä½ ä¼šè¾©è§£ï¼Œåœ¨è¯»æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ç­‰å¾…ï¼Œå› ä¸º toml2yaml å‡½æ•°çš„æ‰§è¡Œæœ‰èµ–äºè¯»å–æ–‡ä»¶çš„ç»“æœã€‚</p>
<p>å—¯æ²¡é”™ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œè¿˜æœ‰å¾ˆå¤§çš„ CPU æµªè´¹ï¼šæˆ‘ä»¬è¯»å®Œç¬¬ä¸€ä¸ªæ–‡ä»¶æ‰å¼€å§‹è¯»ç¬¬äºŒä¸ªæ–‡ä»¶ï¼Œæœ‰æ²¡æœ‰å¯èƒ½ä¸¤ä¸ªæ–‡ä»¶åŒæ—¶è¯»å–å‘¢ï¼Ÿè¿™æ ·æ€»å…±ç­‰å¾…çš„æ—¶é—´æ˜¯ max(time_for_file1, time_for_file2)ï¼Œè€Œé time_for_file1 + time_for_file2 ã€‚</p>
<p>è¿™å¹¶ä¸éš¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ–‡ä»¶è¯»å–å’Œå†™å…¥çš„æ“ä½œæ”¾å…¥å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ¯”å¦‚ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::{anyhow, Result};
use serde_yaml::Value;
use std::{
    fs,
    thread::{self, JoinHandle},
};

/// åŒ…è£…ä¸€ä¸‹ JoinHandleï¼Œè¿™æ ·å¯ä»¥æä¾›é¢å¤–çš„æ–¹æ³•
struct MyJoinHandle&lt;T&gt;(JoinHandle&lt;Result&lt;T&gt;&gt;);

impl&lt;T&gt; MyJoinHandle&lt;T&gt; {
    /// ç­‰å¾… thread æ‰§è¡Œå®Œï¼ˆç±»ä¼¼ awaitï¼‰
    pub fn thread_await(self) -&gt; Result&lt;T&gt; {
        self.0.join().map_err(|_| anyhow!(&quot;failed&quot;))?
    }
}

fn main() -&gt; Result&lt;()&gt; {
    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1
    let t1 = thread_read(&quot;./Cargo.toml&quot;);
    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2
    let t2 = thread_read(&quot;./Cargo.lock&quot;);

    let content1 = t1.thread_await()?;
    let content2 = t2.thread_await()?;

    // è®¡ç®—
    let yaml1 = toml2yaml(&amp;content1)?;
    let yaml2 = toml2yaml(&amp;content2)?;

    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3
    let t3 = thread_write(&quot;/tmp/Cargo.yml&quot;, yaml1);
    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4
    let t4 = thread_write(&quot;/tmp/Cargo.lock&quot;, yaml2);

    let yaml1 = t3.thread_await()?;
    let yaml2 = t4.thread_await()?;

    fs::write(&quot;/tmp/Cargo.yml&quot;, &amp;yaml1)?;
    fs::write(&quot;/tmp/Cargo.lock&quot;, &amp;yaml2)?;

    // æ‰“å°
    println!(&quot;{}&quot;, yaml1);
    println!(&quot;{}&quot;, yaml2);

    Ok(())
}

fn thread_read(filename: &amp;'static str) -&gt; MyJoinHandle&lt;String&gt; {
    let handle = thread::spawn(move || {
        let s = fs::read_to_string(filename)?;
        Ok::&lt;_, anyhow::Error&gt;(s)
    });
    MyJoinHandle(handle)
}

fn thread_write(filename: &amp;'static str, content: String) -&gt; MyJoinHandle&lt;String&gt; {
    let handle = thread::spawn(move || {
        fs::write(filename, &amp;content)?;
        Ok::&lt;_, anyhow::Error&gt;(content)
    });
    MyJoinHandle(handle)
}

fn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {
    let value: Value = toml::from_str(&amp;content)?;
    Ok(serde_yaml::to_string(&amp;value)?)
}
</code></pre></pre>
<blockquote>
<p>è¿™æ ·ï¼Œè¯»å–æˆ–è€…å†™å…¥å¤šä¸ªæ–‡ä»¶çš„è¿‡ç¨‹å¹¶å‘æ‰§è¡Œï¼Œä½¿ç­‰å¾…çš„æ—¶é—´å¤§å¤§ç¼©çŸ­ã€‚</p>
</blockquote>
<ol>
<li>ä½†æ˜¯ï¼Œå¦‚æœè¦åŒæ—¶è¯»å– 100 ä¸ªæ–‡ä»¶å‘¢ï¼Ÿ</li>
</ol>
<ul>
<li>æ˜¾ç„¶ï¼Œåˆ›å»º 100 ä¸ªçº¿ç¨‹æ¥åšè¿™æ ·çš„äº‹æƒ…ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚</li>
<li>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ï¼Œåˆ›å»º / é˜»å¡ / å”¤é†’ / é”€æ¯çº¿ç¨‹ï¼Œéƒ½æ¶‰åŠä¸å°‘çš„åŠ¨ä½œ</li>
<li>æ¯ä¸ªçº¿ç¨‹ä¹Ÿéƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªä¸å°çš„è°ƒç”¨æ ˆ</li>
<li>æ‰€ä»¥ä» CPU å’Œå†…å­˜çš„è§’åº¦æ¥çœ‹ï¼Œåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ä¼šå¤§å¤§å¢åŠ ç³»ç»Ÿçš„å¼€é”€ã€‚</li>
</ul>
<ol start="2">
<li>å…¶å®ï¼Œç»å¤§å¤šæ•°æ“ä½œç³»ç»Ÿå¯¹ I/O æ“ä½œæä¾›äº†éé˜»å¡æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´: </li>
</ol>
<ul>
<li>ä½ å¯ä»¥å‘èµ·ä¸€ä¸ªè¯»å–çš„æŒ‡ä»¤</li>
<li>è‡ªå·±å¤„ç†ç±»ä¼¼ EWOULDBLOCKè¿™æ ·çš„é”™è¯¯ç </li>
<li>æ¥æ›´å¥½åœ°åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†å¤šä¸ªæ–‡ä»¶çš„ IO</li>
<li>è€Œä¸æ˜¯ä¾èµ–æ“ä½œç³»ç»Ÿé€šè¿‡è°ƒåº¦å¸®ä½ å®Œæˆè¿™ä»¶äº‹ã€‚</li>
</ul>
<ol start="3">
<li>ä¸è¿‡è¿™æ ·å°±æ„å‘³ç€ï¼Œä½ éœ€è¦:</li>
</ol>
<ul>
<li>å®šä¹‰åˆé€‚çš„æ•°æ®ç»“æ„æ¥è¿½è¸ªæ¯ä¸ªæ–‡ä»¶çš„è¯»å–</li>
<li>åœ¨ç”¨æˆ·æ€è¿›è¡Œç›¸åº”çš„è°ƒåº¦</li>
<li>é˜»å¡ç­‰å¾… IO çš„æ•°æ®ç»“æ„çš„è¿è¡Œ</li>
<li>è®©æ²¡æœ‰ç­‰å¾… IO çš„æ•°æ®ç»“æ„å¾—åˆ°æœºä¼šä½¿ç”¨ CPU</li>
<li>ä»¥åŠå½“ IO æ“ä½œç»“æŸåï¼Œæ¢å¤ç­‰å¾… IO çš„æ•°æ®ç»“æ„çš„è¿è¡Œç­‰ç­‰ã€‚</li>
</ul>
<blockquote>
<p>è¿™æ ·çš„æ“ä½œç²’åº¦æ›´å°ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦åˆ©ç”¨ CPU èµ„æºã€‚
è¿™å°±æ˜¯ç±»ä¼¼ Future è¿™æ ·çš„å¹¶å‘ç»“æ„çš„ä¸»è¦ç”¨é€”ã€‚</p>
</blockquote>
<ol start="4">
<li>ç„¶è€Œï¼Œå¦‚æœè¿™ä¹ˆå¤„ç†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·æ€åšå¾ˆå¤šäº‹æƒ…,åŒ…æ‹¬:</li>
</ol>
<ul>
<li>å¤„ç† IO ä»»åŠ¡çš„äº‹ä»¶é€šçŸ¥</li>
<li>åˆ›å»º Future</li>
<li>åˆç†åœ°è°ƒåº¦ Future</li>
</ul>
<blockquote>
<p>è¿™äº›äº‹æƒ…ï¼Œç»Ÿç»Ÿäº¤ç»™å¼€å‘è€…åšæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚æ‰€ä»¥ï¼ŒRust æä¾›äº†ç›¸åº”å¤„ç†æ‰‹æ®µ async/await ï¼š</p>
</blockquote>
<ul>
<li>async æ¥æ–¹ä¾¿åœ°ç”Ÿæˆ Future</li>
<li>await æ¥è§¦å‘ Future çš„è°ƒåº¦å’Œæ‰§è¡Œã€‚</li>
</ul>
<hr />
<p>æˆ‘ä»¬çœ‹çœ‹ï¼ŒåŒæ ·çš„ä»»åŠ¡ï¼Œå¦‚ä½•ç”¨ async/await æ›´é«˜æ•ˆåœ°å¤„ç†ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use serde_yaml::Value;
use tokio::{fs, try_join};

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1
    let f1 = fs::read_to_string(&quot;./Cargo.toml&quot;);
    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2
    let f2 = fs::read_to_string(&quot;./Cargo.lock&quot;);
    let (content1, content2) = try_join!(f1, f2)?;

    // è®¡ç®—
    let yaml1 = toml2yaml(&amp;content1)?;
    let yaml2 = toml2yaml(&amp;content2)?;

    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3
    let f3 = fs::write(&quot;/tmp/Cargo.yml&quot;, &amp;yaml1);
    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4
    let f4 = fs::write(&quot;/tmp/Cargo.lock&quot;, &amp;yaml2);
    try_join!(f3, f4)?;

    // æ‰“å°
    println!(&quot;{}&quot;, yaml1);
    println!(&quot;{}&quot;, yaml2);

    Ok(())
}

fn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {
    let value: Value = toml::from_str(&amp;content)?;
    Ok(serde_yaml::to_string(&amp;value)?)
}
</code></pre></pre>
<p>åœ¨è¿™æ®µä»£ç é‡Œ:</p>
<ol>
<li>æˆ‘ä»¬ä½¿ç”¨äº† tokio::fsï¼Œè€Œä¸æ˜¯ std::fs</li>
<li>tokio::fs çš„æ–‡ä»¶æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ª Futureï¼Œç„¶åå¯ä»¥ join è¿™äº› Futureï¼Œå¾—åˆ°å®ƒä»¬è¿è¡Œåçš„ç»“æœã€‚</li>
<li>join / try_join æ˜¯ç”¨æ¥è½®è¯¢å¤šä¸ª Future çš„å®:</li>
</ol>
<ul>
<li>å®ƒä¼šä¾æ¬¡å¤„ç†æ¯ä¸ª Future</li>
<li>é‡åˆ°é˜»å¡å°±å¤„ç†ä¸‹ä¸€ä¸ª</li>
<li>ç›´åˆ°æ‰€æœ‰ Future äº§ç”Ÿç»“æœã€‚</li>
</ul>
<blockquote>
<p>æ•´ä¸ªç­‰å¾…æ–‡ä»¶è¯»å–çš„æ—¶é—´æ˜¯ max(time_for_file1, time_for_file2)ï¼Œæ€§èƒ½å’Œä½¿ç”¨çº¿ç¨‹çš„ç‰ˆæœ¬å‡ ä¹ä¸€è‡´ï¼Œä½†æ˜¯æ¶ˆè€—çš„èµ„æºï¼ˆä¸»è¦æ˜¯çº¿ç¨‹ï¼‰è¦å°‘å¾ˆå¤šã€‚</p>
</blockquote>
<p>å»ºè®®ä½ å¥½å¥½å¯¹æ¯”è¿™ä¸‰ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œå†™ä¸€å†™ï¼Œè¿è¡Œä¸€ä¸‹ï¼Œæ„Ÿå—å®ƒä»¬çš„å¤„ç†é€»è¾‘ã€‚</p>
<p>æ³¨æ„åœ¨æœ€åçš„ async/await çš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½æŠŠä»£ç å†™æˆè¿™æ ·ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
// è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1
let content1 = fs::read_to_string(&quot;./Cargo.toml&quot;).await?;
// è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2
let content1 = fs::read_to_string(&quot;./Cargo.lock&quot;).await?;
</code></pre></pre>
<p>è¿™æ ·å†™çš„è¯ï¼Œå’Œç¬¬ä¸€ç‰ˆåŒæ­¥çš„ç‰ˆæœ¬æ²¡æœ‰åŒºåˆ«ï¼Œå› ä¸º await ä¼šè¿è¡Œ Future ç›´åˆ° Future æ‰§è¡Œç»“æŸï¼Œæ‰€ä»¥ä¾æ—§æ˜¯å…ˆè¯»å– Cargo.tomlï¼Œå†è¯»å– Cargo.lockï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°å¹¶å‘çš„æ•ˆæœã€‚</p>
</div>
</details>
<h2 id="æ·±å…¥æ€è·¯"><a class="header" href="#æ·±å…¥æ€è·¯">æ·±å…¥æ€è·¯</a></h2>
<details id="admonition-ä»async-fnäº†è§£åˆ°futureçš„æ€è·¯" class="admonition info">
<summary class="admonition-title">
<p>ä»async fnäº†è§£åˆ°futureçš„æ€è·¯</p>
<p><a class="admonition-anchor-link" href="#admonition-ä»async-fnäº†è§£åˆ°futureçš„æ€è·¯"></a></p>
</summary>
<div>
<ol>
<li>æ‹†è§£ async fn æœ‰ç‚¹å¥‡æ€ªçš„è¿”å›å€¼ç»“æ„</li>
<li>æˆ‘ä»¬å­¦ä¹ äº† Reactor pattern</li>
<li>å¤§è‡´äº†è§£äº† tokio å¦‚ä½•é€šè¿‡ executor å’Œ reactor å…±åŒä½œç”¨ï¼Œå®Œæˆ Future çš„è°ƒåº¦ã€æ‰§è¡Œã€é˜»å¡ï¼Œä»¥åŠå”¤é†’ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯ï¼Œç›´åˆ° Future è¿”å› Poll::Ready(T)ã€‚</li>
</ol>
</div>
</details>
<h2 id="æ·±å…¥äº†è§£"><a class="header" href="#æ·±å…¥äº†è§£">æ·±å…¥äº†è§£</a></h2>
<p>å¥½ï¼Œäº†è§£äº† Future åœ¨è½¯ä»¶å¼€å‘ä¸­çš„å¿…è¦æ€§ï¼Œæ¥æ·±å…¥ç ”ç©¶ä¸€ä¸‹ Future/async/awaitã€‚</p>
<details id="admonition-å¼‚æ­¥å‡½æ•°async-fnå…¶å®æ˜¯è¯­æ³•ç³–å®ƒæœ‰ç­‰ä»·å‡½æ•°å†™æ³•" class="admonition info">
<summary class="admonition-title">
<p>å¼‚æ­¥å‡½æ•°ï¼ˆasync fnï¼‰å…¶å®æ˜¯è¯­æ³•ç³–ï¼Œå®ƒæœ‰ç­‰ä»·å‡½æ•°å†™æ³•ã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-å¼‚æ­¥å‡½æ•°async-fnå…¶å®æ˜¯è¯­æ³•ç³–å®ƒæœ‰ç­‰ä»·å‡½æ•°å†™æ³•"></a></p>
</summary>
<div>
<p>åœ¨å‰é¢ä»£ç æ’°å†™è¿‡ç¨‹ä¸­ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œå¼‚æ­¥å‡½æ•°ï¼ˆasync fnï¼‰çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„ impl Future<Output> çš„ç»“æ„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/38%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9AFuture%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AE%83%E5%92%8Casyncawait%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%9F.png" alt="38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasyncawaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" /></p>
<blockquote>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€èˆ¬ä¼šç”¨ impl å…³é”®å­—ä¸ºæ•°æ®ç»“æ„å®ç° traitï¼Œä¹Ÿå°±æ˜¯è¯´æ¥åœ¨ impl å…³é”®å­—åé¢çš„ä¸œè¥¿æ˜¯ä¸€ä¸ª traitï¼Œæ‰€ä»¥ï¼Œæ˜¾ç„¶ Future æ˜¯ä¸€ä¸ª traitï¼Œå¹¶ä¸”è¿˜æœ‰ä¸€ä¸ªå…³è”ç±»å‹ Outputã€‚</p>
</blockquote>
<p>æ¥çœ‹ <a href="https://doc.rust-lang.org/std/future/trait.Future.html">Future çš„å®šä¹‰</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Future {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}

pub enum Poll&lt;T&gt; {
    Ready(T),
    Pending,
}
</code></pre></pre>
<ol>
<li>é™¤äº† Output å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª poll() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å› <a href="https://doc.rust-lang.org/std/future/trait.Future.html">PollSelf::Output</a>ã€‚</li>
<li>è€Œ Poll<T> æ˜¯ä¸ª enumï¼ŒåŒ…å« Ready å’Œ Pending ä¸¤ä¸ªçŠ¶æ€ã€‚</li>
<li>æ˜¾ç„¶ï¼Œå½“ Future è¿”å› Pending çŠ¶æ€æ—¶ï¼Œæ´»è¿˜æ²¡å¹²å®Œï¼Œä½†å¹²ä¸ä¸‹å»äº†ï¼Œéœ€è¦é˜»å¡ä¸€é˜µå­ï¼Œç­‰æŸä¸ªäº‹ä»¶å°†å…¶å”¤é†’ï¼›</li>
<li>å½“ Future è¿”å› Ready çŠ¶æ€æ—¶ï¼ŒFuture å¯¹åº”çš„å€¼å·²ç»å¾—åˆ°ï¼Œæ­¤æ—¶å¯ä»¥è¿”å›äº†ã€‚</li>
</ol>
<blockquote>
<p>ä½ çœ‹ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„æ•°æ®ç»“æ„ï¼Œå°±æ‰˜èµ·äº†åºå¤§çš„ Rust å¼‚æ­¥ async/await å¤„ç†çš„ç”Ÿæ€ã€‚</p>
</blockquote>
<p>å›åˆ° async fn çš„è¿”å›å€¼æˆ‘ä»¬æ¥ç€è¯´ï¼Œæ˜¾ç„¶å®ƒæ˜¯ä¸€ä¸ª impl Future.</p>
<blockquote>
<p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç»™ä¸€ä¸ªæ™®é€šçš„å‡½æ•°è¿”å› impl Future<Output>ï¼Œå®ƒçš„è¡Œä¸ºå’Œ async fn æ˜¯ä¸æ˜¯ä¸€è‡´å‘¢ï¼Ÿ</p>
</blockquote>
<p>æ¥å†™ä¸ªç®€å•çš„å®éªŒï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use futures::executor::block_on;
use std::future::Future;

#[tokio::main]
async fn main() {
    let name1 = &quot;Tyr&quot;.to_string();
    let name2 = &quot;Lindsey&quot;.to_string();

    say_hello1(&amp;name1).await;
    say_hello2(&amp;name2).await;

    // Future é™¤äº†å¯ä»¥ç”¨ await æ¥æ‰§è¡Œå¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥ç”¨ executor æ‰§è¡Œ
    block_on(say_hello1(&amp;name1));
    block_on(say_hello2(&amp;name2));
}

async fn say_hello1(name: &amp;str) -&gt; usize {
    println!(&quot;Hello {}&quot;, name);
    42
}

// async fn å…³é”®å­—ç›¸å½“äºä¸€ä¸ªè¿”å› impl Future&lt;Output&gt; çš„è¯­æ³•ç³–
fn say_hello2&lt;'fut&gt;(name: &amp;'fut str) -&gt; impl Future&lt;Output = usize&gt; + 'fut {
    async move {
        println!(&quot;Hello {}&quot;, name);
        42
    }
}
</code></pre></pre>
<blockquote>
<p>è¿è¡Œè¿™æ®µä»£ç ä½ ä¼šå‘ç°ï¼Œsay_hello1 å’Œ say_hello2 æ˜¯ç­‰ä»·çš„ï¼ŒäºŒè€…éƒ½å¯ä»¥ä½¿ç”¨ await æ¥æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å°†å…¶æä¾›ç»™ä¸€ä¸ª executor æ¥æ‰§è¡Œã€‚</p>
</blockquote>
</div>
</details>
<h2 id="executor"><a class="header" href="#executor">executor</a></h2>
<details id="admonition-executoræ˜¯ä»€ä¹ˆ--rustå¦‚ä½•æ”¯æŒ-rustå¸¸ç”¨çš„executoræœ‰å“ªäº›" class="admonition info">
<summary class="admonition-title">
<p>executoræ˜¯ä»€ä¹ˆ-&gt; Rustå¦‚ä½•æ”¯æŒ-&gt;Rustå¸¸ç”¨çš„executoræœ‰å“ªäº›ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-executoræ˜¯ä»€ä¹ˆ--rustå¦‚ä½•æ”¯æŒ-rustå¸¸ç”¨çš„executoræœ‰å“ªäº›"></a></p>
</summary>
<div>
<p>è¿™é‡Œæˆ‘ä»¬è§åˆ°äº†ä¸€ä¸ªæ–°çš„åè¯ï¼šexecutorã€‚</p>
<p>ä»€ä¹ˆæ˜¯ executorï¼Ÿ</p>
<ol>
<li>ä½ å¯ä»¥æŠŠ executor å¤§è‡´æƒ³è±¡æˆä¸€ä¸ª Future çš„è°ƒåº¦å™¨ã€‚</li>
<li>å¯¹äºçº¿ç¨‹æ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£è°ƒåº¦ï¼›</li>
<li>ä½†æ“ä½œç³»ç»Ÿä¸ä¼šå»è°ƒåº¦ç”¨æˆ·æ€çš„åç¨‹ï¼ˆæ¯”å¦‚ Futureï¼‰ï¼Œæ‰€ä»¥ä»»ä½•ä½¿ç”¨äº†åç¨‹æ¥å¤„ç†å¹¶å‘çš„ç¨‹åºï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ª executor æ¥è´Ÿè´£åç¨‹çš„è°ƒåº¦ã€‚</li>
</ol>
<p>å¾ˆå¤šåœ¨è¯­è¨€å±‚é¢æ”¯æŒåç¨‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ¯”å¦‚ Golang / Erlangï¼Œéƒ½è‡ªå¸¦ä¸€ä¸ªç”¨æˆ·æ€çš„è°ƒåº¦å™¨ã€‚</p>
<p>Rust è™½ç„¶ä¹Ÿæä¾› Future è¿™æ ·çš„åç¨‹ï¼Œä½†å®ƒåœ¨è¯­è¨€å±‚é¢å¹¶ä¸æä¾› executorï¼ŒæŠŠè¦ä¸è¦ä½¿ç”¨ executor å’Œä½¿ç”¨ä»€ä¹ˆæ ·çš„ executor çš„è‡ªä¸»æƒäº¤ç»™äº†å¼€å‘è€…ã€‚</p>
<ul>
<li>å¥½å¤„æ˜¯ï¼Œå½“æˆ‘çš„ä»£ç ä¸­ä¸éœ€è¦ä½¿ç”¨åç¨‹æ—¶ï¼Œä¸éœ€è¦å¼•å…¥ä»»ä½•è¿è¡Œæ—¶ï¼›</li>
<li>è€Œéœ€è¦ä½¿ç”¨åç¨‹æ—¶ï¼Œå¯ä»¥åœ¨ç”Ÿæ€ç³»ç»Ÿä¸­é€‰æ‹©æœ€åˆé€‚æˆ‘åº”ç”¨çš„ executorã€‚</li>
</ul>
<hr />
<p>å¸¸è§çš„ executor æœ‰ï¼š</p>
<ol>
<li>futures åº“è‡ªå¸¦çš„å¾ˆç®€å•çš„ executorï¼Œä¸Šé¢çš„ä»£ç å°±ä½¿ç”¨äº†å®ƒçš„ block_on å‡½æ•°ï¼›</li>
<li>tokio æä¾›çš„ executorï¼Œå½“ä½¿ç”¨ #[tokio::main] æ—¶ï¼Œå°±éšå«å¼•å…¥äº† tokio çš„ executorï¼›</li>
<li><a href="https://github.com/async-rs/async-std">async-std</a> æä¾›çš„ executorï¼Œå’Œ tokio ç±»ä¼¼ï¼›</li>
<li><a href="https://github.com/smol-rs/smol">smol æä¾›çš„ async-executor</a>ï¼Œä¸»è¦æä¾›äº† block_onã€‚</li>
</ol>
<p>æ³¨æ„ï¼Œä¸Šé¢çš„ä»£ç æˆ‘ä»¬æ··ç”¨äº† #[tokio::main] å’Œ futures:executor::block_onï¼Œè¿™åªæ˜¯ä¸ºäº†å±•ç¤º Future ä½¿ç”¨çš„ä¸åŒæ–¹å¼ï¼Œåœ¨æ­£å¼ä»£ç é‡Œï¼Œä¸å»ºè®®æ··ç”¨ä¸åŒçš„ executorï¼Œä¼šé™ä½ç¨‹åºçš„æ€§èƒ½ï¼Œè¿˜å¯èƒ½å¼•å‘å¥‡æ€ªçš„é—®é¢˜ã€‚</p>
</div>
</details>
<h2 id="reactor-pattern"><a class="header" href="#reactor-pattern">reactor pattern</a></h2>
<details id="admonition-reactor-patternå¦‚ä½•ç»„æˆ" class="admonition info">
<summary class="admonition-title">
<p>Reactor Patternå¦‚ä½•ç»„æˆï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-reactor-patternå¦‚ä½•ç»„æˆ"></a></p>
</summary>
<div>
<p>å½“æˆ‘ä»¬è°ˆåˆ° executor æ—¶ï¼Œå°±ä¸å¾—ä¸æ reactorï¼Œå®ƒä¿©éƒ½æ˜¯ Reactor Pattern çš„ç»„æˆéƒ¨åˆ†ï¼Œä½œä¸ºæ„å»ºé«˜æ€§èƒ½äº‹ä»¶é©±åŠ¨ç³»ç»Ÿçš„ä¸€ä¸ªå¾ˆå…¸å‹æ¨¡å¼ï¼ŒReactor pattern å®ƒåŒ…å«ä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>taskï¼Œå¾…å¤„ç†çš„ä»»åŠ¡</li>
</ol>
<p>ä»»åŠ¡å¯ä»¥è¢«æ‰“æ–­ï¼Œå¹¶ä¸”æŠŠæ§åˆ¶æƒäº¤ç»™ executorï¼Œç­‰å¾…ä¹‹åçš„è°ƒåº¦ï¼›</p>
<ol start="2">
<li>executorï¼Œä¸€ä¸ªè°ƒåº¦å™¨ã€‚</li>
</ol>
<p>ç»´æŠ¤ç­‰å¾…è¿è¡Œçš„ä»»åŠ¡ï¼ˆready queueï¼‰ï¼Œä»¥åŠè¢«é˜»å¡çš„ä»»åŠ¡ï¼ˆwait queueï¼‰ï¼›</p>
<ol start="3">
<li>reactorï¼Œç»´æŠ¤äº‹ä»¶é˜Ÿåˆ—ã€‚</li>
</ol>
<p>å½“äº‹ä»¶æ¥ä¸´æ—¶ï¼Œé€šçŸ¥ executor å”¤é†’æŸä¸ªä»»åŠ¡ç­‰å¾…è¿è¡Œã€‚</p>
<ul>
<li>executor ä¼šè°ƒåº¦æ‰§è¡Œå¾…å¤„ç†çš„ä»»åŠ¡ï¼Œå½“ä»»åŠ¡æ— æ³•ç»§ç»­è¿›è¡Œå´åˆæ²¡æœ‰å®Œæˆæ—¶ï¼Œå®ƒä¼šæŒ‚èµ·ä»»åŠ¡ï¼Œå¹¶è®¾ç½®å¥½åˆé€‚çš„å”¤é†’æ¡ä»¶ã€‚</li>
<li>ä¹‹åï¼Œå¦‚æœ reactor å¾—åˆ°äº†æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶ï¼Œå®ƒä¼šå”¤é†’ä¹‹å‰æŒ‚èµ·çš„ä»»åŠ¡ï¼Œç„¶å executor å°±æœ‰æœºä¼šç»§ç»­æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚</li>
<li>è¿™æ ·ä¸€ç›´å¾ªç¯ä¸‹å»ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</li>
</ul>
</div>
</details>
<h2 id="æ€ä¹ˆç”¨-future-åšå¼‚æ­¥å¤„ç†"><a class="header" href="#æ€ä¹ˆç”¨-future-åšå¼‚æ­¥å¤„ç†">æ€ä¹ˆç”¨ Future åšå¼‚æ­¥å¤„ç†ï¼Ÿ</a></h2>
<details id="admonition-rustå¦‚ä½•åŸºäºreactor-patternä½¿ç”¨futureåšå¼‚æ­¥å¤„ç†" class="admonition info">
<summary class="admonition-title">
<p>Rustå¦‚ä½•åŸºäºReactor patternä½¿ç”¨Futureåšå¼‚æ­¥å¤„ç†</p>
<p><a class="admonition-anchor-link" href="#admonition-rustå¦‚ä½•åŸºäºreactor-patternä½¿ç”¨futureåšå¼‚æ­¥å¤„ç†"></a></p>
</summary>
<div>
<p>ç†è§£äº† Reactor pattern åï¼ŒRust ä½¿ç”¨ Future åšå¼‚æ­¥å¤„ç†çš„æ•´ä¸ªç»“æ„å°±æ¸…æ™°äº†ï¼Œæˆ‘ä»¬ä»¥ tokio ä¸ºä¾‹ï¼š</p>
<ol>
<li>async/await æä¾›è¯­æ³•å±‚é¢çš„æ”¯æŒ</li>
<li>Future æ˜¯å¼‚æ­¥ä»»åŠ¡çš„æ•°æ®ç»“æ„</li>
<li>å½“ fut.await æ—¶ï¼Œexecutor å°±ä¼šè°ƒåº¦å¹¶æ‰§è¡Œå®ƒã€‚</li>
</ol>
<hr />
<ul>
<li>tokio çš„è°ƒåº¦å™¨ï¼ˆexecutorï¼‰ä¼šè¿è¡Œåœ¨å¤šä¸ªçº¿ç¨‹ä¸Šï¼Œè¿è¡Œçº¿ç¨‹è‡ªå·±çš„ ready queue ä¸Šçš„ä»»åŠ¡ï¼ˆFutureï¼‰</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œå°±å»åˆ«çš„çº¿ç¨‹çš„è°ƒåº¦å™¨ä¸Šâ€œå·â€ä¸€äº›è¿‡æ¥è¿è¡Œã€‚</li>
<li>å½“æŸä¸ªä»»åŠ¡æ— æ³•å†ç»§ç»­å–å¾—è¿›å±•ï¼Œæ­¤æ—¶ Future è¿è¡Œçš„ç»“æœæ˜¯ Poll::Pendingï¼Œé‚£ä¹ˆè°ƒåº¦å™¨ä¼šæŒ‚èµ·ä»»åŠ¡ï¼Œå¹¶è®¾ç½®å¥½åˆé€‚çš„å”¤é†’æ¡ä»¶ï¼ˆWakerï¼‰ï¼Œç­‰å¾…è¢« reactor å”¤é†’ã€‚</li>
<li>è€Œ reactor ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„å¼‚æ­¥ I/Oï¼Œæ¯”å¦‚ epoll / kqueue / IOCPï¼Œæ¥ç›‘å¬æ“ä½œç³»ç»Ÿæä¾›çš„ IO äº‹ä»¶ï¼Œå½“é‡åˆ°æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶æ—¶ï¼Œå°±ä¼šè°ƒç”¨ Waker.wake() å”¤é†’è¢«æŒ‚èµ·çš„ Futureã€‚è¿™ä¸ª Future ä¼šå›åˆ° ready queue ç­‰å¾…æ‰§è¡Œã€‚</li>
</ul>
<hr />
<p>æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p>
<h2 id=""><a class="header" href="#"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/38%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9AFuture%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AE%83%E5%92%8Casyncawait%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%9F.jpg" alt="38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasyncawaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" /></a></h2>
<p>æˆ‘ä»¬ä»¥ä¸€ä¸ªå…·ä½“çš„ä»£ç ç¤ºä¾‹æ¥è¿›ä¸€æ­¥ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use futures::{SinkExt, StreamExt};
use tokio::net::TcpListener;
use tokio_util::codec::{Framed, LinesCodec};

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let addr = &quot;0.0.0.0:8080&quot;;
    let listener = TcpListener::bind(addr).await?;
    println!(&quot;listen to: {}&quot;, addr);
    loop {
        let (stream, addr) = listener.accept().await?;
        println!(&quot;Accepted: {:?}&quot;, addr);
        tokio::spawn(async move {
            // ä½¿ç”¨ LinesCodec æŠŠ TCP æ•°æ®åˆ‡æˆä¸€è¡Œè¡Œå­—ç¬¦ä¸²å¤„ç†
            let framed = Framed::new(stream, LinesCodec::new());
            // split æˆ writer å’Œ reader
            let (mut w, mut r) = framed.split();
            for line in r.next().await {
                // æ¯è¯»åˆ°ä¸€è¡Œå°±åŠ ä¸ªå‰ç¼€å‘å›
                w.send(format!(&quot;I got: {}&quot;, line?)).await?;
            }
            Ok::&lt;_, anyhow::Error&gt;(())
        });
    }
}
</code></pre></pre>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ TCP æœåŠ¡å™¨:</p>
<ol>
<li>æœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°±ä¼šç”¨<a href="https://docs.rs/tokio/1.13.0/tokio/fn.spawn.html"> tokio::spawn </a>åˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæ”¾å…¥ executor ä¸­æ‰§è¡Œã€‚</li>
<li>è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡æ¥å—å®¢æˆ·ç«¯å‘æ¥çš„æŒ‰è¡Œåˆ†éš”ï¼ˆåˆ†éš”ç¬¦æ˜¯ â€œ\r\nâ€ï¼‰çš„æ•°æ®å¸§ï¼ŒæœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€è¡Œï¼Œå°±åŠ ä¸ªå‰ç¼€æŠŠå†…å®¹ä¹ŸæŒ‰è¡Œå‘å›ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>ä½ å¯ä»¥ç”¨ telnet å’Œè¿™ä¸ªæœåŠ¡å™¨äº¤äº’ï¼š</li>
</ol>
<pre><code class="language-shell">â¯ telnet localhost 8080
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
hello
I got: hello
Connection closed by foreign host.
</code></pre>
<ul>
<li>å‡è®¾æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯è¾“å…¥äº†å¾ˆå¤§çš„ä¸€è¡Œæ•°æ®ï¼ŒæœåŠ¡å™¨åœ¨åš r.next().await åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œæ”¶ä¸å®Œä¸€è¡Œçš„æ•°æ®ï¼Œå› è€Œè¿™ä¸ª Future è¿”å› Poll::Pendingï¼Œæ­¤æ—¶å®ƒè¢«æŒ‚èµ·ã€‚</li>
<li>å½“åç»­å®¢æˆ·ç«¯çš„æ•°æ®åˆ°è¾¾æ—¶ï¼Œreactor ä¼šçŸ¥é“è¿™ä¸ª socket ä¸Šåˆæœ‰æ•°æ®äº†ï¼Œäºæ˜¯æ‰¾åˆ° socket å¯¹åº”çš„ Futureï¼Œå°†å…¶å”¤é†’ï¼Œç»§ç»­æ¥æ”¶æ•°æ®ã€‚</li>
<li>è¿™æ ·åå¤ä¸‹å»ï¼Œæœ€ç»ˆ r.next().await å¾—åˆ° Poll::Ready(Ok(line))ï¼Œäºæ˜¯å®ƒè¿”å› Ok(line)ï¼Œç¨‹åºç»§ç»­å¾€ä¸‹èµ°ï¼Œè¿›å…¥åˆ° w.send() çš„é˜¶æ®µã€‚</li>
</ul>
<blockquote>
<p>ä»è¿™æ®µä»£ç ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Rust ä¸‹ä½¿ç”¨å¼‚æ­¥å¤„ç†æ˜¯ä¸€ä»¶éå¸¸ç®€å•çš„äº‹æƒ…</p>
</blockquote>
<ol>
<li>é™¤äº†å‡ ä¸ªä½ å¯èƒ½ä¸å¤ªç†Ÿæ‚‰çš„æ¦‚å¿µ:</li>
</ol>
<ul>
<li>æ¯”å¦‚ç”¨äºåˆ›å»º Future çš„ async å…³é”®å­—</li>
<li>ç”¨äºæ‰§è¡Œå’Œç­‰å¾… Future æ‰§è¡Œå®Œæ¯•çš„ await å…³é”®å­—</li>
<li>ä»¥åŠç”¨äºè°ƒåº¦ Future æ‰§è¡Œçš„è¿è¡Œæ—¶ #[tokio:main] </li>
</ul>
<ol start="2">
<li>æ•´ä½“çš„ä»£ç å’Œä½¿ç”¨çº¿ç¨‹å¤„ç†çš„ä»£ç å®Œå…¨ä¸€è‡´ã€‚æ‰€ä»¥ï¼Œå®ƒçš„ä¸Šæ‰‹éš¾åº¦éå¸¸ä½ï¼Œå¾ˆå®¹æ˜“ä½¿ç”¨ã€‚</li>
</ol>
</div>
</details>
<h2 id="ä½¿ç”¨-future-çš„æ³¨æ„äº‹é¡¹"><a class="header" href="#ä½¿ç”¨-future-çš„æ³¨æ„äº‹é¡¹">ä½¿ç”¨ Future çš„æ³¨æ„äº‹é¡¹</a></h2>
<details id="admonition-ä½¿ç”¨futureå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ä¸‰ä¸ªæ³¨æ„äº‹é¡¹" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨Futureå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ä¸‰ä¸ªæ³¨æ„äº‹é¡¹</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½¿ç”¨futureå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ä¸‰ä¸ªæ³¨æ„äº‹é¡¹"></a></p>
</summary>
<div>
<p>ç›®å‰æˆ‘ä»¬å·²ç»åŸºæœ¬æ˜ç™½ Future è¿è¡Œçš„åŸºæœ¬åŸç†äº†ï¼Œä¹Ÿå¯ä»¥åœ¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†è‡ªå¦‚åœ°ä½¿ç”¨ Future/async/await æ¥è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚</p>
<p>ä½†æ˜¯è¦æ³¨æ„ï¼Œä¸æ˜¯æ‰€æœ‰çš„åº”ç”¨åœºæ™¯éƒ½é€‚åˆç”¨ async/awaitï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæœ‰ä¸€äº›ä¸å®¹æ˜“æ³¨æ„åˆ°çš„å‘éœ€è¦æˆ‘ä»¬å¦¥å–„è€ƒè™‘ã€‚</p>
<ol>
<li>å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ—¶</li>
</ol>
<p>å½“ä½ è¦å¤„ç†çš„ä»»åŠ¡æ˜¯ CPU å¯†é›†å‹ï¼Œè€Œé IO å¯†é›†å‹ï¼Œæ›´é€‚åˆä½¿ç”¨çº¿ç¨‹ï¼Œè€Œé Futureã€‚</p>
<p>è¿™æ˜¯å› ä¸º Future çš„è°ƒåº¦æ˜¯åä½œå¼å¤šä»»åŠ¡ï¼ˆCooperative Multitaskingï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤é Future ä¸»åŠ¨æ”¾å¼ƒ CPUï¼Œä¸ç„¶å®ƒå°±ä¼šä¸€ç›´è¢«æ‰§è¡Œï¼Œç›´åˆ°è¿è¡Œç»“æŸã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use std::time::Duration;

// å¼ºåˆ¶ tokio åªä½¿ç”¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè¿™æ · task 2 ä¸ä¼šè·‘åˆ°å…¶å®ƒçº¿ç¨‹æ‰§è¡Œ
#[tokio::main(worker_threads = 1)]
async fn main() -&gt; Result&lt;()&gt; {
    // å…ˆå¼€å§‹æ‰§è¡Œ task 1 çš„è¯ä¼šé˜»å¡ï¼Œè®© task 2 æ²¡æœ‰æœºä¼šè¿è¡Œ
    tokio::spawn(async move {
        eprintln!(&quot;task 1&quot;);
        // è¯•è¯•æŠŠè¿™å¥æ³¨é‡Šæ‰çœ‹çœ‹ä¼šäº§ç”Ÿä»€ä¹ˆç»“æœ
        // tokio::time::sleep(Duration::from_millis(1)).await;
        loop {}
    });

    tokio::spawn(async move {
        eprintln!(&quot;task 2&quot;);
    });

    tokio::time::sleep(Duration::from_millis(1)).await;
    Ok(())
}
</code></pre></pre>
<p>task 1 é‡Œæœ‰ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ˜¯æ‰§è¡Œæ—¶é—´å¾ˆé•¿åˆä¸åŒ…æ‹¬ IO å¤„ç†çš„ä»£ç ã€‚è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå‘ç°ï¼Œtask 2 æ²¡æœ‰æœºä¼šå¾—åˆ°æ‰§è¡Œã€‚è¿™æ˜¯å› ä¸º task 1 ä¸æ‰§è¡Œç»“æŸï¼Œæˆ–è€…ä¸è®©å‡º CPUï¼Œtask 2 æ²¡æœ‰æœºä¼šè¢«è°ƒåº¦ã€‚</p>
<ol start="2">
<li>å¼‚æ­¥ä»£ç ä¸­ä½¿ç”¨ Mutex æ—¶</li>
</ol>
<p>å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæ ‡å‡†åº“çš„ Mutex å¯ä»¥ç”¨åœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œè€Œä¸”ï¼Œè¿™æ˜¯æ¨èçš„ç”¨æ³•ã€‚</p>
<p>ç„¶è€Œï¼Œæ ‡å‡†åº“çš„ MutexGuard ä¸èƒ½å®‰å…¨åœ°è·¨è¶Š awaitï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬éœ€è¦è·å¾—é”ä¹‹åæ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå¿…é¡»ä½¿ç”¨ tokio è‡ªå¸¦çš„ Mutexï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use std::{sync::Arc, time::Duration};
use tokio::sync::Mutex;

struct DB;

impl DB {
    // å‡è£…åœ¨ commit æ•°æ®
    async fn commit(&amp;mut self) -&gt; Result&lt;usize&gt; {
        Ok(42)
    }
}

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let db1 = Arc::new(Mutex::new(DB));
    let db2 = Arc::clone(&amp;db1);

    tokio::spawn(async move {
        let mut db = db1.lock().await;
        // å› ä¸ºæ‹¿åˆ°çš„ MutexGuard è¦è·¨è¶Š awaitï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ std::sync::Mutex
        // åªèƒ½ç”¨ tokio::sync::Mutex
        let affected = db.commit().await?;
        println!(&quot;db1: Total affected rows: {}&quot;, affected);
        Ok::&lt;_, anyhow::Error&gt;(())
    });

    tokio::spawn(async move {
        let mut db = db2.lock().await;
        let affected = db.commit().await?;
        println!(&quot;db2: Total affected rows: {}&quot;, affected);

        Ok::&lt;_, anyhow::Error&gt;(())
    });

    // è®©ä¸¤ä¸ª task æœ‰æœºä¼šæ‰§è¡Œå®Œ
    tokio::time::sleep(Duration::from_millis(1)).await;

    Ok(())
}
</code></pre></pre>
<blockquote>
<p>è¿™ä¸ªä¾‹å­æ¨¡æ‹Ÿäº†ä¸€ä¸ªæ•°æ®åº“çš„å¼‚æ­¥ commit() æ“ä½œ</p>
</blockquote>
<ul>
<li>å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨å¤šä¸ª tokio task ä¸­ä½¿ç”¨è¿™ä¸ª DBï¼Œéœ€è¦ä½¿ç”¨ Arc&lt;Mutext<DB>&gt;ã€‚</li>
<li>ç„¶è€Œï¼Œdb1.lock() æ‹¿åˆ°é”åï¼Œæˆ‘ä»¬éœ€è¦è¿è¡Œ db.commit().awaitï¼Œè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚</li>
<li>å‰é¢è®²è¿‡ï¼Œå› ä¸º tokio å®ç°äº† work-stealing è°ƒåº¦ï¼ŒFuture æœ‰å¯èƒ½åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ™®é€šçš„ MutexGuard ç¼–è¯‘ç›´æ¥å°±ä¼šå‡ºé”™ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ tokio çš„ Mutexã€‚<a href="https://docs.rs/tokio/1.13.0/tokio/sync/struct.Mutex.html">æ›´å¤šä¿¡æ¯å¯ä»¥çœ‹æ–‡æ¡£</a>ã€‚</li>
</ul>
<blockquote>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬åˆè§è¯†åˆ°äº† Rust ç¼–è¯‘å™¨çš„ä¼Ÿå¤§ä¹‹å¤„ï¼šå¦‚æœä¸€ä»¶äº‹ï¼Œå®ƒè§‰å¾—ä½ ä¸èƒ½åšï¼Œä¼šé€šè¿‡ç¼–è¯‘å™¨é”™è¯¯é˜»æ­¢ä½ ï¼Œè€Œä¸æ˜¯ä»»ç”±ç¼–è¯‘é€šè¿‡ï¼Œç„¶åè®©ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¬å¤©ç”±å‘½ï¼Œè®©ä½ æ— ä¼‘æ­¢åœ°å’Œæ‰æ‘¸ä¸å®šçš„å¹¶å‘ bug æ–—äº‰ã€‚</p>
</blockquote>
<ol start="3">
<li>åœ¨çº¿ç¨‹å’Œå¼‚æ­¥ä»»åŠ¡é—´åšåŒæ­¥æ—¶</li>
</ol>
<p>åœ¨ä¸€ä¸ªå¤æ‚çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä¼šå…¼æœ‰è®¡ç®—å¯†é›†å’Œ IO å¯†é›†çš„ä»»åŠ¡ã€‚</p>
<p>å‰é¢è¯´äº†ï¼Œè¦é¿å…åœ¨ tokio è¿™æ ·çš„å¼‚æ­¥è¿è¡Œæ—¶ä¸­è¿è¡Œå¤§é‡è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œä¸€æ¥æ•ˆç‡ä¸é«˜ï¼ŒäºŒæ¥è¿˜å®¹æ˜“é¥¿æ­»å…¶å®ƒä»»åŠ¡ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯æˆ‘ä»¬ä½¿ç”¨ channel æ¥åœ¨çº¿ç¨‹å’Œ future ä¸¤è€…ä¹‹é—´åšåŒæ­¥ã€‚çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::thread;

use anyhow::Result;
use blake3::Hasher;
use futures::{SinkExt, StreamExt};
use rayon::prelude::*;
use tokio::{
    net::TcpListener,
    sync::{mpsc, oneshot},
};
use tokio_util::codec::{Framed, LinesCodec};

pub const PREFIX_ZERO: &amp;[u8] = &amp;[0, 0, 0];

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let addr = &quot;0.0.0.0:8080&quot;;
    let listener = TcpListener::bind(addr).await?;
    println!(&quot;listen to: {}&quot;, addr);

    // åˆ›å»º tokio task å’Œ thread ä¹‹é—´çš„ channel
    let (sender, mut receiver) = mpsc::unbounded_channel::&lt;(String, oneshot::Sender&lt;String&gt;)&gt;();

    // ä½¿ç”¨ thread å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡
    thread::spawn(move || {
        // è¯»å–ä» tokio task è¿‡æ¥çš„ msgï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ blocking_recvï¼Œè€Œé await
        while let Some((line, reply)) = receiver.blocking_recv() {
            // è®¡ç®— pow
            let result = match pow(&amp;line) {
                Some((hash, nonce)) =&gt; format!(&quot;hash: {}, once: {}&quot;, hash, nonce),
                None =&gt; &quot;Not found&quot;.to_string(),
            };
            // æŠŠè®¡ç®—ç»“æœä» oneshot channel é‡Œå‘å›
            if let Err(e) = reply.send(result) {
                println!(&quot;Failed to send: {}&quot;, e);
            }
        }
    });

    // ä½¿ç”¨ tokio task å¤„ç† IO å¯†é›†å‹ä»»åŠ¡
    loop {
        let (stream, addr) = listener.accept().await?;
        println!(&quot;Accepted: {:?}&quot;, addr);
        let sender1 = sender.clone();
        tokio::spawn(async move {
            // ä½¿ç”¨ LinesCodec æŠŠ TCP æ•°æ®åˆ‡æˆä¸€è¡Œè¡Œå­—ç¬¦ä¸²å¤„ç†
            let framed = Framed::new(stream, LinesCodec::new());
            // split æˆ writer å’Œ reader
            let (mut w, mut r) = framed.split();
            for line in r.next().await {
                // ä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ›å»ºä¸€ä¸ª oneshot channelï¼Œç”¨äºå‘é€å›å¤
                let (reply, reply_receiver) = oneshot::channel();
                sender1.send((line?, reply))?;

                // æ¥æ”¶ pow è®¡ç®—å®Œæˆåçš„ hash å’Œ nonce
                if let Ok(v) = reply_receiver.await {
                    w.send(format!(&quot;Pow calculated: {}&quot;, v)).await?;
                }
            }
            Ok::&lt;_, anyhow::Error&gt;(())
        });
    }
}

// ä½¿ç”¨ rayon å¹¶å‘è®¡ç®— u32 ç©ºé—´ä¸‹æ‰€æœ‰ nonceï¼Œç›´åˆ°æ‰¾åˆ°æœ‰å¤´ N ä¸ª 0 çš„å“ˆå¸Œ
pub fn pow(s: &amp;str) -&gt; Option&lt;(String, u32)&gt; {
    let hasher = blake3_base_hash(s.as_bytes());
    let nonce = (0..u32::MAX).into_par_iter().find_any(|n| {
        let hash = blake3_hash(hasher.clone(), n).as_bytes().to_vec();
        &amp;hash[..PREFIX_ZERO.len()] == PREFIX_ZERO
    });
    nonce.map(|n| {
        let hash = blake3_hash(hasher, &amp;n).to_hex().to_string();
        (hash, n)
    })
}

// è®¡ç®—æºå¸¦ nonce åçš„å“ˆå¸Œ
fn blake3_hash(mut hasher: blake3::Hasher, nonce: &amp;u32) -&gt; blake3::Hash {
    hasher.update(&amp;nonce.to_be_bytes()[..]);
    hasher.finalize()
}

// è®¡ç®—æ•°æ®çš„å“ˆå¸Œ
fn blake3_base_hash(data: &amp;[u8]) -&gt; Hasher {
    let mut hasher = Hasher::new();
    hasher.update(data);
    hasher
}
</code></pre></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œ:</p>
<ol>
<li>æˆ‘ä»¬ä½¿ç”¨äº†ä¹‹å‰æ’°å†™çš„ TCP server</li>
<li>åªä¸è¿‡è¿™æ¬¡ï¼Œå®¢æˆ·ç«¯è¾“å…¥è¿‡æ¥çš„ä¸€è¡Œæ–‡å­—ï¼Œä¼šè¢«è®¡ç®—å‡ºä¸€ä¸ª POWï¼ˆProof of Workï¼‰çš„å“ˆå¸Œ</li>
<li>è°ƒæ•´ nonceï¼Œä¸æ–­è®¡ç®—å“ˆå¸Œï¼Œç›´åˆ°å“ˆå¸Œçš„å¤´ä¸‰ä¸ªå­—èŠ‚å…¨æ˜¯é›¶ä¸ºæ­¢ã€‚</li>
<li>æœåŠ¡å™¨è¦è¿”å›è®¡ç®—å¥½çš„å“ˆå¸Œå’Œè·å¾—è¯¥å“ˆå¸Œçš„ nonceã€‚</li>
<li>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨çº¿ç¨‹æ¥å¤„ç†å®ƒã€‚</li>
<li>è€Œåœ¨ tokio task å’Œ thread é—´ä½¿ç”¨ channel è¿›è¡ŒåŒæ­¥ã€‚æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª ubounded MPSC channel ä» tokio task ä¾§å¾€ thread ä¾§å‘é€æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½é™„å¸¦ä¸€ä¸ª oneshot channel ç”¨äº thread ä¾§å¾€ tokio task ä¾§å‘é€æ•°æ®ã€‚</li>
</ol>
<blockquote>
<p>å»ºè®®ä½ ä»”ç»†è¯»è¯»è¿™æ®µä»£ç ï¼Œæœ€å¥½è‡ªå·±å†™ä¸€éï¼Œæ„Ÿå—ä¸€ä¸‹ä½¿ç”¨ channel åœ¨è®¡ç®—å¯†é›†å‹å’Œ IO å¯†é›†å‹ä»»åŠ¡åŒæ­¥çš„æ–¹å¼ã€‚</p>
</blockquote>
<p>å¦‚æœä½ ç”¨ telnet è¿æ¥ï¼Œå‘é€ â€œhello world!â€ï¼Œä¼šå¾—åˆ°ä¸åŒçš„å“ˆå¸Œå’Œ nonceï¼Œå®ƒä»¬éƒ½æ˜¯æ­£ç¡®çš„ç»“æœï¼š</p>
<pre><code class="language-shell">
â¯ telnet localhost 8080
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
hello world!
Pow calculated: hash: 0000006e6e9370d0f60f06bdc288efafa203fd99b9af0480d040b2cc89c44df0, once: 403407307
Connection closed by foreign host.

â¯ telnet localhost 8080
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
hello world!
Pow calculated: hash: 000000e23f0e9b7aeba9060a17ac676f3341284800a2db843e2f0e85f77f52dd, once: 36169623
Connection closed by foreign host.

</code></pre>
</div>
</details>
<h2 id="å¯¹æ¯”çº¿ç¨‹å­¦ä¹ future"><a class="header" href="#å¯¹æ¯”çº¿ç¨‹å­¦ä¹ future">å¯¹æ¯”çº¿ç¨‹å­¦ä¹ Future</a></h2>
<details id="admonition-å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ future" class="admonition info">
<summary class="admonition-title">
<p>å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ future</p>
<p><a class="admonition-anchor-link" href="#admonition-å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ future"></a></p>
</summary>
<div>
<p>åœ¨å­¦ä¹  Future çš„ä½¿ç”¨æ—¶ï¼Œä¼°è®¡ä½ ä¹Ÿå‘ç°äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸‹åˆ—ä»£ç çš„ç»“æ„å¤šä¹ˆç›¸ä¼¼ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn thread_async() -&gt; JoinHandle&lt;usize&gt; {
    thread::spawn(move || {
        println!(&quot;hello thread!&quot;);
        42
    })
}

fn task_async() -&gt; impl Future&lt;Output = usize&gt; {
    async move {
        println!(&quot;hello async!&quot;);
        42
    }
}
</code></pre></pre>
</div>
</details>
<h2 id="ä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„-mutex-ä¸èƒ½è·¨è¶Š-await"><a class="header" href="#ä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„-mutex-ä¸èƒ½è·¨è¶Š-await">ä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„ Mutex ä¸èƒ½è·¨è¶Š awaitï¼Ÿ</a></h2>
<p>æƒ³æƒ³çœ‹ï¼Œä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„ Mutex ä¸èƒ½è·¨è¶Š awaitï¼Ÿ</p>
<p>ä½ å¯ä»¥æŠŠæ–‡ä¸­ä½¿ç”¨ tokio::sync::Mutex çš„ä»£ç æ”¹æˆä½¿ç”¨ std::sync::Mutexï¼Œå¹¶å¯¹ä½¿ç”¨çš„æ¥å£åšç›¸åº”çš„æ”¹åŠ¨ï¼ˆæŠŠ lock().await æ”¹æˆ lock().unwrap()ï¼‰ï¼Œçœ‹çœ‹ç¼–è¯‘å™¨ä¼šæŠ¥ä»€ä¹ˆé”™ã€‚</p>
<p>å¯¹ç€é”™è¯¯æç¤ºï¼Œä½ æ˜ç™½ä¸ºä»€ä¹ˆäº†ä¹ˆï¼Ÿ</p>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="5_1_concurrency_primitives.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="5_3_deepin_async_await.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="5_1_concurrency_primitives.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="5_3_deepin_async_await.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
