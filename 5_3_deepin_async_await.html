<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>æ·±å…¥async/await - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item expanded "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item expanded "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item expanded "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item expanded "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item expanded "><a href="2_2_generic_overview.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹æ¦‚è§ˆï¼šå°±åƒå‡½æ•°</a></li><li class="chapter-item expanded "><a href="2_3_trait_overview.html"><strong aria-hidden="true">4.2.3.</strong> traitæ¦‚è§ˆ</a></li><li class="chapter-item expanded "><a href="2_4_0_three_polymorphics.html"><strong aria-hidden="true">4.2.4.</strong> ä¸‰ç§å¤šæ€å½¢å¼</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_4_1_generic_usage.html"><strong aria-hidden="true">4.2.4.1.</strong> Generics</a></li><li class="chapter-item "><a href="2_4_2_trait_impl.html"><strong aria-hidden="true">4.2.4.2.</strong> Trait impl</a></li><li class="chapter-item "><a href="2_4_3_trait_object.html"><strong aria-hidden="true">4.2.4.3.</strong> Trait object</a></li></ol></li><li class="chapter-item expanded "><a href="2_5_trait_frequently.html"><strong aria-hidden="true">4.2.5.</strong> å¸¸ç”¨trait</a></li><li class="chapter-item expanded "><a href="2_6_trait_design.html"><strong aria-hidden="true">4.2.6.</strong> Traitè®¾è®¡</a></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_1_box.html"><strong aria-hidden="true">4.3.1.1.</strong> Box</a></li><li class="chapter-item "><a href="3_1_2_cow.html"><strong aria-hidden="true">4.3.1.2.</strong> Cow&lt;'a, B&gt;</a></li><li class="chapter-item "><a href="3_1_3_mutex_guard.html"><strong aria-hidden="true">4.3.1.3.</strong> MutexGuard&lt;'_, T&gt;</a></li></ol></li><li class="chapter-item expanded "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_2_1_slice.html"><strong aria-hidden="true">4.3.2.1.</strong> åˆ‡ç‰‡</a></li><li class="chapter-item "><a href="3_2_2_hashmap.html"><strong aria-hidden="true">4.3.2.2.</strong> å“ˆå¸Œè¡¨</a></li></ol></li><li class="chapter-item expanded "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_3_1_error_content.html"><strong aria-hidden="true">4.3.3.1.</strong> é”™è¯¯å¤„ç†å†…å®¹å’Œä¸»æµæ–¹æ³•</a></li><li class="chapter-item "><a href="3_3_2_rust_error_handling.html"><strong aria-hidden="true">4.3.3.2.</strong> Rustå¦‚ä½•å¤„ç†é”™è¯¯</a></li></ol></li><li class="chapter-item expanded "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="4_1_macros_classify.html"><strong aria-hidden="true">4.4.1.</strong> å®åˆ†ç±»</a></li><li class="chapter-item expanded "><a href="4_2_declarative_macros.html"><strong aria-hidden="true">4.4.2.</strong> å£°æ˜å®</a></li><li class="chapter-item expanded "><a href="4_3_procedural_macros.html"><strong aria-hidden="true">4.4.3.</strong> è¿‡ç¨‹å®</a></li></ol></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item expanded "><a href="5_2_future_async_await.html"><strong aria-hidden="true">4.5.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item expanded "><a href="5_3_deepin_async_await.html" class="active"><strong aria-hidden="true">4.5.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="asyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„"><a class="header" href="#asyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„">async/awaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</a></h1>
<!--ts-->
<ul>
<li><a href="#asyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84">async/awaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</a></li>
<li><a href="#futureasyncawait%E7%9A%84%E8%81%94%E5%8A%A8%E7%90%86%E8%A7%A3">Futureã€Async/Awaitçš„è”åŠ¨ç†è§£</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E4%B8%80async-%E4%BA%A7%E7%94%9F%E7%9A%84-future-%E7%A9%B6%E7%AB%9F%E6%98%AF%E4%BB%80%E4%B9%88%E7%B1%BB%E5%9E%8B">é—®é¢˜ä¸€ï¼šasync äº§ç”Ÿçš„ Future ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E4%BA%8Cfuture-%E6%98%AF%E6%80%8E%E4%B9%88%E8%A2%AB-executor-%E5%A4%84%E7%90%86%E7%9A%84">é—®é¢˜äºŒï¼šFuture æ˜¯æ€ä¹ˆè¢« executor å¤„ç†çš„</a>
<ul>
<li><a href="#%E5%86%8D%E5%BA%A6%E6%B7%B1%E5%85%A5future-trait-contextpin">å†åº¦æ·±å…¥Future Traitï¼š Contextã€Pin</a></li>
<li><a href="#contextwaker-waker-%E7%9A%84%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6">Context::waker: Waker çš„è°ƒç”¨æœºåˆ¶</a>
<ul>
<li><a href="#context%E5%8C%85%E5%90%ABwaker">ContextåŒ…å«Waker</a></li>
<li><a href="#waker%E5%8C%85%E5%90%ABvtable%E8%AE%B0%E5%BD%95%E5%9B%9E%E8%B0%83">WakeråŒ…å«Vtableè®°å½•å›è°ƒ</a></li>
</ul>
</li>
<li><a href="#future-%E6%98%AF%E6%80%8E%E4%B9%88%E8%A2%AB-executor-%E5%A4%84%E7%90%86%E7%9A%84">Future æ˜¯æ€ä¹ˆè¢« executor å¤„ç†çš„</a>
<ul>
<li><a href="#%E4%B8%8D%E6%96%ADpool">ä¸æ–­pool</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0future-trait%E5%8C%B9%E9%85%8D%E4%B8%8D%E5%90%8C%E9%80%BB%E8%BE%91">å®ç°Future traitåŒ¹é…ä¸åŒé€»è¾‘</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B%E5%85%B6%E5%AE%9E%E6%98%AF%E4%B8%80%E4%B8%AA%E7%8A%B6%E6%80%81%E6%9C%BA">å®ç°è¿‡ç¨‹å…¶å®æ˜¯ä¸€ä¸ªçŠ¶æ€æœº</a></li>
</ul>
</li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-pin">ä¸ºä»€ä¹ˆéœ€è¦ Pinï¼Ÿ</a>
<ul>
<li><a href="#%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E4%BC%9A%E5%87%BA%E7%8E%B0%E8%87%AA%E5%BC%95%E7%94%A8%E7%BB%93%E6%9E%84">å¼‚æ­¥ä»£ç ä¼šå‡ºç°è‡ªå¼•ç”¨ç»“æ„</a></li>
<li><a href="#%E8%87%AA%E5%BC%95%E7%94%A8%E7%BB%93%E6%9E%84%E7%9A%84%E9%97%AE%E9%A2%98">è‡ªå¼•ç”¨ç»“æ„çš„é—®é¢˜</a></li>
<li><a href="#pin%E5%B0%B1%E6%98%AF%E4%B8%BA%E4%BA%86%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98">Pinå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜</a></li>
</ul>
</li>
<li><a href="#%E8%81%94%E6%83%B3unpin">è”æƒ³Unpin</a>
<ul>
<li><a href="#unpin%E5%A3%B0%E6%98%8E%E5%8F%AF%E4%BB%A5%E7%A7%BB%E5%8A%A8">Unpinå£°æ˜å¯ä»¥ç§»åŠ¨</a></li>
<li><a href="#unpin">!Unpin</a></li>
<li><a href="#unpin%E4%B8%8Epin%E7%9A%84%E5%85%B3%E7%B3%BB">Unpinä¸Pinçš„å…³ç³»</a></li>
<li><a href="#boxt%E7%9A%84unpin%E6%80%9D%E8%80%83">Box&lt;T&gt;çš„Unpinæ€è€ƒ</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%9B%9E%E9%A1%BE%E6%95%B4%E7%90%86future%E7%9A%84contextpinunpin%E4%BB%A5%E5%8F%8Aasyncawait">å›é¡¾æ•´ç†Futureçš„Contextã€Pin/Unpinï¼Œä»¥åŠasync/await</a></li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Fri Oct 21 14:41:30 UTC 2022 -->
<!--te-->
<h1 id="futureasyncawaitçš„è”åŠ¨ç†è§£"><a class="header" href="#futureasyncawaitçš„è”åŠ¨ç†è§£">Futureã€Async/Awaitçš„è”åŠ¨ç†è§£</a></h1>
<div id="admonition-å¯¹-future-å’Œ-asyncawait-çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£" class="admonition info">
<div class="admonition-title">
<p>å¯¹ Future å’Œ async/await çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£</p>
<p><a class="admonition-anchor-link" href="#admonition-å¯¹-future-å’Œ-asyncawait-çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£"></a></p>
</div>
<div>
<p>å¯¹ Future å’Œ async/await çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£:</p>
<ol>
<li><a href="5_2_future_async_await.html#%E4%BD%BF%E7%94%A8-future-%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">çŸ¥é“åœ¨ä»€ä¹ˆæƒ…å†µä¸‹è¯¥ä½¿ç”¨ Future, ä»€ä¹ˆæƒ…å†µä¸‹è¯¥ä½¿ç”¨ Thread</a></li>
<li><a href="5_2_future_async_await.html#%E6%80%8E%E4%B9%88%E7%94%A8-future-%E5%81%9A%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86">executor å’Œ reactor æ˜¯æ€ä¹ˆè”åŠ¨æœ€ç»ˆè®© Future å¾—åˆ°äº†ä¸€ä¸ªç»“æœã€‚</a></li>
</ol>
</div>
</div>
<blockquote>
<p>ç„¶è€Œ:</p>
</blockquote>
<ol>
<li>æˆ‘ä»¬å¹¶ä¸æ¸…æ¥šä¸ºä»€ä¹ˆ async fn æˆ–è€… async block å°±èƒ½å¤Ÿäº§ç”Ÿ Future</li>
<li>ä¹Ÿå¹¶ä¸æ˜ç™½ Future æ˜¯æ€ä¹ˆè¢« executor å¤„ç†çš„ã€‚</li>
</ol>
<blockquote>
<p>ç»§ç»­æ·±å…¥ä¸‹å»ï¼Œçœ‹çœ‹ async/await è¿™ä¸¤ä¸ªå…³é”®è¯ç©¶ç«Ÿæ–½äº†ä»€ä¹ˆæ ·çš„é­”æ³•ï¼Œèƒ½å¤Ÿè®©ä¸€åˆ‡å¦‚æ­¤ç®€å•åˆå¦‚æ­¤è‡ªç„¶åœ°è¿è½¬èµ·æ¥ã€‚</p>
</blockquote>
<h1 id="é—®é¢˜ä¸€async-äº§ç”Ÿçš„-future-ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹"><a class="header" href="#é—®é¢˜ä¸€async-äº§ç”Ÿçš„-future-ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹">é—®é¢˜ä¸€ï¼šasync äº§ç”Ÿçš„ Future ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</a></h1>
<details id="admonition-rustä¸­futureæ˜¯ä¸€ä¸ªtraitasyncè¿”å›çš„æ˜¯ä¸€ä¸ªå®ç°äº†futureçš„genfutureç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>Rustä¸­Futureæ˜¯ä¸€ä¸ªtraitï¼Œasyncè¿”å›çš„æ˜¯ä¸€ä¸ªå®ç°äº†Futureçš„GenFutureç±»å‹</p>
<p><a class="admonition-anchor-link" href="#admonition-rustä¸­futureæ˜¯ä¸€ä¸ªtraitasyncè¿”å›çš„æ˜¯ä¸€ä¸ªå®ç°äº†futureçš„genfutureç±»å‹"></a></p>
</summary>
<div>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯¹ Future çš„æ¥å£æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„è®¤è¯†ï¼Œä¹ŸçŸ¥é“ async å…³é”®å­—çš„èƒŒåéƒ½å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Future {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}
</code></pre></pre>
<p>é‚£ä¹ˆï¼Œå½“ä½ å†™ä¸€ä¸ª async fn æˆ–è€…ä½¿ç”¨äº†ä¸€ä¸ª async block æ—¶ï¼Œç©¶ç«Ÿå¾—åˆ°äº†ä¸€ä¸ªä»€ä¹ˆç±»å‹çš„æ•°æ®å‘¢ï¼Ÿæ¯”å¦‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let fut = async { 42 };
</code></pre></pre>
<p>ä½ è‚¯å®šèƒ½æ‹ç€èƒ¸è„¯è¯´ï¼Œè¿™ä¸ªæˆ‘çŸ¥é“ï¼Œä¸å°±æ˜¯ impl Future&lt;Output = i32&gt; ä¹ˆï¼Ÿ</p>
<p>å¯¹ï¼Œä½†æ˜¯ impl Future ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»å‹å•Šï¼Œæˆ‘ä»¬è®²è¿‡ï¼Œå®ƒç›¸å½“äº T: Futureï¼Œé‚£ä¹ˆè¿™ä¸ª T ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬æ¥å†™æ®µä»£ç æ¢ç´¢ä¸€ä¸‹ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let fut = async { 42 };

    println!(&quot;type of fut is: {}&quot;, get_type_name(&amp;fut));
}

fn get_type_name&lt;T&gt;(_: &amp;T) -&gt; &amp;'static str {
    std::any::type_name::&lt;T&gt;()
}
</code></pre></pre>
<p>å®ƒçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">
type of fut is: core::future::from_generator::GenFuture&lt;xxx::main::{{closure}}&gt;
</code></pre>
<p>å®ç° Future trait çš„æ˜¯ä¸€ä¸ªå« GenFuture çš„ç»“æ„ï¼Œå®ƒå†…éƒ¨æœ‰ä¸€ä¸ªé—­åŒ…ã€‚çŒœæµ‹è¿™ä¸ªé—­åŒ…æ˜¯ async { 42 } äº§ç”Ÿçš„ï¼Ÿ</p>
</div>
</details>
<details id="admonition-genfuture-è¿™é‡Œé¢‡ä¼¼pythonçš„yieldå¦‚ä½•å˜æˆåç¨‹çš„è¿‡ç¨‹" class="admonition info">
<summary class="admonition-title">
<p>GenFuture: è¿™é‡Œé¢‡ä¼¼pythonçš„yieldå¦‚ä½•å˜æˆåç¨‹çš„è¿‡ç¨‹ã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-genfuture-è¿™é‡Œé¢‡ä¼¼pythonçš„yieldå¦‚ä½•å˜æˆåç¨‹çš„è¿‡ç¨‹"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬çœ‹ GenFuture çš„å®šä¹‰ï¼ˆæ„Ÿå…´è¶£å¯ä»¥åœ¨ Rust æºç ä¸­æœ from_generatorï¼‰ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ªæ³›å‹ç»“æ„ï¼Œå†…éƒ¨æ•°æ® T è¦æ»¡è¶³ Generator traitï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct GenFuture&lt;T: Generator&lt;ResumeTy, Yield = ()&gt;&gt;(T);

pub trait Generator&lt;R = ()&gt; {
    type Yield;
    type Return;
    fn resume(
        self: Pin&lt;&amp;mut Self&gt;, 
        arg: R
    ) -&gt; GeneratorState&lt;Self::Yield, Self::Return&gt;;
}
</code></pre></pre>
<p><a href="https://doc.rust-lang.org/std/ops/trait.Generator.html">Generator</a> æ˜¯ Rust nightly çš„ä¸€ä¸ª traitï¼Œè¿˜æ²¡æœ‰è¿›å…¥åˆ°æ ‡å‡†åº“ã€‚å¤§è‡´çœ‹çœ‹å®˜ç½‘å±•ç¤ºçš„ä¾‹å­ï¼Œå®ƒæ˜¯æ€ä¹ˆç”¨çš„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#![feature(generators, generator_trait)]

use std::ops::{Generator, GeneratorState};
use std::pin::Pin;

fn main() {
    let mut generator = || {
        yield 1;
        return &quot;foo&quot;
    };

    match Pin::new(&amp;mut generator).resume(()) {
        GeneratorState::Yielded(1) =&gt; {}
        _ =&gt; panic!(&quot;unexpected return from resume&quot;),
    }
    match Pin::new(&amp;mut generator).resume(()) {
        GeneratorState::Complete(&quot;foo&quot;) =&gt; {}
        _ =&gt; panic!(&quot;unexpected return from resume&quot;),
    }
}
</code></pre></pre>
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä½ åˆ›å»ºä¸€ä¸ªé—­åŒ…ï¼Œé‡Œé¢æœ‰ yield å…³é”®å­—ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ª Generatorã€‚</li>
<li>å¦‚æœä½ åœ¨ Python ä¸­ä½¿ç”¨è¿‡ yieldï¼ŒäºŒè€…å…¶å®éå¸¸ç±»ä¼¼ã€‚</li>
<li>å› ä¸º Generator æ˜¯ä¸€ä¸ªè¿˜æ²¡è¿›å…¥åˆ°ç¨³å®šç‰ˆçš„åŠŸèƒ½ï¼Œå¤§è‡´äº†è§£ä¸€ä¸‹å°±è¡Œï¼Œä»¥åç­‰å®ƒçš„ API ç¨³å®šåå†ä»”ç»†ç ”ç©¶ã€‚</li>
</ol>
</div>
</details>
<h1 id="é—®é¢˜äºŒfuture-æ˜¯æ€ä¹ˆè¢«-executor-å¤„ç†çš„"><a class="header" href="#é—®é¢˜äºŒfuture-æ˜¯æ€ä¹ˆè¢«-executor-å¤„ç†çš„">é—®é¢˜äºŒï¼šFuture æ˜¯æ€ä¹ˆè¢« executor å¤„ç†çš„</a></h1>
<h2 id="å†åº¦æ·±å…¥future-trait-contextpin"><a class="header" href="#å†åº¦æ·±å…¥future-trait-contextpin">å†åº¦æ·±å…¥Future Traitï¼š Contextã€Pin</a></h2>
<details id="admonition-ä»futureå®šä¹‰ä¸­çš„pinå’Œcontextå¼€å§‹" class="admonition info">
<summary class="admonition-title">
<p>ä»Futureå®šä¹‰ä¸­çš„Pinå’ŒContextå¼€å§‹</p>
<p><a class="admonition-anchor-link" href="#admonition-ä»futureå®šä¹‰ä¸­çš„pinå’Œcontextå¼€å§‹"></a></p>
</summary>
<div>
<p>æå‰è¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¼šç»§ç»­å›´ç»•ç€ Future è¿™ä¸ªç®€çº¦å´åˆå¹¶ä¸ç®€å•çš„æ¥å£ï¼Œæ¥æ¢è®¨ä¸€äº›åŸç†æ€§çš„ä¸œè¥¿ï¼Œä¸»è¦æ˜¯ Context å’Œ Pin è¿™ä¸¤ä¸ªç»“æ„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Future {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}
</code></pre></pre>
</div>
</details>
<h2 id="contextwaker-waker-çš„è°ƒç”¨æœºåˆ¶"><a class="header" href="#contextwaker-waker-çš„è°ƒç”¨æœºåˆ¶">Context::waker: Waker çš„è°ƒç”¨æœºåˆ¶</a></h2>
<h3 id="contextåŒ…å«waker"><a class="header" href="#contextåŒ…å«waker">ContextåŒ…å«Waker</a></h3>
<details id="admonition-context-å°±æ˜¯-waker-çš„ä¸€ä¸ªå°è£…" class="admonition info">
<summary class="admonition-title">
<p>Context å°±æ˜¯ Waker çš„ä¸€ä¸ªå°è£…</p>
<p><a class="admonition-anchor-link" href="#admonition-context-å°±æ˜¯-waker-çš„ä¸€ä¸ªå°è£…"></a></p>
</summary>
<div>
<p>å…ˆæ¥çœ‹è¿™ä¸ªæ¥å£çš„ Context æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚</p>
<ol>
<li>executor é€šè¿‡è°ƒç”¨ poll æ–¹æ³•æ¥è®© Future ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li>
<li>å¦‚æœ poll æ–¹æ³•è¿”å› Poll::Pendingï¼Œå°±é˜»å¡ Future</li>
<li>ç›´åˆ° reactor æ”¶åˆ°äº†æŸä¸ªäº‹ä»¶ï¼Œç„¶åè°ƒç”¨ Waker.wake() æŠŠ Future å”¤é†’ã€‚</li>
<li>è¿™ä¸ª Waker æ˜¯å“ªæ¥çš„å‘¢ï¼Ÿ</li>
</ol>
<p>å…¶å®ï¼Œå®ƒéšå«åœ¨ Context ä¸­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct Context&lt;'a&gt; {
    waker: &amp;'a Waker,
    _marker: PhantomData&lt;fn(&amp;'a ()) -&gt; &amp;'a ()&gt;,
}
</code></pre></pre>
<p>æ‰€ä»¥ï¼ŒContext å°±æ˜¯ Waker çš„ä¸€ä¸ªå°è£…ã€‚</p>
</div>
</details>
<h3 id="wakeråŒ…å«vtableè®°å½•å›è°ƒ"><a class="header" href="#wakeråŒ…å«vtableè®°å½•å›è°ƒ">WakeråŒ…å«Vtableè®°å½•å›è°ƒ</a></h3>
<details id="admonition-rawwakervtable" class="admonition info">
<summary class="admonition-title">
<p>RawWakerVTable</p>
<p><a class="admonition-anchor-link" href="#admonition-rawwakervtable"></a></p>
</summary>
<div>
<p>å¦‚æœä½ å»çœ‹ Waker çš„å®šä¹‰å’Œç›¸å…³çš„ä»£ç ï¼Œä¼šå‘ç°å®ƒéå¸¸æŠ½è±¡ï¼Œå†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ª vtable æ¥å…è®¸å„ç§å„æ ·çš„ waker çš„è¡Œä¸ºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct RawWakerVTable {
    clone: unsafe fn(*const ()) -&gt; RawWaker,
    wake: unsafe fn(*const ()),
    wake_by_ref: unsafe fn(*const ()),
    drop: unsafe fn(*const ()),
}
</code></pre></pre>
<ol>
<li>è¿™ç§æ‰‹å·¥ç”Ÿæˆ vtable çš„åšæ³•ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦å…¼é¡¾æ•ˆç‡å’Œçµæ´»æ€§ã€‚</li>
<li>Rust è‡ªèº«å¹¶ä¸æä¾›å¼‚æ­¥è¿è¡Œæ—¶ï¼Œå®ƒåªåœ¨æ ‡å‡†åº“é‡Œè§„å®šäº†ä¸€äº›åŸºæœ¬çš„æ¥å£ï¼Œè‡³äºæ€ä¹ˆå®ç°ï¼Œå¯ä»¥ç”±å„ä¸ªè¿è¡Œæ—¶ï¼ˆå¦‚ tokioï¼‰è‡ªè¡Œå†³å®šã€‚</li>
<li>æ‰€ä»¥åœ¨æ ‡å‡†åº“ä¸­ï¼Œä½ åªä¼šçœ‹åˆ°è¿™äº›æ¥å£çš„å®šä¹‰ï¼Œä»¥åŠâ€œé«˜å±‚â€æ¥å£çš„å®ç°ï¼Œæ¯”å¦‚ Waker ä¸‹çš„ wake æ–¹æ³•ï¼Œåªæ˜¯è°ƒç”¨äº† vtable é‡Œçš„ wake() è€Œå·²ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
impl Waker {
    /// Wake up the task associated with this `Waker`.
    #[inline]
    pub fn wake(self) {
        // The actual wakeup call is delegated through a virtual function call
        // to the implementation which is defined by the executor.
        let wake = self.waker.vtable.wake;
        let data = self.waker.data;

        // Don't call `drop` -- the waker will be consumed by `wake`.
        crate::mem::forget(self);

        // SAFETY: This is safe because `Waker::from_raw` is the only way
        // to initialize `wake` and `data` requiring the user to acknowledge
        // that the contract of `RawWaker` is upheld.
        unsafe { (wake)(data) };
    }
    ...
}
</code></pre></pre>
<blockquote>
<p>å¦‚æœä½ æƒ³é¡ºè—¤æ‘¸ç“œæ‰¾åˆ° vtable æ˜¯æ€ä¹ˆè®¾ç½®çš„ï¼Œå´å‘ç°ä¸€åˆ‡çº¿ç´¢éƒ½æ‚„æ— å£°æ¯åœ°ä¸­æ–­äº†ï¼Œé‚£æ˜¯å› ä¸ºï¼Œå…·ä½“çš„å®ç°å¹¶ä¸åœ¨æ ‡å‡†åº“ä¸­ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸‰æ–¹çš„å¼‚æ­¥è¿è¡Œæ—¶é‡Œï¼Œæ¯”å¦‚ tokioã€‚</p>
</blockquote>
</div>
</details>
<p>ä¸è¿‡ï¼Œè™½ç„¶æˆ‘ä»¬å¼€å‘æ—¶ä¼šä½¿ç”¨ tokioï¼Œä½†é˜…è¯»ã€ç†è§£ä»£ç æ—¶ï¼Œæˆ‘å»ºè®®çœ‹ futures åº“ï¼Œæ¯”å¦‚ waker vtable çš„å®šä¹‰ã€‚futures åº“è¿˜æœ‰ä¸€ä¸ªç®€å•çš„ executorï¼Œä¹Ÿéå¸¸é€‚åˆè¿›ä¸€æ­¥é€šè¿‡ä»£ç ç†è§£ executor çš„åŸç†ã€‚</p>
<h2 id="future-æ˜¯æ€ä¹ˆè¢«-executor-å¤„ç†çš„"><a class="header" href="#future-æ˜¯æ€ä¹ˆè¢«-executor-å¤„ç†çš„">Future æ˜¯æ€ä¹ˆè¢« executor å¤„ç†çš„</a></h2>
<h3 id="ä¸æ–­pool"><a class="header" href="#ä¸æ–­pool">ä¸æ–­pool</a></h3>
<details id="admonition-ä¸æ–­pollåŒ¹é…çŠ¶æ€æ‰§è¡Œä¸åŒé€»è¾‘" class="admonition info">
<summary class="admonition-title">
<p>ä¸æ–­pollï¼ŒåŒ¹é…çŠ¶æ€æ‰§è¡Œä¸åŒé€»è¾‘</p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸æ–­pollåŒ¹é…çŠ¶æ€æ‰§è¡Œä¸åŒé€»è¾‘"></a></p>
</summary>
<div>
<p>ä¸ºäº†è®²æ˜ç™½ Pinï¼Œæˆ‘ä»¬å¾—å¾€å‰è¿½è¸ªä¸€æ­¥ï¼Œçœ‹çœ‹äº§ç”Ÿ Future çš„ä¸€ä¸ª async block/fn å†…éƒ¨ç©¶ç«Ÿç”Ÿæˆäº†ä»€ä¹ˆæ ·çš„ä»£ç ï¼Ÿæ¥çœ‹ä¸‹é¢è¿™ä¸ªç®€å•çš„ async å‡½æ•°ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
async fn write_hello_file_async(name: &amp;str) -&gt; anyhow::Result&lt;()&gt; {
    let mut file = fs::File::create(name).await?;
    // è¿™é‡Œå…¶å®å°±ç±»ä¼¼pythonçš„yield from
    file.write_all(b&quot;hello world!&quot;).await?;

    Ok(())
}
</code></pre></pre>
<ol>
<li>é¦–å…ˆå®ƒåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åå¾€è¿™ä¸ªæ–‡ä»¶é‡Œå†™å…¥ â€œhello world!â€ã€‚</li>
<li>è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ª awaitï¼Œåˆ›å»ºæ–‡ä»¶çš„æ—¶å€™ä¼šå¼‚æ­¥åˆ›å»ºï¼Œå†™å…¥æ–‡ä»¶çš„æ—¶å€™ä¼šå¼‚æ­¥å†™å…¥ã€‚</li>
<li>æœ€ç»ˆï¼Œæ•´ä¸ªå‡½æ•°å¯¹å¤–è¿”å›ä¸€ä¸ª Futureã€‚</li>
</ol>
<blockquote>
<p>å…¶å®ƒäººå¯ä»¥è¿™æ ·è°ƒç”¨ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
write_hello_file_async(&quot;/tmp/hello&quot;).await?;
</code></pre></pre>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œexecutor å¤„ç† Future æ—¶ï¼Œä¼šä¸æ–­åœ°è°ƒç”¨å®ƒçš„ poll() æ–¹æ³•ï¼Œäºæ˜¯ï¼Œä¸Šé¢é‚£å¥å®é™…ä¸Šç›¸å½“äºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
match write_hello_file_async.poll(cx) {
    Poll::Ready(result) =&gt; return result,
    Poll::Pending =&gt; return Poll::Pending
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>è¿™æ˜¯å•ä¸ª await çš„å¤„ç†æ–¹æ³•ï¼Œé‚£æ›´åŠ å¤æ‚çš„ï¼Œä¸€ä¸ªå‡½æ•°ä¸­æœ‰è‹¥å¹²ä¸ª awaitï¼Œè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>
</blockquote>
<h3 id="å®ç°future-traitåŒ¹é…ä¸åŒé€»è¾‘"><a class="header" href="#å®ç°future-traitåŒ¹é…ä¸åŒé€»è¾‘">å®ç°Future traitåŒ¹é…ä¸åŒé€»è¾‘</a></h3>
<details id="admonition-åŒ¹é…çš„ä¸åŒæ“ä½œé€»è¾‘éœ€è¦åœ¨future-traité‡Œé¢å®ç°" class="admonition info">
<summary class="admonition-title">
<p>åŒ¹é…çš„ä¸åŒæ“ä½œé€»è¾‘ï¼Œéœ€è¦åœ¨Future traité‡Œé¢å®ç°</p>
<p><a class="admonition-anchor-link" href="#admonition-åŒ¹é…çš„ä¸åŒæ“ä½œé€»è¾‘éœ€è¦åœ¨future-traité‡Œé¢å®ç°"></a></p>
</summary>
<div>
<p>ä»¥å‰é¢write_hello_file_async å‡½æ•°çš„å†…éƒ¨å®ç°ä¸ºä¾‹ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬åªæœ‰åœ¨å¤„ç†å®Œ create()ï¼Œæ‰èƒ½å¤„ç† write_all()ï¼Œæ‰€ä»¥ï¼Œåº”è¯¥æ˜¯ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let fut = fs::File::create(name);
match fut.poll(cx) {
    Poll::Ready(Ok(file)) =&gt; {
        let fut = file.write_all(b&quot;hello world!&quot;);
        match fut.poll(cx) {
            Poll::Ready(result) =&gt; return result,
            Poll::Pending =&gt; return Poll::Pending,
        }
    }
    Poll::Pending =&gt; return Poll::Pending,
}
</code></pre></pre>
<blockquote>
<p>ä½†æ˜¯ï¼Œå‰é¢è¯´è¿‡ï¼Œasync å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª Futureï¼Œæ‰€ä»¥ï¼Œè¿˜éœ€è¦æŠŠè¿™æ ·çš„ä»£ç å°è£…åœ¨ä¸€ä¸ª Future çš„å®ç°é‡Œï¼Œå¯¹å¤–æä¾›å‡ºå»ã€‚</p>
</blockquote>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒæŠŠå†…éƒ¨çš„çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸ºè¿™ä¸ªæ•°æ®ç»“æ„å®ç° Futureã€‚æ¯”å¦‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
enum WriteHelloFile {
    // åˆå§‹é˜¶æ®µï¼Œç”¨æˆ·æä¾›æ–‡ä»¶å
    Init(String),
    // ç­‰å¾…æ–‡ä»¶åˆ›å»ºï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨
    // è¿™æ˜¯ä¼ªä»£ç ï¼Œimpl Future ä¸èƒ½ç”¨åœ¨è¿™é‡Œ
    AwaitingCreate(impl Future&lt;Output = Result&lt;fs::File, std::io::Error&gt;&gt;),
    // ç­‰å¾…æ–‡ä»¶å†™å…¥ï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨
    AwaitingWrite(impl Future&lt;Output = Result&lt;(), std::io::Error&gt;&gt;),
    // Future å¤„ç†å®Œæ¯•
    Done,
}

impl WriteHelloFile {
    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {
        Self::Init(name.into())
    }
}

impl Future for WriteHelloFile {
    type Output = Result&lt;(), std::io::Error&gt;;

    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
        todo!()
    }
}

fn write_hello_file_async(name: &amp;str) -&gt; WriteHelloFile {
    WriteHelloFile::new(name)
}
</code></pre></pre>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æŠŠåˆšæ‰çš„ write_hello_file_async å¼‚æ­¥å‡½æ•°ï¼Œè½¬åŒ–æˆäº†ä¸€ä¸ªè¿”å› WriteHelloFile Future çš„å‡½æ•°ã€‚</p>
</div>
</details>
<h3 id="å®ç°è¿‡ç¨‹å…¶å®æ˜¯ä¸€ä¸ªçŠ¶æ€æœº"><a class="header" href="#å®ç°è¿‡ç¨‹å…¶å®æ˜¯ä¸€ä¸ªçŠ¶æ€æœº">å®ç°è¿‡ç¨‹å…¶å®æ˜¯ä¸€ä¸ªçŠ¶æ€æœº</a></h3>
<details id="admonition-æ¥çœ‹è¿™ä¸ª-future-å¦‚ä½•å®ç°è¯¦ç»†æ³¨é‡Šäº†çŠ¶æ€æœº" class="admonition info">
<summary class="admonition-title">
<p>æ¥çœ‹è¿™ä¸ª Future å¦‚ä½•å®ç°ï¼ˆè¯¦ç»†æ³¨é‡Šäº†ï¼‰ï¼šçŠ¶æ€æœº</p>
<p><a class="admonition-anchor-link" href="#admonition-æ¥çœ‹è¿™ä¸ª-future-å¦‚ä½•å®ç°è¯¦ç»†æ³¨é‡Šäº†çŠ¶æ€æœº"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
impl Future for WriteHelloFile {
    type Output = Result&lt;(), std::io::Error&gt;;

    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
        let this = self.get_mut();
        loop {
            match this {
                // å¦‚æœçŠ¶æ€æ˜¯ Initï¼Œé‚£ä¹ˆå°±ç”Ÿæˆ create Futureï¼ŒæŠŠçŠ¶æ€åˆ‡æ¢åˆ° AwaitingCreate
                WriteHelloFile::Init(name) =&gt; {
                    let fut = fs::File::create(name);
                    *self = WriteHelloFile::AwaitingCreate(fut);
                }
                // å¦‚æœçŠ¶æ€æ˜¯ AwaitingCreateï¼Œé‚£ä¹ˆ poll create Future
                // å¦‚æœè¿”å› Poll::Ready(Ok(_))ï¼Œé‚£ä¹ˆåˆ›å»º write Future
                // å¹¶æŠŠçŠ¶æ€åˆ‡æ¢åˆ° Awaiting
                WriteHelloFile::AwaitingCreate(fut) =&gt; match fut.poll(cx) {
                    Poll::Ready(Ok(file)) =&gt; {
                        let fut = file.write_all(b&quot;hello world!&quot;);
                        *self = WriteHelloFile::AwaitingWrite(fut);
                    }
                    Poll::Ready(Err(e)) =&gt; return Poll::Ready(Err(e)),
                    Poll::Pending =&gt; return Poll::Pending,
                },
                // å¦‚æœçŠ¶æ€æ˜¯ AwaitingWriteï¼Œé‚£ä¹ˆ poll write Future
                // å¦‚æœè¿”å› Poll::Ready(_)ï¼Œé‚£ä¹ˆçŠ¶æ€åˆ‡æ¢åˆ° Doneï¼Œæ•´ä¸ª Future æ‰§è¡ŒæˆåŠŸ
                WriteHelloFile::AwaitingWrite(fut) =&gt; match fut.poll(cx) {
                    Poll::Ready(result) =&gt; {
                        *self = WriteHelloFile::Done;
                        return Poll::Ready(result);
                    }
                    Poll::Pending =&gt; return Poll::Pending,
                },
                // æ•´ä¸ª Future å·²ç»æ‰§è¡Œå®Œæ¯•
                WriteHelloFile::Done =&gt; return Poll::Ready(Ok(())),
            }
        }
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition--è¿™ä¸ª-future-å®Œæ•´å®ç°çš„å†…éƒ¨ç»“æ„-å…¶å®å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºçš„è¿ç§»" class="admonition info">
<summary class="admonition-title">
<blockquote>
<p>è¿™ä¸ª Future å®Œæ•´å®ç°çš„å†…éƒ¨ç»“æ„ ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºçš„è¿ç§»ã€‚</p>
</blockquote>
<p><a class="admonition-anchor-link" href="#admonition--è¿™ä¸ª-future-å®Œæ•´å®ç°çš„å†…éƒ¨ç»“æ„-å…¶å®å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºçš„è¿ç§»"></a></p>
</summary>
<div>
<p>è¿™æ®µï¼ˆä¼ªï¼‰ä»£ç å’Œä¹‹å‰å¼‚æ­¥å‡½æ•°æ˜¯ç­‰ä»·çš„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
async fn write_hello_file_async(name: &amp;str) -&gt; anyhow::Result&lt;()&gt; {
    let mut file = fs::File::create(name).await?;
    file.write_all(b&quot;hello world!&quot;).await?;

    Ok(())
}
</code></pre></pre>
<blockquote>
<p>Rust åœ¨ç¼–è¯‘ async fn æˆ–è€… async block æ—¶ï¼Œå°±ä¼šç”Ÿæˆç±»ä¼¼çš„çŠ¶æ€æœºçš„å®ç°ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œçœ‹ä¼¼ç®€å•çš„å¼‚æ­¥å¤„ç†ï¼Œå†…éƒ¨éšè—äº†ä¸€å¥—å¹¶ä¸éš¾ç†è§£ã€ä½†æ˜¯å†™èµ·æ¥å¾ˆç”Ÿç¡¬å¾ˆå•°å—¦çš„çŠ¶æ€æœºç®¡ç†ä»£ç ã€‚</p>
</blockquote>
</div>
</details>
<h2 id="ä¸ºä»€ä¹ˆéœ€è¦-pin"><a class="header" href="#ä¸ºä»€ä¹ˆéœ€è¦-pin">ä¸ºä»€ä¹ˆéœ€è¦ Pinï¼Ÿ</a></h2>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ Pinã€‚è¿™æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„æ•°æ®ç»“æ„ï¼Œæ­£å¸¸æ•°æ®ç»“æ„çš„æ–¹æ³•éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ self / &amp;self / &amp;mut selfï¼Œå¯æ˜¯ poll() å´ä½¿ç”¨äº† Pin&lt;&amp;mut self&gt;ï¼Œä¸ºä»€ä¹ˆï¼Ÿ
å¥½ææ˜ç™½è¿™ä¸ªé—®é¢˜ï¼Œå›åˆ° pin ã€‚åˆšæ‰æˆ‘ä»¬æ‰‹å†™çŠ¶æ€æœºä»£ç çš„è¿‡ç¨‹ï¼Œèƒ½å¸®ä½ ç†è§£ä¸ºä»€ä¹ˆä¼šéœ€è¦ Pin è¿™ä¸ªé—®é¢˜ã€‚</p>
<h3 id="å¼‚æ­¥ä»£ç ä¼šå‡ºç°è‡ªå¼•ç”¨ç»“æ„"><a class="header" href="#å¼‚æ­¥ä»£ç ä¼šå‡ºç°è‡ªå¼•ç”¨ç»“æ„">å¼‚æ­¥ä»£ç ä¼šå‡ºç°è‡ªå¼•ç”¨ç»“æ„</a></h3>
<details id="admonition-ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šå‡ºç°è‡ªå¼•ç”¨æ•°æ®ç»“æ„" class="admonition question">
<summary class="admonition-title">
<p>ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šå‡ºç°è‡ªå¼•ç”¨æ•°æ®ç»“æ„ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šå‡ºç°è‡ªå¼•ç”¨æ•°æ®ç»“æ„"></a></p>
</summary>
<div>
<p>åœ¨ä¸Šé¢å®ç° Future çš„çŠ¶æ€æœºä¸­ï¼Œæˆ‘ä»¬å¼•ç”¨äº† file è¿™æ ·ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
WriteHelloFile::AwaitingCreate(fut) =&gt; match fut.poll(cx) {
    Poll::Ready(Ok(file)) =&gt; {
        let fut = file.write_all(b&quot;hello world!&quot;);
        *self = WriteHelloFile::AwaitingWrite(fut);
    }
    Poll::Ready(Err(e)) =&gt; return Poll::Ready(Err(e)),
    Poll::Pending =&gt; return Poll::Pending,
}
</code></pre></pre>
<p>è¿™ä¸ªä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œfile è¢« fut å¼•ç”¨ï¼Œä½† file ä¼šåœ¨è¿™ä¸ªä½œç”¨åŸŸè¢«ä¸¢å¼ƒã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä¿å­˜åœ¨æ•°æ®ç»“æ„ä¸­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
enum WriteHelloFile {
    // åˆå§‹é˜¶æ®µï¼Œç”¨æˆ·æä¾›æ–‡ä»¶å
    Init(String),
    // ç­‰å¾…æ–‡ä»¶åˆ›å»ºï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨
    AwaitingCreate(impl Future&lt;Output = Result&lt;fs::File, std::io::Error&gt;&gt;),
    // ç­‰å¾…æ–‡ä»¶å†™å…¥ï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨
    AwaitingWrite(AwaitingWriteData),
    // Future å¤„ç†å®Œæ¯•
    Done,
}

struct AwaitingWriteData {
    fut: impl Future&lt;Output = Result&lt;(), std::io::Error&gt;&gt;,
    file: fs::File,
}
</code></pre></pre>
<ol>
<li>å¯ä»¥ç”Ÿæˆä¸€ä¸ª AwaitingWriteData æ•°æ®ç»“æ„ï¼ŒæŠŠ file å’Œ fut éƒ½æ”¾è¿›å»</li>
<li>ç„¶ååœ¨ WriteHelloFile ä¸­å¼•ç”¨å®ƒã€‚</li>
<li>æ­¤æ—¶ï¼Œåœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„å†…éƒ¨ï¼Œfut æŒ‡å‘äº†å¯¹ file çš„å¼•ç”¨ï¼Œè¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œå«è‡ªå¼•ç”¨ç»“æ„ï¼ˆSelf-Referential Structureï¼‰ã€‚</li>
</ol>
</div>
</details>
<blockquote>
<p>å¯ä»¥è¯´ï¼Œå¼‚æ­¥ä»£ç è¿™ç§çŠ¶æ€æœºæƒ…å†µä¸‹ï¼Œå®¹æ˜“å‡ºç°è‡ªå¼•ç”¨ç»“æ„</p>
</blockquote>
<blockquote>
<p>å½“ç„¶ï¼Œè‡ªå¼•ç”¨æ•°æ®ç»“æ„å¹¶éåªåœ¨å¼‚æ­¥ä»£ç é‡Œå‡ºç°ï¼Œåªä¸è¿‡å¼‚æ­¥ä»£ç åœ¨å†…éƒ¨ç”Ÿæˆç”¨çŠ¶æ€æœºè¡¨è¿°çš„ Future æ—¶ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿè‡ªå¼•ç”¨ç»“æ„ã€‚</p>
</blockquote>
<details id="admonition-æˆ‘ä»¬çœ‹ä¸€ä¸ªå’Œ-future-æ— å…³çš„ä¾‹å­ä»£ç " class="admonition bug">
<summary class="admonition-title">
<p>æˆ‘ä»¬çœ‹ä¸€ä¸ªå’Œ Future æ— å…³çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-æˆ‘ä»¬çœ‹ä¸€ä¸ªå’Œ-future-æ— å…³çš„ä¾‹å­ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[derive(Debug)]
struct SelfReference {
    name: String,
    // åœ¨åˆå§‹åŒ–åæŒ‡å‘ name
    name_ptr: *const String,
}

impl SelfReference {
    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {
        SelfReference {
            name: name.into(),
            name_ptr: std::ptr::null(),
        }
    }

    pub fn init(&amp;mut self) {
        self.name_ptr = &amp;self.name as *const String;
    }

    pub fn print_name(&amp;self) {
        println!(
            &quot;struct {:p}: (name: {:p} name_ptr: {:p}), name: {}, name_ref: {}&quot;,
            self,
            &amp;self.name,
            self.name_ptr,
            self.name,
            // åœ¨ä½¿ç”¨ ptr æ˜¯éœ€è¦ unsafe
            // SAFETY: è¿™é‡Œ name_ptr æ½œåœ¨ä¸å®‰å…¨ï¼Œä¼šæŒ‡å‘æ—§çš„ä½ç½®
            unsafe { &amp;*self.name_ptr },
        );
    }
}

fn main() {
    let data = move_creates_issue();
    println!(&quot;data: {:?}&quot;, data);
    // å¦‚æœæŠŠä¸‹é¢è¿™å¥æ³¨é‡Šæ‰ï¼Œç¨‹åºè¿è¡Œä¼šç›´æ¥ segment error
    // data.print_name();
    print!(&quot;\\n&quot;);
    mem_swap_creates_issue();
}

fn move_creates_issue() -&gt; SelfReference {
    let mut data = SelfReference::new(&quot;Tyr&quot;);
    data.init();

    // ä¸ moveï¼Œä¸€åˆ‡æ­£å¸¸
    data.print_name();

    let data = move_it(data);

    // move ä¹‹åï¼Œname_ref æŒ‡å‘çš„ä½ç½®æ˜¯å·²ç»å¤±æ•ˆçš„åœ°å€
    // åªä¸è¿‡ç°åœ¨ move å‰çš„åœ°å€è¿˜æ²¡è¢«å›æ”¶æŒªä½œå®ƒç”¨
    data.print_name();
    data
}

fn mem_swap_creates_issue() {
    let mut data1 = SelfReference::new(&quot;Tyr&quot;);
    data1.init();

    let mut data2 = SelfReference::new(&quot;Lindsey&quot;);
    data2.init();

    data1.print_name();
    data2.print_name();

    std::mem::swap(&amp;mut data1, &amp;mut data2);
    data1.print_name();
    data2.print_name();
}

fn move_it(data: SelfReference) -&gt; SelfReference {
    data
}
</code></pre></pre>
<ol>
<li>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè‡ªå¼•ç”¨ç»“æ„ SelfReferenceï¼Œå®ƒé‡Œé¢çš„ name_ref æŒ‡å‘äº† nameã€‚</li>
<li>æ­£å¸¸ä½¿ç”¨å®ƒæ—¶ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜</li>
<li>ä½†ä¸€æ—¦å¯¹è¿™ä¸ªç»“æ„åš move æ“ä½œï¼Œname_ref æŒ‡å‘çš„ä½ç½®è¿˜ä¼šæ˜¯ move å‰ name çš„åœ°å€ï¼Œè¿™å°±å¼•å‘äº†é—®é¢˜ã€‚çœ‹ä¸‹å›¾ï¼š</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961711.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<p>åŒæ ·çš„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ std::mem:swapï¼Œä¹Ÿä¼šå‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œä¸€æ—¦ swapï¼Œä¸¤ä¸ªæ•°æ®çš„å†…å®¹äº¤æ¢ï¼Œç„¶è€Œï¼Œç”±äº name_ref æŒ‡å‘çš„åœ°å€è¿˜æ˜¯æ—§çš„ï¼Œæ‰€ä»¥æ•´ä¸ªæŒ‡é’ˆä½“ç³»éƒ½æ··ä¹±äº†ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961697.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<p>çœ‹ä»£ç çš„è¾“å‡ºï¼Œè¾…åŠ©ä½ ç†è§£ï¼š</p>
<pre><code class="language-shell">
struct 0x7ffeea91d6e8: (name: 0x7ffeea91d6e8 name_ptr: 0x7ffeea91d6e8), name: Tyr, name_ref: Tyr
struct 0x7ffeea91d760: (name: 0x7ffeea91d760 name_ptr: 0x7ffeea91d6e8), name: Tyr, name_ref: Tyr
data: SelfReference { name: &quot;Tyr&quot;, name_ptr: 0x7ffeea91d6e8 }

struct 0x7ffeea91d6f0: (name: 0x7ffeea91d6f0 name_ptr: 0x7ffeea91d6f0), name: Tyr, name_ref: Tyr
struct 0x7ffeea91d710: (name: 0x7ffeea91d710 name_ptr: 0x7ffeea91d710), name: Lindsey, name_ref: Lindsey
struct 0x7ffeea91d6f0: (name: 0x7ffeea91d6f0 name_ptr: 0x7ffeea91d710), name: Lindsey, name_ref: Tyr
struct 0x7ffeea91d710: (name: 0x7ffeea91d710 name_ptr: 0x7ffeea91d6f0), name: Tyr, name_ref: Lindsey
</code></pre>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œswap ä¹‹åï¼Œname_ref æŒ‡å‘çš„å†…å®¹ç¡®å®å’Œ name ä¸ä¸€æ ·äº†ã€‚è¿™å°±æ˜¯è‡ªå¼•ç”¨ç»“æ„å¸¦æ¥çš„é—®é¢˜ã€‚</p>
</blockquote>
<p>ä½ ä¹Ÿè®¸ä¼šå¥‡æ€ªï¼Œä¸æ˜¯è¯´ move ä¹Ÿä¼šå‡ºé—®é¢˜ä¹ˆï¼Ÿä¸ºä»€ä¹ˆç¬¬äºŒè¡Œæ‰“å° name_ref è¿˜æ˜¯æŒ‡å‘äº† â€œTyrâ€ï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸º move åï¼Œä¹‹å‰çš„å†…å­˜å¤±æ•ˆï¼Œä½†æ˜¯å†…å­˜åœ°å€è¿˜æ²¡æœ‰è¢«æŒªä½œå®ƒç”¨ï¼Œæ‰€ä»¥è¿˜èƒ½æ­£å¸¸æ˜¾ç¤º â€œTyrâ€ã€‚ä½†è¿™æ ·çš„å†…å­˜è®¿é—®æ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æœä½ æŠŠ main ä¸­è¿™å¥ä»£ç æ³¨é‡Šæ‰ï¼Œç¨‹åºå°±ä¼š crashï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let data = move_creates_issue();
    println!(&quot;data: {:?}&quot;, data);
    // å¦‚æœæŠŠä¸‹é¢è¿™å¥æ³¨é‡Šæ‰ï¼Œç¨‹åºè¿è¡Œä¼šç›´æ¥ segment error
    // data.print_name();
    print!(&quot;\\n&quot;);
    mem_swap_creates_issue();
}
</code></pre></pre>
<blockquote>
<p>ç°åœ¨ä½ åº”è¯¥äº†è§£åˆ°åœ¨ Rust ä¸‹ï¼Œè‡ªå¼•ç”¨ç±»å‹å¸¦æ¥çš„æ½œåœ¨å±å®³äº†å§ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="è‡ªå¼•ç”¨ç»“æ„çš„é—®é¢˜"><a class="header" href="#è‡ªå¼•ç”¨ç»“æ„çš„é—®é¢˜">è‡ªå¼•ç”¨ç»“æ„çš„é—®é¢˜</a></h3>
<details id="admonition-è‡ªå¼•ç”¨ç»“æ„æœ‰ä»€ä¹ˆé—®é¢˜" class="admonition info">
<summary class="admonition-title">
<p>è‡ªå¼•ç”¨ç»“æ„æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-è‡ªå¼•ç”¨ç»“æ„æœ‰ä»€ä¹ˆé—®é¢˜"></a></p>
</summary>
<div>
<blockquote>
<p>è‡ªå¼•ç”¨ç»“æ„æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜æ˜¯ï¼šä¸€æ—¦å®ƒè¢«ç§»åŠ¨ï¼ŒåŸæœ¬çš„æŒ‡é’ˆå°±ä¼šæŒ‡å‘æ—§çš„åœ°å€ã€‚</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961729.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
</div>
</details>
<blockquote>
<p>æ‰€ä»¥éœ€è¦æœ‰æŸç§æœºåˆ¶æ¥ä¿è¯è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿã€‚</p>
</blockquote>
<h3 id="pinå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜"><a class="header" href="#pinå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜">Pinå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜</a></h3>
<details id="admonition-pinå®šä¹‰å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜" class="admonition question">
<summary class="admonition-title">
<p>Pinå®šä¹‰å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜?</p>
<p><a class="admonition-anchor-link" href="#admonition-pinå®šä¹‰å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜"></a></p>
</summary>
<div>
<p>Pin å°±æ˜¯ä¸ºè¿™ä¸ªç›®çš„è€Œè®¾è®¡çš„ä¸€ä¸ªæ•°æ®ç»“æ„: æˆ‘ä»¬å¯ä»¥ Pin ä½æŒ‡å‘ä¸€ä¸ª Future çš„æŒ‡é’ˆ</p>
<p>çœ‹æ–‡ç¨¿ä¸­ Pin çš„å£°æ˜ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct Pin&lt;P&gt; {
    pointer: P,
}

impl&lt;P: Deref&gt; Deref for Pin&lt;P&gt; {
    type Target = P::Target;
    fn deref(&amp;self) -&gt; &amp;P::Target {
        Pin::get_ref(Pin::as_ref(self))
    }
}

impl&lt;P: DerefMut&lt;Target: Unpin&gt;&gt; DerefMut for Pin&lt;P&gt; {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut P::Target {
        Pin::get_mut(Pin::as_mut(self))
    }
}
</code></pre></pre>
<ol>
<li>Pin æ‹¿ä½çš„æ˜¯ä¸€ä¸ªå¯ä»¥è§£å¼•ç”¨æˆ T çš„æŒ‡é’ˆç±»å‹ Pï¼Œè€Œä¸æ˜¯ç›´æ¥æ‹¿åŸæœ¬çš„ç±»å‹ Tã€‚</li>
<li>æ‰€ä»¥ï¼Œå¯¹äº Pin è€Œè¨€ï¼Œä½ çœ‹åˆ°çš„éƒ½æ˜¯ Pin&lt;Box<T>&gt;ã€Pin&lt;&amp;mut T&gt;ï¼Œä½†ä¸ä¼šæ˜¯ Pin<T>ã€‚</li>
<li>å› ä¸º Pin çš„ç›®çš„æ˜¯ï¼ŒæŠŠ T çš„å†…å­˜ä½ç½®é”ä½ï¼Œä»è€Œé¿å…ç§»åŠ¨åè‡ªå¼•ç”¨ç±»å‹å¸¦æ¥çš„å¼•ç”¨å¤±æ•ˆé—®é¢˜ã€‚</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961721.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<p>è¿™æ ·æ•°æ®ç»“æ„å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œä½†æ˜¯ä½ æ— æ³•ç›´æ¥æ‹¿åˆ°åŸæ¥çš„æ•°æ®ç»“æ„è¿›è€Œç§»åŠ¨å®ƒã€‚</p>
</div>
</details>
<blockquote>
<p>æ‰€ä»¥ï¼ŒPin çš„å‡ºç°ï¼Œå¯¹è§£å†³è¿™ç±»é—®é¢˜å¾ˆå…³é”®ï¼Œå¦‚æœä½ è¯•å›¾ç§»åŠ¨è¢« Pin ä½çš„æ•°æ®ç»“æ„:</p>
</blockquote>
<ul>
<li>è¦ä¹ˆï¼Œç¼–è¯‘å™¨ä¼šé€šè¿‡ç¼–è¯‘é”™è¯¯é˜»æ­¢ä½ ï¼›</li>
<li>è¦ä¹ˆï¼Œä½ å¼ºè¡Œä½¿ç”¨ unsafe Rustï¼Œè‡ªå·±è´Ÿè´£å…¶å®‰å…¨æ€§ã€‚</li>
</ul>
<details id="admonition-ä½¿ç”¨pinä¹‹åå¦‚ä½•è§£å†³é—®é¢˜" class="admonition question">
<summary class="admonition-title">
<p>ä½¿ç”¨pinä¹‹åå¦‚ä½•è§£å†³é—®é¢˜</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½¿ç”¨pinä¹‹åå¦‚ä½•è§£å†³é—®é¢˜"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬æ¥çœ‹ä½¿ç”¨ Pin åå¦‚ä½•é¿å…ç§»åŠ¨å¸¦æ¥çš„é—®é¢˜ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{marker::PhantomPinned, pin::Pin};

#[derive(Debug)]
struct SelfReference {
    name: String,
    // åœ¨åˆå§‹åŒ–åæŒ‡å‘ name
    name_ptr: *const String,
    // PhantomPinned å ä½ç¬¦
    _marker: PhantomPinned,
}

impl SelfReference {
    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {
        SelfReference {
            name: name.into(),
            name_ptr: std::ptr::null(),
            _marker: PhantomPinned,
        }
    }

    pub fn init(self: Pin&lt;&amp;mut Self&gt;) {
        let name_ptr = &amp;self.name as *const String;
        // SAFETY: è¿™é‡Œå¹¶ä¸ä¼šæŠŠä»»ä½•æ•°æ®ä» &amp;mut SelfReference ä¸­ç§»èµ°
        let this = unsafe { self.get_unchecked_mut() };
        this.name_ptr = name_ptr;
    }

    pub fn print_name(self: Pin&lt;&amp;Self&gt;) {
        println!(
            &quot;struct {:p}: (name: {:p} name_ptr: {:p}), name: {}, name_ref: {}&quot;,
            self,
            &amp;self.name,
            self.name_ptr,
            self.name,
            // åœ¨ä½¿ç”¨ ptr æ˜¯éœ€è¦ unsafe
            // SAFETY: å› ä¸ºæ•°æ®ä¸ä¼šç§»åŠ¨ï¼Œæ‰€ä»¥è¿™é‡Œ name_ptr æ˜¯å®‰å…¨çš„
            unsafe { &amp;*self.name_ptr },
        );
    }
}

fn main() {
    move_creates_issue();
}

fn move_creates_issue() {
    let mut data = SelfReference::new(&quot;Tyr&quot;);
    let mut data = unsafe { Pin::new_unchecked(&amp;mut data) };
    SelfReference::init(data.as_mut());

    // ä¸ moveï¼Œä¸€åˆ‡æ­£å¸¸
    data.as_ref().print_name();

    // ç°åœ¨åªèƒ½æ‹¿åˆ° pinned åçš„æ•°æ®ï¼Œæ‰€ä»¥ move ä¸äº†ä¹‹å‰
    move_pinned(data.as_mut());
    println!(&quot;{:?} ({:p})&quot;, data, &amp;data);

    // ä½ æ— æ³•æ‹¿å› Pin ä¹‹å‰çš„ SelfReference ç»“æ„ï¼Œæ‰€ä»¥è°ƒç”¨ä¸äº† move_it
    // move_it(data);
}

fn move_pinned(data: Pin&lt;&amp;mut SelfReference&gt;) {
    println!(&quot;{:?} ({:p})&quot;, data, &amp;data);
}

#[allow(dead_code)]
fn move_it(data: SelfReference) {
    println!(&quot;{:?} ({:p})&quot;, data, &amp;data);
}
</code></pre></pre>
<p>ç”±äºæ•°æ®ç»“æ„è¢«åŒ…è£¹åœ¨ Pin å†…éƒ¨ï¼Œæ‰€ä»¥åœ¨å‡½æ•°é—´ä¼ é€’æ—¶ï¼Œå˜åŒ–çš„åªæ˜¯æŒ‡å‘ data çš„ Pinï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961106.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
</div>
</details>
<h2 id="è”æƒ³unpin"><a class="header" href="#è”æƒ³unpin">è”æƒ³Unpin</a></h2>
<p>å­¦ä¹ äº† Pinï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æƒ³èµ· Unpin ã€‚</p>
<p>é‚£ä¹ˆï¼ŒUnpin æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</p>
<h3 id="unpinå£°æ˜å¯ä»¥ç§»åŠ¨"><a class="header" href="#unpinå£°æ˜å¯ä»¥ç§»åŠ¨">Unpinå£°æ˜å¯ä»¥ç§»åŠ¨</a></h3>
<details id="admonition-äº†è§£pinçš„ä½œç”¨åunpinæœ‰ä»€ä¹ˆç”¨" class="admonition info">
<summary class="admonition-title">
<p>äº†è§£pinçš„ä½œç”¨åï¼ŒUnpinæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-äº†è§£pinçš„ä½œç”¨åunpinæœ‰ä»€ä¹ˆç”¨"></a></p>
</summary>
<div>
<p>Pin æ˜¯ä¸ºäº†è®©æŸä¸ªæ•°æ®ç»“æ„æ— æ³•åˆæ³•åœ°ç§»åŠ¨ï¼Œè€Œ Unpin åˆ™ç›¸å½“äºå£°æ˜æ•°æ®ç»“æ„æ˜¯å¯ä»¥ç§»åŠ¨çš„.</p>
<blockquote>
<p>å®ƒçš„ä½œç”¨ç±»ä¼¼äº Send / Syncï¼Œé€šè¿‡ç±»å‹çº¦æŸæ¥å‘Šè¯‰ç¼–è¯‘å™¨å“ªäº›è¡Œä¸ºæ˜¯åˆæ³•çš„ã€å“ªäº›ä¸æ˜¯ã€‚</p>
</blockquote>
<p>åœ¨ Rust ä¸­ï¼Œç»å¤§å¤šæ•°æ•°æ®ç»“æ„éƒ½æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½è‡ªåŠ¨å®ç°äº† <a href="https://doc.rust-lang.org/std/marker/trait.Unpin.html">Unpin</a>ã€‚</p>
</div>
</details>
<details id="admonition-å£°æ˜unpinçš„ç»“æ„å³ä½¿è¢«-pin-åŒ…è£¹å®ƒä»¬ä¾æ—§å¯ä»¥è¿›è¡Œç§»åŠ¨æ¯”å¦‚" class="admonition info">
<summary class="admonition-title">
<p>å£°æ˜Unpinçš„ç»“æ„å³ä½¿è¢« Pin åŒ…è£¹ï¼Œå®ƒä»¬ä¾æ—§å¯ä»¥è¿›è¡Œç§»åŠ¨ï¼Œæ¯”å¦‚ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-å£°æ˜unpinçš„ç»“æ„å³ä½¿è¢«-pin-åŒ…è£¹å®ƒä»¬ä¾æ—§å¯ä»¥è¿›è¡Œç§»åŠ¨æ¯”å¦‚"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::mem;
use std::pin::Pin;

let mut string = &quot;this&quot;.to_string();
let mut pinned_string = Pin::new(&amp;mut string);

// We need a mutable reference to call `mem::replace`.
// We can obtain such a reference by (implicitly) invoking `Pin::deref_mut`,
// but that is only possible because `String` implements `Unpin`.
mem::replace(&amp;mut *pinned_string, &quot;other&quot;.to_string());
</code></pre></pre>
</div>
</details>
<h3 id="unpin"><a class="header" href="#unpin">!Unpin</a></h3>
<details id="admonition-å½“æˆ‘ä»¬ä¸å¸Œæœ›ä¸€ä¸ªæ•°æ®ç»“æ„è¢«ç§»åŠ¨å¯ä»¥ä½¿ç”¨-unpin" class="admonition info">
<summary class="admonition-title">
<p>å½“æˆ‘ä»¬ä¸å¸Œæœ›ä¸€ä¸ªæ•°æ®ç»“æ„è¢«ç§»åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ !Unpinã€‚</p>
<p><a class="admonition-anchor-link" href="#admonition-å½“æˆ‘ä»¬ä¸å¸Œæœ›ä¸€ä¸ªæ•°æ®ç»“æ„è¢«ç§»åŠ¨å¯ä»¥ä½¿ç”¨-unpin"></a></p>
</summary>
<div>
<p>åœ¨ Rust é‡Œï¼Œå®ç°äº† !Unpin çš„ï¼Œé™¤äº†å†…éƒ¨ç»“æ„ï¼ˆæ¯”å¦‚ Futureï¼‰ï¼Œä¸»è¦å°±æ˜¯ PhantomPinnedï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct PhantomPinned;
impl !Unpin for PhantomPinned {}
</code></pre></pre>
<p>æ‰€ä»¥ï¼Œå¦‚æœä½ å¸Œæœ›ä½ çš„æ•°æ®ç»“æ„ä¸èƒ½è¢«ç§»åŠ¨ï¼Œå¯ä»¥ä¸ºå…¶æ·»åŠ  PhantomPinned å­—æ®µæ¥éšå¼å£°æ˜ !Unpinã€‚</p>
</div>
</details>
<h3 id="unpinä¸pinçš„å…³ç³»"><a class="header" href="#unpinä¸pinçš„å…³ç³»">Unpinä¸Pinçš„å…³ç³»</a></h3>
<details id="admonition-å½“æ•°æ®ç»“æ„æ»¡è¶³-unpin-æ—¶åˆ›å»º-pin-ä»¥åŠä½¿ç”¨-pinä¸»è¦æ˜¯-derefmutéƒ½å¯ä»¥ä½¿ç”¨å®‰å…¨æ¥å£å¦åˆ™éœ€è¦ä½¿ç”¨-unsafe-æ¥å£" class="admonition info">
<summary class="admonition-title">
<p>å½“æ•°æ®ç»“æ„æ»¡è¶³ Unpin æ—¶ï¼Œåˆ›å»º Pin ä»¥åŠä½¿ç”¨ Pinï¼ˆä¸»è¦æ˜¯ DerefMutï¼‰éƒ½å¯ä»¥ä½¿ç”¨å®‰å…¨æ¥å£ï¼Œå¦åˆ™ï¼Œéœ€è¦ä½¿ç”¨ unsafe æ¥å£ï¼š</p>
<p><a class="admonition-anchor-link" href="#admonition-å½“æ•°æ®ç»“æ„æ»¡è¶³-unpin-æ—¶åˆ›å»º-pin-ä»¥åŠä½¿ç”¨-pinä¸»è¦æ˜¯-derefmutéƒ½å¯ä»¥ä½¿ç”¨å®‰å…¨æ¥å£å¦åˆ™éœ€è¦ä½¿ç”¨-unsafe-æ¥å£"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// å¦‚æœå®ç°äº† Unpinï¼Œå¯ä»¥é€šè¿‡å®‰å…¨æ¥å£åˆ›å»ºå’Œè¿›è¡Œ DerefMut
impl&lt;P: Deref&lt;Target: Unpin&gt;&gt; Pin&lt;P&gt; {
    pub const fn new(pointer: P) -&gt; Pin&lt;P&gt; {
        // SAFETY: the value pointed to is `Unpin`, and so has no requirements
        // around pinning.
        unsafe { Pin::new_unchecked(pointer) }
    }
    pub const fn into_inner(pin: Pin&lt;P&gt;) -&gt; P {
        pin.pointer
    }
}

impl&lt;P: DerefMut&lt;Target: Unpin&gt;&gt; DerefMut for Pin&lt;P&gt; {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut P::Target {
        Pin::get_mut(Pin::as_mut(self))
    }
}

// å¦‚æœæ²¡æœ‰å®ç° Unpinï¼Œåªèƒ½é€šè¿‡ unsafe æ¥å£åˆ›å»ºï¼Œä¸èƒ½ä½¿ç”¨ DerefMut
impl&lt;P: Deref&gt; Pin&lt;P&gt; {
    pub const unsafe fn new_unchecked(pointer: P) -&gt; Pin&lt;P&gt; {
        Pin { pointer }
    }

    pub const unsafe fn into_inner_unchecked(pin: Pin&lt;P&gt;) -&gt; P {
        pin.pointer
    }
}
</code></pre></pre>
</div>
</details>
<h3 id="boxtçš„unpinæ€è€ƒ"><a class="header" href="#boxtçš„unpinæ€è€ƒ">Box&lt;T&gt;çš„Unpinæ€è€ƒ</a></h3>
<details id="admonition-å¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„-t-unpinæˆ‘ä»¬ä¸ºå…¶ç”Ÿæˆ-boxé‚£ä¹ˆ-box-æ˜¯-unpin-è¿˜æ˜¯-unpin-çš„" class="admonition info">
<summary class="admonition-title">
<p>å¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„ T: !Unpinï¼Œæˆ‘ä»¬ä¸ºå…¶ç”Ÿæˆ Box<T>ï¼Œé‚£ä¹ˆ Box<T> æ˜¯ Unpin è¿˜æ˜¯ !Unpin çš„ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-å¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„-t-unpinæˆ‘ä»¬ä¸ºå…¶ç”Ÿæˆ-boxé‚£ä¹ˆ-box-æ˜¯-unpin-è¿˜æ˜¯-unpin-çš„"></a></p>
</summary>
<div>
<p>Box<T>æ˜¯Unpinï¼Œå› ä¸ºBox<T>å®ç°äº†Unpin trait</p>
</div>
</details>
<h1 id="å›é¡¾æ•´ç†futureçš„contextpinunpinä»¥åŠasyncawait"><a class="header" href="#å›é¡¾æ•´ç†futureçš„contextpinunpinä»¥åŠasyncawait">å›é¡¾æ•´ç†Futureçš„Contextã€Pin/Unpinï¼Œä»¥åŠasync/await</a></h1>
<details id="admonition-å›é¡¾æ•´ç†futureçš„contextpinunpinä»¥åŠasyncawait" class="admonition info">
<summary class="admonition-title">
<p>å›é¡¾æ•´ç†Futureçš„Contextã€Pin/Unpinï¼Œä»¥åŠasync/await</p>
<p><a class="admonition-anchor-link" href="#admonition-å›é¡¾æ•´ç†futureçš„contextpinunpinä»¥åŠasyncawait"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<blockquote>
<p>å¹¶å‘ä»»åŠ¡è¿è¡Œåœ¨ Future è¿™æ ·çš„åç¨‹ä¸Šæ—¶ï¼Œasync/await æ˜¯äº§ç”Ÿå’Œè¿è¡Œå¹¶å‘ä»»åŠ¡çš„æ‰‹æ®µï¼Œasync å®šä¹‰ä¸€ä¸ªå¯ä»¥å¹¶å‘æ‰§è¡Œçš„ Future ä»»åŠ¡ï¼Œawait è§¦å‘è¿™ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚å…·ä½“æ¥è¯´ï¼š</p>
</blockquote>
<ol>
<li>å½“æˆ‘ä»¬ä½¿ç”¨ async å…³é”®å­—æ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ª impl Future çš„ç»“æœã€‚</li>
<li>å¯¹äºä¸€ä¸ª async block æˆ–è€… async fn æ¥è¯´ï¼Œå†…éƒ¨çš„æ¯ä¸ª await éƒ½ä¼šè¢«ç¼–è¯‘å™¨æ•æ‰ï¼Œå¹¶æˆä¸ºè¿”å›çš„ Future çš„ poll() æ–¹æ³•çš„å†…éƒ¨çŠ¶æ€æœºçš„ä¸€ä¸ªçŠ¶æ€ã€‚</li>
<li>Rust çš„ Future éœ€è¦å¼‚æ­¥è¿è¡Œæ—¶æ¥è¿è¡Œ Future</li>
</ol>
<ul>
<li>ä»¥ tokio ä¸ºä¾‹ï¼Œå®ƒçš„ executor ä¼šä» run queue ä¸­å–å‡º Future è¿›è¡Œ poll()</li>
<li>å½“ poll() è¿”å› Pending æ—¶ï¼Œè¿™ä¸ª Future ä¼šè¢«æŒ‚èµ·</li>
<li>ç›´åˆ° reactor å¾—åˆ°äº†æŸä¸ªäº‹ä»¶ï¼Œå”¤é†’è¿™ä¸ª Futureï¼Œå°†å…¶æ·»åŠ å› run queue ç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œã€‚</li>
<li>tokio ä¸€èˆ¬ä¼šåœ¨æ¯ä¸ªç‰©ç†çº¿ç¨‹ï¼ˆæˆ–è€… CPU coreï¼‰ä¸‹è¿è¡Œä¸€ä¸ªçº¿ç¨‹</li>
<li>æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ run queue æ¥å¤„ç† Futureã€‚</li>
<li>ä¸ºäº†æä¾›æœ€å¤§çš„ååé‡ï¼Œtokio å®ç°äº† work stealing schedulerï¼Œè¿™æ ·ï¼Œå½“æŸä¸ªçº¿ç¨‹ä¸‹æ²¡æœ‰å¯æ‰§è¡Œçš„ Futureï¼Œå®ƒä¼šä»å…¶å®ƒçº¿ç¨‹çš„ run queue ä¸­â€œå·â€ä¸€ä¸ªæ‰§è¡Œã€‚</li>
</ul>
</div>
</details>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="5_2_future_async_await.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="6_unsafe_ffi.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="5_2_future_async_await.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="6_unsafe_ffi.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
