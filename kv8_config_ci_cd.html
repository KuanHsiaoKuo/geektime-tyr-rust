<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a></li><li class="chapter-item "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a></li><li class="chapter-item "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a></li><li class="chapter-item "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item "><a href="5_2_future_async_await.html"><strong aria-hidden="true">4.5.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">4.5.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html" class="active"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="å…«é…ç½®æµ‹è¯•ç›‘æ§cicd"><a class="header" href="#å…«é…ç½®æµ‹è¯•ç›‘æ§cicd">å…«ã€é…ç½®/æµ‹è¯•/ç›‘æ§/CI/CD</a></h1>
<!--ts-->
<ul>
<li><a href="#%E5%85%AB%E9%85%8D%E7%BD%AE%E6%B5%8B%E8%AF%95%E7%9B%91%E6%8E%A7cicd">å…«ã€é…ç½®/æµ‹è¯•/ç›‘æ§/CI/CD</a>
<ul>
<li><a href="#%E9%85%8D%E7%BD%AE">é…ç½®</a></li>
<li><a href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95">é›†æˆæµ‹è¯•</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95">æ€§èƒ½æµ‹è¯•</a></li>
<li><a href="#%E6%B5%8B%E9%87%8F%E5%92%8C%E7%9B%91%E6%8E%A7">æµ‹é‡å’Œç›‘æ§</a></li>
<li><a href="#cicd">CI/CD</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct 12 02:34:54 UTC 2022 -->
<!--te-->
<p>è™½ç„¶è¿™æ˜¯ä¸€ä¸ªâ€œç®€å•â€çš„ KV serverï¼š</p>
<ul>
<li>å®ƒæ²¡æœ‰å¤æ‚çš„æ€§èƒ½ä¼˜åŒ–ï¼šåªç”¨äº†ä¸€å¥ unsafeï¼›</li>
<li>ä¹Ÿæ²¡æœ‰å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†ï¼šåªæœ‰é›¶æ˜Ÿ â€™static æ ‡æ³¨ï¼›</li>
<li>æ›´æ²¡æœ‰æ”¯æŒé›†ç¾¤çš„å¤„ç†ã€‚</li>
</ul>
<blockquote>
<p>ç„¶è€Œï¼Œå¦‚æœä½ èƒ½å¤Ÿç†è§£åˆ°ç›®å‰ä¸ºæ­¢çš„ä»£ç ï¼Œç”šè‡³èƒ½ç‹¬ç«‹å†™å‡ºè¿™æ ·çš„ä»£ç ï¼Œé‚£ä¹ˆï¼Œä½ å·²ç»å…·å¤‡è¶³å¤Ÿçš„ã€èƒ½åœ¨ä¸€çº¿å¤§å‚å¼€å‘çš„å®åŠ›äº†ï¼Œå›½å†…æˆ‘ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œä½†åœ¨åŒ—ç¾è¿™è¾¹ï¼Œä¿å®ˆä¸€äº›åœ°è¯´ï¼Œ300k+ USD çš„ package åº”è¯¥å¯ä»¥è½»æ¾æ‹¿åˆ°ã€‚</p>
</blockquote>
<p>ä»Šå¤©æˆ‘ä»¬å°±ç»™ KV server é¡¹ç›®æ”¶ä¸ªå°¾ï¼Œç»“åˆä¹‹å‰æ¢³ç†çš„å®æˆ˜ä¸­ Rust é¡¹ç›®åº”è¯¥è€ƒè™‘çš„é—®é¢˜ï¼Œæ¥èŠèŠå’Œç”Ÿäº§ç¯å¢ƒæœ‰å…³çš„ä¸€äº›å¤„ç†ï¼ŒæŒ‰å¼€å‘æµç¨‹ï¼Œä¸»è¦è®²äº”ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>é…ç½®</li>
<li>é›†æˆæµ‹è¯•</li>
<li>æ€§èƒ½æµ‹è¯•</li>
<li>æµ‹é‡å’Œç›‘æ§</li>
<li>CI/CD</li>
</ul>
<h2 id="é…ç½®"><a class="header" href="#é…ç½®">é…ç½®</a></h2>
<ol>
<li>é¦–å…ˆåœ¨ Cargo.toml é‡Œæ·»åŠ  <a href="https://github.com/serde-rs/serde">serde</a> å’Œ<a href="https://github.com/toml-rs/toml-rs"> toml</a>ã€‚æˆ‘ä»¬è®¡åˆ’ï¼š</li>
</ol>
<ul>
<li>ä½¿ç”¨ toml åšé…ç½®æ–‡ä»¶</li>
<li>serde ç”¨æ¥å¤„ç†é…ç½®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</li>
</ul>
<details id="admonition-cargotoml" class="admonition note">
<summary class="admonition-title">
<p>Cargo.toml</p>
<p><a class="admonition-anchor-link" href="#admonition-cargotoml"></a></p>
</summary>
<div>
<pre><code class="language-toml">
[dependencies]
...
serde = { version = &quot;1&quot;, features = [&quot;derive&quot;] } # åºåˆ—åŒ–/ååºåˆ—åŒ–
...
toml = &quot;0.5&quot; # toml æ”¯æŒ
...
</code></pre>
</div>
</details>
<details id="admonition-2-ç„¶åæ¥åˆ›å»ºä¸€ä¸ª-srcconfigrsæ„å»º-kv-server-çš„é…ç½®" class="admonition note">
<summary class="admonition-title">
<ol start="2">
<li>ç„¶åæ¥åˆ›å»ºä¸€ä¸ª src/config.rsï¼Œæ„å»º KV server çš„é…ç½®ï¼š</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-ç„¶åæ¥åˆ›å»ºä¸€ä¸ª-srcconfigrsæ„å»º-kv-server-çš„é…ç½®"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use crate::KvError;
use serde::{Deserialize, Serialize};
use std::fs;

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ServerConfig {
    pub general: GeneralConfig,
    pub storage: StorageConfig,
    pub tls: ServerTlsConfig,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ClientConfig {
    pub general: GeneralConfig,
    pub tls: ClientTlsConfig,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct GeneralConfig {
    pub addr: String,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
#[serde(tag = &quot;type&quot;, content = &quot;args&quot;)]
pub enum StorageConfig {
    MemTable,
    SledDb(String),
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ServerTlsConfig {
    pub cert: String,
    pub key: String,
    pub ca: Option&lt;String&gt;,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ClientTlsConfig {
    pub domain: String,
    pub identity: Option&lt;(String, String)&gt;,
    pub ca: Option&lt;String&gt;,
}

impl ServerConfig {
    pub fn load(path: &amp;str) -&gt; Result&lt;Self, KvError&gt; {
        let config = fs::read_to_string(path)?;
        let config: Self = toml::from_str(&amp;config)?;
        Ok(config)
    }
}

impl ClientConfig {
    pub fn load(path: &amp;str) -&gt; Result&lt;Self, KvError&gt; {
        let config = fs::read_to_string(path)?;
        let config: Self = toml::from_str(&amp;config)?;
        Ok(config)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn server_config_should_be_loaded() {
        let result: Result&lt;ServerConfig, toml::de::Error&gt; =
            toml::from_str(include_str!(&quot;../fixtures/server.conf&quot;));
        assert!(result.is_ok());
    }

    #[test]
    fn client_config_should_be_loaded() {
        let result: Result&lt;ClientConfig, toml::de::Error&gt; =
            toml::from_str(include_str!(&quot;../fixtures/client.conf&quot;));
        assert!(result.is_ok());
    }
}
</code></pre></pre>
</div>
</details>
<p>ä½ å¯ä»¥çœ‹åˆ°:</p>
<ul>
<li>åœ¨ Rust ä¸‹ï¼Œæœ‰äº† serde çš„å¸®åŠ©ï¼Œå¤„ç†ä»»ä½•å·²çŸ¥æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œæ˜¯å¤šä¹ˆå®¹æ˜“çš„ä¸€ä»¶äº‹æƒ…ã€‚</li>
<li>æˆ‘ä»¬åªéœ€è¦å®šä¹‰æ•°æ®ç»“æ„ï¼Œå¹¶ä¸ºæ•°æ®ç»“æ„ä½¿ç”¨ Serialize/Deserialize æ´¾ç”Ÿå®ï¼Œå°±å¯ä»¥å¤„ç†ä»»ä½•æ”¯æŒ serde çš„æ•°æ®ç»“æ„ã€‚</li>
</ul>
<details id="admonition-3-examplesgen_configrs-ç”¨æ¥ç”Ÿæˆtomlé…ç½®æ–‡ä»¶" class="admonition info">
<summary class="admonition-title">
<ol start="3">
<li>examples/gen_config.rs, ç”¨æ¥ç”Ÿæˆtomlé…ç½®æ–‡ä»¶</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-3-examplesgen_configrs-ç”¨æ¥ç”Ÿæˆtomlé…ç½®æ–‡ä»¶"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use crate::KvError;
use serde::{Deserialize, Serialize};
use std::fs;

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ServerConfig {
    pub general: GeneralConfig,
    pub storage: StorageConfig,
    pub tls: ServerTlsConfig,
    pub log: LogConfig,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ClientConfig {
    pub general: GeneralConfig,
    pub tls: ClientTlsConfig,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct GeneralConfig {
    pub addr: String,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct LogConfig {
    pub path: String,
    pub rotation: RotationConfig,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub enum RotationConfig {
    Hourly,
    Daily,
    Never,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
#[serde(tag = &quot;type&quot;, content = &quot;args&quot;)]
pub enum StorageConfig {
    MemTable,
    SledDb(String),
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ServerTlsConfig {
    pub cert: String,
    pub key: String,
    pub ca: Option&lt;String&gt;,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ClientTlsConfig {
    pub domain: String,
    pub identity: Option&lt;(String, String)&gt;,
    pub ca: Option&lt;String&gt;,
}

impl ServerConfig {
    pub fn load(path: &amp;str) -&gt; Result&lt;Self, KvError&gt; {
        let config = fs::read_to_string(path)?;
        let config: Self = toml::from_str(&amp;config)?;
        Ok(config)
    }
}

impl ClientConfig {
    pub fn load(path: &amp;str) -&gt; Result&lt;Self, KvError&gt; {
        let config = fs::read_to_string(path)?;
        let config: Self = toml::from_str(&amp;config)?;
        Ok(config)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn server_config_should_be_loaded() {
        let result: Result&lt;ServerConfig, toml::de::Error&gt; =
            toml::from_str(include_str!(&quot;../fixtures/server.conf&quot;));
        assert!(result.is_ok());
    }

    #[test]
    fn client_config_should_be_loaded() {
        let result: Result&lt;ClientConfig, toml::de::Error&gt; =
            toml::from_str(include_str!(&quot;../fixtures/client.conf&quot;));
        assert!(result.is_ok());
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-ä¸‹é¢æ˜¯ç”Ÿæˆçš„æœåŠ¡ç«¯çš„é…ç½®" class="admonition note">
<summary class="admonition-title">
<p>ä¸‹é¢æ˜¯ç”Ÿæˆçš„æœåŠ¡ç«¯çš„é…ç½®ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸‹é¢æ˜¯ç”Ÿæˆçš„æœåŠ¡ç«¯çš„é…ç½®"></a></p>
</summary>
<div>
<pre><code class="language-toml">
[general]
addr = '127.0.0.1:9527'

[storage]
type = 'SledDb'
args = '/tmp/kv_server'

[tls]
cert = &quot;&quot;&quot;
-----BEGIN CERTIFICATE-----\r
MIIBdzCCASmgAwIBAgIICpy02U2yuPowBQYDK2VwMDMxCzAJBgNVBAYMAkNOMRIw\r
EAYDVQQKDAlBY21lIEluYy4xEDAOBgNVBAMMB0FjbWUgQ0EwHhcNMjEwOTI2MDEy\r
NTU5WhcNMjYwOTI1MDEyNTU5WjA6MQswCQYDVQQGDAJDTjESMBAGA1UECgwJQWNt\r
ZSBJbmMuMRcwFQYDVQQDDA5BY21lIEtWIHNlcnZlcjAqMAUGAytlcAMhAK2Z2AjF\r
A0uiltNuCvl6EVFl6tpaS/wJYB5IdWT2IISdo1QwUjAcBgNVHREEFTATghFrdnNl\r
cnZlci5hY21lLmluYzATBgNVHSUEDDAKBggrBgEFBQcDATAMBgNVHRMEBTADAQEA\r
MA8GA1UdDwEB/wQFAwMH4AAwBQYDK2VwA0EASGOmOWFPjbGhXNOmYNCa3lInbgRy\r
iTNtB/5kElnbKkhKhRU7yQ8HTHWWkyU5WGWbOOIXEtYp+5ERUJC+mzP9Bw==\r
-----END CERTIFICATE-----\r
&quot;&quot;&quot;
key = &quot;&quot;&quot;
-----BEGIN PRIVATE KEY-----\r
MFMCAQEwBQYDK2VwBCIEIPMyINaewhXwuTPUufFO2mMt/MvQMHrGDGxgdgfy/kUu\r
oSMDIQCtmdgIxQNLopbTbgr5ehFRZeraWkv8CWAeSHVk9iCEnQ==\r
-----END PRIVATE KEY-----\r
&quot;&quot;&quot;
</code></pre>
</div>
</details>
<p>æœ‰äº†é…ç½®æ–‡ä»¶çš„æ”¯æŒï¼Œå°±å¯ä»¥åœ¨ lib.rs ä¸‹å†™ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œè®©æˆ‘ä»¬åˆ›å»ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ›´åŠ ç®€å•ï¼š</p>
<details id="admonition-examplesgen_configrs" class="admonition info">
<summary class="admonition-title">
<p>examples/gen_config.rs</p>
<p><a class="admonition-anchor-link" href="#admonition-examplesgen_configrs"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">mod config;
mod error;
mod network;
mod pb;
mod service;
mod storage;

pub use config::*;
pub use error::KvError;
pub use network::*;
pub use pb::abi::*;
pub use service::*;
pub use storage::*;

use anyhow::Result;
use tokio::net::{TcpListener, TcpStream};
use tokio_rustls::client;
use tokio_util::compat::FuturesAsyncReadCompatExt;
use tracing::{info, instrument, span};

/// é€šè¿‡é…ç½®åˆ›å»º KV æœåŠ¡å™¨
#[instrument(skip_all)]
pub async fn start_server_with_config(config: &amp;ServerConfig) -&gt; Result&lt;()&gt; {
    let acceptor =
        TlsServerAcceptor::new(&amp;config.tls.cert, &amp;config.tls.key, config.tls.ca.as_deref())?;

    let addr = &amp;config.general.addr;
    match &amp;config.storage {
        StorageConfig::MemTable =&gt; start_tls_server(addr, MemTable::new(), acceptor).await?,
        StorageConfig::SledDb(path) =&gt; start_tls_server(addr, SledDb::new(path), acceptor).await?,
    };

    Ok(())
}

/// é€šè¿‡é…ç½®åˆ›å»º KV å®¢æˆ·ç«¯
#[instrument(skip_all)]
pub async fn start_client_with_config(
    config: &amp;ClientConfig,
) -&gt; Result&lt;YamuxCtrl&lt;client::TlsStream&lt;TcpStream&gt;&gt;&gt; {
    let addr = &amp;config.general.addr;
    let tls = &amp;config.tls;

    let identity = tls.identity.as_ref().map(|(c, k)| (c.as_str(), k.as_str()));
    let connector = TlsClientConnector::new(&amp;tls.domain, identity, tls.ca.as_deref())?;
    let stream = TcpStream::connect(addr).await?;
    let stream = connector.connect(stream).await?;

    // æ‰“å¼€ä¸€ä¸ª stream
    Ok(YamuxCtrl::new_client(stream, None))
}

async fn start_tls_server&lt;Store: Storage&gt;(
    addr: &amp;str,
    store: Store,
    acceptor: TlsServerAcceptor,
) -&gt; Result&lt;()&gt; {
    let service: Service&lt;Store&gt; = ServiceInner::new(store).into();
    let listener = TcpListener::bind(addr).await?;
    info!(&quot;Start listening on {}&quot;, addr);
    loop {
        let root = span!(tracing::Level::INFO, &quot;server_process&quot;);
        let _enter = root.enter();
        let tls = acceptor.clone();
        let (stream, addr) = listener.accept().await?;
        info!(&quot;Client {:?} connected&quot;, addr);

        let svc = service.clone();
        tokio::spawn(async move {
            let stream = tls.accept(stream).await.unwrap();
            YamuxCtrl::new_server(stream, None, move |stream| {
                let svc1 = svc.clone();
                async move {
                    let stream = ProstServerStream::new(stream.compat(), svc1.clone());
                    stream.process().await.unwrap();
                    Ok(())
                }
            });
        });
    }
}
</code></pre></pre>
</div>
</details>
<p>æœ‰äº† start_server_with_config å’Œ start_client_with_config è¿™ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç®€åŒ– src/server.rs å’Œ src/client.rs äº†ã€‚</p>
<details id="admonition-ä¸‹é¢æ˜¯-srcserverrs-çš„æ–°ä»£ç " class="admonition note">
<summary class="admonition-title">
<p>ä¸‹é¢æ˜¯ src/server.rs çš„æ–°ä»£ç ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸‹é¢æ˜¯-srcserverrs-çš„æ–°ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use kv6::{start_server_with_config, ServerConfig};

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();
    let config: ServerConfig = toml::from_str(include_str!(&quot;../fixtures/server.conf&quot;))?;

    start_server_with_config(&amp;config).await?;

    Ok(())
}
</code></pre></pre>
</div>
</details>
<details id="admonition-examplesgen_configrs-1" class="admonition info">
<summary class="admonition-title">
<p>examples/gen_config.rs</p>
<p><a class="admonition-anchor-link" href="#admonition-examplesgen_configrs-1"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::env;

use anyhow::Result;
use kv6::{start_server_with_config, RotationConfig, ServerConfig};
use tokio::fs;
use tracing::span;
use tracing_subscriber::{
    fmt::{self, format},
    layer::SubscriberExt,
    prelude::*,
    EnvFilter,
};

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let config = match env::var(&quot;KV_SERVER_CONFIG&quot;) {
        Ok(path) =&gt; fs::read_to_string(&amp;path).await?,
        Err(_) =&gt; include_str!(&quot;../fixtures/server.conf&quot;).to_string(),
    };
    let config: ServerConfig = toml::from_str(&amp;config)?;

    let tracer = opentelemetry_jaeger::new_pipeline()
        .with_service_name(&quot;kv-server&quot;)
        .install_simple()?;
    let opentelemetry = tracing_opentelemetry::layer().with_tracer(tracer);

    // æ·»åŠ 
    let log = &amp;config.log;
    let file_appender = match log.rotation {
        RotationConfig::Hourly =&gt; tracing_appender::rolling::hourly(&amp;log.path, &quot;server.log&quot;),
        RotationConfig::Daily =&gt; tracing_appender::rolling::daily(&amp;log.path, &quot;server.log&quot;),
        RotationConfig::Never =&gt; tracing_appender::rolling::never(&amp;log.path, &quot;server.log&quot;),
    };

    let (non_blocking, _guard1) = tracing_appender::non_blocking(file_appender);
    let fmt_layer = fmt::layer()
        .event_format(format().compact())
        .with_writer(non_blocking);

    tracing_subscriber::registry()
        .with(EnvFilter::from_default_env())
        .with(fmt_layer)
        .with(opentelemetry)
        .init();

    let root = span!(tracing::Level::INFO, &quot;app_start&quot;, work_units = 2);
    let _enter = root.enter();

    start_server_with_config(&amp;config).await?;

    Ok(())
}
</code></pre></pre>
</div>
</details>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªä»£ç ç®€æ´äº†å¾ˆå¤šã€‚åœ¨è¿™ä¸ªé‡æ„çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰ä¸€äº›å…¶å®ƒæ”¹åŠ¨ï¼Œä½ å¯ä»¥çœ‹ GitHub repo ä¸‹ 45 è®²çš„ diff_configã€‚</p>
<h2 id="é›†æˆæµ‹è¯•"><a class="header" href="#é›†æˆæµ‹è¯•">é›†æˆæµ‹è¯•</a></h2>
<p>ä¹‹å‰æˆ‘ä»¬å†™äº†å¾ˆå¤šå•å…ƒæµ‹è¯•ï¼Œä½†è¿˜æ²¡æœ‰å†™è¿‡ä¸€è¡Œé›†æˆæµ‹è¯•ã€‚ä»Šå¤©å°±æ¥å†™ä¸€ä¸ªç®€å•çš„é›†æˆæµ‹è¯•ï¼Œç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å®Œæ•´çš„äº¤äº’å·¥ä½œæ­£å¸¸ã€‚</p>
<p>ä¹‹å‰æåˆ°åœ¨ Rust é‡Œï¼Œé›†æˆæµ‹è¯•æ”¾åœ¨ tests ç›®å½•ä¸‹ï¼Œæ¯ä¸ªæµ‹è¯•ç¼–æˆå•ç‹¬çš„äºŒè¿›åˆ¶ã€‚</p>
<ol>
<li>æ‰€ä»¥é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºå’Œ src å¹³è¡Œçš„ tests ç›®å½•ã€‚</li>
<li>ç„¶åå†åˆ›å»º tests/server.rsï¼Œå¡«å…¥ä»¥ä¸‹ä»£ç ï¼š</li>
</ol>
<details id="admonition-examplesgen_configrs-2" class="admonition info">
<summary class="admonition-title">
<p>examples/gen_config.rs</p>
<p><a class="admonition-anchor-link" href="#admonition-examplesgen_configrs-2"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use anyhow::Result;
use kv6::{
    start_client_with_config, start_server_with_config, ClientConfig, CommandRequest, ServerConfig,
    StorageConfig,
};
use std::time::Duration;
use tokio::time;

#[tokio::test]
async fn yamux_server_client_full_tests() -&gt; Result&lt;()&gt; {
    let addr = &quot;127.0.0.1:10086&quot;;

    let mut config: ServerConfig = toml::from_str(include_str!(&quot;../fixtures/server.conf&quot;))?;
    config.general.addr = addr.into();
    config.storage = StorageConfig::MemTable;

    // å¯åŠ¨æœåŠ¡å™¨
    tokio::spawn(async move {
        start_server_with_config(&amp;config).await.unwrap();
    });

    time::sleep(Duration::from_millis(10)).await;
    let mut config: ClientConfig = toml::from_str(include_str!(&quot;../fixtures/client.conf&quot;))?;
    config.general.addr = addr.into();

    let mut ctrl = start_client_with_config(&amp;config).await.unwrap();
    let mut stream = ctrl.open_stream().await?;

    // ç”Ÿæˆä¸€ä¸ª HSET å‘½ä»¤
    let cmd = CommandRequest::new_hset(&quot;table1&quot;, &quot;hello&quot;, &quot;world&quot;.to_string().into());
    stream.execute_unary(&amp;cmd).await?;

    // ç”Ÿæˆä¸€ä¸ª HGET å‘½ä»¤
    let cmd = CommandRequest::new_hget(&quot;table1&quot;, &quot;hello&quot;);
    let data = stream.execute_unary(&amp;cmd).await?;

    assert_eq!(data.status, 200);
    assert_eq!(data.values, &amp;[&quot;world&quot;.into()]);

    Ok(())
}
</code></pre></pre>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œé›†æˆæµ‹è¯•çš„å†™æ³•å’Œå•å…ƒæµ‹è¯•å…¶å®å¾ˆç±»ä¼¼ï¼Œåªä¸è¿‡æˆ‘ä»¬ä¸éœ€è¦å†ä½¿ç”¨ #[cfg(test)] æ¥åšæ¡ä»¶ç¼–è¯‘ã€‚</p>
</blockquote>
<pre><code class="language-admonish note title=&quot;å¦‚æœä½ çš„é›†æˆæµ‹è¯•æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦æ¯”è¾ƒå¤šçš„è¾…åŠ©ä»£ç ï¼Œé‚£ä¹ˆä½ è¿˜å¯ä»¥:&quot; collapsible=true">1. åœ¨ tests ä¸‹ cargo new å‡ºä¸€ä¸ªé¡¹ç›®
2. ç„¶ååœ¨é‚£ä¸ªé¡¹ç›®é‡Œæ’°å†™è¾…åŠ©ä»£ç å’Œæµ‹è¯•ä»£ç 
3. å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹[ tonic çš„é›†æˆæµ‹è¯•](https://github.com/hyperium/tonic/tree/master/tests)ã€‚
4. ä¸è¿‡æ³¨æ„äº†,é›†æˆæµ‹è¯•å’Œä½ çš„ crate ç”¨åŒæ ·çš„æ¡ä»¶ç¼–è¯‘ï¼Œæ‰€ä»¥åœ¨é›†æˆæµ‹è¯•é‡Œï¼Œæ— æ³•ä½¿ç”¨å•å…ƒæµ‹è¯•ä¸­æ„å»ºçš„è¾…åŠ©ä»£ç ã€‚

&lt;/div&gt;
&lt;/details&gt;

## æ€§èƒ½æµ‹è¯•

åœ¨ä¹‹å‰ä¸æ–­å®Œå–„ KV server çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¸€å®šä¼šå¥½å¥‡ï¼šæˆ‘ä»¬çš„ KV server æ€§èƒ½ç©¶ç«Ÿå¦‚ä½•å‘¢ï¼Ÿé‚£æ¥å†™ä¸€ä¸ªå…³äº Pub/Sub çš„æ€§èƒ½æµ‹è¯•å§ã€‚

åŸºæœ¬çš„æƒ³æ³•æ˜¯æˆ‘ä»¬è¿ä¸Š 100 ä¸ª subscriber ä½œä¸ºèƒŒæ™¯ï¼Œç„¶åçœ‹ publisher publish çš„é€Ÿåº¦ã€‚

å› ä¸º BROADCAST_CAPACITY æœ‰é™ï¼Œæ˜¯ 128ï¼Œå½“ publisher é€Ÿåº¦å¤ªå¿«ï¼Œè€Œå¯¼è‡´ server ä¸èƒ½åŠæ—¶å¾€ subscriber å‘é€æ—¶ï¼Œserver æ¥æ”¶ client æ•°æ®çš„é€Ÿåº¦å°±ä¼šé™ä¸‹æ¥ï¼Œæ— æ³•æ¥æ”¶æ–°çš„
clientï¼Œæ•´ä½“çš„ publish çš„é€Ÿåº¦ä¹Ÿä¼šé™ä¸‹æ¥ï¼Œæ‰€ä»¥è¿™ä¸ªæµ‹è¯•èƒ½å¤Ÿäº†è§£ server å¤„ç† publish çš„é€Ÿåº¦ã€‚


&lt;details id=&quot;admonition-ä¸ºäº†ç¡®è®¤è¿™ä¸€ç‚¹æˆ‘ä»¬åœ¨-start_tls_server-å‡½æ•°ä¸­åœ¨-process-ä¹‹å‰å†åŠ ä¸ª-100ms-çš„å»¶æ—¶äººä¸ºå‡ç¼“ç³»ç»Ÿçš„å¤„ç†é€Ÿåº¦&quot; class=&quot;admonition note&quot;&gt;
&lt;summary class=&quot;admonition-title&quot;&gt;

ä¸ºäº†ç¡®è®¤è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨ start_tls_server() å‡½æ•°ä¸­ï¼Œåœ¨ process() ä¹‹å‰ï¼Œå†åŠ ä¸ª 100ms çš„å»¶æ—¶ï¼Œäººä¸ºå‡ç¼“ç³»ç»Ÿçš„å¤„ç†é€Ÿåº¦ï¼š

&lt;a class=&quot;admonition-anchor-link&quot; href=&quot;#admonition-ä¸ºäº†ç¡®è®¤è¿™ä¸€ç‚¹æˆ‘ä»¬åœ¨-start_tls_server-å‡½æ•°ä¸­åœ¨-process-ä¹‹å‰å†åŠ ä¸ª-100ms-çš„å»¶æ—¶äººä¸ºå‡ç¼“ç³»ç»Ÿçš„å¤„ç†é€Ÿåº¦&quot;&gt;&lt;/a&gt;
&lt;/summary&gt;
&lt;div&gt;

```rust, editable

async move {
    let stream = ProstServerStream::new(stream.compat(), svc1.clone());
    // å»¶è¿Ÿ 100ms å¤„ç†
    time::sleep(Duration::from_millis(100)).await;
    stream.process().await.unwrap();
    Ok(())
}
```

&lt;/div&gt;
&lt;/details&gt;

å¥½ï¼Œç°åœ¨å¯ä»¥å†™æ€§èƒ½æµ‹è¯•äº†ã€‚


&lt;details id=&quot;admonition-åœ¨-rust-ä¸‹æˆ‘ä»¬å¯ä»¥ç”¨-criterion-åº“httpsgithubcombheislercriterionrså®ƒå¯ä»¥å¤„ç†åŸºæœ¬çš„æ€§èƒ½æµ‹è¯•å¹¶ç”Ÿæˆæ¼‚äº®çš„æŠ¥å‘Š&quot; class=&quot;admonition note&quot;&gt;
&lt;summary class=&quot;admonition-title&quot;&gt;

åœ¨ Rust ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ [criterion åº“](https://github.com/bheisler/criterion.rs)ã€‚å®ƒå¯ä»¥å¤„ç†åŸºæœ¬çš„æ€§èƒ½æµ‹è¯•ï¼Œå¹¶ç”Ÿæˆæ¼‚äº®çš„æŠ¥å‘Š 

&lt;a class=&quot;admonition-anchor-link&quot; href=&quot;#admonition-åœ¨-rust-ä¸‹æˆ‘ä»¬å¯ä»¥ç”¨-criterion-åº“httpsgithubcombheislercriterionrså®ƒå¯ä»¥å¤„ç†åŸºæœ¬çš„æ€§èƒ½æµ‹è¯•å¹¶ç”Ÿæˆæ¼‚äº®çš„æŠ¥å‘Š&quot;&gt;&lt;/a&gt;
&lt;/summary&gt;
&lt;div&gt;

æ‰€ä»¥åœ¨ Cargo.toml ä¸­åŠ å…¥ï¼š

```toml

[dev-dependencies]
...
criterion = { version = &quot;0.3&quot;, features = [&quot;async_futures&quot;, &quot;async_tokio&quot;, &quot;html_reports&quot;] } # benchmark
...
rand = &quot;0.8&quot; # éšæœºæ•°å¤„ç†
...

[[bench]]
name = &quot;pubsub&quot;
harness = false
```

&gt; æœ€åè¿™ä¸ª bench sectionï¼Œæè¿°äº†æ€§èƒ½æµ‹è¯•çš„åå­—ï¼Œå®ƒå¯¹åº” benches ç›®å½•ä¸‹çš„åŒåæ–‡ä»¶ã€‚

æˆ‘ä»¬åˆ›å»ºå’Œ src å¹³çº§çš„ benchesï¼Œç„¶åå†åˆ›å»º benches/pubsub.rsï¼Œæ·»å…¥å¦‚ä¸‹ä»£ç ï¼š

~~~admonish info title=&quot;examples/gen_config.rs&quot; collapsible=true
```rust, editable
use anyhow::Result;
use criterion::{criterion_group, criterion_main, Criterion};
use futures::StreamExt;
use kv6::{
    start_client_with_config, start_server_with_config, ClientConfig, CommandRequest, ServerConfig,
    StorageConfig, YamuxCtrl,
};
use rand::prelude::SliceRandom;
use std::time::Duration;
use tokio::net::TcpStream;
use tokio::runtime::Builder;
use tokio::time;
use tokio_rustls::client::TlsStream;
use tracing::{info, span};
use tracing_subscriber::{layer::SubscriberExt, prelude::*, EnvFilter};

async fn start_server() -&gt; Result&lt;()&gt; {
    let addr = &quot;127.0.0.1:9999&quot;;
    let mut config: ServerConfig = toml::from_str(include_str!(&quot;../fixtures/server.conf&quot;))?;
    config.general.addr = addr.into();
    config.storage = StorageConfig::MemTable;

    tokio::spawn(async move {
        start_server_with_config(&amp;config).await.unwrap();
    });

    Ok(())
}

async fn connect() -&gt; Result&lt;YamuxCtrl&lt;TlsStream&lt;TcpStream&gt;&gt;&gt; {
    let addr = &quot;127.0.0.1:9999&quot;;
    let mut config: ClientConfig = toml::from_str(include_str!(&quot;../fixtures/client.conf&quot;))?;
    config.general.addr = addr.into();

    Ok(start_client_with_config(&amp;config).await?)
}

async fn start_subscribers(topic: &amp;'static str) -&gt; Result&lt;()&gt; {
    let mut ctrl = connect().await?;
    let stream = ctrl.open_stream().await?;
    info!(&quot;C(subscriber): stream opened&quot;);
    let cmd = CommandRequest::new_subscribe(topic.to_string());
    tokio::spawn(async move {
        let mut stream = stream.execute_streaming(&amp;cmd).await.unwrap();
        while let Some(Ok(data)) = stream.next().await {
            drop(data);
        }
    });

    Ok(())
}

async fn start_publishers(topic: &amp;'static str, values: &amp;'static [&amp;'static str]) -&gt; Result&lt;()&gt; {
    let mut rng = rand::thread_rng();
    let v = values.choose(&amp;mut rng).unwrap();

    let mut ctrl = connect().await.unwrap();
    let mut stream = ctrl.open_stream().await.unwrap();
    info!(&quot;C(publisher): stream opened&quot;);

    let cmd = CommandRequest::new_publish(topic.to_string(), vec![(*v).into()]);
    stream.execute_unary(&amp;cmd).await.unwrap();

    Ok(())
}

fn pubsub(c: &amp;mut Criterion) {
    let tracer = opentelemetry_jaeger::new_pipeline()
        .with_service_name(&quot;kv-bench&quot;)
        .install_simple()
        .unwrap();
    let opentelemetry = tracing_opentelemetry::layer().with_tracer(tracer);

    tracing_subscriber::registry()
        .with(EnvFilter::from_default_env())
        .with(opentelemetry)
        .init();

    let root = span!(tracing::Level::INFO, &quot;app_start&quot;, work_units = 2);
    let _enter = root.enter();
    // åˆ›å»º Tokio runtime
    let runtime = Builder::new_multi_thread()
        .worker_threads(4)
        .thread_name(&quot;pubsub&quot;)
        .enable_all()
        .build()
        .unwrap();

    let base_str = include_str!(&quot;../fixtures/server.conf&quot;); // 891 bytes

    let values: &amp;'static [&amp;'static str] = Box::leak(
        vec![
            &amp;base_str[..64],
            &amp;base_str[..128],
            &amp;base_str[..256],
            &amp;base_str[..512],
        ]
        .into_boxed_slice(),
    );
    let topic = &quot;lobby&quot;;

    // è¿è¡ŒæœåŠ¡å™¨å’Œ 100 ä¸ª subscriberï¼Œä¸ºæµ‹è¯•å‡†å¤‡
    runtime.block_on(async {
        eprint!(&quot;preparing server and subscribers&quot;);
        start_server().await.unwrap();
        time::sleep(Duration::from_millis(50)).await;
        for _ in 0..1000 {
            start_subscribers(topic).await.unwrap();
            eprint!(&quot;.&quot;);
        }
        eprintln!(&quot;Done!&quot;);
    });

    // è¿›è¡Œ benchmark
    c.bench_function(&quot;publishing&quot;, move |b| {
        b.to_async(&amp;runtime)
            .iter(|| async { start_publishers(topic, values).await })
    });
}

criterion_group! {
    name = benches;
    config = Criterion::default().sample_size(10);
    targets = pubsub
}
criterion_main!(benches);
```

&lt;/div&gt;
&lt;/details&gt;

å¤§éƒ¨åˆ†çš„ä»£ç éƒ½å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯åˆ›å»ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œä¸ºæµ‹è¯•åšå‡†å¤‡ã€‚

è¯´ä¸€ä¸‹è¿™é‡Œé¢æ ¸å¿ƒçš„ benchmark ä»£ç ï¼š

```rust, editable

c.bench_function(&quot;publishing&quot;, move |b| {
    b.to_async(&amp;runtime)
        .iter(|| async { start_publishers(topic, values).await })
});
```

å¯¹äºè¦æµ‹è¯•çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…æˆä¸€ä¸ªå‡½æ•°è¿›è¡Œæµ‹è¯•ã€‚

- è¿™é‡Œå› ä¸ºè¦åš async å‡½æ•°çš„æµ‹è¯•ï¼Œéœ€è¦ä½¿ç”¨ runtimeã€‚
- æ™®é€šçš„å‡½æ•°ä¸éœ€è¦è°ƒç”¨ to_asyncã€‚å¯¹äºæ›´å¤šæœ‰å…³ criterion çš„ç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒå®ƒçš„æ–‡æ¡£ã€‚

</code></pre>
<p>````admonish success title=&quot;è¿è¡Œ <code>cargo bench</code> åï¼Œä¼šè§åˆ°å¦‚ä¸‹æ‰“å°ï¼ˆå¦‚æœä½ çš„ä»£ç æ— æ³•é€šè¿‡ï¼Œå¯ä»¥å‚è€ƒ repo é‡Œçš„ diff_benchmarkï¼Œæˆ‘é¡ºä¾¿åšäº†ä¸€ç‚¹å°é‡æ„ï¼‰ï¼š &quot; collapsible=true</p>
<pre><code class="language-shell">
preparing server and subscribers....................................................................................................Done!
publishing              time:   [419.73 ms 426.84 ms 434.20 ms]                     
                        change: [-1.6712% +1.0499% +3.6586%] (p = 0.48 &gt; 0.05)
                        No change in performance detected.
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå•ä¸ª publish çš„å¤„ç†é€Ÿåº¦è¦ 426msï¼Œå¥½æ…¢ï¼æˆ‘ä»¬æŠŠä¹‹å‰åœ¨ start_tls_server() é‡ŒåŠ çš„å»¶è¿Ÿå»æ‰ï¼Œå†æ¬¡æµ‹è¯•ï¼š</p>
<pre><code class="language-shell">
preparing server and subscribers....................................................................................................Done!
publishing              time:   [318.61 ms 324.48 ms 329.81 ms]                     
                        change: [-25.854% -23.980% -22.144%] (p = 0.00 &lt; 0.05)
                        Performance has improved.
</code></pre>
<pre><code>
 &gt; 
 &gt; å—¯ï¼Œè¿™ä¸‹ 324msï¼Œæ­£å¥½æ˜¯å‡å»åˆšæ‰åŠ çš„ 100msã€‚å¯æ˜¯è¿™ä¸ªé€Ÿåº¦ä¾æ—§ä¸åˆç†ï¼Œå‡­ç›´è§‰æˆ‘ä»¬æ„Ÿè§‰ä¸€ä¸‹è¿™ä¸ªé€Ÿåº¦ï¼Œæ˜¯ Python è¿™æ ·çš„è¯­è¨€è¿˜æ­£å¸¸ï¼Œå¦‚æœæ˜¯ Rust ä¹Ÿå¤ªæ…¢äº†å§ï¼Ÿ

## æµ‹é‡å’Œç›‘æ§

 &gt; 
 &gt; å·¥ä¸šç•Œæœ‰å¥åè¨€ï¼šå¦‚æœä½ æ— æ³•æµ‹é‡ï¼Œé‚£ä½ å°±æ— æ³•æ”¹è¿›ï¼ˆIf you canâ€™t measure it, you canâ€™t improve itï¼‰ã€‚

ç°åœ¨çŸ¥é“äº† KV server æ€§èƒ½æœ‰é—®é¢˜ï¼Œä½†å¹¶ä¸çŸ¥é“é—®é¢˜å‡ºåœ¨å“ªé‡Œã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆé€‚çš„æµ‹é‡æ–¹å¼ã€‚

ç›®å‰ï¼Œæ¯”è¾ƒå¥½çš„ç«¯å¯¹ç«¯çš„æ€§èƒ½ç›‘æ§å’Œæµ‹é‡å·¥å…·æ˜¯ jaegerï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ KV server/client ä¾§æ”¶é›†ç›‘æ§ä¿¡æ¯ï¼Œå‘é€ç»™ jaeger æ¥æŸ¥çœ‹åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„æ•´ä¸ªå¤„ç†æµç¨‹ä¸­ï¼Œæ—¶é—´éƒ½èŠ±è´¹åˆ°å“ªé‡Œå»äº†ã€‚

ä¹‹å‰æˆ‘ä»¬åœ¨ KV server é‡Œä½¿ç”¨çš„æ—¥å¿—å·¥å…·æ˜¯
tracingï¼Œä¸è¿‡æ—¥å¿—åªæ˜¯å®ƒçš„è¯¸å¤šåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒè¿˜èƒ½åš[ instrument](https://docs.rs/tracing/0.1.28/tracing/attr.instrument.html)
ï¼Œç„¶åé…åˆ [opentelemetry åº“](https://github.com/open-telemetry/opentelemetry-rust)ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠ instrument çš„ç»“æœå‘é€ç»™ jaeger äº†ã€‚

&lt;details id=&quot;admonition-1-åŠ å…¥jaeger&quot; class=&quot;admonition note&quot;&gt;
&lt;summary class=&quot;admonition-title&quot;&gt;

1. åŠ å…¥jaeger 

&lt;a class=&quot;admonition-anchor-link&quot; href=&quot;#admonition-1-åŠ å…¥jaeger&quot;&gt;&lt;/a&gt;

&lt;/summary&gt;
&lt;div&gt;

å¥½ï¼Œåœ¨ Cargo.toml é‡Œæ·»åŠ æ–°çš„ä¾èµ–ï¼š

````toml

[dependencies]
...
opentelemetry-jaeger = &quot;0.15&quot; # opentelemetry jaeger æ”¯æŒ
...
tracing-appender = &quot;0.1&quot; # æ–‡ä»¶æ—¥å¿—
tracing-opentelemetry = &quot;0.15&quot; # opentelemetry æ”¯æŒ
tracing-subscriber = { version = &quot;0.2&quot;, features = [&quot;json&quot;, &quot;chrono&quot;] } # æ—¥å¿—å¤„ç†
</code></pre>
<p>æœ‰äº†è¿™äº›ä¾èµ–åï¼Œåœ¨ benches/pubsub.rs é‡Œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆå§‹åŒ– tracing_subscriber æ—¶ï¼Œä½¿ç”¨ jaeger å’Œ opentelemetry tracerï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn pubsub(c: &amp;mut Criterion) {
    let tracer = opentelemetry_jaeger::new_pipeline()
        .with_service_name(&quot;kv-bench&quot;)
        .install_simple()
        .unwrap();
    let opentelemetry = tracing_opentelemetry::layer().with_tracer(tracer);

    tracing_subscriber::registry()
        .with(EnvFilter::from_default_env())
        .with(opentelemetry)
        .init();

    let root = span!(tracing::Level::INFO, &quot;app_start&quot;, work_units = 2);
    let _enter = root.enter();
    // åˆ›å»º Tokio runtime
    ...
}
</code></pre></pre>
<p>è®¾ç½®å¥½ tracing åï¼Œå°±åœ¨ç³»ç»Ÿçš„ä¸»æµç¨‹ä¸Šæ·»åŠ ç›¸åº”çš„ instrumentï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/f1680244d5c7901ec26181c01bfea8a1.jpg" alt="img" /></p>
<h2 id="æ–°æ·»åŠ çš„ä»£ç ä½ å¯ä»¥çœ‹-repo-ä¸­çš„-diff_telemetry"><a class="header" href="#æ–°æ·»åŠ çš„ä»£ç ä½ å¯ä»¥çœ‹-repo-ä¸­çš„-diff_telemetry">æ–°æ·»åŠ çš„ä»£ç ä½ å¯ä»¥çœ‹ repo ä¸­çš„ diff_telemetryã€‚</a></h2>
<p>æ³¨æ„ instrument å¯ä»¥ç”¨ä¸åŒçš„åç§°:</p>
<blockquote>
<p>æ¯”å¦‚ï¼Œå¯¹äº TlsConnector::new() å‡½æ•°ï¼Œå¯ä»¥ç”¨ #[instrument(name = â€œtls_connector_newâ€)]ï¼Œè¿™æ ·å®ƒçš„åå­—è¾¨è¯†åº¦é«˜ä¸€äº›ã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-2-è¿è¡Œjaeger" class="admonition success">
<summary class="admonition-title">
<ol start="2">
<li>è¿è¡Œjaeger </li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-è¿è¡Œjaeger"></a></p>
</summary>
<div>
<p>ä¸ºä¸»æµç¨‹ä¸­çš„å‡½æ•°æ·»åŠ å®Œ instrument åï¼Œä½ éœ€è¦å…ˆæ‰“å¼€ä¸€ä¸ªçª—å£ï¼Œè¿è¡Œ jaegerï¼ˆéœ€è¦ dockerï¼‰ï¼š</p>
<pre><code class="language-shell">docker run -d -p6831:6831/udp -p6832:6832/udp -p16686:16686 -p14268:14268 jaegertracing/all-in-one:latest
</code></pre>
<p>ç„¶åå¸¦ç€ RUST_LOG=info è¿è¡Œ benchmarkï¼š</p>
<pre><code class="language-shell">RUST_LOG=info cargo bench
</code></pre>
<pre><code class="language-shell">
preparing server and subscribers....................................................................................................Done!
publishing              time:   [1.7464 ms 1.9556 ms 2.2343 ms]                       
Found 2 outliers among 10 measurements (20.00%)
  1 (10.00%) high mild
  1 (10.00%) high severe
</code></pre>
</div>
</details>
<p>å¹¶æ²¡æœ‰åšä»»ä½•äº‹æƒ…ï¼Œä¼¼ä¹åªæ˜¯æ¢äº†ä¸ªç³»ç»Ÿï¼Œæ€§èƒ½å°±æå‡äº†å¾ˆå¤šï¼Œè¿™ç»™æˆ‘ä»¬ä¸€ä¸ª tipï¼šä¹Ÿè®¸é—®é¢˜å‡ºåœ¨ OS X å’Œ Linux ç³»ç»Ÿç›¸å…³çš„éƒ¨åˆ†ã€‚</p>
<p>ä¸ç®¡æ€æ ·ï¼Œå·²ç»å‘é€äº†ä¸å°‘æ•°æ®ç»™ jaegerï¼Œæˆ‘ä»¬åˆ° jaeger ä¸Šçœ‹çœ‹é—®é¢˜å‡ºåœ¨å“ªé‡Œã€‚</p>
<details id="admonition-ç¬¬ä¸€æ¬¡æ£€æŸ¥" class="admonition bug">
<summary class="admonition-title">
<p>ç¬¬ä¸€æ¬¡æ£€æŸ¥</p>
<p><a class="admonition-anchor-link" href="#admonition-ç¬¬ä¸€æ¬¡æ£€æŸ¥"></a></p>
</summary>
<div>
<ul>
<li>æ‰“å¼€ http://localhost:16686/</li>
<li>service é€‰ kv-bench</li>
<li>Operation é€‰ app_start</li>
<li>ç‚¹å‡» â€œFind Tracesâ€</li>
<li>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•è·çš„ traceã€‚å› ä¸ºè¿è¡Œäº†ä¸¤æ¬¡ benchmarkï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ª app_start çš„æŸ¥è¯¢ç»“æœï¼š</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/ecd9b1d06debe7fb3fe507befd803877.png" alt="img" /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡ start_client_with_config éƒ½è¦èŠ± 1.6-2.5msï¼Œå…¶ä¸­æœ‰å·®ä¸å¤šä¸€å°åŠæ—¶é—´èŠ±åœ¨äº† TlsClientConnector::new() ä¸Šï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/fe574ccac09ce5434027fce2afebaeb6.png" alt="img" /></p>
</div>
</details>
<details id="admonition-ç¬¬ä¸€æ¬¡ä¿®æ”¹" class="admonition info">
<summary class="admonition-title">
<p>ç¬¬ä¸€æ¬¡ä¿®æ”¹ </p>
<p><a class="admonition-anchor-link" href="#admonition-ç¬¬ä¸€æ¬¡ä¿®æ”¹"></a></p>
</summary>
<div>
<p>å¦‚æœè¯´ TlsClientConnector::connect() èŠ±ä¸å°‘æ—¶é—´è¿˜æƒ…æœ‰å¯åŸï¼Œå› ä¸ºè¿™æ˜¯æ•´ä¸ª TLS åè®®çš„æ¡æ‰‹è¿‡ç¨‹ï¼Œæ¶‰åŠåˆ°ç½‘ç»œè°ƒç”¨ã€åŒ…çš„åŠ è§£å¯†ç­‰ã€‚</p>
<p>ä½† TlsClientConnector::new() å°±æ˜¯åŠ è½½ä¸€äº›è¯ä¹¦ã€åˆ›å»º TlsConnector è¿™ä¸ªæ•°æ®ç»“æ„è€Œå·²ï¼Œä¸ºä½•è¿™ä¹ˆæ…¢ï¼Ÿ</p>
<p>ä»”ç»†é˜…è¯» TlsClientConnector::new() çš„ä»£ç ï¼Œä½ å¯ä»¥å¯¹ç…§æ³¨é‡Šçœ‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[instrument(name = &quot;tls_connector_new&quot;, skip_all)]
pub fn new(
    domain: impl Into&lt;String&gt; + std::fmt::Debug,
    identity: Option&lt;(&amp;str, &amp;str)&gt;,
    server_ca: Option&lt;&amp;str&gt;,
) -&gt; Result&lt;Self, KvError&gt; {
    let mut config = ClientConfig::new();

    // å¦‚æœæœ‰å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŠ è½½ä¹‹
    if let Some((cert, key)) = identity {
        let certs = load_certs(cert)?;
        let key = load_key(key)?;
        config.set_single_client_cert(certs, key)?;
    }

    // åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾
    config.root_store = match rustls_native_certs::load_native_certs() {
        Ok(store) | Err((Some(store), _)) =&gt; store,
        Err((None, error)) =&gt; return Err(error.into()),
    };

    // å¦‚æœæœ‰ç­¾ç½²æœåŠ¡å™¨çš„ CA è¯ä¹¦ï¼Œåˆ™åŠ è½½å®ƒï¼Œè¿™æ ·æœåŠ¡å™¨è¯ä¹¦ä¸åœ¨æ ¹è¯ä¹¦é“¾
    // ä½†æ˜¯è¿™ä¸ª CA è¯ä¹¦èƒ½éªŒè¯å®ƒï¼Œä¹Ÿå¯ä»¥
    if let Some(cert) = server_ca {
        let mut buf = Cursor::new(cert);
        config.root_store.add_pem_file(&amp;mut buf).unwrap();
    }

    Ok(Self {
        config: Arc::new(config),
        domain: Arc::new(domain.into()),
    })
}
</code></pre></pre>
<p>å¯ä»¥å‘ç°ï¼Œå®ƒçš„ä»£ç å”¯ä¸€å¯èƒ½å½±å“æ€§èƒ½çš„å°±æ˜¯åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾çš„éƒ¨åˆ†ã€‚è¿™ä¸ªä»£ç ä¼šå’Œæ“ä½œç³»ç»Ÿäº¤äº’ï¼Œè·å–ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾ã€‚ä¹Ÿè®¸ï¼Œè¿™å°±æ˜¯å½±å“æ€§èƒ½çš„åŸå› ä¹‹ä¸€ï¼Ÿ</p>
<p>é‚£æˆ‘ä»¬å°†å…¶ç®€å•é‡æ„ä¸€ä¸‹ã€‚å› ä¸ºæ ¹è¯ä¹¦é“¾ï¼Œåªæœ‰åœ¨å®¢æˆ·ç«¯æ²¡æœ‰æä¾›ç”¨äºéªŒè¯æœåŠ¡å™¨è¯ä¹¦çš„ CA è¯ä¹¦æ—¶ï¼Œæ‰éœ€è¦ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æ²¡æœ‰ CA è¯ä¹¦æ—¶ï¼Œæ‰åŠ è½½æœ¬åœ°çš„æ ¹è¯ä¹¦é“¾ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[instrument(name = &quot;tls_connector_new&quot;, skip_all)]
pub fn new(
    domain: impl Into&lt;String&gt; + std::fmt::Debug,
    identity: Option&lt;(&amp;str, &amp;str)&gt;,
    server_ca: Option&lt;&amp;str&gt;,
) -&gt; Result&lt;Self, KvError&gt; {
    let mut config = ClientConfig::new();

    // å¦‚æœæœ‰å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŠ è½½ä¹‹
    if let Some((cert, key)) = identity {
        let certs = load_certs(cert)?;
        let key = load_key(key)?;
        config.set_single_client_cert(certs, key)?;
    }

    // å¦‚æœæœ‰ç­¾ç½²æœåŠ¡å™¨çš„ CA è¯ä¹¦ï¼Œåˆ™åŠ è½½å®ƒï¼Œè¿™æ ·æœåŠ¡å™¨è¯ä¹¦ä¸åœ¨æ ¹è¯ä¹¦é“¾
    // ä½†æ˜¯è¿™ä¸ª CA è¯ä¹¦èƒ½éªŒè¯å®ƒï¼Œä¹Ÿå¯ä»¥
    if let Some(cert) = server_ca {
        let mut buf = Cursor::new(cert);
        config.root_store.add_pem_file(&amp;mut buf).unwrap();
    } else {
        // åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾
        config.root_store = match rustls_native_certs::load_native_certs() {
            Ok(store) | Err((Some(store), _)) =&gt; store,
            Err((None, error)) =&gt; return Err(error.into()),
        };
    }

    Ok(Self {
        config: Arc::new(config),
        domain: Arc::new(domain.into()),
    })
}
</code></pre></pre>
<p>å®Œæˆè¿™ä¸ªä¿®æ”¹åï¼Œæˆ‘ä»¬å†è¿è¡Œ RUST_LOG=info cargo benchï¼Œç°åœ¨çš„æ€§èƒ½è¾¾åˆ°äº† 1.64msï¼Œç›¸æ¯”ä¹‹å‰çš„ 1.95msï¼Œæå‡äº† 16%ã€‚</p>
</div>
</details>
<details id="admonition-ç¬¬äºŒæ¬¡æ£€æŸ¥" class="admonition bug">
<summary class="admonition-title">
<p>ç¬¬äºŒæ¬¡æ£€æŸ¥ </p>
<p><a class="admonition-anchor-link" href="#admonition-ç¬¬äºŒæ¬¡æ£€æŸ¥"></a></p>
</summary>
<div>
<p>æ‰“å¼€ jaegerï¼Œçœ‹æœ€æ–°çš„ app_start ç»“æœï¼Œå‘ç° TlsClientConnector::new() æ‰€èŠ±æ—¶é—´é™åˆ°äº† ~12us å·¦å³ã€‚å—¯ï¼Œè™½ç„¶æ²¡æœ‰æŠ“åˆ°æœåŠ¡å™¨æœ¬èº«çš„ bugï¼Œä½†å®¢æˆ·ç«¯çš„ bug å€’æ˜¯è§£å†³äº†ä¸€ä¸ªã€‚</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/3cfde740dbe0d4a897e2d4c3684b530b.png" alt="img" /></p>
<p>è‡³äºæœåŠ¡å™¨ï¼Œå¦‚æœæˆ‘ä»¬çœ‹ Service::execute çš„ä¸»æµç¨‹ï¼Œæ‰§è¡Œé€Ÿåº¦åœ¨ 40-60usï¼Œé—®é¢˜ä¸å¤§ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/7be6139668c82fb8b79fb66f3ed06d31.png" alt="img" /></p>
<p>å†çœ‹æœåŠ¡å™¨çš„ä¸»æµç¨‹ server_processï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/076402ac25b507295d022b980378e363.png" alt="img" /></p>
<p>è¿™æ˜¯æˆ‘ä»¬åœ¨ start_tls_server() é‡Œé¢å¤–æ·»åŠ çš„ tracing spanï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
loop {
    let root = span!(tracing::Level::INFO, &quot;server_process&quot;);
    let _enter = root.enter();
    ...
}
</code></pre></pre>
<p>æŠŠå³ä¸Šè§’çš„ trace timeline æ”¹æˆ trace graphï¼Œç„¶åç‚¹å³ä¾§çš„ timeï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/1499657924a241e43c9d1be467793041.png" alt="img" /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦çš„æœåŠ¡å™¨æ—¶é—´éƒ½èŠ±åœ¨äº† TLS accept ä¸Šï¼Œæ‰€ä»¥ï¼Œç›®å‰æœåŠ¡å™¨æ²¡æœ‰å¤ªå¤šå€¼å¾—ä¼˜åŒ–çš„åœ°æ–¹ã€‚</p>
<p>ç”±äº tracing æœ¬èº«ä¹Ÿå ç”¨ä¸å°‘ CPUï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ cargo bench çœ‹çœ‹ç›®å‰çš„ç»“æœï¼š</p>
<pre><code class="language-shell">preparing server and subscribers....................................................................................................Done!
publishing              time:   [1.3986 ms 1.4140 ms 1.4474 ms]                       
                        change: [-26.647% -19.977% -10.798%] (p = 0.00 &lt; 0.05)
                        Performance has improved.
Found 2 outliers among 10 measurements (20.00%)
  2 (20.00%) high severe
</code></pre>
<p>ä¸åŠ  RUST_LOG=info åï¼Œæ•´ä½“æ€§èƒ½åˆ°äº† 1.4msã€‚è¿™æ˜¯æˆ‘åœ¨ Ubuntu è™šæ‹Ÿæœºä¸‹çš„ç»“æœã€‚</p>
<p>æˆ‘ä»¬å†å›åˆ° OS X ä¸‹æµ‹è¯•ï¼Œçœ‹çœ‹ TlsClientConnector::new() çš„ä¿®æ”¹ï¼Œå¯¹ OS X æ˜¯å¦æœ‰æ•ˆï¼š</p>
<pre><code class="language-shell">preparing server and subscribers....................................................................................................Done!
publishing              time:   [1.4086 ms 1.4229 ms 1.4315 ms]                       
                        change: [-99.570% -99.563% -99.554%] (p = 0.00 &lt; 0.05)
                        Performance has improved.
</code></pre>
<p>å—¯ï¼Œåœ¨æˆ‘çš„ OS X ä¸‹ï¼Œç°åœ¨æ•´ä½“æ€§èƒ½ä¹Ÿåˆ°äº† 1.4ms çš„æ°´å¹³ã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œåœ¨æœ‰ 100 ä¸ª subscribers çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ KV server æ¯ç§’é’Ÿå¯ä»¥å¤„ç† 714k publish è¯·æ±‚ï¼›è€Œåœ¨ 1000 ä¸ª subscribers çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½åœ¨ 11.1ms çš„æ°´å¹³ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’å¯ä»¥å¤„ç† 90k publish è¯·æ±‚ï¼š</p>
<pre><code class="language-shell">
publishing              time:   [11.007 ms 11.095 ms 11.253 ms]                      
                        change: [-96.618% -96.556% -96.486%] (p = 0.00 &lt; 0.05)
                        Performance has improved.
</code></pre>
<p>ä½ ä¹Ÿè®¸ä¼šè§‰å¾—ç›®å‰ publish çš„ value å¤ªå°ï¼Œé‚£æ¢ä¸€äº›æ›´åŠ è´´è¿‘å®é™…çš„å­—ç¬¦ä¸²å¤§å°ï¼š</p>
<pre><code class="language-shell">
// let values = &amp;[&quot;Hello&quot;, &quot;Tyr&quot;, &quot;Goodbye&quot;, &quot;World&quot;];
let base_str = include_str!(&quot;../fixtures/server.conf&quot;); // 891 bytes

let values: &amp;'static [&amp;'static str] = Box::leak(
    vec![
        &amp;base_str[..64],
        &amp;base_str[..128],
        &amp;base_str[..256],
        &amp;base_str[..512],
    ]
    .into_boxed_slice(),
);
</code></pre>
<p>æµ‹è¯•ç»“æœå·®ä¸å¤ªå¤šï¼š</p>
<pre><code class="language-shell">
publishing              time:   [10.917 ms 11.098 ms 11.428 ms]                      
                        change: [-0.4822% +2.3311% +4.9631%] (p = 0.12 &gt; 0.05)
                        No change in performance detected.
</code></pre>
</div>
</details>
<details id="admonition-criterion-è¿˜ä¼šç”Ÿæˆæ¼‚äº®çš„-report" class="admonition info">
<summary class="admonition-title">
<p>criterion è¿˜ä¼šç”Ÿæˆæ¼‚äº®çš„ report </p>
<p><a class="admonition-anchor-link" href="#admonition-criterion-è¿˜ä¼šç”Ÿæˆæ¼‚äº®çš„-report"></a></p>
</summary>
<div>
<p>ä½ å¯ä»¥ç”¨æµè§ˆå™¨æ‰“å¼€ ./target/criterion/publishing/report/index.html æŸ¥çœ‹ï¼ˆåå­—æ˜¯ publishing ï¼Œå› ä¸º benchmark ID æ˜¯ publishingï¼‰ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/d3cebd8e3c164171febbe34e43916885.png" alt="img" /></p>
</div>
</details>
<details id="admonition-å¥½å¤„ç†å®Œæ€§èƒ½ç›¸å…³çš„é—®é¢˜æˆ‘ä»¬æ¥ä¸º-server-æ·»åŠ æ—¥å¿—å’Œæ€§èƒ½ç›‘æµ‹çš„æ”¯æŒ" class="admonition note">
<summary class="admonition-title">
<p>å¥½ï¼Œå¤„ç†å®Œæ€§èƒ½ç›¸å…³çš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥ä¸º server æ·»åŠ æ—¥å¿—å’Œæ€§èƒ½ç›‘æµ‹çš„æ”¯æŒï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-å¥½å¤„ç†å®Œæ€§èƒ½ç›¸å…³çš„é—®é¢˜æˆ‘ä»¬æ¥ä¸º-server-æ·»åŠ æ—¥å¿—å’Œæ€§èƒ½ç›‘æµ‹çš„æ”¯æŒ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::env;

use anyhow::Result;
use kv6::{start_server_with_config, RotationConfig, ServerConfig};
use tokio::fs;
use tracing::span;
use tracing_subscriber::{
    fmt::{self, format},
    layer::SubscriberExt,
    prelude::*,
    EnvFilter,
};

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    // å¦‚æœæœ‰ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ config
    let config = match env::var(&quot;KV_SERVER_CONFIG&quot;) {
        Ok(path) =&gt; fs::read_to_string(&amp;path).await?,
        Err(_) =&gt; include_str!(&quot;../fixtures/server.conf&quot;).to_string(),
    };
    let config: ServerConfig = toml::from_str(&amp;config)?;

    let tracer = opentelemetry_jaeger::new_pipeline()
        .with_service_name(&quot;kv-server&quot;)
        .install_simple()?;
    let opentelemetry = tracing_opentelemetry::layer().with_tracer(tracer);

    // æ·»åŠ 
    let log = &amp;config.log;
    let file_appender = match log.rotation {
        RotationConfig::Hourly =&gt; tracing_appender::rolling::hourly(&amp;log.path, &quot;server.log&quot;),
        RotationConfig::Daily =&gt; tracing_appender::rolling::daily(&amp;log.path, &quot;server.log&quot;),
        RotationConfig::Never =&gt; tracing_appender::rolling::never(&amp;log.path, &quot;server.log&quot;),
    };

    let (non_blocking, _guard1) = tracing_appender::non_blocking(file_appender);
    let fmt_layer = fmt::layer()
        .event_format(format().compact())
        .with_writer(non_blocking);

    tracing_subscriber::registry()
        .with(EnvFilter::from_default_env())
        .with(fmt_layer)
        .with(opentelemetry)
        .init();

    let root = span!(tracing::Level::INFO, &quot;app_start&quot;, work_units = 2);
    let _enter = root.enter();

    start_server_with_config(&amp;config).await?;

    Ok(())
}
</code></pre></pre>
<p>ä¸ºäº†è®©æ—¥å¿—èƒ½åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œéœ€è¦æ›´æ–°ä¸€ä¸‹ src/config.rsï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct ServerConfig {
    pub general: GeneralConfig,
    pub storage: StorageConfig,
    pub tls: ServerTlsConfig,
    pub log: LogConfig,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub struct LogConfig {
    pub path: String,
    pub rotation: RotationConfig,
}

#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]
pub enum RotationConfig {
    Hourly,
    Daily,
    Never,
}
</code></pre></pre>
<p>ä½ è¿˜éœ€è¦æ›´æ–° examples/gen_config.rsã€‚ç›¸å…³çš„æ”¹å˜å¯ä»¥çœ‹ repo ä¸‹çš„ diff_loggingã€‚</p>
</div>
</details>
<h2 id="cicd"><a class="header" href="#cicd">CI/CD</a></h2>
<p>ä¸ºäº†è®²è¿°æ–¹ä¾¿ï¼Œæˆ‘æŠŠ CI/CD æ”¾åœ¨æœ€åï¼Œä½† CI/CD åº”è¯¥æ˜¯åœ¨ä¸€å¼€å§‹çš„æ—¶å€™å°±å¦¥å–„è®¾ç½®çš„ã€‚</p>
<details id="admonition-ä½¿ç”¨github-actionå®ç°ci" class="admonition note">
<summary class="admonition-title">
<p>ä½¿ç”¨github actionå®ç°CI</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½¿ç”¨github-actionå®ç°ci"></a></p>
</summary>
<div>
<p>å…ˆè¯´ CI å§, repo tyrchen/geektime-rust åœ¨ä¸€å¼€å§‹å°±è®¾ç½®äº† github actionï¼Œæ¯æ¬¡ commit éƒ½ä¼šè¿è¡Œï¼š</p>
<ul>
<li>
<p>ä»£ç æ ¼å¼æ£€æŸ¥ï¼šcargo fmt</p>
</li>
<li>
<p>ä¾èµ– license æ£€æŸ¥ï¼šcargo deny</p>
</li>
<li>
<p>lintingï¼šcargo check å’Œ cargo clippy</p>
</li>
<li>
<p>å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼šcargo test</p>
</li>
<li>
<p>ç”Ÿæˆæ–‡æ¡£ï¼šcargo doc</p>
</li>
</ul>
<blockquote>
<p>github action é…ç½®å¦‚ä¸‹ï¼Œä¾›ä½ å‚è€ƒï¼š</p>
</blockquote>
<pre><code class="language-yaml">
name: build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-rust:
    strategy:
      matrix:
        platform: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v2
      - name: Cache cargo registry
        uses: actions/cache@v1
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry
      - name: Cache cargo index
        uses: actions/cache@v1
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index
      - name: Cache cargo build
        uses: actions/cache@v1
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target
      - name: Install stable
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Check code format
        run: cargo fmt -- --check
      - name: Check the package for errors
        run: cargo check --all
      - name: Lint rust sources
        run: cargo clippy --all-targets --all-features --tests --benches -- -D warnings
      - name: Run tests
        run: cargo test --all-features -- --test-threads=1 --nocapture
      - name: Generate docs
        run: cargo doc --all-features --no-deps
      - name: Deploy docs to gh-page
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
</code></pre>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ¯æ¬¡ push tag æ—¶åš releaseï¼š</p>
<pre><code class="language-yaml">
name: release

on:
  push:
    tags:
      - &quot;v*&quot; # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
  build:
    name: Upload Release Asset
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - name: Cache cargo registry
        uses: actions/cache@v1
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry
      - name: Cache cargo index
        uses: actions/cache@v1
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index
      - name: Cache cargo build
        uses: actions/cache@v1
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_TOKEN }}
          submodules: recursive
      - name: Build project
        run: |
          make build-release
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
      - name: Upload asset
        id: upload-kv-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./target/release/kvs
          asset_name: kvs
          asset_content_type: application/octet-stream
      - name: Set env
        run: echo &quot;RELEASE_VERSION=${GITHUB_REF#refs/*/}&quot; &gt;&gt; $GITHUB_ENV
      - name: Deploy docs to gh-page
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc/simple_kv
          destination_dir: ${{ env.RELEASE_VERSION }}
</code></pre>
<p>è¿™æ ·ï¼Œæ¯æ¬¡ push tag æ—¶ï¼Œéƒ½å¯ä»¥æ‰“åŒ…å‡ºæ¥ Linux çš„ kvs ç‰ˆæœ¬ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/1c61b7f58dd176bd25a565577d75af19.png" alt="img" /></p>
<p>å¦‚æœä½ ä¸å¸Œæœ›ç›´æ¥ä½¿ç”¨ç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶ï¼Œä¹Ÿå¯ä»¥æ‰“åŒ…æˆ dockerï¼Œåœ¨ Kubernetes ä¸‹ä½¿ç”¨ã€‚</p>
</div>
</details>
<details id="admonition--åœ¨åš-ci-çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è§¦å‘-cdæ¯”å¦‚" class="admonition info">
<summary class="admonition-title">
<blockquote>
<p>åœ¨åš CI çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è§¦å‘ CDï¼Œæ¯”å¦‚ï¼š </p>
</blockquote>
<p><a class="admonition-anchor-link" href="#admonition--åœ¨åš-ci-çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è§¦å‘-cdæ¯”å¦‚"></a></p>
</summary>
<div>
<ul>
<li>
<p>PR merge åˆ° masterï¼Œåœ¨ build å®Œæˆåï¼Œè§¦å‘ dev æœåŠ¡å™¨çš„éƒ¨ç½²ï¼Œå›¢é˜Ÿå†…éƒ¨å¯ä»¥å°è¯•ï¼›</p>
</li>
<li>
<p>å¦‚æœ release tag åŒ…å« alphaï¼Œåœ¨ build å®Œæˆåï¼Œè§¦å‘ staging æœåŠ¡å™¨çš„éƒ¨ç½²ï¼Œå…¬å¸å†…éƒ¨å¯ä»¥ä½¿ç”¨ï¼›</p>
</li>
<li>
<p>å¦‚æœ release tag åŒ…å« betaï¼Œåœ¨ build å®Œæˆåï¼Œè§¦å‘ beta æœåŠ¡å™¨çš„éƒ¨ç½²ï¼Œbeta ç”¨æˆ·å¯ä»¥ä½¿ç”¨ï¼›</p>
</li>
<li>
<p>æ­£å¼çš„ release tag ä¼šè§¦å‘ç”Ÿäº§ç¯å¢ƒçš„æ»šåŠ¨å‡çº§ï¼Œå‡çº§è¦†ç›–åˆ°çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨ã€‚</p>
</li>
</ul>
</div>
</details>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæ¯å®¶ä¼ä¸šéƒ½æœ‰è‡ªå·±çš„ CI/CD çš„å·¥å…·é“¾ï¼Œè¿™é‡Œä¸ºäº†å±•ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ github action å¯¹ Rust ä»£ç åš CIï¼Œä½ å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€è¦æ¥å¤„ç†ã€‚</p>
<p>åœ¨åˆšæ‰çš„ action ä»£ç ä¸­ï¼Œè¿˜ç¼–è¯‘å¹¶ä¸Šä¼ äº†æ–‡æ¡£ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ github pages å¾ˆæ–¹ä¾¿åœ°è®¿é—®æ–‡æ¡£ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/885d092273f8cacda1a65867a2489ea7.png" alt="img" /></p>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="kv7_big_refactor.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="custom_axum_async_web_framework.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="kv7_big_refactor.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="custom_axum_async_web_framework.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
