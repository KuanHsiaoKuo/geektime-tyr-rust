<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>thumbor - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">2.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">2.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">2.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html" class="active"><strong aria-hidden="true">2.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">2.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">3.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="thumborå›¾ç‰‡æœåŠ¡"><a class="header" href="#thumborå›¾ç‰‡æœåŠ¡">thumborå›¾ç‰‡æœåŠ¡</a></h1>
<!--ts-->
<!--te-->
<h2 id="abiproto"><a class="header" href="#abiproto">abi.proto</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">syntax = &quot;proto3&quot;;

package abi;

// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
message ImageSpec { repeated Spec specs = 1; }

// å¤„ç†å›¾ç‰‡æ”¹å˜å¤§å°
message Resize {
  uint32 width = 1;
  uint32 height = 2;

  enum ResizeType {
    NORMAL = 0;
    SEAM_CARVE = 1;
  }

  ResizeType rtype = 3;

  enum SampleFilter {
    UNDEFINED = 0;
    NEAREST = 1;
    TRIANGLE = 2;
    CATMULL_ROM = 3;
    GAUSSIAN = 4;
    LANCZOS3 = 5;
  }

  SampleFilter filter = 4;
}

// å¤„ç†å›¾ç‰‡æˆªå–
message Crop {
  uint32 x1 = 1;
  uint32 y1 = 2;
  uint32 x2 = 3;
  uint32 y2 = 4;
}

// å¤„ç†æ°´å¹³ç¿»è½¬
message Fliph {}
// å¤„ç†å‚ç›´ç¿»è½¬
message Flipv {}
// å¤„ç†å¯¹æ¯”åº¦
message Contrast { float contrast = 1; }
// å¤„ç†æ»¤é•œ
message Filter {
  enum Filter {
    UNSPECIFIED = 0;
    OCEANIC = 1;
    ISLANDS = 2;
    MARINE = 3;
    // more: https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html
  }
  Filter filter = 1;
}

// å¤„ç†æ°´å°
message Watermark {
  uint32 x = 1;
  uint32 y = 2;
}

// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
message Spec {
  oneof data {
    Resize resize = 1;
    Crop crop = 2;
    Flipv flipv = 3;
    Fliph fliph = 4;
    Contrast contrast = 5;
    Filter filter = 6;
    Watermark watermark = 7;
  }
}
</code></pre></pre>
<h2 id="buildrs"><a class="header" href="#buildrs">build.rs</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">use std::process::Command;

fn main() {
    // åœ¨ç¼–è¯‘æ—¶å¯é€‰æ‹©æ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚
    let build_enabled = option_env!(&quot;BUILD_PROTO&quot;)
        .map(|v| v == &quot;1&quot;)
        .unwrap_or(false);
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¯å¢ƒå˜é‡çš„å¯¹åº”å€¼ï¼Œå°±ç›´æ¥returnï¼Œä¸å†è¿›è¡Œåç»­ç¼–è¯‘
    if !build_enabled {
        println!(&quot;=== Skipped compiling protos ===&quot;);
        return;
    }
    // ä½¿ç”¨ prost_build æŠŠ abi.proto ç¼–è¯‘åˆ° src/pb ç›®å½•ä¸‹
    prost_build::Config::new()
        .out_dir(&quot;src/pb&quot;)
        .compile_protos(&amp;[&quot;abi.proto&quot;], &amp;[&quot;.&quot;])
        .unwrap();
    Command::new(&quot;cargo&quot;)
        .args(&amp;[&quot;fmt&quot;, &quot;--&quot;, &quot;src/*.rs&quot;])
        .status()
        .expect(&quot;cargo fmt failed&quot;);
}
</code></pre></pre>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.option_env.html">option_env in std - Rust</a></li>
</ul>
<blockquote>
<p>åœ¨ç¼–è¯‘æ—¶å¯é€‰æ‹©æ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚</p>
</blockquote>
<h2 id="å…³äºrustçš„æ¨¡å—"><a class="header" href="#å…³äºrustçš„æ¨¡å—">å…³äºrustçš„æ¨¡å—</a></h2>
<blockquote>
<p>å¯ä»¥å‚è€ƒè¿™ç¯‡ï¼š<a href="https://zhuanlan.zhihu.com/p/443926839">Rust æ¨¡å—ç³»ç»Ÿç†è§£ - çŸ¥ä¹</a></p>
</blockquote>
<div id="admonition-modå…¨è®¤è¯†" class="admonition tip">
<div class="admonition-title">
<p>modå…¨è®¤è¯†</p>
<p><a class="admonition-anchor-link" href="#admonition-modå…¨è®¤è¯†"></a></p>
</div>
<div>
<ol>
<li>mod(mod.rsæˆ–modå…³é”®å­—)å°†ä»£ç åˆ†ä¸ºå¤šä¸ªé€»è¾‘æ¨¡å—ï¼Œå¹¶ç®¡ç†è¿™äº›æ¨¡å—çš„å¯è§æ€§ï¼ˆpublic / privateï¼‰ã€‚</li>
<li>æ¨¡å—æ˜¯é¡¹ï¼ˆitemï¼‰çš„é›†åˆï¼Œé¡¹å¯ä»¥æ˜¯ï¼šå‡½æ•°ï¼Œç»“æ„ä½“ï¼Œtraitï¼Œimplå—ï¼Œç”šè‡³å…¶å®ƒæ¨¡å—ã€‚</li>
<li>ä¸€ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ç ï¼Œå¯ä»¥é€šè¿‡ mod.rs å£°æ˜</li>
<li>Rustæ¨¡å—æœ‰ä¸‰ç§å½¢å¼:
<ul>
<li>mod.rs: ä¸€ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ç ï¼Œå¯ä»¥é€šè¿‡ mod.rs å£°æ˜</li>
<li>æ–‡ä»¶/ç›®å½•å³æ¨¡å—ï¼šç¼–è¯‘å™¨çš„æœºåˆ¶å†³å®šï¼Œé™¤äº†mod.rså¤–ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚ä¸å…è®¸åªåˆ†æ‹†æ–‡ä»¶ï¼Œä½†æ˜¯ä¸å£°æ˜modï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨pub useï¼Œåœ¨çˆ¶ç©ºé—´ç›´æ¥è°ƒç”¨å­ç©ºé—´çš„å‡½æ•°ã€‚</li>
<li>modå…³é”®å­—: åœ¨æ–‡ä»¶å†…éƒ¨åˆ†æ‹†æ¨¡å—</li>
</ul>
</li>
<li>Rustç¼–è¯‘å™¨åªæ¥å—ä¸€ä¸ªæºæ–‡ä»¶ï¼Œè¾“å‡ºä¸€ä¸ªcrate</li>
<li>æ¯ä¸€ä¸ªcrateéƒ½æœ‰ä¸€ä¸ªåŒ¿åçš„æ ¹å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´å¯ä»¥æ— é™åµŒå¥—</li>
<li>â€œmod mod-name { â€¦ }â€œ å°†å¤§æ‹¬å·ä¸­çš„ä»£ç ç½®äºå‘½åç©ºé—´mod-nameä¹‹ä¸‹</li>
<li>â€œuse mod-name1::mod-name2;â€œ å¯ä»¥æ‰“å¼€å‘½åç©ºé—´ï¼Œå‡å°‘æ— ä¼‘æ­¢çš„::æ“ä½œç¬¦</li>
<li>â€œmod mod-name;â€œ å¯ä»¥æŒ‡å¯¼ç¼–è¯‘å™¨å°†å¤šä¸ªæ–‡ä»¶ç»„è£…æˆä¸€ä¸ªæ–‡ä»¶</li>
<li>â€œpub use mod-nam1::mod-name2::item-name;â€œ
è¯­å¥å¯ä»¥å°†mod-name2ä¸‹çš„item-nameæå‡åˆ°è¿™æ¡è¯­å¥æ‰€åœ¨çš„ç©ºé—´ï¼Œitem-nameé€šå¸¸æ˜¯å‡½æ•°æˆ–è€…ç»“æ„ä½“ã€‚Rustç¤¾åŒºé€šå¸¸ç”¨è¿™ä¸ªæ–¹æ³•æ¥ç¼©çŸ­åº“APIçš„å‘½åç©ºé—´æ·±åº¦
ç¼–è¯‘å™¨è§„å®šuseè¯­å¥ä¸€å®šè¦åœ¨modè¯­å¥ä¹‹å‰</li>
</ol>
</div>
</div>
<h2 id="modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»"><a class="header" href="#modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»">modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»</a></h2>
<p>åœ¨rustä¸­ï¼Œä¸€èˆ¬ä¼šåœ¨æ¨¡å—çš„mod.rsæ–‡ä»¶ä¸­å¯¹ä¾›å¤–éƒ¨ä½¿ç”¨çš„é¡¹è¿›è¡Œå®ç°, é¡¹å¯ä»¥æ˜¯ï¼šå‡½æ•°ï¼Œç»“æ„ä½“ï¼Œtraitï¼Œimplå—ï¼Œç”šè‡³å…¶å®ƒæ¨¡å—.
è¿™æ ·æœ‰ä¸ªå¥½å¤„ï¼Œé«˜å†…èšï¼Œå¯ä»¥åœ¨ä»£ç å¢é•¿æ—¶ï¼Œå°†å˜åŠ¨å±€é™åœ¨æœåŠ¡æä¾›è€…å†…éƒ¨ï¼Œå¯¹å¤–æä¾›çš„apiä¸å˜ï¼Œä¸ä¼šé€ æˆç ´åæ€§æ›´æ–°ã€‚</p>
<h2 id="pbæ¨¡å—-å¤„ç†protobuf"><a class="header" href="#pbæ¨¡å—-å¤„ç†protobuf">pbæ¨¡å—: å¤„ç†protobuf</a></h2>
<h3 id="pbmodrså£°æ˜æ¨¡å—"><a class="header" href="#pbmodrså£°æ˜æ¨¡å—">pb/mod.rså£°æ˜æ¨¡å—</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">mod abi; // å£°æ˜ abi.rs
pub use abi::*;
</code></pre></pre>
<h3 id="pbabirsé‡Œé¢è¿˜æœ‰å­æ¨¡å—"><a class="header" href="#pbabirsé‡Œé¢è¿˜æœ‰å­æ¨¡å—">pb/abi.rsé‡Œé¢è¿˜æœ‰å­æ¨¡å—</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Spec`.
pub mod spec {
    #[derive(Clone, PartialEq, ::prost::Oneof)]
    pub enum Data {
        #[prost(message, tag = &quot;1&quot;)]
        Resize(super::Resize),
        #[prost(message, tag = &quot;2&quot;)]
        Crop(super::Crop),
        #[prost(message, tag = &quot;3&quot;)]
        Flipv(super::Flipv),
        #[prost(message, tag = &quot;4&quot;)]
        Fliph(super::Fliph),
        #[prost(message, tag = &quot;5&quot;)]
        Contrast(super::Contrast),
        #[prost(message, tag = &quot;6&quot;)]
        Filter(super::Filter),
        #[prost(message, tag = &quot;7&quot;)]
        Watermark(super::Watermark),
    }
}
</code></pre></pre>
<h3 id="pbabirså¦å¤–å®šä¹‰äº†specdataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“åµŒå¥—æ¨¡å—mod"><a class="header" href="#pbabirså¦å¤–å®šä¹‰äº†specdataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“åµŒå¥—æ¨¡å—mod">pb/abi.rså¦å¤–å®šä¹‰äº†spec::Dataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“/åµŒå¥—æ¨¡å—mod</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct ImageSpec {
    #[prost(message, repeated, tag = &quot;1&quot;)]
    pub specs: ::prost::alloc::vec::Vec&lt;Spec&gt;,
}
/// å¤„ç†å›¾ç‰‡æ”¹å˜å¤§å°
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Resize {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub width: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub height: u32,
    #[prost(enumeration = &quot;resize::ResizeType&quot;, tag = &quot;3&quot;)]
    pub rtype: i32,
    #[prost(enumeration = &quot;resize::SampleFilter&quot;, tag = &quot;4&quot;)]
    pub filter: i32,
}
/// Nested message and enum types in `Resize`.
pub mod resize {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum ResizeType {
        Normal = 0,
        SeamCarve = 1,
    }
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum SampleFilter {
        Undefined = 0,
        Nearest = 1,
        Triangle = 2,
        CatmullRom = 3,
        Gaussian = 4,
        Lanczos3 = 5,
    }
}
/// å¤„ç†å›¾ç‰‡æˆªå–
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Crop {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub x1: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub y1: u32,
    #[prost(uint32, tag = &quot;3&quot;)]
    pub x2: u32,
    #[prost(uint32, tag = &quot;4&quot;)]
    pub y2: u32,
}
/// å¤„ç†æ°´å¹³ç¿»è½¬
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Fliph {}
/// å¤„ç†å‚ç›´ç¿»è½¬
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Flipv {}
/// å¤„ç†å¯¹æ¯”åº¦
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Contrast {
    #[prost(float, tag = &quot;1&quot;)]
    pub contrast: f32,
}
/// å¤„ç†æ»¤é•œ
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Filter {
    #[prost(enumeration = &quot;filter::Filter&quot;, tag = &quot;1&quot;)]
    pub filter: i32,
}
/// Nested message and enum types in `Filter`.
pub mod filter {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum Filter {
        Unspecified = 0,
        Oceanic = 1,
        Islands = 2,
        /// more: &lt;https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html&gt;
        Marine = 3,
    }
}
/// å¤„ç†æ°´å°
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Watermark {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub x: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub y: u32,
}
</code></pre></pre>
<h3 id="pbabirsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“"><a class="header" href="#pbabirsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“">pb/abi.rsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Spec {
    #[prost(oneof = &quot;spec::Data&quot;, tags = &quot;1, 2, 3, 4, 5, 6, 7&quot;)]
    pub data: ::core::option::Option&lt;spec::Data&gt;,
}
</code></pre></pre>
<h3 id="imagespec"><a class="header" href="#imagespec">ImageSpec</a></h3>
<h4 id="å®šä¹‰æœ‰åºæ•°ç»„"><a class="header" href="#å®šä¹‰æœ‰åºæ•°ç»„">å®šä¹‰ï¼šæœ‰åºæ•°ç»„</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct ImageSpec {
    #[prost(message, repeated, tag = &quot;1&quot;)]
    pub specs: ::prost::alloc::vec::Vec&lt;Spec&gt;,
}
</code></pre></pre>
<h4 id="å®ç°newæ–¹æ³•fromtryfromå®ç°ç±»å‹è½¬åŒ–"><a class="header" href="#å®ç°newæ–¹æ³•fromtryfromå®ç°ç±»å‹è½¬åŒ–">å®ç°ï¼šnewæ–¹æ³•ã€From&amp;TryFromå®ç°ç±»å‹è½¬åŒ–</a></h4>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">impl ImageSpec {
    pub fn new(specs: Vec&lt;Spec&gt;) -&gt; Self {
        Self { specs }
    }
}

// è®© ImageSpec å¯ä»¥ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²
impl From&lt;&amp;ImageSpec&gt; for String {
    fn from(image_spec: &amp;ImageSpec) -&gt; Self {
        let data = image_spec.encode_to_vec();
        encode_config(data, URL_SAFE_NO_PAD)
    }
}

// è®© ImageSpec å¯ä»¥é€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²åˆ›å»ºã€‚æ¯”å¦‚ s.parse().unwrap()
impl TryFrom&lt;&amp;str&gt; for ImageSpec {
    type Error = anyhow::Error;

    fn try_from(value: &amp;str) -&gt; Result&lt;Self, Self::Error&gt; {
        let data = decode_config(value, URL_SAFE_NO_PAD)?;
        Ok(ImageSpec::decode(&amp;data[..])?)
    }
}
</code></pre></pre>
<h3 id="filter"><a class="header" href="#filter">Filter</a></h3>
<h4 id="å®šä¹‰æšä¸¾ä½“mod"><a class="header" href="#å®šä¹‰æšä¸¾ä½“mod">å®šä¹‰ï¼šæšä¸¾ä½“mod</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Filter`.
pub mod filter {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum Filter {
        Unspecified = 0,
        Oceanic = 1,
        Islands = 2,
        /// more: &lt;https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html&gt;
        Marine = 3,
    }
}
</code></pre></pre>
<h4 id="å®ç°åŒå¼•å·çš„ä½¿ç”¨æ¨¡å¼åŒ¹é…"><a class="header" href="#å®ç°åŒå¼•å·çš„ä½¿ç”¨æ¨¡å¼åŒ¹é…">å®ç°ï¼šåŒå¼•å·çš„ä½¿ç”¨ã€æ¨¡å¼åŒ¹é…</a></h4>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">// è¾…åŠ©å‡½æ•°ï¼Œphoton_rs ç›¸åº”çš„æ–¹æ³•é‡Œéœ€è¦å­—ç¬¦ä¸²
impl filter::Filter {
    pub fn to_str(self) -&gt; Option&lt;&amp;'static str&gt; {
        match self {
            filter::Filter::Unspecified =&gt; None,
            filter::Filter::Oceanic =&gt; Some(&quot;oceanic&quot;),
            filter::Filter::Islands =&gt; Some(&quot;islands&quot;),
            filter::Filter::Marine =&gt; Some(&quot;marine&quot;),
        }
    }
}
</code></pre></pre>
<h3 id="samplefilter"><a class="header" href="#samplefilter">SampleFilter</a></h3>
<h4 id="å®šä¹‰æšä¸¾ä½“mod-1"><a class="header" href="#å®šä¹‰æšä¸¾ä½“mod-1">å®šä¹‰ï¼šæšä¸¾ä½“mod</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Resize`.
pub mod resize {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum ResizeType {
        Normal = 0,
        SeamCarve = 1,
    }
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum SampleFilter {
        Undefined = 0,
        Nearest = 1,
        Triangle = 2,
        CatmullRom = 3,
        Gaussian = 4,
        Lanczos3 = 5,
    }
}
</code></pre></pre>
<h3 id="å®ç°modä½¿ç”¨åŒå¼•å·fromè½¬ä¸ºä¸åŒç»“æœ"><a class="header" href="#å®ç°modä½¿ç”¨åŒå¼•å·fromè½¬ä¸ºä¸åŒç»“æœ">å®ç°ï¼šmodä½¿ç”¨åŒå¼•å·ã€Fromè½¬ä¸ºä¸åŒç»“æœ</a></h3>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">impl From&lt;resize::SampleFilter&gt; for SamplingFilter {
    fn from(v: resize::SampleFilter) -&gt; Self {
        match v {
            resize::SampleFilter::Undefined =&gt; SamplingFilter::Nearest,
            resize::SampleFilter::Nearest =&gt; SamplingFilter::Nearest,
            resize::SampleFilter::Triangle =&gt; SamplingFilter::Triangle,
            resize::SampleFilter::CatmullRom =&gt; SamplingFilter::CatmullRom,
            resize::SampleFilter::Gaussian =&gt; SamplingFilter::Gaussian,
            resize::SampleFilter::Lanczos3 =&gt; SamplingFilter::Lanczos3,
        }
    }
}
</code></pre></pre>
<h3 id="spec"><a class="header" href="#spec">Spec</a></h3>
<h4 id="å®šä¹‰ç»“æ„ä½“"><a class="header" href="#å®šä¹‰ç»“æ„ä½“">å®šä¹‰ï¼šç»“æ„ä½“</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Spec {
    #[prost(oneof = &quot;spec::Data&quot;, tags = &quot;1, 2, 3, 4, 5, 6, 7&quot;)]
    pub data: ::core::option::Option&lt;spec::Data&gt;,
}
</code></pre></pre>
<h4 id="å®ç°ç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•self"><a class="header" href="#å®ç°ç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•self">å®ç°ï¼šç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•Self</a></h4>
<blockquote>
<p>æ³¨æ„åŒºåˆ«Selfå’Œselfçš„ä½¿ç”¨ï¼š
<a href="https://stackoverflow.com/questions/32304595/whats-the-difference-between-self-and-self">rust - Whatâ€™s the difference between self and Self? - Stack Overflow</a></p>
</blockquote>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">// æä¾›ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œè®©åˆ›å»ºä¸€ä¸ª spec çš„è¿‡ç¨‹ç®€å•ä¸€äº›
impl Spec {
    pub fn new_resize_seam_carve(width: u32, height: u32) -&gt; Self {
        Self {
            data: Some(spec::Data::Resize(Resize {
                width,
                height,
                rtype: resize::ResizeType::SeamCarve as i32,
                filter: resize::SampleFilter::Undefined as i32,
            })),
        }
    }

    pub fn new_resize(width: u32, height: u32, filter: resize::SampleFilter) -&gt; Self {
        Self {
            data: Some(spec::Data::Resize(Resize {
                width,
                height,
                rtype: resize::ResizeType::Normal as i32,
                filter: filter as i32,
            })),
        }
    }

    pub fn new_filter(filter: filter::Filter) -&gt; Self {
        Self {
            data: Some(spec::Data::Filter(Filter {
                filter: filter as i32,
            })),
        }
    }

    pub fn new_watermark(x: u32, y: u32) -&gt; Self {
        Self {
            data: Some(spec::Data::Watermark(Watermark { x, y })),
        }
    }
}
</code></pre></pre>
<h3 id="å•å…ƒæµ‹è¯•"><a class="header" href="#å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#[cfg(test)]
mod tests {
    use super::*;
    use std::borrow::Borrow;

    #[test]
    fn encoded_spec_could_be_decoded() {
        let spec1 = Spec::new_resize(600, 600, resize::SampleFilter::CatmullRom);
        let spec2 = Spec::new_filter(filter::Filter::Marine);
        let image_spec = ImageSpec::new(vec![spec1, spec2]);
        let s: String = image_spec.borrow().into();
        assert_eq!(image_spec, s.as_str().try_into().unwrap());
    }
}
</code></pre></pre>
<h2 id="engineæ¨¡å—-å¤„ç†å›¾ç‰‡"><a class="header" href="#engineæ¨¡å—-å¤„ç†å›¾ç‰‡">engineæ¨¡å—: å¤„ç†å›¾ç‰‡</a></h2>
<h3 id="modrs-å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait"><a class="header" href="#modrs-å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait">mod.rs: å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// Engine traitï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šçš„ engineï¼Œä¸»æµç¨‹åªéœ€è¦æ›¿æ¢ engine
pub trait Engine {
    // å¯¹ engine æŒ‰ç…§ specs è¿›è¡Œä¸€ç³»åˆ—æœ‰åºçš„å¤„ç†
    fn apply(&amp;mut self, specs: &amp;[Spec]);
    // ä» engine ä¸­ç”Ÿæˆç›®æ ‡å›¾ç‰‡ï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ selfï¼Œè€Œé self çš„å¼•ç”¨
    fn generate(self, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt;;
}

// SpecTransformï¼šæœªæ¥å¦‚æœæ·»åŠ æ›´å¤šçš„ specï¼Œåªéœ€è¦å®ç°å®ƒå³å¯
pub trait SpecTransform&lt;T&gt; {
    // å¯¹å›¾ç‰‡ä½¿ç”¨ op åš transform
    fn transform(&amp;mut self, op: T);
}
</code></pre></pre>
<h3 id="photonrs--é™æ€å˜é‡åŠ è½½"><a class="header" href="#photonrs--é™æ€å˜é‡åŠ è½½">photon.rs &gt; é™æ€å˜é‡åŠ è½½</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">lazy_static! {
    // é¢„å…ˆæŠŠæ°´å°æ–‡ä»¶åŠ è½½ä¸ºé™æ€å˜é‡
    static ref WATERMARK: PhotonImage = {
        let data = include_bytes!(&quot;../../rust-logo.png&quot;);
        let watermark = open_image_from_bytes(data).unwrap();
        transform::resize(&amp;watermark, 64, 64, transform::SamplingFilter::Nearest)
    };
}
</code></pre></pre>
<h3 id="photonrs--å…·ä½“å¼•æ“photonçš„å®šä¹‰ä¸è½¬åŒ–tryfrom"><a class="header" href="#photonrs--å…·ä½“å¼•æ“photonçš„å®šä¹‰ä¸è½¬åŒ–tryfrom">photon.rs &gt; å…·ä½“å¼•æ“Photonçš„å®šä¹‰ä¸è½¬åŒ–TryFrom</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">pub struct Photon(PhotonImage);

// ä» Bytes è½¬æ¢æˆ Photon ç»“æ„
impl TryFrom&lt;Bytes&gt; for Photon {
    type Error = anyhow::Error;

    fn try_from(data: Bytes) -&gt; Result&lt;Self, Self::Error&gt; {
        Ok(Self(open_image_from_bytes(&amp;data)?))
    }
}
</code></pre></pre>
<h3 id="photonrs--å…·ä½“å¼•æ“photonçš„traitå®ç°"><a class="header" href="#photonrs--å…·ä½“å¼•æ“photonçš„traitå®ç°">photon.rs &gt; å…·ä½“å¼•æ“Photonçš„traitå®ç°</a></h3>
<h4 id="engine-trait"><a class="header" href="#engine-trait">Engine Trait</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">impl Engine for Photon {
    fn apply(&amp;mut self, specs: &amp;[Spec]) {
        for spec in specs.iter() {
            match spec.data {
                Some(spec::Data::Crop(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Contrast(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Filter(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Fliph(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Flipv(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Resize(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Watermark(ref v)) =&gt; self.transform(v),
                // å¯¹äºç›®å‰ä¸è®¤è¯†çš„ specï¼Œä¸åšä»»ä½•å¤„ç†
                _ =&gt; {}
            }
        }
    }
</code></pre></pre>
<h4 id="spectransform-trait"><a class="header" href="#spectransform-trait">SpecTransform Trait</a></h4>
<h5 id="æ ¼å¼è¯­ä¹‰åŒ–"><a class="header" href="#æ ¼å¼è¯­ä¹‰åŒ–">æ ¼å¼è¯­ä¹‰åŒ–</a></h5>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl SpecTransform(&amp;OpreationName) for SpecificEngine {
    fn transform(&amp;mut self, _op: &amp;OperationName) {
        transform::OperationMethod(&amp;mut self.0)
    }
}
<span class="boring">}
</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust  editable">impl SpecTransform&lt;&amp;Crop&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Crop) {
        let img = transform::crop(&amp;mut self.0, op.x1, op.y1, op.x2, op.y2);
        self.0 = img;
    }
}

impl SpecTransform&lt;&amp;Contrast&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Contrast) {
        effects::adjust_contrast(&amp;mut self.0, op.contrast);
    }
}

impl SpecTransform&lt;&amp;Flipv&gt; for Photon {
    fn transform(&amp;mut self, _op: &amp;Flipv) {
        transform::flipv(&amp;mut self.0)
    }
}

impl SpecTransform&lt;&amp;Fliph&gt; for Photon {
    fn transform(&amp;mut self, _op: &amp;Fliph) {
        transform::fliph(&amp;mut self.0)
    }
}

impl SpecTransform&lt;&amp;Filter&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Filter) {
        match filter::Filter::from_i32(op.filter) {
            Some(filter::Filter::Unspecified) =&gt; {}
            Some(f) =&gt; filters::filter(&amp;mut self.0, f.to_str().unwrap()),
            _ =&gt; {}
        }
    }
}

impl SpecTransform&lt;&amp;Resize&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Resize) {
        let img = match resize::ResizeType::from_i32(op.rtype).unwrap() {
            resize::ResizeType::Normal =&gt; transform::resize(
                &amp;self.0,
                op.width,
                op.height,
                resize::SampleFilter::from_i32(op.filter).unwrap().into(),
            ),
            resize::ResizeType::SeamCarve =&gt; transform::seam_carve(&amp;self.0, op.width, op.height),
        };
        self.0 = img;
    }
}

impl SpecTransform&lt;&amp;Watermark&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Watermark) {
        multiple::watermark(&amp;mut self.0, &amp;WATERMARK, op.x, op.y);
    }
}
</code></pre></pre>
<h3 id="photonrs--åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•"><a class="header" href="#photonrs--åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•">photon.rs &gt; åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">fn image_to_buf(img: PhotonImage, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt; {
    let raw_pixels = img.get_raw_pixels();
    let width = img.get_width();
    let height = img.get_height();

    let img_buffer = ImageBuffer::from_vec(width, height, raw_pixels).unwrap();
    let dynimage = DynamicImage::ImageRgba8(img_buffer);

    let mut buffer = Vec::with_capacity(32768);
    dynimage.write_to(&amp;mut buffer, format).unwrap();
    buffer
}
</code></pre></pre>
<h2 id="mainrs"><a class="header" href="#mainrs">main.rs</a></h2>
<h3 id="å…ˆå¼•å…¥modå†use"><a class="header" href="#å…ˆå¼•å…¥modå†use">å…ˆå¼•å…¥modï¼Œå†use</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// å‚æ•°ä½¿ç”¨ serde åš Deserializeï¼Œaxum ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶è§£æ
#[derive(Deserialize)]
struct Params {
    spec: String,
    url: String,
}
</code></pre></pre>
<h3 id="å›¾ç‰‡èµ„æºç”¨åˆ°lruç­–ç•¥ç¼“å­˜typeå®šä¹‰"><a class="header" href="#å›¾ç‰‡èµ„æºç”¨åˆ°lruç­–ç•¥ç¼“å­˜typeå®šä¹‰">å›¾ç‰‡èµ„æºç”¨åˆ°Lruç­–ç•¥ç¼“å­˜typeå®šä¹‰</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">type Cache = Arc&lt;Mutex&lt;LruCache&lt;u64, Bytes&gt;&gt;&gt;;
</code></pre></pre>
<h3 id="ä¸»æµç¨‹mainå‡½æ•°"><a class="header" href="#ä¸»æµç¨‹mainå‡½æ•°">ä¸»æµç¨‹mainå‡½æ•°</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#[tokio::main]
async fn main() {
    // åˆå§‹åŒ– tracing
    tracing_subscriber::fmt::init();
    let cache: Cache = Arc::new(Mutex::new(LruCache::new(1024)));
    // æ„å»ºè·¯ç”±
    let app = Router::new()
        // `GET /` ä¼šæ‰§è¡Œ
        .route(&quot;/image/:spec/:url&quot;, get(generate))
        .layer(
            ServiceBuilder::new()
                .load_shed()
                .concurrency_limit(1024)
                .timeout(Duration::from_secs(10))
                .layer(TraceLayer::new_for_http())
                .layer(AddExtensionLayer::new(cache))
                .layer(CompressionLayer::new())
                .into_inner(),
        );

    // è¿è¡Œ web æœåŠ¡å™¨
    let addr = &quot;127.0.0.1:3000&quot;.parse().unwrap();
    print_test_url(&quot;https://images.pexels.com/photos/1562477/pexels-photo-1562477.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=3&amp;h=750&amp;w=1260&quot;);
    info!(&quot;Listening on {}&quot;, addr);
    axum::Server::bind(&amp;addr)
        .serve(app.into_make_service())
        .await
        .unwrap();
}
</code></pre></pre>
<h4 id="å»ºé€ è€…æ¨¡å¼"><a class="header" href="#å»ºé€ è€…æ¨¡å¼">å»ºé€ è€…æ¨¡å¼</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">            ServiceBuilder::new()
                .load_shed()
                .concurrency_limit(1024)
                .timeout(Duration::from_secs(10))
                .layer(TraceLayer::new_for_http())
                .layer(AddExtensionLayer::new(cache))
                .layer(CompressionLayer::new())
                .into_inner(),
</code></pre></pre>
<h4 id="ç±»å‹è½¬æ¢"><a class="header" href="#ç±»å‹è½¬æ¢">ç±»å‹è½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">    // è¿è¡Œ web æœåŠ¡å™¨
    let addr = &quot;127.0.0.1:3000&quot;.parse().unwrap();
</code></pre></pre>
<h5 id="æ•°å­—ä¸å­—ç¬¦ä¸²"><a class="header" href="#æ•°å­—ä¸å­—ç¬¦ä¸²">æ•°å­—ä¸å­—ç¬¦ä¸²</a></h5>
<p>||i32|u32|f64|String*|
|--|---|---|---|-------|
|i32|\|x as u32|x as f64|x.to_string()|
|u32|x as i32|\|x as f64|x.to_string()|
|f64|x as i32|x as u32|\|x.to_string()|
|String*|x.parse().unwrap()|x.parse().unwrap()|x.parse().unwrap()|\|</p>
<h5 id="string-ä¸--str"><a class="header" href="#string-ä¸--str">String ä¸ &amp; str</a></h5>
<p>|\|String|&amp;str|
|-|------|----|
|String|\|&amp;*x|
|&amp;str|x.to_string()|\|</p>
<h5 id="æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ</a></h5>
<p>|\|Vec&lt;T&gt;|&amp;[T]|Box&lt;[T]&gt;|
|-|------|----|--------|
|Vec&lt;T&gt;|\|&amp;x[â€¦]|x.into_boxed_slice()|
|&amp;[T]|x.to_vec()|\|Box::new(*x)|
|Box&lt;[T]&gt;|x.to_vec()|&amp;*x|\|</p>
<h3 id="è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler"><a class="header" href="#è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler">è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// basic handler that responds with a static string
async fn generate(
    Path(Params { spec, url }): Path&lt;Params&gt;,
    Extension(cache): Extension&lt;Cache&gt;,
) -&gt; Result&lt;(HeaderMap, Vec&lt;u8&gt;), StatusCode&gt; {
    let spec: ImageSpec = spec
        .as_str()
        .try_into()
        .map_err(|_| StatusCode::BAD_REQUEST)?;

    let url: &amp;str = &amp;percent_decode_str(&amp;url).decode_utf8_lossy();
    let data = retrieve_image(url, cache)
        .await
        .map_err(|_| StatusCode::BAD_REQUEST)?;

    // ä½¿ç”¨ image engine å¤„ç†
    let mut engine: Photon = data
        .try_into()
        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
    engine.apply(&amp;spec.specs);
    // TODO: è¿™é‡Œç›®å‰ç±»å‹å†™æ­»äº†ï¼Œåº”è¯¥ä½¿ç”¨ content negotiation
    let image = engine.generate(ImageOutputFormat::Jpeg(85));

    info!(&quot;Finished processing: image size {}&quot;, image.len());
    let mut headers = HeaderMap::new();

    headers.insert(&quot;content-type&quot;, HeaderValue::from_static(&quot;image/jpeg&quot;));
    Ok((headers, image))
}
</code></pre></pre>
<h3 id="å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•"><a class="header" href="#å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•">å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•</a></h3>
<blockquote>
<p>å¯¹äºå›¾ç‰‡çš„ç½‘ç»œè¯·æ±‚ï¼Œæˆ‘ä»¬å…ˆæŠŠ URL åšä¸ªå“ˆå¸Œï¼Œåœ¨ LRU ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°æ‰ç”¨ reqwest å‘é€è¯·æ±‚ã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">#[instrument(level = &quot;info&quot;, skip(cache))]
async fn retrieve_image(url: &amp;str, cache: Cache) -&gt; Result&lt;Bytes&gt; {
    let mut hasher = DefaultHasher::new();
    url.hash(&amp;mut hasher);
    let key = hasher.finish();

    let g = &amp;mut cache.lock().await;
    let data = match g.get(&amp;key) {
        Some(v) =&gt; {
            info!(&quot;Match cache {}&quot;, key);
            v.to_owned()
        }
        None =&gt; {
            info!(&quot;Retrieve url&quot;);
            let resp = reqwest::get(url).await?;
            let data = resp.bytes().await?;
            g.put(key, data.clone());
            data
        }
    };

    Ok(data)
}
</code></pre></pre>
<h3 id="ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°"><a class="header" href="#ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°">ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// è°ƒè¯•è¾…åŠ©å‡½æ•°
fn print_test_url(url: &amp;str) {
    use std::borrow::Borrow;
    let spec1 = Spec::new_resize(500, 800, resize::SampleFilter::CatmullRom);
    let spec2 = Spec::new_watermark(20, 20);
    let spec3 = Spec::new_filter(filter::Filter::Marine);
    let image_spec = ImageSpec::new(vec![spec1, spec2, spec3]);
    let s: String = image_spec.borrow().into();
    let test_image = percent_encode(url.as_bytes(), NON_ALPHANUMERIC).to_string();
    println!(&quot;test url: http://localhost:3000/image/{}/{}&quot;, s, test_image);
}
</code></pre></pre>
<h2 id="è¿è¡Œä¸æ—¥å¿—"><a class="header" href="#è¿è¡Œä¸æ—¥å¿—">è¿è¡Œä¸æ—¥å¿—</a></h2>
<blockquote>
<p>å°†RUST_LOGçº§åˆ«è®¾ç½®ä¸ºinfo</p>
</blockquote>
<pre><code class="language-shell">cargo build --release
RUST_LOG=info target/release/thumbor
</code></pre>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="rgrep.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="queryer.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="rgrep.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="queryer.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
