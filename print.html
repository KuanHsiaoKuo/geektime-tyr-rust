<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>Anatomy In First Rust Programming Class ğŸ¦€</title>
        <meta name="robots" content="noindex"/>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="æºç è§£æé€»è¾‘"><a class="header" href="#æºç è§£æé€»è¾‘">æºç è§£æé€»è¾‘</a></h1>
<!--ts-->
<ul>
<li><a href="anatomy_logic.html#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%80%BB%E8%BE%91">æºç è§£æé€»è¾‘</a>
<ul>
<li><a href="anatomy_logic.html#%E9%A1%B9%E7%9B%AE%E6%96%87%E6%A1%A3">é¡¹ç›®æ–‡æ¡£</a>
<ul>
<li><a href="anatomy_logic.html#%E6%9D%A5%E6%BA%90">æ¥æº</a></li>
<li><a href="anatomy_logic.html#cargo-doc%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8">cargo docå‘½ä»¤ä½¿ç”¨</a>
<ul>
<li><a href="anatomy_logic.html#--open">â€“open</a></li>
<li><a href="anatomy_logic.html#--no-deps">â€“no-deps</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#%E4%BD%BF%E7%94%A8%E5%8C%BA%E5%88%AB">ä½¿ç”¨åŒºåˆ«</a></li>
<li><a href="anatomy_logic.html#%E4%BD%BF%E7%94%A8%E7%BB%86%E8%8A%82">ä½¿ç”¨ç»†èŠ‚</a>
<ul>
<li><a href="anatomy_logic.html#crates">Crates</a></li>
<li><a href="anatomy_logic.html#crate%E5%8C%85%E5%90%AB%E6%88%90%E5%91%98">crateåŒ…å«æˆå‘˜</a></li>
<li><a href="anatomy_logic.html#re-exports">Re-exports</a></li>
<li><a href="anatomy_logic.html#modules">Modules</a></li>
<li><a href="anatomy_logic.html#macros">Macros</a></li>
<li><a href="anatomy_logic.html#derive-macros">Derive Macros</a></li>
<li><a href="anatomy_logic.html#attribute-macros">Attribute Macros</a></li>
<li><a href="anatomy_logic.html#structs">Structs</a>
<ul>
<li><a href="anatomy_logic.html#definition">Definition</a></li>
<li><a href="anatomy_logic.html#associated-types">Associated Types</a></li>
<li><a href="anatomy_logic.html#implementations">Implementations</a></li>
<li><a href="anatomy_logic.html#trait-implementations">Trait Implementations</a></li>
<li><a href="anatomy_logic.html#auto-trait-implementations">Auto Trait Implementations</a></li>
<li><a href="anatomy_logic.html#blanket-implementations">Blanket Implementations</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#enums">Enums</a>
<ul>
<li><a href="anatomy_logic.html#definition-1">Definition</a></li>
<li><a href="anatomy_logic.html#variants">Variants</a></li>
<li><a href="anatomy_logic.html#trait-implementations-1">Trait Implementations</a></li>
<li><a href="anatomy_logic.html#auto-trait-implementations-1">Auto Trait Implementations</a></li>
<li><a href="anatomy_logic.html#blanket-implementations-1">Blanket Implementations</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#constants">Constants</a></li>
<li><a href="anatomy_logic.html#traits">Traits</a>
<ul>
<li><a href="anatomy_logic.html#definition-2">Definition</a></li>
<li><a href="anatomy_logic.html#required-methods">Required methods</a></li>
<li><a href="anatomy_logic.html#implementations-on-foreign-types">Implementations on Foreign Types</a></li>
<li><a href="anatomy_logic.html#implementors">Implementors</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#functions">Functions</a>
<ul>
<li><a href="anatomy_logic.html#definition-3">Definition</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#type-definitions">Type Definitions</a>
<ul>
<li><a href="anatomy_logic.html#definition-4">Definition</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sat Sep 24 03:25:10 UTC 2022 -->
<!--te-->
<h2 id="é¡¹ç›®æ–‡æ¡£"><a class="header" href="#é¡¹ç›®æ–‡æ¡£">é¡¹ç›®æ–‡æ¡£</a></h2>
<h3 id="æ¥æº"><a class="header" href="#æ¥æº">æ¥æº</a></h3>
<ol>
<li>ç¬¬ä¸‰æ–¹crateå¯ä»¥åœ¨<a href="https://docs.rs/">å®˜æ–¹æ–‡æ¡£</a>ä¸Šé¢æœç´¢</li>
<li>æœ¬åœ°crateå¯ä»¥ä½¿ç”¨å‘½ä»¤<code>cargo doc --open</code>.</li>
</ol>
<h3 id="cargo-docå‘½ä»¤ä½¿ç”¨"><a class="header" href="#cargo-docå‘½ä»¤ä½¿ç”¨">cargo docå‘½ä»¤ä½¿ç”¨</a></h3>
<blockquote>
<p><a href="https://doc.rust-lang.org/cargo/commands/cargo-doc.html">æ›´å¤šå†…å®¹</a></p>
</blockquote>
<h4 id="open"><a class="header" href="#open">â€“open</a></h4>
<p>è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£å¹¶åœ¨æµè§ˆå™¨æ‰“å¼€</p>
<h4 id="no-deps"><a class="header" href="#no-deps">â€“no-deps</a></h4>
<p>é»˜è®¤æƒ…å†µä¸‹ä¼šæŠŠé¡¹ç›®ä¾èµ–çš„åŒ…æ–‡æ¡£ä¹Ÿç”Ÿæˆï¼Œè¿™ä¹Ÿæ˜¯æ–‡æ¡£å·¦ä¾§Cratesçš„æ¥æºä¹‹ä¸€ã€‚
è¿™ä¸ªå‚æ•°å¯ä»¥å±è”½æ‰ä¾èµ–çš„crates</p>
<h3 id="ä½¿ç”¨åŒºåˆ«"><a class="header" href="#ä½¿ç”¨åŒºåˆ«">ä½¿ç”¨åŒºåˆ«</a></h3>
<ol>
<li>äºŒè€…å†…å®¹æ²¡æœ‰åŒºåˆ«ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ˜¯æ‰§è¡Œå‘½ä»¤ç”Ÿæˆæ–‡æ¡£ã€‚</li>
<li>å®˜æ–¹æ–‡æ¡£è¿˜å¯ä»¥æä¾›å¾ˆå¤šç»†èŠ‚ï¼Œæ¯”å¦‚gitåˆ†æ”¯åœ°å€</li>
</ol>
<h3 id="ä½¿ç”¨ç»†èŠ‚"><a class="header" href="#ä½¿ç”¨ç»†èŠ‚">ä½¿ç”¨ç»†èŠ‚</a></h3>
<blockquote>
<p>è¿™é‡ŒæŒ‰ç…§æ–‡æ¡£çš„å±‚çº§è¿›è¡Œé€’è¿›è¯´æ˜</p>
</blockquote>
<h4 id="crates"><a class="header" href="#crates">Crates</a></h4>
<p>æ‰€æœ‰æ–‡æ¡£çš„é¦–é¡µéƒ½ä¼šæœ‰è¿™ä¸€é¡¹ï¼Œåˆ—å‡ºé¡¹ç›®åŒ…å«çš„crate</p>
<h4 id="crateåŒ…å«æˆå‘˜"><a class="header" href="#crateåŒ…å«æˆå‘˜">crateåŒ…å«æˆå‘˜</a></h4>
<blockquote>
<p>ç‚¹å‡»Cratesä¸‹çš„æŸä¸ªcrateï¼Œå³ä¾§é¡µé¢å°±ä¼šæ˜¾ç¤ºå½“å‰crateåŒ…å«çš„å…ƒç´ ï¼Œ ä¸»è¦æœ‰ä¸‹åˆ—å†…å®¹</p>
</blockquote>
<ul>
<li>Re-exports</li>
<li>Modules</li>
<li>Macros</li>
<li>Derive Macros</li>
<li>Attribute Macros</li>
<li>Structs</li>
<li>Enums</li>
<li>Constants</li>
<li>Traits</li>
<li>Functions</li>
<li>Type Definitions</li>
</ul>
<h4 id="re-exports"><a class="header" href="#re-exports">Re-exports</a></h4>
<blockquote>
<p>futures_util</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub use reader::DecompressorCustomIo;
<span class="boring">}
</span></code></pre></pre>
<h4 id="modules"><a class="header" href="#modules">Modules</a></h4>
<p>å…¶å®å°±æ˜¯modï¼Œç‚¹å‡»ä¹‹åå°†ä¼šåˆ—å‡ºæŸä¸ªmodé‡Œé¢çš„æˆå‘˜</p>
<h4 id="macros"><a class="header" href="#macros">Macros</a></h4>
<h4 id="derive-macros"><a class="header" href="#derive-macros">Derive Macros</a></h4>
<blockquote>
<p>darling_macroã€clap_derive</p>
</blockquote>
<h4 id="attribute-macros"><a class="header" href="#attribute-macros">Attribute Macros</a></h4>
<blockquote>
<p>tokio_macrosã€futures_macro</p>
</blockquote>
<h4 id="structs"><a class="header" href="#structs">Structs</a></h4>
<h5 id="definition"><a class="header" href="#definition">Definition</a></h5>
<h5 id="associated-types"><a class="header" href="#associated-types">Associated Types</a></h5>
<h5 id="implementations"><a class="header" href="#implementations">Implementations</a></h5>
<h5 id="trait-implementations"><a class="header" href="#trait-implementations">Trait Implementations</a></h5>
<h5 id="auto-trait-implementations"><a class="header" href="#auto-trait-implementations">Auto Trait Implementations</a></h5>
<h5 id="blanket-implementations"><a class="header" href="#blanket-implementations">Blanket Implementations</a></h5>
<h4 id="enums"><a class="header" href="#enums">Enums</a></h4>
<h5 id="definition-1"><a class="header" href="#definition-1">Definition</a></h5>
<h5 id="variants"><a class="header" href="#variants">Variants</a></h5>
<h5 id="trait-implementations-1"><a class="header" href="#trait-implementations-1">Trait Implementations</a></h5>
<h5 id="auto-trait-implementations-1"><a class="header" href="#auto-trait-implementations-1">Auto Trait Implementations</a></h5>
<h5 id="blanket-implementations-1"><a class="header" href="#blanket-implementations-1">Blanket Implementations</a></h5>
<h4 id="constants"><a class="header" href="#constants">Constants</a></h4>
<h4 id="traits"><a class="header" href="#traits">Traits</a></h4>
<h5 id="definition-2"><a class="header" href="#definition-2">Definition</a></h5>
<h5 id="required-methods"><a class="header" href="#required-methods">Required methods</a></h5>
<h5 id="implementations-on-foreign-types"><a class="header" href="#implementations-on-foreign-types">Implementations on Foreign Types</a></h5>
<h5 id="implementors"><a class="header" href="#implementors">Implementors</a></h5>
<h4 id="functions"><a class="header" href="#functions">Functions</a></h4>
<h5 id="definition-3"><a class="header" href="#definition-3">Definition</a></h5>
<h4 id="type-definitions"><a class="header" href="#type-definitions">Type Definitions</a></h4>
<h5 id="definition-4"><a class="header" href="#definition-4">Definition</a></h5>
<blockquote>
<p>html2md</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub type BoxedError = Box&lt;dyn Error + Send + Sync&gt;;
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gdblldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„"><a class="header" href="#gdblldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„">gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></h1>
<!--ts-->
<ul>
<li><a href="intro_gdb_lldb.html#gdblldb%E8%B0%83%E8%AF%95%E6%88%96%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84">gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a>
<ul>
<li><a href="intro_gdb_lldb.html#%E8%B5%84%E6%96%99%E6%95%B4%E7%90%86">èµ„æ–™æ•´ç†</a>
<ul>
<li><a href="intro_gdb_lldb.html#%E5%AE%98%E6%96%B9%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84cheat-sheet">å®˜æ–¹æ•°æ®ç»“æ„cheat sheet</a></li>
</ul>
</li>
<li><a href="intro_gdb_lldb.html#%E6%9F%A5%E7%9C%8Bhashmap%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84">æŸ¥çœ‹hashmapå†…å­˜ç»“æ„</a>
<ul>
<li><a href="intro_gdb_lldb.html#bin%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%BF%90%E8%A1%8C">biné…ç½®ä¸è¿è¡Œ</a></li>
<li><a href="intro_gdb_lldb.html#%E7%9B%AE%E6%A0%87%E8%B0%83%E8%AF%95%E4%BB%A3%E7%A0%81">ç›®æ ‡è°ƒè¯•ä»£ç </a></li>
<li><a href="intro_gdb_lldb.html#%E4%BD%BF%E7%94%A8gdblldb%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84">ä½¿ç”¨gdb/lldbè¿›è¡Œè°ƒè¯•æŸ¥çœ‹å†…å­˜ç»“æ„</a>
<ul>
<li><a href="intro_gdb_lldb.html#gdb-%E4%B8%BB%E8%A6%81%E6%98%AFlinux%E7%B3%BB%E7%BB%9F">gdb: ä¸»è¦æ˜¯linuxç³»ç»Ÿ</a></li>
<li><a href="intro_gdb_lldb.html#lldb-%E4%B8%BB%E8%A6%81osx%E7%B3%BB%E7%BB%9F">lldb: ä¸»è¦OSXç³»ç»Ÿ</a></li>
<li><a href="intro_gdb_lldb.html#idea">IDEA</a></li>
<li><a href="intro_gdb_lldb.html#gdb%E4%B8%8Elldb%E5%91%BD%E4%BB%A4%E5%AF%B9%E7%85%A7">gdbä¸lldbå‘½ä»¤å¯¹ç…§</a></li>
<li><a href="intro_gdb_lldb.html#%E5%BC%80%E5%A7%8B%E8%B0%83%E8%AF%95">å¼€å§‹è°ƒè¯•</a></li>
<li><a href="intro_gdb_lldb.html#breakpoint-%E6%B7%BB%E5%8A%A0%E6%96%AD%E7%82%B9">b(reakpoint): æ·»åŠ æ–­ç‚¹</a></li>
<li><a href="intro_gdb_lldb.html#run%E8%BF%90%E8%A1%8C%E5%88%B0%E6%96%AD%E7%82%B9">r(un):è¿è¡Œåˆ°æ–­ç‚¹</a></li>
<li><a href="intro_gdb_lldb.html#continue%E7%BB%A7%E7%BB%AD%E5%8D%95%E6%AD%A5%E6%89%A7%E8%A1%8C">c(ontinue):ç»§ç»­å•æ­¥æ‰§è¡Œ</a></li>
<li><a href="intro_gdb_lldb.html#x-%E6%89%93%E5%8D%B0%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80">x: æ‰“å°å†…å­˜åœ°å€</a></li>
<li><a href="intro_gdb_lldb.html#continue-%E7%BB%A7%E7%BB%AD%E6%89%A7%E8%A1%8C%E5%88%B0%E4%B8%8B%E4%B8%80%E4%B8%AA%E6%96%AD%E7%82%B9">c(ontinue): ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="intro_gdb_lldb.html#%E6%9F%A5%E7%9C%8B%E9%97%AD%E5%8C%85%E7%9A%84%E7%BB%93%E6%9E%84">æŸ¥çœ‹é—­åŒ…çš„ç»“æ„</a>
<ul>
<li><a href="intro_gdb_lldb.html#%E4%BB%A3%E7%A0%81">ä»£ç </a></li>
<li><a href="intro_gdb_lldb.html#%E8%BF%90%E8%A1%8C%E8%BF%9B%E5%85%A5lldb">è¿è¡Œè¿›å…¥lldb</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sat Sep 24 03:25:11 UTC 2022 -->
<!--te-->
<h2 id="èµ„æ–™æ•´ç†"><a class="header" href="#èµ„æ–™æ•´ç†">èµ„æ–™æ•´ç†</a></h2>
<h3 id="å®˜æ–¹æ•°æ®ç»“æ„cheat-sheet"><a class="header" href="#å®˜æ–¹æ•°æ®ç»“æ„cheat-sheet">å®˜æ–¹æ•°æ®ç»“æ„cheat sheet</a></h3>
<ul>
<li><a href="https://cheats.rs/#data-layout">Rust Language Cheat Sheet</a></li>
</ul>
<h2 id="æŸ¥çœ‹hashmapå†…å­˜ç»“æ„"><a class="header" href="#æŸ¥çœ‹hashmapå†…å­˜ç»“æ„">æŸ¥çœ‹hashmapå†…å­˜ç»“æ„</a></h2>
<h3 id="biné…ç½®ä¸è¿è¡Œ"><a class="header" href="#biné…ç½®ä¸è¿è¡Œ">biné…ç½®ä¸è¿è¡Œ</a></h3>
<ul>
<li><a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html?highlight=bin#binaries">Cargo Targets - The Cargo Book</a></li>
</ul>
<pre><code class="language-toml">[package]
name = &quot;hashtable&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[[bin]]
name = &quot;hashmap1&quot;
path = &quot;src/hashmap1.rs&quot;

[[bin]]
name = &quot;hashmap2&quot;
path = &quot;src/hashmap2.rs&quot;

[[bin]]
name = &quot;hash&quot;
path = &quot;src/hash.rs&quot;

[[bin]]
name = &quot;siphasher&quot;
path = &quot;src/siphasher.rs&quot;
doc = false

[[bin]]
name = &quot;hashmap3&quot;
path = &quot;src/hashmap3.rs&quot;

[[bin]]
name = &quot;btreemap1&quot;
path = &quot;src/btreemap1.rs&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
</code></pre>
<blockquote>
<p>å¦‚æœè¦å•ç‹¬è¿è¡ŒæŒ‡å®šbinæ–‡ä»¶ï¼š</p>
</blockquote>
<pre><code class="language-shell">cargo run --bin hashmap2
</code></pre>
<h3 id="ç›®æ ‡è°ƒè¯•ä»£ç "><a class="header" href="#ç›®æ ‡è°ƒè¯•ä»£ç ">ç›®æ ‡è°ƒè¯•ä»£ç </a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use std::collections::HashMap;

fn main() {
    let map = HashMap::new();
    let mut map = explain(&quot;empty&quot;, map);

    map.insert('a', 1);
    let mut map = explain(&quot;added 1&quot;, map);
    map.insert('b', 2);
    map.insert('c', 3);

    let mut map = explain(&quot;added 3&quot;, map);

    map.insert('d', 4);

    let mut map = explain(&quot;added 4&quot;, map);

    map.remove(&amp;'a');

    explain(&quot;final&quot;, map);
}

// HashMap ç»“æ„æœ‰ä¸¤ä¸ª u64 çš„ RandomStateï¼Œç„¶åæ˜¯å››ä¸ª usizeï¼Œ
// åˆ†åˆ«æ˜¯ bucket_mask, ctrl, growth_left å’Œ items
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain&lt;K, V&gt;(name: &amp;str, map: HashMap&lt;K, V&gt;) -&gt; HashMap&lt;K, V&gt; {
    let arr: [usize; 6] = unsafe { std::mem::transmute(map) };
    println!(
        &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
        name, arr[2], arr[3], arr[4], arr[5]
    );
    unsafe { std::mem::transmute(arr) }
}
</code></pre></pre>
<h3 id="ä½¿ç”¨gdblldbè¿›è¡Œè°ƒè¯•æŸ¥çœ‹å†…å­˜ç»“æ„"><a class="header" href="#ä½¿ç”¨gdblldbè¿›è¡Œè°ƒè¯•æŸ¥çœ‹å†…å­˜ç»“æ„">ä½¿ç”¨gdb/lldbè¿›è¡Œè°ƒè¯•æŸ¥çœ‹å†…å­˜ç»“æ„</a></h3>
<h4 id="gdb-ä¸»è¦æ˜¯linuxç³»ç»Ÿ"><a class="header" href="#gdb-ä¸»è¦æ˜¯linuxç³»ç»Ÿ">gdb: ä¸»è¦æ˜¯linuxç³»ç»Ÿ</a></h4>
<h4 id="lldb-ä¸»è¦osxç³»ç»Ÿ"><a class="header" href="#lldb-ä¸»è¦osxç³»ç»Ÿ">lldb: ä¸»è¦OSXç³»ç»Ÿ</a></h4>
<h4 id="idea"><a class="header" href="#idea">IDEA</a></h4>
<blockquote>
<p>è‡ªå¸¦çš„è°ƒè¯•ç•Œé¢åŒæ—¶åŒ…å«lldbæ›´å¥½çš„ç•Œé¢åŠŸèƒ½ã€‚</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/CleanShot%202022-09-18%20at%2021.24.12%402x.png" alt="CleanShot 2022-09-18 at 21.24.12@2x" /></p>
<h4 id="gdbä¸lldbå‘½ä»¤å¯¹ç…§"><a class="header" href="#gdbä¸lldbå‘½ä»¤å¯¹ç…§">gdbä¸lldbå‘½ä»¤å¯¹ç…§</a></h4>
<ul>
<li><a href="https://lldb.llvm.org/use/map.html">GDB to LLDB command map â€” The LLDB Debugger</a></li>
</ul>
<h4 id="å¼€å§‹è°ƒè¯•"><a class="header" href="#å¼€å§‹è°ƒè¯•">å¼€å§‹è°ƒè¯•</a></h4>
<pre><code class="language-shell">rust-lldb target/debug/hashmap2                                                                                                                  â”€â•¯
(lldb) command script import &quot;/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_lookup.py&quot;
(lldb) command source -s 0 '/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_commands'
Executing commands in '/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_commands'.
(lldb) type synthetic add -l lldb_lookup.synthetic_lookup -x &quot;.*&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)String$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^&amp;(mut )?str$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^&amp;(mut )?\\[.+\\]$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::ffi::([a-z_]+::)+)OsString$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Vec&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)VecDeque&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)BTreeSet&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)BTreeMap&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::collections::([a-z_]+::)+)HashMap&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::collections::([a-z_]+::)+)HashSet&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Rc&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Arc&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)Cell&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)Ref&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)RefMut&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)RefCell&lt;.+&gt;$&quot; --category Rust
(lldb) type category enable Rust
(lldb) target create &quot;target/debug/hashmap2&quot;
Current executable set to '/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/hashmap2' (x86_64).
(lldb)
</code></pre>
<h4 id="breakpoint-æ·»åŠ æ–­ç‚¹"><a class="header" href="#breakpoint-æ·»åŠ æ–­ç‚¹">b(reakpoint): æ·»åŠ æ–­ç‚¹</a></h4>
<blockquote>
<p>åœ¨32è¡Œæ‰“æ–­ç‚¹ï¼Œæ–¹ä¾¿çœ‹std::mem::transmute(arr)</p>
</blockquote>
<pre><code class="language-shell">(lldb) b hashmap2.rs:32
Breakpoint 1: where = hashmap2`hashmap2::explain::h4091c852f38a0de4 + 406 at hashmap2.rs:32:34, address = 0x0000000100008d16
</code></pre>
<h4 id="runè¿è¡Œåˆ°æ–­ç‚¹"><a class="header" href="#runè¿è¡Œåˆ°æ–­ç‚¹">r(un):è¿è¡Œåˆ°æ–­ç‚¹</a></h4>
<pre><code class="language-shell">(lldb) r
Process 69337 launched: '/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/hashmap2' (x86_64)
empty: bucket_mask 0x0, ctrl 0x100043d20, growth_left: 0, items: 0
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;empty&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># æœ€åˆçš„çŠ¶æ€ï¼Œå“ˆå¸Œè¡¨ä¸ºç©º
empty: bucket_mask 0x0, ctrl 0x100043d20, growth_left: 0, items: 0
</code></pre>
<h4 id="continueç»§ç»­å•æ­¥æ‰§è¡Œ"><a class="header" href="#continueç»§ç»­å•æ­¥æ‰§è¡Œ">c(ontinue):ç»§ç»­å•æ­¥æ‰§è¡Œ</a></h4>
<pre><code class="language-shell">(lldb) c
Process 69337 resuming
added 1: bucket_mask 0x3, ctrl 0x600001700160, growth_left: 2, items: 1
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;added 1&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># æ’å…¥äº†ä¸€ä¸ªå…ƒç´ åï¼Œbucket æœ‰ 4 ä¸ªï¼ˆ0x3+1ï¼‰ï¼Œå †åœ°å€èµ·å§‹ä½ç½® 0x600001700160 - 4*8(0x20)
added 1: bucket_mask 0x3, ctrl 0x600001700160, growth_left: 2, items: 1
</code></pre>
<h4 id="x-æ‰“å°å†…å­˜åœ°å€"><a class="header" href="#x-æ‰“å°å†…å­˜åœ°å€">x: æ‰“å°å†…å­˜åœ°å€</a></h4>
<ul>
<li><a href="https://wizardforcel.gitbooks.io/100-gdb-tips/content/examine-memory.html">æ‰“å°å†…å­˜çš„å€¼ | 100ä¸ªgdbå°æŠ€å·§</a></li>
</ul>
<pre><code class="language-shell"># ä»¥12è¿›åˆ¶æ‰“å°ä»å†…å­˜åœ°å€å¼€å§‹çš„å€¼
(lldb) x/12x 0x600001700160
0x600001700160: 0xffff6dff 0xffffffff 0xffffffff 0xffffffff
0x600001700170: 0xffff6dff 0x00000000 0x00000000 0x00000000
0x600001700180: 0x20ec913f 0x00007ff8 0x4e5ef01e 0x00000000
</code></pre>
<h4 id="continue-ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹"><a class="header" href="#continue-ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹">c(ontinue): ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹</a></h4>
<pre><code class="language-shell">(lldb) c
Process 69337 resuming
added 3: bucket_mask 0x3, ctrl 0x600001700160, growth_left: 0, items: 3
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;added 3&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># # æ’å…¥äº†ä¸‰ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ²¡æœ‰å‰©ä½™ç©ºé—´ï¼Œå †åœ°å€èµ·å§‹ä½ç½®ä¸å˜ 0x600001700160 - 4*8(0x20)
added 3: bucket_mask 0x3, ctrl 0x600001700160, growth_left: 0, items: 3
</code></pre>
<pre><code class="language-shell">(lldb) x/12x 0x600001700160
0x600001700160: 0x16ff6d66 0xffffffff 0xffffffff 0xffffffff
0x600001700170: 0x16ff6d66 0x00000000 0x00000000 0x00000000
0x600001700180: 0x20ec913f 0x00007ff8 0x4e5ef01e 0x00000000
</code></pre>
<pre><code class="language-shell">(lldb) c
Process 69337 resuming
added 4: bucket_mask 0x7, ctrl 0x600002604040, growth_left: 3, items: 4
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;added 4&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># æ’å…¥ç¬¬å››ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ‰©å®¹ï¼Œå †åœ°å€èµ·å§‹ä½ç½®å˜ä¸º 0x600002604040 - 8*8(0x40)
added 4: bucket_mask 0x7, ctrl 0x600002604040, growth_left: 3, items: 4
</code></pre>
<pre><code class="language-shell">(lldb) x/12x 0x600002604040
0x600002604040: 0x16446d66 0xffffffff 0xffffffff 0xffffffff
0x600002604050: 0x16446d66 0xffffffff 0x00000000 0x00000000
0x600002604060: 0x00000000 0x00000000 0x00000000 0x00000000
(lldb) x/20x 0x600002604040
0x600002604040: 0x16446d66 0xffffffff 0xffffffff 0xffffffff
0x600002604050: 0x16446d66 0xffffffff 0x00000000 0x00000000
0x600002604060: 0x00000000 0x00000000 0x00000000 0x00000000
0x600002604070: 0x00000000 0x00000000 0x00000000 0x00000000
0x600002604080: 0x00000000 0x00000000 0x00000000 0x00000000
</code></pre>
<pre><code class="language-shell">(lldb) c
Process 69337 resuming
final: bucket_mask 0x7, ctrl 0x600002604040, growth_left: 4, items: 3
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;final&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># åˆ é™¤ a åï¼Œå‰©ä½™ 4 ä¸ªä½ç½®ã€‚æ³¨æ„ ctrl bit çš„å˜åŒ–ï¼Œä»¥åŠ 0x61 0x1 å¹¶æ²¡æœ‰è¢«æ¸…é™¤
final: bucket_mask 0x7, ctrl 0x600002604040, growth_left: 4, items: 3
</code></pre>
<pre><code class="language-shell">(lldb) x/12x 0x600002604040
0x600002604040: 0x1644ff66 0xffffffff 0xffffffff 0xffffffff
0x600002604050: 0x1644ff66 0xffffffff 0x00000000 0x00000000
0x600002604060: 0x00000000 0x00000000 0x00000000 0x00000000
(lldb) x/20x 0x600002604040
0x600002604040: 0x1644ff66 0xffffffff 0xffffffff 0xffffffff
0x600002604050: 0x1644ff66 0xffffffff 0x00000000 0x00000000
0x600002604060: 0x00000000 0x00000000 0x00000000 0x00000000
0x600002604070: 0x00000000 0x00000000 0x00000000 0x00000000
0x600002604080: 0x00000000 0x00000000 0x00000000 0x00000000
</code></pre>
<h2 id="æŸ¥çœ‹é—­åŒ…çš„ç»“æ„"><a class="header" href="#æŸ¥çœ‹é—­åŒ…çš„ç»“æ„">æŸ¥çœ‹é—­åŒ…çš„ç»“æ„</a></h2>
<h3 id="ä»£ç "><a class="header" href="#ä»£ç ">ä»£ç </a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use std::{collections::HashMap, mem::size_of_val};
fn main() {
    // é•¿åº¦ä¸º 0
    let c1 = || println!(&quot;hello world!&quot;);
    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
    let c2 = |i: i32| println!(&quot;hello: {}&quot;, i);
    let name = String::from(&quot;tyr&quot;);
    let name1 = name.clone();
    let mut table = HashMap::new();
    table.insert(&quot;hello&quot;, &quot;world&quot;);
    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
    let c3 = || println!(&quot;hello: {}&quot;, name);
    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
    let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
    let name2 = name.clone();
    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
    let c5 = move || {
        let x = 1;
        let name3 = String::from(&quot;lindsey&quot;);
        println!(&quot;hello: {}, {:?}, {:?}&quot;, x, name2, name3);
    };

    println!(
        &quot;c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}&quot;,
        size_of_val(&amp;c1),
        size_of_val(&amp;c2),
        size_of_val(&amp;c3),
        size_of_val(&amp;c4),
        size_of_val(&amp;c5),
        size_of_val(&amp;main),
    )
}
</code></pre></pre>
<h3 id="è¿è¡Œè¿›å…¥lldb"><a class="header" href="#è¿è¡Œè¿›å…¥lldb">è¿è¡Œè¿›å…¥lldb</a></h3>
<pre><code class="language-shell"># è‡ªåŠ¨å»examplesç›®å½•æ‰¾å¯¹åº”åå­—çš„ä»£ç æ–‡ä»¶
cargo run --example closure_size
</code></pre>
<pre><code class="language-shell">rust-lldb ../target/debug/examples/closure_size                                                                                                  â”€â•¯
(lldb) command script import &quot;/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_lookup.py&quot;
(lldb) command source -s 0 '/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_commands'
Executing commands in '/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_commands'.
(lldb) type synthetic add -l lldb_lookup.synthetic_lookup -x &quot;.*&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)String$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^&amp;(mut )?str$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^&amp;(mut )?\\[.+\\]$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::ffi::([a-z_]+::)+)OsString$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Vec&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)VecDeque&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)BTreeSet&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)BTreeMap&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::collections::([a-z_]+::)+)HashMap&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::collections::([a-z_]+::)+)HashSet&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Rc&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Arc&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)Cell&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)Ref&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)RefMut&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)RefCell&lt;.+&gt;$&quot; --category Rust
(lldb) type category enable Rust
(lldb) target create &quot;../target/debug/examples/closure_size&quot;
Current executable set to '/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/closure_size' (x86_64).
(lldb)
</code></pre>
<pre><code class="language-shell">(lldb) b closure_size.rs:14
Breakpoint 1: where = closure_size`closure_size::main::h679d75437a0cd078 + 199 at closure_size.rs:14:14, address = 0x00000001000056b7
</code></pre>
<pre><code class="language-shell">(lldb) r
Process 95084 launched: '/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/closure_size' (x86_64)
Process 95084 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x00000001000056b7 closure_size`closure_size::main::h679d75437a0cd078 at closure_size.rs:14:14
   11       // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
   12       let c3 = || println!(&quot;hello: {}&quot;, name);
   13       // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
-&gt; 14       let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
   15       let name2 = name.clone();
   16       // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
   17       let c5 = move || {
Target 0: (closure_size) stopped.
</code></pre>
<pre><code class="language-shell">(lldb) frame variable
(closure_size::main::{closure_env#0}) c1 =
(closure_size::main::{closure_env#1}) c2 =
(alloc::string::String) name = &quot;tyr&quot; {
  vec = size=3 {
    [0] = 't'
    [1] = 'y'
    [2] = 'r'
  }
}
(alloc::string::String) name1 = &quot;tyr&quot; {
  vec = size=3 {
    [0] = 't'
    [1] = 'y'
    [2] = 'r'
  }
}
(std::collections::hash::map::HashMap&lt;&amp;str, &amp;str, std::collections::hash::map::RandomState&gt;) table = size=1 {
  [0] = {
    0 = &quot;hello&quot; {
      data_ptr = 0x0000000100043daf &quot;helloworld, c2: , c3: , c4: , c5: \n&quot;
      length = 5
    }
    1 = &quot;world&quot; {
      data_ptr = 0x0000000100043db4 &quot;world, c2: , c3: , c4: , c5: \n&quot;
      length = 5
    }
  }
}
(lldb) fr v
(closure_size::main::{closure_env#0}) c1 =
(closure_size::main::{closure_env#1}) c2 =
(alloc::string::String) name = &quot;tyr&quot; {
  vec = size=3 {
    [0] = 't'
    [1] = 'y'
    [2] = 'r'
  }
}
(alloc::string::String) name1 = &quot;tyr&quot; {
  vec = size=3 {
    [0] = 't'
    [1] = 'y'
    [2] = 'r'
  }
}
(std::collections::hash::map::HashMap&lt;&amp;str, &amp;str, std::collections::hash::map::RandomState&gt;) table = size=1 {
  [0] = {
    0 = &quot;hello&quot; {
      data_ptr = 0x0000000100043daf &quot;helloworld, c2: , c3: , c4: , c5: \n&quot;
      length = 5
    }
    1 = &quot;world&quot; {
      data_ptr = 0x0000000100043db4 &quot;world, c2: , c3: , c4: , c5: \n&quot;
      length = 5
    }
  }
}
</code></pre>
<pre><code class="language-shell">(lldb) x/gx c1
error: memory read failed for 0x0
(lldb) x/gx &amp;c1
0x7ff7bfefed20: 0x0000000100266000
(lldb) x/gx &amp;c2
0x7ff7bfefed28: 0x00006000017041c0
(lldb) x/gx &amp;c3
0x7ff7bfefed90: 0x00007ff7bfefed30
(lldb) x/gx 0x00007ff7bfefed30
0x7ff7bfefed30: 0x0000600000008010
(lldb) x/3c  0x0000600000008010
error: reading memory as characters of size 8 is not supported
(lldb) x/gx  0x0000600000008010
0x600000008010: 0x0000000000727974
</code></pre>
<ul>
<li>gè¡¨ç¤ºå…«å­—èŠ‚ã€‚å½“æˆ‘ä»¬æŒ‡å®šäº†å­—èŠ‚é•¿åº¦åï¼ŒGDBä¼šä»æŒ‡å†…å­˜å®šçš„å†…å­˜åœ°å€å¼€å§‹ï¼Œè¯»å†™æŒ‡å®šå­—èŠ‚ï¼Œå¹¶æŠŠå…¶å½“ä½œä¸€ä¸ªå€¼å–å‡ºæ¥ã€‚</li>
<li>å¯ä»¥çœ‹å‡ºï¼šc1æ˜¯</li>
</ul>
<pre><code class="language-shell">(lldb) n
Process 95084 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = step over
    frame #0: 0x0000000100005744 closure_size`closure_size::main::h679d75437a0cd078 at closure_size.rs:15:17
   12       let c3 = || println!(&quot;hello: {}&quot;, name);
   13       // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
   14       let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
-&gt; 15       let name2 = name.clone();
   16       // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
   17       let c5 = move || {
   18           let x = 1;
Target 0: (closure_size) stopped.
(lldb) x/9gx c4
error: memory read failed for 0x0
(lldb) x/9gx &amp;c4
0x7ff7bfefed98: 0x0000600000008020 0x0000000000000003
0x7ff7bfefeda8: 0x0000000000000003 0x3e49f3270a1a0fb0
0x7ff7bfefedb8: 0x79dd9a78e6c327e7 0x0000000000000003
0x7ff7bfefedc8: 0x0000600003304080 0x0000000000000002
0x7ff7bfefedd8: 0x0000000000000001
(lldb) x/3c 0x0000600000008020
error: reading memory as characters of size 8 is not supported
(lldb) x/gx 0x0000600000008020
0x600000008020: 0x0000000000727974
(lldb) x/18gx 0x0000600000008020 - 0x80
error: memory read takes a start address expression with an optional end address expression.
warning: Expressions should be quoted if they contain spaces or other special characters.
(lldb) x/18gx '0x0000600000008020 - 0x80'
0x600000007fa0: 0x0000000000000000 0x0000000000000000
0x600000007fb0: 0x0000000000000000 0x0000000000000000
0x600000007fc0: 0x0000000000000000 0x0000000000000000
0x600000007fd0: 0x0000000000000000 0x0000000000000000
0x600000007fe0: 0x0000000000000000 0x0000000000000000
0x600000007ff0: 0x0000000000000000 0x0000000000000000
0x600000008000: 0x000000006e69616d 0x0000000000000000
0x600000008010: 0x0000000000727974 0x0000000000000000
0x600000008020: 0x0000000000727974 0x0000000000000000
</code></pre>
<ul>
<li>0x: Cè¯­è¨€é‡Œçš„0x0å’Œ0x1åˆ†åˆ«è¡¨ç¤ºåå…­è¿›åˆ¶çš„æ•°çš„0å’Œ1ã€‚</li>
</ul>
<p>Cè¯­è¨€ã€C++ã€Shellã€Pythonã€Javaè¯­è¨€åŠå…¶ä»–ç›¸è¿‘çš„è¯­è¨€ä½¿ç”¨å­—é¦–â€œ0xâ€ï¼Œä¾‹å¦‚â€œ0x5A3â€ã€‚å¼€å¤´çš„â€œ0â€ä»¤è§£æå™¨æ›´æ˜“è¾¨è®¤æ•°ï¼Œè€Œâ€œxâ€åˆ™ä»£è¡¨åå…­è¿›åˆ¶ï¼ˆå°±å¦‚â€œOâ€ä»£è¡¨å…«è¿›åˆ¶ï¼‰ã€‚åœ¨â€œ0xâ€ä¸­çš„â€œxâ€å¯ä»¥å¤§å†™æˆ–å°å†™ã€‚å¯¹äºå­—ç¬¦é‡Cè¯­è¨€ä¸­åˆ™ä»¥x+ä¸¤ä½åå…­è¿›åˆ¶æ•°çš„æ–¹å¼è¡¨ç¤ºï¼Œå¦‚xFFã€‚</p>
<p>å› æ­¤ï¼Œ0x0ä¸­â€œ0xâ€è¡¨ç¤ºçš„æ˜¯åå…­è¿›åˆ¶æ•°ï¼Œ0æ˜¯åå…­è¿›åˆ¶æ•°å€¼0ï¼Œ0x,1ä¸­â€œ0xâ€è¡¨ç¤ºçš„æ˜¯åå…­è¿›åˆ¶æ•°ï¼Œ1æ˜¯åå…­è¿›åˆ¶æ•°å€¼1</p>
<ul>
<li>Cè¯­è¨€ä¸­çš„ç›¸å…³æ•°å€¼è¡¨ç¤ºæ³•ï¼š</li>
</ul>
<p>1ã€åœ¨Cè¯­è¨€é‡Œï¼Œæ•´æ•°æœ‰ä¸‰ç§è¡¨ç¤ºå½¢å¼ï¼šåè¿›åˆ¶ï¼Œå…«è¿›åˆ¶ï¼Œåå…­è¿›åˆ¶ã€‚å…¶ä¸­ä»¥æ•°å­—0å¼€å¤´ï¼Œç”±0~7ç»„æˆçš„æ•°æ˜¯å…«è¿›åˆ¶ã€‚ä»¥0Xæˆ–0xå¼€å¤´ï¼Œç”±0~9ï¼ŒA~Fæˆ–a~f ç»„æˆæ˜¯åå…­è¿›åˆ¶ã€‚é™¤è¡¨ç¤ºæ­£è´Ÿçš„ç¬¦å·å¤–ï¼Œä»¥1~9å¼€å¤´ï¼Œç”±0~9ç»„æˆæ˜¯åè¿›åˆ¶ã€‚</p>
<p>2ã€åè¿›åˆ¶ï¼šé™¤è¡¨ç¤ºæ­£è´Ÿçš„ç¬¦å·å¤–ï¼Œä»¥1~9å¼€å¤´ï¼Œç”±0~9ç»„æˆã€‚å¦‚ï¼Œ128ï¼Œ+234ï¼Œ-278ã€‚</p>
<p>3ã€å…«è¿›åˆ¶ï¼šä»¥0å¼€å¤´ï¼Œç”±0~7ç»„æˆçš„æ•°ã€‚å¦‚ï¼Œ0126,050000.</p>
<p>4ã€åå…­è¿›åˆ¶ï¼šä»¥0Xæˆ–0xå¼€å¤´ï¼Œç”±0~9ï¼ŒA~Fæˆ–a~f ç»„æˆã€‚å¦‚ï¼Œ0x12A,0x5a000ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="get-hands-dirty"><a class="header" href="#get-hands-dirty">get hands dirty</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="httpieæºç å‰–æ"><a class="header" href="#httpieæºç å‰–æ">httpieæºç å‰–æ</a></h1>
<!--ts-->
<ul>
<li><a href="httpie.html#httpie%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90">httpieæºç å‰–æ</a>
<ul>
<li><a href="httpie.html#example%E7%9A%84%E4%BD%BF%E7%94%A8">exampleçš„ä½¿ç”¨</a>
<ul>
<li><a href="httpie.html#cargotoml">Cargo.toml</a></li>
</ul>
</li>
<li><a href="httpie.html#step1%E6%8C%87%E4%BB%A4%E8%A7%A3%E6%9E%90">Step1ï¼šæŒ‡ä»¤è§£æ</a>
<ul>
<li><a href="httpie.html#clapparser">clap::Parser</a></li>
</ul>
</li>
<li><a href="httpie.html#step2%E6%B7%BB%E5%8A%A0%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81%E4%B8%8E%E9%94%AE%E5%80%BC%E5%AF%B9%E6%94%B9%E9%80%A0">Step2ï¼šæ·»åŠ å‚æ•°éªŒè¯ä¸é”®å€¼å¯¹æ”¹é€ </a>
<ul>
<li><a href="httpie.html#%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81">å‚æ•°éªŒè¯</a></li>
<li><a href="httpie.html#%E9%94%AE%E5%80%BC%E5%AF%B9%E6%94%B9%E9%80%A0">é”®å€¼å¯¹æ”¹é€ </a></li>
</ul>
</li>
<li><a href="httpie.html#step3%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E6%94%B9%E9%80%A0">Step3ï¼šå¼‚æ­¥è¯·æ±‚æ”¹é€ </a></li>
<li><a href="httpie.html#step4-%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE%E6%89%93%E5%8D%B0">Step4: è¯­æ³•é«˜äº®æ‰“å°</a></li>
<li><a href="httpie.html#step5-%E6%B7%BB%E5%8A%A0%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">Step5: æ·»åŠ å•å…ƒæµ‹è¯•</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sat Sep 24 03:25:11 UTC 2022 -->
<!--te-->
<h2 id="exampleçš„ä½¿ç”¨"><a class="header" href="#exampleçš„ä½¿ç”¨">exampleçš„ä½¿ç”¨</a></h2>
<ul>
<li><a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html?highlight=%5B%5Bexample%5D%5D#examples">Cargo Targets &gt;&gt; Examples - The Cargo Book</a></li>
</ul>
<h3 id="cargotoml"><a class="header" href="#cargotoml">Cargo.toml</a></h3>
<pre><code class="language-toml">[package]
name = &quot;httpie&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[[example]]
name = &quot;cli&quot;

[[example]]
name = &quot;cli_verify&quot;

[[example]]
name = &quot;cli_get&quot;

[dependencies]
anyhow = &quot;1&quot; # é”™è¯¯å¤„ç†
clap = { version = &quot;3&quot;, features = [&quot;derive&quot;] } # å‘½ä»¤è¡Œè§£æ
colored = &quot;2&quot; # å‘½ä»¤ç»ˆç«¯å¤šå½©æ˜¾ç¤º
jsonxf = &quot;1.1&quot; # JSON pretty print æ ¼å¼åŒ–
mime = &quot;0.3&quot; # å¤„ç† mime ç±»å‹
# reqwest é»˜è®¤ä½¿ç”¨ opensslï¼Œæœ‰äº› linux ç”¨æˆ·å¦‚æœæ²¡æœ‰å®‰è£…å¥½ openssl ä¼šæ— æ³•ç¼–è¯‘ï¼Œè¿™é‡Œæˆ‘æ”¹æˆäº†ä½¿ç”¨ rustls
reqwest = { version = &quot;0.11&quot;, default-features = false, features = [&quot;json&quot;, &quot;rustls-tls&quot;] } # HTTP å®¢æˆ·ç«¯
tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] } # å¼‚æ­¥å¤„ç†åº“
syntect = &quot;4&quot;
</code></pre>
<pre><code class="language-toml">[[example]]
name = &quot;cli&quot;

[[example]]
name = &quot;cli_verify&quot;

[[example]]
name = &quot;cli_get&quot;
</code></pre>
<div id="admonition-exampleä½¿ç”¨" class="admonition tip">
<div class="admonition-title">
<p>exampleä½¿ç”¨</p>
<p><a class="admonition-anchor-link" href="httpie.html#admonition-exampleä½¿ç”¨"></a></p>
</div>
<div>
<ol>
<li>ç¤ºä¾‹ä»£ç æ”¾åœ¨æ ¹ç›®å½•çš„examplesæ–‡ä»¶å¤¹ï¼Œä¸srcåŒçº§</li>
</ol>
<pre><code class="language-shell">tree -L 2                                                                                                       â”€â•¯
.
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ examples
â”‚Â Â  â”œâ”€â”€ cli.rs
â”‚Â Â  â”œâ”€â”€ cli_get.rs
â”‚Â Â  â””â”€â”€ cli_verify.rs
â””â”€â”€ src
    â””â”€â”€ main.rs

2 directories, 5 files
</code></pre>
<ol start="2">
<li>æ‰§è¡ŒæŒ‡ä»¤</li>
</ol>
<pre><code class="language-shell">cargo run --example &lt;example-name-in-cargo&gt;
cargo run --example cli
cargo run --example cli_get
cargo run --example cli_verify
</code></pre>
<ol start="3">
<li>ä½¿ç”¨ç¤ºä¾‹</li>
</ol>
<pre><code class="language-shell">cargo run --example cli                                                                                                                                                                                                                â”€â•¯
    Finished dev [unoptimized + debuginfo] target(s) in 0.70s
     Running `/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/cli`
httpie 1.0
Tyr Chen &lt;tyr@chen.com&gt;
A naive httpie implementation with Rust, can you imagine how easy it is?

USAGE:
    cli &lt;SUBCOMMAND&gt;

OPTIONS:
    -h, --help       Print help information
    -V, --version    Print version information

SUBCOMMANDS:
    get     feed get with an url and we will retrieve the response for you
    help    Print this message or the help of the given subcommand(s)
    post    feed post with an url and optional key=value pairs. We will post the data as JSON,
                and retrieve the response for you
</code></pre>
<ul>
<li>Run a binary or example of the local package</li>
<li>SUBCOMMANDSæ¥è‡ªä»£ç ä¸­çš„æ³¨é‡Š</li>
</ul>
</div>
</div>
<h2 id="step1æŒ‡ä»¤è§£æ"><a class="header" href="#step1æŒ‡ä»¤è§£æ">Step1ï¼šæŒ‡ä»¤è§£æ</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">use clap::Parser;

// å®šä¹‰ httpie çš„ CLI çš„ä¸»å…¥å£ï¼Œå®ƒåŒ…å«è‹¥å¹²ä¸ªå­å‘½ä»¤
// ä¸‹é¢ /// çš„æ³¨é‡Šæ˜¯æ–‡æ¡£ï¼Œclap ä¼šå°†å…¶ä½œä¸º CLI çš„å¸®åŠ©

/// A naive httpie implementation with Rust, can you imagine how easy it is?
#[derive(Parser, Debug)]
#[clap(version = &quot;1.0&quot;, author = &quot;Tyr Chen &lt;tyr@chen.com&gt;&quot;)]
struct Opts {
    #[clap(subcommand)]
    subcmd: SubCommand,
}

// å­å‘½ä»¤åˆ†åˆ«å¯¹åº”ä¸åŒçš„ HTTP æ–¹æ³•ï¼Œç›®å‰åªæ”¯æŒ get / post
#[derive(Parser, Debug)]
enum SubCommand {
    Get(Get),
    Post(Post),
    // æˆ‘ä»¬æš‚ä¸”ä¸æ”¯æŒå…¶å®ƒ HTTP æ–¹æ³•
}

// get å­å‘½ä»¤

/// feed get with an url and we will retrieve the response for you
#[derive(Parser, Debug)]
struct Get {
    /// HTTP è¯·æ±‚çš„ URL
    url: String,
}

// post å­å‘½ä»¤ã€‚éœ€è¦è¾“å…¥ä¸€ä¸ª urlï¼Œå’Œè‹¥å¹²ä¸ªå¯é€‰çš„ key=valueï¼Œç”¨äºæä¾› json body

/// feed post with an url and optional key=value pairs. We will post the data
/// as JSON, and retrieve the response for you
#[derive(Parser, Debug)]
struct Post {
    /// HTTP è¯·æ±‚çš„ URL
    url: String,
    /// HTTP è¯·æ±‚çš„ body
    body: Vec&lt;String&gt;,
}

fn main() {
    let opts: Opts = Opts::parse();
    let opt_subcmd: SubCommand = opts.subcmd;
    // println!(&quot;{:?}&quot;, opts);
    println!(&quot;{:?}&quot;, opt_subcmd);
    // println!(&quot;{:?}&quot;, opts.subcmd);
    // è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºï¼Œç»“æ„ä½“çš„å†…åœ¨å…ƒç´ ä½¿ç”¨&quot;.&quot;æ¥è·å–
    // println!(&quot;{:?}&quot;, opts::subcmd);
}
</code></pre></pre>
<h3 id="clapparser"><a class="header" href="#clapparser">clap::Parser</a></h3>
<div id="admonition-clapparser" class="admonition info">
<div class="admonition-title">
<p>clap::Parser</p>
<p><a class="admonition-anchor-link" href="httpie.html#admonition-clapparser"></a></p>
</div>
<div>
<ul>
<li><a href="https://github.com/clap-rs/clap">clap-rs/clap: A full featured, fast Command Line Argument Parser for Rust</a></li>
<li><a href="https://docs.rs/clap/latest/clap/">clap - Rust</a></li>
<li><a href="https://docs.rs/clap/latest/clap/parser/index.html">clap::parser - Rust</a></li>
</ul>
</div>
</div>
<ol>
<li>clapçš„parseræ´¾ç”Ÿå®ä¼šè‡ªåŠ¨å®ç°parseæ–¹æ³•æ¥æ¥æ”¶æŒ‡ä»¤å‚æ•°</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">struct Opts {
    #[clap(subcommand)]
    subcmd: SubCommand,
}

// å­å‘½ä»¤åˆ†åˆ«å¯¹åº”ä¸åŒçš„ HTTP æ–¹æ³•ï¼Œç›®å‰åªæ”¯æŒ get / post
#[derive(Parser, Debug)]
</code></pre></pre>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let opts: Opts = Opts::parse();
    let opt_subcmd: SubCommand = opts.subcmd;
    // println!(&quot;{:?}&quot;, opts);
</code></pre></pre>
<ol start="2">
<li>è¿è¡Œæ•ˆæœ</li>
</ol>
<pre><code class="language-shell">cargo run --example cli get http://jsonplaceholder.typicode.com/posts/2                                                                                                                                                                â”€â•¯
   Compiling httpie v0.1.0 (/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/04_httpie)
    Finished dev [unoptimized + debuginfo] target(s) in 2.31s
     Running `/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/cli get 'http://jsonplaceholder.typicode.com/posts/2'`
Opts { subcmd: Get(Get { url: &quot;http://jsonplaceholder.typicode.com/posts/2&quot; }) }
</code></pre>
<pre><code class="language-shell">cargo run --example cli post http://jsonplaceholder.typicode.com/posts/2                                                                                                                                                               â”€â•¯
    Finished dev [unoptimized + debuginfo] target(s) in 0.31s
     Running `/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/cli post 'http://jsonplaceholder.typicode.com/posts/2'`
Opts { subcmd: Post(Post { url: &quot;http://jsonplaceholder.typicode.com/posts/2&quot;, body: [] }) }
</code></pre>
<pre><code class="language-shell">cargo run --example cli delete http://jsonplaceholder.typicode.com/posts/2                                                                                                                                                             â”€â•¯
    Finished dev [unoptimized + debuginfo] target(s) in 0.24s
     Running `/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/cli delete 'http://jsonplaceholder.typicode.com/posts/2'`
error: Found argument 'delete' which wasn't expected, or isn't valid in this context

USAGE:
    cli &lt;SUBCOMMAND&gt;

For more information try --help

</code></pre>
<ul>
<li>optsçš„è·å–ï¼šè‡ªåŠ¨ä»¥ç©ºæ ¼åˆ†éš”ï¼Œæ ¹æ®<subcommand>æ¨¡å¼åŒ¹é…ï¼Œä¹‹åçš„å‚æ•°ä¾æ¬¡èµ‹å€¼ç»™<subcommand> structé‡Œé¢çš„å…ƒç´ </li>
</ul>
<h2 id="step2æ·»åŠ å‚æ•°éªŒè¯ä¸é”®å€¼å¯¹æ”¹é€ "><a class="header" href="#step2æ·»åŠ å‚æ•°éªŒè¯ä¸é”®å€¼å¯¹æ”¹é€ ">Step2ï¼šæ·»åŠ å‚æ•°éªŒè¯ä¸é”®å€¼å¯¹æ”¹é€ </a></h2>
<h3 id="å‚æ•°éªŒè¯"><a class="header" href="#å‚æ•°éªŒè¯">å‚æ•°éªŒè¯</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// feed get with an url and we will retrieve the response for you
#[derive(Parser, Debug)]
struct Get {
    /// HTTP è¯·æ±‚çš„ URL
    #[clap(parse(try_from_str = parse_url))]
    url: String,
}

// post å­å‘½ä»¤ã€‚éœ€è¦è¾“å…¥ä¸€ä¸ª urlï¼Œå’Œè‹¥å¹²ä¸ªå¯é€‰çš„ key=valueï¼Œç”¨äºæä¾› json body

/// feed post with an url and optional key=value pairs. We will post the data
/// as JSON, and retrieve the response for you
#[derive(Parser, Debug)]
struct Post {
    /// HTTP è¯·æ±‚çš„ URL
    #[clap(parse(try_from_str = parse_url))]
    url: String,
    /// HTTP è¯·æ±‚çš„ body
    #[clap(parse(try_from_str=parse_kv_pair))]
    body: Vec&lt;KvPair&gt;,
}
</code></pre></pre>
<ol>
<li>clap å…è®¸ä½ ä¸ºæ¯ä¸ªè§£æå‡ºæ¥çš„å€¼æ·»åŠ è‡ªå®šä¹‰çš„è§£æå‡½æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œå®šä¹‰äº†parse_urlå’Œparse_kv_pairæ£€æŸ¥ä¸€ä¸‹ã€‚</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">/// å› ä¸ºæˆ‘ä»¬ä¸º KvPair å®ç°äº† FromStrï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥ s.parse() å¾—åˆ° KvPair
fn parse_kv_pair(s: &amp;str) -&gt; Result&lt;KvPair&gt; {
    s.parse()
}
fn parse_url(s: &amp;str) -&gt; Result&lt;String&gt; {
    // è¿™é‡Œæˆ‘ä»¬ä»…ä»…æ£€æŸ¥ä¸€ä¸‹ URL æ˜¯å¦åˆæ³•
    let _url: Url = s.parse()?;

    Ok(s.into())
}
</code></pre></pre>
<ol>
<li>clap å…è®¸ä½ ä¸ºæ¯ä¸ªè§£æå‡ºæ¥çš„å€¼æ·»åŠ è‡ªå®šä¹‰çš„è§£æå‡½æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œå®šä¹‰äº†ä¸ªparse_urlæ£€æŸ¥ä¸€ä¸‹ã€‚</li>
</ol>
<h3 id="é”®å€¼å¯¹æ”¹é€ "><a class="header" href="#é”®å€¼å¯¹æ”¹é€ ">é”®å€¼å¯¹æ”¹é€ </a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// å‘½ä»¤è¡Œä¸­çš„ key=value å¯ä»¥é€šè¿‡ parse_kv_pair è§£ææˆ KvPair ç»“æ„
#[allow(dead_code)]
#[derive(Debug)]
struct KvPair {
    k: String,
    v: String,
}

/// å½“æˆ‘ä»¬å®ç° FromStr trait åï¼Œå¯ä»¥ç”¨ str.parse() æ–¹æ³•å°†å­—ç¬¦ä¸²è§£ææˆ KvPair
impl FromStr for KvPair {
    type Err = anyhow::Error;

    fn from_str(s: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {
        // ä½¿ç”¨ = è¿›è¡Œ splitï¼Œè¿™ä¼šå¾—åˆ°ä¸€ä¸ªè¿­ä»£å™¨
        let mut split = s.split('=');
        let err = || anyhow!(format!(&quot;Failed to parse {}&quot;, s));
        Ok(Self {
            // ä»è¿­ä»£å™¨ä¸­å–ç¬¬ä¸€ä¸ªç»“æœä½œä¸º keyï¼Œè¿­ä»£å™¨è¿”å› Some(T)/None
            // æˆ‘ä»¬å°†å…¶è½¬æ¢æˆ Ok(T)/Err(E)ï¼Œç„¶åç”¨ ? å¤„ç†é”™è¯¯
            k: (split.next().ok_or_else(err)?).to_string(),
            // ä»è¿­ä»£å™¨ä¸­å–ç¬¬äºŒä¸ªç»“æœä½œä¸º value
            v: (split.next().ok_or_else(err)?).to_string(),
        })
    }
}
</code></pre></pre>
<h2 id="step3å¼‚æ­¥è¯·æ±‚æ”¹é€ "><a class="header" href="#step3å¼‚æ­¥è¯·æ±‚æ”¹é€ ">Step3ï¼šå¼‚æ­¥è¯·æ±‚æ”¹é€ </a></h2>
<pre><pre class="playground"><code class="language-rust  editable">#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let opts: Opts = Opts::parse();
    // ç”Ÿæˆä¸€ä¸ª
    let client = Client::new();
    match opts.subcmd {
        SubCommand::Get(ref args) =&gt; get(client, args).await?,
        SubCommand::Post(ref args) =&gt; post(client, args).await?,
    };

    Ok(())
}

async fn get(client: Client, args: &amp;Get) -&gt; Result&lt;()&gt; {
    let resp = client.get(&amp;args.url).send().await?;
    println!(&quot;{:?}&quot;, resp.text().await?);
    Ok(())
}

async fn post(client: Client, args: &amp;Post) -&gt; Result&lt;()&gt; {
    let mut body = HashMap::new();
    for pair in args.body.iter() {
        body.insert(&amp;pair.k, &amp;pair.v);
    }
    let resp = client.post(&amp;args.url).json(&amp;body).send().await?;
    println!(&quot;{:?}&quot;, resp.text().await?);
    Ok(())
}
</code></pre></pre>
<h2 id="step4-è¯­æ³•é«˜äº®æ‰“å°"><a class="header" href="#step4-è¯­æ³•é«˜äº®æ‰“å°">Step4: è¯­æ³•é«˜äº®æ‰“å°</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">// æ‰“å°æœåŠ¡å™¨ç‰ˆæœ¬å· + çŠ¶æ€ç 
fn print_status(resp: &amp;Response) {
    let status = format!(&quot;{:?} {}&quot;, resp.version(), resp.status()).blue();
    println!(&quot;{}\n&quot;, status);
}

// æ‰“å°æœåŠ¡å™¨è¿”å›çš„ HTTP header
fn print_headers(resp: &amp;Response) {
    for (name, value) in resp.headers() {
        println!(&quot;{}: {:?}&quot;, name.to_string().green(), value);
    }

    println!();
}

/// æ‰“å°æœåŠ¡å™¨è¿”å›çš„ HTTP body
fn print_body(m: Option&lt;Mime&gt;, body: &amp;str) {
    match m {
        // å¯¹äº &quot;application/json&quot; æˆ‘ä»¬ pretty print
        Some(v) if v == mime::APPLICATION_JSON =&gt; print_syntect(body, &quot;json&quot;),
        Some(v) if v == mime::TEXT_HTML =&gt; print_syntect(body, &quot;html&quot;),

        // å…¶å®ƒ mime typeï¼Œæˆ‘ä»¬å°±ç›´æ¥è¾“å‡º
        _ =&gt; println!(&quot;{}&quot;, body),
    }
}

/// æ‰“å°æ•´ä¸ªå“åº”
async fn print_resp(resp: Response) -&gt; Result&lt;()&gt; {
    print_status(&amp;resp);
    print_headers(&amp;resp);
    let mime = get_content_type(&amp;resp);
    let body = resp.text().await?;
    print_body(mime, &amp;body);
    Ok(())
}

/// å°†æœåŠ¡å™¨è¿”å›çš„ content-type è§£ææˆ Mime ç±»å‹
fn get_content_type(resp: &amp;Response) -&gt; Option&lt;Mime&gt; {
    resp.headers()
        .get(header::CONTENT_TYPE)
        .map(|v| v.to_str().unwrap().parse().unwrap())
}

fn print_syntect(s: &amp;str, ext: &amp;str) {
    // Load these once at the start of your program
    let ps = SyntaxSet::load_defaults_newlines();
    let ts = ThemeSet::load_defaults();
    let syntax = ps.find_syntax_by_extension(ext).unwrap();
    let mut h = HighlightLines::new(syntax, &amp;ts.themes[&quot;base16-ocean.dark&quot;]);
    for line in LinesWithEndings::from(s) {
        let ranges: Vec&lt;(Style, &amp;str)&gt; = h.highlight(line, &amp;ps);
        let escaped = as_24_bit_terminal_escaped(&amp;ranges[..], true);
        print!(&quot;{}&quot;, escaped);
    }
}
</code></pre></pre>
<pre><pre class="playground"><code class="language-rust  editable">/// ç¨‹åºçš„å…¥å£å‡½æ•°ï¼Œå› ä¸ºåœ¨ http è¯·æ±‚æ—¶æˆ‘ä»¬ä½¿ç”¨äº†å¼‚æ­¥å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œå¼•å…¥ tokio
#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let opts: Opts = Opts::parse();
    let mut headers = header::HeaderMap::new();
    // ä¸ºæˆ‘ä»¬çš„ http å®¢æˆ·ç«¯æ·»åŠ ä¸€äº›ç¼ºçœçš„ HTTP å¤´
    headers.insert(&quot;X-POWERED-BY&quot;, &quot;Rust&quot;.parse()?);
    headers.insert(header::USER_AGENT, &quot;Rust Httpie&quot;.parse()?);
    let client = Client::builder()
        .default_headers(headers)
        .build()?;
    let result = match opts.subcmd {
        SubCommand::Get(ref args) =&gt; get(client, args).await?,
        SubCommand::Post(ref args) =&gt; post(client, args).await?,
    };

    Ok(result)
}
</code></pre></pre>
<h2 id="step5-æ·»åŠ å•å…ƒæµ‹è¯•"><a class="header" href="#step5-æ·»åŠ å•å…ƒæµ‹è¯•">Step5: æ·»åŠ å•å…ƒæµ‹è¯•</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">// ä»…åœ¨ cargo test æ—¶æ‰ç¼–è¯‘
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn parse_url_works() {
        assert!(parse_url(&quot;abc&quot;).is_err());
        assert!(parse_url(&quot;http://abc.xyz&quot;).is_ok());
        assert!(parse_url(&quot;https://httpbin.org/post&quot;).is_ok());
    }

    #[test]
    fn parse_kv_pair_works() {
        assert!(parse_kv_pair(&quot;a&quot;).is_err());
        assert_eq!(
            parse_kv_pair(&quot;a=1&quot;).unwrap(),
            KvPair {
                k: &quot;a&quot;.into(),
                v: &quot;1&quot;.into(),
            }
        );

        assert_eq!(
            parse_kv_pair(&quot;b=&quot;).unwrap(),
            KvPair {
                k: &quot;b&quot;.into(),
                v: &quot;&quot;.into(),
            }
        );
    }
}
</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rgrep"><a class="header" href="#rgrep">rgrep</a></h1>
<!--ts-->
<ul>
<li><a href="rgrep.html#rgrep">rgrep</a>
<ul>
<li><a href="rgrep.html#cargotoml">Cargo.toml</a></li>
<li><a href="rgrep.html#srcerrorrs-thiserror%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2">src/error.rs: thiserrorä¼šè‡ªåŠ¨è½¬æ¢</a></li>
<li><a href="rgrep.html#srclibrs%E5%AE%9A%E4%B9%89%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">src/lib.rsï¼šå®šä¹‰ç»“æ„ä½“+å®ç°æ–¹æ³•+å•å…ƒæµ‹è¯•</a>
<ul>
<li><a href="rgrep.html#mod%E5%BC%95%E5%85%A5%E4%B8%8E%E4%BD%BF%E7%94%A8">modå¼•å…¥ä¸ä½¿ç”¨</a></li>
<li><a href="rgrep.html#%E5%AE%9A%E4%B9%89%E7%BB%93%E6%9E%84%E4%BD%93">å®šä¹‰ç»“æ„ä½“</a>
<ul>
<li><a href="rgrep.html#%E4%B8%93%E9%97%A8%E7%AE%80%E5%8C%96%E5%A4%8D%E6%9D%82%E7%B1%BB%E5%9E%8B">ä¸“é—¨ç®€åŒ–å¤æ‚ç±»å‹</a></li>
<li><a href="rgrep.html#%E4%B8%93%E9%97%A8%E7%9A%84%E7%BB%93%E5%90%88%E7%89%88%E6%9C%ACgrep%E7%BB%93%E6%9E%84%E4%BD%93">ä¸“é—¨çš„ç»“åˆç‰ˆæœ¬grepç»“æ„ä½“</a></li>
</ul>
</li>
<li><a href="rgrep.html#%E7%BB%99%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95">ç»™ç»“æ„ä½“å®ç°æ–¹æ³•</a></li>
<li><a href="rgrep.html#%E9%BB%98%E8%AE%A4%E7%AD%96%E7%95%A5-default_strategy">é»˜è®¤ç­–ç•¥: default_strategy</a></li>
<li><a href="rgrep.html#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA">æ ¼å¼åŒ–è¾“å‡º</a></li>
<li><a href="rgrep.html#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">å•å…ƒæµ‹è¯•</a></li>
</ul>
</li>
<li><a href="rgrep.html#srcmainrs">src/main.rs</a>
<ul>
<li><a href="rgrep.html#%E5%BC%95%E5%85%A5librs%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9">å¼•å…¥lib.rsä¸­çš„å†…å®¹</a></li>
<li><a href="rgrep.html#%E4%B8%BB%E5%87%BD%E6%95%B0main">ä¸»å‡½æ•°ï¼šmain()</a></li>
</ul>
</li>
<li><a href="rgrep.html#%E4%BD%BF%E7%94%A8">ä½¿ç”¨</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sat Sep 24 03:25:11 UTC 2022 -->
<!--te-->
<h2 id="cargotoml-1"><a class="header" href="#cargotoml-1">Cargo.toml</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/Cargo.toml}}
</code></pre></pre>
<h2 id="srcerrorrs-thiserrorä¼šè‡ªåŠ¨è½¬æ¢"><a class="header" href="#srcerrorrs-thiserrorä¼šè‡ªåŠ¨è½¬æ¢">src/error.rs: thiserrorä¼šè‡ªåŠ¨è½¬æ¢</a></h2>
<blockquote>
<p>å®ƒä»¬éƒ½æ˜¯éœ€è¦è¿›è¡Œè½¬æ¢çš„é”™è¯¯ã€‚thiserror èƒ½å¤Ÿé€šè¿‡å®å¸®æˆ‘ä»¬å®Œæˆé”™è¯¯ç±»å‹çš„è½¬æ¢ã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/error.rs}}
</code></pre></pre>
<h2 id="srclibrså®šä¹‰ç»“æ„ä½“å®ç°æ–¹æ³•å•å…ƒæµ‹è¯•"><a class="header" href="#srclibrså®šä¹‰ç»“æ„ä½“å®ç°æ–¹æ³•å•å…ƒæµ‹è¯•">src/lib.rsï¼šå®šä¹‰ç»“æ„ä½“+å®ç°æ–¹æ³•+å•å…ƒæµ‹è¯•</a></h2>
<h3 id="modå¼•å…¥ä¸ä½¿ç”¨"><a class="header" href="#modå¼•å…¥ä¸ä½¿ç”¨">modå¼•å…¥ä¸ä½¿ç”¨</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:13:14}}
</code></pre></pre>
<h3 id="å®šä¹‰ç»“æ„ä½“"><a class="header" href="#å®šä¹‰ç»“æ„ä½“">å®šä¹‰ç»“æ„ä½“</a></h3>
<h4 id="ä¸“é—¨ç®€åŒ–å¤æ‚ç±»å‹"><a class="header" href="#ä¸“é—¨ç®€åŒ–å¤æ‚ç±»å‹">ä¸“é—¨ç®€åŒ–å¤æ‚ç±»å‹</a></h4>
<blockquote>
<p>è¿™é‡Œå…¶å®å°±æ˜¯ä¼ å…¥ä¸€ä¸ªæŒ‡å®šç»“æ„çš„å‡½æ•°å¯¹è±¡</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:16:17}}
</code></pre></pre>
<h4 id="ä¸“é—¨çš„ç»“åˆç‰ˆæœ¬grepç»“æ„ä½“"><a class="header" href="#ä¸“é—¨çš„ç»“åˆç‰ˆæœ¬grepç»“æ„ä½“">ä¸“é—¨çš„ç»“åˆç‰ˆæœ¬grepç»“æ„ä½“</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:19:27}}
</code></pre></pre>
<h3 id="ç»™ç»“æ„ä½“å®ç°æ–¹æ³•"><a class="header" href="#ç»™ç»“æ„ä½“å®ç°æ–¹æ³•">ç»™ç»“æ„ä½“å®ç°æ–¹æ³•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:29:55}}
</code></pre></pre>
<blockquote>
<p>ä¸»è¦å®ç°ä¸¤ç§è§£æç­–ç•¥ï¼š</p>
</blockquote>
<ol>
<li>é»˜è®¤ç­–ç•¥ï¼šmatch_with_default_strategy, ä½¿ç”¨default_strategy</li>
<li>æŒ‡å®šç­–ç•¥ï¼šmatch_with, ä½¿ç”¨ä¼ å…¥çš„strategy: StrategyFn</li>
</ol>
<h3 id="é»˜è®¤ç­–ç•¥-default_strategy"><a class="header" href="#é»˜è®¤ç­–ç•¥-default_strategy">é»˜è®¤ç­–ç•¥: default_strategy</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:57:87}}
</code></pre></pre>
<h3 id="æ ¼å¼åŒ–è¾“å‡º"><a class="header" href="#æ ¼å¼åŒ–è¾“å‡º">æ ¼å¼åŒ–è¾“å‡º</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:89:103}}
</code></pre></pre>
<h3 id="å•å…ƒæµ‹è¯•"><a class="header" href="#å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:105:139}}
</code></pre></pre>
<h2 id="srcmainrs"><a class="header" href="#srcmainrs">src/main.rs</a></h2>
<h3 id="å¼•å…¥librsä¸­çš„å†…å®¹"><a class="header" href="#å¼•å…¥librsä¸­çš„å†…å®¹">å¼•å…¥lib.rsä¸­çš„å†…å®¹</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:3:3}}
</code></pre></pre>
<h3 id="ä¸»å‡½æ•°main"><a class="header" href="#ä¸»å‡½æ•°main">ä¸»å‡½æ•°ï¼šmain()</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/22_mid_rgrep/src/lib.rs:5:11}}
</code></pre></pre>
<h2 id="ä½¿ç”¨"><a class="header" href="#ä½¿ç”¨">ä½¿ç”¨</a></h2>
<pre><code class="language-shell">cargo run --quiet -- &quot;Re[^\\s]+&quot; &quot;src/*.rs&quot;                                                                                                                                                                                            â”€â•¯
src/main.rs
     1:13  use anyhow::Result;
     5:14  fn main() -&gt; Result&lt;()&gt; {
src/error.rs
     7:14      #[error(&quot;Regex pattern error&quot;)]
     8:5       RegexPatternError(#[from] regex::Error),
src/lib.rs
     5:12  use regex::Regex;
     8:19      io::{self, BufRead, BufReader, Write},
    17:45  pub type StrategyFn = fn(&amp;Path, &amp;mut dyn BufRead, &amp;Regex, &amp;mut dyn Write) -&gt; Result&lt;(), GrepError&gt;;
    31:50      pub fn match_with_default_strategy(&amp;self) -&gt; Result&lt;(), GrepError&gt; {
    36:55      pub fn match_with(&amp;self, strategy: StrategyFn) -&gt; Result&lt;(), GrepError&gt; {
    37:21          let regex = Regex::new(&amp;self.pattern)?;
    44:41                      let mut reader = BufReader::new(file);
    60:25      reader: &amp;mut dyn BufRead,
    61:15      pattern: &amp;Regex,
    63:6   ) -&gt; Result&lt;(), GrepError&gt; {
   126:29          let mut reader = BufReader::new(&amp;input[..]);
   127:23          let pattern = Regex::new(r&quot;he\w+&quot;).unwrap();
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="thumborå›¾ç‰‡æœåŠ¡"><a class="header" href="#thumborå›¾ç‰‡æœåŠ¡">thumborå›¾ç‰‡æœåŠ¡</a></h1>
<!--ts-->
<!--te-->
<h2 id="abiproto"><a class="header" href="#abiproto">abi.proto</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">syntax = &quot;proto3&quot;;

package abi;

// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
message ImageSpec { repeated Spec specs = 1; }

// å¤„ç†å›¾ç‰‡æ”¹å˜å¤§å°
message Resize {
  uint32 width = 1;
  uint32 height = 2;

  enum ResizeType {
    NORMAL = 0;
    SEAM_CARVE = 1;
  }

  ResizeType rtype = 3;

  enum SampleFilter {
    UNDEFINED = 0;
    NEAREST = 1;
    TRIANGLE = 2;
    CATMULL_ROM = 3;
    GAUSSIAN = 4;
    LANCZOS3 = 5;
  }

  SampleFilter filter = 4;
}

// å¤„ç†å›¾ç‰‡æˆªå–
message Crop {
  uint32 x1 = 1;
  uint32 y1 = 2;
  uint32 x2 = 3;
  uint32 y2 = 4;
}

// å¤„ç†æ°´å¹³ç¿»è½¬
message Fliph {}
// å¤„ç†å‚ç›´ç¿»è½¬
message Flipv {}
// å¤„ç†å¯¹æ¯”åº¦
message Contrast { float contrast = 1; }
// å¤„ç†æ»¤é•œ
message Filter {
  enum Filter {
    UNSPECIFIED = 0;
    OCEANIC = 1;
    ISLANDS = 2;
    MARINE = 3;
    // more: https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html
  }
  Filter filter = 1;
}

// å¤„ç†æ°´å°
message Watermark {
  uint32 x = 1;
  uint32 y = 2;
}

// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
message Spec {
  oneof data {
    Resize resize = 1;
    Crop crop = 2;
    Flipv flipv = 3;
    Fliph fliph = 4;
    Contrast contrast = 5;
    Filter filter = 6;
    Watermark watermark = 7;
  }
}
</code></pre></pre>
<h2 id="buildrs"><a class="header" href="#buildrs">build.rs</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">use std::process::Command;

fn main() {
    // åœ¨ç¼–è¯‘æ—¶å¯é€‰æ‹©æ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚
    let build_enabled = option_env!(&quot;BUILD_PROTO&quot;)
        .map(|v| v == &quot;1&quot;)
        .unwrap_or(false);
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¯å¢ƒå˜é‡çš„å¯¹åº”å€¼ï¼Œå°±ç›´æ¥returnï¼Œä¸å†è¿›è¡Œåç»­ç¼–è¯‘
    if !build_enabled {
        println!(&quot;=== Skipped compiling protos ===&quot;);
        return;
    }
    // ä½¿ç”¨ prost_build æŠŠ abi.proto ç¼–è¯‘åˆ° src/pb ç›®å½•ä¸‹
    prost_build::Config::new()
        .out_dir(&quot;src/pb&quot;)
        .compile_protos(&amp;[&quot;abi.proto&quot;], &amp;[&quot;.&quot;])
        .unwrap();
    Command::new(&quot;cargo&quot;)
        .args(&amp;[&quot;fmt&quot;, &quot;--&quot;, &quot;src/*.rs&quot;])
        .status()
        .expect(&quot;cargo fmt failed&quot;);
}
</code></pre></pre>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.option_env.html">option_env in std - Rust</a></li>
</ul>
<blockquote>
<p>åœ¨ç¼–è¯‘æ—¶å¯é€‰æ‹©æ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚</p>
</blockquote>
<h2 id="å…³äºrustçš„æ¨¡å—"><a class="header" href="#å…³äºrustçš„æ¨¡å—">å…³äºrustçš„æ¨¡å—</a></h2>
<blockquote>
<p>å¯ä»¥å‚è€ƒè¿™ç¯‡ï¼š<a href="https://zhuanlan.zhihu.com/p/443926839">Rust æ¨¡å—ç³»ç»Ÿç†è§£ - çŸ¥ä¹</a></p>
</blockquote>
<div id="admonition-modå…¨è®¤è¯†" class="admonition tip">
<div class="admonition-title">
<p>modå…¨è®¤è¯†</p>
<p><a class="admonition-anchor-link" href="thumbor.html#admonition-modå…¨è®¤è¯†"></a></p>
</div>
<div>
<ol>
<li>mod(mod.rsæˆ–modå…³é”®å­—)å°†ä»£ç åˆ†ä¸ºå¤šä¸ªé€»è¾‘æ¨¡å—ï¼Œå¹¶ç®¡ç†è¿™äº›æ¨¡å—çš„å¯è§æ€§ï¼ˆpublic / privateï¼‰ã€‚</li>
<li>æ¨¡å—æ˜¯é¡¹ï¼ˆitemï¼‰çš„é›†åˆï¼Œé¡¹å¯ä»¥æ˜¯ï¼šå‡½æ•°ï¼Œç»“æ„ä½“ï¼Œtraitï¼Œimplå—ï¼Œç”šè‡³å…¶å®ƒæ¨¡å—ã€‚</li>
<li>ä¸€ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ç ï¼Œå¯ä»¥é€šè¿‡ mod.rs å£°æ˜</li>
<li>Rustæ¨¡å—æœ‰ä¸‰ç§å½¢å¼:
<ul>
<li>mod.rs: ä¸€ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ç ï¼Œå¯ä»¥é€šè¿‡ mod.rs å£°æ˜</li>
<li>æ–‡ä»¶/ç›®å½•å³æ¨¡å—ï¼šç¼–è¯‘å™¨çš„æœºåˆ¶å†³å®šï¼Œé™¤äº†mod.rså¤–ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚ä¸å…è®¸åªåˆ†æ‹†æ–‡ä»¶ï¼Œä½†æ˜¯ä¸å£°æ˜modï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨pub useï¼Œåœ¨çˆ¶ç©ºé—´ç›´æ¥è°ƒç”¨å­ç©ºé—´çš„å‡½æ•°ã€‚</li>
<li>modå…³é”®å­—: åœ¨æ–‡ä»¶å†…éƒ¨åˆ†æ‹†æ¨¡å—</li>
</ul>
</li>
<li>Rustç¼–è¯‘å™¨åªæ¥å—ä¸€ä¸ªæºæ–‡ä»¶ï¼Œè¾“å‡ºä¸€ä¸ªcrate</li>
<li>æ¯ä¸€ä¸ªcrateéƒ½æœ‰ä¸€ä¸ªåŒ¿åçš„æ ¹å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´å¯ä»¥æ— é™åµŒå¥—</li>
<li>â€œmod mod-name { â€¦ }â€œ å°†å¤§æ‹¬å·ä¸­çš„ä»£ç ç½®äºå‘½åç©ºé—´mod-nameä¹‹ä¸‹</li>
<li>â€œuse mod-name1::mod-name2;â€œ å¯ä»¥æ‰“å¼€å‘½åç©ºé—´ï¼Œå‡å°‘æ— ä¼‘æ­¢çš„::æ“ä½œç¬¦</li>
<li>â€œmod mod-name;â€œ å¯ä»¥æŒ‡å¯¼ç¼–è¯‘å™¨å°†å¤šä¸ªæ–‡ä»¶ç»„è£…æˆä¸€ä¸ªæ–‡ä»¶</li>
<li>â€œpub use mod-nam1::mod-name2::item-name;â€œ
è¯­å¥å¯ä»¥å°†mod-name2ä¸‹çš„item-nameæå‡åˆ°è¿™æ¡è¯­å¥æ‰€åœ¨çš„ç©ºé—´ï¼Œitem-nameé€šå¸¸æ˜¯å‡½æ•°æˆ–è€…ç»“æ„ä½“ã€‚Rustç¤¾åŒºé€šå¸¸ç”¨è¿™ä¸ªæ–¹æ³•æ¥ç¼©çŸ­åº“APIçš„å‘½åç©ºé—´æ·±åº¦
ç¼–è¯‘å™¨è§„å®šuseè¯­å¥ä¸€å®šè¦åœ¨modè¯­å¥ä¹‹å‰</li>
</ol>
</div>
</div>
<h2 id="modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»"><a class="header" href="#modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»">modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»</a></h2>
<p>åœ¨rustä¸­ï¼Œä¸€èˆ¬ä¼šåœ¨æ¨¡å—çš„mod.rsæ–‡ä»¶ä¸­å¯¹ä¾›å¤–éƒ¨ä½¿ç”¨çš„é¡¹è¿›è¡Œå®ç°, é¡¹å¯ä»¥æ˜¯ï¼šå‡½æ•°ï¼Œç»“æ„ä½“ï¼Œtraitï¼Œimplå—ï¼Œç”šè‡³å…¶å®ƒæ¨¡å—.
è¿™æ ·æœ‰ä¸ªå¥½å¤„ï¼Œé«˜å†…èšï¼Œå¯ä»¥åœ¨ä»£ç å¢é•¿æ—¶ï¼Œå°†å˜åŠ¨å±€é™åœ¨æœåŠ¡æä¾›è€…å†…éƒ¨ï¼Œå¯¹å¤–æä¾›çš„apiä¸å˜ï¼Œä¸ä¼šé€ æˆç ´åæ€§æ›´æ–°ã€‚</p>
<h2 id="pbæ¨¡å—-å¤„ç†protobuf"><a class="header" href="#pbæ¨¡å—-å¤„ç†protobuf">pbæ¨¡å—: å¤„ç†protobuf</a></h2>
<h3 id="pbmodrså£°æ˜æ¨¡å—"><a class="header" href="#pbmodrså£°æ˜æ¨¡å—">pb/mod.rså£°æ˜æ¨¡å—</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">mod abi; // å£°æ˜ abi.rs
pub use abi::*;
</code></pre></pre>
<h3 id="pbabirsé‡Œé¢è¿˜æœ‰å­æ¨¡å—"><a class="header" href="#pbabirsé‡Œé¢è¿˜æœ‰å­æ¨¡å—">pb/abi.rsé‡Œé¢è¿˜æœ‰å­æ¨¡å—</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Spec`.
pub mod spec {
    #[derive(Clone, PartialEq, ::prost::Oneof)]
    pub enum Data {
        #[prost(message, tag = &quot;1&quot;)]
        Resize(super::Resize),
        #[prost(message, tag = &quot;2&quot;)]
        Crop(super::Crop),
        #[prost(message, tag = &quot;3&quot;)]
        Flipv(super::Flipv),
        #[prost(message, tag = &quot;4&quot;)]
        Fliph(super::Fliph),
        #[prost(message, tag = &quot;5&quot;)]
        Contrast(super::Contrast),
        #[prost(message, tag = &quot;6&quot;)]
        Filter(super::Filter),
        #[prost(message, tag = &quot;7&quot;)]
        Watermark(super::Watermark),
    }
}
</code></pre></pre>
<h3 id="pbabirså¦å¤–å®šä¹‰äº†specdataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“åµŒå¥—æ¨¡å—mod"><a class="header" href="#pbabirså¦å¤–å®šä¹‰äº†specdataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“åµŒå¥—æ¨¡å—mod">pb/abi.rså¦å¤–å®šä¹‰äº†spec::Dataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“/åµŒå¥—æ¨¡å—mod</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct ImageSpec {
    #[prost(message, repeated, tag = &quot;1&quot;)]
    pub specs: ::prost::alloc::vec::Vec&lt;Spec&gt;,
}
/// å¤„ç†å›¾ç‰‡æ”¹å˜å¤§å°
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Resize {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub width: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub height: u32,
    #[prost(enumeration = &quot;resize::ResizeType&quot;, tag = &quot;3&quot;)]
    pub rtype: i32,
    #[prost(enumeration = &quot;resize::SampleFilter&quot;, tag = &quot;4&quot;)]
    pub filter: i32,
}
/// Nested message and enum types in `Resize`.
pub mod resize {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum ResizeType {
        Normal = 0,
        SeamCarve = 1,
    }
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum SampleFilter {
        Undefined = 0,
        Nearest = 1,
        Triangle = 2,
        CatmullRom = 3,
        Gaussian = 4,
        Lanczos3 = 5,
    }
}
/// å¤„ç†å›¾ç‰‡æˆªå–
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Crop {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub x1: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub y1: u32,
    #[prost(uint32, tag = &quot;3&quot;)]
    pub x2: u32,
    #[prost(uint32, tag = &quot;4&quot;)]
    pub y2: u32,
}
/// å¤„ç†æ°´å¹³ç¿»è½¬
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Fliph {}
/// å¤„ç†å‚ç›´ç¿»è½¬
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Flipv {}
/// å¤„ç†å¯¹æ¯”åº¦
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Contrast {
    #[prost(float, tag = &quot;1&quot;)]
    pub contrast: f32,
}
/// å¤„ç†æ»¤é•œ
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Filter {
    #[prost(enumeration = &quot;filter::Filter&quot;, tag = &quot;1&quot;)]
    pub filter: i32,
}
/// Nested message and enum types in `Filter`.
pub mod filter {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum Filter {
        Unspecified = 0,
        Oceanic = 1,
        Islands = 2,
        /// more: &lt;https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html&gt;
        Marine = 3,
    }
}
/// å¤„ç†æ°´å°
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Watermark {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub x: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub y: u32,
}
</code></pre></pre>
<h3 id="pbabirsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“"><a class="header" href="#pbabirsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“">pb/abi.rsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Spec {
    #[prost(oneof = &quot;spec::Data&quot;, tags = &quot;1, 2, 3, 4, 5, 6, 7&quot;)]
    pub data: ::core::option::Option&lt;spec::Data&gt;,
}
</code></pre></pre>
<h3 id="imagespec"><a class="header" href="#imagespec">ImageSpec</a></h3>
<h4 id="å®šä¹‰æœ‰åºæ•°ç»„"><a class="header" href="#å®šä¹‰æœ‰åºæ•°ç»„">å®šä¹‰ï¼šæœ‰åºæ•°ç»„</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct ImageSpec {
    #[prost(message, repeated, tag = &quot;1&quot;)]
    pub specs: ::prost::alloc::vec::Vec&lt;Spec&gt;,
}
</code></pre></pre>
<h4 id="å®ç°newæ–¹æ³•fromtryfromå®ç°ç±»å‹è½¬åŒ–"><a class="header" href="#å®ç°newæ–¹æ³•fromtryfromå®ç°ç±»å‹è½¬åŒ–">å®ç°ï¼šnewæ–¹æ³•ã€From&amp;TryFromå®ç°ç±»å‹è½¬åŒ–</a></h4>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">impl ImageSpec {
    pub fn new(specs: Vec&lt;Spec&gt;) -&gt; Self {
        Self { specs }
    }
}

// è®© ImageSpec å¯ä»¥ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²
impl From&lt;&amp;ImageSpec&gt; for String {
    fn from(image_spec: &amp;ImageSpec) -&gt; Self {
        let data = image_spec.encode_to_vec();
        encode_config(data, URL_SAFE_NO_PAD)
    }
}

// è®© ImageSpec å¯ä»¥é€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²åˆ›å»ºã€‚æ¯”å¦‚ s.parse().unwrap()
impl TryFrom&lt;&amp;str&gt; for ImageSpec {
    type Error = anyhow::Error;

    fn try_from(value: &amp;str) -&gt; Result&lt;Self, Self::Error&gt; {
        let data = decode_config(value, URL_SAFE_NO_PAD)?;
        Ok(ImageSpec::decode(&amp;data[..])?)
    }
}
</code></pre></pre>
<h3 id="filter"><a class="header" href="#filter">Filter</a></h3>
<h4 id="å®šä¹‰æšä¸¾ä½“mod"><a class="header" href="#å®šä¹‰æšä¸¾ä½“mod">å®šä¹‰ï¼šæšä¸¾ä½“mod</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Filter`.
pub mod filter {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum Filter {
        Unspecified = 0,
        Oceanic = 1,
        Islands = 2,
        /// more: &lt;https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html&gt;
        Marine = 3,
    }
}
</code></pre></pre>
<h4 id="å®ç°åŒå¼•å·çš„ä½¿ç”¨æ¨¡å¼åŒ¹é…"><a class="header" href="#å®ç°åŒå¼•å·çš„ä½¿ç”¨æ¨¡å¼åŒ¹é…">å®ç°ï¼šåŒå¼•å·çš„ä½¿ç”¨ã€æ¨¡å¼åŒ¹é…</a></h4>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">// è¾…åŠ©å‡½æ•°ï¼Œphoton_rs ç›¸åº”çš„æ–¹æ³•é‡Œéœ€è¦å­—ç¬¦ä¸²
impl filter::Filter {
    pub fn to_str(self) -&gt; Option&lt;&amp;'static str&gt; {
        match self {
            filter::Filter::Unspecified =&gt; None,
            filter::Filter::Oceanic =&gt; Some(&quot;oceanic&quot;),
            filter::Filter::Islands =&gt; Some(&quot;islands&quot;),
            filter::Filter::Marine =&gt; Some(&quot;marine&quot;),
        }
    }
}
</code></pre></pre>
<h3 id="samplefilter"><a class="header" href="#samplefilter">SampleFilter</a></h3>
<h4 id="å®šä¹‰æšä¸¾ä½“mod-1"><a class="header" href="#å®šä¹‰æšä¸¾ä½“mod-1">å®šä¹‰ï¼šæšä¸¾ä½“mod</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Resize`.
pub mod resize {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum ResizeType {
        Normal = 0,
        SeamCarve = 1,
    }
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum SampleFilter {
        Undefined = 0,
        Nearest = 1,
        Triangle = 2,
        CatmullRom = 3,
        Gaussian = 4,
        Lanczos3 = 5,
    }
}
</code></pre></pre>
<h3 id="å®ç°modä½¿ç”¨åŒå¼•å·fromè½¬ä¸ºä¸åŒç»“æœ"><a class="header" href="#å®ç°modä½¿ç”¨åŒå¼•å·fromè½¬ä¸ºä¸åŒç»“æœ">å®ç°ï¼šmodä½¿ç”¨åŒå¼•å·ã€Fromè½¬ä¸ºä¸åŒç»“æœ</a></h3>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">impl From&lt;resize::SampleFilter&gt; for SamplingFilter {
    fn from(v: resize::SampleFilter) -&gt; Self {
        match v {
            resize::SampleFilter::Undefined =&gt; SamplingFilter::Nearest,
            resize::SampleFilter::Nearest =&gt; SamplingFilter::Nearest,
            resize::SampleFilter::Triangle =&gt; SamplingFilter::Triangle,
            resize::SampleFilter::CatmullRom =&gt; SamplingFilter::CatmullRom,
            resize::SampleFilter::Gaussian =&gt; SamplingFilter::Gaussian,
            resize::SampleFilter::Lanczos3 =&gt; SamplingFilter::Lanczos3,
        }
    }
}
</code></pre></pre>
<h3 id="spec"><a class="header" href="#spec">Spec</a></h3>
<h4 id="å®šä¹‰ç»“æ„ä½“-1"><a class="header" href="#å®šä¹‰ç»“æ„ä½“-1">å®šä¹‰ï¼šç»“æ„ä½“</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Spec {
    #[prost(oneof = &quot;spec::Data&quot;, tags = &quot;1, 2, 3, 4, 5, 6, 7&quot;)]
    pub data: ::core::option::Option&lt;spec::Data&gt;,
}
</code></pre></pre>
<h4 id="å®ç°ç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•self"><a class="header" href="#å®ç°ç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•self">å®ç°ï¼šç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•Self</a></h4>
<blockquote>
<p>æ³¨æ„åŒºåˆ«Selfå’Œselfçš„ä½¿ç”¨ï¼š
<a href="https://stackoverflow.com/questions/32304595/whats-the-difference-between-self-and-self">rust - Whatâ€™s the difference between self and Self? - Stack Overflow</a></p>
</blockquote>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">// æä¾›ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œè®©åˆ›å»ºä¸€ä¸ª spec çš„è¿‡ç¨‹ç®€å•ä¸€äº›
impl Spec {
    pub fn new_resize_seam_carve(width: u32, height: u32) -&gt; Self {
        Self {
            data: Some(spec::Data::Resize(Resize {
                width,
                height,
                rtype: resize::ResizeType::SeamCarve as i32,
                filter: resize::SampleFilter::Undefined as i32,
            })),
        }
    }

    pub fn new_resize(width: u32, height: u32, filter: resize::SampleFilter) -&gt; Self {
        Self {
            data: Some(spec::Data::Resize(Resize {
                width,
                height,
                rtype: resize::ResizeType::Normal as i32,
                filter: filter as i32,
            })),
        }
    }

    pub fn new_filter(filter: filter::Filter) -&gt; Self {
        Self {
            data: Some(spec::Data::Filter(Filter {
                filter: filter as i32,
            })),
        }
    }

    pub fn new_watermark(x: u32, y: u32) -&gt; Self {
        Self {
            data: Some(spec::Data::Watermark(Watermark { x, y })),
        }
    }
}
</code></pre></pre>
<h3 id="å•å…ƒæµ‹è¯•-1"><a class="header" href="#å•å…ƒæµ‹è¯•-1">å•å…ƒæµ‹è¯•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#[cfg(test)]
mod tests {
    use super::*;
    use std::borrow::Borrow;

    #[test]
    fn encoded_spec_could_be_decoded() {
        let spec1 = Spec::new_resize(600, 600, resize::SampleFilter::CatmullRom);
        let spec2 = Spec::new_filter(filter::Filter::Marine);
        let image_spec = ImageSpec::new(vec![spec1, spec2]);
        let s: String = image_spec.borrow().into();
        assert_eq!(image_spec, s.as_str().try_into().unwrap());
    }
}
</code></pre></pre>
<h2 id="engineæ¨¡å—-å¤„ç†å›¾ç‰‡"><a class="header" href="#engineæ¨¡å—-å¤„ç†å›¾ç‰‡">engineæ¨¡å—: å¤„ç†å›¾ç‰‡</a></h2>
<h3 id="modrs-å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait"><a class="header" href="#modrs-å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait">mod.rs: å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// Engine traitï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šçš„ engineï¼Œä¸»æµç¨‹åªéœ€è¦æ›¿æ¢ engine
pub trait Engine {
    // å¯¹ engine æŒ‰ç…§ specs è¿›è¡Œä¸€ç³»åˆ—æœ‰åºçš„å¤„ç†
    fn apply(&amp;mut self, specs: &amp;[Spec]);
    // ä» engine ä¸­ç”Ÿæˆç›®æ ‡å›¾ç‰‡ï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ selfï¼Œè€Œé self çš„å¼•ç”¨
    fn generate(self, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt;;
}

// SpecTransformï¼šæœªæ¥å¦‚æœæ·»åŠ æ›´å¤šçš„ specï¼Œåªéœ€è¦å®ç°å®ƒå³å¯
pub trait SpecTransform&lt;T&gt; {
    // å¯¹å›¾ç‰‡ä½¿ç”¨ op åš transform
    fn transform(&amp;mut self, op: T);
}
</code></pre></pre>
<h3 id="photonrs--é™æ€å˜é‡åŠ è½½"><a class="header" href="#photonrs--é™æ€å˜é‡åŠ è½½">photon.rs &gt; é™æ€å˜é‡åŠ è½½</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">lazy_static! {
    // é¢„å…ˆæŠŠæ°´å°æ–‡ä»¶åŠ è½½ä¸ºé™æ€å˜é‡
    static ref WATERMARK: PhotonImage = {
        let data = include_bytes!(&quot;../../rust-logo.png&quot;);
        let watermark = open_image_from_bytes(data).unwrap();
        transform::resize(&amp;watermark, 64, 64, transform::SamplingFilter::Nearest)
    };
}
</code></pre></pre>
<h3 id="photonrs--å…·ä½“å¼•æ“photonçš„å®šä¹‰ä¸è½¬åŒ–tryfrom"><a class="header" href="#photonrs--å…·ä½“å¼•æ“photonçš„å®šä¹‰ä¸è½¬åŒ–tryfrom">photon.rs &gt; å…·ä½“å¼•æ“Photonçš„å®šä¹‰ä¸è½¬åŒ–TryFrom</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">pub struct Photon(PhotonImage);

// ä» Bytes è½¬æ¢æˆ Photon ç»“æ„
impl TryFrom&lt;Bytes&gt; for Photon {
    type Error = anyhow::Error;

    fn try_from(data: Bytes) -&gt; Result&lt;Self, Self::Error&gt; {
        Ok(Self(open_image_from_bytes(&amp;data)?))
    }
}
</code></pre></pre>
<h3 id="photonrs--å…·ä½“å¼•æ“photonçš„traitå®ç°"><a class="header" href="#photonrs--å…·ä½“å¼•æ“photonçš„traitå®ç°">photon.rs &gt; å…·ä½“å¼•æ“Photonçš„traitå®ç°</a></h3>
<h4 id="engine-trait"><a class="header" href="#engine-trait">Engine Trait</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">impl Engine for Photon {
    fn apply(&amp;mut self, specs: &amp;[Spec]) {
        for spec in specs.iter() {
            match spec.data {
                Some(spec::Data::Crop(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Contrast(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Filter(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Fliph(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Flipv(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Resize(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Watermark(ref v)) =&gt; self.transform(v),
                // å¯¹äºç›®å‰ä¸è®¤è¯†çš„ specï¼Œä¸åšä»»ä½•å¤„ç†
                _ =&gt; {}
            }
        }
    }
</code></pre></pre>
<h4 id="spectransform-trait"><a class="header" href="#spectransform-trait">SpecTransform Trait</a></h4>
<h5 id="æ ¼å¼è¯­ä¹‰åŒ–"><a class="header" href="#æ ¼å¼è¯­ä¹‰åŒ–">æ ¼å¼è¯­ä¹‰åŒ–</a></h5>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl SpecTransform(&amp;OpreationName) for SpecificEngine {
    fn transform(&amp;mut self, _op: &amp;OperationName) {
        transform::OperationMethod(&amp;mut self.0)
    }
}
<span class="boring">}
</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust  editable">impl SpecTransform&lt;&amp;Crop&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Crop) {
        let img = transform::crop(&amp;mut self.0, op.x1, op.y1, op.x2, op.y2);
        self.0 = img;
    }
}

impl SpecTransform&lt;&amp;Contrast&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Contrast) {
        effects::adjust_contrast(&amp;mut self.0, op.contrast);
    }
}

impl SpecTransform&lt;&amp;Flipv&gt; for Photon {
    fn transform(&amp;mut self, _op: &amp;Flipv) {
        transform::flipv(&amp;mut self.0)
    }
}

impl SpecTransform&lt;&amp;Fliph&gt; for Photon {
    fn transform(&amp;mut self, _op: &amp;Fliph) {
        transform::fliph(&amp;mut self.0)
    }
}

impl SpecTransform&lt;&amp;Filter&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Filter) {
        match filter::Filter::from_i32(op.filter) {
            Some(filter::Filter::Unspecified) =&gt; {}
            Some(f) =&gt; filters::filter(&amp;mut self.0, f.to_str().unwrap()),
            _ =&gt; {}
        }
    }
}

impl SpecTransform&lt;&amp;Resize&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Resize) {
        let img = match resize::ResizeType::from_i32(op.rtype).unwrap() {
            resize::ResizeType::Normal =&gt; transform::resize(
                &amp;self.0,
                op.width,
                op.height,
                resize::SampleFilter::from_i32(op.filter).unwrap().into(),
            ),
            resize::ResizeType::SeamCarve =&gt; transform::seam_carve(&amp;self.0, op.width, op.height),
        };
        self.0 = img;
    }
}

impl SpecTransform&lt;&amp;Watermark&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Watermark) {
        multiple::watermark(&amp;mut self.0, &amp;WATERMARK, op.x, op.y);
    }
}
</code></pre></pre>
<h3 id="photonrs--åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•"><a class="header" href="#photonrs--åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•">photon.rs &gt; åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">fn image_to_buf(img: PhotonImage, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt; {
    let raw_pixels = img.get_raw_pixels();
    let width = img.get_width();
    let height = img.get_height();

    let img_buffer = ImageBuffer::from_vec(width, height, raw_pixels).unwrap();
    let dynimage = DynamicImage::ImageRgba8(img_buffer);

    let mut buffer = Vec::with_capacity(32768);
    dynimage.write_to(&amp;mut buffer, format).unwrap();
    buffer
}
</code></pre></pre>
<h2 id="mainrs"><a class="header" href="#mainrs">main.rs</a></h2>
<h3 id="å…ˆå¼•å…¥modå†use"><a class="header" href="#å…ˆå¼•å…¥modå†use">å…ˆå¼•å…¥modï¼Œå†use</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// å‚æ•°ä½¿ç”¨ serde åš Deserializeï¼Œaxum ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶è§£æ
#[derive(Deserialize)]
struct Params {
    spec: String,
    url: String,
}
</code></pre></pre>
<h3 id="å›¾ç‰‡èµ„æºç”¨åˆ°lruç­–ç•¥ç¼“å­˜typeå®šä¹‰"><a class="header" href="#å›¾ç‰‡èµ„æºç”¨åˆ°lruç­–ç•¥ç¼“å­˜typeå®šä¹‰">å›¾ç‰‡èµ„æºç”¨åˆ°Lruç­–ç•¥ç¼“å­˜typeå®šä¹‰</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">type Cache = Arc&lt;Mutex&lt;LruCache&lt;u64, Bytes&gt;&gt;&gt;;
</code></pre></pre>
<h3 id="ä¸»æµç¨‹mainå‡½æ•°"><a class="header" href="#ä¸»æµç¨‹mainå‡½æ•°">ä¸»æµç¨‹mainå‡½æ•°</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#[tokio::main]
async fn main() {
    // åˆå§‹åŒ– tracing
    tracing_subscriber::fmt::init();
    let cache: Cache = Arc::new(Mutex::new(LruCache::new(1024)));
    // æ„å»ºè·¯ç”±
    let app = Router::new()
        // `GET /` ä¼šæ‰§è¡Œ
        .route(&quot;/image/:spec/:url&quot;, get(generate))
        .layer(
            ServiceBuilder::new()
                .load_shed()
                .concurrency_limit(1024)
                .timeout(Duration::from_secs(10))
                .layer(TraceLayer::new_for_http())
                .layer(AddExtensionLayer::new(cache))
                .layer(CompressionLayer::new())
                .into_inner(),
        );

    // è¿è¡Œ web æœåŠ¡å™¨
    let addr = &quot;127.0.0.1:3000&quot;.parse().unwrap();
    print_test_url(&quot;https://images.pexels.com/photos/1562477/pexels-photo-1562477.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=3&amp;h=750&amp;w=1260&quot;);
    info!(&quot;Listening on {}&quot;, addr);
    axum::Server::bind(&amp;addr)
        .serve(app.into_make_service())
        .await
        .unwrap();
}
</code></pre></pre>
<h4 id="å»ºé€ è€…æ¨¡å¼"><a class="header" href="#å»ºé€ è€…æ¨¡å¼">å»ºé€ è€…æ¨¡å¼</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">            ServiceBuilder::new()
                .load_shed()
                .concurrency_limit(1024)
                .timeout(Duration::from_secs(10))
                .layer(TraceLayer::new_for_http())
                .layer(AddExtensionLayer::new(cache))
                .layer(CompressionLayer::new())
                .into_inner(),
</code></pre></pre>
<h4 id="ç±»å‹è½¬æ¢"><a class="header" href="#ç±»å‹è½¬æ¢">ç±»å‹è½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">    // è¿è¡Œ web æœåŠ¡å™¨
    let addr = &quot;127.0.0.1:3000&quot;.parse().unwrap();
</code></pre></pre>
<h5 id="æ•°å­—ä¸å­—ç¬¦ä¸²"><a class="header" href="#æ•°å­—ä¸å­—ç¬¦ä¸²">æ•°å­—ä¸å­—ç¬¦ä¸²</a></h5>
<p>||i32|u32|f64|String*|
|--|---|---|---|-------|
|i32|\|x as u32|x as f64|x.to_string()|
|u32|x as i32|\|x as f64|x.to_string()|
|f64|x as i32|x as u32|\|x.to_string()|
|String*|x.parse().unwrap()|x.parse().unwrap()|x.parse().unwrap()|\|</p>
<h5 id="string-ä¸--str"><a class="header" href="#string-ä¸--str">String ä¸ &amp; str</a></h5>
<p>|\|String|&amp;str|
|-|------|----|
|String|\|&amp;*x|
|&amp;str|x.to_string()|\|</p>
<h5 id="æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ</a></h5>
<p>|\|Vec&lt;T&gt;|&amp;[T]|Box&lt;[T]&gt;|
|-|------|----|--------|
|Vec&lt;T&gt;|\|&amp;x[â€¦]|x.into_boxed_slice()|
|&amp;[T]|x.to_vec()|\|Box::new(*x)|
|Box&lt;[T]&gt;|x.to_vec()|&amp;*x|\|</p>
<h3 id="è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler"><a class="header" href="#è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler">è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// basic handler that responds with a static string
async fn generate(
    Path(Params { spec, url }): Path&lt;Params&gt;,
    Extension(cache): Extension&lt;Cache&gt;,
) -&gt; Result&lt;(HeaderMap, Vec&lt;u8&gt;), StatusCode&gt; {
    let spec: ImageSpec = spec
        .as_str()
        .try_into()
        .map_err(|_| StatusCode::BAD_REQUEST)?;

    let url: &amp;str = &amp;percent_decode_str(&amp;url).decode_utf8_lossy();
    let data = retrieve_image(url, cache)
        .await
        .map_err(|_| StatusCode::BAD_REQUEST)?;

    // ä½¿ç”¨ image engine å¤„ç†
    let mut engine: Photon = data
        .try_into()
        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
    engine.apply(&amp;spec.specs);
    // TODO: è¿™é‡Œç›®å‰ç±»å‹å†™æ­»äº†ï¼Œåº”è¯¥ä½¿ç”¨ content negotiation
    let image = engine.generate(ImageOutputFormat::Jpeg(85));

    info!(&quot;Finished processing: image size {}&quot;, image.len());
    let mut headers = HeaderMap::new();

    headers.insert(&quot;content-type&quot;, HeaderValue::from_static(&quot;image/jpeg&quot;));
    Ok((headers, image))
}
</code></pre></pre>
<h3 id="å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•"><a class="header" href="#å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•">å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•</a></h3>
<blockquote>
<p>å¯¹äºå›¾ç‰‡çš„ç½‘ç»œè¯·æ±‚ï¼Œæˆ‘ä»¬å…ˆæŠŠ URL åšä¸ªå“ˆå¸Œï¼Œåœ¨ LRU ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°æ‰ç”¨ reqwest å‘é€è¯·æ±‚ã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">#[instrument(level = &quot;info&quot;, skip(cache))]
async fn retrieve_image(url: &amp;str, cache: Cache) -&gt; Result&lt;Bytes&gt; {
    let mut hasher = DefaultHasher::new();
    url.hash(&amp;mut hasher);
    let key = hasher.finish();

    let g = &amp;mut cache.lock().await;
    let data = match g.get(&amp;key) {
        Some(v) =&gt; {
            info!(&quot;Match cache {}&quot;, key);
            v.to_owned()
        }
        None =&gt; {
            info!(&quot;Retrieve url&quot;);
            let resp = reqwest::get(url).await?;
            let data = resp.bytes().await?;
            g.put(key, data.clone());
            data
        }
    };

    Ok(data)
}
</code></pre></pre>
<h3 id="ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°"><a class="header" href="#ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°">ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// è°ƒè¯•è¾…åŠ©å‡½æ•°
fn print_test_url(url: &amp;str) {
    use std::borrow::Borrow;
    let spec1 = Spec::new_resize(500, 800, resize::SampleFilter::CatmullRom);
    let spec2 = Spec::new_watermark(20, 20);
    let spec3 = Spec::new_filter(filter::Filter::Marine);
    let image_spec = ImageSpec::new(vec![spec1, spec2, spec3]);
    let s: String = image_spec.borrow().into();
    let test_image = percent_encode(url.as_bytes(), NON_ALPHANUMERIC).to_string();
    println!(&quot;test url: http://localhost:3000/image/{}/{}&quot;, s, test_image);
}
</code></pre></pre>
<h2 id="è¿è¡Œä¸æ—¥å¿—"><a class="header" href="#è¿è¡Œä¸æ—¥å¿—">è¿è¡Œä¸æ—¥å¿—</a></h2>
<blockquote>
<p>å°†RUST_LOGçº§åˆ«è®¾ç½®ä¸ºinfo</p>
</blockquote>
<pre><code class="language-shell">cargo build --release
RUST_LOG=info target/release/thumbor
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sqlæŸ¥è¯¢å·¥å…·"><a class="header" href="#sqlæŸ¥è¯¢å·¥å…·">SQLæŸ¥è¯¢å·¥å…·</a></h1>
<!--ts-->
<ul>
<li><a href="queryer.html#sql%E6%9F%A5%E8%AF%A2%E5%B7%A5%E5%85%B7">SQLæŸ¥è¯¢å·¥å…·</a>
<ul>
<li><a href="queryer.html#workspace-%E8%BF%99%E9%87%8C%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F%E6%B8%85%E5%8D%95virtual-manifest%E6%96%B9%E5%BC%8F">workspace: è¿™é‡Œä½¿ç”¨è™šæ‹Ÿæ¸…å•(virtual manifest)æ–¹å¼</a>
<ul>
<li><a href="queryer.html#workspace%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F">workspaceä½¿ç”¨æ–¹å¼</a></li>
</ul>
</li>
<li><a href="queryer.html#queryer-package">queryer package</a>
<ul>
<li><a href="queryer.html#cargotoml">cargo.toml</a></li>
<li><a href="queryer.html#%E4%B8%A4%E4%B8%AA%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">ä¸¤ä¸ªä½¿ç”¨ç¤ºä¾‹</a>
<ul>
<li><a href="queryer.html#dialectrssql%E8%A7%A3%E6%9E%90">dialect.rs:SQLè§£æ</a></li>
<li><a href="queryer.html#covidrs-ast%E8%BD%AC%E6%8D%A2">covid.rs: ASTè½¬æ¢</a></li>
</ul>
</li>
<li><a href="queryer.html#srcconvertrs">src/convert.rs</a>
<ul>
<li><a href="queryer.html#%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89sql%E4%B8%8E%E5%AF%B9%E5%BA%94%E9%83%A8%E5%88%86%E7%BB%93%E6%9E%84%E4%BD%93-%E6%B3%A8%E6%84%8F%E9%99%90%E4%BA%8E%E5%AD%A4%E5%84%BF%E5%8E%9F%E5%88%99%E7%9A%84%E5%86%8D%E5%8C%85%E8%A3%85">ç»“æ„ä½“å®šä¹‰:sqlä¸å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“, æ³¨æ„é™äºå­¤å„¿åŸåˆ™çš„å†åŒ…è£…</a></li>
<li><a href="queryer.html#sql%E7%9A%84%E8%BD%AC%E6%8D%A2">sqlçš„è½¬æ¢</a></li>
<li><a href="queryer.html#%E5%AF%B9%E5%BA%94%E9%83%A8%E5%88%86%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E8%BD%AC%E6%8D%A2">å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“çš„è½¬æ¢</a></li>
<li><a href="queryer.html#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">å•å…ƒæµ‹è¯•</a></li>
</ul>
</li>
<li><a href="queryer.html#srcdialectrs">src/dialect.rs</a>
<ul>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89%E6%96%B9%E8%A8%80%E7%BB%93%E6%9E%84%E4%BD%93">å®šä¹‰æ–¹è¨€ç»“æ„ä½“</a></li>
<li><a href="queryer.html#%E7%BB%99%E6%96%B9%E8%A8%80%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9E%E7%8E%B0trait">ç»™æ–¹è¨€ç»“æ„ä½“å®ç°trait</a></li>
<li><a href="queryer.html#%E6%B7%BB%E5%8A%A0%E6%B5%8B%E8%AF%95%E7%94%A8%E5%87%BD%E6%95%B0">æ·»åŠ æµ‹è¯•ç”¨å‡½æ•°</a></li>
<li><a href="queryer.html#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95-1">å•å…ƒæµ‹è¯•</a></li>
</ul>
</li>
<li><a href="queryer.html#srcloaderrs">src/loader.rs</a>
<ul>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89loader%E4%B8%8Ecsvloader">å®šä¹‰Loaderä¸CsvLoader</a></li>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89trait%E5%B9%B6%E7%BB%99csvloader%E5%AE%9E%E7%8E%B0">å®šä¹‰traitå¹¶ç»™CsvLoaderå®ç°</a></li>
<li><a href="queryer.html#todo-%E7%BB%99csvloader%E6%B7%BB%E5%8A%A0%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B">todo: ç»™CsvLoaderæ·»åŠ å†…å®¹æ£€æµ‹</a></li>
</ul>
</li>
<li><a href="queryer.html#srcfetcherrs">src/fetcher.rs</a>
<ul>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89urlfetcher%E4%B8%8Efilefetcher">å®šä¹‰UrlFetcherä¸FileFetcher</a></li>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89trait%E5%B9%B6%E7%BB%99fetcher%E4%B8%8Efilefetcher%E5%AE%9E%E7%8E%B0">å®šä¹‰traitå¹¶ç»™Fetcherä¸FileFetcherå®ç°</a></li>
<li><a href="queryer.html#%E6%9C%80%E5%90%8E%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E7%9A%84%E6%96%B9%E6%B3%95">æœ€åå®šä¹‰ä¸€ä¸ªè·å–æ•°æ®çš„æ–¹æ³•</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="queryer.html#queryer-js-package-%E4%BD%BF%E7%94%A8neon">queryer-js package: ä½¿ç”¨neon</a>
<ul>
<li><a href="queryer.html#cargotoml-1">Cargo.toml</a></li>
<li><a href="queryer.html#build-in-packagejson">build in package.json</a></li>
<li><a href="queryer.html#srclibrs">src/lib.rs</a></li>
</ul>
</li>
<li><a href="queryer.html#queryer-py-package-%E4%BD%BF%E7%94%A8pyo3">queryer-py package: ä½¿ç”¨pyo3</a>
<ul>
<li><a href="queryer.html#cargotoml-2">Cargo.toml</a></li>
<li><a href="queryer.html#buildrs">build.rs</a></li>
<li><a href="queryer.html#srclibrs-1">src/lib.rs</a></li>
</ul>
</li>
<li><a href="queryer.html#data-viewer-package-%E4%BD%BF%E7%94%A8tauri">data-viewer package: ä½¿ç”¨tauri</a>
<ul>
<li><a href="queryer.html#cargotoml-3">Cargo.toml</a></li>
<li><a href="queryer.html#buildrs-1">build.rs</a></li>
<li><a href="queryer.html#mainrs">main.rs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sat Sep 24 03:25:11 UTC 2022 -->
<!--te-->
<h2 id="workspace-è¿™é‡Œä½¿ç”¨è™šæ‹Ÿæ¸…å•virtual-manifestæ–¹å¼"><a class="header" href="#workspace-è¿™é‡Œä½¿ç”¨è™šæ‹Ÿæ¸…å•virtual-manifestæ–¹å¼">workspace: è¿™é‡Œä½¿ç”¨è™šæ‹Ÿæ¸…å•(virtual manifest)æ–¹å¼</a></h2>
<blockquote>
<p><a href="https://course.rs/cargo/reference/workspaces.html">å·¥ä½œç©ºé—´ Workspace - Rustè¯­è¨€åœ£ç»(Rust Course)</a></p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">[workspace]

members = [
  &quot;queryer&quot;,
  &quot;queryer-js&quot;,
  &quot;queryer-py&quot;,
  &quot;data-viewer/src-tauri&quot;
]
</code></pre></pre>
<div id="admonition-è™šæ‹Ÿæ¸…å•" class="admonition info">
<div class="admonition-title">
<p>è™šæ‹Ÿæ¸…å•</p>
<p><a class="admonition-anchor-link" href="queryer.html#admonition-è™šæ‹Ÿæ¸…å•"></a></p>
</div>
<div>
<p>è‹¥ä¸€ä¸ª Cargo.toml æœ‰ [workspace] ä½†æ˜¯æ²¡æœ‰ [package] éƒ¨åˆ†ï¼Œåˆ™å®ƒæ˜¯è™šæ‹Ÿæ¸…å•ç±»å‹çš„å·¥ä½œç©ºé—´ã€‚</p>
<p>å¯¹äºæ²¡æœ‰ä¸» package çš„åœºæ™¯æˆ–ä½ å¸Œæœ›å°†æ‰€æœ‰çš„ package ç»„ç»‡åœ¨å•ç‹¬çš„ç›®å½•ä¸­æ—¶ï¼Œè¿™ç§æ–¹å¼å°±éå¸¸é€‚åˆã€‚</p>
</div>
</div>
<div id="admonition-workspaceå…³é”®ç‚¹" class="admonition tip">
<div class="admonition-title">
<p>workspaceå…³é”®ç‚¹</p>
<p><a class="admonition-anchor-link" href="queryer.html#admonition-workspaceå…³é”®ç‚¹"></a></p>
</div>
<div>
<ul>
<li>æ‰€æœ‰çš„ package å…±äº«åŒä¸€ä¸ª Cargo.lock æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä½äºå·¥ä½œç©ºé—´çš„æ ¹ç›®å½•ä¸­</li>
<li>æ‰€æœ‰çš„ package å…±äº«åŒä¸€ä¸ªè¾“å‡ºç›®å½•ï¼Œè¯¥ç›®å½•é»˜è®¤çš„åç§°æ˜¯ target ï¼Œä½äºå·¥ä½œç©ºé—´æ ¹ç›®å½•ä¸‹</li>
<li>åªæœ‰å·¥ä½œç©ºé—´æ ¹ç›®å½•çš„ Cargo.toml æ‰èƒ½åŒ…å« [patch], [replace] å’Œ [profile.*]ï¼Œè€Œæˆå‘˜çš„ Cargo.toml ä¸­çš„ç›¸åº”éƒ¨åˆ†å°†è¢«è‡ªåŠ¨å¿½ç•¥</li>
</ul>
</div>
</div>
<h3 id="workspaceä½¿ç”¨æ–¹å¼"><a class="header" href="#workspaceä½¿ç”¨æ–¹å¼">workspaceä½¿ç”¨æ–¹å¼</a></h3>
<pre><code class="language-shell">cargo run -p &lt;member package&gt;
cargo build -p queryer
</code></pre>
<div id="admonition-ä½¿ç”¨è¯´æ˜" class="admonition info">
<div class="admonition-title">
<p>ä½¿ç”¨è¯´æ˜</p>
<p><a class="admonition-anchor-link" href="queryer.html#admonition-ä½¿ç”¨è¯´æ˜"></a></p>
</div>
<div>
<ol>
<li>
<p>åœ¨å·¥ä½œç©ºé—´ä¸­ï¼Œpackage ç›¸å…³çš„ Cargo å‘½ä»¤(ä¾‹å¦‚ cargo build )å¯ä»¥ä½¿ç”¨ -p ã€ â€“package æˆ– â€“workspace å‘½ä»¤è¡Œå‚æ•°æ¥æŒ‡å®šæƒ³è¦æ“ä½œçš„ packageã€‚</p>
</li>
<li>
<p>è‹¥æ²¡æœ‰æŒ‡å®šä»»ä½•å‚æ•°ï¼Œåˆ™ Cargo å°†ä½¿ç”¨å½“å‰å·¥ä½œç›®å½•çš„ä¸­çš„ package ã€‚è‹¥å·¥ä½œç›®å½•æ˜¯è™šæ‹Ÿæ¸…å•ç±»å‹çš„å·¥ä½œç©ºé—´ï¼Œåˆ™è¯¥å‘½ä»¤å°†ä½œç”¨åœ¨æ‰€æœ‰æˆå‘˜ä¸Š(å°±å¥½åƒæ˜¯ä½¿ç”¨äº† â€“workspace å‘½ä»¤è¡Œå‚æ•°)ã€‚è€Œ default-members å¯ä»¥åœ¨å‘½ä»¤è¡Œå‚æ•°æ²¡æœ‰è¢«æä¾›æ—¶ï¼Œæ‰‹åŠ¨æŒ‡å®šæ“ä½œçš„æˆå‘˜</p>
</li>
</ol>
</div>
</div>
<h2 id="queryer-package"><a class="header" href="#queryer-package">queryer package</a></h2>
<h3 id="cargotoml-2"><a class="header" href="#cargotoml-2">cargo.toml</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/06_queryer/queryer/cargo.toml}}
</code></pre></pre>
<h3 id="ä¸¤ä¸ªä½¿ç”¨ç¤ºä¾‹"><a class="header" href="#ä¸¤ä¸ªä½¿ç”¨ç¤ºä¾‹">ä¸¤ä¸ªä½¿ç”¨ç¤ºä¾‹</a></h3>
<h4 id="dialectrssqlè§£æ"><a class="header" href="#dialectrssqlè§£æ">dialect.rs:SQLè§£æ</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">use sqlparser::{dialect::GenericDialect, parser::Parser};

fn main() {
    tracing_subscriber::fmt::init();

    let sql = &quot;SELECT a a1, b, 123, myfunc(b), * \
    FROM data_source \
    WHERE a &gt; b AND b &lt; 100 AND c BETWEEN 10 AND 20 \
    ORDER BY a DESC, b \
    LIMIT 50 OFFSET 10&quot;;

    let ast = Parser::parse_sql(&amp;GenericDialect::default(), sql);
    println!(&quot;{:#?}&quot;, ast);
}
</code></pre></pre>
<h4 id="covidrs-astè½¬æ¢"><a class="header" href="#covidrs-astè½¬æ¢">covid.rs: ASTè½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">use anyhow::Result;
use queryer::query;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();

    let url = &quot;https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/latest/owid-covid-latest.csv&quot;;

    // ä½¿ç”¨ sql ä» URL é‡Œè·å–æ•°æ®
    let sql = format!(
        &quot;SELECT location name, total_cases, new_cases, total_deaths, new_deaths \
        FROM {} where new_deaths &gt;= 500 ORDER BY new_cases DESC&quot;,
        url
    );
    let df1 = query(sql).await?;
    println!(&quot;{:?}&quot;, df1);

    Ok(())
}
</code></pre></pre>
<h3 id="srcconvertrs"><a class="header" href="#srcconvertrs">src/convert.rs</a></h3>
<h4 id="ç»“æ„ä½“å®šä¹‰sqlä¸å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“-æ³¨æ„é™äºå­¤å„¿åŸåˆ™çš„å†åŒ…è£…"><a class="header" href="#ç»“æ„ä½“å®šä¹‰sqlä¸å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“-æ³¨æ„é™äºå­¤å„¿åŸåˆ™çš„å†åŒ…è£…">ç»“æ„ä½“å®šä¹‰:sqlä¸å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“, æ³¨æ„é™äºå­¤å„¿åŸåˆ™çš„å†åŒ…è£…</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// è§£æå‡ºæ¥çš„ SQL
pub struct Sql&lt;'a&gt; {
    pub(crate) selection: Vec&lt;Expr&gt;,
    pub(crate) condition: Option&lt;Expr&gt;,
    pub(crate) source: &amp;'a str,
    pub(crate) order_by: Vec&lt;(String, bool)&gt;,
    pub(crate) offset: Option&lt;i64&gt;,
    pub(crate) limit: Option&lt;usize&gt;,
}

// å› ä¸º Rust trait çš„å­¤å„¿è§„åˆ™ï¼Œæˆ‘ä»¬å¦‚æœè¦æƒ³å¯¹å·²æœ‰çš„ç±»å‹å®ç°å·²æœ‰çš„ traitï¼Œ
// éœ€è¦ç®€å•åŒ…è£…ä¸€ä¸‹

pub struct Expression(pub(crate) Box&lt;SqlExpr&gt;);
pub struct Operation(pub(crate) SqlBinaryOperator);
pub struct Projection&lt;'a&gt;(pub(crate) &amp;'a SelectItem);
pub struct Source&lt;'a&gt;(pub(crate) &amp;'a [TableWithJoins]);
pub struct Order&lt;'a&gt;(pub(crate) &amp;'a OrderByExpr);
pub struct Offset&lt;'a&gt;(pub(crate) &amp;'a SqlOffset);
pub struct Limit&lt;'a&gt;(pub(crate) &amp;'a SqlExpr);
pub struct Value(pub(crate) SqlValue);
</code></pre></pre>
<h4 id="sqlçš„è½¬æ¢"><a class="header" href="#sqlçš„è½¬æ¢">sqlçš„è½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// æŠŠ SqlParser è§£æå‡ºæ¥çš„ Statement è½¬æ¢æˆæˆ‘ä»¬éœ€è¦çš„ç»“æ„
impl&lt;'a&gt; TryFrom&lt;&amp;'a Statement&gt; for Sql&lt;'a&gt; {
    type Error = anyhow::Error;

    fn try_from(sql: &amp;'a Statement) -&gt; Result&lt;Self, Self::Error&gt; {
        match sql {
            // ç›®å‰æˆ‘ä»¬åªå…³å¿ƒ query (select ... from ... where ...)
            Statement::Query(q) =&gt; {
                let offset = q.offset.as_ref();
                let limit = q.limit.as_ref();
                let orders = &amp;q.order_by;
                let Select {
                    from: table_with_joins,
                    selection: where_clause,
                    projection,

                    group_by: _,
                    ..
                } = match &amp;q.body {
                    SetExpr::Select(statement) =&gt; statement.as_ref(),
                    _ =&gt; return Err(anyhow!(&quot;We only support Select Query at the moment&quot;)),
                };

                let source = Source(table_with_joins).try_into()?;

                let condition = match where_clause {
                    Some(expr) =&gt; Some(Expression(Box::new(expr.to_owned())).try_into()?),
                    None =&gt; None,
                };

                let mut selection = Vec::with_capacity(8);
                for p in projection {
                    let expr = Projection(p).try_into()?;
                    selection.push(expr);
                }

                let mut order_by = Vec::new();
                for expr in orders {
                    order_by.push(Order(expr).try_into()?);
                }

                let offset = offset.map(|v| Offset(v).into());
                let limit = limit.map(|v| Limit(v).into());

                Ok(Sql {
                    selection,
                    condition,
                    source,
                    order_by,
                    offset,
                    limit,
                })
            }
            _ =&gt; Err(anyhow!(&quot;We only support Query at the moment&quot;)),
        }
    }
}
</code></pre></pre>
<h4 id="å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“çš„è½¬æ¢"><a class="header" href="#å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“çš„è½¬æ¢">å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“çš„è½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// æŠŠ SqlParser çš„ Expr è½¬æ¢æˆ DataFrame çš„ Expr
impl TryFrom&lt;Expression&gt; for Expr {
    type Error = anyhow::Error;

    fn try_from(expr: Expression) -&gt; Result&lt;Self, Self::Error&gt; {
        match *expr.0 {
            SqlExpr::BinaryOp { left, op, right } =&gt; Ok(Expr::BinaryExpr {
                left: Box::new(Expression(left).try_into()?),
                op: Operation(op).try_into()?,
                right: Box::new(Expression(right).try_into()?),
            }),
            SqlExpr::Wildcard =&gt; Ok(Self::Wildcard),
            SqlExpr::IsNull(expr) =&gt; Ok(Self::IsNull(Box::new(Expression(expr).try_into()?))),
            SqlExpr::IsNotNull(expr) =&gt; Ok(Self::IsNotNull(Box::new(Expression(expr).try_into()?))),
            SqlExpr::Identifier(id) =&gt; Ok(Self::Column(Arc::new(id.value))),
            SqlExpr::Value(v) =&gt; Ok(Self::Literal(Value(v).try_into()?)),
            v =&gt; Err(anyhow!(&quot;expr {:#?} is not supported&quot;, v)),
        }
    }
}

/// æŠŠ SqlParser çš„ BinaryOperator è½¬æ¢æˆ DataFrame çš„ Operator
impl TryFrom&lt;Operation&gt; for Operator {
    type Error = anyhow::Error;

    fn try_from(op: Operation) -&gt; Result&lt;Self, Self::Error&gt; {
        match op.0 {
            SqlBinaryOperator::Plus =&gt; Ok(Self::Plus),
            SqlBinaryOperator::Minus =&gt; Ok(Self::Minus),
            SqlBinaryOperator::Multiply =&gt; Ok(Self::Multiply),
            SqlBinaryOperator::Divide =&gt; Ok(Self::Divide),
            SqlBinaryOperator::Modulo =&gt; Ok(Self::Modulus),
            SqlBinaryOperator::Gt =&gt; Ok(Self::Gt),
            SqlBinaryOperator::Lt =&gt; Ok(Self::Lt),
            SqlBinaryOperator::GtEq =&gt; Ok(Self::GtEq),
            SqlBinaryOperator::LtEq =&gt; Ok(Self::LtEq),
            SqlBinaryOperator::Eq =&gt; Ok(Self::Eq),
            SqlBinaryOperator::NotEq =&gt; Ok(Self::NotEq),
            SqlBinaryOperator::And =&gt; Ok(Self::And),
            SqlBinaryOperator::Or =&gt; Ok(Self::Or),
            v =&gt; Err(anyhow!(&quot;Operator {} is not supported&quot;, v)),
        }
    }
}

/// æŠŠ SqlParser çš„ SelectItem è½¬æ¢æˆ DataFrame çš„ Expr
impl&lt;'a&gt; TryFrom&lt;Projection&lt;'a&gt;&gt; for Expr {
    type Error = anyhow::Error;

    fn try_from(p: Projection&lt;'a&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        match p.0 {
            SelectItem::UnnamedExpr(SqlExpr::Identifier(id)) =&gt; Ok(col(&amp;id.to_string())),
            SelectItem::ExprWithAlias {
                expr: SqlExpr::Identifier(id),
                alias,
            } =&gt; Ok(Expr::Alias(
                Box::new(Expr::Column(Arc::new(id.to_string()))),
                Arc::new(alias.to_string()),
            )),
            SelectItem::QualifiedWildcard(v) =&gt; Ok(col(&amp;v.to_string())),
            SelectItem::Wildcard =&gt; Ok(col(&quot;*&quot;)),
            item =&gt; Err(anyhow!(&quot;projection {} not supported&quot;, item)),
        }
    }
}

impl&lt;'a&gt; TryFrom&lt;Source&lt;'a&gt;&gt; for &amp;'a str {
    type Error = anyhow::Error;

    fn try_from(source: Source&lt;'a&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        if source.0.len() != 1 {
            return Err(anyhow!(&quot;We only support single data source at the moment&quot;));
        }

        let table = &amp;source.0[0];
        if !table.joins.is_empty() {
            return Err(anyhow!(&quot;We do not support joint data source at the moment&quot;));
        }

        match &amp;table.relation {
            TableFactor::Table { name, .. } =&gt; Ok(&amp;name.0.first().unwrap().value),
            _ =&gt; Err(anyhow!(&quot;We only support table&quot;)),
        }
    }
}

/// æŠŠ SqlParser çš„ order by expr è½¬æ¢æˆ (åˆ—å, æ’åºæ–¹æ³•)
impl&lt;'a&gt; TryFrom&lt;Order&lt;'a&gt;&gt; for (String, bool) {
    type Error = anyhow::Error;

    fn try_from(o: Order) -&gt; Result&lt;Self, Self::Error&gt; {
        let name = match &amp;o.0.expr {
            SqlExpr::Identifier(id) =&gt; id.to_string(),
            expr =&gt; {
                return Err(anyhow!(
                    &quot;We only support identifier for order by, got {}&quot;,
                    expr
                ))
            }
        };

        Ok((name, !o.0.asc.unwrap_or(true)))
    }
}

/// æŠŠ SqlParser çš„ offset expr è½¬æ¢æˆ i64
impl&lt;'a&gt; From&lt;Offset&lt;'a&gt;&gt; for i64 {
    fn from(offset: Offset) -&gt; Self {
        match offset.0 {
            SqlOffset {
                value: SqlExpr::Value(SqlValue::Number(v, _b)),
                ..
            } =&gt; v.parse().unwrap_or(0),
            _ =&gt; 0,
        }
    }
}

/// æŠŠ SqlParser çš„ Limit expr è½¬æ¢æˆ usize
impl&lt;'a&gt; From&lt;Limit&lt;'a&gt;&gt; for usize {
    fn from(l: Limit&lt;'a&gt;) -&gt; Self {
        match l.0 {
            SqlExpr::Value(SqlValue::Number(v, _b)) =&gt; v.parse().unwrap_or(usize::MAX),
            _ =&gt; usize::MAX,
        }
    }
}

/// æŠŠ SqlParser çš„ value è½¬æ¢æˆ DataFrame æ”¯æŒçš„ LiteralValue
impl TryFrom&lt;Value&gt; for LiteralValue {
    type Error = anyhow::Error;
    fn try_from(v: Value) -&gt; Result&lt;Self, Self::Error&gt; {
        match v.0 {
            SqlValue::Number(v, _) =&gt; Ok(LiteralValue::Float64(v.parse().unwrap())),
            SqlValue::Boolean(v) =&gt; Ok(LiteralValue::Boolean(v)),
            SqlValue::Null =&gt; Ok(LiteralValue::Null),
            v =&gt; Err(anyhow!(&quot;Value {} is not supported&quot;, v)),
        }
    }
}
</code></pre></pre>
<h4 id="å•å…ƒæµ‹è¯•-2"><a class="header" href="#å•å…ƒæµ‹è¯•-2">å•å…ƒæµ‹è¯•</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[cfg(test)]
mod tests {
    use super::*;
    use crate::TyrDialect;
    use sqlparser::parser::Parser;

    #[test]
    fn parse_sql_works() {
        let url = &quot;http://abc.xyz/abc?a=1&amp;b=2&quot;;
        let sql = format!(
            &quot;select a, b, c from {} where a=1 order by c desc limit 5 offset 10&quot;,
            url
        );
        let statement = &amp;Parser::parse_sql(&amp;TyrDialect::default(), sql.as_ref()).unwrap()[0];
        let sql: Sql = statement.try_into().unwrap();
        assert_eq!(sql.source, url);
        assert_eq!(sql.limit, Some(5));
        assert_eq!(sql.offset, Some(10));
        assert_eq!(sql.order_by, vec![(&quot;c&quot;.into(), true)]);
        assert_eq!(sql.selection, vec![col(&quot;a&quot;), col(&quot;b&quot;), col(&quot;c&quot;)]);
    }
}
</code></pre></pre>
<h3 id="srcdialectrs"><a class="header" href="#srcdialectrs">src/dialect.rs</a></h3>
<h4 id="å®šä¹‰æ–¹è¨€ç»“æ„ä½“"><a class="header" href="#å®šä¹‰æ–¹è¨€ç»“æ„ä½“">å®šä¹‰æ–¹è¨€ç»“æ„ä½“</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[derive(Debug, Default)]
pub struct TyrDialect;
</code></pre></pre>
<h4 id="ç»™æ–¹è¨€ç»“æ„ä½“å®ç°trait"><a class="header" href="#ç»™æ–¹è¨€ç»“æ„ä½“å®ç°trait">ç»™æ–¹è¨€ç»“æ„ä½“å®ç°trait</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">// åˆ›å»ºè‡ªå·±çš„ sql æ–¹è¨€ã€‚TyrDialect æ”¯æŒ identifier å¯ä»¥æ˜¯ç®€å•çš„ url
impl Dialect for TyrDialect {
    fn is_identifier_start(&amp;self, ch: char) -&gt; bool {
        ('a'..='z').contains(&amp;ch) || ('A'..='Z').contains(&amp;ch) || ch == '_'
    }

    // identifier å¯ä»¥æœ‰ ':', '/', '?', '&amp;', '='
    fn is_identifier_part(&amp;self, ch: char) -&gt; bool {
        ('a'..='z').contains(&amp;ch)
            || ('A'..='Z').contains(&amp;ch)
            || ('0'..='9').contains(&amp;ch)
            || [':', '/', '?', '&amp;', '=', '-', '_', '.'].contains(&amp;ch)
    }
}
</code></pre></pre>
<h4 id="æ·»åŠ æµ‹è¯•ç”¨å‡½æ•°"><a class="header" href="#æ·»åŠ æµ‹è¯•ç”¨å‡½æ•°">æ·»åŠ æµ‹è¯•ç”¨å‡½æ•°</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// æµ‹è¯•è¾…åŠ©å‡½æ•°
pub fn example_sql() -&gt; String {
    let url = &quot;https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/latest/owid-covid-latest.csv&quot;;

    let sql = format!(
        &quot;SELECT location name, total_cases, new_cases, total_deaths, new_deaths \
        FROM {} where new_deaths &gt;= 500 ORDER BY new_cases DESC LIMIT 6 OFFSET 5&quot;,
        url
    );

    sql
}
</code></pre></pre>
<h4 id="å•å…ƒæµ‹è¯•-3"><a class="header" href="#å•å…ƒæµ‹è¯•-3">å•å…ƒæµ‹è¯•</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[cfg(test)]
mod tests {
    use super::*;
    use sqlparser::parser::Parser;

    #[test]
    fn it_works() {
        assert!(Parser::parse_sql(&amp;TyrDialect::default(), &amp;example_sql()).is_ok());
    }
}
</code></pre></pre>
<h3 id="srcloaderrs"><a class="header" href="#srcloaderrs">src/loader.rs</a></h3>
<h4 id="å®šä¹‰loaderä¸csvloader"><a class="header" href="#å®šä¹‰loaderä¸csvloader">å®šä¹‰Loaderä¸CsvLoader</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[derive(Debug)]
#[non_exhaustive]
pub enum Loader {
    Csv(CsvLoader),
}

#[derive(Default, Debug)]
pub struct CsvLoader(pub(crate) String);
</code></pre></pre>
<h4 id="å®šä¹‰traitå¹¶ç»™csvloaderå®ç°"><a class="header" href="#å®šä¹‰traitå¹¶ç»™csvloaderå®ç°">å®šä¹‰traitå¹¶ç»™CsvLoaderå®ç°</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">
    let sql = format!(
        &quot;SELECT location name, total_cases, new_cases, total_deaths, new_deaths \
        FROM {} where new_deaths &gt;= 500 ORDER BY new_cases DESC LIMIT 6 OFFSET 5&quot;,
        url
    );

    sql
}

#[cfg(test)]
mod tests {
    use super::*;
    use sqlparser::parser::Parser;

</code></pre></pre>
<h4 id="todo-ç»™csvloaderæ·»åŠ å†…å®¹æ£€æµ‹"><a class="header" href="#todo-ç»™csvloaderæ·»åŠ å†…å®¹æ£€æµ‹">todo: ç»™CsvLoaderæ·»åŠ å†…å®¹æ£€æµ‹</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">    fn it_works() {
        assert!(Parser::parse_sql(&amp;TyrDialect::default(), &amp;example_sql()).is_ok());
    }
}
</code></pre></pre>
<h3 id="srcfetcherrs"><a class="header" href="#srcfetcherrs">src/fetcher.rs</a></h3>
<h4 id="å®šä¹‰urlfetcherä¸filefetcher"><a class="header" href="#å®šä¹‰urlfetcherä¸filefetcher">å®šä¹‰UrlFetcherä¸FileFetcher</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">struct UrlFetcher&lt;'a&gt;(pub(crate) &amp;'a str);

struct FileFetcher&lt;'a&gt;(pub(crate) &amp;'a str);
</code></pre></pre>
<h4 id="å®šä¹‰traitå¹¶ç»™fetcherä¸filefetcherå®ç°"><a class="header" href="#å®šä¹‰traitå¹¶ç»™fetcherä¸filefetcherå®ç°">å®šä¹‰traitå¹¶ç»™Fetcherä¸FileFetcherå®ç°</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">// Rust çš„ async trait è¿˜æ²¡æœ‰ç¨³å®šï¼Œå¯ä»¥ç”¨ async_trait å®
#[async_trait]
pub trait Fetch {
    type Error;
    async fn fetch(&amp;self) -&gt; Result&lt;String, Self::Error&gt;;
}

#[async_trait]
impl&lt;'a&gt; Fetch for UrlFetcher&lt;'a&gt; {
    type Error = anyhow::Error;

    async fn fetch(&amp;self) -&gt; Result&lt;String, Self::Error&gt; {
        Ok(reqwest::get(self.0).await?.text().await?)
    }
}

#[async_trait]
impl&lt;'a&gt; Fetch for FileFetcher&lt;'a&gt; {
    type Error = anyhow::Error;

    async fn fetch(&amp;self) -&gt; Result&lt;String, Self::Error&gt; {
        Ok(fs::read_to_string(&amp;self.0[7..]).await?)
    }
}
</code></pre></pre>
<h4 id="æœ€åå®šä¹‰ä¸€ä¸ªè·å–æ•°æ®çš„æ–¹æ³•"><a class="header" href="#æœ€åå®šä¹‰ä¸€ä¸ªè·å–æ•°æ®çš„æ–¹æ³•">æœ€åå®šä¹‰ä¸€ä¸ªè·å–æ•°æ®çš„æ–¹æ³•</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// ä»æ–‡ä»¶æºæˆ–è€… http æºä¸­è·å–æ•°æ®ï¼Œè¿”å›å­—ç¬¦ä¸²
pub async fn retrieve_data(source: impl AsRef&lt;str&gt;) -&gt; Result&lt;String&gt; {
    let name = source.as_ref();
    match &amp;name[..4] {
        // åŒ…æ‹¬ http / https
        &quot;http&quot; =&gt; UrlFetcher(name).fetch().await,
        // å¤„ç† file://&lt;filename&gt;
        &quot;file&quot; =&gt; FileFetcher(name).fetch().await,
        _ =&gt; Err(anyhow!(&quot;We only support http/https/file at the moment&quot;)),
    }
}
</code></pre></pre>
<h2 id="queryer-js-package-ä½¿ç”¨neon"><a class="header" href="#queryer-js-package-ä½¿ç”¨neon">queryer-js package: ä½¿ç”¨neon</a></h2>
<h3 id="cargotoml-3"><a class="header" href="#cargotoml-3">Cargo.toml</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">[package]
name = &quot;queryer-js&quot;
version = &quot;0.1.0&quot;
license = &quot;ISC&quot;
edition = &quot;2021&quot;
exclude = [&quot;index.node&quot;]

[lib]
crate-type = [&quot;cdylib&quot;]

[dependencies]
anyhow = &quot;1&quot;
queryer = { path = &quot;../queryer&quot; }
tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] }

[dependencies.neon]
version = &quot;0.9&quot;
default-features = false
features = [&quot;napi-6&quot;]
</code></pre></pre>
<h3 id="build-in-packagejson"><a class="header" href="#build-in-packagejson">build in package.json</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{
  &quot;name&quot;: &quot;queryer-js&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;index.node&quot;,
  &quot;scripts&quot;: {
    &quot;build&quot;: &quot;cargo-cp-artifact -nc index.node -- cargo build --message-format=json-render-diagnostics&quot;,
    &quot;build-debug&quot;: &quot;npm run build --&quot;,
    &quot;build-release&quot;: &quot;npm run build -- --release&quot;,
    &quot;install&quot;: &quot;npm run build-release&quot;,
    &quot;test&quot;: &quot;cargo test&quot;
  },
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;devDependencies&quot;: {
    &quot;cargo-cp-artifact&quot;: &quot;^0.1&quot;
  }
}
</code></pre></pre>
<h3 id="srclibrs"><a class="header" href="#srclibrs">src/lib.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use neon::prelude::*;

pub fn example_sql(mut cx: FunctionContext) -&gt; JsResult&lt;JsString&gt; {
    Ok(cx.string(queryer::example_sql()))
}

fn query(mut cx: FunctionContext) -&gt; JsResult&lt;JsString&gt; {
    let sql = cx.argument::&lt;JsString&gt;(0)?.value(&amp;mut cx);
    let output = match cx.argument::&lt;JsString&gt;(1) {
        Ok(v) =&gt; v.value(&amp;mut cx),
        Err(_) =&gt; &quot;csv&quot;.to_string(),
    };
    let rt = tokio::runtime::Runtime::new().unwrap();
    let data = rt.block_on(async { queryer::query(sql).await.unwrap() });

    match output.as_str() {
        &quot;csv&quot; =&gt; Ok(cx.string(data.to_csv().unwrap())),
        v =&gt; cx.throw_type_error(format!(&quot;Output type {} not supported&quot;, v)),
    }
}

#[neon::main]
fn main(mut cx: ModuleContext) -&gt; NeonResult&lt;()&gt; {
    cx.export_function(&quot;example_sql&quot;, example_sql)?;
    cx.export_function(&quot;query&quot;, query)?;
    Ok(())
}
</code></pre></pre>
<h2 id="queryer-py-package-ä½¿ç”¨pyo3"><a class="header" href="#queryer-py-package-ä½¿ç”¨pyo3">queryer-py package: ä½¿ç”¨pyo3</a></h2>
<blockquote>
<p>pythonè°ƒç”¨æŸ¥è¯¢åŒ…</p>
</blockquote>
<h3 id="cargotoml-4"><a class="header" href="#cargotoml-4">Cargo.toml</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">[package]
name = &quot;queryer_py&quot; # Python æ¨¡å—éœ€è¦ç”¨ä¸‹åˆ’çº¿
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;


[lib]
crate-type = [&quot;cdylib&quot;] # ä½¿ç”¨ cdylib ç±»å‹

[dependencies]
queryer = { path = &quot;../queryer&quot; } # å¼•å…¥ queryer
tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] }

[dependencies.pyo3]
version = &quot;0.14&quot;
features = [&quot;extension-module&quot;]

[build-dependencies]
pyo3-build-config = &quot;0.14&quot;
</code></pre></pre>
<h3 id="buildrs-1"><a class="header" href="#buildrs-1">build.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    pyo3_build_config::add_extension_module_link_args();
}
</code></pre></pre>
<h3 id="srclibrs-1"><a class="header" href="#srclibrs-1">src/lib.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#![allow(clippy::needless_option_as_deref)]
use pyo3::{exceptions, prelude::*};

#[pyfunction]
pub fn example_sql() -&gt; PyResult&lt;String&gt; {
    Ok(queryer::example_sql())
}

#[pyfunction]
pub fn query(sql: &amp;str, output: Option&lt;&amp;str&gt;) -&gt; PyResult&lt;String&gt; {
    let rt = tokio::runtime::Runtime::new().unwrap();
    let data = rt.block_on(async { queryer::query(sql).await.unwrap() });
    match output {
        Some(&quot;csv&quot;) | None =&gt; Ok(data.to_csv().unwrap()),
        Some(v) =&gt; Err(exceptions::PyTypeError::new_err(format!(
            &quot;Output type {} not supported&quot;,
            v
        ))),
    }
}

#[pymodule]
fn queryer_py(_py: Python, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    m.add_function(wrap_pyfunction!(query, m)?)?;
    m.add_function(wrap_pyfunction!(example_sql, m)?)?;
    Ok(())
}
</code></pre></pre>
<h2 id="data-viewer-package-ä½¿ç”¨tauri"><a class="header" href="#data-viewer-package-ä½¿ç”¨tauri">data-viewer package: ä½¿ç”¨tauri</a></h2>
<h3 id="cargotoml-5"><a class="header" href="#cargotoml-5">Cargo.toml</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">[package]
name = &quot;app&quot;
version = &quot;0.1.0&quot;
description = &quot;A Tauri App&quot;
authors = [&quot;you&quot;]
license = &quot;&quot;
repository = &quot;&quot;
default-run = &quot;app&quot;
edition = &quot;2021&quot;
build = &quot;src/build.rs&quot;

<span class="boring">See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html
</span>
[build-dependencies]
tauri-build = { version = &quot;1.0.0-beta.4&quot; }

[dependencies]
anyhow = &quot;1&quot;
serde_json = &quot;1&quot;
queryer = { path = &quot;../../queryer&quot; }
serde = { version = &quot;1.0&quot;, features = [&quot;derive&quot;] }
tauri = { version = &quot;1.0.0-beta.8&quot;, features = [&quot;api-all&quot;] }

[features]
default = [ &quot;custom-protocol&quot; ]
custom-protocol = [ &quot;tauri/custom-protocol&quot; ]
</code></pre></pre>
<h3 id="buildrs-2"><a class="header" href="#buildrs-2">build.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
  tauri_build::build()
}
</code></pre></pre>
<h3 id="mainrs-1"><a class="header" href="#mainrs-1">main.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#![cfg_attr(
  all(not(debug_assertions), target_os = &quot;windows&quot;),
  windows_subsystem = &quot;windows&quot;
)]

#[tauri::command]
fn example_sql() -&gt; String {
  queryer::example_sql()
}

#[tauri::command]
async fn query(sql: String) -&gt; Result&lt;String, String&gt; {
  let data = queryer::query(&amp;sql).await.map_err(|err| err.to_string())?;
  Ok(data.to_csv().map_err(|err| err.to_string())?)
}

fn main() {
  tauri::Builder::default()
    .invoke_handler(tauri::generate_handler![example_sql, query])
    .run(tauri::generate_context!())
    .expect(&quot;error while running tauri application&quot;);
}
</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustæ ¸å¿ƒæ·±å…¥"><a class="header" href="#rustæ ¸å¿ƒæ·±å…¥">Rustæ ¸å¿ƒæ·±å…¥</a></h1>
<h2 id="èµ„æ–™æ¨è"><a class="header" href="#èµ„æ–™æ¨è">èµ„æ–™æ¨è</a></h2>
<ul>
<li><a href="https://tyrchen.github.io/rust-training/rust-training-all-in-one-cn.html#1">é™ˆå¤©åŸ¹è®­slides</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="i-ä»æ ˆå †æ‰€æœ‰æƒç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†"><a class="header" href="#i-ä»æ ˆå †æ‰€æœ‰æƒç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†">I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ii-ç±»å‹ç³»ç»Ÿ"><a class="header" href="#ii-ç±»å‹ç³»ç»Ÿ">II. ç±»å‹ç³»ç»Ÿ</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="iii-æ•°æ®ç»“æ„"><a class="header" href="#iii-æ•°æ®ç»“æ„">III. æ•°æ®ç»“æ„</a></h1>
<div id="admonition-æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ" class="admonition tip">
<div class="admonition-title">
<p>æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ"></a></p>
</div>
<div>
<blockquote>
<p>ç”¨40åˆ†é’Ÿçš„æ—¶é—´ï¼Œæ€»ç»“äº†Rustçš„ä¸»è¦æ•°æ®ç»“æ„çš„å†… å­˜å¸ƒå±€ã€‚å®ƒèƒ½å˜æ¸…â€œæ•°æ®æ˜¯å¦‚ä½•åœ¨å †å’Œæ ˆä¸Šå­˜å‚¨â€œçš„æ€è·¯ï¼Œåœ¨è¿™é‡Œä¹Ÿæ¨èç»™ä½ ã€‚
<a href="https://www.youtube.com/watch?v=rDoqT-a6UFg">Visualizing memory layout of Rustâ€™s data types - YouTube</a></p>
</blockquote>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="iv-å®ç¼–ç¨‹"><a class="header" href="#iv-å®ç¼–ç¨‹">IV å®ç¼–ç¨‹</a></h1>
<!--ts-->
<ul>
<li><a href="4_macros.html#iv-%E5%AE%8F%E7%BC%96%E7%A8%8B">IV å®ç¼–ç¨‹</a>
<ul>
<li><a href="4_macros.html#%E8%B5%84%E6%96%99">èµ„æ–™</a></li>
<li><a href="4_macros.html#%E5%AE%8F%E7%9A%84%E5%88%86%E7%B1%BB">å®çš„åˆ†ç±»</a>
<ul>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8Fdeclarative-macros-macro_rulesbang">å£°æ˜å®(declarative macros): macro_rules!(bang)</a></li>
<li><a href="4_macros.html#%E8%BF%87%E7%A8%8B%E5%AE%8F%E6%B7%B1%E5%BA%A6%E5%AE%9A%E5%88%B6%E4%B8%8E%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81">è¿‡ç¨‹å®ï¼šæ·±åº¦å®šåˆ¶ä¸ç”Ÿæˆä»£ç </a>
<ul>
<li><a href="4_macros.html#%E5%87%BD%E6%95%B0%E5%AE%8F">å‡½æ•°å®</a></li>
<li><a href="4_macros.html#%E5%B1%9E%E6%80%A7%E5%AE%8F">å±æ€§å®</a></li>
<li><a href="4_macros.html#%E6%B4%BE%E7%94%9F%E5%AE%8F">æ´¾ç”Ÿå®</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8F">å£°æ˜å®</a>
<ul>
<li><a href="4_macros.html#rust%E5%B8%B8%E7%94%A8%E5%A3%B0%E6%98%8E%E5%AE%8F">Rustå¸¸ç”¨å£°æ˜å®</a>
<ul>
<li><a href="4_macros.html#println">println!</a></li>
<li><a href="4_macros.html#writeln">writeln!</a></li>
<li><a href="4_macros.html#eprintln">eprintln!</a></li>
</ul>
</li>
<li><a href="4_macros.html#%E7%A4%BA%E4%BE%8B">ç¤ºä¾‹</a>
<ul>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8F%E7%A4%BA%E6%84%8F%E5%9B%BE">å£°æ˜å®ç¤ºæ„å›¾</a></li>
<li><a href="4_macros.html#macro_rules%E5%AE%9A%E4%B9%89">macro_rules!å®šä¹‰</a></li>
<li><a href="4_macros.html#%E4%BD%BF%E7%94%A8">ä½¿ç”¨</a></li>
</ul>
</li>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8F%E7%94%A8%E5%88%B0%E7%9A%84%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B">å£°æ˜å®ç”¨åˆ°çš„å‚æ•°ç±»å‹</a></li>
</ul>
</li>
<li><a href="4_macros.html#%E8%BF%87%E7%A8%8B%E5%AE%8F%E6%89%8B%E5%B7%A5%E5%AE%9A%E4%B9%89%E5%9B%BE">è¿‡ç¨‹å®æ‰‹å·¥å®šä¹‰å›¾</a>
<ul>
<li><a href="4_macros.html#cargotoml%E6%B7%BB%E5%8A%A0proc-macro%E5%A3%B0%E6%98%8E">Cargo.tomlæ·»åŠ proc-macroå£°æ˜</a></li>
</ul>
</li>
<li>[è¿‡ç¨‹å‡½æ•°å®: #[proc_macro]](#è¿‡ç¨‹å‡½æ•°å®-proc_macro)
<ul>
<li><a href="4_macros.html#srclibrs%E5%AE%9A%E4%B9%89%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0%E5%AE%8F">src/lib.rs:å®šä¹‰è¿‡ç¨‹å‡½æ•°å®</a></li>
<li><a href="4_macros.html#examplesqueryrs%E4%BD%BF%E7%94%A8">examples/query.rs:ä½¿ç”¨</a></li>
</ul>
</li>
<li>[è¿‡ç¨‹å±æ€§å®: #[proc_macro_attribute]](#è¿‡ç¨‹å±æ€§å®-proc_macro_attribute)</li>
<li>[è¿‡ç¨‹æ´¾ç”Ÿå®: /#[proc_macro_devive(DeriveMacroName)]](#è¿‡ç¨‹æ´¾ç”Ÿå®-proc_macro_devivederivemacroname)
<ul>
<li><a href="4_macros.html#%E5%B8%B8%E7%94%A8%E6%B4%BE%E7%94%9F%E5%AE%8F">å¸¸ç”¨æ´¾ç”Ÿå®</a>
<ul>
<li>[#[derive(Debug)]](#derivedebug)</li>
</ul>
</li>
<li><a href="4_macros.html#%E5%8E%9F%E5%A7%8B%E5%AE%9E%E7%8E%B0builder%E6%A8%A1%E5%BC%8F">åŸå§‹å®ç°builderæ¨¡å¼</a>
<ul>
<li><a href="4_macros.html#%E6%83%B3%E5%88%B0%E8%BE%BE%E5%88%B0%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E7%9A%84%E6%95%88%E6%9E%9C">æƒ³åˆ°è¾¾åˆ°é“¾å¼è°ƒç”¨çš„æ•ˆæœ</a></li>
<li><a href="4_macros.html#%E5%8F%AF%E4%BB%A5%E8%BF%99%E6%A0%B7%E5%AE%9A%E4%B9%89">å¯ä»¥è¿™æ ·å®šä¹‰</a></li>
<li><a href="4_macros.html#%E4%BD%86%E6%98%AF%E6%9C%89%E7%82%B9%E7%B9%81%E7%90%90%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E6%B4%BE%E7%94%9F%E5%AE%8F%E6%B4%BE%E7%94%9F%E5%87%BA%E8%BF%99%E4%BA%9B%E4%BB%A3%E7%A0%81">ä½†æ˜¯æœ‰ç‚¹ç¹çï¼Œå¯ä»¥ä½¿ç”¨æ´¾ç”Ÿå®æ´¾ç”Ÿå‡ºè¿™äº›ä»£ç </a></li>
</ul>
</li>
<li><a href="4_macros.html#%E6%B4%BE%E7%94%9F%E5%AE%8F%E6%80%9D%E8%B7%AF">æ´¾ç”Ÿå®æ€è·¯</a>
<ul>
<li><a href="4_macros.html#%E8%A6%81%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81%E6%A8%A1%E7%89%88">è¦ç”Ÿæˆçš„ä»£ç æ¨¡ç‰ˆ</a></li>
<li><a href="4_macros.html#%E6%9E%84%E5%BB%BA%E5%AF%B9%E5%BA%94%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">æ„å»ºå¯¹åº”æ•°æ®ç»“æ„</a></li>
<li><a href="4_macros.html#srclibrs-%E4%BD%BF%E7%94%A8%E6%B4%BE%E7%94%9F%E5%AE%8F%E4%BB%8Etokenstream%E6%8A%BD%E5%8F%96%E5%87%BA%E6%83%B3%E8%A6%81%E7%9A%84%E4%BF%A1%E6%81%AF">src/lib.rs: ä½¿ç”¨æ´¾ç”Ÿå®ä»TokenStreamæŠ½å–å‡ºæƒ³è¦çš„ä¿¡æ¯</a></li>
<li><a href="4_macros.html#examplescommandrs-%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E6%B4%BE%E7%94%9F%E5%AE%8F%E6%8A%BD%E5%8F%96">examples/command.rs: ä½¿ç”¨è¿™ä¸ªæ´¾ç”Ÿå®æŠ½å–</a></li>
<li><a href="4_macros.html#%E8%BF%90%E8%A1%8C%E6%9F%A5%E7%9C%8B%E8%8E%B7%E5%8F%96%E7%9A%84tokenstream">è¿è¡Œï¼ŒæŸ¥çœ‹è·å–çš„TokenStream</a></li>
<li><a href="4_macros.html#srcraw_builderrs-%E4%BD%BF%E7%94%A8anyhow%E4%B8%8Easkama%E6%8A%BD%E5%8F%96tokenstream%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF">src/raw_builder.rs: ä½¿ç”¨anyhowä¸askamaæŠ½å–TokenStreamä¸­çš„ä¿¡æ¯</a></li>
<li><a href="4_macros.html#templatesbuilderj2-%E4%B8%8A%E9%9D%A2askama%E7%94%A8%E5%88%B0%E7%9A%84jinja2%E6%A8%A1%E7%89%88">templates/builder.j2: ä¸Šé¢askamaç”¨åˆ°çš„jinja2æ¨¡ç‰ˆ</a></li>
<li><a href="4_macros.html#srcraw_builderrs-%E5%AE%9E%E7%8E%B0%E5%AF%B9%E5%BA%94%E6%8A%BD%E5%8F%96%E6%96%B9%E6%B3%95">src/raw_builder.rs: å®ç°å¯¹åº”æŠ½å–æ–¹æ³•</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sat Sep 24 03:25:10 UTC 2022 -->
<!--te-->
<h2 id="èµ„æ–™"><a class="header" href="#èµ„æ–™">èµ„æ–™</a></h2>
<ul>
<li><a href="https://kaisery.github.io/trpl-zh-cn/ch19-06-macros.html">å® - Rust ç¨‹åºè®¾è®¡è¯­è¨€ ç®€ä½“ä¸­æ–‡ç‰ˆ</a></li>
<li><a href="https://doc.rust-lang.org/book/ch19-06-macros.html">Macros - The Rust Programming Language</a></li>
<li><a href="https://doc.rust-lang.org/reference/macros-by-example.html">Macros By Example - The Rust Reference</a></li>
</ul>
<h2 id="å®çš„åˆ†ç±»"><a class="header" href="#å®çš„åˆ†ç±»">å®çš„åˆ†ç±»</a></h2>
<h3 id="å£°æ˜å®declarative-macros-macro_rulesbang"><a class="header" href="#å£°æ˜å®declarative-macros-macro_rulesbang">å£°æ˜å®(declarative macros): macro_rules!(bang)</a></h3>
<blockquote>
<p>å¯¹ä»£ç æ¨¡ç‰ˆåšç®€å•æ›¿æ¢
å£°æ˜å®å¯ä»¥ç”¨ macro_rules! æ¥æè¿°, å¦‚æœé‡å¤æ€§çš„ä»£ç æ— æ³•ç”¨å‡½æ•°æ¥å°è£…ï¼Œé‚£ä¹ˆå£°æ˜å®å°±æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©</p>
</blockquote>
<h3 id="è¿‡ç¨‹å®æ·±åº¦å®šåˆ¶ä¸ç”Ÿæˆä»£ç "><a class="header" href="#è¿‡ç¨‹å®æ·±åº¦å®šåˆ¶ä¸ç”Ÿæˆä»£ç ">è¿‡ç¨‹å®ï¼šæ·±åº¦å®šåˆ¶ä¸ç”Ÿæˆä»£ç </a></h3>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Za411q7LQ">Rust è¿‡ç¨‹å®(1): å¦‚ä½•ç¡¬ç”Ÿç”Ÿè§£æå’Œæ‰‹å†™è¿‡ç¨‹å®</a></li>
</ul>
<blockquote>
<p>ä¸»è¦ä»¥å¦‚ä½•ä½¿ç”¨ function-like macro åœ¨ä¸ä¾èµ–äº syn / quote çš„æƒ…å†µä¸‹ï¼ŒæŠŠ Json Schema åœ¨ç¼–è¯‘æœŸè½¬æ¢æˆ Rust structã€‚ä¸»è¦ç›®çš„æ˜¯è®©å¤§å®¶ç†Ÿæ‚‰åŸºæœ¬çš„å¤„ç† TokenStream çš„æ€è·¯</p>
</blockquote>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Fu411m7W7">Rust è¿‡ç¨‹å®(2): ä½¿ç”¨ syn/quote æ’°å†™è¿‡ç¨‹å®</a></li>
</ul>
<blockquote>
<p>ä¸»è¦é€šè¿‡ä¸€ä¸ª derive Builder å®ï¼Œæ¥å±•ç¤ºä½¿ç”¨ syn/quote å¦‚ä½•å¼€å‘è¿‡ç¨‹å®ã€‚</p>
</blockquote>
<ul>
<li><a href="https://www.bilibili.com/video/BV1dr4y1v74n">Rust è¿‡ç¨‹å®(3): ä½¿ç”¨ darling å¤„ç† attributes</a></li>
</ul>
<blockquote>
<p>åšä¸ªæ”¶å°¾ï¼Œå¯¹ä¸Šä¸€è®²çš„ derive macro æ”¯æŒ attributesã€‚ æˆ‘ä»¬å¯ä»¥ç›´æ¥è§£æ attributes ç›¸å…³çš„ TokenStreamï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ darling è¿™ä¸ªå¾ˆæ–¹ä¾¿çš„åº“ï¼Œç›´æ¥æŠŠ attributes åƒ
Clap/Structopts é‚£æ ·æ”¶é›†åˆ°ä¸€ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œç„¶åå†è¿›ä¸€æ­¥å¤„ç†ã€‚</p>
</blockquote>
<div id="admonition-æ€»ç»“" class="admonition info">
<div class="admonition-title">
<p>æ€»ç»“</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-æ€»ç»“"></a></p>
</div>
<div>
<p>è¿™ä¸‰è®²çš„å†…å®¹è™½ç„¶ç®€å•ï¼Œä½†è¶³ä»¥åº”ä»˜å¤§å®¶ç»å¤§å¤šæ•°å®ç¼–ç¨‹çš„éœ€æ±‚ã€‚
å…¶å®æˆ‘ä»¬ç°åœ¨å¯¹ syn åº“çš„ä½¿ç”¨è¿˜åªæ˜¯ä¸€ä¸ªçš®æ¯›ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ·±å…¥
å»æ’°å†™è‡ªå·±çš„æ•°æ®ç»“æ„å»å®ç° Parse traitï¼Œåƒ DeriveInput 
é‚£æ ·å¯ä»¥ç›´æ¥æŠŠ TokenStream è½¬æ¢æˆæˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿ã€‚</p>
<p>å¤§å®¶æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è‡ªè¡Œå»çœ‹ syn åº“çš„æ–‡æ¡£ã€‚</p>
</div>
</div>
<h4 id="å‡½æ•°å®"><a class="header" href="#å‡½æ•°å®">å‡½æ•°å®</a></h4>
<p>çœ‹èµ·æ¥åƒå‡½æ•°çš„å®ï¼Œä½†åœ¨ç¼–è¯‘æœŸè¿›è¡Œå¤„ç†.</p>
<blockquote>
<p>sqlx ç”¨å‡½æ•°å®æ¥å¤„ç†SQL queryã€tokioä½¿ç”¨å±æ€§å® #[tokio::main] æ¥å¼•å…¥ runtimeã€‚
å®ƒä»¬å¯ä»¥å¸®åŠ©ç›®æ ‡ä»£ç çš„å®ç°é€»è¾‘å˜å¾—æ›´åŠ ç®€å•ï¼Œ ä½†ä¸€èˆ¬é™¤éç‰¹åˆ«å¿…è¦ï¼Œå¦åˆ™å¹¶ä¸æ¨èå†™ã€‚
å¹¶æ²¡æœ‰ç‰¹å®šçš„ä½¿ç”¨åœºæ™¯</p>
</blockquote>
<h4 id="å±æ€§å®"><a class="header" href="#å±æ€§å®">å±æ€§å®</a></h4>
<p>å¯ä»¥åœ¨å…¶ä»–ä»£ç å—ä¸Šæ·»åŠ å±æ€§ï¼Œä¸ºä»£ç å—æä¾›æ›´å¤šåŠŸèƒ½ã€‚</p>
<h4 id="æ´¾ç”Ÿå®"><a class="header" href="#æ´¾ç”Ÿå®">æ´¾ç”Ÿå®</a></h4>
<p>ä¸º deriveå±æ€§æ·»åŠ æ–°çš„åŠŸèƒ½ã€‚è¿™æ˜¯æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨æœ€å¤šçš„å®ï¼Œæ¯”å¦‚ #[derive(Debug)].</p>
<blockquote>
<p>å¦‚æœä½ å®šä¹‰çš„ trait åˆ«äººå®ç°èµ·æ¥æœ‰å›ºå®šçš„æ¨¡å¼å¯å¾ªï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä¸ºå…¶æ„å»ºæ´¾ç”Ÿå®</p>
</blockquote>
<h2 id="å£°æ˜å®"><a class="header" href="#å£°æ˜å®">å£°æ˜å®</a></h2>
<h3 id="rustå¸¸ç”¨å£°æ˜å®"><a class="header" href="#rustå¸¸ç”¨å£°æ˜å®">Rustå¸¸ç”¨å£°æ˜å®</a></h3>
<h4 id="println"><a class="header" href="#println">println!</a></h4>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.println.html">println in std - Rust</a></li>
<li><a href="https://blog.csdn.net/jiangjkd/article/details/120994956">Rustå£°æ˜å®printlnå‰–æ_ä¸€çº¿coderçš„åšå®¢-CSDNåšå®¢_rust å£°æ˜å®</a></li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[macro_export]
#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
#[allow_internal_unstable(print_internals, format_args_nl)]
macro_rules! println {
    () =&gt; ($crate::print!(&quot;\n&quot;));
    ($($arg:tt)*) =&gt; ({
        $crate::io::_print($crate::format_args_nl!($($arg)*));
    })
}
<span class="boring">}
</span></code></pre></pre>
<h4 id="writeln"><a class="header" href="#writeln">writeln!</a></h4>
<blockquote>
<p>å¯ä»¥å°†å†…å®¹è¾“å…¥åˆ°æŒ‡å®šæ–‡ä»¶</p>
</blockquote>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.writeln.html">writeln in std - Rust</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/148945862">rustå…¥é—¨ç¬”è®°â€”ç¿»è¯‘rust writeï¼å® - çŸ¥ä¹</a></li>
</ul>
<pre><code class="language-shell">cargo run --example raw_command &gt; examples/raw_command_output.txt
</code></pre>
<h4 id="eprintln"><a class="header" href="#eprintln">eprintln!</a></h4>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.eprintln.html">eprintln in std - Rust</a></li>
</ul>
<h3 id="ç¤ºä¾‹"><a class="header" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></h3>
<h4 id="å£°æ˜å®ç¤ºæ„å›¾"><a class="header" href="#å£°æ˜å®ç¤ºæ„å›¾">å£°æ˜å®ç¤ºæ„å›¾</a></h4>
<figure><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="633px" preserveAspectRatio="none" style="width:474px;height:633px;background:#FFFFFF;" version="1.1" viewBox="0 0 474 633" width="474px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="26.2969" id="_title" style="stroke:none;stroke-width:1.0;" width="136" x="167.5" y="15"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="126" x="172.5" y="32.9951">å£°æ˜å®å®šä¹‰ä½¿ç”¨æµç¨‹</text><ellipse cx="51" cy="57.2969" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><path d="M101,77.2969 L101,389.9531 L462,389.9531 L462,87.2969 L452,77.2969 L101,77.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M452,77.2969 L452,87.2969 L462,87.2969 L452,77.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="107" y="94.3638">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="123" y="94.3638">[macro_export]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="107" y="109.4966">macro_rules! my_vec {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299" x="123" y="124.6294">// æ²¡å¸¦ä»»ä½•å‚æ•°çš„ my_vecï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºçš„ vec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="123" y="139.7622">// æ³¨æ„ï¼Œç”±äºå®è¦åœ¨è°ƒç”¨çš„åœ°æ–¹å±•å¼€ï¼Œæˆ‘ä»¬æ— æ³•é¢„æµ‹è°ƒç”¨</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="316" x="123" y="154.895">// è€…çš„ç¯å¢ƒæ˜¯å¦å·²ç» åšäº†ç›¸å…³çš„ useï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨çš„</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="123" y="170.0278">// ä»£ç æœ€å¥½å¸¦ç€å®Œæ•´çš„å‘½åç©ºé—´ã€‚</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="123" y="185.1606">() =&gt; {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="139" y="200.2935">std::vec::Vec::new()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="123" y="215.4263">};</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="123" y="230.5591">// å¤„ç† my_vec![1, 2, 3, 4]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="123" y="245.6919">($($el:expr),*) =&gt; ({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="139" y="260.8247">let mut v = std::vec::Vec::new();</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="139" y="275.9575">$(v.push($el);)*</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="7" x="139" y="291.0903">v</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="123" y="306.2231">});</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="123" y="321.356">// å¤„ç† my_vec![0; 10]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="123" y="336.4888">($el:expr; $n:expr) =&gt; {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="139" y="351.6216">std::vec::from_elem($el, $n)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="123" y="366.7544">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="107" y="381.8872">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="11" y="216.6406"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="21" y="237.7793">å®šä¹‰è¿‡ç¨‹å®</text><path d="M101,399.9531 L101,621.8125 L318,621.8125 L318,409.9531 L308,399.9531 L101,399.9531 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M308,399.9531 L308,409.9531 L318,409.9531 L308,399.9531 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="107" y="417.02">fn main() {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="123" y="432.1528">let mut v = my_vec![];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="123" y="447.2856">v.push(1);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="123" y="462.4185">// è°ƒç”¨æ—¶å¯ä»¥ä½¿ç”¨ [], (), {}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="123" y="477.5513">let _v = my_vec!(1, 2, 3, 4);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="123" y="492.6841">let _v = my_vec![1, 2, 3, 4];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="123" y="507.8169">let v = my_vec! {1, 2, 3, 4};</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="123" y="522.9497">println!("{:?}", v);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="107" y="538.0825">Â </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="123" y="553.2153">println!("{:?}", v);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="123" y="568.3481">//</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="123" y="583.481">let v = my_vec![1; 10];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="123" y="598.6138">println!("{:?}", v);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="107" y="613.7466">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="11" y="493.8984"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="21" y="515.0371">ä½¿ç”¨å£°æ˜å®</text><line style="stroke:#181818;stroke-width:1.0;" x1="51" x2="51" y1="67.2969" y2="216.6406"/><polygon fill="#181818" points="47,206.6406,51,216.6406,55,206.6406,51,210.6406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="51" x2="51" y1="250.6094" y2="493.8984"/><polygon fill="#181818" points="47,483.8984,51,493.8984,55,483.8984,51,487.8984" style="stroke:#181818;stroke-width:1.0;"/></g></svg></figure>
<h4 id="macro_ruleså®šä¹‰"><a class="header" href="#macro_ruleså®šä¹‰">macro_rules!å®šä¹‰</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[macro_export]
macro_rules! my_vec {
    // æ²¡å¸¦ä»»ä½•å‚æ•°çš„ my_vecï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºçš„ vec
    // æ³¨æ„ï¼Œç”±äºå®è¦åœ¨è°ƒç”¨çš„åœ°æ–¹å±•å¼€ï¼Œæˆ‘ä»¬æ— æ³•é¢„æµ‹è°ƒç”¨
    // è€…çš„ç¯å¢ƒæ˜¯å¦å·²ç» åšäº†ç›¸å…³çš„ useï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨çš„
    // ä»£ç æœ€å¥½å¸¦ç€å®Œæ•´çš„å‘½åç©ºé—´ã€‚
    () =&gt; {
        std::vec::Vec::new()
    };
    // å¤„ç† my_vec![1, 2, 3, 4]
    ($($el:expr),*) =&gt; ({
        let mut v = std::vec::Vec::new();
        $(v.push($el);)*
        v
    });
    // å¤„ç† my_vec![0; 10]
    ($el:expr; $n:expr) =&gt; {
        std::vec::from_elem($el, $n)
    }
}
</code></pre></pre>
<div id="admonition-elexpr-" class="admonition info">
<div class="admonition-title">
<p>$($el:expr), *)</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-elexpr-"></a></p>
</div>
<div>
<ol>
<li>åœ¨å£°æ˜å®ä¸­ï¼Œæ¡ä»¶æ•è·çš„å‚æ•°ä½¿ç”¨ $ å¼€å¤´çš„æ ‡è¯†ç¬¦æ¥å£°æ˜ã€‚</li>
<li>æ¯ä¸ªå‚æ•°éƒ½éœ€è¦æä¾›ç±»å‹ï¼Œè¿™é‡Œ<code>expr</code>ä»£è¡¨è¡¨è¾¾å¼ï¼Œæ‰€ä»¥ $el:expr æ˜¯è¯´æŠŠåŒ¹é…åˆ°çš„è¡¨è¾¾å¼å‘½åä¸º $elã€‚</li>
<li>$(â€¦),* å‘Šè¯‰ç¼–è¯‘å™¨å¯ä»¥åŒ¹é…ä»»æ„å¤šä¸ªä»¥é€—å·åˆ†éš”çš„è¡¨è¾¾å¼ï¼Œç„¶åæ•è·åˆ°çš„æ¯ä¸€ä¸ªè¡¨è¾¾å¼å¯ä»¥ç”¨ $el æ¥è®¿é—®ã€‚</li>
<li>ç”±äºåŒ¹é…çš„æ—¶å€™åŒ¹é…åˆ°ä¸€ä¸ª $(â€¦)* ï¼ˆæˆ‘ä»¬å¯ä»¥ä¸ç®¡åˆ†éš”ç¬¦ï¼‰ï¼Œåœ¨æ‰§è¡Œçš„ä»£ç å—ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç›¸åº”åœ°ä½¿ç”¨ $(â€¦)* å±•å¼€ã€‚</li>
<li>æ‰€ä»¥è¿™å¥ $(v.push($el);)* ç›¸å½“äºåŒ¹é…å‡ºå¤šå°‘ä¸ª $elå°±å±•å¼€å¤šå°‘å¥ push è¯­å¥ã€‚</li>
</ol>
</div>
</div>
<h4 id="ä½¿ç”¨-1"><a class="header" href="#ä½¿ç”¨-1">ä½¿ç”¨</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let mut v = my_vec![];
    v.push(1);
    // è°ƒç”¨æ—¶å¯ä»¥ä½¿ç”¨ [], (), {}
    let _v = my_vec!(1, 2, 3, 4);
    let _v = my_vec![1, 2, 3, 4];
    let v = my_vec! {1, 2, 3, 4};
    println!(&quot;{:?}&quot;, v);

    println!(&quot;{:?}&quot;, v);
    //
    let v = my_vec![1; 10];
    println!(&quot;{:?}&quot;, v);
}
</code></pre></pre>
<h3 id="å£°æ˜å®ç”¨åˆ°çš„å‚æ•°ç±»å‹"><a class="header" href="#å£°æ˜å®ç”¨åˆ°çš„å‚æ•°ç±»å‹">å£°æ˜å®ç”¨åˆ°çš„å‚æ•°ç±»å‹</a></h3>
<div id="admonition-ç±»å‹åˆ—è¡¨" class="admonition info">
<div class="admonition-title">
<p>ç±»å‹åˆ—è¡¨</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-ç±»å‹åˆ—è¡¨"></a></p>
</div>
<div>
<ol>
<li>itemï¼Œæ¯”å¦‚ä¸€ä¸ªå‡½æ•°ã€ç»“æ„ä½“ã€æ¨¡å—ç­‰ã€‚ </li>
<li>blockï¼Œä»£ç å—ã€‚æ¯”å¦‚ä¸€ç³»åˆ—ç”±èŠ±æ‹¬å·åŒ…è£¹çš„è¡¨è¾¾å¼å’Œè¯­å¥ã€‚ </li>
<li>stmtï¼Œè¯­å¥ã€‚æ¯”å¦‚ä¸€ä¸ªèµ‹å€¼è¯­å¥ã€‚ </li>
<li>patï¼Œæ¨¡å¼ã€‚ </li>
<li>exprï¼Œè¡¨è¾¾å¼ã€‚åˆšæ‰çš„ä¾‹å­ä½¿ç”¨è¿‡äº†ã€‚ </li>
<li>tyï¼Œç±»å‹ã€‚æ¯”å¦‚ Vecã€‚ </li>
<li>identï¼Œæ ‡è¯†ç¬¦ã€‚æ¯”å¦‚ä¸€ä¸ªå˜é‡åã€‚ </li>
<li>pathï¼Œè·¯å¾„ã€‚æ¯”å¦‚ï¼šfooã€::std::mem::replaceã€transmute::&lt;_, int&gt;ã€‚ </li>
<li>metaï¼Œå…ƒæ•°æ®ã€‚ä¸€èˆ¬æ˜¯åœ¨ #[â€¦] å’Œ #![â€¦] å±æ€§å†…éƒ¨çš„æ•°æ®ã€‚ </li>
<li>ttï¼Œå•ä¸ªçš„ token æ ‘ã€‚ </li>
<li>visï¼Œå¯èƒ½ä¸ºç©ºçš„ä¸€ä¸ª Visibility ä¿®é¥°ç¬¦ã€‚æ¯”å¦‚ pubã€pub(crate)</li>
</ol>
</div>
</div>
<h2 id="è¿‡ç¨‹å®æ‰‹å·¥å®šä¹‰å›¾"><a class="header" href="#è¿‡ç¨‹å®æ‰‹å·¥å®šä¹‰å›¾">è¿‡ç¨‹å®æ‰‹å·¥å®šä¹‰å›¾</a></h2>
<blockquote>
<p>è¿‡ç¨‹å®è¦æ¯”å£°æ˜å®è¦å¤æ‚å¾ˆå¤šï¼Œä¸è¿‡æ— è®ºæ˜¯å“ªä¸€ç§è¿‡ç¨‹å®ï¼Œæœ¬è´¨éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ¶‰åŠè¦æŠŠ <code>è¾“å…¥çš„ TokenStream</code> å¤„ç†æˆ<code>è¾“å‡ºçš„ TokenStream</code>ã€‚</p>
</blockquote>
<div id="admonition-å‡½æ•°å®ä¸æ´¾ç”Ÿå®å®šä¹‰ä½¿ç”¨åŒºåˆ«" class="admonition info">
<div class="admonition-title">
<p>å‡½æ•°å®ä¸æ´¾ç”Ÿå®å®šä¹‰ä½¿ç”¨åŒºåˆ«</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-å‡½æ•°å®ä¸æ´¾ç”Ÿå®å®šä¹‰ä½¿ç”¨åŒºåˆ«"></a></p>
</div>
<div>
<figure><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1938px" preserveAspectRatio="none" style="width:3264px;height:1938px;background:#FFFFFF;" version="1.1" viewBox="0 0 3264 1938" width="3264px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="26.2969" id="_title" style="stroke:none;stroke-width:1.0;" width="136" x="1562.5" y="15"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="126" x="1567.5" y="32.9951">è¿‡ç¨‹å®å®šä¹‰ä½¿ç”¨æµç¨‹</text><ellipse cx="214" cy="85.9951" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><path d="M22,112.8467 L22,153.1123 L162,153.1123 L162,122.8467 L152,112.8467 L22,112.8467 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M152,112.8467 L152,122.8467 L162,122.8467 L152,112.8467 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="24" x="28" y="129.9136">[lib]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="28" y="145.0464">proc-macro = true</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="174" y="115.9951"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="184" y="137.1338">æ‰“å¼€è¿‡ç¨‹å®</text><ellipse cx="214" cy="536.0732" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><path d="M20,562.9248 L20,603.1904 L160,603.1904 L160,572.9248 L150,562.9248 L20,562.9248 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M150,562.9248 L150,572.9248 L160,572.9248 L150,562.9248 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="24" x="26" y="579.9917">[lib]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="26" y="595.1245">proc-macro = true</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="84" x="172" y="566.0732"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="186" y="587.2119">æ‰“å¼€è¿‡ç¨‹å®</text><line style="stroke:#000000;stroke-width:1.5;" x1="15" x2="15" y1="50.042" y2="1926.0889"/><path d="M378,163.1123 L378,294.1748 L737,294.1748 L737,173.1123 L727,163.1123 L378,163.1123 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M727,163.1123 L727,173.1123 L737,173.1123 L727,163.1123 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="384" y="180.1792">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="400" y="180.1792">[proc_macro]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="338" x="384" y="195.312">pub fn query(input: TokenStream) -&gt; TokenStream {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="400" y="210.4448">// åªæœ‰ä¿®æ”¹ä»£ç ä¹‹åå†æ¬¡ç¼–è¯‘æ‰ä¼šæ‰§è¡Œ</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="400" y="225.5776">println!("{:#?}", input);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="400" y="240.7104">"fn hello() { println!(\"Hello world!\"); }"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="50" x="416" y="255.8433">.parse()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="416" y="270.9761">.unwrap()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="384" y="286.1089">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="278" y="211.6592"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="288" y="232.7979">å®šä¹‰è¿‡ç¨‹å®</text><path d="M390,613.1904 L390,698.8545 L802,698.8545 L802,623.1904 L792,613.1904 L390,613.1904 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M792,613.1904 L792,623.1904 L802,623.1904 L792,613.1904 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="396" y="630.2573">/#[proc_macro_derive(Builder)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="396" y="645.3901">pub fn derive_builder(input: TokenStream) -&gt; TokenStream {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="341" x="412" y="660.5229">let input = parse_macro_input!(input as DeriveInput);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="319" x="412" y="675.6558">builder::BuilderContext::from(input).render().into()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="396" y="690.7886">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="266" y="639.0381"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="276" y="660.1768">å®šä¹‰è¿‡ç¨‹æ´¾ç”Ÿå®</text><line style="stroke:#000000;stroke-width:1.5;" x1="260" x2="260" y1="50.042" y2="1926.0889"/><path d="M812,304.1748 L812,420.1045 L1371,420.1045 L1371,314.1748 L1361,304.1748 L812,304.1748 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1361,304.1748 L1361,314.1748 L1371,314.1748 L1361,304.1748 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123" x="818" y="321.2417">use macros::query;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="818" y="336.3745">Â </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="818" y="351.5073">fn main() {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="834" y="366.6401">// query!(SELECT * FROM users WHERE age &gt; 10);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="522" x="834" y="381.7729">query!(SELECT * FROM users u JOIN (SELECT * from profiles p) WHERE u.id = p.id);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="40" x="834" y="396.9058">hello()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="818" y="412.0386">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="1391" y="345.1553"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="1401" y="366.2939">ä½¿ç”¨è¿‡ç¨‹å®</text><path d="M962,708.8545 L962,1172.8389 L1359,1172.8389 L1359,718.8545 L1349,708.8545 L962,708.8545 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1349,708.8545 L1349,718.8545 L1359,718.8545 L1349,708.8545 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="968" y="725.9214">use macros::Builder;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="968" y="741.0542">Â </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="968" y="756.187">/#[allow(dead_code)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="168" x="968" y="771.3198">/#[derive(Debug, Builder)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="968" y="786.4526">pub struct Command {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="984" y="801.5854">executable: String,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="984" y="816.7183">args: Vec&lt;String&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="984" y="831.8511">env: Vec&lt;String&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="984" y="846.9839">current_dir: Option&lt;String&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="968" y="862.1167">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="968" y="877.2495">Â </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="968" y="892.3823">fn main() {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="232" x="984" y="907.5151">let command = Command::builder()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="1000" y="922.6479">.executable("cargo".to_owned())</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="344" x="1000" y="937.7808">.args(vec!["build".to_owned(), "--release".to_owned()])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="1000" y="952.9136">.env(vec![])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="1000" y="968.0464">.build()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="1000" y="983.1792">.unwrap();</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="984" y="998.312">assert!(command.current_dir.is_none());</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="968" y="1013.4448">Â </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="232" x="984" y="1028.5776">let command = Command::builder()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="1000" y="1043.7104">.executable("cargo".to_owned())</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="344" x="1000" y="1058.8433">.args(vec!["build".to_owned(), "--release".to_owned()])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="1000" y="1073.9761">.env(vec![])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="1000" y="1089.1089">.current_dir("..".to_owned())</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="1000" y="1104.2417">.build()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="1000" y="1119.3745">.unwrap();</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="264" x="984" y="1134.5073">assert!(command.current_dir.is_some());</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="984" y="1149.6401">println!("{:?}", command);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="968" y="1164.7729">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="1379" y="923.8623"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="1389" y="945.001">ä½¿ç”¨æ´¾ç”Ÿå®æŠ½å–</text><line style="stroke:#000000;stroke-width:1.5;" x1="807" x2="807" y1="50.042" y2="1926.0889"/><path d="M1608,444.5225 L1608,469.6553 L1990,469.6553 L1990,454.5225 L1980,444.5225 L1608,444.5225 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1980,444.5225 L1980,454.5225 L1990,454.5225 L1980,444.5225 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="361" x="1614" y="461.5894">cargo run --example query &gt; examples/query_output.txt</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="2000" y="440.1045"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="2010" y="461.2432">æŸ¥çœ‹æ‰“å°çš„TokenStream</text><ellipse cx="2081.5" cy="505.0732" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="2081.5" cy="505.0732" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><path d="M1492,1197.2568 L1492,1222.3896 L1990,1222.3896 L1990,1207.2568 L1980,1197.2568 L1492,1197.2568 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1980,1197.2568 L1980,1207.2568 L1990,1207.2568 L1980,1197.2568 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="477" x="1498" y="1214.3237">cargo run --example raw_command &gt; examples/raw_command_output.txt</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="2000" y="1192.8389"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="2010" y="1213.9775">æŸ¥çœ‹æ‰“å°çš„TokenStream</text><line style="stroke:#000000;stroke-width:1.5;" x1="1487" x2="1487" y1="50.042" y2="1926.0889"/><path d="M2172,1236.8076 L2172,1564.5967 L2674,1564.5967 L2674,1246.8076 L2664,1236.8076 L2172,1236.8076 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2664,1236.8076 L2664,1246.8076 L2674,1246.8076 L2664,1236.8076 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="2178" y="1253.8745">use anyhow::Result;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150" x="2178" y="1269.0073">use askama::Template;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="331" x="2178" y="1284.1401">use proc_macro::{Ident, TokenStream, TokenTree};</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="200" x="2178" y="1299.2729">use std::collections::VecDeque;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="2178" y="1314.4058">Â </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="481" x="2178" y="1329.5386">/// å¤„ç† jinja æ¨¡æ¿çš„æ•°æ®ç»“æ„ï¼Œåœ¨æ¨¡æ¿ä¸­æˆ‘ä»¬ä½¿ç”¨äº† name / builder_name / fields</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="2178" y="1344.6714">/#[derive(Template)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="2178" y="1359.8042">/#[template(path = "builder.j2", escape = "none")]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="2178" y="1374.937">pub struct BuilderContext {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="2194" y="1390.0698">name: String,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="2194" y="1405.2026">builder_name: String,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="2194" y="1420.3354">fields: Vec&lt;Fd&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2178" y="1435.4683">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="2178" y="1450.6011">Â </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="2178" y="1465.7339">/// æè¿° struct çš„æ¯ä¸ª field</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170" x="2178" y="1480.8667">/#[derive(Debug, Default)]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="2178" y="1495.9995">struct Fd {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="2194" y="1511.1323">name: String,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="62" x="2194" y="1526.2651">ty: String,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="90" x="2194" y="1541.3979">optional: bool,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2178" y="1556.5308">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="307" x="2694" y="1383.7178"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="287" x="2704" y="1404.8564">ä½¿ç”¨anyhowä¸askamaæŠ½å–TokenStreamä¸­çš„ä¿¡æ¯</text><path d="M2323.5,1628.5654 L2323.5,1926.0889 L2769.5,1926.0889 L2769.5,1638.5654 L2759.5,1628.5654 L2323.5,1628.5654 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M2759.5,1628.5654 L2759.5,1638.5654 L2769.5,1638.5654 L2759.5,1628.5654 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="2329.5" y="1645.6323">impl Fd {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="391" x="2345.5" y="1660.7651">/// name å’Œ field éƒ½æ˜¯é€šè¿‡å†’å· Punct åˆ‡åˆ†å‡ºæ¥çš„ TokenTree åˆ‡ç‰‡</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="386" x="2345.5" y="1675.8979">pub fn new(name: &amp;[TokenTree], ty: &amp;[TokenTree]) -&gt; Self {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2345.5" y="1691.0308">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2329.5" y="1706.1636">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="2329.5" y="1721.2964">impl BuilderContext {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="325" x="2345.5" y="1736.4292">/// ä» TokenStream ä¸­æå–ä¿¡æ¯ï¼Œæ„å»º BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="237" x="2345.5" y="1751.562">fn new(input: TokenStream) -&gt; Self {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2345.5" y="1766.6948">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="2345.5" y="1781.8276">/// æŠŠæ¨¡æ¿æ¸²æŸ“æˆå­—ç¬¦ä¸²ä»£ç </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="357" x="2345.5" y="1796.9604">pub fn render(input: TokenStream) -&gt; Result&lt;String&gt; {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2345.5" y="1812.0933">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2329.5" y="1827.2261">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="425" x="2329.5" y="1842.3589">// æŠŠ TokenStream åˆ†å‡º struct çš„åå­—ï¼Œå’ŒåŒ…å« fields çš„ TokenStream</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="350" x="2329.5" y="1857.4917">fn split(input: TokenStream) -&gt; (Ident, TokenStream) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2329.5" y="1872.6245">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="313" x="2329.5" y="1887.7573">/// ä»åŒ…å« fields çš„ TokenStream ä¸­åˆ‡å‡ºæ¥ä¸€ä¸ªä¸ª Fd</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="354" x="2329.5" y="1902.8901">fn get_struct_fields(input: TokenStream) -&gt; Vec&lt;Fd&gt; {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="2329.5" y="1918.0229">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="116" x="2789.5" y="1760.3428"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="2799.5" y="1781.4814">å®ç°å¯¹åº”æŠ½å–æ–¹æ³•</text><line style="stroke:#000000;stroke-width:1.5;" x1="2167" x2="2167" y1="50.042" y2="1926.0889"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="229" x="3011" y="1584.5967"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="209" x="3021" y="1605.7354">ç¼–å†™ä¸tokenstreamå¯¹åº”çš„jinja2æ¨¡ç‰ˆ</text><line style="stroke:#000000;stroke-width:1.5;" x1="3005" x2="3005" y1="50.042" y2="1926.0889"/><line style="stroke:#000000;stroke-width:1.5;" x1="3244" x2="3244" y1="50.042" y2="1926.0889"/><line style="stroke:#181818;stroke-width:1.0;" x1="214" x2="214" y1="95.9951" y2="115.9951"/><polygon fill="#181818" points="210,105.9951,214,115.9951,218,105.9951,214,109.9951" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="214" x2="214" y1="546.0732" y2="566.0732"/><polygon fill="#181818" points="210,556.0732,214,566.0732,218,556.0732,214,560.0732" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2081.5" x2="2081.5" y1="474.0732" y2="494.0732"/><polygon fill="#181818" points="2077.5,484.0732,2081.5,494.0732,2085.5,484.0732,2081.5,488.0732" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="214" x2="214" y1="149.9639" y2="168.3115"/><line style="stroke:#181818;stroke-width:1.0;" x1="214" x2="318" y1="168.3115" y2="168.3115"/><line style="stroke:#181818;stroke-width:1.0;" x1="318" x2="318" y1="168.3115" y2="211.6592"/><polygon fill="#181818" points="314,201.6592,318,211.6592,322,201.6592,318,205.6592" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="318" x2="318" y1="245.6279" y2="299.1748"/><line style="stroke:#181818;stroke-width:1.0;" x1="318" x2="1431" y1="299.1748" y2="299.1748"/><line style="stroke:#181818;stroke-width:1.0;" x1="1431" x2="1431" y1="299.1748" y2="345.1553"/><polygon fill="#181818" points="1427,335.1553,1431,345.1553,1435,335.1553,1431,339.1553" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1431" x2="1431" y1="379.124" y2="417.1143"/><line style="stroke:#181818;stroke-width:1.0;" x1="1431" x2="2081.5" y1="417.1143" y2="417.1143"/><line style="stroke:#181818;stroke-width:1.0;" x1="2081.5" x2="2081.5" y1="417.1143" y2="440.1045"/><polygon fill="#181818" points="2077.5,430.1045,2081.5,440.1045,2085.5,430.1045,2081.5,434.1045" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="214" x2="214" y1="600.042" y2="608.1904"/><line style="stroke:#181818;stroke-width:1.0;" x1="214" x2="318" y1="608.1904" y2="608.1904"/><line style="stroke:#181818;stroke-width:1.0;" x1="318" x2="318" y1="608.1904" y2="639.0381"/><polygon fill="#181818" points="314,629.0381,318,639.0381,322,629.0381,318,633.0381" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="318" x2="318" y1="673.0068" y2="785.9346"/><line style="stroke:#181818;stroke-width:1.0;" x1="318" x2="1431" y1="785.9346" y2="785.9346"/><line style="stroke:#181818;stroke-width:1.0;" x1="1431" x2="1431" y1="785.9346" y2="923.8623"/><polygon fill="#181818" points="1427,913.8623,1431,923.8623,1435,913.8623,1431,917.8623" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1431" x2="1431" y1="957.8311" y2="1082.835"/><line style="stroke:#181818;stroke-width:1.0;" x1="1431" x2="2081.5" y1="1082.835" y2="1082.835"/><line style="stroke:#181818;stroke-width:1.0;" x1="2081.5" x2="2081.5" y1="1082.835" y2="1192.8389"/><polygon fill="#181818" points="2077.5,1182.8389,2081.5,1192.8389,2085.5,1182.8389,2081.5,1186.8389" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2081.5" x2="2081.5" y1="1226.8076" y2="1292.7627"/><line style="stroke:#181818;stroke-width:1.0;" x1="2081.5" x2="2847.5" y1="1292.7627" y2="1292.7627"/><line style="stroke:#181818;stroke-width:1.0;" x1="2847.5" x2="2847.5" y1="1292.7627" y2="1383.7178"/><polygon fill="#181818" points="2843.5,1373.7178,2847.5,1383.7178,2851.5,1373.7178,2847.5,1377.7178" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2847.5" x2="2847.5" y1="1417.6865" y2="1508.6416"/><line style="stroke:#181818;stroke-width:1.0;" x1="2847.5" x2="3125.5" y1="1508.6416" y2="1508.6416"/><line style="stroke:#181818;stroke-width:1.0;" x1="3125.5" x2="3125.5" y1="1508.6416" y2="1584.5967"/><polygon fill="#181818" points="3121.5,1574.5967,3125.5,1584.5967,3129.5,1574.5967,3125.5,1578.5967" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="3125.5" x2="3125.5" y1="1618.5654" y2="1676.9541"/><line style="stroke:#181818;stroke-width:1.0;" x1="3125.5" x2="2847.5" y1="1676.9541" y2="1676.9541"/><line style="stroke:#181818;stroke-width:1.0;" x1="2847.5" x2="2847.5" y1="1676.9541" y2="1760.3428"/><polygon fill="#181818" points="2843.5,1750.3428,2847.5,1760.3428,2851.5,1750.3428,2847.5,1754.3428" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="99" x="88" y="66.75">Cargo.toml</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="74" x="496.5" y="66.75">src/lib.rs</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="162" x="1066" y="66.75">examples/è°ƒç”¨ä»£ç </text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="79" x="1787.5" y="66.75">Terminal</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="158" x="2507" y="66.75">src/raw_builder.rs</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="177" x="3036" y="66.75">templates/builder.j2</text></g></svg></figure>
</div>
</div>
<h3 id="cargotomlæ·»åŠ proc-macroå£°æ˜"><a class="header" href="#cargotomlæ·»åŠ proc-macroå£°æ˜">Cargo.tomlæ·»åŠ proc-macroå£°æ˜</a></h3>
<blockquote>
<p>è¿™æ ·ï¼Œç¼–è¯‘å™¨æ‰å…è®¸ä½ ä½¿ç”¨ #[proc_macro] ç›¸å…³çš„å®ã€‚</p>
</blockquote>
<pre><code class="language-toml  editable">[lib]
proc-macro = true
</code></pre>
<h2 id="è¿‡ç¨‹å‡½æ•°å®-proc_macro"><a class="header" href="#è¿‡ç¨‹å‡½æ•°å®-proc_macro">è¿‡ç¨‹å‡½æ•°å®: #[proc_macro]</a></h2>
<blockquote>
<p>å’Œmacro_rules! åŠŸèƒ½ç±»ä¼¼ï¼Œä½†æ›´ä¸ºå¼ºå¤§ã€‚</p>
</blockquote>
<h3 id="srclibrså®šä¹‰è¿‡ç¨‹å‡½æ•°å®"><a class="header" href="#srclibrså®šä¹‰è¿‡ç¨‹å‡½æ•°å®">src/lib.rs:å®šä¹‰è¿‡ç¨‹å‡½æ•°å®</a></h3>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œéƒ½æ˜¯å¤„ç†TokenStream</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">mod builder;
mod builder_with_attr;
mod raw_builder;

use proc_macro::TokenStream;
use raw_builder::BuilderContext;
use syn::{parse_macro_input, DeriveInput};

#[proc_macro]
pub fn query(input: TokenStream) -&gt; TokenStream {
    // åªæœ‰ä¿®æ”¹ä»£ç ä¹‹åå†æ¬¡ç¼–è¯‘æ‰ä¼šæ‰§è¡Œ
    println!(&quot;{:#?}&quot;, input);
    &quot;fn hello() { println!(\&quot;Hello world!\&quot;); }&quot;
        .parse()
        .unwrap()
}

#[proc_macro_derive(RawBuilder)]
pub fn derive_raw_builder(input: TokenStream) -&gt; TokenStream {
    // åªæœ‰ä¿®æ”¹ä»£ç ä¹‹åå†æ¬¡ç¼–è¯‘æ‰ä¼šæ‰§è¡Œ
    println!(&quot;{:#?}&quot;, input);
    BuilderContext::render(input).unwrap().parse().unwrap()
}

#[proc_macro_derive(Builder)]
pub fn derive_builder(input: TokenStream) -&gt; TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    builder::BuilderContext::from(input).render().into()
}

#[proc_macro_derive(BuilderWithAttr, attributes(builder))]
pub fn derive_builder_with_attr(input: TokenStream) -&gt; TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    builder_with_attr::BuilderContext::from(input)
        .render()
        .into()
}
</code></pre></pre>
<div id="admonition-tokenstream" class="admonition info">
<div class="admonition-title">
<p>TokenStream</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-tokenstream"></a></p>
</div>
<div>
<p>ä½¿ç”¨è€…å¯ä»¥é€šè¿‡ query!(â€¦) æ¥è°ƒç”¨ã€‚æˆ‘ä»¬æ‰“å°ä¼ å…¥çš„ TokenStreamï¼Œ
ç„¶åæŠŠä¸€æ®µåŒ…å«åœ¨å­—ç¬¦ä¸²ä¸­çš„ä»£ç è§£ææˆ TokenStream è¿”å›ã€‚</p>
<p>è¿™é‡Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°ç”¨å­—ç¬¦ä¸²çš„ parse() æ–¹æ³•æ¥è·å¾— TokenStreamï¼Œ
æ˜¯å› ä¸º TokenStream å®ç°äº†  FromStr traitã€‚</p>
</div>
</div>
<h3 id="examplesqueryrsä½¿ç”¨"><a class="header" href="#examplesqueryrsä½¿ç”¨">examples/query.rs:ä½¿ç”¨</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use macros::query;

fn main() {
    // query!(SELECT * FROM users WHERE age &gt; 10);
    query!(SELECT * FROM users u JOIN (SELECT * from profiles p) WHERE u.id = p.id);
    hello()
}
</code></pre></pre>
<ol>
<li>.parse().unwrap(): å­—ç¬¦ä¸²è‡ªåŠ¨è½¬ä¸ºTokenStreamç±»å‹</li>
</ol>
<pre><code class="language-shell">cargo run --example query &gt; examples/query_output.txt
</code></pre>
<pre><code class="language-shell">TokenStream [
    Ident {
        ident: &quot;SELECT&quot;,
        span: #0 bytes(94..100),
    },
    Punct {
        ch: '*',
        spacing: Alone,
        span: #0 bytes(101..102),
    },
    Ident {
        ident: &quot;FROM&quot;,
        span: #0 bytes(103..107),
    },
    Ident {
        ident: &quot;users&quot;,
        span: #0 bytes(108..113),
    },
    Ident {
        ident: &quot;u&quot;,
        span: #0 bytes(114..115),
    },
    Ident {
        ident: &quot;JOIN&quot;,
        span: #0 bytes(116..120),
    },
    Group {
        delimiter: Parenthesis,
        stream: TokenStream [
            Ident {
                ident: &quot;SELECT&quot;,
                span: #0 bytes(122..128),
            },
            Punct {
                ch: '*',
                spacing: Alone,
                span: #0 bytes(129..130),
            },
            Ident {
                ident: &quot;from&quot;,
                span: #0 bytes(131..135),
            },
            Ident {
                ident: &quot;profiles&quot;,
                span: #0 bytes(136..144),
            },
            Ident {
                ident: &quot;p&quot;,
                span: #0 bytes(145..146),
            },
        ],
        span: #0 bytes(121..147),
    },
    Ident {
        ident: &quot;WHERE&quot;,
        span: #0 bytes(148..153),
    },
    Ident {
        ident: &quot;u&quot;,
        span: #0 bytes(154..155),
    },
    Punct {
        ch: '.',
        spacing: Alone,
        span: #0 bytes(155..156),
    },
    Ident {
        ident: &quot;id&quot;,
        span: #0 bytes(156..158),
    },
    Punct {
        ch: '=',
        spacing: Alone,
        span: #0 bytes(159..160),
    },
    Ident {
        ident: &quot;p&quot;,
        span: #0 bytes(161..162),
    },
    Punct {
        ch: '.',
        spacing: Alone,
        span: #0 bytes(162..163),
    },
    Ident {
        ident: &quot;id&quot;,
        span: #0 bytes(163..165),
    },
]
Hello world!
</code></pre>
<div id="admonition-tokenstreamæ˜¯ä¸€ä¸ªiteratoré‡Œé¢åŒ…å«ä¸€ç³»åˆ—çš„tokentree" class="admonition tip">
<div class="admonition-title">
<p>TokenStreamæ˜¯ä¸€ä¸ªIteratorï¼Œé‡Œé¢åŒ…å«ä¸€ç³»åˆ—çš„TokenTree</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-tokenstreamæ˜¯ä¸€ä¸ªiteratoré‡Œé¢åŒ…å«ä¸€ç³»åˆ—çš„tokentree"></a></p>
</div>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum TokenTree {
    // ç»„ï¼Œå¦‚æœä»£ç ä¸­åŒ…å«æ‹¬å·ï¼Œæ¯”å¦‚{} [] &lt;&gt; () ï¼Œé‚£ä¹ˆå†…éƒ¨çš„å†…å®¹ä¼šè¢«åˆ†ææˆä¸€ä¸ªGroupï¼ˆç»„ï¼‰
    Group(Group), 
    // æ ‡è¯†ç¬¦
    Ident(Ident),
    // æ ‡ç‚¹ç¬¦å· 
    Punct(Punct),
    // å­—é¢é‡ 
    Literal(Literal), 
}
<span class="boring">}
</span></code></pre></pre>
</div>
</div>
<div id="admonition-group-example" class="admonition info">
<div class="admonition-title">
<p>Group Example</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-group-example"></a></p>
</div>
<div>
<pre><pre class="playground"><code class="language-rust">use macros::query;

fn main() {
    // query!(SELECT * FROM users WHERE age &gt; 10);
    query!(SELECT * FROM users u JOIN (SELECT * from profiles p) WHERE u.id = p.id);
    hello()
}
</code></pre></pre>
</div>
</div>
<h2 id="è¿‡ç¨‹å±æ€§å®-proc_macro_attribute"><a class="header" href="#è¿‡ç¨‹å±æ€§å®-proc_macro_attribute">è¿‡ç¨‹å±æ€§å®: #[proc_macro_attribute]</a></h2>
<blockquote>
<p>ç”¨äºå±æ€§å®ï¼Œ ç”¨åœ¨ç»“æ„ä½“ã€å­—æ®µã€å‡½æ•°ç­‰åœ°æ–¹ï¼Œä¸ºå…¶æŒ‡å®šå±æ€§ç­‰åŠŸèƒ½, ç±»ä¼¼pythonçš„è®¡ç®—å±æ€§</p>
</blockquote>
<h2 id="è¿‡ç¨‹æ´¾ç”Ÿå®-proc_macro_devivederivemacroname"><a class="header" href="#è¿‡ç¨‹æ´¾ç”Ÿå®-proc_macro_devivederivemacroname">è¿‡ç¨‹æ´¾ç”Ÿå®: /#[proc_macro_devive(DeriveMacroName)]</a></h2>
<blockquote>
<p>ç”¨äºç»“æ„ä½“ï¼ˆstructï¼‰ã€æšä¸¾ï¼ˆenumï¼‰ã€è”åˆï¼ˆunionï¼‰ç±»å‹ï¼Œå¯ä¸ºå…¶å®ç°å‡½æ•°æˆ–ç‰¹å¾ï¼ˆTraitï¼‰</p>
</blockquote>
<h3 id="å¸¸ç”¨æ´¾ç”Ÿå®"><a class="header" href="#å¸¸ç”¨æ´¾ç”Ÿå®">å¸¸ç”¨æ´¾ç”Ÿå®</a></h3>
<h4 id="derivedebug"><a class="header" href="#derivedebug">#[derive(Debug)]</a></h4>
<h3 id="åŸå§‹å®ç°builderæ¨¡å¼"><a class="header" href="#åŸå§‹å®ç°builderæ¨¡å¼">åŸå§‹å®ç°builderæ¨¡å¼</a></h3>
<h4 id="æƒ³åˆ°è¾¾åˆ°é“¾å¼è°ƒç”¨çš„æ•ˆæœ"><a class="header" href="#æƒ³åˆ°è¾¾åˆ°é“¾å¼è°ƒç”¨çš„æ•ˆæœ">æƒ³åˆ°è¾¾åˆ°é“¾å¼è°ƒç”¨çš„æ•ˆæœ</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let command = Command::builder()
        .executable(&quot;cargo&quot;.to_owned())
        .args(vec![&quot;build&quot;.to_owned(), &quot;--release&quot;.to_owned()])
        .env(vec![])
        .build()
        .unwrap();
    assert!(command.current_dir.is_none());

    let command = Command::builder()
        .executable(&quot;cargo&quot;.to_owned())
        .args(vec![&quot;build&quot;.to_owned(), &quot;--release&quot;.to_owned()])
        .env(vec![])
        .current_dir(&quot;..&quot;.to_owned())
        .build()
        .unwrap();
    assert!(command.current_dir.is_some());
    println!(&quot;{:?}&quot;, command);
}
</code></pre></pre>
<h4 id="å¯ä»¥è¿™æ ·å®šä¹‰"><a class="header" href="#å¯ä»¥è¿™æ ·å®šä¹‰">å¯ä»¥è¿™æ ·å®šä¹‰</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// è¿™æ˜¯command.rsçš„æ´¾ç”Ÿå®å®ç°çš„ä»£ç æ ·å­
#[allow(dead_code)]
#[derive(Debug)]
pub struct Command {
    executable: String,
    args: Vec&lt;String&gt;,
    env: Vec&lt;String&gt;,
    current_dir: Option&lt;String&gt;,
}

#[derive(Debug, Default)]
pub struct CommandBuilder {
    executable: Option&lt;String&gt;,
    args: Option&lt;Vec&lt;String&gt;&gt;,
    env: Option&lt;Vec&lt;String&gt;&gt;,
    current_dir: Option&lt;String&gt;,
}

impl Command {
    pub fn builder() -&gt; CommandBuilder {
        Default::default()
    }
}

impl CommandBuilder {
    pub fn executable(mut self, v: String) -&gt; Self {
        self.executable = Some(v.to_owned());
        self
    }

    pub fn args(mut self, v: Vec&lt;String&gt;) -&gt; Self {
        self.args = Some(v.to_owned());
        self
    }

    pub fn env(mut self, v: Vec&lt;String&gt;) -&gt; Self {
        self.env = Some(v.to_owned());
        self
    }

    pub fn current_dir(mut self, v: String) -&gt; Self {
        self.current_dir = Some(v.to_owned());
        self
    }

    pub fn build(mut self) -&gt; Result&lt;Command, &amp;'static str&gt; {
        Ok(Command {
            executable: self.executable.take().ok_or(&quot;executable must be set&quot;)?,
            args: self.args.take().ok_or(&quot;args must be set&quot;)?,
            env: self.env.take().ok_or(&quot;env must be set&quot;)?,
            current_dir: self.current_dir.take(),
        })
    }
</code></pre></pre>
<h4 id="ä½†æ˜¯æœ‰ç‚¹ç¹çå¯ä»¥ä½¿ç”¨æ´¾ç”Ÿå®æ´¾ç”Ÿå‡ºè¿™äº›ä»£ç "><a class="header" href="#ä½†æ˜¯æœ‰ç‚¹ç¹çå¯ä»¥ä½¿ç”¨æ´¾ç”Ÿå®æ´¾ç”Ÿå‡ºè¿™äº›ä»£ç ">ä½†æ˜¯æœ‰ç‚¹ç¹çï¼Œå¯ä»¥ä½¿ç”¨æ´¾ç”Ÿå®æ´¾ç”Ÿå‡ºè¿™äº›ä»£ç </a></h4>
<h3 id="æ´¾ç”Ÿå®æ€è·¯"><a class="header" href="#æ´¾ç”Ÿå®æ€è·¯">æ´¾ç”Ÿå®æ€è·¯</a></h3>
<h4 id="è¦ç”Ÿæˆçš„ä»£ç æ¨¡ç‰ˆ"><a class="header" href="#è¦ç”Ÿæˆçš„ä»£ç æ¨¡ç‰ˆ">è¦ç”Ÿæˆçš„ä»£ç æ¨¡ç‰ˆ</a></h4>
<p>æŠŠè¾“å…¥çš„ TokenStream æŠ½å–å‡ºæ¥ï¼Œä¹Ÿå°±æ˜¯æŠŠåœ¨ struct çš„å®šä¹‰å†…éƒ¨ï¼Œæ¯ä¸ªåŸŸçš„åå­—åŠå…¶ç±»å‹éƒ½æŠ½å‡ºæ¥ï¼Œç„¶åç”Ÿæˆå¯¹åº”çš„æ–¹æ³•ä»£ç ã€‚</p>
<pre><pre class="playground"><code class="language-rust  editable">impl {{ name }} {
    pub fn builder() -&gt; {{ builder_name }} {
        Default::default()
    }
}

#[derive(Debug, Default)]
pub struct {{ builder_name }} {
    {% for field in fields %}
        {{ field.name }}: Option&lt;{{ field.ty }}&gt;,
    {% endfor %}
}

impl {{ builder_name }} {
    {% for field in fields %}
    pub fn {{ field.name }}(mut self, v: impl Into&lt;{{ field.ty }}&gt;) -&gt; {{ builder_name }} {
        self.{{ field.name }} = Some(v.into());
        self
    }
    {% endfor %}

    pub fn build(self) -&gt; Result&lt;{{ name }}, &amp;'static str&gt; {
        Ok({{ name }} {
            {% for field in fields %}
                {% if field.optional %}
                {{ field.name }}: self.{{ field.name }},
                {% else %}
                {{ field.name }}: self.{{ field.name }}.ok_or(&quot;Build failed: missing {{ field.name }}&quot;)?,
                {% endif %}
            {% endfor %}
        })
    }
}
</code></pre></pre>
<ol>
<li>7-12: è¿™é‡Œçš„ fileds / builder_name æ˜¯æˆ‘ä»¬è¦ä¼ å…¥çš„å‚æ•°ï¼Œæ¯ä¸ª field è¿˜éœ€è¦ name å’Œ ty ä¸¤ä¸ª å±æ€§ï¼Œåˆ†åˆ«å¯¹åº” field çš„åå­—å’Œç±»å‹</li>
<li>25-26: å¯¹äºåŸæœ¬æ˜¯ Option<T> ç±»å‹çš„åŸŸï¼Œè¦é¿å…ç”Ÿæˆ Option<Option>ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ˜¯å¦æ˜¯ Option å•ç‹¬æŠ½å–å‡ºæ¥ï¼Œå¦‚æœæ˜¯ Option<T>ï¼Œé‚£ä¹ˆ ty å°±æ˜¯ Tã€‚æ‰€ä»¥ï¼Œfield è¿˜éœ€è¦ä¸€ä¸ªå± æ€§
optionalã€‚</li>
</ol>
<h4 id="æ„å»ºå¯¹åº”æ•°æ®ç»“æ„"><a class="header" href="#æ„å»ºå¯¹åº”æ•°æ®ç»“æ„">æ„å»ºå¯¹åº”æ•°æ®ç»“æ„</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">struct Fd {
    name: Ident,
    ty: Type,
    optional: bool,
}
</code></pre></pre>
<h4 id="srclibrs-ä½¿ç”¨æ´¾ç”Ÿå®ä»tokenstreamæŠ½å–å‡ºæƒ³è¦çš„ä¿¡æ¯"><a class="header" href="#srclibrs-ä½¿ç”¨æ´¾ç”Ÿå®ä»tokenstreamæŠ½å–å‡ºæƒ³è¦çš„ä¿¡æ¯">src/lib.rs: ä½¿ç”¨æ´¾ç”Ÿå®ä»TokenStreamæŠ½å–å‡ºæƒ³è¦çš„ä¿¡æ¯</a></h4>
<blockquote>
<p>å¯¹äº derive macroï¼Œè¦ä½¿ç”¨ proce_macro_derive è¿™ä¸ªå®ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ª derive macro å‘½åä¸º Builderã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">#[proc_macro_derive(Builder)]
pub fn derive_builder(input: TokenStream) -&gt; TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    builder::BuilderContext::from(input).render().into()
}
</code></pre></pre>
<h4 id="examplescommandrs-ä½¿ç”¨è¿™ä¸ªæ´¾ç”Ÿå®æŠ½å–"><a class="header" href="#examplescommandrs-ä½¿ç”¨è¿™ä¸ªæ´¾ç”Ÿå®æŠ½å–">examples/command.rs: ä½¿ç”¨è¿™ä¸ªæ´¾ç”Ÿå®æŠ½å–</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">use macros::Builder;

#[allow(dead_code)]
#[derive(Debug, Builder)]
pub struct Command {
    executable: String,
    args: Vec&lt;String&gt;,
    env: Vec&lt;String&gt;,
    current_dir: Option&lt;String&gt;,
}

fn main() {
    let command = Command::builder()
        .executable(&quot;cargo&quot;.to_owned())
        .args(vec![&quot;build&quot;.to_owned(), &quot;--release&quot;.to_owned()])
        .env(vec![])
        .build()
        .unwrap();
    assert!(command.current_dir.is_none());

    let command = Command::builder()
        .executable(&quot;cargo&quot;.to_owned())
        .args(vec![&quot;build&quot;.to_owned(), &quot;--release&quot;.to_owned()])
        .env(vec![])
        .current_dir(&quot;..&quot;.to_owned())
        .build()
        .unwrap();
    assert!(command.current_dir.is_some());
    println!(&quot;{:?}&quot;, command);
}
</code></pre></pre>
<h4 id="è¿è¡ŒæŸ¥çœ‹è·å–çš„tokenstream"><a class="header" href="#è¿è¡ŒæŸ¥çœ‹è·å–çš„tokenstream">è¿è¡Œï¼ŒæŸ¥çœ‹è·å–çš„TokenStream</a></h4>
<pre><code class="language-shell">cargo run --example raw_command &gt; examples/raw_command_output.txt
</code></pre>
<pre><code class="language-shell">TokenStream [
    Punct {
        ch: '#',
        spacing: Alone,
        span: #0 bytes(25..26),
    },
    Group {
        delimiter: Bracket,
        stream: TokenStream [
            Ident {
                ident: &quot;allow&quot;,
                span: #0 bytes(27..32),
            },
            Group {
                delimiter: Parenthesis,
                stream: TokenStream [
                    Ident {
                        ident: &quot;dead_code&quot;,
                        span: #0 bytes(33..42),
                    },
                ],
                span: #0 bytes(32..43),
            },
        ],
        span: #0 bytes(26..44),
    },
    Ident {
        ident: &quot;pub&quot;,
        span: #0 bytes(74..77),
    },
    Ident {
        ident: &quot;struct&quot;,
        span: #0 bytes(78..84),
    },
    Ident {
        ident: &quot;Command&quot;,
        span: #0 bytes(85..92),
    },
    Group {
        delimiter: Brace,
        stream: TokenStream [
            Ident {
                ident: &quot;executable&quot;,
                span: #0 bytes(99..109),
            },
            Punct {
                ch: ':',
                spacing: Alone,
                span: #0 bytes(109..110),
            },
            Ident {
                ident: &quot;String&quot;,
                span: #0 bytes(111..117),
            },
            Punct {
                ch: ',',
                spacing: Alone,
                span: #0 bytes(117..118),
            },
            Ident {
                ident: &quot;args&quot;,
                span: #0 bytes(123..127),
            },
            Punct {
                ch: ':',
                spacing: Alone,
                span: #0 bytes(127..128),
            },
            Ident {
                ident: &quot;Vec&quot;,
                span: #0 bytes(129..132),
            },
            Punct {
                ch: '&lt;',
                spacing: Alone,
                span: #0 bytes(132..133),
            },
            Ident {
                ident: &quot;String&quot;,
                span: #0 bytes(133..139),
            },
            Punct {
                ch: '&gt;',
                spacing: Joint,
                span: #0 bytes(139..140),
            },
            Punct {
                ch: ',',
                spacing: Alone,
                span: #0 bytes(140..141),
            },
            Ident {
                ident: &quot;env&quot;,
                span: #0 bytes(146..149),
            },
            Punct {
                ch: ':',
                spacing: Alone,
                span: #0 bytes(149..150),
            },
            Ident {
                ident: &quot;Vec&quot;,
                span: #0 bytes(151..154),
            },
            Punct {
                ch: '&lt;',
                spacing: Alone,
                span: #0 bytes(154..155),
            },
            Ident {
                ident: &quot;String&quot;,
                span: #0 bytes(155..161),
            },
            Punct {
                ch: '&gt;',
                spacing: Joint,
                span: #0 bytes(161..162),
            },
            Punct {
                ch: ',',
                spacing: Alone,
                span: #0 bytes(162..163),
            },
            Ident {
                ident: &quot;current_dir&quot;,
                span: #0 bytes(168..179),
            },
            Punct {
                ch: ':',
                spacing: Alone,
                span: #0 bytes(179..180),
            },
            Ident {
                ident: &quot;Option&quot;,
                span: #0 bytes(181..187),
            },
            Punct {
                ch: '&lt;',
                spacing: Alone,
                span: #0 bytes(187..188),
            },
            Ident {
                ident: &quot;String&quot;,
                span: #0 bytes(188..194),
            },
            Punct {
                ch: '&gt;',
                spacing: Joint,
                span: #0 bytes(194..195),
            },
            Punct {
                ch: ',',
                spacing: Alone,
                span: #0 bytes(195..196),
            },
        ],
        span: #0 bytes(93..198),
    },
]
Command { executable: &quot;cargo&quot;, args: [&quot;build&quot;, &quot;--release&quot;], env: [], current_dir: Some(&quot;..&quot;) }
</code></pre>
<div id="admonition-æ‰“å°ä¿¡æ¯è¯´æ˜" class="admonition info">
<div class="admonition-title">
<p>æ‰“å°ä¿¡æ¯è¯´æ˜</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-æ‰“å°ä¿¡æ¯è¯´æ˜"></a></p>
</div>
<div>
<ol>
<li>
<p>é¦–å…ˆæœ‰ä¸€ä¸ª Groupï¼ŒåŒ…å«äº† #[allow(dead_code)] å±æ€§çš„ä¿¡æ¯ã€‚å› ä¸ºæˆ‘ä»¬ç°åœ¨æ‹¿åˆ° çš„ derive ä¸‹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æ‰€æœ‰ä¸å±äº #[derive(â€¦)] çš„å±æ€§ï¼Œéƒ½ä¼šè¢«æ”¾å…¥ TokenStream ä¸­ã€‚</p>
</li>
<li>
<p>ä¹‹åæ˜¯ pub / struct / Command ä¸‰ä¸ª identã€‚</p>
</li>
<li>
<p>éšååˆæ˜¯ä¸€ä¸ª Groupï¼ŒåŒ…å«äº†æ¯ä¸ª field çš„ä¿¡æ¯ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œfield ä¹‹é—´ç”¨é€—å·è¿™ä¸ª Punct åˆ†éš”ï¼Œfield çš„åå­—å’Œç±»å‹åˆæ˜¯é€šè¿‡å†’å·è¿™ä¸ª Punct åˆ†éš”ã€‚è€Œç±»å‹ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ª Identï¼Œå¦‚ Stringï¼Œæˆ–è€…ä¸€ç³»åˆ— Ident / Punctï¼Œå¦‚ Vec / &lt; / String / &gt;ã€‚</p>
</li>
</ol>
</div>
</div>
<h4 id="srcraw_builderrs-ä½¿ç”¨anyhowä¸askamaæŠ½å–tokenstreamä¸­çš„ä¿¡æ¯"><a class="header" href="#srcraw_builderrs-ä½¿ç”¨anyhowä¸askamaæŠ½å–tokenstreamä¸­çš„ä¿¡æ¯">src/raw_builder.rs: ä½¿ç”¨anyhowä¸askamaæŠ½å–TokenStreamä¸­çš„ä¿¡æ¯</a></h4>
<blockquote>
<p>æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼ŒæŠŠè¿™ä¸ª TokenStream ä¸­çš„ struct åå­—ï¼Œä»¥åŠæ¯ä¸ª field çš„åå­—å’Œç±»å‹æ‹¿å‡ºæ¥ã€‚
å¦‚æœç±»å‹æ˜¯ Option<T>ï¼Œé‚£ä¹ˆæŠŠ T æ‹¿å‡ºæ¥ï¼ŒæŠŠ optional è®¾ç½®ä¸º trueã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">use anyhow::Result;
use askama::Template;
use proc_macro::{Ident, TokenStream, TokenTree};
use std::collections::VecDeque;

/// å¤„ç† jinja æ¨¡æ¿çš„æ•°æ®ç»“æ„ï¼Œåœ¨æ¨¡æ¿ä¸­æˆ‘ä»¬ä½¿ç”¨äº† name / builder_name / fields
#[derive(Template)]
#[template(path = &quot;builder.j2&quot;, escape = &quot;none&quot;)]
pub struct BuilderContext {
    name: String,
    builder_name: String,
    fields: Vec&lt;Fd&gt;,
}

/// æè¿° struct çš„æ¯ä¸ª field
#[derive(Debug, Default)]
struct Fd {
    name: String,
    ty: String,
    optional: bool,
}
</code></pre></pre>
<h4 id="templatesbuilderj2-ä¸Šé¢askamaç”¨åˆ°çš„jinja2æ¨¡ç‰ˆ"><a class="header" href="#templatesbuilderj2-ä¸Šé¢askamaç”¨åˆ°çš„jinja2æ¨¡ç‰ˆ">templates/builder.j2: ä¸Šé¢askamaç”¨åˆ°çš„jinja2æ¨¡ç‰ˆ</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">impl {{ name }} {
    pub fn builder() -&gt; {{ builder_name }} {
        Default::default()
    }
}

#[derive(Debug, Default)]
pub struct {{ builder_name }} {
    {% for field in fields %}
        {{ field.name }}: Option&lt;{{ field.ty }}&gt;,
    {% endfor %}
}

impl {{ builder_name }} {
    {% for field in fields %}
    pub fn {{ field.name }}(mut self, v: impl Into&lt;{{ field.ty }}&gt;) -&gt; {{ builder_name }} {
        self.{{ field.name }} = Some(v.into());
        self
    }
    {% endfor %}

    pub fn build(self) -&gt; Result&lt;{{ name }}, &amp;'static str&gt; {
        Ok({{ name }} {
            {% for field in fields %}
                {% if field.optional %}
                {{ field.name }}: self.{{ field.name }},
                {% else %}
                {{ field.name }}: self.{{ field.name }}.ok_or(&quot;Build failed: missing {{ field.name }}&quot;)?,
                {% endif %}
            {% endfor %}
        })
    }
}
</code></pre></pre>
<h4 id="srcraw_builderrs-å®ç°å¯¹åº”æŠ½å–æ–¹æ³•"><a class="header" href="#srcraw_builderrs-å®ç°å¯¹åº”æŠ½å–æ–¹æ³•">src/raw_builder.rs: å®ç°å¯¹åº”æŠ½å–æ–¹æ³•</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">impl Fd {
    /// name å’Œ field éƒ½æ˜¯é€šè¿‡å†’å· Punct åˆ‡åˆ†å‡ºæ¥çš„ TokenTree åˆ‡ç‰‡
    pub fn new(name: &amp;[TokenTree], ty: &amp;[TokenTree]) -&gt; Self {
        // æŠŠç±»ä¼¼ Ident(&quot;Option&quot;), Punct('&lt;'), Ident(&quot;String&quot;), Punct('&gt;) çš„ ty
        // æ”¶é›†æˆä¸€ä¸ª String åˆ—è¡¨ï¼Œå¦‚ vec![&quot;Option&quot;, &quot;&lt;&quot;, &quot;String&quot;, &quot;&gt;&quot;]
        let ty = ty
            .iter()
            .map(|v| match v {
                TokenTree::Ident(n) =&gt; n.to_string(),
                TokenTree::Punct(p) =&gt; p.as_char().to_string(),
                e =&gt; panic!(&quot;Expect ident, got {:?}&quot;, e),
            })
            .collect::&lt;Vec&lt;_&gt;&gt;();
        // å†’å·å‰æœ€åä¸€ä¸ª TokenTree æ˜¯ field çš„åå­—
        // æ¯”å¦‚ï¼šexecutable: String,
        // æ³¨æ„è¿™é‡Œä¸åº”è¯¥ç”¨ name[0]ï¼Œå› ä¸ºæœ‰å¯èƒ½æ˜¯ pub executable: String
        // ç”šè‡³ï¼Œå¸¦ attributes çš„ fieldï¼Œ
        // æ¯”å¦‚ï¼š#[builder(hello = world)] pub executable: String
        match name.last() {
            Some(TokenTree::Ident(name)) =&gt; {
                // å¦‚æœ ty ç¬¬ 0 é¡¹æ˜¯ Optionï¼Œé‚£ä¹ˆä»ç¬¬äºŒé¡¹å–åˆ°å€’æ•°ç¬¬ä¸€é¡¹
                // å–å®Œåä¸Šé¢çš„ä¾‹å­ä¸­çš„ ty ä¼šå˜æˆ [&quot;String&quot;]ï¼Œoptiona = true
                let (ty, optional) = if ty[0].as_str() == &quot;Option&quot; {
                    (&amp;ty[2..ty.len() - 1], true)
                } else {
                    (&amp;ty[..], false)
                };
                Self {
                    name: name.to_string(),
                    ty: ty.join(&quot;&quot;), // æŠŠ ty join æˆå­—ç¬¦ä¸²
                    optional,
                }
            }
            e =&gt; panic!(&quot;Expect ident, got {:?}&quot;, e),
        }
    }
}

impl BuilderContext {
    /// ä» TokenStream ä¸­æå–ä¿¡æ¯ï¼Œæ„å»º BuilderContext
    fn new(input: TokenStream) -&gt; Self {
        let (name, input) = split(input);
        let fields = get_struct_fields(input);
        Self {
            builder_name: format!(&quot;{}Builder&quot;, name),
            name: name.to_string(),
            fields,
        }
    }

    /// æŠŠæ¨¡æ¿æ¸²æŸ“æˆå­—ç¬¦ä¸²ä»£ç 
    pub fn render(input: TokenStream) -&gt; Result&lt;String&gt; {
        let template = Self::new(input);
        Ok(template.render()?)
    }
}

/// æŠŠ TokenStream åˆ†å‡º struct çš„åå­—ï¼Œå’ŒåŒ…å« fields çš„ TokenStream
fn split(input: TokenStream) -&gt; (Ident, TokenStream) {
    let mut input = input.into_iter().collect::&lt;VecDeque&lt;_&gt;&gt;();
    // ä¸€ç›´å¾€åæ‰¾ï¼Œæ‰¾åˆ° struct åœä¸‹æ¥
    while let Some(item) = input.pop_front() {
        if let TokenTree::Ident(v) = item {
            if v.to_string() == &quot;struct&quot; {
                break;
            }
        }
    }

    // struct åé¢ï¼Œåº”è¯¥æ˜¯ struct name
    let ident;
    if let Some(TokenTree::Ident(v)) = input.pop_front() {
        ident = v;
    } else {
        panic!(&quot;Didn't find struct name&quot;);
    }

    // struct åé¢å¯èƒ½è¿˜æœ‰è‹¥å¹² TokenTreeï¼Œæˆ‘ä»¬ä¸ç®¡ï¼Œä¸€è·¯æ‰¾åˆ°ç¬¬ä¸€ä¸ª Group
    let mut group = None;
    for item in input {
        if let TokenTree::Group(g) = item {
            group = Some(g);
            break;
        }
    }

    (ident, group.expect(&quot;Didn't find field group&quot;).stream())
}

/// ä»åŒ…å« fields çš„ TokenStream ä¸­åˆ‡å‡ºæ¥ä¸€ä¸ªä¸ª Fd
fn get_struct_fields(input: TokenStream) -&gt; Vec&lt;Fd&gt; {
    let input = input.into_iter().collect::&lt;Vec&lt;_&gt;&gt;();
    input
        .split(|v| match v {
            // å…ˆç”¨ ',' åˆ‡å‡ºæ¥ä¸€ä¸ªä¸ªåŒ…å« field æ‰€æœ‰ä¿¡æ¯çš„ &amp;[TokenTree]
            TokenTree::Punct(p) =&gt; p.as_char() == ',',
            _ =&gt; false,
        })
        .map(|tokens| {
            tokens
                .split(|v| match v {
                    // å†ç”¨ ':' æŠŠ &amp;[TokenTree] åˆ‡æˆ [&amp;[TokenTree], &amp;[TokenTree]]
                    // å®ƒä»¬åˆ†åˆ«å¯¹åº”åå­—å’Œç±»å‹
                    TokenTree::Punct(p) =&gt; p.as_char() == ':',
                    _ =&gt; false,
                })
                .collect::&lt;Vec&lt;_&gt;&gt;()
        })
        // æ­£å¸¸æƒ…å†µä¸‹ï¼Œåº”è¯¥å¾—åˆ° [&amp;[TokenTree], &amp;[TokenTree]]ï¼Œå¯¹äºåˆ‡å‡ºæ¥é•¿åº¦ä¸ä¸º 2 çš„ç»Ÿç»Ÿè¿‡æ»¤æ‰
        .filter(|tokens| tokens.len() == 2)
        // ä½¿ç”¨ Fd::new åˆ›å»ºå‡ºæ¯ä¸ª Fd
        .map(|tokens| Fd::new(tokens[0], tokens[1]))
        .collect()
}
</code></pre></pre>
<div id="admonition-tip" class="admonition tip">
<div class="admonition-title">
<p>Tip</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-tip"></a></p>
</div>
<div>
<p>å¯ä»¥å¯¹ç€æ‰“å°å‡ºæ¥çš„ TokenStream å’Œåˆšæ‰çš„åˆ†æè¿›è¡Œç†è§£ã€‚
æ ¸å¿ƒçš„å°±æ˜¯ get_struct_fields() æ–¹æ³•ï¼Œå¦‚æœè§‰å¾—éš¾æ‡‚ï¼Œ
å¯ä»¥æƒ³æƒ³å¦‚æœè¦æŠŠä¸€ä¸ª a=1,b=2 çš„å­—ç¬¦ä¸²åˆ‡æˆ [[a, 1], [b, 2]] è¯¥æ€ä¹ˆåšï¼Œå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="v-å¹¶å‘ä¸å¼‚æ­¥"><a class="header" href="#v-å¹¶å‘ä¸å¼‚æ­¥">V å¹¶å‘ä¸å¼‚æ­¥</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vi-æ··åˆç¼–ç¨‹"><a class="header" href="#vi-æ··åˆç¼–ç¨‹">VI æ··åˆç¼–ç¨‹</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kv-serverè®¾è®¡ä¸å®ç°"><a class="header" href="#kv-serverè®¾è®¡ä¸å®ç°">KV Serverè®¾è®¡ä¸å®ç°</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥webæ¡†æ¶"><a class="header" href="#æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥webæ¡†æ¶">æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="checklist"><a class="header" href="#checklist">Checklist</a></h1>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->


                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">

    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

        <script type="text/javascript">
            window.addEventListener('load', function () {
                MathJax.Hub.Register.StartupHook('End', function () {
                    window.setTimeout(window.print, 100);
                });
            });
        </script>
</body>
</html>
