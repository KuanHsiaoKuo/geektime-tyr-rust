<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>Anatomy In First Rust Programming Class ğŸ¦€</title>
        <meta name="robots" content="noindex"/>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="æºç è§£æé€»è¾‘"><a class="header" href="#æºç è§£æé€»è¾‘">æºç è§£æé€»è¾‘</a></h1>
<!--ts-->
<ul>
<li><a href="anatomy_logic.html#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E9%80%BB%E8%BE%91">æºç è§£æé€»è¾‘</a>
<ul>
<li><a href="anatomy_logic.html#%E9%A1%B9%E7%9B%AE%E6%96%87%E6%A1%A3">é¡¹ç›®æ–‡æ¡£</a>
<ul>
<li><a href="anatomy_logic.html#%E6%9D%A5%E6%BA%90">æ¥æº</a></li>
<li><a href="anatomy_logic.html#cargo-doc%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8">cargo docå‘½ä»¤ä½¿ç”¨</a>
<ul>
<li><a href="anatomy_logic.html#--open">â€“open</a></li>
<li><a href="anatomy_logic.html#--no-deps">â€“no-deps</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#%E4%BD%BF%E7%94%A8%E5%8C%BA%E5%88%AB">ä½¿ç”¨åŒºåˆ«</a></li>
<li><a href="anatomy_logic.html#%E4%BD%BF%E7%94%A8%E7%BB%86%E8%8A%82">ä½¿ç”¨ç»†èŠ‚</a>
<ul>
<li><a href="anatomy_logic.html#crates">Crates</a></li>
<li><a href="anatomy_logic.html#crate%E5%8C%85%E5%90%AB%E6%88%90%E5%91%98">crateåŒ…å«æˆå‘˜</a></li>
<li><a href="anatomy_logic.html#re-exports">Re-exports</a></li>
<li><a href="anatomy_logic.html#modules">Modules</a></li>
<li><a href="anatomy_logic.html#macros">Macros</a></li>
<li><a href="anatomy_logic.html#derive-macros">Derive Macros</a></li>
<li><a href="anatomy_logic.html#attribute-macros">Attribute Macros</a></li>
<li><a href="anatomy_logic.html#structs">Structs</a>
<ul>
<li><a href="anatomy_logic.html#definition">Definition</a></li>
<li><a href="anatomy_logic.html#associated-types">Associated Types</a></li>
<li><a href="anatomy_logic.html#implementations">Implementations</a></li>
<li><a href="anatomy_logic.html#trait-implementations">Trait Implementations</a></li>
<li><a href="anatomy_logic.html#auto-trait-implementations">Auto Trait Implementations</a></li>
<li><a href="anatomy_logic.html#blanket-implementations">Blanket Implementations</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#enums">Enums</a>
<ul>
<li><a href="anatomy_logic.html#definition-1">Definition</a></li>
<li><a href="anatomy_logic.html#variants">Variants</a></li>
<li><a href="anatomy_logic.html#trait-implementations-1">Trait Implementations</a></li>
<li><a href="anatomy_logic.html#auto-trait-implementations-1">Auto Trait Implementations</a></li>
<li><a href="anatomy_logic.html#blanket-implementations-1">Blanket Implementations</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#constants">Constants</a></li>
<li><a href="anatomy_logic.html#traits">Traits</a>
<ul>
<li><a href="anatomy_logic.html#definition-2">Definition</a></li>
<li><a href="anatomy_logic.html#required-methods">Required methods</a></li>
<li><a href="anatomy_logic.html#implementations-on-foreign-types">Implementations on Foreign Types</a></li>
<li><a href="anatomy_logic.html#implementors">Implementors</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#functions">Functions</a>
<ul>
<li><a href="anatomy_logic.html#definition-3">Definition</a></li>
</ul>
</li>
<li><a href="anatomy_logic.html#type-definitions">Type Definitions</a>
<ul>
<li><a href="anatomy_logic.html#definition-4">Definition</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:43:59 UTC 2022 -->
<!--te-->
<h2 id="é¡¹ç›®æ–‡æ¡£"><a class="header" href="#é¡¹ç›®æ–‡æ¡£">é¡¹ç›®æ–‡æ¡£</a></h2>
<h3 id="æ¥æº"><a class="header" href="#æ¥æº">æ¥æº</a></h3>
<ol>
<li>ç¬¬ä¸‰æ–¹crateå¯ä»¥åœ¨<a href="https://docs.rs/">å®˜æ–¹æ–‡æ¡£</a>ä¸Šé¢æœç´¢</li>
<li>æœ¬åœ°crateå¯ä»¥ä½¿ç”¨å‘½ä»¤<code>cargo doc --open</code>.</li>
</ol>
<h3 id="cargo-docå‘½ä»¤ä½¿ç”¨"><a class="header" href="#cargo-docå‘½ä»¤ä½¿ç”¨">cargo docå‘½ä»¤ä½¿ç”¨</a></h3>
<blockquote>
<p><a href="https://doc.rust-lang.org/cargo/commands/cargo-doc.html">æ›´å¤šå†…å®¹</a></p>
</blockquote>
<h4 id="open"><a class="header" href="#open">â€“open</a></h4>
<p>è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£å¹¶åœ¨æµè§ˆå™¨æ‰“å¼€</p>
<h4 id="no-deps"><a class="header" href="#no-deps">â€“no-deps</a></h4>
<p>é»˜è®¤æƒ…å†µä¸‹ä¼šæŠŠé¡¹ç›®ä¾èµ–çš„åŒ…æ–‡æ¡£ä¹Ÿç”Ÿæˆï¼Œè¿™ä¹Ÿæ˜¯æ–‡æ¡£å·¦ä¾§Cratesçš„æ¥æºä¹‹ä¸€ã€‚
è¿™ä¸ªå‚æ•°å¯ä»¥å±è”½æ‰ä¾èµ–çš„crates</p>
<h3 id="ä½¿ç”¨åŒºåˆ«"><a class="header" href="#ä½¿ç”¨åŒºåˆ«">ä½¿ç”¨åŒºåˆ«</a></h3>
<ol>
<li>äºŒè€…å†…å®¹æ²¡æœ‰åŒºåˆ«ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ˜¯æ‰§è¡Œå‘½ä»¤ç”Ÿæˆæ–‡æ¡£ã€‚</li>
<li>å®˜æ–¹æ–‡æ¡£è¿˜å¯ä»¥æä¾›å¾ˆå¤šç»†èŠ‚ï¼Œæ¯”å¦‚gitåˆ†æ”¯åœ°å€</li>
</ol>
<h3 id="ä½¿ç”¨ç»†èŠ‚"><a class="header" href="#ä½¿ç”¨ç»†èŠ‚">ä½¿ç”¨ç»†èŠ‚</a></h3>
<blockquote>
<p>è¿™é‡ŒæŒ‰ç…§æ–‡æ¡£çš„å±‚çº§è¿›è¡Œé€’è¿›è¯´æ˜</p>
</blockquote>
<h4 id="crates"><a class="header" href="#crates">Crates</a></h4>
<p>æ‰€æœ‰æ–‡æ¡£çš„é¦–é¡µéƒ½ä¼šæœ‰è¿™ä¸€é¡¹ï¼Œåˆ—å‡ºé¡¹ç›®åŒ…å«çš„crate</p>
<h4 id="crateåŒ…å«æˆå‘˜"><a class="header" href="#crateåŒ…å«æˆå‘˜">crateåŒ…å«æˆå‘˜</a></h4>
<blockquote>
<p>ç‚¹å‡»Cratesä¸‹çš„æŸä¸ªcrateï¼Œå³ä¾§é¡µé¢å°±ä¼šæ˜¾ç¤ºå½“å‰crateåŒ…å«çš„å…ƒç´ ï¼Œ ä¸»è¦æœ‰ä¸‹åˆ—å†…å®¹</p>
</blockquote>
<ul>
<li>Re-exports</li>
<li>Modules</li>
<li>Macros</li>
<li>Derive Macros</li>
<li>Attribute Macros</li>
<li>Structs</li>
<li>Enums</li>
<li>Constants</li>
<li>Traits</li>
<li>Functions</li>
<li>Type Definitions</li>
</ul>
<h4 id="re-exports"><a class="header" href="#re-exports">Re-exports</a></h4>
<blockquote>
<p>futures_util</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub use reader::DecompressorCustomIo;
<span class="boring">}
</span></code></pre></pre>
<h4 id="modules"><a class="header" href="#modules">Modules</a></h4>
<p>å…¶å®å°±æ˜¯modï¼Œç‚¹å‡»ä¹‹åå°†ä¼šåˆ—å‡ºæŸä¸ªmodé‡Œé¢çš„æˆå‘˜</p>
<h4 id="macros"><a class="header" href="#macros">Macros</a></h4>
<h4 id="derive-macros"><a class="header" href="#derive-macros">Derive Macros</a></h4>
<blockquote>
<p>darling_macroã€clap_derive</p>
</blockquote>
<h4 id="attribute-macros"><a class="header" href="#attribute-macros">Attribute Macros</a></h4>
<blockquote>
<p>tokio_macrosã€futures_macro</p>
</blockquote>
<h4 id="structs"><a class="header" href="#structs">Structs</a></h4>
<h5 id="definition"><a class="header" href="#definition">Definition</a></h5>
<h5 id="associated-types"><a class="header" href="#associated-types">Associated Types</a></h5>
<h5 id="implementations"><a class="header" href="#implementations">Implementations</a></h5>
<h5 id="trait-implementations"><a class="header" href="#trait-implementations">Trait Implementations</a></h5>
<h5 id="auto-trait-implementations"><a class="header" href="#auto-trait-implementations">Auto Trait Implementations</a></h5>
<h5 id="blanket-implementations"><a class="header" href="#blanket-implementations">Blanket Implementations</a></h5>
<h4 id="enums"><a class="header" href="#enums">Enums</a></h4>
<h5 id="definition-1"><a class="header" href="#definition-1">Definition</a></h5>
<h5 id="variants"><a class="header" href="#variants">Variants</a></h5>
<h5 id="trait-implementations-1"><a class="header" href="#trait-implementations-1">Trait Implementations</a></h5>
<h5 id="auto-trait-implementations-1"><a class="header" href="#auto-trait-implementations-1">Auto Trait Implementations</a></h5>
<h5 id="blanket-implementations-1"><a class="header" href="#blanket-implementations-1">Blanket Implementations</a></h5>
<h4 id="constants"><a class="header" href="#constants">Constants</a></h4>
<h4 id="traits"><a class="header" href="#traits">Traits</a></h4>
<h5 id="definition-2"><a class="header" href="#definition-2">Definition</a></h5>
<h5 id="required-methods"><a class="header" href="#required-methods">Required methods</a></h5>
<h5 id="implementations-on-foreign-types"><a class="header" href="#implementations-on-foreign-types">Implementations on Foreign Types</a></h5>
<h5 id="implementors"><a class="header" href="#implementors">Implementors</a></h5>
<h4 id="functions"><a class="header" href="#functions">Functions</a></h4>
<h5 id="definition-3"><a class="header" href="#definition-3">Definition</a></h5>
<h4 id="type-definitions"><a class="header" href="#type-definitions">Type Definitions</a></h4>
<h5 id="definition-4"><a class="header" href="#definition-4">Definition</a></h5>
<blockquote>
<p>html2md</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub type BoxedError = Box&lt;dyn Error + Send + Sync&gt;;
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gdblldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„"><a class="header" href="#gdblldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„">gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></h1>
<!--ts-->
<ul>
<li><a href="intro_gdb_lldb.html#gdblldb%E8%B0%83%E8%AF%95%E6%88%96%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84">gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a>
<ul>
<li><a href="intro_gdb_lldb.html#%E8%B5%84%E6%96%99%E6%95%B4%E7%90%86">èµ„æ–™æ•´ç†</a>
<ul>
<li><a href="intro_gdb_lldb.html#%E5%AE%98%E6%96%B9%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84cheat-sheet">å®˜æ–¹æ•°æ®ç»“æ„cheat sheet</a></li>
</ul>
</li>
<li><a href="intro_gdb_lldb.html#%E6%9F%A5%E7%9C%8Bhashmap%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84">æŸ¥çœ‹hashmapå†…å­˜ç»“æ„</a>
<ul>
<li><a href="intro_gdb_lldb.html#bin%E9%85%8D%E7%BD%AE%E4%B8%8E%E8%BF%90%E8%A1%8C">biné…ç½®ä¸è¿è¡Œ</a></li>
<li><a href="intro_gdb_lldb.html#%E7%9B%AE%E6%A0%87%E8%B0%83%E8%AF%95%E4%BB%A3%E7%A0%81">ç›®æ ‡è°ƒè¯•ä»£ç </a></li>
<li><a href="intro_gdb_lldb.html#%E4%BD%BF%E7%94%A8gdblldb%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84">ä½¿ç”¨gdb/lldbè¿›è¡Œè°ƒè¯•æŸ¥çœ‹å†…å­˜ç»“æ„</a>
<ul>
<li><a href="intro_gdb_lldb.html#gdb-%E4%B8%BB%E8%A6%81%E6%98%AFlinux%E7%B3%BB%E7%BB%9F">gdb: ä¸»è¦æ˜¯linuxç³»ç»Ÿ</a></li>
<li><a href="intro_gdb_lldb.html#lldb-%E4%B8%BB%E8%A6%81osx%E7%B3%BB%E7%BB%9F">lldb: ä¸»è¦OSXç³»ç»Ÿ</a></li>
<li><a href="intro_gdb_lldb.html#idea">IDEA</a></li>
<li><a href="intro_gdb_lldb.html#gdb%E4%B8%8Elldb%E5%91%BD%E4%BB%A4%E5%AF%B9%E7%85%A7">gdbä¸lldbå‘½ä»¤å¯¹ç…§</a></li>
<li><a href="intro_gdb_lldb.html#%E5%BC%80%E5%A7%8B%E8%B0%83%E8%AF%95">å¼€å§‹è°ƒè¯•</a></li>
<li><a href="intro_gdb_lldb.html#breakpoint-%E6%B7%BB%E5%8A%A0%E6%96%AD%E7%82%B9">b(reakpoint): æ·»åŠ æ–­ç‚¹</a></li>
<li><a href="intro_gdb_lldb.html#run%E8%BF%90%E8%A1%8C%E5%88%B0%E6%96%AD%E7%82%B9">r(un):è¿è¡Œåˆ°æ–­ç‚¹</a></li>
<li><a href="intro_gdb_lldb.html#continue%E7%BB%A7%E7%BB%AD%E5%8D%95%E6%AD%A5%E6%89%A7%E8%A1%8C">c(ontinue):ç»§ç»­å•æ­¥æ‰§è¡Œ</a></li>
<li><a href="intro_gdb_lldb.html#x-%E6%89%93%E5%8D%B0%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80">x: æ‰“å°å†…å­˜åœ°å€</a></li>
<li><a href="intro_gdb_lldb.html#continue-%E7%BB%A7%E7%BB%AD%E6%89%A7%E8%A1%8C%E5%88%B0%E4%B8%8B%E4%B8%80%E4%B8%AA%E6%96%AD%E7%82%B9">c(ontinue): ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="intro_gdb_lldb.html#%E6%9F%A5%E7%9C%8B%E9%97%AD%E5%8C%85%E7%9A%84%E7%BB%93%E6%9E%84">æŸ¥çœ‹é—­åŒ…çš„ç»“æ„</a>
<ul>
<li><a href="intro_gdb_lldb.html#%E4%BB%A3%E7%A0%81">ä»£ç </a></li>
<li><a href="intro_gdb_lldb.html#%E8%BF%90%E8%A1%8C%E8%BF%9B%E5%85%A5lldb">è¿è¡Œè¿›å…¥lldb</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:44:00 UTC 2022 -->
<!--te-->
<h2 id="èµ„æ–™æ•´ç†"><a class="header" href="#èµ„æ–™æ•´ç†">èµ„æ–™æ•´ç†</a></h2>
<h3 id="å®˜æ–¹æ•°æ®ç»“æ„cheat-sheet"><a class="header" href="#å®˜æ–¹æ•°æ®ç»“æ„cheat-sheet">å®˜æ–¹æ•°æ®ç»“æ„cheat sheet</a></h3>
<ul>
<li><a href="https://cheats.rs/#data-layout">Rust Language Cheat Sheet</a></li>
</ul>
<h2 id="æŸ¥çœ‹hashmapå†…å­˜ç»“æ„"><a class="header" href="#æŸ¥çœ‹hashmapå†…å­˜ç»“æ„">æŸ¥çœ‹hashmapå†…å­˜ç»“æ„</a></h2>
<h3 id="biné…ç½®ä¸è¿è¡Œ"><a class="header" href="#biné…ç½®ä¸è¿è¡Œ">biné…ç½®ä¸è¿è¡Œ</a></h3>
<ul>
<li><a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html?highlight=bin#binaries">Cargo Targets - The Cargo Book</a></li>
</ul>
<pre><code class="language-toml">[package]
name = &quot;hashtable&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[[bin]]
name = &quot;hashmap1&quot;
path = &quot;src/hashmap1.rs&quot;

[[bin]]
name = &quot;hashmap2&quot;
path = &quot;src/hashmap2.rs&quot;

[[bin]]
name = &quot;hash&quot;
path = &quot;src/hash.rs&quot;

[[bin]]
name = &quot;siphasher&quot;
path = &quot;src/siphasher.rs&quot;
doc = false

[[bin]]
name = &quot;hashmap3&quot;
path = &quot;src/hashmap3.rs&quot;

[[bin]]
name = &quot;btreemap1&quot;
path = &quot;src/btreemap1.rs&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
</code></pre>
<blockquote>
<p>å¦‚æœè¦å•ç‹¬è¿è¡ŒæŒ‡å®šbinæ–‡ä»¶ï¼š</p>
</blockquote>
<pre><code class="language-shell">cargo run --bin hashmap2
</code></pre>
<h3 id="ç›®æ ‡è°ƒè¯•ä»£ç "><a class="header" href="#ç›®æ ‡è°ƒè¯•ä»£ç ">ç›®æ ‡è°ƒè¯•ä»£ç </a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use std::collections::HashMap;

fn main() {
    let map = HashMap::new();
    let mut map = explain(&quot;empty&quot;, map);

    map.insert('a', 1);
    let mut map = explain(&quot;added 1&quot;, map);
    map.insert('b', 2);
    map.insert('c', 3);

    let mut map = explain(&quot;added 3&quot;, map);

    map.insert('d', 4);

    let mut map = explain(&quot;added 4&quot;, map);

    map.remove(&amp;'a');

    explain(&quot;final&quot;, map);
}

// HashMap ç»“æ„æœ‰ä¸¤ä¸ª u64 çš„ RandomStateï¼Œç„¶åæ˜¯å››ä¸ª usizeï¼Œ
// åˆ†åˆ«æ˜¯ bucket_mask, ctrl, growth_left å’Œ items
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain&lt;K, V&gt;(name: &amp;str, map: HashMap&lt;K, V&gt;) -&gt; HashMap&lt;K, V&gt; {
    let arr: [usize; 6] = unsafe { std::mem::transmute(map) };
    println!(
        &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
        name, arr[2], arr[3], arr[4], arr[5]
    );
    unsafe { std::mem::transmute(arr) }
}
</code></pre></pre>
<h3 id="ä½¿ç”¨gdblldbè¿›è¡Œè°ƒè¯•æŸ¥çœ‹å†…å­˜ç»“æ„"><a class="header" href="#ä½¿ç”¨gdblldbè¿›è¡Œè°ƒè¯•æŸ¥çœ‹å†…å­˜ç»“æ„">ä½¿ç”¨gdb/lldbè¿›è¡Œè°ƒè¯•æŸ¥çœ‹å†…å­˜ç»“æ„</a></h3>
<h4 id="gdb-ä¸»è¦æ˜¯linuxç³»ç»Ÿ"><a class="header" href="#gdb-ä¸»è¦æ˜¯linuxç³»ç»Ÿ">gdb: ä¸»è¦æ˜¯linuxç³»ç»Ÿ</a></h4>
<h4 id="lldb-ä¸»è¦osxç³»ç»Ÿ"><a class="header" href="#lldb-ä¸»è¦osxç³»ç»Ÿ">lldb: ä¸»è¦OSXç³»ç»Ÿ</a></h4>
<h4 id="idea"><a class="header" href="#idea">IDEA</a></h4>
<blockquote>
<p>è‡ªå¸¦çš„è°ƒè¯•ç•Œé¢åŒæ—¶åŒ…å«lldbæ›´å¥½çš„ç•Œé¢åŠŸèƒ½ã€‚</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/CleanShot%202022-09-18%20at%2021.24.12%402x.png" alt="CleanShot 2022-09-18 at 21.24.12@2x" /></p>
<h4 id="gdbä¸lldbå‘½ä»¤å¯¹ç…§"><a class="header" href="#gdbä¸lldbå‘½ä»¤å¯¹ç…§">gdbä¸lldbå‘½ä»¤å¯¹ç…§</a></h4>
<ul>
<li><a href="https://lldb.llvm.org/use/map.html">GDB to LLDB command map â€” The LLDB Debugger</a></li>
</ul>
<h4 id="å¼€å§‹è°ƒè¯•"><a class="header" href="#å¼€å§‹è°ƒè¯•">å¼€å§‹è°ƒè¯•</a></h4>
<pre><code class="language-shell">rust-lldb target/debug/hashmap2                                                                                                                  â”€â•¯
(lldb) command script import &quot;/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_lookup.py&quot;
(lldb) command source -s 0 '/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_commands'
Executing commands in '/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_commands'.
(lldb) type synthetic add -l lldb_lookup.synthetic_lookup -x &quot;.*&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)String$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^&amp;(mut )?str$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^&amp;(mut )?\\[.+\\]$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::ffi::([a-z_]+::)+)OsString$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Vec&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)VecDeque&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)BTreeSet&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)BTreeMap&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::collections::([a-z_]+::)+)HashMap&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::collections::([a-z_]+::)+)HashSet&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Rc&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Arc&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)Cell&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)Ref&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)RefMut&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)RefCell&lt;.+&gt;$&quot; --category Rust
(lldb) type category enable Rust
(lldb) target create &quot;target/debug/hashmap2&quot;
Current executable set to '/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/hashmap2' (x86_64).
(lldb)
</code></pre>
<h4 id="breakpoint-æ·»åŠ æ–­ç‚¹"><a class="header" href="#breakpoint-æ·»åŠ æ–­ç‚¹">b(reakpoint): æ·»åŠ æ–­ç‚¹</a></h4>
<blockquote>
<p>åœ¨32è¡Œæ‰“æ–­ç‚¹ï¼Œæ–¹ä¾¿çœ‹std::mem::transmute(arr)</p>
</blockquote>
<pre><code class="language-shell">(lldb) b hashmap2.rs:32
Breakpoint 1: where = hashmap2`hashmap2::explain::h4091c852f38a0de4 + 406 at hashmap2.rs:32:34, address = 0x0000000100008d16
</code></pre>
<h4 id="runè¿è¡Œåˆ°æ–­ç‚¹"><a class="header" href="#runè¿è¡Œåˆ°æ–­ç‚¹">r(un):è¿è¡Œåˆ°æ–­ç‚¹</a></h4>
<pre><code class="language-shell">(lldb) r
Process 69337 launched: '/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/hashmap2' (x86_64)
empty: bucket_mask 0x0, ctrl 0x100043d20, growth_left: 0, items: 0
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;empty&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># æœ€åˆçš„çŠ¶æ€ï¼Œå“ˆå¸Œè¡¨ä¸ºç©º
empty: bucket_mask 0x0, ctrl 0x100043d20, growth_left: 0, items: 0
</code></pre>
<h4 id="continueç»§ç»­å•æ­¥æ‰§è¡Œ"><a class="header" href="#continueç»§ç»­å•æ­¥æ‰§è¡Œ">c(ontinue):ç»§ç»­å•æ­¥æ‰§è¡Œ</a></h4>
<pre><code class="language-shell">(lldb) c
Process 69337 resuming
added 1: bucket_mask 0x3, ctrl 0x600001700160, growth_left: 2, items: 1
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;added 1&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># æ’å…¥äº†ä¸€ä¸ªå…ƒç´ åï¼Œbucket æœ‰ 4 ä¸ªï¼ˆ0x3+1ï¼‰ï¼Œå †åœ°å€èµ·å§‹ä½ç½® 0x600001700160 - 4*8(0x20)
added 1: bucket_mask 0x3, ctrl 0x600001700160, growth_left: 2, items: 1
</code></pre>
<h4 id="x-æ‰“å°å†…å­˜åœ°å€"><a class="header" href="#x-æ‰“å°å†…å­˜åœ°å€">x: æ‰“å°å†…å­˜åœ°å€</a></h4>
<ul>
<li><a href="https://wizardforcel.gitbooks.io/100-gdb-tips/content/examine-memory.html">æ‰“å°å†…å­˜çš„å€¼ | 100ä¸ªgdbå°æŠ€å·§</a></li>
</ul>
<pre><code class="language-shell"># ä»¥12è¿›åˆ¶æ‰“å°ä»å†…å­˜åœ°å€å¼€å§‹çš„å€¼
(lldb) x/12x 0x600001700160
0x600001700160: 0xffff6dff 0xffffffff 0xffffffff 0xffffffff
0x600001700170: 0xffff6dff 0x00000000 0x00000000 0x00000000
0x600001700180: 0x20ec913f 0x00007ff8 0x4e5ef01e 0x00000000
</code></pre>
<h4 id="continue-ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹"><a class="header" href="#continue-ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹">c(ontinue): ç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹</a></h4>
<pre><code class="language-shell">(lldb) c
Process 69337 resuming
added 3: bucket_mask 0x3, ctrl 0x600001700160, growth_left: 0, items: 3
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;added 3&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># # æ’å…¥äº†ä¸‰ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ²¡æœ‰å‰©ä½™ç©ºé—´ï¼Œå †åœ°å€èµ·å§‹ä½ç½®ä¸å˜ 0x600001700160 - 4*8(0x20)
added 3: bucket_mask 0x3, ctrl 0x600001700160, growth_left: 0, items: 3
</code></pre>
<pre><code class="language-shell">(lldb) x/12x 0x600001700160
0x600001700160: 0x16ff6d66 0xffffffff 0xffffffff 0xffffffff
0x600001700170: 0x16ff6d66 0x00000000 0x00000000 0x00000000
0x600001700180: 0x20ec913f 0x00007ff8 0x4e5ef01e 0x00000000
</code></pre>
<pre><code class="language-shell">(lldb) c
Process 69337 resuming
added 4: bucket_mask 0x7, ctrl 0x600002604040, growth_left: 3, items: 4
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;added 4&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># æ’å…¥ç¬¬å››ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ‰©å®¹ï¼Œå †åœ°å€èµ·å§‹ä½ç½®å˜ä¸º 0x600002604040 - 8*8(0x40)
added 4: bucket_mask 0x7, ctrl 0x600002604040, growth_left: 3, items: 4
</code></pre>
<pre><code class="language-shell">(lldb) x/12x 0x600002604040
0x600002604040: 0x16446d66 0xffffffff 0xffffffff 0xffffffff
0x600002604050: 0x16446d66 0xffffffff 0x00000000 0x00000000
0x600002604060: 0x00000000 0x00000000 0x00000000 0x00000000
(lldb) x/20x 0x600002604040
0x600002604040: 0x16446d66 0xffffffff 0xffffffff 0xffffffff
0x600002604050: 0x16446d66 0xffffffff 0x00000000 0x00000000
0x600002604060: 0x00000000 0x00000000 0x00000000 0x00000000
0x600002604070: 0x00000000 0x00000000 0x00000000 0x00000000
0x600002604080: 0x00000000 0x00000000 0x00000000 0x00000000
</code></pre>
<pre><code class="language-shell">(lldb) c
Process 69337 resuming
final: bucket_mask 0x7, ctrl 0x600002604040, growth_left: 4, items: 3
Process 69337 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x0000000100008d16 hashmap2`hashmap2::explain::h4091c852f38a0de4(name=&quot;final&quot;, map=&lt;unavailable&gt;) at hashmap2.rs:32:34
   29           &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
   30           name, arr[2], arr[3], arr[4], arr[5]
   31       );
-&gt; 32       unsafe { std::mem::transmute(arr) }
   33   }
Target 0: (hashmap2) stopped.
</code></pre>
<pre><code class="language-shell"># åˆ é™¤ a åï¼Œå‰©ä½™ 4 ä¸ªä½ç½®ã€‚æ³¨æ„ ctrl bit çš„å˜åŒ–ï¼Œä»¥åŠ 0x61 0x1 å¹¶æ²¡æœ‰è¢«æ¸…é™¤
final: bucket_mask 0x7, ctrl 0x600002604040, growth_left: 4, items: 3
</code></pre>
<pre><code class="language-shell">(lldb) x/12x 0x600002604040
0x600002604040: 0x1644ff66 0xffffffff 0xffffffff 0xffffffff
0x600002604050: 0x1644ff66 0xffffffff 0x00000000 0x00000000
0x600002604060: 0x00000000 0x00000000 0x00000000 0x00000000
(lldb) x/20x 0x600002604040
0x600002604040: 0x1644ff66 0xffffffff 0xffffffff 0xffffffff
0x600002604050: 0x1644ff66 0xffffffff 0x00000000 0x00000000
0x600002604060: 0x00000000 0x00000000 0x00000000 0x00000000
0x600002604070: 0x00000000 0x00000000 0x00000000 0x00000000
0x600002604080: 0x00000000 0x00000000 0x00000000 0x00000000
</code></pre>
<h2 id="æŸ¥çœ‹é—­åŒ…çš„ç»“æ„"><a class="header" href="#æŸ¥çœ‹é—­åŒ…çš„ç»“æ„">æŸ¥çœ‹é—­åŒ…çš„ç»“æ„</a></h2>
<h3 id="ä»£ç "><a class="header" href="#ä»£ç ">ä»£ç </a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use std::{collections::HashMap, mem::size_of_val};
fn main() {
    // é•¿åº¦ä¸º 0
    let c1 = || println!(&quot;hello world!&quot;);
    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
    let c2 = |i: i32| println!(&quot;hello: {}&quot;, i);
    let name = String::from(&quot;tyr&quot;);
    let name1 = name.clone();
    let mut table = HashMap::new();
    table.insert(&quot;hello&quot;, &quot;world&quot;);
    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
    let c3 = || println!(&quot;hello: {}&quot;, name);
    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
    let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
    let name2 = name.clone();
    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
    let c5 = move || {
        let x = 1;
        let name3 = String::from(&quot;lindsey&quot;);
        println!(&quot;hello: {}, {:?}, {:?}&quot;, x, name2, name3);
    };

    println!(
        &quot;c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}&quot;,
        size_of_val(&amp;c1),
        size_of_val(&amp;c2),
        size_of_val(&amp;c3),
        size_of_val(&amp;c4),
        size_of_val(&amp;c5),
        size_of_val(&amp;main),
    )
}
</code></pre></pre>
<h3 id="è¿è¡Œè¿›å…¥lldb"><a class="header" href="#è¿è¡Œè¿›å…¥lldb">è¿è¡Œè¿›å…¥lldb</a></h3>
<pre><code class="language-shell"># è‡ªåŠ¨å»examplesç›®å½•æ‰¾å¯¹åº”åå­—çš„ä»£ç æ–‡ä»¶
cargo run --example closure_size
</code></pre>
<pre><code class="language-shell">rust-lldb ../target/debug/examples/closure_size                                                                                                  â”€â•¯
(lldb) command script import &quot;/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_lookup.py&quot;
(lldb) command source -s 0 '/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_commands'
Executing commands in '/Users/kuanhsiaokuo/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/etc/lldb_commands'.
(lldb) type synthetic add -l lldb_lookup.synthetic_lookup -x &quot;.*&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)String$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^&amp;(mut )?str$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^&amp;(mut )?\\[.+\\]$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::ffi::([a-z_]+::)+)OsString$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Vec&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)VecDeque&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)BTreeSet&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)BTreeMap&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::collections::([a-z_]+::)+)HashMap&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(std::collections::([a-z_]+::)+)HashSet&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Rc&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(alloc::([a-z_]+::)+)Arc&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)Cell&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)Ref&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)RefMut&lt;.+&gt;$&quot; --category Rust
(lldb) type summary add -F lldb_lookup.summary_lookup  -e -x -h &quot;^(core::([a-z_]+::)+)RefCell&lt;.+&gt;$&quot; --category Rust
(lldb) type category enable Rust
(lldb) target create &quot;../target/debug/examples/closure_size&quot;
Current executable set to '/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/closure_size' (x86_64).
(lldb)
</code></pre>
<pre><code class="language-shell">(lldb) b closure_size.rs:14
Breakpoint 1: where = closure_size`closure_size::main::h679d75437a0cd078 + 199 at closure_size.rs:14:14, address = 0x00000001000056b7
</code></pre>
<pre><code class="language-shell">(lldb) r
Process 95084 launched: '/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/closure_size' (x86_64)
Process 95084 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x00000001000056b7 closure_size`closure_size::main::h679d75437a0cd078 at closure_size.rs:14:14
   11       // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
   12       let c3 = || println!(&quot;hello: {}&quot;, name);
   13       // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
-&gt; 14       let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
   15       let name2 = name.clone();
   16       // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
   17       let c5 = move || {
Target 0: (closure_size) stopped.
</code></pre>
<pre><code class="language-shell">(lldb) frame variable
(closure_size::main::{closure_env#0}) c1 =
(closure_size::main::{closure_env#1}) c2 =
(alloc::string::String) name = &quot;tyr&quot; {
  vec = size=3 {
    [0] = 't'
    [1] = 'y'
    [2] = 'r'
  }
}
(alloc::string::String) name1 = &quot;tyr&quot; {
  vec = size=3 {
    [0] = 't'
    [1] = 'y'
    [2] = 'r'
  }
}
(std::collections::hash::map::HashMap&lt;&amp;str, &amp;str, std::collections::hash::map::RandomState&gt;) table = size=1 {
  [0] = {
    0 = &quot;hello&quot; {
      data_ptr = 0x0000000100043daf &quot;helloworld, c2: , c3: , c4: , c5: \n&quot;
      length = 5
    }
    1 = &quot;world&quot; {
      data_ptr = 0x0000000100043db4 &quot;world, c2: , c3: , c4: , c5: \n&quot;
      length = 5
    }
  }
}
(lldb) fr v
(closure_size::main::{closure_env#0}) c1 =
(closure_size::main::{closure_env#1}) c2 =
(alloc::string::String) name = &quot;tyr&quot; {
  vec = size=3 {
    [0] = 't'
    [1] = 'y'
    [2] = 'r'
  }
}
(alloc::string::String) name1 = &quot;tyr&quot; {
  vec = size=3 {
    [0] = 't'
    [1] = 'y'
    [2] = 'r'
  }
}
(std::collections::hash::map::HashMap&lt;&amp;str, &amp;str, std::collections::hash::map::RandomState&gt;) table = size=1 {
  [0] = {
    0 = &quot;hello&quot; {
      data_ptr = 0x0000000100043daf &quot;helloworld, c2: , c3: , c4: , c5: \n&quot;
      length = 5
    }
    1 = &quot;world&quot; {
      data_ptr = 0x0000000100043db4 &quot;world, c2: , c3: , c4: , c5: \n&quot;
      length = 5
    }
  }
}
</code></pre>
<pre><code class="language-shell">(lldb) x/gx c1
error: memory read failed for 0x0
(lldb) x/gx &amp;c1
0x7ff7bfefed20: 0x0000000100266000
(lldb) x/gx &amp;c2
0x7ff7bfefed28: 0x00006000017041c0
(lldb) x/gx &amp;c3
0x7ff7bfefed90: 0x00007ff7bfefed30
(lldb) x/gx 0x00007ff7bfefed30
0x7ff7bfefed30: 0x0000600000008010
(lldb) x/3c  0x0000600000008010
error: reading memory as characters of size 8 is not supported
(lldb) x/gx  0x0000600000008010
0x600000008010: 0x0000000000727974
</code></pre>
<ul>
<li>gè¡¨ç¤ºå…«å­—èŠ‚ã€‚å½“æˆ‘ä»¬æŒ‡å®šäº†å­—èŠ‚é•¿åº¦åï¼ŒGDBä¼šä»æŒ‡å†…å­˜å®šçš„å†…å­˜åœ°å€å¼€å§‹ï¼Œè¯»å†™æŒ‡å®šå­—èŠ‚ï¼Œå¹¶æŠŠå…¶å½“ä½œä¸€ä¸ªå€¼å–å‡ºæ¥ã€‚</li>
<li>å¯ä»¥çœ‹å‡ºï¼šc1æ˜¯</li>
</ul>
<pre><code class="language-shell">(lldb) n
Process 95084 stopped
* thread #1, queue = 'com.apple.main-thread', stop reason = step over
    frame #0: 0x0000000100005744 closure_size`closure_size::main::h679d75437a0cd078 at closure_size.rs:15:17
   12       let c3 = || println!(&quot;hello: {}&quot;, name);
   13       // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
   14       let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
-&gt; 15       let name2 = name.clone();
   16       // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
   17       let c5 = move || {
   18           let x = 1;
Target 0: (closure_size) stopped.
(lldb) x/9gx c4
error: memory read failed for 0x0
(lldb) x/9gx &amp;c4
0x7ff7bfefed98: 0x0000600000008020 0x0000000000000003
0x7ff7bfefeda8: 0x0000000000000003 0x3e49f3270a1a0fb0
0x7ff7bfefedb8: 0x79dd9a78e6c327e7 0x0000000000000003
0x7ff7bfefedc8: 0x0000600003304080 0x0000000000000002
0x7ff7bfefedd8: 0x0000000000000001
(lldb) x/3c 0x0000600000008020
error: reading memory as characters of size 8 is not supported
(lldb) x/gx 0x0000600000008020
0x600000008020: 0x0000000000727974
(lldb) x/18gx 0x0000600000008020 - 0x80
error: memory read takes a start address expression with an optional end address expression.
warning: Expressions should be quoted if they contain spaces or other special characters.
(lldb) x/18gx '0x0000600000008020 - 0x80'
0x600000007fa0: 0x0000000000000000 0x0000000000000000
0x600000007fb0: 0x0000000000000000 0x0000000000000000
0x600000007fc0: 0x0000000000000000 0x0000000000000000
0x600000007fd0: 0x0000000000000000 0x0000000000000000
0x600000007fe0: 0x0000000000000000 0x0000000000000000
0x600000007ff0: 0x0000000000000000 0x0000000000000000
0x600000008000: 0x000000006e69616d 0x0000000000000000
0x600000008010: 0x0000000000727974 0x0000000000000000
0x600000008020: 0x0000000000727974 0x0000000000000000
</code></pre>
<ul>
<li>0x: Cè¯­è¨€é‡Œçš„0x0å’Œ0x1åˆ†åˆ«è¡¨ç¤ºåå…­è¿›åˆ¶çš„æ•°çš„0å’Œ1ã€‚</li>
</ul>
<p>Cè¯­è¨€ã€C++ã€Shellã€Pythonã€Javaè¯­è¨€åŠå…¶ä»–ç›¸è¿‘çš„è¯­è¨€ä½¿ç”¨å­—é¦–â€œ0xâ€ï¼Œä¾‹å¦‚â€œ0x5A3â€ã€‚å¼€å¤´çš„â€œ0â€ä»¤è§£æå™¨æ›´æ˜“è¾¨è®¤æ•°ï¼Œè€Œâ€œxâ€åˆ™ä»£è¡¨åå…­è¿›åˆ¶ï¼ˆå°±å¦‚â€œOâ€ä»£è¡¨å…«è¿›åˆ¶ï¼‰ã€‚åœ¨â€œ0xâ€ä¸­çš„â€œxâ€å¯ä»¥å¤§å†™æˆ–å°å†™ã€‚å¯¹äºå­—ç¬¦é‡Cè¯­è¨€ä¸­åˆ™ä»¥x+ä¸¤ä½åå…­è¿›åˆ¶æ•°çš„æ–¹å¼è¡¨ç¤ºï¼Œå¦‚xFFã€‚</p>
<p>å› æ­¤ï¼Œ0x0ä¸­â€œ0xâ€è¡¨ç¤ºçš„æ˜¯åå…­è¿›åˆ¶æ•°ï¼Œ0æ˜¯åå…­è¿›åˆ¶æ•°å€¼0ï¼Œ0x,1ä¸­â€œ0xâ€è¡¨ç¤ºçš„æ˜¯åå…­è¿›åˆ¶æ•°ï¼Œ1æ˜¯åå…­è¿›åˆ¶æ•°å€¼1</p>
<ul>
<li>Cè¯­è¨€ä¸­çš„ç›¸å…³æ•°å€¼è¡¨ç¤ºæ³•ï¼š</li>
</ul>
<p>1ã€åœ¨Cè¯­è¨€é‡Œï¼Œæ•´æ•°æœ‰ä¸‰ç§è¡¨ç¤ºå½¢å¼ï¼šåè¿›åˆ¶ï¼Œå…«è¿›åˆ¶ï¼Œåå…­è¿›åˆ¶ã€‚å…¶ä¸­ä»¥æ•°å­—0å¼€å¤´ï¼Œç”±0~7ç»„æˆçš„æ•°æ˜¯å…«è¿›åˆ¶ã€‚ä»¥0Xæˆ–0xå¼€å¤´ï¼Œç”±0~9ï¼ŒA~Fæˆ–a~f ç»„æˆæ˜¯åå…­è¿›åˆ¶ã€‚é™¤è¡¨ç¤ºæ­£è´Ÿçš„ç¬¦å·å¤–ï¼Œä»¥1~9å¼€å¤´ï¼Œç”±0~9ç»„æˆæ˜¯åè¿›åˆ¶ã€‚</p>
<p>2ã€åè¿›åˆ¶ï¼šé™¤è¡¨ç¤ºæ­£è´Ÿçš„ç¬¦å·å¤–ï¼Œä»¥1~9å¼€å¤´ï¼Œç”±0~9ç»„æˆã€‚å¦‚ï¼Œ128ï¼Œ+234ï¼Œ-278ã€‚</p>
<p>3ã€å…«è¿›åˆ¶ï¼šä»¥0å¼€å¤´ï¼Œç”±0~7ç»„æˆçš„æ•°ã€‚å¦‚ï¼Œ0126,050000.</p>
<p>4ã€åå…­è¿›åˆ¶ï¼šä»¥0Xæˆ–0xå¼€å¤´ï¼Œç”±0~9ï¼ŒA~Fæˆ–a~f ç»„æˆã€‚å¦‚ï¼Œ0x12A,0x5a000ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="get-hands-dirty"><a class="header" href="#get-hands-dirty">get hands dirty</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="httpieæºç å‰–æ"><a class="header" href="#httpieæºç å‰–æ">httpieæºç å‰–æ</a></h1>
<!--ts-->
<ul>
<li><a href="httpie.html#httpie%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90">httpieæºç å‰–æ</a>
<ul>
<li><a href="httpie.html#example%E7%9A%84%E4%BD%BF%E7%94%A8">exampleçš„ä½¿ç”¨</a>
<ul>
<li><a href="httpie.html#cargotoml">Cargo.toml</a></li>
</ul>
</li>
<li><a href="httpie.html#step1%E6%8C%87%E4%BB%A4%E8%A7%A3%E6%9E%90">Step1ï¼šæŒ‡ä»¤è§£æ</a>
<ul>
<li><a href="httpie.html#clapparser">clap::Parser</a></li>
</ul>
</li>
<li><a href="httpie.html#step2%E6%B7%BB%E5%8A%A0%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81%E4%B8%8E%E9%94%AE%E5%80%BC%E5%AF%B9%E6%94%B9%E9%80%A0">Step2ï¼šæ·»åŠ å‚æ•°éªŒè¯ä¸é”®å€¼å¯¹æ”¹é€ </a>
<ul>
<li><a href="httpie.html#%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81">å‚æ•°éªŒè¯</a></li>
<li><a href="httpie.html#%E9%94%AE%E5%80%BC%E5%AF%B9%E6%94%B9%E9%80%A0">é”®å€¼å¯¹æ”¹é€ </a></li>
</ul>
</li>
<li><a href="httpie.html#step3%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E6%94%B9%E9%80%A0">Step3ï¼šå¼‚æ­¥è¯·æ±‚æ”¹é€ </a></li>
<li><a href="httpie.html#step4-%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE%E6%89%93%E5%8D%B0">Step4: è¯­æ³•é«˜äº®æ‰“å°</a></li>
<li><a href="httpie.html#step5-%E6%B7%BB%E5%8A%A0%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">Step5: æ·»åŠ å•å…ƒæµ‹è¯•</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:44:00 UTC 2022 -->
<!--te-->
<h2 id="exampleçš„ä½¿ç”¨"><a class="header" href="#exampleçš„ä½¿ç”¨">exampleçš„ä½¿ç”¨</a></h2>
<ul>
<li><a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html?highlight=%5B%5Bexample%5D%5D#examples">Cargo Targets &gt;&gt; Examples - The Cargo Book</a></li>
</ul>
<h3 id="cargotoml"><a class="header" href="#cargotoml">Cargo.toml</a></h3>
<pre><code class="language-toml">[package]
name = &quot;httpie&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[[example]]
name = &quot;cli&quot;

[[example]]
name = &quot;cli_verify&quot;

[[example]]
name = &quot;cli_get&quot;

[dependencies]
anyhow = &quot;1&quot; # é”™è¯¯å¤„ç†
clap = { version = &quot;3&quot;, features = [&quot;derive&quot;] } # å‘½ä»¤è¡Œè§£æ
colored = &quot;2&quot; # å‘½ä»¤ç»ˆç«¯å¤šå½©æ˜¾ç¤º
jsonxf = &quot;1.1&quot; # JSON pretty print æ ¼å¼åŒ–
mime = &quot;0.3&quot; # å¤„ç† mime ç±»å‹
# reqwest é»˜è®¤ä½¿ç”¨ opensslï¼Œæœ‰äº› linux ç”¨æˆ·å¦‚æœæ²¡æœ‰å®‰è£…å¥½ openssl ä¼šæ— æ³•ç¼–è¯‘ï¼Œè¿™é‡Œæˆ‘æ”¹æˆäº†ä½¿ç”¨ rustls
reqwest = { version = &quot;0.11&quot;, default-features = false, features = [&quot;json&quot;, &quot;rustls-tls&quot;] } # HTTP å®¢æˆ·ç«¯
tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] } # å¼‚æ­¥å¤„ç†åº“
syntect = &quot;4&quot;
</code></pre>
<pre><code class="language-toml">[[example]]
name = &quot;cli&quot;

[[example]]
name = &quot;cli_verify&quot;

[[example]]
name = &quot;cli_get&quot;
</code></pre>
<div id="admonition-exampleä½¿ç”¨" class="admonition tip">
<div class="admonition-title">
<p>exampleä½¿ç”¨</p>
<p><a class="admonition-anchor-link" href="httpie.html#admonition-exampleä½¿ç”¨"></a></p>
</div>
<div>
<ol>
<li>ç¤ºä¾‹ä»£ç æ”¾åœ¨æ ¹ç›®å½•çš„examplesæ–‡ä»¶å¤¹ï¼Œä¸srcåŒçº§</li>
</ol>
<pre><code class="language-shell">tree -L 2                                                                                                       â”€â•¯
.
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ examples
â”‚Â Â  â”œâ”€â”€ cli.rs
â”‚Â Â  â”œâ”€â”€ cli_get.rs
â”‚Â Â  â””â”€â”€ cli_verify.rs
â””â”€â”€ src
    â””â”€â”€ main.rs

2 directories, 5 files
</code></pre>
<ol start="2">
<li>æ‰§è¡ŒæŒ‡ä»¤</li>
</ol>
<pre><code class="language-shell">cargo run --example &lt;example-name-in-cargo&gt;
cargo run --example cli
cargo run --example cli_get
cargo run --example cli_verify
</code></pre>
<ol start="3">
<li>ä½¿ç”¨ç¤ºä¾‹</li>
</ol>
<pre><code class="language-shell">cargo run --example cli                                                                                                                                                                                                                â”€â•¯
    Finished dev [unoptimized + debuginfo] target(s) in 0.70s
     Running `/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/cli`
httpie 1.0
Tyr Chen &lt;tyr@chen.com&gt;
A naive httpie implementation with Rust, can you imagine how easy it is?

USAGE:
    cli &lt;SUBCOMMAND&gt;

OPTIONS:
    -h, --help       Print help information
    -V, --version    Print version information

SUBCOMMANDS:
    get     feed get with an url and we will retrieve the response for you
    help    Print this message or the help of the given subcommand(s)
    post    feed post with an url and optional key=value pairs. We will post the data as JSON,
                and retrieve the response for you
</code></pre>
<ul>
<li>Run a binary or example of the local package</li>
<li>SUBCOMMANDSæ¥è‡ªä»£ç ä¸­çš„æ³¨é‡Š</li>
</ul>
</div>
</div>
<h2 id="step1æŒ‡ä»¤è§£æ"><a class="header" href="#step1æŒ‡ä»¤è§£æ">Step1ï¼šæŒ‡ä»¤è§£æ</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">use clap::Parser;

// å®šä¹‰ httpie çš„ CLI çš„ä¸»å…¥å£ï¼Œå®ƒåŒ…å«è‹¥å¹²ä¸ªå­å‘½ä»¤
// ä¸‹é¢ /// çš„æ³¨é‡Šæ˜¯æ–‡æ¡£ï¼Œclap ä¼šå°†å…¶ä½œä¸º CLI çš„å¸®åŠ©

/// A naive httpie implementation with Rust, can you imagine how easy it is?
#[derive(Parser, Debug)]
#[clap(version = &quot;1.0&quot;, author = &quot;Tyr Chen &lt;tyr@chen.com&gt;&quot;)]
struct Opts {
    #[clap(subcommand)]
    subcmd: SubCommand,
}

// å­å‘½ä»¤åˆ†åˆ«å¯¹åº”ä¸åŒçš„ HTTP æ–¹æ³•ï¼Œç›®å‰åªæ”¯æŒ get / post
#[derive(Parser, Debug)]
enum SubCommand {
    Get(Get),
    Post(Post),
    // æˆ‘ä»¬æš‚ä¸”ä¸æ”¯æŒå…¶å®ƒ HTTP æ–¹æ³•
}

// get å­å‘½ä»¤

/// feed get with an url and we will retrieve the response for you
#[derive(Parser, Debug)]
struct Get {
    /// HTTP è¯·æ±‚çš„ URL
    url: String,
}

// post å­å‘½ä»¤ã€‚éœ€è¦è¾“å…¥ä¸€ä¸ª urlï¼Œå’Œè‹¥å¹²ä¸ªå¯é€‰çš„ key=valueï¼Œç”¨äºæä¾› json body

/// feed post with an url and optional key=value pairs. We will post the data
/// as JSON, and retrieve the response for you
#[derive(Parser, Debug)]
struct Post {
    /// HTTP è¯·æ±‚çš„ URL
    url: String,
    /// HTTP è¯·æ±‚çš„ body
    body: Vec&lt;String&gt;,
}

fn main() {
    let opts: Opts = Opts::parse();
    let opt_subcmd: SubCommand = opts.subcmd;
    // println!(&quot;{:?}&quot;, opts);
    println!(&quot;{:?}&quot;, opt_subcmd);
    // println!(&quot;{:?}&quot;, opts.subcmd);
    // è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºï¼Œç»“æ„ä½“çš„å†…åœ¨å…ƒç´ ä½¿ç”¨&quot;.&quot;æ¥è·å–
    // println!(&quot;{:?}&quot;, opts::subcmd);
}
</code></pre></pre>
<h3 id="clapparser"><a class="header" href="#clapparser">clap::Parser</a></h3>
<div id="admonition-clapparser" class="admonition info">
<div class="admonition-title">
<p>clap::Parser</p>
<p><a class="admonition-anchor-link" href="httpie.html#admonition-clapparser"></a></p>
</div>
<div>
<ul>
<li><a href="https://github.com/clap-rs/clap">clap-rs/clap: A full featured, fast Command Line Argument Parser for Rust</a></li>
<li><a href="https://docs.rs/clap/latest/clap/">clap - Rust</a></li>
<li><a href="https://docs.rs/clap/latest/clap/parser/index.html">clap::parser - Rust</a></li>
</ul>
</div>
</div>
<ol>
<li>clapçš„parseræ´¾ç”Ÿå®ä¼šè‡ªåŠ¨å®ç°parseæ–¹æ³•æ¥æ¥æ”¶æŒ‡ä»¤å‚æ•°</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">struct Opts {
    #[clap(subcommand)]
    subcmd: SubCommand,
}

// å­å‘½ä»¤åˆ†åˆ«å¯¹åº”ä¸åŒçš„ HTTP æ–¹æ³•ï¼Œç›®å‰åªæ”¯æŒ get / post
#[derive(Parser, Debug)]
</code></pre></pre>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let opts: Opts = Opts::parse();
    let opt_subcmd: SubCommand = opts.subcmd;
    // println!(&quot;{:?}&quot;, opts);
</code></pre></pre>
<ol start="2">
<li>è¿è¡Œæ•ˆæœ</li>
</ol>
<pre><code class="language-shell">cargo run --example cli get http://jsonplaceholder.typicode.com/posts/2                                                                                                                                                                â”€â•¯
   Compiling httpie v0.1.0 (/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/04_httpie)
    Finished dev [unoptimized + debuginfo] target(s) in 2.31s
     Running `/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/cli get 'http://jsonplaceholder.typicode.com/posts/2'`
Opts { subcmd: Get(Get { url: &quot;http://jsonplaceholder.typicode.com/posts/2&quot; }) }
</code></pre>
<pre><code class="language-shell">cargo run --example cli post http://jsonplaceholder.typicode.com/posts/2                                                                                                                                                               â”€â•¯
    Finished dev [unoptimized + debuginfo] target(s) in 0.31s
     Running `/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/cli post 'http://jsonplaceholder.typicode.com/posts/2'`
Opts { subcmd: Post(Post { url: &quot;http://jsonplaceholder.typicode.com/posts/2&quot;, body: [] }) }
</code></pre>
<pre><code class="language-shell">cargo run --example cli delete http://jsonplaceholder.typicode.com/posts/2                                                                                                                                                             â”€â•¯
    Finished dev [unoptimized + debuginfo] target(s) in 0.24s
     Running `/Users/kuanhsiaokuo/Developer/spare_projects/rust_lab/geektime-rust/geektime_rust_codes/target/debug/examples/cli delete 'http://jsonplaceholder.typicode.com/posts/2'`
error: Found argument 'delete' which wasn't expected, or isn't valid in this context

USAGE:
    cli &lt;SUBCOMMAND&gt;

For more information try --help

</code></pre>
<ul>
<li>optsçš„è·å–ï¼šè‡ªåŠ¨ä»¥ç©ºæ ¼åˆ†éš”ï¼Œæ ¹æ®<subcommand>æ¨¡å¼åŒ¹é…ï¼Œä¹‹åçš„å‚æ•°ä¾æ¬¡èµ‹å€¼ç»™<subcommand> structé‡Œé¢çš„å…ƒç´ </li>
</ul>
<h2 id="step2æ·»åŠ å‚æ•°éªŒè¯ä¸é”®å€¼å¯¹æ”¹é€ "><a class="header" href="#step2æ·»åŠ å‚æ•°éªŒè¯ä¸é”®å€¼å¯¹æ”¹é€ ">Step2ï¼šæ·»åŠ å‚æ•°éªŒè¯ä¸é”®å€¼å¯¹æ”¹é€ </a></h2>
<h3 id="å‚æ•°éªŒè¯"><a class="header" href="#å‚æ•°éªŒè¯">å‚æ•°éªŒè¯</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// feed get with an url and we will retrieve the response for you
#[derive(Parser, Debug)]
struct Get {
    /// HTTP è¯·æ±‚çš„ URL
    #[clap(parse(try_from_str = parse_url))]
    url: String,
}

// post å­å‘½ä»¤ã€‚éœ€è¦è¾“å…¥ä¸€ä¸ª urlï¼Œå’Œè‹¥å¹²ä¸ªå¯é€‰çš„ key=valueï¼Œç”¨äºæä¾› json body

/// feed post with an url and optional key=value pairs. We will post the data
/// as JSON, and retrieve the response for you
#[derive(Parser, Debug)]
struct Post {
    /// HTTP è¯·æ±‚çš„ URL
    #[clap(parse(try_from_str = parse_url))]
    url: String,
    /// HTTP è¯·æ±‚çš„ body
    #[clap(parse(try_from_str=parse_kv_pair))]
    body: Vec&lt;KvPair&gt;,
}
</code></pre></pre>
<ol>
<li>clap å…è®¸ä½ ä¸ºæ¯ä¸ªè§£æå‡ºæ¥çš„å€¼æ·»åŠ è‡ªå®šä¹‰çš„è§£æå‡½æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œå®šä¹‰äº†parse_urlå’Œparse_kv_pairæ£€æŸ¥ä¸€ä¸‹ã€‚</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">/// å› ä¸ºæˆ‘ä»¬ä¸º KvPair å®ç°äº† FromStrï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥ s.parse() å¾—åˆ° KvPair
fn parse_kv_pair(s: &amp;str) -&gt; Result&lt;KvPair&gt; {
    s.parse()
}
fn parse_url(s: &amp;str) -&gt; Result&lt;String&gt; {
    // è¿™é‡Œæˆ‘ä»¬ä»…ä»…æ£€æŸ¥ä¸€ä¸‹ URL æ˜¯å¦åˆæ³•
    let _url: Url = s.parse()?;

    Ok(s.into())
}
</code></pre></pre>
<ol>
<li>clap å…è®¸ä½ ä¸ºæ¯ä¸ªè§£æå‡ºæ¥çš„å€¼æ·»åŠ è‡ªå®šä¹‰çš„è§£æå‡½æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œå®šä¹‰äº†ä¸ªparse_urlæ£€æŸ¥ä¸€ä¸‹ã€‚</li>
</ol>
<h3 id="é”®å€¼å¯¹æ”¹é€ "><a class="header" href="#é”®å€¼å¯¹æ”¹é€ ">é”®å€¼å¯¹æ”¹é€ </a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// å‘½ä»¤è¡Œä¸­çš„ key=value å¯ä»¥é€šè¿‡ parse_kv_pair è§£ææˆ KvPair ç»“æ„
#[allow(dead_code)]
#[derive(Debug)]
struct KvPair {
    k: String,
    v: String,
}

/// å½“æˆ‘ä»¬å®ç° FromStr trait åï¼Œå¯ä»¥ç”¨ str.parse() æ–¹æ³•å°†å­—ç¬¦ä¸²è§£ææˆ KvPair
impl FromStr for KvPair {
    type Err = anyhow::Error;

    fn from_str(s: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {
        // ä½¿ç”¨ = è¿›è¡Œ splitï¼Œè¿™ä¼šå¾—åˆ°ä¸€ä¸ªè¿­ä»£å™¨
        let mut split = s.split('=');
        let err = || anyhow!(format!(&quot;Failed to parse {}&quot;, s));
        Ok(Self {
            // ä»è¿­ä»£å™¨ä¸­å–ç¬¬ä¸€ä¸ªç»“æœä½œä¸º keyï¼Œè¿­ä»£å™¨è¿”å› Some(T)/None
            // æˆ‘ä»¬å°†å…¶è½¬æ¢æˆ Ok(T)/Err(E)ï¼Œç„¶åç”¨ ? å¤„ç†é”™è¯¯
            k: (split.next().ok_or_else(err)?).to_string(),
            // ä»è¿­ä»£å™¨ä¸­å–ç¬¬äºŒä¸ªç»“æœä½œä¸º value
            v: (split.next().ok_or_else(err)?).to_string(),
        })
    }
}
</code></pre></pre>
<h2 id="step3å¼‚æ­¥è¯·æ±‚æ”¹é€ "><a class="header" href="#step3å¼‚æ­¥è¯·æ±‚æ”¹é€ ">Step3ï¼šå¼‚æ­¥è¯·æ±‚æ”¹é€ </a></h2>
<pre><pre class="playground"><code class="language-rust  editable">#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let opts: Opts = Opts::parse();
    // ç”Ÿæˆä¸€ä¸ª
    let client = Client::new();
    match opts.subcmd {
        SubCommand::Get(ref args) =&gt; get(client, args).await?,
        SubCommand::Post(ref args) =&gt; post(client, args).await?,
    };

    Ok(())
}

async fn get(client: Client, args: &amp;Get) -&gt; Result&lt;()&gt; {
    let resp = client.get(&amp;args.url).send().await?;
    println!(&quot;{:?}&quot;, resp.text().await?);
    Ok(())
}

async fn post(client: Client, args: &amp;Post) -&gt; Result&lt;()&gt; {
    let mut body = HashMap::new();
    for pair in args.body.iter() {
        body.insert(&amp;pair.k, &amp;pair.v);
    }
    let resp = client.post(&amp;args.url).json(&amp;body).send().await?;
    println!(&quot;{:?}&quot;, resp.text().await?);
    Ok(())
}
</code></pre></pre>
<h2 id="step4-è¯­æ³•é«˜äº®æ‰“å°"><a class="header" href="#step4-è¯­æ³•é«˜äº®æ‰“å°">Step4: è¯­æ³•é«˜äº®æ‰“å°</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">// æ‰“å°æœåŠ¡å™¨ç‰ˆæœ¬å· + çŠ¶æ€ç 
fn print_status(resp: &amp;Response) {
    let status = format!(&quot;{:?} {}&quot;, resp.version(), resp.status()).blue();
    println!(&quot;{}\n&quot;, status);
}

// æ‰“å°æœåŠ¡å™¨è¿”å›çš„ HTTP header
fn print_headers(resp: &amp;Response) {
    for (name, value) in resp.headers() {
        println!(&quot;{}: {:?}&quot;, name.to_string().green(), value);
    }

    println!();
}

/// æ‰“å°æœåŠ¡å™¨è¿”å›çš„ HTTP body
fn print_body(m: Option&lt;Mime&gt;, body: &amp;str) {
    match m {
        // å¯¹äº &quot;application/json&quot; æˆ‘ä»¬ pretty print
        Some(v) if v == mime::APPLICATION_JSON =&gt; print_syntect(body, &quot;json&quot;),
        Some(v) if v == mime::TEXT_HTML =&gt; print_syntect(body, &quot;html&quot;),

        // å…¶å®ƒ mime typeï¼Œæˆ‘ä»¬å°±ç›´æ¥è¾“å‡º
        _ =&gt; println!(&quot;{}&quot;, body),
    }
}

/// æ‰“å°æ•´ä¸ªå“åº”
async fn print_resp(resp: Response) -&gt; Result&lt;()&gt; {
    print_status(&amp;resp);
    print_headers(&amp;resp);
    let mime = get_content_type(&amp;resp);
    let body = resp.text().await?;
    print_body(mime, &amp;body);
    Ok(())
}

/// å°†æœåŠ¡å™¨è¿”å›çš„ content-type è§£ææˆ Mime ç±»å‹
fn get_content_type(resp: &amp;Response) -&gt; Option&lt;Mime&gt; {
    resp.headers()
        .get(header::CONTENT_TYPE)
        .map(|v| v.to_str().unwrap().parse().unwrap())
}

fn print_syntect(s: &amp;str, ext: &amp;str) {
    // Load these once at the start of your program
    let ps = SyntaxSet::load_defaults_newlines();
    let ts = ThemeSet::load_defaults();
    let syntax = ps.find_syntax_by_extension(ext).unwrap();
    let mut h = HighlightLines::new(syntax, &amp;ts.themes[&quot;base16-ocean.dark&quot;]);
    for line in LinesWithEndings::from(s) {
        let ranges: Vec&lt;(Style, &amp;str)&gt; = h.highlight(line, &amp;ps);
        let escaped = as_24_bit_terminal_escaped(&amp;ranges[..], true);
        print!(&quot;{}&quot;, escaped);
    }
}
</code></pre></pre>
<pre><pre class="playground"><code class="language-rust  editable">/// ç¨‹åºçš„å…¥å£å‡½æ•°ï¼Œå› ä¸ºåœ¨ http è¯·æ±‚æ—¶æˆ‘ä»¬ä½¿ç”¨äº†å¼‚æ­¥å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œå¼•å…¥ tokio
#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let opts: Opts = Opts::parse();
    let mut headers = header::HeaderMap::new();
    // ä¸ºæˆ‘ä»¬çš„ http å®¢æˆ·ç«¯æ·»åŠ ä¸€äº›ç¼ºçœçš„ HTTP å¤´
    headers.insert(&quot;X-POWERED-BY&quot;, &quot;Rust&quot;.parse()?);
    headers.insert(header::USER_AGENT, &quot;Rust Httpie&quot;.parse()?);
    let client = Client::builder()
        .default_headers(headers)
        .build()?;
    let result = match opts.subcmd {
        SubCommand::Get(ref args) =&gt; get(client, args).await?,
        SubCommand::Post(ref args) =&gt; post(client, args).await?,
    };

    Ok(result)
}
</code></pre></pre>
<h2 id="step5-æ·»åŠ å•å…ƒæµ‹è¯•"><a class="header" href="#step5-æ·»åŠ å•å…ƒæµ‹è¯•">Step5: æ·»åŠ å•å…ƒæµ‹è¯•</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">// ä»…åœ¨ cargo test æ—¶æ‰ç¼–è¯‘
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn parse_url_works() {
        assert!(parse_url(&quot;abc&quot;).is_err());
        assert!(parse_url(&quot;http://abc.xyz&quot;).is_ok());
        assert!(parse_url(&quot;https://httpbin.org/post&quot;).is_ok());
    }

    #[test]
    fn parse_kv_pair_works() {
        assert!(parse_kv_pair(&quot;a&quot;).is_err());
        assert_eq!(
            parse_kv_pair(&quot;a=1&quot;).unwrap(),
            KvPair {
                k: &quot;a&quot;.into(),
                v: &quot;1&quot;.into(),
            }
        );

        assert_eq!(
            parse_kv_pair(&quot;b=&quot;).unwrap(),
            KvPair {
                k: &quot;b&quot;.into(),
                v: &quot;&quot;.into(),
            }
        );
    }
}
</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rgrep"><a class="header" href="#rgrep">rgrep</a></h1>
<!--ts-->
<ul>
<li><a href="rgrep.html#rgrep">rgrep</a>
<ul>
<li><a href="rgrep.html#cargotoml">Cargo.toml</a></li>
<li><a href="rgrep.html#srcerrorrs-thiserror%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2">src/error.rs: thiserrorä¼šè‡ªåŠ¨è½¬æ¢</a></li>
<li><a href="rgrep.html#srclibrs%E5%AE%9A%E4%B9%89%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">src/lib.rsï¼šå®šä¹‰ç»“æ„ä½“+å®ç°æ–¹æ³•+å•å…ƒæµ‹è¯•</a>
<ul>
<li><a href="rgrep.html#mod%E5%BC%95%E5%85%A5%E4%B8%8E%E4%BD%BF%E7%94%A8">modå¼•å…¥ä¸ä½¿ç”¨</a></li>
<li><a href="rgrep.html#%E5%AE%9A%E4%B9%89%E7%BB%93%E6%9E%84%E4%BD%93">å®šä¹‰ç»“æ„ä½“</a>
<ul>
<li><a href="rgrep.html#%E4%B8%93%E9%97%A8%E7%AE%80%E5%8C%96%E5%A4%8D%E6%9D%82%E7%B1%BB%E5%9E%8B">ä¸“é—¨ç®€åŒ–å¤æ‚ç±»å‹</a></li>
<li><a href="rgrep.html#%E4%B8%93%E9%97%A8%E7%9A%84%E7%BB%93%E5%90%88%E7%89%88%E6%9C%ACgrep%E7%BB%93%E6%9E%84%E4%BD%93">ä¸“é—¨çš„ç»“åˆç‰ˆæœ¬grepç»“æ„ä½“</a></li>
</ul>
</li>
<li><a href="rgrep.html#%E7%BB%99%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95">ç»™ç»“æ„ä½“å®ç°æ–¹æ³•</a></li>
<li><a href="rgrep.html#%E9%BB%98%E8%AE%A4%E7%AD%96%E7%95%A5-default_strategy">é»˜è®¤ç­–ç•¥: default_strategy</a></li>
<li><a href="rgrep.html#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA">æ ¼å¼åŒ–è¾“å‡º</a></li>
<li><a href="rgrep.html#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">å•å…ƒæµ‹è¯•</a></li>
</ul>
</li>
<li><a href="rgrep.html#srcmainrs">src/main.rs</a>
<ul>
<li><a href="rgrep.html#%E5%BC%95%E5%85%A5librs%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9">å¼•å…¥lib.rsä¸­çš„å†…å®¹</a></li>
<li><a href="rgrep.html#%E4%B8%BB%E5%87%BD%E6%95%B0main">ä¸»å‡½æ•°ï¼šmain()</a></li>
</ul>
</li>
<li><a href="rgrep.html#%E4%BD%BF%E7%94%A8">ä½¿ç”¨</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:44:00 UTC 2022 -->
<!--te-->
<h2 id="cargotoml-1"><a class="header" href="#cargotoml-1">Cargo.toml</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">[package]
name = &quot;rgrep&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

<span class="boring">See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html
</span>
[dependencies]
anyhow = &quot;1&quot;
clap = { version = &quot;3&quot;, features = [&quot;derive&quot;] }
colored = &quot;2&quot;
glob = &quot;0.3&quot;
itertools = &quot;0.10&quot;
rayon = &quot;1&quot;
regex = &quot;1&quot;
thiserror = &quot;1&quot;
</code></pre></pre>
<h2 id="srcerrorrs-thiserrorä¼šè‡ªåŠ¨è½¬æ¢"><a class="header" href="#srcerrorrs-thiserrorä¼šè‡ªåŠ¨è½¬æ¢">src/error.rs: thiserrorä¼šè‡ªåŠ¨è½¬æ¢</a></h2>
<blockquote>
<p>å®ƒä»¬éƒ½æ˜¯éœ€è¦è¿›è¡Œè½¬æ¢çš„é”™è¯¯ã€‚thiserror èƒ½å¤Ÿé€šè¿‡å®å¸®æˆ‘ä»¬å®Œæˆé”™è¯¯ç±»å‹çš„è½¬æ¢ã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">use thiserror::Error;

#[derive(Error, Debug)]
pub enum GrepError {
    #[error(&quot;Glob pattern error&quot;)]
    GlobPatternError(#[from] glob::PatternError),
    #[error(&quot;Regex pattern error&quot;)]
    RegexPatternError(#[from] regex::Error),
    #[error(&quot;I/O error&quot;)]
    IoError(#[from] std::io::Error),
}
</code></pre></pre>
<h2 id="srclibrså®šä¹‰ç»“æ„ä½“å®ç°æ–¹æ³•å•å…ƒæµ‹è¯•"><a class="header" href="#srclibrså®šä¹‰ç»“æ„ä½“å®ç°æ–¹æ³•å•å…ƒæµ‹è¯•">src/lib.rsï¼šå®šä¹‰ç»“æ„ä½“+å®ç°æ–¹æ³•+å•å…ƒæµ‹è¯•</a></h2>
<h3 id="modå¼•å…¥ä¸ä½¿ç”¨"><a class="header" href="#modå¼•å…¥ä¸ä½¿ç”¨">modå¼•å…¥ä¸ä½¿ç”¨</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">mod error;
pub use error::GrepError;
</code></pre></pre>
<h3 id="å®šä¹‰ç»“æ„ä½“"><a class="header" href="#å®šä¹‰ç»“æ„ä½“">å®šä¹‰ç»“æ„ä½“</a></h3>
<h4 id="ä¸“é—¨ç®€åŒ–å¤æ‚ç±»å‹"><a class="header" href="#ä¸“é—¨ç®€åŒ–å¤æ‚ç±»å‹">ä¸“é—¨ç®€åŒ–å¤æ‚ç±»å‹</a></h4>
<blockquote>
<p>è¿™é‡Œå…¶å®å°±æ˜¯ä¼ å…¥ä¸€ä¸ªæŒ‡å®šç»“æ„çš„å‡½æ•°å¯¹è±¡</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">/// å®šä¹‰ç±»å‹ï¼Œè¿™æ ·ï¼Œåœ¨ä½¿ç”¨æ—¶å¯ä»¥ç®€åŒ–å¤æ‚ç±»å‹çš„ä¹¦å†™
pub type StrategyFn = fn(&amp;Path, &amp;mut dyn BufRead, &amp;Regex, &amp;mut dyn Write) -&gt; Result&lt;(), GrepError&gt;;
</code></pre></pre>
<h4 id="ä¸“é—¨çš„ç»“åˆç‰ˆæœ¬grepç»“æ„ä½“"><a class="header" href="#ä¸“é—¨çš„ç»“åˆç‰ˆæœ¬grepç»“æ„ä½“">ä¸“é—¨çš„ç»“åˆç‰ˆæœ¬grepç»“æ„ä½“</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// ç®€åŒ–ç‰ˆæœ¬çš„ grepï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼å’Œæ–‡ä»¶é€šé…ç¬¦
#[derive(Parser, Debug)]
#[clap(version = &quot;1.0&quot;, author = &quot;Tyr Chen &lt;tyr@chen.com&gt;&quot;)]
pub struct GrepConfig {
    /// ç”¨äºæŸ¥æ‰¾çš„æ­£åˆ™è¡¨è¾¾å¼
    pattern: String,
    /// æ–‡ä»¶é€šé…ç¬¦
    glob: String,
}
</code></pre></pre>
<h3 id="ç»™ç»“æ„ä½“å®ç°æ–¹æ³•"><a class="header" href="#ç»™ç»“æ„ä½“å®ç°æ–¹æ³•">ç»™ç»“æ„ä½“å®ç°æ–¹æ³•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">impl GrepConfig {
    /// ä½¿ç”¨ç¼ºçœç­–ç•¥æ¥æŸ¥æ‰¾åŒ¹é…
    pub fn match_with_default_strategy(&amp;self) -&gt; Result&lt;(), GrepError&gt; {
        self.match_with(default_strategy)
    }

    /// ä½¿ç”¨æŸä¸ªç­–ç•¥å‡½æ•°æ¥æŸ¥æ‰¾åŒ¹é…
    pub fn match_with(&amp;self, strategy: StrategyFn) -&gt; Result&lt;(), GrepError&gt; {
        let regex = Regex::new(&amp;self.pattern)?;
        // ç”Ÿæˆæ‰€æœ‰ç¬¦åˆé€šé…ç¬¦çš„æ–‡ä»¶åˆ—è¡¨
        let files: Vec&lt;_&gt; = glob::glob(&amp;self.glob)?.collect();
        // å¹¶è¡Œå¤„ç†æ‰€æœ‰æ–‡ä»¶
        files.into_par_iter().for_each(|v| {
            if let Ok(filename) = v {
                if let Ok(file) = File::open(&amp;filename) {
                    let mut reader = BufReader::new(file);
                    let mut stdout = io::stdout();

                    if let Err(e) = strategy(filename.as_path(), &amp;mut reader, &amp;regex, &amp;mut stdout) {
                        println!(&quot;Internal error: {:?}&quot;, e);
                    }
                }
            }
        });
        Ok(())
    }
}
</code></pre></pre>
<blockquote>
<p>ä¸»è¦å®ç°ä¸¤ç§è§£æç­–ç•¥ï¼š</p>
</blockquote>
<ol>
<li>é»˜è®¤ç­–ç•¥ï¼šmatch_with_default_strategy, ä½¿ç”¨default_strategy</li>
<li>æŒ‡å®šç­–ç•¥ï¼šmatch_with, ä½¿ç”¨ä¼ å…¥çš„strategy: StrategyFn</li>
</ol>
<h3 id="é»˜è®¤ç­–ç•¥-default_strategy"><a class="header" href="#é»˜è®¤ç­–ç•¥-default_strategy">é»˜è®¤ç­–ç•¥: default_strategy</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// ç¼ºçœç­–ç•¥ï¼Œä»å¤´åˆ°å°¾ä¸²è¡ŒæŸ¥æ‰¾ï¼Œæœ€åè¾“å‡ºåˆ° writer
pub fn default_strategy(
    path: &amp;Path,
    reader: &amp;mut dyn BufRead,
    pattern: &amp;Regex,
    writer: &amp;mut dyn Write,
) -&gt; Result&lt;(), GrepError&gt; {
    let matches: String = reader
        .lines()
        .enumerate()
        .map(|(lineno, line)| {
            line.ok()
                .map(|line| {
                    pattern
                        .find(&amp;line)
                        .map(|m| format_line(&amp;line, lineno + 1, m.range()))
                })
                .flatten()
        })
        .filter_map(|v| v.ok_or(()).ok())
        .join(&quot;\n&quot;);

    if !matches.is_empty() {
        writer.write_all(path.display().to_string().green().as_bytes())?;
        writer.write_all(b&quot;\n&quot;)?;
        writer.write_all(matches.as_bytes())?;
        writer.write_all(b&quot;\n&quot;)?;
    }

    Ok(())
}
</code></pre></pre>
<h3 id="æ ¼å¼åŒ–è¾“å‡º"><a class="header" href="#æ ¼å¼åŒ–è¾“å‡º">æ ¼å¼åŒ–è¾“å‡º</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// æ ¼å¼åŒ–è¾“å‡ºåŒ¹é…çš„è¡Œï¼ŒåŒ…å«è¡Œå·ï¼Œåˆ—å·å’Œå¸¦æœ‰é«˜äº®çš„ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
pub fn format_line(line: &amp;str, lineno: usize, range: Range&lt;usize&gt;) -&gt; String {
    let Range { start, end } = range;
    let prefix = &amp;line[..start];
    format!(
        &quot;{0: &gt;6}:{1: &lt;3} {2}{3}{4}&quot;,
        lineno.to_string().blue(),
        // æ‰¾åˆ°åŒ¹é…é¡¹çš„èµ·å§‹ä½ç½®ï¼Œæ³¨æ„å¯¹æ±‰å­—ç­‰é ascii å­—ç¬¦ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ prefix.len()
        // è¿™æ˜¯ä¸€ä¸ª O(n) çš„æ“ä½œï¼Œä¼šæ‹–ç´¯æ•ˆç‡ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºçš„æ•ˆæœ
        (prefix.chars().count() + 1).to_string().cyan(),
        prefix,
        &amp;line[start..end].red(),
        &amp;line[end..]
    )
}
</code></pre></pre>
<h3 id="å•å…ƒæµ‹è¯•"><a class="header" href="#å•å…ƒæµ‹è¯•">å•å…ƒæµ‹è¯•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#[cfg(test)]
mod tests {

    use super::*;

    #[test]
    fn format_line_should_work() {
        let result = format_line(&quot;Hello, Tyr~&quot;, 1000, 7..10);
        let expected = format!(
            &quot;{0: &gt;6}:{1: &lt;3} Hello, {2}~&quot;,
            &quot;1000&quot;.blue(),
            &quot;8&quot;.cyan(),
            &quot;Tyr&quot;.red()
        );
        assert_eq!(result, expected);
    }

    #[test]
    fn default_strategy_should_work() {
        let path = Path::new(&quot;src/main.rs&quot;);
        let input = b&quot;hello world!\nhey Tyr!&quot;;
        let mut reader = BufReader::new(&amp;input[..]);
        let pattern = Regex::new(r&quot;he\w+&quot;).unwrap();
        let mut writer = Vec::new();
        default_strategy(path, &amp;mut reader, &amp;pattern, &amp;mut writer).unwrap();
        let result = String::from_utf8(writer).unwrap();
        let expected = [
            String::from(&quot;src/main.rs&quot;),
            format_line(&quot;hello world!&quot;, 1, 0..5),
            format_line(&quot;hey Tyr!\n&quot;, 2, 0..3),
        ];

        assert_eq!(result, expected.join(&quot;\n&quot;));
    }
}
</code></pre></pre>
<h2 id="srcmainrs"><a class="header" href="#srcmainrs">src/main.rs</a></h2>
<h3 id="å¼•å…¥librsä¸­çš„å†…å®¹"><a class="header" href="#å¼•å…¥librsä¸­çš„å†…å®¹">å¼•å…¥lib.rsä¸­çš„å†…å®¹</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use itertools::Itertools;
</code></pre></pre>
<h3 id="ä¸»å‡½æ•°main"><a class="header" href="#ä¸»å‡½æ•°main">ä¸»å‡½æ•°ï¼šmain()</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use regex::Regex;
use std::{
    fs::File,
    io::{self, BufRead, BufReader, Write},
    ops::Range,
    path::Path,
};
</code></pre></pre>
<h2 id="ä½¿ç”¨"><a class="header" href="#ä½¿ç”¨">ä½¿ç”¨</a></h2>
<pre><code class="language-shell">cargo run --quiet -- &quot;Re[^\\s]+&quot; &quot;src/*.rs&quot;                                                                                                                                                                                            â”€â•¯
src/main.rs
     1:13  use anyhow::Result;
     5:14  fn main() -&gt; Result&lt;()&gt; {
src/error.rs
     7:14      #[error(&quot;Regex pattern error&quot;)]
     8:5       RegexPatternError(#[from] regex::Error),
src/lib.rs
     5:12  use regex::Regex;
     8:19      io::{self, BufRead, BufReader, Write},
    17:45  pub type StrategyFn = fn(&amp;Path, &amp;mut dyn BufRead, &amp;Regex, &amp;mut dyn Write) -&gt; Result&lt;(), GrepError&gt;;
    31:50      pub fn match_with_default_strategy(&amp;self) -&gt; Result&lt;(), GrepError&gt; {
    36:55      pub fn match_with(&amp;self, strategy: StrategyFn) -&gt; Result&lt;(), GrepError&gt; {
    37:21          let regex = Regex::new(&amp;self.pattern)?;
    44:41                      let mut reader = BufReader::new(file);
    60:25      reader: &amp;mut dyn BufRead,
    61:15      pattern: &amp;Regex,
    63:6   ) -&gt; Result&lt;(), GrepError&gt; {
   126:29          let mut reader = BufReader::new(&amp;input[..]);
   127:23          let pattern = Regex::new(r&quot;he\w+&quot;).unwrap();
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="thumborå›¾ç‰‡æœåŠ¡"><a class="header" href="#thumborå›¾ç‰‡æœåŠ¡">thumborå›¾ç‰‡æœåŠ¡</a></h1>
<!--ts-->
<!--te-->
<h2 id="abiproto"><a class="header" href="#abiproto">abi.proto</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">syntax = &quot;proto3&quot;;

package abi;

// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
message ImageSpec { repeated Spec specs = 1; }

// å¤„ç†å›¾ç‰‡æ”¹å˜å¤§å°
message Resize {
  uint32 width = 1;
  uint32 height = 2;

  enum ResizeType {
    NORMAL = 0;
    SEAM_CARVE = 1;
  }

  ResizeType rtype = 3;

  enum SampleFilter {
    UNDEFINED = 0;
    NEAREST = 1;
    TRIANGLE = 2;
    CATMULL_ROM = 3;
    GAUSSIAN = 4;
    LANCZOS3 = 5;
  }

  SampleFilter filter = 4;
}

// å¤„ç†å›¾ç‰‡æˆªå–
message Crop {
  uint32 x1 = 1;
  uint32 y1 = 2;
  uint32 x2 = 3;
  uint32 y2 = 4;
}

// å¤„ç†æ°´å¹³ç¿»è½¬
message Fliph {}
// å¤„ç†å‚ç›´ç¿»è½¬
message Flipv {}
// å¤„ç†å¯¹æ¯”åº¦
message Contrast { float contrast = 1; }
// å¤„ç†æ»¤é•œ
message Filter {
  enum Filter {
    UNSPECIFIED = 0;
    OCEANIC = 1;
    ISLANDS = 2;
    MARINE = 3;
    // more: https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html
  }
  Filter filter = 1;
}

// å¤„ç†æ°´å°
message Watermark {
  uint32 x = 1;
  uint32 y = 2;
}

// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
message Spec {
  oneof data {
    Resize resize = 1;
    Crop crop = 2;
    Flipv flipv = 3;
    Fliph fliph = 4;
    Contrast contrast = 5;
    Filter filter = 6;
    Watermark watermark = 7;
  }
}
</code></pre></pre>
<h2 id="buildrs"><a class="header" href="#buildrs">build.rs</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">use std::process::Command;

fn main() {
    // åœ¨ç¼–è¯‘æ—¶å¯é€‰æ‹©æ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚
    let build_enabled = option_env!(&quot;BUILD_PROTO&quot;)
        .map(|v| v == &quot;1&quot;)
        .unwrap_or(false);
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç¯å¢ƒå˜é‡çš„å¯¹åº”å€¼ï¼Œå°±ç›´æ¥returnï¼Œä¸å†è¿›è¡Œåç»­ç¼–è¯‘
    if !build_enabled {
        println!(&quot;=== Skipped compiling protos ===&quot;);
        return;
    }
    // ä½¿ç”¨ prost_build æŠŠ abi.proto ç¼–è¯‘åˆ° src/pb ç›®å½•ä¸‹
    prost_build::Config::new()
        .out_dir(&quot;src/pb&quot;)
        .compile_protos(&amp;[&quot;abi.proto&quot;], &amp;[&quot;.&quot;])
        .unwrap();
    Command::new(&quot;cargo&quot;)
        .args(&amp;[&quot;fmt&quot;, &quot;--&quot;, &quot;src/*.rs&quot;])
        .status()
        .expect(&quot;cargo fmt failed&quot;);
}
</code></pre></pre>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.option_env.html">option_env in std - Rust</a></li>
</ul>
<blockquote>
<p>åœ¨ç¼–è¯‘æ—¶å¯é€‰æ‹©æ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚</p>
</blockquote>
<h2 id="å…³äºrustçš„æ¨¡å—"><a class="header" href="#å…³äºrustçš„æ¨¡å—">å…³äºrustçš„æ¨¡å—</a></h2>
<blockquote>
<p>å¯ä»¥å‚è€ƒè¿™ç¯‡ï¼š<a href="https://zhuanlan.zhihu.com/p/443926839">Rust æ¨¡å—ç³»ç»Ÿç†è§£ - çŸ¥ä¹</a></p>
</blockquote>
<div id="admonition-modå…¨è®¤è¯†" class="admonition tip">
<div class="admonition-title">
<p>modå…¨è®¤è¯†</p>
<p><a class="admonition-anchor-link" href="thumbor.html#admonition-modå…¨è®¤è¯†"></a></p>
</div>
<div>
<ol>
<li>mod(mod.rsæˆ–modå…³é”®å­—)å°†ä»£ç åˆ†ä¸ºå¤šä¸ªé€»è¾‘æ¨¡å—ï¼Œå¹¶ç®¡ç†è¿™äº›æ¨¡å—çš„å¯è§æ€§ï¼ˆpublic / privateï¼‰ã€‚</li>
<li>æ¨¡å—æ˜¯é¡¹ï¼ˆitemï¼‰çš„é›†åˆï¼Œé¡¹å¯ä»¥æ˜¯ï¼šå‡½æ•°ï¼Œç»“æ„ä½“ï¼Œtraitï¼Œimplå—ï¼Œç”šè‡³å…¶å®ƒæ¨¡å—ã€‚</li>
<li>ä¸€ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ç ï¼Œå¯ä»¥é€šè¿‡ mod.rs å£°æ˜</li>
<li>Rustæ¨¡å—æœ‰ä¸‰ç§å½¢å¼:
<ul>
<li>mod.rs: ä¸€ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰ä»£ç ï¼Œå¯ä»¥é€šè¿‡ mod.rs å£°æ˜</li>
<li>æ–‡ä»¶/ç›®å½•å³æ¨¡å—ï¼šç¼–è¯‘å™¨çš„æœºåˆ¶å†³å®šï¼Œé™¤äº†mod.rså¤–ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚ä¸å…è®¸åªåˆ†æ‹†æ–‡ä»¶ï¼Œä½†æ˜¯ä¸å£°æ˜modï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨pub useï¼Œåœ¨çˆ¶ç©ºé—´ç›´æ¥è°ƒç”¨å­ç©ºé—´çš„å‡½æ•°ã€‚</li>
<li>modå…³é”®å­—: åœ¨æ–‡ä»¶å†…éƒ¨åˆ†æ‹†æ¨¡å—</li>
</ul>
</li>
<li>Rustç¼–è¯‘å™¨åªæ¥å—ä¸€ä¸ªæºæ–‡ä»¶ï¼Œè¾“å‡ºä¸€ä¸ªcrate</li>
<li>æ¯ä¸€ä¸ªcrateéƒ½æœ‰ä¸€ä¸ªåŒ¿åçš„æ ¹å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´å¯ä»¥æ— é™åµŒå¥—</li>
<li>â€œmod mod-name { â€¦ }â€œ å°†å¤§æ‹¬å·ä¸­çš„ä»£ç ç½®äºå‘½åç©ºé—´mod-nameä¹‹ä¸‹</li>
<li>â€œuse mod-name1::mod-name2;â€œ å¯ä»¥æ‰“å¼€å‘½åç©ºé—´ï¼Œå‡å°‘æ— ä¼‘æ­¢çš„::æ“ä½œç¬¦</li>
<li>â€œmod mod-name;â€œ å¯ä»¥æŒ‡å¯¼ç¼–è¯‘å™¨å°†å¤šä¸ªæ–‡ä»¶ç»„è£…æˆä¸€ä¸ªæ–‡ä»¶</li>
<li>â€œpub use mod-nam1::mod-name2::item-name;â€œ
è¯­å¥å¯ä»¥å°†mod-name2ä¸‹çš„item-nameæå‡åˆ°è¿™æ¡è¯­å¥æ‰€åœ¨çš„ç©ºé—´ï¼Œitem-nameé€šå¸¸æ˜¯å‡½æ•°æˆ–è€…ç»“æ„ä½“ã€‚Rustç¤¾åŒºé€šå¸¸ç”¨è¿™ä¸ªæ–¹æ³•æ¥ç¼©çŸ­åº“APIçš„å‘½åç©ºé—´æ·±åº¦
ç¼–è¯‘å™¨è§„å®šuseè¯­å¥ä¸€å®šè¦åœ¨modè¯­å¥ä¹‹å‰</li>
</ol>
</div>
</div>
<h2 id="modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»"><a class="header" href="#modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»">modæ–‡ä»¶å®šä¹‰ä¸å®ç°åˆ†ç¦»</a></h2>
<p>åœ¨rustä¸­ï¼Œä¸€èˆ¬ä¼šåœ¨æ¨¡å—çš„mod.rsæ–‡ä»¶ä¸­å¯¹ä¾›å¤–éƒ¨ä½¿ç”¨çš„é¡¹è¿›è¡Œå®ç°, é¡¹å¯ä»¥æ˜¯ï¼šå‡½æ•°ï¼Œç»“æ„ä½“ï¼Œtraitï¼Œimplå—ï¼Œç”šè‡³å…¶å®ƒæ¨¡å—.
è¿™æ ·æœ‰ä¸ªå¥½å¤„ï¼Œé«˜å†…èšï¼Œå¯ä»¥åœ¨ä»£ç å¢é•¿æ—¶ï¼Œå°†å˜åŠ¨å±€é™åœ¨æœåŠ¡æä¾›è€…å†…éƒ¨ï¼Œå¯¹å¤–æä¾›çš„apiä¸å˜ï¼Œä¸ä¼šé€ æˆç ´åæ€§æ›´æ–°ã€‚</p>
<h2 id="pbæ¨¡å—-å¤„ç†protobuf"><a class="header" href="#pbæ¨¡å—-å¤„ç†protobuf">pbæ¨¡å—: å¤„ç†protobuf</a></h2>
<h3 id="pbmodrså£°æ˜æ¨¡å—"><a class="header" href="#pbmodrså£°æ˜æ¨¡å—">pb/mod.rså£°æ˜æ¨¡å—</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">mod abi; // å£°æ˜ abi.rs
pub use abi::*;
</code></pre></pre>
<h3 id="pbabirsé‡Œé¢è¿˜æœ‰å­æ¨¡å—"><a class="header" href="#pbabirsé‡Œé¢è¿˜æœ‰å­æ¨¡å—">pb/abi.rsé‡Œé¢è¿˜æœ‰å­æ¨¡å—</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Spec`.
pub mod spec {
    #[derive(Clone, PartialEq, ::prost::Oneof)]
    pub enum Data {
        #[prost(message, tag = &quot;1&quot;)]
        Resize(super::Resize),
        #[prost(message, tag = &quot;2&quot;)]
        Crop(super::Crop),
        #[prost(message, tag = &quot;3&quot;)]
        Flipv(super::Flipv),
        #[prost(message, tag = &quot;4&quot;)]
        Fliph(super::Fliph),
        #[prost(message, tag = &quot;5&quot;)]
        Contrast(super::Contrast),
        #[prost(message, tag = &quot;6&quot;)]
        Filter(super::Filter),
        #[prost(message, tag = &quot;7&quot;)]
        Watermark(super::Watermark),
    }
}
</code></pre></pre>
<h3 id="pbabirså¦å¤–å®šä¹‰äº†specdataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“åµŒå¥—æ¨¡å—mod"><a class="header" href="#pbabirså¦å¤–å®šä¹‰äº†specdataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“åµŒå¥—æ¨¡å—mod">pb/abi.rså¦å¤–å®šä¹‰äº†spec::Dataé‡Œé¢çš„å„ä¸ªå…ƒç´ ç»“æ„ä½“/åµŒå¥—æ¨¡å—mod</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct ImageSpec {
    #[prost(message, repeated, tag = &quot;1&quot;)]
    pub specs: ::prost::alloc::vec::Vec&lt;Spec&gt;,
}
/// å¤„ç†å›¾ç‰‡æ”¹å˜å¤§å°
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Resize {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub width: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub height: u32,
    #[prost(enumeration = &quot;resize::ResizeType&quot;, tag = &quot;3&quot;)]
    pub rtype: i32,
    #[prost(enumeration = &quot;resize::SampleFilter&quot;, tag = &quot;4&quot;)]
    pub filter: i32,
}
/// Nested message and enum types in `Resize`.
pub mod resize {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum ResizeType {
        Normal = 0,
        SeamCarve = 1,
    }
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum SampleFilter {
        Undefined = 0,
        Nearest = 1,
        Triangle = 2,
        CatmullRom = 3,
        Gaussian = 4,
        Lanczos3 = 5,
    }
}
/// å¤„ç†å›¾ç‰‡æˆªå–
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Crop {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub x1: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub y1: u32,
    #[prost(uint32, tag = &quot;3&quot;)]
    pub x2: u32,
    #[prost(uint32, tag = &quot;4&quot;)]
    pub y2: u32,
}
/// å¤„ç†æ°´å¹³ç¿»è½¬
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Fliph {}
/// å¤„ç†å‚ç›´ç¿»è½¬
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Flipv {}
/// å¤„ç†å¯¹æ¯”åº¦
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Contrast {
    #[prost(float, tag = &quot;1&quot;)]
    pub contrast: f32,
}
/// å¤„ç†æ»¤é•œ
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Filter {
    #[prost(enumeration = &quot;filter::Filter&quot;, tag = &quot;1&quot;)]
    pub filter: i32,
}
/// Nested message and enum types in `Filter`.
pub mod filter {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum Filter {
        Unspecified = 0,
        Oceanic = 1,
        Islands = 2,
        /// more: &lt;https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html&gt;
        Marine = 3,
    }
}
/// å¤„ç†æ°´å°
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Watermark {
    #[prost(uint32, tag = &quot;1&quot;)]
    pub x: u32,
    #[prost(uint32, tag = &quot;2&quot;)]
    pub y: u32,
}
</code></pre></pre>
<h3 id="pbabirsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“"><a class="header" href="#pbabirsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“">pb/abi.rsæœ‰ä¸ªç‰¹æ®Šç»“æ„ä½“</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Spec {
    #[prost(oneof = &quot;spec::Data&quot;, tags = &quot;1, 2, 3, 4, 5, 6, 7&quot;)]
    pub data: ::core::option::Option&lt;spec::Data&gt;,
}
</code></pre></pre>
<h3 id="imagespec"><a class="header" href="#imagespec">ImageSpec</a></h3>
<h4 id="å®šä¹‰æœ‰åºæ•°ç»„"><a class="header" href="#å®šä¹‰æœ‰åºæ•°ç»„">å®šä¹‰ï¼šæœ‰åºæ•°ç»„</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª ImageSpec æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼ŒæœåŠ¡å™¨æŒ‰ç…§ spec çš„é¡ºåºå¤„ç†
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct ImageSpec {
    #[prost(message, repeated, tag = &quot;1&quot;)]
    pub specs: ::prost::alloc::vec::Vec&lt;Spec&gt;,
}
</code></pre></pre>
<h4 id="å®ç°newæ–¹æ³•fromtryfromå®ç°ç±»å‹è½¬åŒ–"><a class="header" href="#å®ç°newæ–¹æ³•fromtryfromå®ç°ç±»å‹è½¬åŒ–">å®ç°ï¼šnewæ–¹æ³•ã€From&amp;TryFromå®ç°ç±»å‹è½¬åŒ–</a></h4>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">impl ImageSpec {
    pub fn new(specs: Vec&lt;Spec&gt;) -&gt; Self {
        Self { specs }
    }
}

// è®© ImageSpec å¯ä»¥ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²
impl From&lt;&amp;ImageSpec&gt; for String {
    fn from(image_spec: &amp;ImageSpec) -&gt; Self {
        let data = image_spec.encode_to_vec();
        encode_config(data, URL_SAFE_NO_PAD)
    }
}

// è®© ImageSpec å¯ä»¥é€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²åˆ›å»ºã€‚æ¯”å¦‚ s.parse().unwrap()
impl TryFrom&lt;&amp;str&gt; for ImageSpec {
    type Error = anyhow::Error;

    fn try_from(value: &amp;str) -&gt; Result&lt;Self, Self::Error&gt; {
        let data = decode_config(value, URL_SAFE_NO_PAD)?;
        Ok(ImageSpec::decode(&amp;data[..])?)
    }
}
</code></pre></pre>
<h3 id="filter"><a class="header" href="#filter">Filter</a></h3>
<h4 id="å®šä¹‰æšä¸¾ä½“mod"><a class="header" href="#å®šä¹‰æšä¸¾ä½“mod">å®šä¹‰ï¼šæšä¸¾ä½“mod</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Filter`.
pub mod filter {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum Filter {
        Unspecified = 0,
        Oceanic = 1,
        Islands = 2,
        /// more: &lt;https://docs.rs/photon-rs/0.3.1/photon_rs/filters/fn.filter.html&gt;
        Marine = 3,
    }
}
</code></pre></pre>
<h4 id="å®ç°åŒå¼•å·çš„ä½¿ç”¨æ¨¡å¼åŒ¹é…"><a class="header" href="#å®ç°åŒå¼•å·çš„ä½¿ç”¨æ¨¡å¼åŒ¹é…">å®ç°ï¼šåŒå¼•å·çš„ä½¿ç”¨ã€æ¨¡å¼åŒ¹é…</a></h4>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">// è¾…åŠ©å‡½æ•°ï¼Œphoton_rs ç›¸åº”çš„æ–¹æ³•é‡Œéœ€è¦å­—ç¬¦ä¸²
impl filter::Filter {
    pub fn to_str(self) -&gt; Option&lt;&amp;'static str&gt; {
        match self {
            filter::Filter::Unspecified =&gt; None,
            filter::Filter::Oceanic =&gt; Some(&quot;oceanic&quot;),
            filter::Filter::Islands =&gt; Some(&quot;islands&quot;),
            filter::Filter::Marine =&gt; Some(&quot;marine&quot;),
        }
    }
}
</code></pre></pre>
<h3 id="samplefilter"><a class="header" href="#samplefilter">SampleFilter</a></h3>
<h4 id="å®šä¹‰æšä¸¾ä½“mod-1"><a class="header" href="#å®šä¹‰æšä¸¾ä½“mod-1">å®šä¹‰ï¼šæšä¸¾ä½“mod</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// Nested message and enum types in `Resize`.
pub mod resize {
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum ResizeType {
        Normal = 0,
        SeamCarve = 1,
    }
    #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord, ::prost::Enumeration)]
    #[repr(i32)]
    pub enum SampleFilter {
        Undefined = 0,
        Nearest = 1,
        Triangle = 2,
        CatmullRom = 3,
        Gaussian = 4,
        Lanczos3 = 5,
    }
}
</code></pre></pre>
<h3 id="å®ç°modä½¿ç”¨åŒå¼•å·fromè½¬ä¸ºä¸åŒç»“æœ"><a class="header" href="#å®ç°modä½¿ç”¨åŒå¼•å·fromè½¬ä¸ºä¸åŒç»“æœ">å®ç°ï¼šmodä½¿ç”¨åŒå¼•å·ã€Fromè½¬ä¸ºä¸åŒç»“æœ</a></h3>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">impl From&lt;resize::SampleFilter&gt; for SamplingFilter {
    fn from(v: resize::SampleFilter) -&gt; Self {
        match v {
            resize::SampleFilter::Undefined =&gt; SamplingFilter::Nearest,
            resize::SampleFilter::Nearest =&gt; SamplingFilter::Nearest,
            resize::SampleFilter::Triangle =&gt; SamplingFilter::Triangle,
            resize::SampleFilter::CatmullRom =&gt; SamplingFilter::CatmullRom,
            resize::SampleFilter::Gaussian =&gt; SamplingFilter::Gaussian,
            resize::SampleFilter::Lanczos3 =&gt; SamplingFilter::Lanczos3,
        }
    }
}
</code></pre></pre>
<h3 id="spec"><a class="header" href="#spec">Spec</a></h3>
<h4 id="å®šä¹‰ç»“æ„ä½“-1"><a class="header" href="#å®šä¹‰ç»“æ„ä½“-1">å®šä¹‰ï¼šç»“æ„ä½“</a></h4>
<ul>
<li>pb/abi.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">/// ä¸€ä¸ª spec å¯ä»¥åŒ…å«ä¸Šè¿°çš„å¤„ç†æ–¹å¼ä¹‹ä¸€
#[derive(Clone, PartialEq, ::prost::Message)]
pub struct Spec {
    #[prost(oneof = &quot;spec::Data&quot;, tags = &quot;1, 2, 3, 4, 5, 6, 7&quot;)]
    pub data: ::core::option::Option&lt;spec::Data&gt;,
}
</code></pre></pre>
<h4 id="å®ç°ç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•self"><a class="header" href="#å®ç°ç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•self">å®ç°ï¼šç±»ä¼¼é¢å‘å¯¹è±¡ä¸­æ·»åŠ ç±»æ–¹æ³•Self</a></h4>
<blockquote>
<p>æ³¨æ„åŒºåˆ«Selfå’Œselfçš„ä½¿ç”¨ï¼š
<a href="https://stackoverflow.com/questions/32304595/whats-the-difference-between-self-and-self">rust - Whatâ€™s the difference between self and Self? - Stack Overflow</a></p>
</blockquote>
<ul>
<li>pb/mod.rs</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">// æä¾›ä¸€äº›è¾…åŠ©å‡½æ•°ï¼Œè®©åˆ›å»ºä¸€ä¸ª spec çš„è¿‡ç¨‹ç®€å•ä¸€äº›
impl Spec {
    pub fn new_resize_seam_carve(width: u32, height: u32) -&gt; Self {
        Self {
            data: Some(spec::Data::Resize(Resize {
                width,
                height,
                rtype: resize::ResizeType::SeamCarve as i32,
                filter: resize::SampleFilter::Undefined as i32,
            })),
        }
    }

    pub fn new_resize(width: u32, height: u32, filter: resize::SampleFilter) -&gt; Self {
        Self {
            data: Some(spec::Data::Resize(Resize {
                width,
                height,
                rtype: resize::ResizeType::Normal as i32,
                filter: filter as i32,
            })),
        }
    }

    pub fn new_filter(filter: filter::Filter) -&gt; Self {
        Self {
            data: Some(spec::Data::Filter(Filter {
                filter: filter as i32,
            })),
        }
    }

    pub fn new_watermark(x: u32, y: u32) -&gt; Self {
        Self {
            data: Some(spec::Data::Watermark(Watermark { x, y })),
        }
    }
}
</code></pre></pre>
<h3 id="å•å…ƒæµ‹è¯•-1"><a class="header" href="#å•å…ƒæµ‹è¯•-1">å•å…ƒæµ‹è¯•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#[cfg(test)]
mod tests {
    use super::*;
    use std::borrow::Borrow;

    #[test]
    fn encoded_spec_could_be_decoded() {
        let spec1 = Spec::new_resize(600, 600, resize::SampleFilter::CatmullRom);
        let spec2 = Spec::new_filter(filter::Filter::Marine);
        let image_spec = ImageSpec::new(vec![spec1, spec2]);
        let s: String = image_spec.borrow().into();
        assert_eq!(image_spec, s.as_str().try_into().unwrap());
    }
}
</code></pre></pre>
<h2 id="engineæ¨¡å—-å¤„ç†å›¾ç‰‡"><a class="header" href="#engineæ¨¡å—-å¤„ç†å›¾ç‰‡">engineæ¨¡å—: å¤„ç†å›¾ç‰‡</a></h2>
<h3 id="modrs-å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait"><a class="header" href="#modrs-å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait">mod.rs: å®šä¹‰ç»Ÿä¸€çš„å¼•æ“trait</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// Engine traitï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šçš„ engineï¼Œä¸»æµç¨‹åªéœ€è¦æ›¿æ¢ engine
pub trait Engine {
    // å¯¹ engine æŒ‰ç…§ specs è¿›è¡Œä¸€ç³»åˆ—æœ‰åºçš„å¤„ç†
    fn apply(&amp;mut self, specs: &amp;[Spec]);
    // ä» engine ä¸­ç”Ÿæˆç›®æ ‡å›¾ç‰‡ï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ selfï¼Œè€Œé self çš„å¼•ç”¨
    fn generate(self, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt;;
}

// SpecTransformï¼šæœªæ¥å¦‚æœæ·»åŠ æ›´å¤šçš„ specï¼Œåªéœ€è¦å®ç°å®ƒå³å¯
pub trait SpecTransform&lt;T&gt; {
    // å¯¹å›¾ç‰‡ä½¿ç”¨ op åš transform
    fn transform(&amp;mut self, op: T);
}
</code></pre></pre>
<h3 id="photonrs--é™æ€å˜é‡åŠ è½½"><a class="header" href="#photonrs--é™æ€å˜é‡åŠ è½½">photon.rs &gt; é™æ€å˜é‡åŠ è½½</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">lazy_static! {
    // é¢„å…ˆæŠŠæ°´å°æ–‡ä»¶åŠ è½½ä¸ºé™æ€å˜é‡
    static ref WATERMARK: PhotonImage = {
        let data = include_bytes!(&quot;../../rust-logo.png&quot;);
        let watermark = open_image_from_bytes(data).unwrap();
        transform::resize(&amp;watermark, 64, 64, transform::SamplingFilter::Nearest)
    };
}
</code></pre></pre>
<h3 id="photonrs--å…·ä½“å¼•æ“photonçš„å®šä¹‰ä¸è½¬åŒ–tryfrom"><a class="header" href="#photonrs--å…·ä½“å¼•æ“photonçš„å®šä¹‰ä¸è½¬åŒ–tryfrom">photon.rs &gt; å…·ä½“å¼•æ“Photonçš„å®šä¹‰ä¸è½¬åŒ–TryFrom</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">pub struct Photon(PhotonImage);

// ä» Bytes è½¬æ¢æˆ Photon ç»“æ„
impl TryFrom&lt;Bytes&gt; for Photon {
    type Error = anyhow::Error;

    fn try_from(data: Bytes) -&gt; Result&lt;Self, Self::Error&gt; {
        Ok(Self(open_image_from_bytes(&amp;data)?))
    }
}
</code></pre></pre>
<h3 id="photonrs--å…·ä½“å¼•æ“photonçš„traitå®ç°"><a class="header" href="#photonrs--å…·ä½“å¼•æ“photonçš„traitå®ç°">photon.rs &gt; å…·ä½“å¼•æ“Photonçš„traitå®ç°</a></h3>
<h4 id="engine-trait"><a class="header" href="#engine-trait">Engine Trait</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">impl Engine for Photon {
    fn apply(&amp;mut self, specs: &amp;[Spec]) {
        for spec in specs.iter() {
            match spec.data {
                Some(spec::Data::Crop(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Contrast(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Filter(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Fliph(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Flipv(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Resize(ref v)) =&gt; self.transform(v),
                Some(spec::Data::Watermark(ref v)) =&gt; self.transform(v),
                // å¯¹äºç›®å‰ä¸è®¤è¯†çš„ specï¼Œä¸åšä»»ä½•å¤„ç†
                _ =&gt; {}
            }
        }
    }
</code></pre></pre>
<h4 id="spectransform-trait"><a class="header" href="#spectransform-trait">SpecTransform Trait</a></h4>
<h5 id="æ ¼å¼è¯­ä¹‰åŒ–"><a class="header" href="#æ ¼å¼è¯­ä¹‰åŒ–">æ ¼å¼è¯­ä¹‰åŒ–</a></h5>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl SpecTransform(&amp;OpreationName) for SpecificEngine {
    fn transform(&amp;mut self, _op: &amp;OperationName) {
        transform::OperationMethod(&amp;mut self.0)
    }
}
<span class="boring">}
</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust  editable">impl SpecTransform&lt;&amp;Crop&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Crop) {
        let img = transform::crop(&amp;mut self.0, op.x1, op.y1, op.x2, op.y2);
        self.0 = img;
    }
}

impl SpecTransform&lt;&amp;Contrast&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Contrast) {
        effects::adjust_contrast(&amp;mut self.0, op.contrast);
    }
}

impl SpecTransform&lt;&amp;Flipv&gt; for Photon {
    fn transform(&amp;mut self, _op: &amp;Flipv) {
        transform::flipv(&amp;mut self.0)
    }
}

impl SpecTransform&lt;&amp;Fliph&gt; for Photon {
    fn transform(&amp;mut self, _op: &amp;Fliph) {
        transform::fliph(&amp;mut self.0)
    }
}

impl SpecTransform&lt;&amp;Filter&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Filter) {
        match filter::Filter::from_i32(op.filter) {
            Some(filter::Filter::Unspecified) =&gt; {}
            Some(f) =&gt; filters::filter(&amp;mut self.0, f.to_str().unwrap()),
            _ =&gt; {}
        }
    }
}

impl SpecTransform&lt;&amp;Resize&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Resize) {
        let img = match resize::ResizeType::from_i32(op.rtype).unwrap() {
            resize::ResizeType::Normal =&gt; transform::resize(
                &amp;self.0,
                op.width,
                op.height,
                resize::SampleFilter::from_i32(op.filter).unwrap().into(),
            ),
            resize::ResizeType::SeamCarve =&gt; transform::seam_carve(&amp;self.0, op.width, op.height),
        };
        self.0 = img;
    }
}

impl SpecTransform&lt;&amp;Watermark&gt; for Photon {
    fn transform(&amp;mut self, op: &amp;Watermark) {
        multiple::watermark(&amp;mut self.0, &amp;WATERMARK, op.x, op.y);
    }
}
</code></pre></pre>
<h3 id="photonrs--åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•"><a class="header" href="#photonrs--åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•">photon.rs &gt; åœ¨å†…å­˜ä¸­å¯¹å›¾ç‰‡è½¬æ¢æ ¼å¼çš„æ–¹æ³•</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">fn image_to_buf(img: PhotonImage, format: ImageOutputFormat) -&gt; Vec&lt;u8&gt; {
    let raw_pixels = img.get_raw_pixels();
    let width = img.get_width();
    let height = img.get_height();

    let img_buffer = ImageBuffer::from_vec(width, height, raw_pixels).unwrap();
    let dynimage = DynamicImage::ImageRgba8(img_buffer);

    let mut buffer = Vec::with_capacity(32768);
    dynimage.write_to(&amp;mut buffer, format).unwrap();
    buffer
}
</code></pre></pre>
<h2 id="mainrs"><a class="header" href="#mainrs">main.rs</a></h2>
<h3 id="å…ˆå¼•å…¥modå†use"><a class="header" href="#å…ˆå¼•å…¥modå†use">å…ˆå¼•å…¥modï¼Œå†use</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// å‚æ•°ä½¿ç”¨ serde åš Deserializeï¼Œaxum ä¼šè‡ªåŠ¨è¯†åˆ«å¹¶è§£æ
#[derive(Deserialize)]
struct Params {
    spec: String,
    url: String,
}
</code></pre></pre>
<h3 id="å›¾ç‰‡èµ„æºç”¨åˆ°lruç­–ç•¥ç¼“å­˜typeå®šä¹‰"><a class="header" href="#å›¾ç‰‡èµ„æºç”¨åˆ°lruç­–ç•¥ç¼“å­˜typeå®šä¹‰">å›¾ç‰‡èµ„æºç”¨åˆ°Lruç­–ç•¥ç¼“å­˜typeå®šä¹‰</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">type Cache = Arc&lt;Mutex&lt;LruCache&lt;u64, Bytes&gt;&gt;&gt;;
</code></pre></pre>
<h3 id="ä¸»æµç¨‹mainå‡½æ•°"><a class="header" href="#ä¸»æµç¨‹mainå‡½æ•°">ä¸»æµç¨‹mainå‡½æ•°</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#[tokio::main]
async fn main() {
    // åˆå§‹åŒ– tracing
    tracing_subscriber::fmt::init();
    let cache: Cache = Arc::new(Mutex::new(LruCache::new(1024)));
    // æ„å»ºè·¯ç”±
    let app = Router::new()
        // `GET /` ä¼šæ‰§è¡Œ
        .route(&quot;/image/:spec/:url&quot;, get(generate))
        .layer(
            ServiceBuilder::new()
                .load_shed()
                .concurrency_limit(1024)
                .timeout(Duration::from_secs(10))
                .layer(TraceLayer::new_for_http())
                .layer(AddExtensionLayer::new(cache))
                .layer(CompressionLayer::new())
                .into_inner(),
        );

    // è¿è¡Œ web æœåŠ¡å™¨
    let addr = &quot;127.0.0.1:3000&quot;.parse().unwrap();
    print_test_url(&quot;https://images.pexels.com/photos/1562477/pexels-photo-1562477.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=3&amp;h=750&amp;w=1260&quot;);
    info!(&quot;Listening on {}&quot;, addr);
    axum::Server::bind(&amp;addr)
        .serve(app.into_make_service())
        .await
        .unwrap();
}
</code></pre></pre>
<h4 id="å»ºé€ è€…æ¨¡å¼"><a class="header" href="#å»ºé€ è€…æ¨¡å¼">å»ºé€ è€…æ¨¡å¼</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">            ServiceBuilder::new()
                .load_shed()
                .concurrency_limit(1024)
                .timeout(Duration::from_secs(10))
                .layer(TraceLayer::new_for_http())
                .layer(AddExtensionLayer::new(cache))
                .layer(CompressionLayer::new())
                .into_inner(),
</code></pre></pre>
<h4 id="ç±»å‹è½¬æ¢"><a class="header" href="#ç±»å‹è½¬æ¢">ç±»å‹è½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">    // è¿è¡Œ web æœåŠ¡å™¨
    let addr = &quot;127.0.0.1:3000&quot;.parse().unwrap();
</code></pre></pre>
<h5 id="æ•°å­—ä¸å­—ç¬¦ä¸²"><a class="header" href="#æ•°å­—ä¸å­—ç¬¦ä¸²">æ•°å­—ä¸å­—ç¬¦ä¸²</a></h5>
<p>||i32|u32|f64|String*|
|--|---|---|---|-------|
|i32|\|x as u32|x as f64|x.to_string()|
|u32|x as i32|\|x as f64|x.to_string()|
|f64|x as i32|x as u32|\|x.to_string()|
|String*|x.parse().unwrap()|x.parse().unwrap()|x.parse().unwrap()|\|</p>
<h5 id="string-ä¸--str"><a class="header" href="#string-ä¸--str">String ä¸ &amp; str</a></h5>
<p>|\|String|&amp;str|
|-|------|----|
|String|\|&amp;*x|
|&amp;str|x.to_string()|\|</p>
<h5 id="æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆ</a></h5>
<p>|\|Vec&lt;T&gt;|&amp;[T]|Box&lt;[T]&gt;|
|-|------|----|--------|
|Vec&lt;T&gt;|\|&amp;x[â€¦]|x.into_boxed_slice()|
|&amp;[T]|x.to_vec()|\|Box::new(*x)|
|Box&lt;[T]&gt;|x.to_vec()|&amp;*x|\|</p>
<h3 id="è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler"><a class="header" href="#è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler">è·¯ç”±ç»‘å®šçš„å¤„ç†å‡½æ•°handler</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// basic handler that responds with a static string
async fn generate(
    Path(Params { spec, url }): Path&lt;Params&gt;,
    Extension(cache): Extension&lt;Cache&gt;,
) -&gt; Result&lt;(HeaderMap, Vec&lt;u8&gt;), StatusCode&gt; {
    let spec: ImageSpec = spec
        .as_str()
        .try_into()
        .map_err(|_| StatusCode::BAD_REQUEST)?;

    let url: &amp;str = &amp;percent_decode_str(&amp;url).decode_utf8_lossy();
    let data = retrieve_image(url, cache)
        .await
        .map_err(|_| StatusCode::BAD_REQUEST)?;

    // ä½¿ç”¨ image engine å¤„ç†
    let mut engine: Photon = data
        .try_into()
        .map_err(|_| StatusCode::INTERNAL_SERVER_ERROR)?;
    engine.apply(&amp;spec.specs);
    // TODO: è¿™é‡Œç›®å‰ç±»å‹å†™æ­»äº†ï¼Œåº”è¯¥ä½¿ç”¨ content negotiation
    let image = engine.generate(ImageOutputFormat::Jpeg(85));

    info!(&quot;Finished processing: image size {}&quot;, image.len());
    let mut headers = HeaderMap::new();

    headers.insert(&quot;content-type&quot;, HeaderValue::from_static(&quot;image/jpeg&quot;));
    Ok((headers, image))
}
</code></pre></pre>
<h3 id="å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•"><a class="header" href="#å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•">å¤„ç†å‡½æ•°ç”¨åˆ°çš„å›¾ç‰‡è·å–æ–¹æ³•</a></h3>
<blockquote>
<p>å¯¹äºå›¾ç‰‡çš„ç½‘ç»œè¯·æ±‚ï¼Œæˆ‘ä»¬å…ˆæŠŠ URL åšä¸ªå“ˆå¸Œï¼Œåœ¨ LRU ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°æ‰ç”¨ reqwest å‘é€è¯·æ±‚ã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">#[instrument(level = &quot;info&quot;, skip(cache))]
async fn retrieve_image(url: &amp;str, cache: Cache) -&gt; Result&lt;Bytes&gt; {
    let mut hasher = DefaultHasher::new();
    url.hash(&amp;mut hasher);
    let key = hasher.finish();

    let g = &amp;mut cache.lock().await;
    let data = match g.get(&amp;key) {
        Some(v) =&gt; {
            info!(&quot;Match cache {}&quot;, key);
            v.to_owned()
        }
        None =&gt; {
            info!(&quot;Retrieve url&quot;);
            let resp = reqwest::get(url).await?;
            let data = resp.bytes().await?;
            g.put(key, data.clone());
            data
        }
    };

    Ok(data)
}
</code></pre></pre>
<h3 id="ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°"><a class="header" href="#ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°">ä¸€ä¸ªç”¨äºè°ƒè¯•çš„è¾…åŠ©å‡½æ•°</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">// è°ƒè¯•è¾…åŠ©å‡½æ•°
fn print_test_url(url: &amp;str) {
    use std::borrow::Borrow;
    let spec1 = Spec::new_resize(500, 800, resize::SampleFilter::CatmullRom);
    let spec2 = Spec::new_watermark(20, 20);
    let spec3 = Spec::new_filter(filter::Filter::Marine);
    let image_spec = ImageSpec::new(vec![spec1, spec2, spec3]);
    let s: String = image_spec.borrow().into();
    let test_image = percent_encode(url.as_bytes(), NON_ALPHANUMERIC).to_string();
    println!(&quot;test url: http://localhost:3000/image/{}/{}&quot;, s, test_image);
}
</code></pre></pre>
<h2 id="è¿è¡Œä¸æ—¥å¿—"><a class="header" href="#è¿è¡Œä¸æ—¥å¿—">è¿è¡Œä¸æ—¥å¿—</a></h2>
<blockquote>
<p>å°†RUST_LOGçº§åˆ«è®¾ç½®ä¸ºinfo</p>
</blockquote>
<pre><code class="language-shell">cargo build --release
RUST_LOG=info target/release/thumbor
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sqlæŸ¥è¯¢å·¥å…·"><a class="header" href="#sqlæŸ¥è¯¢å·¥å…·">SQLæŸ¥è¯¢å·¥å…·</a></h1>
<!--ts-->
<ul>
<li><a href="queryer.html#sql%E6%9F%A5%E8%AF%A2%E5%B7%A5%E5%85%B7">SQLæŸ¥è¯¢å·¥å…·</a>
<ul>
<li><a href="queryer.html#workspace-%E8%BF%99%E9%87%8C%E4%BD%BF%E7%94%A8%E8%99%9A%E6%8B%9F%E6%B8%85%E5%8D%95virtual-manifest%E6%96%B9%E5%BC%8F">workspace: è¿™é‡Œä½¿ç”¨è™šæ‹Ÿæ¸…å•(virtual manifest)æ–¹å¼</a>
<ul>
<li><a href="queryer.html#workspace%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F">workspaceä½¿ç”¨æ–¹å¼</a></li>
</ul>
</li>
<li><a href="queryer.html#queryer-package">queryer package</a>
<ul>
<li><a href="queryer.html#cargotoml">cargo.toml</a></li>
<li><a href="queryer.html#%E4%B8%A4%E4%B8%AA%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B">ä¸¤ä¸ªä½¿ç”¨ç¤ºä¾‹</a>
<ul>
<li><a href="queryer.html#dialectrssql%E8%A7%A3%E6%9E%90">dialect.rs:SQLè§£æ</a></li>
<li><a href="queryer.html#covidrs-ast%E8%BD%AC%E6%8D%A2">covid.rs: ASTè½¬æ¢</a></li>
</ul>
</li>
<li><a href="queryer.html#srcconvertrs">src/convert.rs</a>
<ul>
<li><a href="queryer.html#%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9A%E4%B9%89sql%E4%B8%8E%E5%AF%B9%E5%BA%94%E9%83%A8%E5%88%86%E7%BB%93%E6%9E%84%E4%BD%93-%E6%B3%A8%E6%84%8F%E9%99%90%E4%BA%8E%E5%AD%A4%E5%84%BF%E5%8E%9F%E5%88%99%E7%9A%84%E5%86%8D%E5%8C%85%E8%A3%85">ç»“æ„ä½“å®šä¹‰:sqlä¸å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“, æ³¨æ„é™äºå­¤å„¿åŸåˆ™çš„å†åŒ…è£…</a></li>
<li><a href="queryer.html#sql%E7%9A%84%E8%BD%AC%E6%8D%A2">sqlçš„è½¬æ¢</a></li>
<li><a href="queryer.html#%E5%AF%B9%E5%BA%94%E9%83%A8%E5%88%86%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E8%BD%AC%E6%8D%A2">å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“çš„è½¬æ¢</a></li>
<li><a href="queryer.html#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95">å•å…ƒæµ‹è¯•</a></li>
</ul>
</li>
<li><a href="queryer.html#srcdialectrs">src/dialect.rs</a>
<ul>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89%E6%96%B9%E8%A8%80%E7%BB%93%E6%9E%84%E4%BD%93">å®šä¹‰æ–¹è¨€ç»“æ„ä½“</a></li>
<li><a href="queryer.html#%E7%BB%99%E6%96%B9%E8%A8%80%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9E%E7%8E%B0trait">ç»™æ–¹è¨€ç»“æ„ä½“å®ç°trait</a></li>
<li><a href="queryer.html#%E6%B7%BB%E5%8A%A0%E6%B5%8B%E8%AF%95%E7%94%A8%E5%87%BD%E6%95%B0">æ·»åŠ æµ‹è¯•ç”¨å‡½æ•°</a></li>
<li><a href="queryer.html#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95-1">å•å…ƒæµ‹è¯•</a></li>
</ul>
</li>
<li><a href="queryer.html#srcloaderrs">src/loader.rs</a>
<ul>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89loader%E4%B8%8Ecsvloader">å®šä¹‰Loaderä¸CsvLoader</a></li>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89trait%E5%B9%B6%E7%BB%99csvloader%E5%AE%9E%E7%8E%B0">å®šä¹‰traitå¹¶ç»™CsvLoaderå®ç°</a></li>
<li><a href="queryer.html#todo-%E7%BB%99csvloader%E6%B7%BB%E5%8A%A0%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B">todo: ç»™CsvLoaderæ·»åŠ å†…å®¹æ£€æµ‹</a></li>
</ul>
</li>
<li><a href="queryer.html#srcfetcherrs">src/fetcher.rs</a>
<ul>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89urlfetcher%E4%B8%8Efilefetcher">å®šä¹‰UrlFetcherä¸FileFetcher</a></li>
<li><a href="queryer.html#%E5%AE%9A%E4%B9%89trait%E5%B9%B6%E7%BB%99fetcher%E4%B8%8Efilefetcher%E5%AE%9E%E7%8E%B0">å®šä¹‰traitå¹¶ç»™Fetcherä¸FileFetcherå®ç°</a></li>
<li><a href="queryer.html#%E6%9C%80%E5%90%8E%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E7%9A%84%E6%96%B9%E6%B3%95">æœ€åå®šä¹‰ä¸€ä¸ªè·å–æ•°æ®çš„æ–¹æ³•</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="queryer.html#queryer-js-package-%E4%BD%BF%E7%94%A8neon">queryer-js package: ä½¿ç”¨neon</a>
<ul>
<li><a href="queryer.html#cargotoml-1">Cargo.toml</a></li>
<li><a href="queryer.html#build-in-packagejson">build in package.json</a></li>
<li><a href="queryer.html#srclibrs">src/lib.rs</a></li>
</ul>
</li>
<li><a href="queryer.html#queryer-py-package-%E4%BD%BF%E7%94%A8pyo3">queryer-py package: ä½¿ç”¨pyo3</a>
<ul>
<li><a href="queryer.html#cargotoml-2">Cargo.toml</a></li>
<li><a href="queryer.html#buildrs">build.rs</a></li>
<li><a href="queryer.html#srclibrs-1">src/lib.rs</a></li>
</ul>
</li>
<li><a href="queryer.html#data-viewer-package-%E4%BD%BF%E7%94%A8tauri">data-viewer package: ä½¿ç”¨tauri</a>
<ul>
<li><a href="queryer.html#cargotoml-3">Cargo.toml</a></li>
<li><a href="queryer.html#buildrs-1">build.rs</a></li>
<li><a href="queryer.html#mainrs">main.rs</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:44:00 UTC 2022 -->
<!--te-->
<h2 id="workspace-è¿™é‡Œä½¿ç”¨è™šæ‹Ÿæ¸…å•virtual-manifestæ–¹å¼"><a class="header" href="#workspace-è¿™é‡Œä½¿ç”¨è™šæ‹Ÿæ¸…å•virtual-manifestæ–¹å¼">workspace: è¿™é‡Œä½¿ç”¨è™šæ‹Ÿæ¸…å•(virtual manifest)æ–¹å¼</a></h2>
<blockquote>
<p><a href="https://course.rs/cargo/reference/workspaces.html">å·¥ä½œç©ºé—´ Workspace - Rustè¯­è¨€åœ£ç»(Rust Course)</a></p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">[workspace]

members = [
  &quot;queryer&quot;,
  &quot;queryer-js&quot;,
  &quot;queryer-py&quot;,
  &quot;data-viewer/src-tauri&quot;
]
</code></pre></pre>
<div id="admonition-è™šæ‹Ÿæ¸…å•" class="admonition info">
<div class="admonition-title">
<p>è™šæ‹Ÿæ¸…å•</p>
<p><a class="admonition-anchor-link" href="queryer.html#admonition-è™šæ‹Ÿæ¸…å•"></a></p>
</div>
<div>
<p>è‹¥ä¸€ä¸ª Cargo.toml æœ‰ [workspace] ä½†æ˜¯æ²¡æœ‰ [package] éƒ¨åˆ†ï¼Œåˆ™å®ƒæ˜¯è™šæ‹Ÿæ¸…å•ç±»å‹çš„å·¥ä½œç©ºé—´ã€‚</p>
<p>å¯¹äºæ²¡æœ‰ä¸» package çš„åœºæ™¯æˆ–ä½ å¸Œæœ›å°†æ‰€æœ‰çš„ package ç»„ç»‡åœ¨å•ç‹¬çš„ç›®å½•ä¸­æ—¶ï¼Œè¿™ç§æ–¹å¼å°±éå¸¸é€‚åˆã€‚</p>
</div>
</div>
<div id="admonition-workspaceå…³é”®ç‚¹" class="admonition tip">
<div class="admonition-title">
<p>workspaceå…³é”®ç‚¹</p>
<p><a class="admonition-anchor-link" href="queryer.html#admonition-workspaceå…³é”®ç‚¹"></a></p>
</div>
<div>
<ul>
<li>æ‰€æœ‰çš„ package å…±äº«åŒä¸€ä¸ª Cargo.lock æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä½äºå·¥ä½œç©ºé—´çš„æ ¹ç›®å½•ä¸­</li>
<li>æ‰€æœ‰çš„ package å…±äº«åŒä¸€ä¸ªè¾“å‡ºç›®å½•ï¼Œè¯¥ç›®å½•é»˜è®¤çš„åç§°æ˜¯ target ï¼Œä½äºå·¥ä½œç©ºé—´æ ¹ç›®å½•ä¸‹</li>
<li>åªæœ‰å·¥ä½œç©ºé—´æ ¹ç›®å½•çš„ Cargo.toml æ‰èƒ½åŒ…å« [patch], [replace] å’Œ [profile.*]ï¼Œè€Œæˆå‘˜çš„ Cargo.toml ä¸­çš„ç›¸åº”éƒ¨åˆ†å°†è¢«è‡ªåŠ¨å¿½ç•¥</li>
</ul>
</div>
</div>
<h3 id="workspaceä½¿ç”¨æ–¹å¼"><a class="header" href="#workspaceä½¿ç”¨æ–¹å¼">workspaceä½¿ç”¨æ–¹å¼</a></h3>
<pre><code class="language-shell">cargo run -p &lt;member package&gt;
cargo build -p queryer
</code></pre>
<div id="admonition-ä½¿ç”¨è¯´æ˜" class="admonition info">
<div class="admonition-title">
<p>ä½¿ç”¨è¯´æ˜</p>
<p><a class="admonition-anchor-link" href="queryer.html#admonition-ä½¿ç”¨è¯´æ˜"></a></p>
</div>
<div>
<ol>
<li>
<p>åœ¨å·¥ä½œç©ºé—´ä¸­ï¼Œpackage ç›¸å…³çš„ Cargo å‘½ä»¤(ä¾‹å¦‚ cargo build )å¯ä»¥ä½¿ç”¨ -p ã€ â€“package æˆ– â€“workspace å‘½ä»¤è¡Œå‚æ•°æ¥æŒ‡å®šæƒ³è¦æ“ä½œçš„ packageã€‚</p>
</li>
<li>
<p>è‹¥æ²¡æœ‰æŒ‡å®šä»»ä½•å‚æ•°ï¼Œåˆ™ Cargo å°†ä½¿ç”¨å½“å‰å·¥ä½œç›®å½•çš„ä¸­çš„ package ã€‚è‹¥å·¥ä½œç›®å½•æ˜¯è™šæ‹Ÿæ¸…å•ç±»å‹çš„å·¥ä½œç©ºé—´ï¼Œåˆ™è¯¥å‘½ä»¤å°†ä½œç”¨åœ¨æ‰€æœ‰æˆå‘˜ä¸Š(å°±å¥½åƒæ˜¯ä½¿ç”¨äº† â€“workspace å‘½ä»¤è¡Œå‚æ•°)ã€‚è€Œ default-members å¯ä»¥åœ¨å‘½ä»¤è¡Œå‚æ•°æ²¡æœ‰è¢«æä¾›æ—¶ï¼Œæ‰‹åŠ¨æŒ‡å®šæ“ä½œçš„æˆå‘˜</p>
</li>
</ol>
</div>
</div>
<h2 id="queryer-package"><a class="header" href="#queryer-package">queryer package</a></h2>
<h3 id="cargotoml-2"><a class="header" href="#cargotoml-2">cargo.toml</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{{#include ../geektime_rust_codes/06_queryer/queryer/cargo.toml}}
</code></pre></pre>
<h3 id="ä¸¤ä¸ªä½¿ç”¨ç¤ºä¾‹"><a class="header" href="#ä¸¤ä¸ªä½¿ç”¨ç¤ºä¾‹">ä¸¤ä¸ªä½¿ç”¨ç¤ºä¾‹</a></h3>
<h4 id="dialectrssqlè§£æ"><a class="header" href="#dialectrssqlè§£æ">dialect.rs:SQLè§£æ</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">use sqlparser::{dialect::GenericDialect, parser::Parser};

fn main() {
    tracing_subscriber::fmt::init();

    let sql = &quot;SELECT a a1, b, 123, myfunc(b), * \
    FROM data_source \
    WHERE a &gt; b AND b &lt; 100 AND c BETWEEN 10 AND 20 \
    ORDER BY a DESC, b \
    LIMIT 50 OFFSET 10&quot;;

    let ast = Parser::parse_sql(&amp;GenericDialect::default(), sql);
    println!(&quot;{:#?}&quot;, ast);
}
</code></pre></pre>
<h4 id="covidrs-astè½¬æ¢"><a class="header" href="#covidrs-astè½¬æ¢">covid.rs: ASTè½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">use anyhow::Result;
use queryer::query;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();

    let url = &quot;https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/latest/owid-covid-latest.csv&quot;;

    // ä½¿ç”¨ sql ä» URL é‡Œè·å–æ•°æ®
    let sql = format!(
        &quot;SELECT location name, total_cases, new_cases, total_deaths, new_deaths \
        FROM {} where new_deaths &gt;= 500 ORDER BY new_cases DESC&quot;,
        url
    );
    let df1 = query(sql).await?;
    println!(&quot;{:?}&quot;, df1);

    Ok(())
}
</code></pre></pre>
<h3 id="srcconvertrs"><a class="header" href="#srcconvertrs">src/convert.rs</a></h3>
<h4 id="ç»“æ„ä½“å®šä¹‰sqlä¸å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“-æ³¨æ„é™äºå­¤å„¿åŸåˆ™çš„å†åŒ…è£…"><a class="header" href="#ç»“æ„ä½“å®šä¹‰sqlä¸å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“-æ³¨æ„é™äºå­¤å„¿åŸåˆ™çš„å†åŒ…è£…">ç»“æ„ä½“å®šä¹‰:sqlä¸å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“, æ³¨æ„é™äºå­¤å„¿åŸåˆ™çš„å†åŒ…è£…</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// è§£æå‡ºæ¥çš„ SQL
pub struct Sql&lt;'a&gt; {
    pub(crate) selection: Vec&lt;Expr&gt;,
    pub(crate) condition: Option&lt;Expr&gt;,
    pub(crate) source: &amp;'a str,
    pub(crate) order_by: Vec&lt;(String, bool)&gt;,
    pub(crate) offset: Option&lt;i64&gt;,
    pub(crate) limit: Option&lt;usize&gt;,
}

// å› ä¸º Rust trait çš„å­¤å„¿è§„åˆ™ï¼Œæˆ‘ä»¬å¦‚æœè¦æƒ³å¯¹å·²æœ‰çš„ç±»å‹å®ç°å·²æœ‰çš„ traitï¼Œ
// éœ€è¦ç®€å•åŒ…è£…ä¸€ä¸‹

pub struct Expression(pub(crate) Box&lt;SqlExpr&gt;);
pub struct Operation(pub(crate) SqlBinaryOperator);
pub struct Projection&lt;'a&gt;(pub(crate) &amp;'a SelectItem);
pub struct Source&lt;'a&gt;(pub(crate) &amp;'a [TableWithJoins]);
pub struct Order&lt;'a&gt;(pub(crate) &amp;'a OrderByExpr);
pub struct Offset&lt;'a&gt;(pub(crate) &amp;'a SqlOffset);
pub struct Limit&lt;'a&gt;(pub(crate) &amp;'a SqlExpr);
pub struct Value(pub(crate) SqlValue);
</code></pre></pre>
<h4 id="sqlçš„è½¬æ¢"><a class="header" href="#sqlçš„è½¬æ¢">sqlçš„è½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// æŠŠ SqlParser è§£æå‡ºæ¥çš„ Statement è½¬æ¢æˆæˆ‘ä»¬éœ€è¦çš„ç»“æ„
impl&lt;'a&gt; TryFrom&lt;&amp;'a Statement&gt; for Sql&lt;'a&gt; {
    type Error = anyhow::Error;

    fn try_from(sql: &amp;'a Statement) -&gt; Result&lt;Self, Self::Error&gt; {
        match sql {
            // ç›®å‰æˆ‘ä»¬åªå…³å¿ƒ query (select ... from ... where ...)
            Statement::Query(q) =&gt; {
                let offset = q.offset.as_ref();
                let limit = q.limit.as_ref();
                let orders = &amp;q.order_by;
                let Select {
                    from: table_with_joins,
                    selection: where_clause,
                    projection,

                    group_by: _,
                    ..
                } = match &amp;q.body {
                    SetExpr::Select(statement) =&gt; statement.as_ref(),
                    _ =&gt; return Err(anyhow!(&quot;We only support Select Query at the moment&quot;)),
                };

                let source = Source(table_with_joins).try_into()?;

                let condition = match where_clause {
                    Some(expr) =&gt; Some(Expression(Box::new(expr.to_owned())).try_into()?),
                    None =&gt; None,
                };

                let mut selection = Vec::with_capacity(8);
                for p in projection {
                    let expr = Projection(p).try_into()?;
                    selection.push(expr);
                }

                let mut order_by = Vec::new();
                for expr in orders {
                    order_by.push(Order(expr).try_into()?);
                }

                let offset = offset.map(|v| Offset(v).into());
                let limit = limit.map(|v| Limit(v).into());

                Ok(Sql {
                    selection,
                    condition,
                    source,
                    order_by,
                    offset,
                    limit,
                })
            }
            _ =&gt; Err(anyhow!(&quot;We only support Query at the moment&quot;)),
        }
    }
}
</code></pre></pre>
<h4 id="å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“çš„è½¬æ¢"><a class="header" href="#å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“çš„è½¬æ¢">å¯¹åº”éƒ¨åˆ†ç»“æ„ä½“çš„è½¬æ¢</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// æŠŠ SqlParser çš„ Expr è½¬æ¢æˆ DataFrame çš„ Expr
impl TryFrom&lt;Expression&gt; for Expr {
    type Error = anyhow::Error;

    fn try_from(expr: Expression) -&gt; Result&lt;Self, Self::Error&gt; {
        match *expr.0 {
            SqlExpr::BinaryOp { left, op, right } =&gt; Ok(Expr::BinaryExpr {
                left: Box::new(Expression(left).try_into()?),
                op: Operation(op).try_into()?,
                right: Box::new(Expression(right).try_into()?),
            }),
            SqlExpr::Wildcard =&gt; Ok(Self::Wildcard),
            SqlExpr::IsNull(expr) =&gt; Ok(Self::IsNull(Box::new(Expression(expr).try_into()?))),
            SqlExpr::IsNotNull(expr) =&gt; Ok(Self::IsNotNull(Box::new(Expression(expr).try_into()?))),
            SqlExpr::Identifier(id) =&gt; Ok(Self::Column(Arc::new(id.value))),
            SqlExpr::Value(v) =&gt; Ok(Self::Literal(Value(v).try_into()?)),
            v =&gt; Err(anyhow!(&quot;expr {:#?} is not supported&quot;, v)),
        }
    }
}

/// æŠŠ SqlParser çš„ BinaryOperator è½¬æ¢æˆ DataFrame çš„ Operator
impl TryFrom&lt;Operation&gt; for Operator {
    type Error = anyhow::Error;

    fn try_from(op: Operation) -&gt; Result&lt;Self, Self::Error&gt; {
        match op.0 {
            SqlBinaryOperator::Plus =&gt; Ok(Self::Plus),
            SqlBinaryOperator::Minus =&gt; Ok(Self::Minus),
            SqlBinaryOperator::Multiply =&gt; Ok(Self::Multiply),
            SqlBinaryOperator::Divide =&gt; Ok(Self::Divide),
            SqlBinaryOperator::Modulo =&gt; Ok(Self::Modulus),
            SqlBinaryOperator::Gt =&gt; Ok(Self::Gt),
            SqlBinaryOperator::Lt =&gt; Ok(Self::Lt),
            SqlBinaryOperator::GtEq =&gt; Ok(Self::GtEq),
            SqlBinaryOperator::LtEq =&gt; Ok(Self::LtEq),
            SqlBinaryOperator::Eq =&gt; Ok(Self::Eq),
            SqlBinaryOperator::NotEq =&gt; Ok(Self::NotEq),
            SqlBinaryOperator::And =&gt; Ok(Self::And),
            SqlBinaryOperator::Or =&gt; Ok(Self::Or),
            v =&gt; Err(anyhow!(&quot;Operator {} is not supported&quot;, v)),
        }
    }
}

/// æŠŠ SqlParser çš„ SelectItem è½¬æ¢æˆ DataFrame çš„ Expr
impl&lt;'a&gt; TryFrom&lt;Projection&lt;'a&gt;&gt; for Expr {
    type Error = anyhow::Error;

    fn try_from(p: Projection&lt;'a&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        match p.0 {
            SelectItem::UnnamedExpr(SqlExpr::Identifier(id)) =&gt; Ok(col(&amp;id.to_string())),
            SelectItem::ExprWithAlias {
                expr: SqlExpr::Identifier(id),
                alias,
            } =&gt; Ok(Expr::Alias(
                Box::new(Expr::Column(Arc::new(id.to_string()))),
                Arc::new(alias.to_string()),
            )),
            SelectItem::QualifiedWildcard(v) =&gt; Ok(col(&amp;v.to_string())),
            SelectItem::Wildcard =&gt; Ok(col(&quot;*&quot;)),
            item =&gt; Err(anyhow!(&quot;projection {} not supported&quot;, item)),
        }
    }
}

impl&lt;'a&gt; TryFrom&lt;Source&lt;'a&gt;&gt; for &amp;'a str {
    type Error = anyhow::Error;

    fn try_from(source: Source&lt;'a&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        if source.0.len() != 1 {
            return Err(anyhow!(&quot;We only support single data source at the moment&quot;));
        }

        let table = &amp;source.0[0];
        if !table.joins.is_empty() {
            return Err(anyhow!(&quot;We do not support joint data source at the moment&quot;));
        }

        match &amp;table.relation {
            TableFactor::Table { name, .. } =&gt; Ok(&amp;name.0.first().unwrap().value),
            _ =&gt; Err(anyhow!(&quot;We only support table&quot;)),
        }
    }
}

/// æŠŠ SqlParser çš„ order by expr è½¬æ¢æˆ (åˆ—å, æ’åºæ–¹æ³•)
impl&lt;'a&gt; TryFrom&lt;Order&lt;'a&gt;&gt; for (String, bool) {
    type Error = anyhow::Error;

    fn try_from(o: Order) -&gt; Result&lt;Self, Self::Error&gt; {
        let name = match &amp;o.0.expr {
            SqlExpr::Identifier(id) =&gt; id.to_string(),
            expr =&gt; {
                return Err(anyhow!(
                    &quot;We only support identifier for order by, got {}&quot;,
                    expr
                ))
            }
        };

        Ok((name, !o.0.asc.unwrap_or(true)))
    }
}

/// æŠŠ SqlParser çš„ offset expr è½¬æ¢æˆ i64
impl&lt;'a&gt; From&lt;Offset&lt;'a&gt;&gt; for i64 {
    fn from(offset: Offset) -&gt; Self {
        match offset.0 {
            SqlOffset {
                value: SqlExpr::Value(SqlValue::Number(v, _b)),
                ..
            } =&gt; v.parse().unwrap_or(0),
            _ =&gt; 0,
        }
    }
}

/// æŠŠ SqlParser çš„ Limit expr è½¬æ¢æˆ usize
impl&lt;'a&gt; From&lt;Limit&lt;'a&gt;&gt; for usize {
    fn from(l: Limit&lt;'a&gt;) -&gt; Self {
        match l.0 {
            SqlExpr::Value(SqlValue::Number(v, _b)) =&gt; v.parse().unwrap_or(usize::MAX),
            _ =&gt; usize::MAX,
        }
    }
}

/// æŠŠ SqlParser çš„ value è½¬æ¢æˆ DataFrame æ”¯æŒçš„ LiteralValue
impl TryFrom&lt;Value&gt; for LiteralValue {
    type Error = anyhow::Error;
    fn try_from(v: Value) -&gt; Result&lt;Self, Self::Error&gt; {
        match v.0 {
            SqlValue::Number(v, _) =&gt; Ok(LiteralValue::Float64(v.parse().unwrap())),
            SqlValue::Boolean(v) =&gt; Ok(LiteralValue::Boolean(v)),
            SqlValue::Null =&gt; Ok(LiteralValue::Null),
            v =&gt; Err(anyhow!(&quot;Value {} is not supported&quot;, v)),
        }
    }
}
</code></pre></pre>
<h4 id="å•å…ƒæµ‹è¯•-2"><a class="header" href="#å•å…ƒæµ‹è¯•-2">å•å…ƒæµ‹è¯•</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[cfg(test)]
mod tests {
    use super::*;
    use crate::TyrDialect;
    use sqlparser::parser::Parser;

    #[test]
    fn parse_sql_works() {
        let url = &quot;http://abc.xyz/abc?a=1&amp;b=2&quot;;
        let sql = format!(
            &quot;select a, b, c from {} where a=1 order by c desc limit 5 offset 10&quot;,
            url
        );
        let statement = &amp;Parser::parse_sql(&amp;TyrDialect::default(), sql.as_ref()).unwrap()[0];
        let sql: Sql = statement.try_into().unwrap();
        assert_eq!(sql.source, url);
        assert_eq!(sql.limit, Some(5));
        assert_eq!(sql.offset, Some(10));
        assert_eq!(sql.order_by, vec![(&quot;c&quot;.into(), true)]);
        assert_eq!(sql.selection, vec![col(&quot;a&quot;), col(&quot;b&quot;), col(&quot;c&quot;)]);
    }
}
</code></pre></pre>
<h3 id="srcdialectrs"><a class="header" href="#srcdialectrs">src/dialect.rs</a></h3>
<h4 id="å®šä¹‰æ–¹è¨€ç»“æ„ä½“"><a class="header" href="#å®šä¹‰æ–¹è¨€ç»“æ„ä½“">å®šä¹‰æ–¹è¨€ç»“æ„ä½“</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[derive(Debug, Default)]
pub struct TyrDialect;
</code></pre></pre>
<h4 id="ç»™æ–¹è¨€ç»“æ„ä½“å®ç°trait"><a class="header" href="#ç»™æ–¹è¨€ç»“æ„ä½“å®ç°trait">ç»™æ–¹è¨€ç»“æ„ä½“å®ç°trait</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">// åˆ›å»ºè‡ªå·±çš„ sql æ–¹è¨€ã€‚TyrDialect æ”¯æŒ identifier å¯ä»¥æ˜¯ç®€å•çš„ url
impl Dialect for TyrDialect {
    fn is_identifier_start(&amp;self, ch: char) -&gt; bool {
        ('a'..='z').contains(&amp;ch) || ('A'..='Z').contains(&amp;ch) || ch == '_'
    }

    // identifier å¯ä»¥æœ‰ ':', '/', '?', '&amp;', '='
    fn is_identifier_part(&amp;self, ch: char) -&gt; bool {
        ('a'..='z').contains(&amp;ch)
            || ('A'..='Z').contains(&amp;ch)
            || ('0'..='9').contains(&amp;ch)
            || [':', '/', '?', '&amp;', '=', '-', '_', '.'].contains(&amp;ch)
    }
}
</code></pre></pre>
<h4 id="æ·»åŠ æµ‹è¯•ç”¨å‡½æ•°"><a class="header" href="#æ·»åŠ æµ‹è¯•ç”¨å‡½æ•°">æ·»åŠ æµ‹è¯•ç”¨å‡½æ•°</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// æµ‹è¯•è¾…åŠ©å‡½æ•°
pub fn example_sql() -&gt; String {
    let url = &quot;https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/latest/owid-covid-latest.csv&quot;;

    let sql = format!(
        &quot;SELECT location name, total_cases, new_cases, total_deaths, new_deaths \
        FROM {} where new_deaths &gt;= 500 ORDER BY new_cases DESC LIMIT 6 OFFSET 5&quot;,
        url
    );

    sql
}
</code></pre></pre>
<h4 id="å•å…ƒæµ‹è¯•-3"><a class="header" href="#å•å…ƒæµ‹è¯•-3">å•å…ƒæµ‹è¯•</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[cfg(test)]
mod tests {
    use super::*;
    use sqlparser::parser::Parser;

    #[test]
    fn it_works() {
        assert!(Parser::parse_sql(&amp;TyrDialect::default(), &amp;example_sql()).is_ok());
    }
}
</code></pre></pre>
<h3 id="srcloaderrs"><a class="header" href="#srcloaderrs">src/loader.rs</a></h3>
<h4 id="å®šä¹‰loaderä¸csvloader"><a class="header" href="#å®šä¹‰loaderä¸csvloader">å®šä¹‰Loaderä¸CsvLoader</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[derive(Debug)]
#[non_exhaustive]
pub enum Loader {
    Csv(CsvLoader),
}

#[derive(Default, Debug)]
pub struct CsvLoader(pub(crate) String);
</code></pre></pre>
<h4 id="å®šä¹‰traitå¹¶ç»™csvloaderå®ç°"><a class="header" href="#å®šä¹‰traitå¹¶ç»™csvloaderå®ç°">å®šä¹‰traitå¹¶ç»™CsvLoaderå®ç°</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">
    let sql = format!(
        &quot;SELECT location name, total_cases, new_cases, total_deaths, new_deaths \
        FROM {} where new_deaths &gt;= 500 ORDER BY new_cases DESC LIMIT 6 OFFSET 5&quot;,
        url
    );

    sql
}

#[cfg(test)]
mod tests {
    use super::*;
    use sqlparser::parser::Parser;

</code></pre></pre>
<h4 id="todo-ç»™csvloaderæ·»åŠ å†…å®¹æ£€æµ‹"><a class="header" href="#todo-ç»™csvloaderæ·»åŠ å†…å®¹æ£€æµ‹">todo: ç»™CsvLoaderæ·»åŠ å†…å®¹æ£€æµ‹</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">    fn it_works() {
        assert!(Parser::parse_sql(&amp;TyrDialect::default(), &amp;example_sql()).is_ok());
    }
}
</code></pre></pre>
<h3 id="srcfetcherrs"><a class="header" href="#srcfetcherrs">src/fetcher.rs</a></h3>
<h4 id="å®šä¹‰urlfetcherä¸filefetcher"><a class="header" href="#å®šä¹‰urlfetcherä¸filefetcher">å®šä¹‰UrlFetcherä¸FileFetcher</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">struct UrlFetcher&lt;'a&gt;(pub(crate) &amp;'a str);

struct FileFetcher&lt;'a&gt;(pub(crate) &amp;'a str);
</code></pre></pre>
<h4 id="å®šä¹‰traitå¹¶ç»™fetcherä¸filefetcherå®ç°"><a class="header" href="#å®šä¹‰traitå¹¶ç»™fetcherä¸filefetcherå®ç°">å®šä¹‰traitå¹¶ç»™Fetcherä¸FileFetcherå®ç°</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">// Rust çš„ async trait è¿˜æ²¡æœ‰ç¨³å®šï¼Œå¯ä»¥ç”¨ async_trait å®
#[async_trait]
pub trait Fetch {
    type Error;
    async fn fetch(&amp;self) -&gt; Result&lt;String, Self::Error&gt;;
}

#[async_trait]
impl&lt;'a&gt; Fetch for UrlFetcher&lt;'a&gt; {
    type Error = anyhow::Error;

    async fn fetch(&amp;self) -&gt; Result&lt;String, Self::Error&gt; {
        Ok(reqwest::get(self.0).await?.text().await?)
    }
}

#[async_trait]
impl&lt;'a&gt; Fetch for FileFetcher&lt;'a&gt; {
    type Error = anyhow::Error;

    async fn fetch(&amp;self) -&gt; Result&lt;String, Self::Error&gt; {
        Ok(fs::read_to_string(&amp;self.0[7..]).await?)
    }
}
</code></pre></pre>
<h4 id="æœ€åå®šä¹‰ä¸€ä¸ªè·å–æ•°æ®çš„æ–¹æ³•"><a class="header" href="#æœ€åå®šä¹‰ä¸€ä¸ªè·å–æ•°æ®çš„æ–¹æ³•">æœ€åå®šä¹‰ä¸€ä¸ªè·å–æ•°æ®çš„æ–¹æ³•</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// ä»æ–‡ä»¶æºæˆ–è€… http æºä¸­è·å–æ•°æ®ï¼Œè¿”å›å­—ç¬¦ä¸²
pub async fn retrieve_data(source: impl AsRef&lt;str&gt;) -&gt; Result&lt;String&gt; {
    let name = source.as_ref();
    match &amp;name[..4] {
        // åŒ…æ‹¬ http / https
        &quot;http&quot; =&gt; UrlFetcher(name).fetch().await,
        // å¤„ç† file://&lt;filename&gt;
        &quot;file&quot; =&gt; FileFetcher(name).fetch().await,
        _ =&gt; Err(anyhow!(&quot;We only support http/https/file at the moment&quot;)),
    }
}
</code></pre></pre>
<h2 id="queryer-js-package-ä½¿ç”¨neon"><a class="header" href="#queryer-js-package-ä½¿ç”¨neon">queryer-js package: ä½¿ç”¨neon</a></h2>
<h3 id="cargotoml-3"><a class="header" href="#cargotoml-3">Cargo.toml</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">[package]
name = &quot;queryer-js&quot;
version = &quot;0.1.0&quot;
license = &quot;ISC&quot;
edition = &quot;2021&quot;
exclude = [&quot;index.node&quot;]

[lib]
crate-type = [&quot;cdylib&quot;]

[dependencies]
anyhow = &quot;1&quot;
queryer = { path = &quot;../queryer&quot; }
tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] }

[dependencies.neon]
version = &quot;0.9&quot;
default-features = false
features = [&quot;napi-6&quot;]
</code></pre></pre>
<h3 id="build-in-packagejson"><a class="header" href="#build-in-packagejson">build in package.json</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">{
  &quot;name&quot;: &quot;queryer-js&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;index.node&quot;,
  &quot;scripts&quot;: {
    &quot;build&quot;: &quot;cargo-cp-artifact -nc index.node -- cargo build --message-format=json-render-diagnostics&quot;,
    &quot;build-debug&quot;: &quot;npm run build --&quot;,
    &quot;build-release&quot;: &quot;npm run build -- --release&quot;,
    &quot;install&quot;: &quot;npm run build-release&quot;,
    &quot;test&quot;: &quot;cargo test&quot;
  },
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;devDependencies&quot;: {
    &quot;cargo-cp-artifact&quot;: &quot;^0.1&quot;
  }
}
</code></pre></pre>
<h3 id="srclibrs"><a class="header" href="#srclibrs">src/lib.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use neon::prelude::*;

pub fn example_sql(mut cx: FunctionContext) -&gt; JsResult&lt;JsString&gt; {
    Ok(cx.string(queryer::example_sql()))
}

fn query(mut cx: FunctionContext) -&gt; JsResult&lt;JsString&gt; {
    let sql = cx.argument::&lt;JsString&gt;(0)?.value(&amp;mut cx);
    let output = match cx.argument::&lt;JsString&gt;(1) {
        Ok(v) =&gt; v.value(&amp;mut cx),
        Err(_) =&gt; &quot;csv&quot;.to_string(),
    };
    let rt = tokio::runtime::Runtime::new().unwrap();
    let data = rt.block_on(async { queryer::query(sql).await.unwrap() });

    match output.as_str() {
        &quot;csv&quot; =&gt; Ok(cx.string(data.to_csv().unwrap())),
        v =&gt; cx.throw_type_error(format!(&quot;Output type {} not supported&quot;, v)),
    }
}

#[neon::main]
fn main(mut cx: ModuleContext) -&gt; NeonResult&lt;()&gt; {
    cx.export_function(&quot;example_sql&quot;, example_sql)?;
    cx.export_function(&quot;query&quot;, query)?;
    Ok(())
}
</code></pre></pre>
<h2 id="queryer-py-package-ä½¿ç”¨pyo3"><a class="header" href="#queryer-py-package-ä½¿ç”¨pyo3">queryer-py package: ä½¿ç”¨pyo3</a></h2>
<blockquote>
<p>pythonè°ƒç”¨æŸ¥è¯¢åŒ…</p>
</blockquote>
<h3 id="cargotoml-4"><a class="header" href="#cargotoml-4">Cargo.toml</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">[package]
name = &quot;queryer_py&quot; # Python æ¨¡å—éœ€è¦ç”¨ä¸‹åˆ’çº¿
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;


[lib]
crate-type = [&quot;cdylib&quot;] # ä½¿ç”¨ cdylib ç±»å‹

[dependencies]
queryer = { path = &quot;../queryer&quot; } # å¼•å…¥ queryer
tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] }

[dependencies.pyo3]
version = &quot;0.14&quot;
features = [&quot;extension-module&quot;]

[build-dependencies]
pyo3-build-config = &quot;0.14&quot;
</code></pre></pre>
<h3 id="buildrs-1"><a class="header" href="#buildrs-1">build.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    pyo3_build_config::add_extension_module_link_args();
}
</code></pre></pre>
<h3 id="srclibrs-1"><a class="header" href="#srclibrs-1">src/lib.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#![allow(clippy::needless_option_as_deref)]
use pyo3::{exceptions, prelude::*};

#[pyfunction]
pub fn example_sql() -&gt; PyResult&lt;String&gt; {
    Ok(queryer::example_sql())
}

#[pyfunction]
pub fn query(sql: &amp;str, output: Option&lt;&amp;str&gt;) -&gt; PyResult&lt;String&gt; {
    let rt = tokio::runtime::Runtime::new().unwrap();
    let data = rt.block_on(async { queryer::query(sql).await.unwrap() });
    match output {
        Some(&quot;csv&quot;) | None =&gt; Ok(data.to_csv().unwrap()),
        Some(v) =&gt; Err(exceptions::PyTypeError::new_err(format!(
            &quot;Output type {} not supported&quot;,
            v
        ))),
    }
}

#[pymodule]
fn queryer_py(_py: Python, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; {
    m.add_function(wrap_pyfunction!(query, m)?)?;
    m.add_function(wrap_pyfunction!(example_sql, m)?)?;
    Ok(())
}
</code></pre></pre>
<h2 id="data-viewer-package-ä½¿ç”¨tauri"><a class="header" href="#data-viewer-package-ä½¿ç”¨tauri">data-viewer package: ä½¿ç”¨tauri</a></h2>
<h3 id="cargotoml-5"><a class="header" href="#cargotoml-5">Cargo.toml</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">[package]
name = &quot;app&quot;
version = &quot;0.1.0&quot;
description = &quot;A Tauri App&quot;
authors = [&quot;you&quot;]
license = &quot;&quot;
repository = &quot;&quot;
default-run = &quot;app&quot;
edition = &quot;2021&quot;
build = &quot;src/build.rs&quot;

<span class="boring">See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html
</span>
[build-dependencies]
tauri-build = { version = &quot;1.0.0-beta.4&quot; }

[dependencies]
anyhow = &quot;1&quot;
serde_json = &quot;1&quot;
queryer = { path = &quot;../../queryer&quot; }
serde = { version = &quot;1.0&quot;, features = [&quot;derive&quot;] }
tauri = { version = &quot;1.0.0-beta.8&quot;, features = [&quot;api-all&quot;] }

[features]
default = [ &quot;custom-protocol&quot; ]
custom-protocol = [ &quot;tauri/custom-protocol&quot; ]
</code></pre></pre>
<h3 id="buildrs-2"><a class="header" href="#buildrs-2">build.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
  tauri_build::build()
}
</code></pre></pre>
<h3 id="mainrs-1"><a class="header" href="#mainrs-1">main.rs</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">#![cfg_attr(
  all(not(debug_assertions), target_os = &quot;windows&quot;),
  windows_subsystem = &quot;windows&quot;
)]

#[tauri::command]
fn example_sql() -&gt; String {
  queryer::example_sql()
}

#[tauri::command]
async fn query(sql: String) -&gt; Result&lt;String, String&gt; {
  let data = queryer::query(&amp;sql).await.map_err(|err| err.to_string())?;
  Ok(data.to_csv().map_err(|err| err.to_string())?)
}

fn main() {
  tauri::Builder::default()
    .invoke_handler(tauri::generate_handler![example_sql, query])
    .run(tauri::generate_context!())
    .expect(&quot;error while running tauri application&quot;);
}
</code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustæ ¸å¿ƒæ·±å…¥"><a class="header" href="#rustæ ¸å¿ƒæ·±å…¥">Rustæ ¸å¿ƒæ·±å…¥</a></h1>
<h2 id="èµ„æ–™æ¨è"><a class="header" href="#èµ„æ–™æ¨è">èµ„æ–™æ¨è</a></h2>
<ul>
<li><a href="https://tyrchen.github.io/rust-training/rust-training-all-in-one-cn.html#1">é™ˆå¤©åŸ¹è®­slides</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="i-ä»æ ˆå †æ‰€æœ‰æƒç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†"><a class="header" href="#i-ä»æ ˆå †æ‰€æœ‰æƒç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†">I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a></h1>
<!--ts-->
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#i-%E4%BB%8E%E6%A0%88%E5%A0%86%E6%89%80%E6%9C%89%E6%9D%83%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%BC%80%E5%A7%8B%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%86%85%E5%AD%98">å†…å­˜</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E5%9B%BE">å­—ç¬¦ä¸²å†…å­˜ä½¿ç”¨å›¾</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E6%A0%88">æ ˆ</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E6%A0%88%E5%B8%A7%E7%A4%BA%E6%84%8F%E5%9B%BE">æ ˆå¸§ç¤ºæ„å›¾</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E8%80%83%E8%99%91%E6%A0%88%E6%BA%A2%E5%87%BA">è€ƒè™‘æ ˆæº¢å‡º</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%A0%86">å †</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%BD%BF%E7%94%A8%E5%A0%86%E5%BC%95%E7%94%A8%E5%85%B1%E4%BA%AB%E6%95%B0%E6%8D%AE">ä½¿ç”¨å †å¼•ç”¨å…±äº«æ•°æ®</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E8%80%83%E8%99%91%E5%A0%86%E6%BA%A2%E5%87%BA">è€ƒè™‘å †æº¢å‡º</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E7%BC%96%E7%A8%8B%E5%9B%9B%E5%A4%A7%E7%B1%BB%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">ç¼–ç¨‹å››å¤§ç±»åŸºæœ¬æ¦‚å¿µ</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#1-%E6%95%B0%E6%8D%AE">1. æ•°æ®</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%80%BC%E5%92%8C%E7%B1%BB%E5%9E%8B">å€¼å’Œç±»å‹</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E6%8C%87%E9%92%88%E5%92%8C%E5%BC%95%E7%94%A8">æŒ‡é’ˆå’Œå¼•ç”¨</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#2-%E4%BB%A3%E7%A0%81">2. ä»£ç </a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%87%BD%E6%95%B0---%E6%96%B9%E6%B3%95---%E9%97%AD%E5%8C%85">å‡½æ•° -&gt; æ–¹æ³• -&gt; é—­åŒ…</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E9%97%AD%E5%8C%85%E7%A4%BA%E6%84%8F%E5%9B%BE">é—­åŒ…ç¤ºæ„å›¾</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E6%8E%A5%E5%8F%A3%E4%B8%8E%E8%99%9A%E8%A1%A8">æ¥å£ä¸è™šè¡¨</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#3-%E8%BF%90%E8%A1%8C%E6%96%B9%E5%BC%8F">3. è¿è¡Œæ–¹å¼</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C">å¹¶å‘ä¸å¹¶è¡Œ</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%90%8C%E6%AD%A5%E5%92%8C%E5%BC%82%E6%AD%A5">åŒæ­¥å’Œå¼‚æ­¥</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#4-%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F">4. ç¼–ç¨‹èŒƒå¼</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E6%B3%9B%E5%9E%8B%E7%BC%96%E7%A8%8B">æ³›å‹ç¼–ç¨‹</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B">å‡½æ•°å¼ç¼–ç¨‹</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%BC%96%E7%A8%8B">é¢å‘å¯¹è±¡ç¼–ç¨‹</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#rust%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%A6%82%E8%A7%88">Rustå†…å­˜ç®¡ç†æ¦‚è§ˆ</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%B8%80%E6%89%80%E6%9C%89%E6%9D%83-%E5%8D%95%E4%B8%80%E5%85%B1%E4%BA%AB">ä¸€ã€æ‰€æœ‰æƒ: å•ä¸€/å…±äº«</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%8D%95%E4%B8%80%E6%89%80%E6%9C%89%E6%9D%83%E6%8E%8C%E6%8E%A7%E7%94%9F%E6%9D%80%E5%A4%A7%E6%9D%83">å•ä¸€æ‰€æœ‰æƒï¼šæŒæ§ç”Ÿæ€å¤§æƒ</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%BB%8E%E5%A4%9A%E5%BC%95%E7%94%A8%E5%BC%80%E5%A7%8B">ä»å¤šå¼•ç”¨å¼€å§‹</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#rust%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3">Rustå¦‚ä½•è§£å†³</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E6%96%B9%E6%A1%88%E4%B8%80%E5%8D%95%E4%B8%80%E6%89%80%E6%9C%89%E6%9D%83">æ–¹æ¡ˆä¸€ã€å•ä¸€æ‰€æœ‰æƒ</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E6%96%B9%E6%A1%88%E4%BA%8Ccopy">æ–¹æ¡ˆäºŒã€Copy</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%8D%95%E4%B8%80%E6%89%80%E6%9C%89%E6%9D%83%E8%A7%84%E5%88%99%E6%95%B4%E7%90%86">å•ä¸€æ‰€æœ‰æƒè§„åˆ™æ•´ç†</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%8D%95%E4%B8%80%E6%89%80%E6%9C%89%E6%9D%83%E5%80%9F%E7%94%A8">å•ä¸€æ‰€æœ‰æƒå€Ÿç”¨</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%B8%A4%E7%A7%8D%E4%BC%A0%E5%8F%82%E6%96%B9%E5%BC%8F%E4%BC%A0%E5%80%BC%E4%BC%A0%E5%9D%80">ä¸¤ç§ä¼ å‚æ–¹å¼ï¼šä¼ å€¼/ä¼ å€</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%8F%AA%E8%AF%BB%E5%80%9F%E7%94%A8%E5%BC%95%E7%94%A8">åªè¯»å€Ÿç”¨/å¼•ç”¨</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%80%9F%E7%94%A8%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%8E%E7%BA%A6%E6%9D%9F">å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸çº¦æŸ</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%8F%AF%E5%8F%98%E5%80%9F%E7%94%A8%E5%BC%95%E7%94%A8">å¯å˜å€Ÿç”¨/å¼•ç”¨</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E7%AC%AC%E4%B8%80%E6%80%A7%E5%8E%9F%E7%90%86%E7%90%86%E8%A7%A3%E5%8D%95%E4%B8%80%E6%89%80%E6%9C%89%E6%9D%83%E8%A7%84%E5%88%99">ç¬¬ä¸€æ€§åŸç†ç†è§£å•ä¸€æ‰€æœ‰æƒè§„åˆ™</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98-%E5%A4%9A%E4%B8%AA%E6%89%80%E6%9C%89%E8%80%85%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0">å…±äº«å†…å­˜-å¤šä¸ªæ‰€æœ‰è€…ï¼šå¼•ç”¨è®¡æ•°</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#rc%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E-%E5%8F%AA%E8%AF%BB%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0">Rcä½¿ç”¨è¯´æ˜: åªè¯»å¼•ç”¨è®¡æ•°</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#rc%E4%BD%BF%E7%94%A8boxleak">Rcä½¿ç”¨Box::leak()</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%BD%BF%E7%94%A8rc%E5%AE%9E%E7%8E%B0dag">ä½¿ç”¨Rcå®ç°DAG</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#refcell-%E6%8F%90%E4%BE%9B%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7%E5%8F%AF%E5%8F%98%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0">RefCell: æä¾›å†…éƒ¨å¯å˜æ€§ï¼Œå¯å˜å¼•ç”¨è®¡æ•°</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%A4%96%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7%E4%B8%8E%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7">å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#refcell%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8">RefCellç®€å•ä½¿ç”¨</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%BD%BF%E7%94%A8refcell%E5%AE%9E%E7%8E%B0%E5%8F%AF%E4%BF%AE%E6%94%B9%E7%89%88%E6%9C%ACdag">ä½¿ç”¨RefCellå®ç°å¯ä¿®æ”¹ç‰ˆæœ¬DAG</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%89%88%E6%9C%AC%E8%AE%A1%E6%95%B0%E5%99%A8arcrcmutexrwlockrefcell">çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬è®¡æ•°å™¨ï¼šArc(Rc)ã€Mutex/RwLock(RefCell)</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%BA%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">äºŒã€ç”Ÿå‘½å‘¨æœŸ</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%8A%A8%E6%80%81%E8%BF%98%E6%98%AF%E9%9D%99%E6%80%81">åŠ¨æ€è¿˜æ˜¯é™æ€ï¼Ÿ</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%A6%82%E4%BD%95%E8%AF%86%E5%88%AB%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">å¦‚ä½•è¯†åˆ«ç”Ÿå‘½å‘¨æœŸ</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%B8%A4%E4%B8%AA%E5%B0%8F%E4%BE%8B%E5%AD%90">ä¸¤ä¸ªå°ä¾‹å­</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E9%9C%80%E8%A6%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E6%B3%A8%E7%9A%84%E6%83%85%E5%86%B5">éœ€è¦ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„æƒ…å†µ</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E7%BC%96%E8%AF%91%E5%99%A8%E5%85%B6%E5%AE%9E%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%BF%9B%E8%A1%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E6%B3%A8">ç¼–è¯‘å™¨å…¶å®ä¼šè‡ªåŠ¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸæ ‡æ³¨</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E6%B3%A8%E7%BB%83%E4%B9%A0">ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ç»ƒä¹ </a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A0%87%E6%B3%A8%E7%9A%84%E7%9B%AE%E7%9A%84">ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„ç›®çš„</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%B8%89%E8%9E%8D%E4%BC%9A%E8%B4%AF%E9%80%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1">ä¸‰ã€èä¼šè´¯é€šï¼Œä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%88%9B%E5%BB%BA">åˆ›å»º</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%A0%86%E5%86%85%E5%AD%98%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86%E5%8F%91%E5%B1%95%E5%8F%B2">å †å†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘å±•å²</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#structenumvecstring%E5%88%9B%E5%BB%BA%E6%97%B6%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">struct/enum/vec/Stringåˆ›å»ºæ—¶çš„å†…å­˜å¸ƒå±€</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#struct">struct</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#enum">enum</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#vec%E5%92%8Cstring">vecå’ŒString</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E6%9B%B4%E5%A4%9A%E5%8F%AF%E8%A7%81cheatsrs">æ›´å¤šå¯è§cheats.rs</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E4%BD%BF%E7%94%A8">ä½¿ç”¨</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#copy%E5%92%8Cmove">copyå’Œmove</a></li>
</ul>
</li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#%E9%94%80%E6%AF%81">é”€æ¯</a>
<ul>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#drop%E9%87%8A%E6%94%BE%E5%A0%86%E5%86%85%E5%AD%98">dropé‡Šæ”¾å †å†…å­˜</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#raii%E9%87%8A%E6%94%BE%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90">RAIIé‡Šæ”¾å…¶ä»–èµ„æº</a></li>
<li><a href="1_stack_heap_ownership_lifetime_memory.html#rust%E5%9C%A8%E7%BC%96%E8%AF%91%E6%97%B6%E8%BF%90%E8%A1%8C%E6%97%B6%E6%A3%80%E6%9F%A5%E8%B0%83%E7%94%A8drop">Ruståœ¨ç¼–è¯‘æ—¶ã€è¿è¡Œæ—¶æ£€æŸ¥è°ƒç”¨drop</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:43:58 UTC 2022 -->
<!--te-->
<h1 id="å†…å­˜"><a class="header" href="#å†…å­˜">å†…å­˜</a></h1>
<h2 id="å­—ç¬¦ä¸²å†…å­˜ä½¿ç”¨å›¾"><a class="header" href="#å­—ç¬¦ä¸²å†…å­˜ä½¿ç”¨å›¾">å­—ç¬¦ä¸²å†…å­˜ä½¿ç”¨å›¾</a></h2>
<details id="admonition-å­—ç¬¦ä¸²å†…å­˜ä½¿ç”¨å›¾" class="admonition info">
<summary class="admonition-title">
<p>å­—ç¬¦ä¸²å†…å­˜ä½¿ç”¨å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å­—ç¬¦ä¸²å†…å­˜ä½¿ç”¨å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/01%EF%BD%9C%E5%86%85%E5%AD%98%EF%BC%9A%E5%80%BC%E6%94%BE%E5%A0%86%E4%B8%8A%E8%BF%98%E6%98%AF%E6%94%BE%E6%A0%88%E4%B8%8A%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98.jpg" alt="å­—ç¬¦ä¸²å†…å­˜ä½¿ç”¨å›¾" /></p>
</div>
</details>
<h2 id="æ ˆ"><a class="header" href="#æ ˆ">æ ˆ</a></h2>
<h3 id="æ ˆå¸§ç¤ºæ„å›¾"><a class="header" href="#æ ˆå¸§ç¤ºæ„å›¾">æ ˆå¸§ç¤ºæ„å›¾</a></h3>
<details id="admonition-æ ˆå¸§ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>æ ˆå¸§ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-æ ˆå¸§ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/01%EF%BD%9C%E5%86%85%E5%AD%98%EF%BC%9A%E5%80%BC%E6%94%BE%E5%A0%86%E4%B8%8A%E8%BF%98%E6%98%AF%E6%94%BE%E6%A0%88%E4%B8%8A%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98-4444135.jpg" alt="æ ˆå¸§ç¤ºæ„å›¾" /></p>
</div>
</details>
<h3 id="è€ƒè™‘æ ˆæº¢å‡º"><a class="header" href="#è€ƒè™‘æ ˆæº¢å‡º">è€ƒè™‘æ ˆæº¢å‡º</a></h3>
<h2 id="å †"><a class="header" href="#å †">å †</a></h2>
<h3 id="ä½¿ç”¨å †å¼•ç”¨å…±äº«æ•°æ®"><a class="header" href="#ä½¿ç”¨å †å¼•ç”¨å…±äº«æ•°æ®">ä½¿ç”¨å †å¼•ç”¨å…±äº«æ•°æ®</a></h3>
<details id="admonition-ä½¿ç”¨å †å¼•ç”¨å…±äº«å†…å­˜æ•°æ®" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨å †å¼•ç”¨å…±äº«å†…å­˜æ•°æ®</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä½¿ç”¨å †å¼•ç”¨å…±äº«å†…å­˜æ•°æ®"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/01%EF%BD%9C%E5%86%85%E5%AD%98%EF%BC%9A%E5%80%BC%E6%94%BE%E5%A0%86%E4%B8%8A%E8%BF%98%E6%98%AF%E6%94%BE%E6%A0%88%E4%B8%8A%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98-4444274.jpg" alt="ä½¿ç”¨å †å¼•ç”¨å…±äº«æ•°æ®" /></p>
</div>
</details>
<h3 id="è€ƒè™‘å †æº¢å‡º"><a class="header" href="#è€ƒè™‘å †æº¢å‡º">è€ƒè™‘å †æº¢å‡º</a></h3>
<details id="admonition-å †é—®é¢˜ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>å †é—®é¢˜ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å †é—®é¢˜ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/01%EF%BD%9C%E5%86%85%E5%AD%98%EF%BC%9A%E5%80%BC%E6%94%BE%E5%A0%86%E4%B8%8A%E8%BF%98%E6%98%AF%E6%94%BE%E6%A0%88%E4%B8%8A%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98.png" alt="å †é—®é¢˜" /></p>
</div>
</details>
<h1 id="ç¼–ç¨‹å››å¤§ç±»åŸºæœ¬æ¦‚å¿µ"><a class="header" href="#ç¼–ç¨‹å››å¤§ç±»åŸºæœ¬æ¦‚å¿µ">ç¼–ç¨‹å››å¤§ç±»åŸºæœ¬æ¦‚å¿µ</a></h1>
<h2 id="1-æ•°æ®"><a class="header" href="#1-æ•°æ®">1. æ•°æ®</a></h2>
<h3 id="å€¼å’Œç±»å‹"><a class="header" href="#å€¼å’Œç±»å‹">å€¼å’Œç±»å‹</a></h3>
<h3 id="æŒ‡é’ˆå’Œå¼•ç”¨"><a class="header" href="#æŒ‡é’ˆå’Œå¼•ç”¨">æŒ‡é’ˆå’Œå¼•ç”¨</a></h3>
<h2 id="2-ä»£ç "><a class="header" href="#2-ä»£ç ">2. ä»£ç </a></h2>
<h3 id="å‡½æ•°---æ–¹æ³•---é—­åŒ…"><a class="header" href="#å‡½æ•°---æ–¹æ³•---é—­åŒ…">å‡½æ•° -&gt; æ–¹æ³• -&gt; é—­åŒ…</a></h3>
<h4 id="é—­åŒ…ç¤ºæ„å›¾"><a class="header" href="#é—­åŒ…ç¤ºæ„å›¾">é—­åŒ…ç¤ºæ„å›¾</a></h4>
<details id="admonition-é—­åŒ…ä¸è‡ªç”±å˜é‡" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…ä¸è‡ªç”±å˜é‡</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-é—­åŒ…ä¸è‡ªç”±å˜é‡"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/02%EF%BD%9C%E4%B8%B2%E8%AE%B2%EF%BC%9A%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91%E4%B8%AD%EF%BC%8C%E9%82%A3%E4%BA%9B%E4%BD%A0%E9%9C%80%E8%A6%81%E6%8E%8C%E6%8F%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5.jpg" alt="é—­åŒ…ä¸è‡ªç”±å˜é‡" /></p>
</div>
</details>
<h3 id="æ¥å£ä¸è™šè¡¨"><a class="header" href="#æ¥å£ä¸è™šè¡¨">æ¥å£ä¸è™šè¡¨</a></h3>
<details id="admonition-è™šè¡¨ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>è™šè¡¨ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-è™šè¡¨ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/02%EF%BD%9C%E4%B8%B2%E8%AE%B2%EF%BC%9A%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91%E4%B8%AD%EF%BC%8C%E9%82%A3%E4%BA%9B%E4%BD%A0%E9%9C%80%E8%A6%81%E6%8E%8C%E6%8F%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-4444557.jpg" alt="è™šè¡¨" /></p>
</div>
</details>
<h2 id="3-è¿è¡Œæ–¹å¼"><a class="header" href="#3-è¿è¡Œæ–¹å¼">3. è¿è¡Œæ–¹å¼</a></h2>
<h3 id="å¹¶å‘ä¸å¹¶è¡Œ"><a class="header" href="#å¹¶å‘ä¸å¹¶è¡Œ">å¹¶å‘ä¸å¹¶è¡Œ</a></h3>
<details id="admonition-å¹¶å‘ä¸å¹¶è¡Œå¯¹æ¯”" class="admonition info">
<summary class="admonition-title">
<p>å¹¶å‘ä¸å¹¶è¡Œå¯¹æ¯”</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å¹¶å‘ä¸å¹¶è¡Œå¯¹æ¯”"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/02%EF%BD%9C%E4%B8%B2%E8%AE%B2%EF%BC%9A%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91%E4%B8%AD%EF%BC%8C%E9%82%A3%E4%BA%9B%E4%BD%A0%E9%9C%80%E8%A6%81%E6%8E%8C%E6%8F%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-4444672.jpg" alt="å¹¶å‘ä¸å¹¶è¡Œ" /></p>
</div>
</details>
<h3 id="åŒæ­¥å’Œå¼‚æ­¥"><a class="header" href="#åŒæ­¥å’Œå¼‚æ­¥">åŒæ­¥å’Œå¼‚æ­¥</a></h3>
<h2 id="4-ç¼–ç¨‹èŒƒå¼"><a class="header" href="#4-ç¼–ç¨‹èŒƒå¼">4. ç¼–ç¨‹èŒƒå¼</a></h2>
<h3 id="æ³›å‹ç¼–ç¨‹"><a class="header" href="#æ³›å‹ç¼–ç¨‹">æ³›å‹ç¼–ç¨‹</a></h3>
<details id="admonition-æ³›å‹ç¼–ç¨‹æ›´æŠ½è±¡æ›´é€šç”¨" class="admonition info">
<summary class="admonition-title">
<p>æ³›å‹ç¼–ç¨‹æ›´æŠ½è±¡ï¼Œæ›´é€šç”¨</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-æ³›å‹ç¼–ç¨‹æ›´æŠ½è±¡æ›´é€šç”¨"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/02%EF%BD%9C%E4%B8%B2%E8%AE%B2%EF%BC%9A%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91%E4%B8%AD%EF%BC%8C%E9%82%A3%E4%BA%9B%E4%BD%A0%E9%9C%80%E8%A6%81%E6%8E%8C%E6%8F%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-4444741.jpg" alt="æ³›å‹ç¼–ç¨‹æ›´æŠ½è±¡ï¼Œæ›´é€šç”¨" /></p>
</div>
</details>
<h3 id="å‡½æ•°å¼ç¼–ç¨‹"><a class="header" href="#å‡½æ•°å¼ç¼–ç¨‹">å‡½æ•°å¼ç¼–ç¨‹</a></h3>
<h3 id="é¢å‘å¯¹è±¡ç¼–ç¨‹"><a class="header" href="#é¢å‘å¯¹è±¡ç¼–ç¨‹">é¢å‘å¯¹è±¡ç¼–ç¨‹</a></h3>
<h1 id="rustå†…å­˜ç®¡ç†æ¦‚è§ˆ"><a class="header" href="#rustå†…å­˜ç®¡ç†æ¦‚è§ˆ">Rustå†…å­˜ç®¡ç†æ¦‚è§ˆ</a></h1>
<h2 id="ä¸€æ‰€æœ‰æƒ-å•ä¸€å…±äº«"><a class="header" href="#ä¸€æ‰€æœ‰æƒ-å•ä¸€å…±äº«">ä¸€ã€æ‰€æœ‰æƒ: å•ä¸€/å…±äº«</a></h2>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/09%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%80%BC%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E4%B8%AA%E6%89%80%E6%9C%89%E8%80%85%E4%B9%88%EF%BC%9F-4606985.jpg" alt="å•ä¸€/å…±äº«æ‰€æœ‰æƒå¯¹æ¯”" /></p>
<h2 id="å•ä¸€æ‰€æœ‰æƒæŒæ§ç”Ÿæ€å¤§æƒ"><a class="header" href="#å•ä¸€æ‰€æœ‰æƒæŒæ§ç”Ÿæ€å¤§æƒ">å•ä¸€æ‰€æœ‰æƒï¼šæŒæ§ç”Ÿæ€å¤§æƒ</a></h2>
<h3 id="ä»å¤šå¼•ç”¨å¼€å§‹"><a class="header" href="#ä»å¤šå¼•ç”¨å¼€å§‹">ä»å¤šå¼•ç”¨å¼€å§‹</a></h3>
<details id="admonition-å¤šé‡å †å¼•ç”¨é—®é¢˜" class="admonition info">
<summary class="admonition-title">
<p>å¤šé‡å †å¼•ç”¨é—®é¢˜</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å¤šé‡å †å¼•ç”¨é—®é¢˜"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/07%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E5%80%BC%E7%9A%84%E7%94%9F%E6%9D%80%E5%A4%A7%E6%9D%83%E5%88%B0%E5%BA%95%E5%9C%A8%E8%B0%81%E6%89%8B%E4%B8%8A%EF%BC%9F-4446989.jpg" alt="å¤šé‡å †å¼•ç”¨çš„é—®é¢˜" /></p>
</div>
</details>
<h3 id="rustå¦‚ä½•è§£å†³"><a class="header" href="#rustå¦‚ä½•è§£å†³">Rustå¦‚ä½•è§£å†³</a></h3>
<h4 id="æ–¹æ¡ˆä¸€å•ä¸€æ‰€æœ‰æƒ"><a class="header" href="#æ–¹æ¡ˆä¸€å•ä¸€æ‰€æœ‰æƒ">æ–¹æ¡ˆä¸€ã€å•ä¸€æ‰€æœ‰æƒ</a></h4>
<details id="admonition-å•ä¸€æ‰€æœ‰æƒè§£å†³å¤šé‡å¼•ç”¨é—®é¢˜" class="admonition info">
<summary class="admonition-title">
<p>å•ä¸€æ‰€æœ‰æƒè§£å†³å¤šé‡å¼•ç”¨é—®é¢˜</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å•ä¸€æ‰€æœ‰æƒè§£å†³å¤šé‡å¼•ç”¨é—®é¢˜"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/07%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E5%80%BC%E7%9A%84%E7%94%9F%E6%9D%80%E5%A4%A7%E6%9D%83%E5%88%B0%E5%BA%95%E5%9C%A8%E8%B0%81%E6%89%8B%E4%B8%8A%EF%BC%9F-4446891.jpg" alt="rustæ‰€æœ‰æƒè§„åˆ™è§£å†³å¤šé‡å¼•ç”¨é—®é¢˜" /></p>
</div>
</details>
<h4 id="æ–¹æ¡ˆäºŒcopy"><a class="header" href="#æ–¹æ¡ˆäºŒcopy">æ–¹æ¡ˆäºŒã€Copy</a></h4>
<details id="admonition-ä½¿ç”¨copyè§£å†³å¤šé‡å¼•ç”¨é—®é¢˜" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨Copyè§£å†³å¤šé‡å¼•ç”¨é—®é¢˜</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä½¿ç”¨copyè§£å†³å¤šé‡å¼•ç”¨é—®é¢˜"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/07%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E5%80%BC%E7%9A%84%E7%94%9F%E6%9D%80%E5%A4%A7%E6%9D%83%E5%88%B0%E5%BA%95%E5%9C%A8%E8%B0%81%E6%89%8B%E4%B8%8A%EF%BC%9F-4447051.jpg" alt="Copyè§£å†³" /></p>
</div>
</details>
<h3 id="å•ä¸€æ‰€æœ‰æƒè§„åˆ™æ•´ç†"><a class="header" href="#å•ä¸€æ‰€æœ‰æƒè§„åˆ™æ•´ç†">å•ä¸€æ‰€æœ‰æƒè§„åˆ™æ•´ç†</a></h3>
<details id="admonition-å•ä¸€æ‰€æœ‰æƒè§„åˆ™æ•´ç†" class="admonition info">
<summary class="admonition-title">
<p>å•ä¸€æ‰€æœ‰æƒè§„åˆ™æ•´ç†</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å•ä¸€æ‰€æœ‰æƒè§„åˆ™æ•´ç†"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/07%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E5%80%BC%E7%9A%84%E7%94%9F%E6%9D%80%E5%A4%A7%E6%9D%83%E5%88%B0%E5%BA%95%E5%9C%A8%E8%B0%81%E6%89%8B%E4%B8%8A%EF%BC%9F-4447111.jpg" alt="æ‰€æœ‰æƒè§„åˆ™æ•´ç†" /></p>
</div>
</details>
<h3 id="å•ä¸€æ‰€æœ‰æƒå€Ÿç”¨"><a class="header" href="#å•ä¸€æ‰€æœ‰æƒå€Ÿç”¨">å•ä¸€æ‰€æœ‰æƒå€Ÿç”¨</a></h3>
<h4 id="ä¸¤ç§ä¼ å‚æ–¹å¼ä¼ å€¼ä¼ å€"><a class="header" href="#ä¸¤ç§ä¼ å‚æ–¹å¼ä¼ å€¼ä¼ å€">ä¸¤ç§ä¼ å‚æ–¹å¼ï¼šä¼ å€¼/ä¼ å€</a></h4>
<details id="admonition-ä¼ å€¼-or-ä¼ å€" class="admonition info">
<summary class="admonition-title">
<p>ä¼ å€¼ or ä¼ å€</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä¼ å€¼-or-ä¼ å€"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/08%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E5%80%BC%E7%9A%84%E5%80%9F%E7%94%A8%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F.jpg" alt="ä¼ å€¼/ä¼ å€" /></p>
</div>
</details>
<h4 id="åªè¯»å€Ÿç”¨å¼•ç”¨"><a class="header" href="#åªè¯»å€Ÿç”¨å¼•ç”¨">åªè¯»å€Ÿç”¨/å¼•ç”¨</a></h4>
<details id="admonition-åªè¯»å€Ÿç”¨å¼•ç”¨" class="admonition info">
<summary class="admonition-title">
<p>åªè¯»å€Ÿç”¨/å¼•ç”¨</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-åªè¯»å€Ÿç”¨å¼•ç”¨"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/08%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E5%80%BC%E7%9A%84%E5%80%9F%E7%94%A8%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F-4447323.jpg" alt="åªè¯»" /></p>
</div>
</details>
<h4 id="å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸çº¦æŸ"><a class="header" href="#å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸çº¦æŸ">å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸çº¦æŸ</a></h4>
<details id="admonition-ä¸‰æ®µç”Ÿå‘½å‘¨æœŸåˆ†æ" class="admonition info">
<summary class="admonition-title">
<p>ä¸‰æ®µç”Ÿå‘½å‘¨æœŸåˆ†æ</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä¸‰æ®µç”Ÿå‘½å‘¨æœŸåˆ†æ"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/08%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E5%80%BC%E7%9A%84%E5%80%9F%E7%94%A8%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F-4447702.jpg" alt="ä¸‰æ®µç”Ÿå‘½å‘¨æœŸåˆ†æ" /></p>
</div>
</details>
<h4 id="å¯å˜å€Ÿç”¨å¼•ç”¨"><a class="header" href="#å¯å˜å€Ÿç”¨å¼•ç”¨">å¯å˜å€Ÿç”¨/å¼•ç”¨</a></h4>
<blockquote>
<p>åŒä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­å¤šä¸ªå¯å˜å¼•ç”¨æ˜¯ä¸å®‰å…¨çš„ï¼Œé‚£å¦‚æœåŒæ—¶æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨å’Œè‹¥å¹²ä¸ªåªè¯»å¼• ç”¨å°±å¯ä»¥</p>
</blockquote>
<h4 id="ç¬¬ä¸€æ€§åŸç†ç†è§£å•ä¸€æ‰€æœ‰æƒè§„åˆ™"><a class="header" href="#ç¬¬ä¸€æ€§åŸç†ç†è§£å•ä¸€æ‰€æœ‰æƒè§„åˆ™">ç¬¬ä¸€æ€§åŸç†ç†è§£å•ä¸€æ‰€æœ‰æƒè§„åˆ™</a></h4>
<details id="admonition-ç¬¬ä¸€æ€§åŸç†ç†è§£æ‰€æœ‰æƒæ¨¡å‹å•ä¸€æ‰€æœ‰æƒå…±äº«æ‰€æœ‰æƒ" class="admonition info">
<summary class="admonition-title">
<p>ç¬¬ä¸€æ€§åŸç†ç†è§£æ‰€æœ‰æƒæ¨¡å‹ï¼šå•ä¸€æ‰€æœ‰æƒ/å…±äº«æ‰€æœ‰æƒ</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ç¬¬ä¸€æ€§åŸç†ç†è§£æ‰€æœ‰æƒæ¨¡å‹å•ä¸€æ‰€æœ‰æƒå…±äº«æ‰€æœ‰æƒ"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/08%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E5%80%BC%E7%9A%84%E5%80%9F%E7%94%A8%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F-4447883.jpg" alt="ç¬¬ä¸€æ€§åŸç†" /></p>
</div>
</details>
<h2 id="å…±äº«å†…å­˜-å¤šä¸ªæ‰€æœ‰è€…å¼•ç”¨è®¡æ•°"><a class="header" href="#å…±äº«å†…å­˜-å¤šä¸ªæ‰€æœ‰è€…å¼•ç”¨è®¡æ•°">å…±äº«å†…å­˜-å¤šä¸ªæ‰€æœ‰è€…ï¼šå¼•ç”¨è®¡æ•°</a></h2>
<details id="admonition-å•ä¸€æ‰€æœ‰æƒä¸å¤šä¸ªæ‰€æœ‰è€…æ˜¯å¦æœ‰å†²çª" class="admonition info">
<summary class="admonition-title">
<p>å•ä¸€æ‰€æœ‰æƒä¸å¤šä¸ªæ‰€æœ‰è€…æ˜¯å¦æœ‰å†²çªï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å•ä¸€æ‰€æœ‰æƒä¸å¤šä¸ªæ‰€æœ‰è€…æ˜¯å¦æœ‰å†²çª"></a></p>
</summary>
<div>
<ol>
<li>é™æ€æ£€æŸ¥ï¼šå•ä¸€æ‰€æœ‰æƒæ˜¯rustçš„ç¼–è¯‘æœŸé»˜è®¤æ£€æŸ¥å†…å®¹</li>
<li>åŠ¨æ€æ£€æŸ¥ï¼šå¤šä¸ªæ‰€æœ‰è€…ä¸»è¦æ˜¯ç”¨äºå…±äº«å†…å­˜ï¼Œè¿™æ˜¯ä¸“é—¨æä¾›Rc/Arcã€Box::leak()ã€RefCell/Mutex/RwLockç­‰å·¥å…·ã€‚</li>
</ol>
<hr />
<blockquote>
<p>è¿™é‡Œå…¶å®å¯ä»¥çœ‹å‡ºrustå¦‚ä½•ä½¿ç”¨â€™äºŒå…«æ³•åˆ™â€™è§£å†³é—®é¢˜ï¼š</p>
</blockquote>
<ul>
<li>å¯¹äºå¸¸ç”¨åœºæ™¯ï¼Œç”¨ç¼–è¯‘æœŸé™æ€æ£€æŸ¥æ¥é»˜è®¤è§£å†³</li>
<li>å¯¹äºç‰¹åˆ«åœºæ™¯ï¼Œç”¨ä¸“é—¨çš„è¯­æ³•æ˜¾å¼è¡¨è¾¾å‡ºæ¥ï¼Œæä¾›è¿è¡ŒæœŸåŠ¨æ€æ£€æŸ¥æ¥ä¸“é—¨è§£å†³</li>
</ul>
</div>
</details>
<h3 id="rcä½¿ç”¨è¯´æ˜-åªè¯»å¼•ç”¨è®¡æ•°"><a class="header" href="#rcä½¿ç”¨è¯´æ˜-åªè¯»å¼•ç”¨è®¡æ•°">Rcä½¿ç”¨è¯´æ˜: åªè¯»å¼•ç”¨è®¡æ•°</a></h3>
<details id="admonition-å¯¹ä¸€ä¸ª-rc-ç»“æ„è¿›è¡Œ-cloneä¸ä¼šå°†å…¶å†…éƒ¨çš„æ•°æ®å¤åˆ¶åªä¼šå¢åŠ å¼•ç”¨è®¡æ•°" class="admonition info">
<summary class="admonition-title">
<p>å¯¹ä¸€ä¸ª Rc ç»“æ„è¿›è¡Œ clone()ï¼Œä¸ä¼šå°†å…¶å†…éƒ¨çš„æ•°æ®å¤åˆ¶ï¼Œåªä¼šå¢åŠ å¼•ç”¨è®¡æ•°</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å¯¹ä¸€ä¸ª-rc-ç»“æ„è¿›è¡Œ-cloneä¸ä¼šå°†å…¶å†…éƒ¨çš„æ•°æ®å¤åˆ¶åªä¼šå¢åŠ å¼•ç”¨è®¡æ•°"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::rc::Rc;
fn main() {
    let a = Rc::new(1);
    let b = a.clone();
    let c = a.clone();
}
</code></pre></pre>
</div>
</details>
<details id="admonition-ä¸Šæ–¹ä»£ç rcå¼•ç”¨è®¡æ•°ç¤ºæ„å›¾å…±äº«å †å†…å­˜" class="admonition info">
<summary class="admonition-title">
<p>ä¸Šæ–¹ä»£ç Rcå¼•ç”¨è®¡æ•°ç¤ºæ„å›¾ï¼šå…±äº«å †å†…å­˜</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä¸Šæ–¹ä»£ç rcå¼•ç”¨è®¡æ•°ç¤ºæ„å›¾å…±äº«å †å†…å­˜"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/09%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%80%BC%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E4%B8%AA%E6%89%80%E6%9C%89%E8%80%85%E4%B9%88%EF%BC%9F-4604653.jpg" alt="å¼•ç”¨è®¡æ•°ç¤ºæ„å›¾" /></p>
</div>
</details>
<details id="admonition-cloneæºç " class="admonition info">
<summary class="admonition-title">
<p>cloneæºç </p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-cloneæºç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">fn clone(&amp;self) -&gt; Rc&lt;T&gt; {
    // å¢åŠ å¼•ç”¨è®¡æ•°
    self.inner().inc_strong();
    // é€šè¿‡ self.ptr ç”Ÿæˆä¸€ä¸ªæ–°çš„ Rc ç»“æ„
    Self::from_inner(self.ptr)
}
</code></pre></pre>
</div>
</details>
<h4 id="rcä½¿ç”¨boxleak"><a class="header" href="#rcä½¿ç”¨boxleak">Rcä½¿ç”¨Box::leak()</a></h4>
<details id="admonition-ä½¿ç”¨boxleakåˆ›å»ºä¸å—æ ˆå†…å­˜æ§åˆ¶å †å †å†…å­˜ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨Box::leak()åˆ›å»ºä¸å—æ ˆå†…å­˜æ§åˆ¶å †å †å†…å­˜ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä½¿ç”¨boxleakåˆ›å»ºä¸å—æ ˆå†…å­˜æ§åˆ¶å †å †å†…å­˜ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/09%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%80%BC%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E4%B8%AA%E6%89%80%E6%9C%89%E8%80%85%E4%B9%88%EF%BC%9F-4605420.jpg" alt="ä½¿ç”¨Box::leak()åˆ›å»ºä¸å—æ ˆå†…å­˜æ§åˆ¶å †å †å†…å­˜ç¤ºæ„å›¾" /></p>
</div>
</details>
<details id="admonition-æœ‰äº†-boxleakæˆ‘ä»¬å°±å¯ä»¥è·³å‡º-rust-ç¼–è¯‘å™¨çš„é™æ€æ£€æŸ¥" class="admonition info">
<summary class="admonition-title">
<p>æœ‰äº† Box::leak()ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·³å‡º Rust ç¼–è¯‘å™¨çš„é™æ€æ£€æŸ¥</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-æœ‰äº†-boxleakæˆ‘ä»¬å°±å¯ä»¥è·³å‡º-rust-ç¼–è¯‘å™¨çš„é™æ€æ£€æŸ¥"></a></p>
</summary>
<div>
<p>ä¿è¯ Rc æŒ‡å‘çš„å †å†…å­˜ï¼Œæœ‰æœ€å¤§çš„ç”Ÿå‘½å‘¨æœŸï¼Œç„¶åæˆ‘ä»¬å†é€šè¿‡å¼•ç”¨è®¡æ•°ï¼Œåœ¨åˆé€‚çš„æ—¶æœºï¼Œç»“æŸè¿™æ®µå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä½ å¯¹æ­¤æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ <a href="https://doc.rust-lang.org/src/alloc/rc.rs.html#342-350">Rc::new() çš„æºç </a>ã€‚</p>
</div>
</details>
<h4 id="ä½¿ç”¨rcå®ç°dag"><a class="header" href="#ä½¿ç”¨rcå®ç°dag">ä½¿ç”¨Rcå®ç°DAG</a></h4>
<details id="admonition-dagæ•°æ®ç»“æ„ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>DAGæ•°æ®ç»“æ„ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-dagæ•°æ®ç»“æ„ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/09%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%80%BC%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E4%B8%AA%E6%89%80%E6%9C%89%E8%80%85%E4%B9%88%EF%BC%9F-4607216.jpg" alt="DAGæ•°æ®ç»“æ„" /></p>
</div>
</details>
<details id="admonition-ä¸å¯ä¿®æ”¹ç‰ˆæœ¬" class="admonition info">
<summary class="admonition-title">
<p>ä¸å¯ä¿®æ”¹ç‰ˆæœ¬</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä¸å¯ä¿®æ”¹ç‰ˆæœ¬"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::rc::Rc;

#[allow(dead_code)]
#[derive(Debug)]
struct Node {
    id: usize,
    downstream: Option&lt;Rc&lt;Node&gt;&gt;,
}

impl Node {
    pub fn new(id: usize) -&gt; Self {
        Self {
            id,
            downstream: None,
        }
    }

    pub fn update_downstream(&amp;mut self, downstream: Rc&lt;Node&gt;) {
        self.downstream = Some(downstream);
    }

    pub fn get_downstream(&amp;self) -&gt; Option&lt;Rc&lt;Node&gt;&gt; {
        self.downstream.as_ref().cloned()
    }
}

fn main() {
    let mut node1 = Node::new(1);
    let mut node2 = Node::new(2);
    let mut node3 = Node::new(3);
    let node4 = Node::new(4);
    node3.update_downstream(Rc::new(node4));

    node1.update_downstream(Rc::new(node3));
    node2.update_downstream(node1.get_downstream().unwrap());
    println!(&quot;node1: {:?}, node2: {:?}&quot;, node1, node2);

    // æ— æ³•ç¼–è¯‘é€šè¿‡: cannot borrow as mutable
    // let node5 = Node::new(5);
    // let node3 = node1.get_downstream().unwrap();
    // node3.update_downstream(Rc::new(node5));

    // println!(&quot;node1: {:?}, node2: {:?}&quot;, node1, node2);
}
</code></pre></pre>
<ul>
<li>new()ï¼šå»ºç«‹ä¸€ä¸ªæ–°çš„ Nodeã€‚</li>
<li>update_downstream()ï¼šè®¾ç½® Node çš„ downstreamã€‚</li>
<li>get_downstream()ï¼šclone ä¸€ä»½ Node é‡Œçš„ downstreamã€‚</li>
</ul>
</div>
</details>
<h3 id="refcell-æä¾›å†…éƒ¨å¯å˜æ€§å¯å˜å¼•ç”¨è®¡æ•°"><a class="header" href="#refcell-æä¾›å†…éƒ¨å¯å˜æ€§å¯å˜å¼•ç”¨è®¡æ•°">RefCell: æä¾›å†…éƒ¨å¯å˜æ€§ï¼Œå¯å˜å¼•ç”¨è®¡æ•°</a></h3>
<h4 id="å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§"><a class="header" href="#å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§">å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§</a></h4>
<details id="admonition-å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§å¯¹æ¯”å›¾" class="admonition info">
<summary class="admonition-title">
<p>å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§å¯¹æ¯”å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§å¯¹æ¯”å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/09%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%80%BC%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E4%B8%AA%E6%89%80%E6%9C%89%E8%80%85%E4%B9%88%EF%BC%9F-4606188-4606221.jpg" alt="å¤–éƒ¨å¯å˜æ€§ä¸å†…éƒ¨å¯å˜æ€§" /></p>
</div>
</details>
<h4 id="refcellç®€å•ä½¿ç”¨"><a class="header" href="#refcellç®€å•ä½¿ç”¨">RefCellç®€å•ä½¿ç”¨</a></h4>
<details id="admonition-è·å¾—-refcell-å†…éƒ¨æ•°æ®çš„å¯å˜å€Ÿç”¨" class="admonition info">
<summary class="admonition-title">
<p>è·å¾— RefCell å†…éƒ¨æ•°æ®çš„å¯å˜å€Ÿç”¨</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-è·å¾—-refcell-å†…éƒ¨æ•°æ®çš„å¯å˜å€Ÿç”¨"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::cell::RefCell;

fn main() {
    let data = RefCell::new(1);
    {
        // è·å¾— RefCell å†…éƒ¨æ•°æ®çš„å¯å˜å€Ÿç”¨
        let mut v = data.borrow_mut();
        *v += 1;
    }
    println!(&quot;data: {:?}&quot;, data.borrow());
}
</code></pre></pre>
</div>
</details>
<h4 id="ä½¿ç”¨refcellå®ç°å¯ä¿®æ”¹ç‰ˆæœ¬dag"><a class="header" href="#ä½¿ç”¨refcellå®ç°å¯ä¿®æ”¹ç‰ˆæœ¬dag">ä½¿ç”¨RefCellå®ç°å¯ä¿®æ”¹ç‰ˆæœ¬DAG</a></h4>
<details id="admonition-ä¸å¯ä¿®æ”¹ç‰ˆæœ¬-1" class="admonition info">
<summary class="admonition-title">
<p>ä¸å¯ä¿®æ”¹ç‰ˆæœ¬</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä¸å¯ä¿®æ”¹ç‰ˆæœ¬-1"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::cell::RefCell;
use std::rc::Rc;

#[allow(dead_code)]
#[derive(Debug)]
struct Node {
    id: usize,
    // ä½¿ç”¨ Rc&lt;RefCell&lt;T&gt;&gt; è®©èŠ‚ç‚¹å¯ä»¥è¢«ä¿®æ”¹
    downstream: Option&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,
}

impl Node {
    pub fn new(id: usize) -&gt; Self {
        Self {
            id,
            downstream: None,
        }
    }

    pub fn update_downstream(&amp;mut self, downstream: Rc&lt;RefCell&lt;Node&gt;&gt;) {
        self.downstream = Some(downstream);
    }

    pub fn get_downstream(&amp;self) -&gt; Option&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt; {
        self.downstream.as_ref().cloned()
    }
}

fn main() {
    let mut node1 = Node::new(1);
    let mut node2 = Node::new(2);
    let mut node3 = Node::new(3);
    let node4 = Node::new(4);

    node3.update_downstream(Rc::new(RefCell::new(node4)));
    node1.update_downstream(Rc::new(RefCell::new(node3)));
    node2.update_downstream(node1.get_downstream().unwrap());
    println!(&quot;node1: {:?}, node2: {:?}&quot;, node1, node2);

    let node5 = Node::new(5);
    let node3 = node1.get_downstream().unwrap();
    // è·å¾—å¯å˜å¼•ç”¨ï¼Œæ¥ä¿®æ”¹ downstream
    node3.borrow_mut().downstream = Some(Rc::new(RefCell::new(node5)));

    println!(&quot;node1: {:?}, node2: {:?}&quot;, node1, node2);
}
</code></pre></pre>
<ol>
<li>é¦–å…ˆæ•°æ®ç»“æ„çš„ downstream éœ€è¦ Rc å†…éƒ¨åµŒå¥—ä¸€ä¸ª RefCell</li>
<li>è¿™æ ·ï¼Œå°±å¯ä»¥åˆ©ç”¨ RefCell çš„å†…éƒ¨å¯å˜æ€§ï¼Œæ¥è·å¾—æ•°æ®çš„å¯å˜å€Ÿç”¨</li>
<li>åŒæ—¶ Rc è¿˜å…è®¸å€¼æœ‰å¤šä¸ªæ‰€æœ‰è€…ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-refcellå†…éƒ¨å¯å˜æ€§ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>RefCellå†…éƒ¨å¯å˜æ€§ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-refcellå†…éƒ¨å¯å˜æ€§ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/09%EF%BD%9C%E6%89%80%E6%9C%89%E6%9D%83%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%80%BC%E5%8F%AF%E4%BB%A5%E6%9C%89%E5%A4%9A%E4%B8%AA%E6%89%80%E6%9C%89%E8%80%85%E4%B9%88%EF%BC%9F-4606429.jpg" alt="ä½¿ç”¨RefCellå®ç°å¯ä¿®æ”¹ç‰ˆæœ¬DAG" /></p>
</div>
</details>
<h3 id="çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬è®¡æ•°å™¨arcrcmutexrwlockrefcell"><a class="header" href="#çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬è®¡æ•°å™¨arcrcmutexrwlockrefcell">çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬è®¡æ•°å™¨ï¼šArc(Rc)ã€Mutex/RwLock(RefCell)</a></h3>
<details id="admonition-rustå®ç°ä¸¤å¥—ä¸åŒçš„å¼•ç”¨è®¡æ•°æ•°æ®ç»“æ„" class="admonition info">
<summary class="admonition-title">
<p>Rustå®ç°ä¸¤å¥—ä¸åŒçš„å¼•ç”¨è®¡æ•°æ•°æ®ç»“æ„</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-rustå®ç°ä¸¤å¥—ä¸åŒçš„å¼•ç”¨è®¡æ•°æ•°æ®ç»“æ„"></a></p>
</summary>
<div>
<blockquote>
<p>Arc å†…éƒ¨çš„å¼•ç”¨è®¡æ•°ä½¿ç”¨äº† <a href="https://doc.rust-lang.org/src/alloc/sync.rs.html#303-312">Atomic Usize</a> ï¼Œè€Œéæ™®é€šçš„ usizeã€‚
ä»åç§°ä¸Šä¹Ÿå¯ä»¥æ„Ÿè§‰å‡ºæ¥ï¼ŒAtomic Usize æ˜¯ usize çš„åŸå­ç±»å‹ï¼Œå®ƒä½¿ç”¨äº† CPU çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œæ¥ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å®‰å…¨ã€‚
å¦‚æœä½ å¯¹åŸå­ç±»å‹æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹ <a href="https://doc.rust-lang.org/std/sync/atomic/index.html">std::sync::atomic</a> çš„æ–‡æ¡£ã€‚</p>
</blockquote>
<p>Rust å®ç°ä¸¤å¥—ä¸åŒçš„å¼•ç”¨è®¡æ•°æ•°æ®ç»“æ„ï¼Œå®Œå…¨æ˜¯ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œä»è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ„Ÿå—åˆ° Rust å¯¹æ€§èƒ½çš„æè‡´æ¸´æ±‚:</p>
<ul>
<li>å¦‚æœä¸ç”¨è·¨çº¿ç¨‹è®¿é—®ï¼Œå¯ä»¥ç”¨æ•ˆç‡éå¸¸é«˜çš„ Rcï¼› å¦‚æœè¦è·¨çº¿ç¨‹è®¿é—®ï¼Œé‚£ä¹ˆå¿…é¡»ç”¨ Arcã€‚</li>
<li>åŒæ ·çš„ï¼ŒRefCell ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œä½¿ç”¨å†…éƒ¨å¯å˜æ€§ï¼ŒRust æä¾›äº† Mutex å’Œ RwLockã€‚</li>
</ul>
</div>
</details>
<details id="admonition-mutexrwlockå…¶å®æ˜¯å¹¶å‘çš„ä¸¤ä¸ªæ–¹æ¡ˆ" class="admonition info">
<summary class="admonition-title">
<p>Mutex/RwLockå…¶å®æ˜¯å¹¶å‘çš„ä¸¤ä¸ªæ–¹æ¡ˆ</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-mutexrwlockå…¶å®æ˜¯å¹¶å‘çš„ä¸¤ä¸ªæ–¹æ¡ˆ"></a></p>
</summary>
<div>
<p>è¿™ä¸¤ä¸ªæ•°æ®ç»“æ„ä½ åº”è¯¥éƒ½ä¸é™Œç”Ÿ:</p>
<ol>
<li>Mutex æ˜¯äº’æ–¥é‡ï¼Œè·å¾—äº’æ–¥é‡çš„çº¿ç¨‹å¯¹æ•°æ®ç‹¬å è®¿é—®.</li>
<li>RwLock æ˜¯è¯»å†™é”ï¼Œè·å¾—å†™é”çš„çº¿ç¨‹å¯¹æ•°æ®ç‹¬å è®¿é—®ï¼Œä½†å½“æ²¡æœ‰å†™é”çš„æ—¶å€™ï¼Œå…è®¸æœ‰å¤šä¸ªè¯»é”ã€‚ </li>
<li>è¯»å†™é”çš„è§„åˆ™å’Œ Rust çš„å€Ÿç”¨è§„åˆ™éå¸¸ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ç±»æ¯”ç€å­¦ã€‚</li>
<li>Mutex å’Œ RwLock éƒ½ç”¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯¹å…±äº«æ•°æ®è®¿é—®çš„ä¿æŠ¤ä¸Šã€‚</li>
<li>å‰é¢æ„å»ºçš„ DAG å¦‚æœè¦ç”¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œéœ€è¦æŠŠ Rc&gt; æ›¿æ¢ä¸º Arc&gt; æˆ–è€… Arc&gt;ã€‚</li>
</ol>
</div>
</details>
<h2 id="äºŒç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#äºŒç”Ÿå‘½å‘¨æœŸ">äºŒã€ç”Ÿå‘½å‘¨æœŸ</a></h2>
<h3 id="åŠ¨æ€è¿˜æ˜¯é™æ€"><a class="header" href="#åŠ¨æ€è¿˜æ˜¯é™æ€">åŠ¨æ€è¿˜æ˜¯é™æ€ï¼Ÿ</a></h3>
<details id="admonition-åŠ¨æ€é™æ€ç”Ÿå‘½å‘¨æœŸå®šä¹‰ä¸è¡¨ç¤ºæ–¹å¼" class="admonition info">
<summary class="admonition-title">
<p>åŠ¨æ€/é™æ€ç”Ÿå‘½å‘¨æœŸå®šä¹‰ä¸è¡¨ç¤ºæ–¹å¼</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-åŠ¨æ€é™æ€ç”Ÿå‘½å‘¨æœŸå®šä¹‰ä¸è¡¨ç¤ºæ–¹å¼"></a></p>
</summary>
<div>
<ol>
<li>é™æ€ç”Ÿå‘½å‘¨æœŸ: â€™static str</li>
</ol>
<ul>
<li>å¦‚æœä¸€ä¸ªå€¼çš„ç”Ÿå‘½å‘¨æœŸè´¯ç©¿æ•´ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç§°è¿™ç§ç”Ÿå‘½å‘¨æœŸä¸ºé™æ€ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li>å½“å€¼æ‹¥æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸï¼Œå…¶å¼•ç”¨ä¹Ÿå…·æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li>æˆ‘ä»¬åœ¨è¡¨è¿°è¿™ç§å¼•ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ â€™static æ¥è¡¨ç¤ºã€‚æ¯”å¦‚ï¼š &amp;â€™static str ä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå…·æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸçš„å­—ç¬¦ä¸²å¼•ç”¨ã€‚</li>
<li>ä¸€èˆ¬æ¥è¯´ï¼Œå…¨å±€å˜é‡ã€é™æ€å˜é‡ã€å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆstring literal (å­—é¢) ï¼‰ç­‰ï¼Œéƒ½æ‹¥æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li>å †å†…å­˜ï¼Œå¦‚æœä½¿ç”¨äº† Box::leak åï¼Œä¹Ÿå…·æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ul>
<ol start="2">
<li>åŠ¨æ€ç”Ÿå‘½å‘¨æœŸ: â€™a ã€â€™b æˆ–è€… â€™hello è¿™æ ·çš„å°å†™å­—ç¬¦æˆ–è€…å­—ç¬¦ä¸²æ¥è¡¨è¿°</li>
</ol>
<ul>
<li>å¦‚æœä¸€ä¸ªå€¼æ˜¯åœ¨æŸä¸ªä½œç”¨åŸŸä¸­å®šä¹‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒè¢«åˆ›å»ºåœ¨æ ˆä¸Šæˆ–è€…å †ä¸Šï¼Œé‚£ä¹ˆå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯åŠ¨æ€çš„ã€‚</li>
<li>å½“è¿™ä¸ªå€¼çš„ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œå€¼çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿéšä¹‹ç»“æŸã€‚</li>
<li>å¯¹äºåŠ¨æ€ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬çº¦å®šç”¨ â€™a ã€â€™b æˆ–è€… â€™hello è¿™æ ·çš„å°å†™å­—ç¬¦æˆ–è€…å­—ç¬¦ä¸²æ¥è¡¨è¿°ã€‚ </li>
<li>â€™ åé¢å…·ä½“æ˜¯ä»€ä¹ˆåå­—ä¸é‡è¦ï¼Œå®ƒä»£è¡¨æŸä¸€æ®µåŠ¨æ€çš„ç”Ÿå‘½å‘¨æœŸ</li>
<li>å…¶ä¸­ï¼Œ &amp;â€™a str å’Œ &amp;â€™b str è¡¨ç¤ºè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¸ä¸€è‡´ã€‚</li>
</ul>
</div>
</details>
<details id="admonition-åŠ¨é™æ€ç”Ÿå‘½å‘¨æœŸç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>åŠ¨é™æ€ç”Ÿå‘½å‘¨æœŸç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-åŠ¨é™æ€ç”Ÿå‘½å‘¨æœŸç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/10%EF%BD%9C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9A%E4%BD%A0%E5%88%9B%E5%BB%BA%E7%9A%84%E5%80%BC%E7%A9%B6%E7%AB%9F%E8%83%BD%E6%B4%BB%E5%A4%9A%E4%B9%85%EF%BC%9F.jpg" alt="åŠ¨é™æ€ç”Ÿå‘½å‘¨æœŸç¤ºæ„å›¾" /></p>
<ol>
<li>åˆ†é…åœ¨å †å’Œæ ˆä¸Šçš„å†…å­˜æœ‰å…¶å„è‡ªçš„ä½œç”¨åŸŸï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸæ˜¯åŠ¨æ€çš„ã€‚</li>
<li>å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€å­—ç¬¦ä¸²å­—é¢é‡ã€ä»£ç ç­‰å†…å®¹ï¼Œåœ¨ç¼–è¯‘æ—¶ï¼Œä¼šè¢«ç¼–è¯‘åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ BSS/Data/RoData/Text æ®µï¼Œç„¶ååœ¨åŠ è½½æ—¶ï¼Œè£…å…¥å†…å­˜ã€‚</li>
<li>å› è€Œï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œè¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼Œæ‰€ä»¥æ˜¯é™æ€çš„ã€‚</li>
<li>æ‰€ä»¥ï¼Œå‡½æ•°æŒ‡é’ˆçš„ç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯é™æ€çš„ï¼Œå› ä¸ºå‡½æ•°åœ¨ Text æ®µä¸­ï¼Œåªè¦è¿›ç¨‹æ´»ç€ï¼Œå…¶å†…å­˜ä¸€ç›´å­˜åœ¨ã€‚</li>
</ol>
</div>
</details>
<h3 id="å¦‚ä½•è¯†åˆ«ç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#å¦‚ä½•è¯†åˆ«ç”Ÿå‘½å‘¨æœŸ">å¦‚ä½•è¯†åˆ«ç”Ÿå‘½å‘¨æœŸ</a></h3>
<h4 id="ä¸¤ä¸ªå°ä¾‹å­"><a class="header" href="#ä¸¤ä¸ªå°ä¾‹å­">ä¸¤ä¸ªå°ä¾‹å­</a></h4>
<details id="admonition-ä¸¤ä¸ªå°ä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>ä¸¤ä¸ªå°ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä¸¤ä¸ªå°ä¾‹å­"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/10%EF%BD%9C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9A%E4%BD%A0%E5%88%9B%E5%BB%BA%E7%9A%84%E5%80%BC%E7%A9%B6%E7%AB%9F%E8%83%BD%E6%B4%BB%E5%A4%9A%E4%B9%85%EF%BC%9F-4607802.jpg" alt="è¯†åˆ«ç”Ÿå‘½å‘¨æœŸçš„ä¸¤ä¸ªå°ä¾‹å­" /></p>
<ol>
<li>x å¼•ç”¨äº†åœ¨å†…å±‚ä½œç”¨åŸŸä¸­åˆ›å»ºå‡ºæ¥çš„å˜é‡ yã€‚ç”±äºï¼Œå˜é‡ä»å¼€å§‹å®šä¹‰åˆ°å…¶ä½œç”¨åŸŸç»“æŸçš„è¿™æ®µæ—¶é—´ï¼Œæ˜¯å®ƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥ x çš„ç”Ÿå‘½å‘¨æœŸ â€™a å¤§äº y çš„ç”Ÿå‘½å‘¨æœŸ â€™bï¼Œå½“ x å¼•ç”¨ y æ—¶ï¼Œç¼–è¯‘å™¨æŠ¥é”™ã€‚</li>
</ol>
<hr />
<ol start="2">
<li>y å’Œ x å¤„åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸‹ï¼Œ x å¼•ç”¨äº† yï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° x çš„ç”Ÿå‘½å‘¨æœŸ â€™a å’Œ y çš„ç”Ÿå‘½å‘¨æœŸ â€™b å‡ ä¹åŒæ—¶ç»“æŸï¼Œæˆ–è€…è¯´ â€™a å°äºç­‰äº â€™bï¼Œæ‰€ä»¥ï¼Œx å¼•ç”¨ y æ˜¯å¯è¡Œçš„ã€‚</li>
</ol>
</div>
</details>
<h4 id="éœ€è¦ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„æƒ…å†µ"><a class="header" href="#éœ€è¦ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„æƒ…å†µ">éœ€è¦ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„æƒ…å†µ</a></h4>
<details id="admonition-missing-lifetime-specifier" class="admonition info">
<summary class="admonition-title">
<p>missing lifetime specifier</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-missing-lifetime-specifier"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let s1 = String::from(&quot;Lindsey&quot;);
    let s2 = String::from(&quot;Rosie&quot;);

    let result = max(&amp;s1, &amp;s2);

    println!(&quot;bigger one: {}&quot;, result);

    let result = get_max(s1);
    println!(&quot;bigger one: {}&quot;, result);
}

fn get_max(s1: &amp;str) -&gt; &amp;str {
    // å­—ç¬¦ä¸²å­—é¢é‡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯é™æ€çš„ï¼Œè€Œ s1 æ˜¯åŠ¨æ€çš„ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸæ˜¾ç„¶ä¸ä¸€è‡´
    max(s1, &quot;Cynthia&quot;)
}

// è¿™æ®µä»£ç æ— æ³•ç¼–è¯‘é€šè¿‡
fn max(s1: &amp;str, s2: &amp;str) -&gt; &amp;str {
    if s1 &gt; s2 {
        s1
    } else {
        s2
    }
}
</code></pre></pre>
<ol>
<li>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ max() å‡½æ•°æ—¶ï¼Œæ— æ³•åˆ¤æ–­ s1ã€s2 å’Œè¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li>å‡½æ•°æœ¬èº«æºå¸¦çš„ä¿¡æ¯ï¼Œå°±æ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨çš„å…¨éƒ¨ä¿¡æ¯ã€‚</li>
<li>è¿™é‡Œå‡½æ•°æœ¬èº«æä¾›çš„ä¿¡æ¯å°±å‘Šè¯‰ç¼–è¯‘æœŸï¼Œç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´</li>
</ol>
</div>
</details>
<details id="admonition-æ·»åŠ ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨å³å¯ç¼–è¯‘é€šè¿‡" class="admonition info">
<summary class="admonition-title">
<p>æ·»åŠ ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨å³å¯ç¼–è¯‘é€šè¿‡</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-æ·»åŠ ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨å³å¯ç¼–è¯‘é€šè¿‡"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let s1 = String::from(&quot;Lindsey&quot;);
    let s2 = String::from(&quot;Rosie&quot;);

    let result = max(&amp;s1, &amp;s2);

    println!(&quot;bigger one: {}&quot;, result);

    let result = get_max(&amp;s1);
    println!(&quot;bigger one: {}&quot;, result);
}

fn get_max(s1: &amp;str) -&gt; &amp;str {
    max(s1, &quot;Cynthia&quot;)
}

fn max&lt;'a&gt;(s1: &amp;'a str, s2: &amp;'a str) -&gt; &amp;'a str {
    if s1 &gt; s2 {
        s1
    } else {
        s2
    }
}
</code></pre></pre>
</div>
</details>
<h4 id="ç¼–è¯‘å™¨å…¶å®ä¼šè‡ªåŠ¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸæ ‡æ³¨"><a class="header" href="#ç¼–è¯‘å™¨å…¶å®ä¼šè‡ªåŠ¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸæ ‡æ³¨">ç¼–è¯‘å™¨å…¶å®ä¼šè‡ªåŠ¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸæ ‡æ³¨</a></h4>
<blockquote>
<p>ç¼–è¯‘å™¨å¸Œæœ›å°½å¯èƒ½å‡è½»å¼€å‘è€…çš„è´Ÿæ‹…ï¼Œå…¶å®æ‰€æœ‰ä½¿ç”¨äº†å¼•ç”¨çš„å‡½æ•°ï¼Œéƒ½éœ€è¦ç”Ÿå‘½å‘¨æœŸçš„æ ‡æ³¨ï¼Œåªä¸è¿‡ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åšè¿™ä»¶äº‹ï¼Œçœå´äº†å¼€å‘è€…çš„éº»çƒ¦</p>
</blockquote>
<details id="admonition-ç¼–è¯‘å™¨è‡ªåŠ¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸæ ‡æ³¨" class="admonition info">
<summary class="admonition-title">
<p>ç¼–è¯‘å™¨è‡ªåŠ¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸæ ‡æ³¨</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ç¼–è¯‘å™¨è‡ªåŠ¨è¿›è¡Œç”Ÿå‘½å‘¨æœŸæ ‡æ³¨"></a></p>
</summary>
<div>
<ol>
<li>æ— æ ‡æ³¨ç‰ˆæœ¬</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let s1 = &quot;Hello world&quot;;

    println!(&quot;first word of s1: {}&quot;, first(s1));
}

// å¦‚æœä½ ç”¨ clippyï¼Œå¤šä½™çš„ lifetime ä¼šæé†’ä½ ä¸éœ€è¦
// fn first&lt;'a&gt;(s: &amp;'a str) -&gt; &amp;'a str {
fn first(s: &amp;str) -&gt; &amp;str {
    let trimmed = s.trim();
    match trimmed.find(' ') {
        None =&gt; &quot;&quot;,
        Some(pos) =&gt; &amp;trimmed[..pos],
    }
}
</code></pre></pre>
<hr />
<ol start="2">
<li>è‡ªåŠ¨æ ‡æ³¨</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let s1 = &quot;Lindsey&quot;;
    let s2 = String::from(&quot;Rosie&quot;);

    let result = max(s1, &amp;s2);

    println!(&quot;bigger one: {}&quot;, result);
}

fn max&lt;'a&gt;(s1: &amp;'a str, s2: &amp;'a str) -&gt; &amp;'a str {
    if s1 &gt; s2 {
        s1
    } else {
        s2
    }
}
</code></pre></pre>
<blockquote>
<p>è¿”å›å€¼å¦‚ä½•æ ‡æ³¨ï¼Ÿæ˜¯ â€™a è¿˜æ˜¯â€™b å‘¢ï¼Ÿè¿™é‡Œçš„å†²çªï¼Œç¼–è¯‘å™¨æ— èƒ½ä¸ºåŠ›ã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-è‡ªåŠ¨æ ‡æ³¨è§„åˆ™" class="admonition info">
<summary class="admonition-title">
<p>è‡ªåŠ¨æ ‡æ³¨è§„åˆ™</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-è‡ªåŠ¨æ ‡æ³¨è§„åˆ™"></a></p>
</summary>
<div>
<ol>
<li>æ‰€æœ‰å¼•ç”¨ç±»å‹çš„å‚æ•°éƒ½æœ‰ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸ â€™a ã€â€™b ç­‰ã€‚</li>
<li>å¦‚æœåªæœ‰ä¸€ä¸ªå¼•ç”¨å‹è¾“å…¥ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¼šèµ‹ç»™æ‰€æœ‰è¾“å‡ºã€‚</li>
<li>å¦‚æœæœ‰å¤šä¸ªå¼•ç”¨ç±»å‹çš„å‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ selfï¼Œé‚£ä¹ˆå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¼šèµ‹ç»™æ‰€æœ‰è¾“å‡ºã€‚</li>
</ol>
</div>
</details>
<h4 id="ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ç»ƒä¹ "><a class="header" href="#ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ç»ƒä¹ ">ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ç»ƒä¹ </a></h4>
<details id="admonition-æ ‡æ³¨ç»ƒä¹ é¢˜" class="admonition info">
<summary class="admonition-title">
<p>æ ‡æ³¨ç»ƒä¹ é¢˜</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-æ ‡æ³¨ç»ƒä¹ é¢˜"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn strtok(s: &amp;mut &amp;str, delimiter: char) -&gt; &amp;str {
    if let Some(i) = s.find(delimiter) {
        let prefix = &amp;s[..i];
        // ç”±äº delimiter å¯ä»¥æ˜¯ utf8ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è·å¾—å…¶ utf8 é•¿åº¦ï¼Œ
        // ç›´æ¥ä½¿ç”¨ len è¿”å›çš„æ˜¯å­—èŠ‚é•¿åº¦ï¼Œä¼šæœ‰é—®é¢˜
        let suffix = &amp;s[(i + delimiter.len_utf8())..];
        *s = suffix;
        prefix
    } else { // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›æ•´ä¸ªå­—ç¬¦ä¸²ï¼ŒæŠŠåŸå­—ç¬¦ä¸²æŒ‡é’ˆ s æŒ‡å‘ç©ºä¸²
        let prefix = *s;
        *s = &quot;&quot;;
        prefix
    }
}

fn main() {
    let s = &quot;hello world&quot;.to_owned();
    let mut s1 = s.as_str();
    let hello = strtok(&amp;mut s1, ' ');
    println!(&quot;hello is: {}, s1: {}, s: {}&quot;, hello, s1, s);
}
</code></pre></pre>
<ol>
<li>æŒ‰ç…§ç¼–è¯‘å™¨çš„è§„åˆ™ï¼Œ &amp;mut &amp;str æ·»åŠ ç”Ÿå‘½å‘¨æœŸåå˜æˆ &amp;â€™b mut &amp;â€™a str</li>
<li>è¿™å°†å¯¼è‡´è¿”å›çš„ â€™&amp;str æ— æ³•é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ol>
</div>
</details>
<details id="admonition-æ ‡æ³¨ç»ƒä¹ é¢˜å‚è€ƒ" class="admonition info">
<summary class="admonition-title">
<p>æ ‡æ³¨ç»ƒä¹ é¢˜å‚è€ƒ</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-æ ‡æ³¨ç»ƒä¹ é¢˜å‚è€ƒ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">pub fn strtok&lt;'a&gt;(s: &amp;mut &amp;'a str, delimiter: char) -&gt; &amp;'a str {
    if let Some(i) = s.find(delimiter) {
        let prefix = &amp;s[..i];
        let suffix = &amp;s[(i + delimiter.len_utf8())..];
        *s = suffix;
        prefix
    } else {
        let prefix = *s;
        *s = &quot;&quot;;
        prefix
    }
}

fn main() {
    let s = &quot;hello world&quot;.to_owned();
    let mut s1 = s.as_str();
    let hello = strtok(&amp;mut s1, ' ');
    println!(&quot;hello is: {}, s1: {}, s: {}&quot;, hello, s1, s);
}
</code></pre></pre>
<hr />
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/10%EF%BD%9C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9A%E4%BD%A0%E5%88%9B%E5%BB%BA%E7%9A%84%E5%80%BC%E7%A9%B6%E7%AB%9F%E8%83%BD%E6%B4%BB%E5%A4%9A%E4%B9%85%EF%BC%9F-4609161.jpg" alt="æ ‡æ³¨ç»ƒä¹ ç¤ºæ„å›¾" /></p>
</div>
</details>
<h4 id="ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„ç›®çš„"><a class="header" href="#ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„ç›®çš„">ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„ç›®çš„</a></h4>
<details id="admonition-ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„ç›®çš„æ˜¯åœ¨å‚æ•°å’Œè¿”å›å€¼ä¹‹é—´å»ºç«‹è”ç³»æˆ–è€…çº¦æŸ" class="admonition info">
<summary class="admonition-title">
<p>ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„ç›®çš„æ˜¯ï¼Œåœ¨å‚æ•°å’Œè¿”å›å€¼ä¹‹é—´å»ºç«‹è”ç³»æˆ–è€…çº¦æŸ</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„ç›®çš„æ˜¯åœ¨å‚æ•°å’Œè¿”å›å€¼ä¹‹é—´å»ºç«‹è”ç³»æˆ–è€…çº¦æŸ"></a></p>
</summary>
<div>
<p>ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨çš„ç›®çš„æ˜¯ï¼Œåœ¨å‚æ•°å’Œè¿”å›å€¼ä¹‹é—´å»ºç«‹è”ç³»æˆ–è€…çº¦æŸ:</p>
<ol>
<li>è°ƒç”¨å‡½æ•°æ—¶ï¼Œä¼ å…¥çš„å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸéœ€è¦å¤§äºç­‰äºæ ‡æ³¨çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li>å½“æ¯ä¸ªå‡½æ•°éƒ½æ·»åŠ å¥½ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨åï¼Œç¼–è¯‘å™¨ï¼Œå°±å¯ä»¥ä»å‡½æ•°è°ƒç”¨çš„ä¸Šä¸‹æ–‡ä¸­åˆ†æå‡ºï¼Œåœ¨ä¼ å‚æ—¶ï¼Œå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯å¦å’Œå‡½æ•°ç­¾åä¸­è¦æ±‚çš„ç”Ÿå‘½å‘¨æœŸåŒ¹é…ã€‚</li>
<li>å¦‚æœä¸åŒ¹é…ï¼Œå°±è¿èƒŒäº†â€œå¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½è¶…å‡ºå€¼çš„ç”Ÿå‘½å‘¨æœŸâ€ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™ã€‚</li>
</ol>
</div>
</details>
<h2 id="ä¸‰èä¼šè´¯é€šä»åˆ›å»ºåˆ°æ¶ˆäº¡"><a class="header" href="#ä¸‰èä¼šè´¯é€šä»åˆ›å»ºåˆ°æ¶ˆäº¡">ä¸‰ã€èä¼šè´¯é€šï¼Œä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></h2>
<h2 id="åˆ›å»º"><a class="header" href="#åˆ›å»º">åˆ›å»º</a></h2>
<h3 id="å †å†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘å±•å²"><a class="header" href="#å †å†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘å±•å²">å †å†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘å±•å²</a></h3>
<details id="admonition-å †å†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘å±•å²" class="admonition info">
<summary class="admonition-title">
<p>å †å†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘å±•å²</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å †å†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘å±•å²"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F.jpg" alt="å †å†…å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘å±•å²" /></p>
</div>
</details>
<details id="admonition-å †å†…å­˜ç®¡ç†éœ€æ±‚åŠ¨æ€å¤§å°-or-ç”Ÿå‘½å‘¨æœŸ" class="admonition info">
<summary class="admonition-title">
<p>å †å†…å­˜ç®¡ç†éœ€æ±‚ï¼šåŠ¨æ€å¤§å° or ç”Ÿå‘½å‘¨æœŸ</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å †å†…å­˜ç®¡ç†éœ€æ±‚åŠ¨æ€å¤§å°-or-ç”Ÿå‘½å‘¨æœŸ"></a></p>
</summary>
<div>
<p>Rust çš„åˆ›é€ è€…ä»¬ï¼Œé‡æ–°å®¡è§†äº†å †å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸï¼Œå‘ç°:</p>
<ul>
<li>å¤§éƒ¨åˆ†å †å†…å­˜çš„éœ€æ±‚åœ¨äºåŠ¨æ€å¤§å°</li>
<li>å°éƒ¨åˆ†éœ€æ±‚æ˜¯æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ul>
<blockquote>
<p>æ‰€ä»¥å®ƒé»˜è®¤å°†å †å†…å­˜çš„ç”Ÿå‘½å‘¨æœŸå’Œä½¿ç”¨å®ƒçš„æ ˆå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸç»‘åœ¨ä¸€èµ·ï¼Œå¹¶ç•™äº†ä¸ªå°å£å­ leaked æœºåˆ¶ï¼Œè®©å †å†…å­˜åœ¨éœ€è¦çš„æ—¶å€™ï¼Œå¯ä»¥æœ‰è¶…å‡ºå¸§å­˜æ´»æœŸçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
</blockquote>
<hr />
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4639705.jpg" alt="Rustä¸å…¶ä»–ç¼–ç¨‹è¯­è¨€å †å†…å­˜ç®¡ç†å¯¹æ¯”" /></p>
</div>
</details>
<h3 id="structenumvecstringåˆ›å»ºæ—¶çš„å†…å­˜å¸ƒå±€"><a class="header" href="#structenumvecstringåˆ›å»ºæ—¶çš„å†…å­˜å¸ƒå±€">struct/enum/vec/Stringåˆ›å»ºæ—¶çš„å†…å­˜å¸ƒå±€</a></h3>
<h4 id="struct"><a class="header" href="#struct">struct</a></h4>
<details id="admonition-å†…å­˜å¸ƒå±€ä¼˜åŒ–ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>å†…å­˜å¸ƒå±€ä¼˜åŒ–ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å†…å­˜å¸ƒå±€ä¼˜åŒ–ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4639867.jpg" alt="å†…å­˜å¸ƒå±€ä¼˜åŒ–ç¤ºæ„å›¾" /></p>
</div>
</details>
<details id="admonition-cè¯­è¨€æ‰‹åŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€" class="admonition info">
<summary class="admonition-title">
<p>cè¯­è¨€æ‰‹åŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-cè¯­è¨€æ‰‹åŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4639905.jpg" alt="cè¯­è¨€æ‰‹åŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€" /></p>
</div>
</details>
<details id="admonition-cè¯­è¨€æ‰‹åŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€ä¸rustè‡ªåŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€å¯¹æ¯”" class="admonition info">
<summary class="admonition-title">
<p>cè¯­è¨€æ‰‹åŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€ä¸rustè‡ªåŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€å¯¹æ¯”</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-cè¯­è¨€æ‰‹åŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€ä¸rustè‡ªåŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€å¯¹æ¯”"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4639936.jpg" alt="cè¯­è¨€æ‰‹åŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€ä¸rustè‡ªåŠ¨ä¼˜åŒ–å†…å­˜å¸ƒå±€å¯¹æ¯”" /></p>
</div>
</details>
<details id="admonition-ä»£ç å¯¹æ¯”rustå’Œclangçš„å†…å­˜å¸ƒå±€ä¼˜åŒ–" class="admonition info">
<summary class="admonition-title">
<p>ä»£ç å¯¹æ¯”rustå’Œclangçš„å†…å­˜å¸ƒå±€ä¼˜åŒ–</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ä»£ç å¯¹æ¯”rustå’Œclangçš„å†…å­˜å¸ƒå±€ä¼˜åŒ–"></a></p>
</summary>
<div>
<pre><code class="language-c">#include &lt;stdio.h&gt;

struct S1 {
    u_int8_t a;
    u_int16_t b;
    u_int8_t c;
};

struct S2 {
    u_int8_t a;
    u_int8_t c;
    u_int16_t b;
};

void main() {
    printf(&quot;size of S1: %d, S2: %d&quot;, sizeof(struct S1), sizeof(struct S2));
}
</code></pre>
<hr />
<pre><pre class="playground"><code class="language-rust  editable">use std::mem::{align_of, size_of};

#[allow(dead_code)]
struct S1 {
    a: u8,
    b: u16,
    c: u8,
}

#[allow(dead_code)]
struct S2 {
    a: u8,
    c: u8,
    b: u16,
}

fn main() {
    println!(&quot;sizeof S1: {}, S2: {}&quot;, size_of::&lt;S1&gt;(), size_of::&lt;S2&gt;());
    println!(&quot;alignof S1: {}, S2: {}&quot;, align_of::&lt;S1&gt;(), align_of::&lt;S2&gt;());
}
</code></pre></pre>
</div>
</details>
<h4 id="enum"><a class="header" href="#enum">enum</a></h4>
<details id="admonition-enumoptionresultå†…å­˜å¸ƒå±€å¯¹æ¯”" class="admonition info">
<summary class="admonition-title">
<p>enum/Option<T>/Result&lt;T,E&gt;å†…å­˜å¸ƒå±€å¯¹æ¯”</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-enumoptionresultå†…å­˜å¸ƒå±€å¯¹æ¯”"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4640218.jpg" alt="enum/Option&lt;T&gt;/Result&lt;T,E&gt;å†…å­˜å¸ƒå±€å¯¹æ¯”" /></p>
</div>
</details>
<details id="admonition-rust-ç¼–è¯‘å™¨ä¼šå¯¹-enum-åšä¸€äº›é¢å¤–çš„ä¼˜åŒ–è®©æŸäº›å¸¸ç”¨ç»“æ„çš„å†…å­˜å¸ƒå±€æ›´ç´§å‡‘" class="admonition info">
<summary class="admonition-title">
<p>Rust ç¼–è¯‘å™¨ä¼šå¯¹ enum åšä¸€äº›é¢å¤–çš„ä¼˜åŒ–ï¼Œè®©æŸäº›å¸¸ç”¨ç»“æ„çš„å†…å­˜å¸ƒå±€æ›´ç´§å‡‘ã€‚</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-rust-ç¼–è¯‘å™¨ä¼šå¯¹-enum-åšä¸€äº›é¢å¤–çš„ä¼˜åŒ–è®©æŸäº›å¸¸ç”¨ç»“æ„çš„å†…å­˜å¸ƒå±€æ›´ç´§å‡‘"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::collections::HashMap;
use std::mem::size_of;

#[allow(dead_code)]
enum E {
    A(f64),
    B(HashMap&lt;String, String&gt;),
    C(Result&lt;Vec&lt;u8&gt;, String&gt;),
}

macro_rules! show_size {
    (header) =&gt; {
        println!(
            &quot;{:&lt;24} {:&gt;4}    {}    {}&quot;,
            &quot;Type&quot;, &quot;T&quot;, &quot;Option&lt;T&gt;&quot;, &quot;Result&lt;T, io::Error&gt;&quot;
        );
        println!(&quot;{}&quot;, &quot;-&quot;.repeat(64));
    };
    ($t:ty) =&gt; {
        println!(
            &quot;{:&lt;24} {:4} {:8} {:12}&quot;,
            stringify!($t),
            size_of::&lt;$t&gt;(),
            size_of::&lt;Option&lt;$t&gt;&gt;(),
            size_of::&lt;Result&lt;$t, std::io::Error&gt;&gt;(),
        )
    };
}

fn main() {
    show_size!(header);
    show_size!(u8);
    show_size!(f64);
    show_size!(&amp;u8);
    show_size!(Box&lt;u8&gt;);
    show_size!(&amp;[u8]);

    show_size!(String);
    show_size!(Vec&lt;u8&gt;);
    show_size!(HashMap&lt;String, String&gt;);
    show_size!(E);
}
</code></pre></pre>
<hr />
<blockquote>
<p>ä½ ä¼šå‘ç°ï¼ŒOption é…åˆå¸¦æœ‰å¼•ç”¨ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ &amp;u8ã€Boxã€Vecã€HashMap ï¼Œæ²¡æœ‰é¢å¤–å ç”¨ç©ºé—´ï¼Œè¿™å°±å¾ˆæœ‰æ„æ€äº†</p>
</blockquote>
<pre><code class="language-shell">
Type                        T    Option&lt;T&gt;    Result&lt;T, io::Error&gt;
----------------------------------------------------------------
u8                          1        2           24
f64                         8       16           24
&amp;u8                         8        8           24
Box&lt;u8&gt;                     8        8           24
&amp;[u8]                      16       16           24
String                     24       24           32
Vec&lt;u8&gt;                    24       24           32
HashMap&lt;String, String&gt;    48       48           56
E                          56       56           64
</code></pre>
<hr />
<p>Rust æ˜¯è¿™ä¹ˆå¤„ç†çš„:</p>
<ol>
<li>æˆ‘ä»¬çŸ¥é“ï¼Œå¼•ç”¨ç±»å‹çš„ç¬¬ä¸€ä¸ªåŸŸæ˜¯ä¸ªæŒ‡é’ˆï¼Œè€ŒæŒ‡é’ˆæ˜¯ä¸å¯èƒ½ç­‰äº 0 çš„ï¼Œ</li>
<li>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¤ç”¨è¿™ä¸ªæŒ‡é’ˆï¼šå½“å…¶ä¸º 0 æ—¶ï¼Œè¡¨ç¤º Noneï¼Œå¦åˆ™æ˜¯ Someï¼Œå‡å°‘äº†å†…å­˜å ç”¨ï¼Œè¿™æ˜¯ä¸ªéå¸¸å·§å¦™çš„ä¼˜åŒ–</li>
</ol>
</div>
</details>
<h4 id="vecå’Œstring"><a class="header" href="#vecå’Œstring">vec<T>å’ŒString</a></h4>
<details id="admonition-stringå…¶å®å°±æ˜¯vec" class="admonition info">
<summary class="admonition-title">
<p>Stringå…¶å®å°±æ˜¯Vec<u8></p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-stringå…¶å®å°±æ˜¯vec"></a></p>
</summary>
<div>
<p>String å’Œ Vec å ç”¨ç›¸åŒçš„å¤§å°ï¼Œéƒ½æ˜¯ 24 ä¸ªå­—èŠ‚ã€‚å…¶å®ï¼Œå¦‚æœä½ æ‰“å¼€ String ç»“æ„çš„<a href="https://doc.rust-lang.org/src/alloc/string.rs.html#279-281">æºç </a>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒå†…éƒ¨å°±æ˜¯ä¸€ä¸ª Vec</p>
</div>
</details>
<details id="admonition-vec-ç»“æ„æ˜¯-3-ä¸ª-word-çš„èƒ–æŒ‡é’ˆ" class="admonition info">
<summary class="admonition-title">
<p>Vec ç»“æ„æ˜¯ 3 ä¸ª word çš„èƒ–æŒ‡é’ˆ</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-vec-ç»“æ„æ˜¯-3-ä¸ª-word-çš„èƒ–æŒ‡é’ˆ"></a></p>
</summary>
<div>
<h2 id=""><a class="header" href="#"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4640654.jpg" alt="vecå°±æ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆ" /></a></h2>
<p>åŒ…å«ï¼š</p>
<ol>
<li>ä¸€ä¸ªæŒ‡å‘å †å†…å­˜çš„æŒ‡é’ˆ pointer</li>
<li>åˆ†é…çš„å †å†…å­˜çš„å®¹é‡ capacity</li>
<li>ä»¥åŠæ•°æ®åœ¨å †å†…å­˜çš„é•¿åº¦ length</li>
</ol>
</div>
</details>
<h4 id="å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€"><a class="header" href="#å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€">å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€</a></h4>
<details id="admonition-å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€" class="admonition info">
<summary class="admonition-title">
<p>å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F.png" alt="å¼•ç”¨ç±»å‹çš„å†…å­˜å¸ƒå±€" /></p>
</div>
</details>
<h3 id="æ›´å¤šå¯è§cheatsrs"><a class="header" href="#æ›´å¤šå¯è§cheatsrs">æ›´å¤šå¯è§cheats.rs</a></h3>
<ul>
<li><a href="https://cheats.rs/#data-layout">Rust Language Cheat Sheet</a></li>
</ul>
<h2 id="ä½¿ç”¨-1"><a class="header" href="#ä½¿ç”¨-1">ä½¿ç”¨</a></h2>
<h3 id="copyå’Œmove"><a class="header" href="#copyå’Œmove">copyå’Œmove</a></h3>
<details id="admonition-copyå’Œmoveçš„å†…éƒ¨å®ç°éƒ½åªæ˜¯æµ…å±‚æŒ‰ä½åšå†…å­˜å¤åˆ¶" class="admonition info">
<summary class="admonition-title">
<p>copyå’Œmoveçš„å†…éƒ¨å®ç°éƒ½åªæ˜¯æµ…å±‚æŒ‰ä½åšå†…å­˜å¤åˆ¶</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-copyå’Œmoveçš„å†…éƒ¨å®ç°éƒ½åªæ˜¯æµ…å±‚æŒ‰ä½åšå†…å­˜å¤åˆ¶"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4640936.jpg" alt="copyå’Œmoveçš„å†…éƒ¨å®ç°éƒ½åªæ˜¯æµ…å±‚æŒ‰ä½åšå†…å­˜å¤åˆ¶" /></p>
</div>
</details>
<h2 id="é”€æ¯"><a class="header" href="#é”€æ¯">é”€æ¯</a></h2>
<h3 id="dropé‡Šæ”¾å †å†…å­˜"><a class="header" href="#dropé‡Šæ”¾å †å†…å­˜">dropé‡Šæ”¾å †å†…å­˜</a></h3>
<details id="admonition-å½“ä¸€ä¸ªå€¼è¢«é‡Šæ”¾å…¶å®å°±æ˜¯è°ƒç”¨å®ƒçš„dropæ–¹æ³•" class="admonition info">
<summary class="admonition-title">
<p>å½“ä¸€ä¸ªå€¼è¢«é‡Šæ”¾ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨å®ƒçš„dropæ–¹æ³•</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å½“ä¸€ä¸ªå€¼è¢«é‡Šæ”¾å…¶å®å°±æ˜¯è°ƒç”¨å®ƒçš„dropæ–¹æ³•"></a></p>
</summary>
<div>
<h2 id="-1"><a class="header" href="#-1"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4641072.jpg" alt="å½“ä¸€ä¸ªå€¼è¢«é‡Šæ”¾ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨å®ƒçš„dropæ–¹æ³•" /></a></h2>
<ol>
<li>å˜é‡ greeting æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨é€€å‡ºä½œç”¨åŸŸæ—¶ï¼Œå…¶ drop() å‡½æ•°è¢«è‡ªåŠ¨è°ƒç”¨</li>
<li>é‡Šæ”¾å †ä¸ŠåŒ…å« â€œhello worldâ€ çš„å†…å­˜</li>
<li>ç„¶åå†é‡Šæ”¾æ ˆä¸Šçš„å†…å­˜</li>
</ol>
</div>
</details>
<details id="admonition-å¤æ‚ç»“æ„é€’å½’è°ƒç”¨drop" class="admonition info">
<summary class="admonition-title">
<p>å¤æ‚ç»“æ„é€’å½’è°ƒç”¨drop</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-å¤æ‚ç»“æ„é€’å½’è°ƒç”¨drop"></a></p>
</summary>
<div>
<h2 id="-2"><a class="header" href="#-2"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4641173.jpg" alt="å¤æ‚ç»“æ„é€’å½’è°ƒç”¨drop" /></a></h2>
<blockquote>
<p>å¦‚æœè¦é‡Šæ”¾çš„å€¼æ˜¯ä¸€ä¸ªå¤æ‚çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ä¸€ä¸ªç»“æ„ä½“ï¼Œé‚£ä¹ˆ:</p>
</blockquote>
<ol>
<li>è¿™ä¸ªç»“æ„ä½“åœ¨è°ƒç”¨ drop() æ—¶ï¼Œä¼šä¾æ¬¡è°ƒç”¨æ¯ä¸€ä¸ªåŸŸçš„ drop() å‡½æ•°</li>
<li>å¦‚æœåŸŸåˆæ˜¯ä¸€ä¸ªå¤æ‚çš„ç»“æ„æˆ–è€…é›†åˆç±»å‹ï¼Œå°±ä¼šé€’å½’ä¸‹å»</li>
<li>ç›´åˆ°æ¯ä¸€ä¸ªåŸŸéƒ½é‡Šæ”¾å¹²å‡€ã€‚</li>
</ol>
<hr />
<ul>
<li>student å˜é‡æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæœ‰ nameã€ageã€scoresã€‚</li>
<li>å…¶ä¸­ name æ˜¯ Stringï¼Œscores æ˜¯ HashMapï¼Œå®ƒä»¬æœ¬èº«éœ€è¦é¢å¤– drop()ã€‚</li>
<li>åˆå› ä¸º HashMap çš„ key æ˜¯ Stringï¼Œæ‰€ä»¥è¿˜éœ€è¦è¿›ä¸€æ­¥è°ƒç”¨è¿™äº› key çš„ drop()ã€‚</li>
</ul>
<blockquote>
<p>æ•´ä¸ªé‡Šæ”¾é¡ºåºä»å†…åˆ°å¤–æ˜¯ï¼šå…ˆé‡Šæ”¾ HashMap ä¸‹çš„ keyï¼Œç„¶åé‡Šæ”¾ HashMap å †ä¸Šçš„è¡¨ç»“æ„ï¼Œæœ€åé‡Šæ”¾æ ˆä¸Šçš„å†…å­˜</p>
</blockquote>
</div>
</details>
<h3 id="raiié‡Šæ”¾å…¶ä»–èµ„æº"><a class="header" href="#raiié‡Šæ”¾å…¶ä»–èµ„æº">RAIIé‡Šæ”¾å…¶ä»–èµ„æº</a></h3>
<details id="admonition-ruståŸºäºraiié‡Šæ”¾æ–‡ä»¶èµ„æº" class="admonition info">
<summary class="admonition-title">
<p>RuståŸºäºRAIIé‡Šæ”¾æ–‡ä»¶èµ„æº</p>
<p><a class="admonition-anchor-link" href="1_stack_heap_ownership_lifetime_memory.html#admonition-ruståŸºäºraiié‡Šæ”¾æ–‡ä»¶èµ„æº"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::fs::File;
use std::io::prelude::*;
fn main() -&gt; std::io::Result&lt;()&gt; {
    let mut file = File::create(&quot;foo.txt&quot;)?;
    file.write_all(b&quot;Hello, world!&quot;)?;
    Ok(())
}
</code></pre></pre>
</div>
</details>
<h3 id="ruståœ¨ç¼–è¯‘æ—¶è¿è¡Œæ—¶æ£€æŸ¥è°ƒç”¨drop"><a class="header" href="#ruståœ¨ç¼–è¯‘æ—¶è¿è¡Œæ—¶æ£€æŸ¥è°ƒç”¨drop">Ruståœ¨ç¼–è¯‘æ—¶ã€è¿è¡Œæ—¶æ£€æŸ¥è°ƒç”¨drop</a></h3>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/11%EF%BD%9C%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%9A%E4%BB%8E%E5%88%9B%E5%BB%BA%E5%88%B0%E6%B6%88%E4%BA%A1%EF%BC%8C%E5%80%BC%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F-4641604.jpg" alt="Ruståœ¨ç¼–è¯‘æ—¶ã€è¿è¡Œæ—¶æ£€æŸ¥è°ƒç”¨drop" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ii-ç±»å‹ç³»ç»Ÿ"><a class="header" href="#ii-ç±»å‹ç³»ç»Ÿ">II. ç±»å‹ç³»ç»Ÿ</a></h1>
<!--ts-->
<ul>
<li><a href="2_type_system.html#ii-%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F">II. ç±»å‹ç³»ç»Ÿ</a>
<ul>
<li><a href="2_type_system.html#%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E5%88%86%E7%B1%BB%E5%9B%BE">ç±»å‹ç³»ç»Ÿåˆ†ç±»å›¾</a>
<ul>
<li><a href="2_type_system.html#%E4%B8%89%E4%B8%AA%E6%A0%87%E5%87%86">ä¸‰ä¸ªæ ‡å‡†</a></li>
<li><a href="2_type_system.html#rust%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E7%89%B9%E7%82%B9">Rustç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E7%B1%BB%E5%9E%8B%E5%88%86%E7%B1%BB">ç±»å‹åˆ†ç±»</a>
<ul>
<li><a href="2_type_system.html#%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%9E%8B">åŸç”Ÿç±»å‹</a></li>
<li><a href="2_type_system.html#%E7%BB%84%E5%90%88%E7%B1%BB%E5%9E%8B">ç»„åˆç±»å‹</a></li>
<li><a href="2_type_system.html#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E5%90%88%E7%B1%BB%E5%9E%8B">è‡ªå®šä¹‰ç»„åˆç±»å‹</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E5%B0%8F%E4%BE%8B%E5%AD%90">å°ä¾‹å­</a>
<ul>
<li><a href="2_type_system.html#%E5%B8%B8%E9%87%8F">å¸¸é‡</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E7%B1%BB%E5%9E%8B%E6%8E%A8%E5%AF%BC">ç±»å‹æ¨å¯¼</a></li>
<li><a href="2_type_system.html#turbofish">Turbofish</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E6%B3%9B%E5%9E%8B">æ³›å‹</a>
<ul>
<li><a href="2_type_system.html#%E6%B3%9B%E5%9E%8B%E5%B0%B1%E5%83%8F%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0">æ³›å‹å°±åƒå®šä¹‰å‡½æ•°</a></li>
<li><a href="2_type_system.html#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F">å®ç°æ–¹å¼</a></li>
<li><a href="2_type_system.html#%E6%B3%9B%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">æ³›å‹æ•°æ®ç»“æ„</a>
<ul>
<li><a href="2_type_system.html#%E9%80%90%E6%AD%A5%E7%BA%A6%E6%9D%9F%E6%8A%8A%E5%86%B3%E7%AD%96%E4%BA%A4%E7%BB%99%E4%BD%BF%E7%94%A8%E8%80%85">é€æ­¥çº¦æŸï¼šæŠŠå†³ç­–äº¤ç»™ä½¿ç”¨è€…</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E6%B3%9B%E5%9E%8B%E5%8F%82%E6%95%B0">æ³›å‹å‚æ•°</a>
<ul>
<li><a href="2_type_system.html#%E5%8F%82%E6%95%B0%E5%A4%9A%E6%80%81">å‚æ•°å¤šæ€</a></li>
<li><a href="2_type_system.html#%E4%B8%89%E7%A7%8D%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">ä¸‰ç§ä½¿ç”¨åœºæ™¯</a>
<ul>
<li><a href="2_type_system.html#%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A">å»¶è¿Ÿç»‘å®š</a></li>
<li><a href="2_type_system.html#%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A-1">å»¶è¿Ÿç»‘å®š</a></li>
<li><a href="2_type_system.html#%E5%A4%9A%E4%B8%AA%E5%AE%9E%E7%8E%B0">å¤šä¸ªå®ç°</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="2_type_system.html#%E6%B3%9B%E5%9E%8B%E5%87%BD%E6%95%B0">æ³›å‹å‡½æ•°</a>
<ul>
<li><a href="2_type_system.html#%E5%8D%95%E6%80%81%E5%8C%96">å•æ€åŒ–</a>
<ul>
<li><a href="2_type_system.html#%E4%BC%98%E5%8A%A3">ä¼˜åŠ£</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E8%BF%94%E5%9B%9E%E5%80%BC%E6%90%BA%E5%B8%A6%E6%B3%9B%E5%9E%8B%E5%8F%82%E6%95%B0">è¿”å›å€¼æºå¸¦æ³›å‹å‚æ•°</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="2_type_system.html#trait">Trait</a>
<ul>
<li><a href="2_type_system.html#%E5%9F%BA%E6%9C%AC%E7%BB%83%E4%B9%A0">åŸºæœ¬ç»ƒä¹ </a>
<ul>
<li><a href="2_type_system.html#self%E5%92%8Cself">Selfå’Œself</a></li>
<li><a href="2_type_system.html#%E9%80%92%E8%BF%9B%E7%BB%83%E4%B9%A0trait%E4%BD%BF%E7%94%A8">é€’è¿›ç»ƒä¹ traitä½¿ç”¨</a>
<ul>
<li><a href="2_type_system.html#%E5%9F%BA%E7%A1%80%E5%AE%9A%E4%B9%89trait">åŸºç¡€å®šä¹‰trait</a></li>
<li><a href="2_type_system.html#%E6%B7%BB%E5%8A%A0%E6%B3%9B%E5%9E%8B%E5%8F%82%E6%95%B0%E4%BD%9C%E4%B8%BA%E6%B3%9B%E5%9E%8B%E7%BA%A6%E6%9D%9F">æ·»åŠ æ³›å‹å‚æ•°ä½œä¸ºæ³›å‹çº¦æŸ</a></li>
<li><a href="2_type_system.html#%E4%BD%BF%E7%94%A8%E5%85%B3%E8%81%94%E7%B1%BB%E5%9E%8B%E6%B7%BB%E5%8A%A0resultt-e">ä½¿ç”¨å…³è”ç±»å‹+æ·»åŠ Result&lt;T, E&gt;</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E6%B3%9B%E5%9E%8B%E7%BA%A6%E6%9D%9F-%E6%94%AF%E6%8C%81%E6%B3%9B%E5%9E%8B%E7%9A%84trait">æ³›å‹çº¦æŸ: æ”¯æŒæ³›å‹çš„trait</a>
<ul>
<li><a href="2_type_system.html#%E6%80%9D%E8%80%83%E9%A2%98">æ€è€ƒé¢˜</a></li>
<li><a href="2_type_system.html#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">è§£å†³æ–¹æ¡ˆ</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E5%85%B3%E8%81%94%E7%B1%BB%E5%9E%8B">å…³è”ç±»å‹</a></li>
<li><a href="2_type_system.html#%E6%94%AF%E6%8C%81%E6%B3%9B%E5%9E%8B">æ”¯æŒæ³›å‹</a></li>
<li><a href="2_type_system.html#%E6%94%AF%E6%8C%81%E7%BB%A7%E6%89%BF">æ”¯æŒç»§æ‰¿</a></li>
<li><a href="2_type_system.html#%E6%8E%A5%E5%8F%A3%E6%8A%BD%E8%B1%A1-or-%E7%89%B9%E8%AE%BE%E5%A4%9A%E6%80%81">æ¥å£æŠ½è±¡ or ç‰¹è®¾å¤šæ€</a></li>
</ul>
</li>
<li><a href="2_type_system.html#trait-object">Trait Object</a>
<ul>
<li><a href="2_type_system.html#%E5%AD%90%E7%B1%BB%E5%9E%8B%E5%A4%9A%E6%80%81-%E5%8A%A8%E6%80%81%E5%88%86%E6%B4%BE">å­ç±»å‹å¤šæ€: åŠ¨æ€åˆ†æ´¾</a></li>
<li><a href="2_type_system.html#%E5%AE%9E%E7%8E%B0%E6%9C%BA%E7%90%86ptrvtable">å®ç°æœºç†ï¼šptr+vtable</a></li>
<li><a href="2_type_system.html#%E5%AF%B9%E8%B1%A1%E5%AE%89%E5%85%A8">å¯¹è±¡å®‰å…¨</a></li>
<li><a href="2_type_system.html#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">ä½¿ç”¨åœºæ™¯</a>
<ul>
<li><a href="2_type_system.html#%E5%9C%A8%E5%87%BD%E6%95%B0%E4%B8%AD%E4%BD%BF%E7%94%A8">åœ¨å‡½æ•°ä¸­ä½¿ç”¨</a></li>
<li><a href="2_type_system.html#%E5%9C%A8%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E4%B8%AD%E4%BD%BF%E7%94%A8">åœ¨å‡½æ•°è¿”å›å€¼ä¸­ä½¿ç”¨</a>
<ul>
<li><a href="2_type_system.html#%E5%9C%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%AD%E4%BD%BF%E7%94%A8">åœ¨æ•°æ®ç»“æ„ä¸­ä½¿ç”¨</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="2_type_system.html#%E5%AD%A4%E5%84%BF%E8%A7%84%E5%88%99">å­¤å„¿è§„åˆ™</a></li>
<li><a href="2_type_system.html#%E5%B8%B8%E7%94%A8trait">å¸¸ç”¨trait</a>
<ul>
<li><a href="2_type_system.html#%E5%86%85%E5%AD%98%E7%9B%B8%E5%85%B3">å†…å­˜ç›¸å…³</a>
<ul>
<li><a href="2_type_system.html#copy">Copy</a></li>
<li><a href="2_type_system.html#drop">Drop</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E6%A0%87%E7%AD%BEtrait">æ ‡ç­¾trait</a>
<ul>
<li><a href="2_type_system.html#sized">Sized</a></li>
<li><a href="2_type_system.html#sendsync">Send/Sync</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2">ç±»å‹è½¬æ¢</a>
<ul>
<li><a href="2_type_system.html#frominto-%E5%80%BC%E5%88%B0%E5%80%BC">From/Into: å€¼åˆ°å€¼</a></li>
<li><a href="2_type_system.html#tryfromtryinto-%E5%80%BC%E5%88%B0%E5%80%BC%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0%E9%94%99%E8%AF%AF">TryFrom/TryInto: å€¼åˆ°å€¼ï¼Œå¯èƒ½å‡ºç°é”™è¯¯</a></li>
<li><a href="2_type_system.html#asrefasmut-%E5%BC%95%E7%94%A8%E5%88%B0%E5%BC%95%E7%94%A8">AsRef/AsMut: å¼•ç”¨åˆ°å¼•ç”¨</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9B%B8%E5%85%B3-derefderefmut">æ“ä½œç¬¦ç›¸å…³: Deref/DerefMut</a></li>
<li><a href="2_type_system.html#%E5%85%B6%E4%BB%96debugdisplaydefault">å…¶ä»–ï¼šDebug/Display/Default</a></li>
</ul>
</li>
<li><a href="2_type_system.html#%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84">è®¾è®¡æ¶æ„</a>
<ul>
<li><a href="2_type_system.html#%E9%A1%BA%E6%89%8B%E8%87%AA%E7%84%B6">é¡ºæ‰‹è‡ªç„¶</a></li>
<li><a href="2_type_system.html#%E6%A1%A5%E6%8E%A5">æ¡¥æ¥</a></li>
<li><a href="2_type_system.html#%E6%8E%A7%E5%88%B6%E5%8F%8D%E8%BD%AC">æ§åˆ¶åè½¬</a></li>
<li><a href="2_type_system.html#solid%E5%8E%9F%E5%88%99">SOLIDåŸåˆ™</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:43:58 UTC 2022 -->
<!--te-->
<h2 id="ç±»å‹ç³»ç»Ÿåˆ†ç±»å›¾"><a class="header" href="#ç±»å‹ç³»ç»Ÿåˆ†ç±»å›¾">ç±»å‹ç³»ç»Ÿåˆ†ç±»å›¾</a></h2>
<div id="admonition-ç±»å‹ç³»ç»Ÿåˆ†ç±»å›¾" class="admonition info">
<div class="admonition-title">
<p>ç±»å‹ç³»ç»Ÿåˆ†ç±»å›¾</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ç±»å‹ç³»ç»Ÿåˆ†ç±»å›¾"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/12%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9ARust%E7%9A%84%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E6%9C%89%E4%BB%80%E4%B9%88%E7%89%B9%E7%82%B9%EF%BC%9F.jpg" alt="ç±»å‹ç³»ç»Ÿåˆ†ç±»å›¾" /></p>
</div>
</div>
<h3 id="ä¸‰ä¸ªæ ‡å‡†"><a class="header" href="#ä¸‰ä¸ªæ ‡å‡†">ä¸‰ä¸ªæ ‡å‡†</a></h3>
<ol>
<li>éšå¼è½¬æ¢</li>
<li>æ£€æŸ¥æ—¶æœº</li>
<li>å¤šæ€æ”¯æŒ</li>
</ol>
<h3 id="rustç±»å‹ç³»ç»Ÿç‰¹ç‚¹"><a class="header" href="#rustç±»å‹ç³»ç»Ÿç‰¹ç‚¹">Rustç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></h3>
<div id="admonition-rustçš„ç±»å‹ç³»ç»Ÿæœ‰ä»€ä¹ˆç‰¹ç‚¹" class="admonition info">
<div class="admonition-title">
<p>Rustçš„ç±»å‹ç³»ç»Ÿæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-rustçš„ç±»å‹ç³»ç»Ÿæœ‰ä»€ä¹ˆç‰¹ç‚¹"></a></p>
</div>
<div>
<h2 id="-3"><a class="header" href="#-3"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/12%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9ARust%E7%9A%84%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E6%9C%89%E4%BB%80%E4%B9%88%E7%89%B9%E7%82%B9%EF%BC%9F-4257735.jpg" alt="Rustçš„ç±»å‹ç³»ç»Ÿæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ" /></a></h2>
<p>å¼ºç±»å‹ + é™æ€ç±»å‹ + æ˜¾å¼ç±»å‹</p>
</div>
</div>
<h2 id="ç±»å‹åˆ†ç±»"><a class="header" href="#ç±»å‹åˆ†ç±»">ç±»å‹åˆ†ç±»</a></h2>
<h3 id="åŸç”Ÿç±»å‹"><a class="header" href="#åŸç”Ÿç±»å‹">åŸç”Ÿç±»å‹</a></h3>
<details id="admonition-ruståŸå£°ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>RuståŸå£°ç±»å‹</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ruståŸå£°ç±»å‹"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/12%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9ARust%E7%9A%84%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E6%9C%89%E4%BB%80%E4%B9%88%E7%89%B9%E7%82%B9%EF%BC%9F-4257523.jpg" alt="RuståŸç”Ÿç±»å‹" /></p>
</div>
</details>
<h3 id="ç»„åˆç±»å‹"><a class="header" href="#ç»„åˆç±»å‹">ç»„åˆç±»å‹</a></h3>
<details id="admonition-rustç»„åˆç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>Rustç»„åˆç±»å‹</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-rustç»„åˆç±»å‹"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/12%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9ARust%E7%9A%84%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E6%9C%89%E4%BB%80%E4%B9%88%E7%89%B9%E7%82%B9%EF%BC%9F-4257587.jpg" alt="Rustç»„åˆç±»å‹" /></p>
</div>
</details>
<h3 id="è‡ªå®šä¹‰ç»„åˆç±»å‹"><a class="header" href="#è‡ªå®šä¹‰ç»„åˆç±»å‹">è‡ªå®šä¹‰ç»„åˆç±»å‹</a></h3>
<h2 id="å°ä¾‹å­"><a class="header" href="#å°ä¾‹å­">å°ä¾‹å­</a></h2>
<h3 id="å¸¸é‡"><a class="header" href="#å¸¸é‡">å¸¸é‡</a></h3>
<details id="admonition-å¸¸é‡å®šä¹‰ä½¿ç”¨" class="admonition info">
<summary class="admonition-title">
<p>å¸¸é‡å®šä¹‰ä½¿ç”¨</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å¸¸é‡å®šä¹‰ä½¿ç”¨"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">const PI: f64 = std::f64::consts::PI;
static E: f32 = std::f32::consts::E;

fn main() {
    const V: u32 = 10;
    static V1: &amp;str = &quot;hello&quot;;
    println!(&quot;PI: {}, E: {}, V {}, V1: {}&quot;, PI, E, V, V1);
}
</code></pre></pre>
</div>
</details>
<h2 id="ç±»å‹æ¨å¯¼"><a class="header" href="#ç±»å‹æ¨å¯¼">ç±»å‹æ¨å¯¼</a></h2>
<details id="admonition-rustç¼–è¯‘å™¨å¯ä»¥ä»ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨å¯¼ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>Rustç¼–è¯‘å™¨å¯ä»¥ä»ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨å¯¼ç±»å‹</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-rustç¼–è¯‘å™¨å¯ä»¥ä»ä¸Šä¸‹æ–‡è‡ªåŠ¨æ¨å¯¼ç±»å‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::collections::BTreeMap;

fn main() {
    let mut map = BTreeMap::new();
    // æ²¡æœ‰è¿™ä¸€è¡Œå°±ç¼ºå°‘è‡ªåŠ¨æ¨å¯¼ä¿¡æ¯
    // map.insert(&quot;hello&quot;, &quot;world&quot;);
    println!(&quot;map: {:?}&quot;, map);
}
</code></pre></pre>
<hr />
<p>æŠŠç¬¬ 5 è¡Œè¿™ä¸ªä½œç”¨åŸŸå†…çš„ insert è¯­å¥æ³¨é‡Šå»æ‰ï¼ŒRust ç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™ï¼šâ€œcannot infer type for type parameter Kâ€ã€‚</p>
</div>
</details>
<details id="admonition-rustç¼–è¯‘å™¨ä¸èƒ½è·å–è¶³å¤Ÿä¸Šä¸‹æ–‡ä¿¡æ¯æ—¶å°±éœ€è¦æ˜ç¡®ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>Rustç¼–è¯‘å™¨ä¸èƒ½è·å–è¶³å¤Ÿä¸Šä¸‹æ–‡ä¿¡æ¯æ—¶ï¼Œå°±éœ€è¦æ˜ç¡®ç±»å‹</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-rustç¼–è¯‘å™¨ä¸èƒ½è·å–è¶³å¤Ÿä¸Šä¸‹æ–‡ä¿¡æ¯æ—¶å°±éœ€è¦æ˜ç¡®ç±»å‹"></a></p>
</summary>
<div>
<ol>
<li>æ— æ³•è‡ªåŠ¨æ¨å¯¼collectè¿”å›ä»€ä¹ˆç±»å‹</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let numbers = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

    let even_numbers = numbers
        .into_iter()
        .filter(|n| n % 2 == 0)
        .collect();

    println!(&quot;{:?}&quot;, even_numbers);
}
</code></pre></pre>
<hr />
<ol start="2">
<li>ç»™even_numbersæ·»åŠ ç±»å‹å£°æ˜å³å¯</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let numbers = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

    let even_numbers: Vec&lt;_&gt; = numbers
        .into_iter()
        .filter(|n| n % 2 == 0)
        .collect();

    println!(&quot;{:?}&quot;, even_numbers);
}
</code></pre></pre>
<blockquote>
<p>è¿™é‡Œç¼–è¯‘å™¨åªæ˜¯æ— æ³•æ¨æ–­å‡ºé›†åˆç±»å‹ï¼Œä½†é›†åˆç±»å‹å†…éƒ¨å…ƒç´ çš„ç±»å‹ï¼Œè¿˜æ˜¯å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡å¾—å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®€å†™æˆ Vec&lt;_&gt;</p>
</blockquote>
<ol start="3">
<li>ä¹Ÿå¯ä»¥è®© collect è¿”å›ä¸€ä¸ªæ˜ç¡®çš„ç±»å‹</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let numbers = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

    let even_numbers = numbers
        .into_iter()
        .filter(|n| n % 2 == 0)
        .collect::&lt;Vec&lt;_&gt;&gt;();

    println!(&quot;{:?}&quot;, even_numbers);
}
</code></pre></pre>
<hr />
<blockquote>
<p>è¿™é‡Œåœ¨æ³›å‹å‡½æ•°åä½¿ç”¨ :: æ¥å¼ºåˆ¶ä½¿ç”¨ç±»å‹ Tï¼Œè¿™ç§å†™æ³•è¢«ç§°ä¸º turbofish</p>
</blockquote>
</div>
</details>
<h2 id="turbofish"><a class="header" href="#turbofish">Turbofish</a></h2>
<details id="admonition-ä¸€ä¸ªå¯¹-ip-åœ°å€å’Œç«¯å£è½¬æ¢çš„ä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>ä¸€ä¸ªå¯¹ IP åœ°å€å’Œç«¯å£è½¬æ¢çš„ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ä¸€ä¸ªå¯¹-ip-åœ°å€å’Œç«¯å£è½¬æ¢çš„ä¾‹å­"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::net::SocketAddr;

fn main() {
    let addr = &quot;127.0.0.1:8080&quot;.parse::&lt;SocketAddr&gt;().unwrap();
    println!(&quot;addr: {:?}, port: {:?}&quot;, addr.ip(), addr.port());
}
</code></pre></pre>
</div>
</details>
<details id="admonition-å¦‚æœç±»å‹åœ¨ä¸Šä¸‹æ–‡æ— æ³•è¢«æ¨å¯¼å‡ºæ¥åˆæ²¡æœ‰-turbofish-çš„å†™æ³•æˆ‘ä»¬å°±ä¸å¾—ä¸å…ˆç»™ä¸€ä¸ªå±€éƒ¨å˜é‡èµ‹å€¼æ—¶å£°æ˜ç±»å‹ç„¶åå†è¿”å›è¿™æ ·ä»£ç å°±å˜å¾—å†—ä½™" class="admonition info">
<summary class="admonition-title">
<p>å¦‚æœç±»å‹åœ¨ä¸Šä¸‹æ–‡æ— æ³•è¢«æ¨å¯¼å‡ºæ¥ï¼Œåˆæ²¡æœ‰ turbofish çš„å†™æ³•ï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸å…ˆç»™ä¸€ä¸ªå±€éƒ¨å˜é‡èµ‹å€¼æ—¶å£°æ˜ç±»å‹ï¼Œç„¶åå†è¿”å›ï¼Œè¿™æ ·ä»£ç å°±å˜å¾—å†—ä½™</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å¦‚æœç±»å‹åœ¨ä¸Šä¸‹æ–‡æ— æ³•è¢«æ¨å¯¼å‡ºæ¥åˆæ²¡æœ‰-turbofish-çš„å†™æ³•æˆ‘ä»¬å°±ä¸å¾—ä¸å…ˆç»™ä¸€ä¸ªå±€éƒ¨å˜é‡èµ‹å€¼æ—¶å£°æ˜ç±»å‹ç„¶åå†è¿”å›è¿™æ ·ä»£ç å°±å˜å¾—å†—ä½™"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>match data {
    Some(s) =&gt; v.parse::&lt;User&gt;()?,
    _ =&gt; return Err(...),
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<h1 id="æ³›å‹"><a class="header" href="#æ³›å‹">æ³›å‹</a></h1>
<h2 id="æ³›å‹å°±åƒå®šä¹‰å‡½æ•°"><a class="header" href="#æ³›å‹å°±åƒå®šä¹‰å‡½æ•°">æ³›å‹å°±åƒå®šä¹‰å‡½æ•°</a></h2>
<ol>
<li>å‡½æ•°ï¼Œæ˜¯æŠŠé‡å¤ä»£ç ä¸­çš„å‚æ•°æŠ½å–å‡ºæ¥ï¼Œä½¿å…¶æ›´åŠ é€šç”¨ï¼Œè°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œæ ¹æ®å‚æ•°çš„ä¸åŒï¼Œæˆ‘ä»¬å¾—åˆ°ä¸åŒçš„ç»“æœï¼›</li>
<li>è€Œæ³›å‹ï¼Œæ˜¯æŠŠé‡å¤æ•°æ®ç»“æ„ä¸­çš„å‚æ•°æŠ½å–å‡ºæ¥ï¼Œåœ¨ä½¿ç”¨æ³›å‹ç±»å‹æ—¶ï¼Œæ ¹æ®ä¸åŒçš„å‚æ•°ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸åŒçš„å…·ä½“ç±»å‹ã€‚</li>
</ol>
<details id="admonition-æ³›å‹ç»“æ„vecä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>æ³›å‹ç»“æ„Vec<T>ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-æ³›å‹ç»“æ„vecä¾‹å­"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct Vec&lt;T, A: Allocator = Global&gt; {
    buf: RawVec&lt;T, A&gt;,
    len: usize,
}

pub struct RawVec&lt;T, A: Allocator = Global&gt; {
    ptr: Unique&lt;T&gt;,
    cap: usize,
    alloc: A,
}
</code></pre></pre>
<hr />
<p>Vecæœ‰ä¸¤ä¸ªå‚æ•°:</p>
<ol>
<li>ä¸€ä¸ªæ˜¯ Tï¼Œæ˜¯åˆ—è¡¨é‡Œçš„æ¯ä¸ªæ•°æ®çš„ç±»å‹</li>
<li>å¦ä¸€ä¸ªæ˜¯ Aï¼Œå®ƒæœ‰è¿›ä¸€æ­¥çš„é™åˆ¶ A: Allocator </li>
</ol>
<blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ A éœ€è¦æ»¡è¶³ Allocator traitã€‚
A è¿™ä¸ªå‚æ•°æœ‰é»˜è®¤å€¼ Globalï¼Œå®ƒæ˜¯ Rust é»˜è®¤çš„å…¨å±€åˆ†é…å™¨</p>
</blockquote>
<ol start="3">
<li>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Vec è™½ç„¶æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä½¿ç”¨æ—¶éƒ½åªéœ€è¦ç”¨ Tã€‚</li>
</ol>
</div>
</details>
<details id="admonition-æšä¸¾ç±»å‹cowä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>æšä¸¾ç±»å‹Cow<T>ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-æšä¸¾ç±»å‹cowä¾‹å­"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub enum Cow&lt;'a, B: ?Sized + 'a&gt; where B: ToOwned,
{
    // å€Ÿç”¨çš„æ•°æ®
    Borrowed(&amp;'a B),
    // æ‹¥æœ‰çš„æ•°æ®
    Owned(&lt;B as ToOwned&gt;::Owned),
}
</code></pre></pre>
<p>è¿™é‡Œå¯¹ B çš„ä¸‰ä¸ªçº¦æŸåˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>ç”Ÿå‘½å‘¨æœŸ â€™a</li>
<li>é•¿åº¦å¯å˜ ?Sized</li>
<li>ç¬¦åˆ ToOwned trait</li>
</ol>
</div>
</details>
<details id="admonition-cow" class="admonition info">
<summary class="admonition-title">
<p>Cow</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-cow"></a></p>
</summary>
<div>
<p>Cowï¼ˆClone-on-Writeï¼‰æ˜¯ Rust ä¸­ä¸€ä¸ªå¾ˆæœ‰æ„æ€ä¸”å¾ˆé‡è¦çš„æ•°æ®ç»“æ„ã€‚å®ƒå°±åƒ Option ä¸€æ ·ï¼Œåœ¨è¿”å›æ•°æ®çš„æ—¶å€™ï¼Œæä¾›äº†ä¸€ç§å¯èƒ½ï¼šè¦ä¹ˆè¿”å›ä¸€ä¸ªå€Ÿç”¨çš„æ•°æ®ï¼ˆåªè¯»ï¼‰ï¼Œè¦ä¹ˆè¿”å›ä¸€ä¸ªæ‹¥æœ‰æ‰€æœ‰æƒçš„æ•°æ®ï¼ˆå¯å†™ï¼‰ã€‚</p>
</div>
</details>
<details id="admonition-sizedä»£è¡¨å¯å˜å¤§å°" class="admonition info">
<summary class="admonition-title">
<p>?Sizedä»£è¡¨å¯å˜å¤§å°</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-sizedä»£è¡¨å¯å˜å¤§å°"></a></p>
</summary>
<div>
<p>?Sized æ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¦æŸå†™æ³•ï¼Œ? ä»£è¡¨å¯ä»¥æ”¾æ¾é—®å·ä¹‹åçš„çº¦æŸã€‚ç”±äº Rust é»˜è®¤çš„æ³›å‹å‚æ•°éƒ½éœ€è¦æ˜¯ Sizedï¼Œä¹Ÿå°±æ˜¯å›ºå®šå¤§å°çš„ç±»å‹ï¼Œæ‰€ä»¥è¿™é‡Œ ?Sized ä»£è¡¨ç”¨å¯å˜å¤§å°çš„ç±»å‹ã€‚</p>
</div>
</details>
<details id="admonition-toowned" class="admonition info">
<summary class="admonition-title">
<p>ToOwned</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-toowned"></a></p>
</summary>
<div>
<p><a href="https://doc.rust-lang.org/std/borrow/trait.ToOwned.html">ToOwned</a> æ˜¯ä¸€ä¸ª traitï¼Œå®ƒå¯ä»¥æŠŠå€Ÿç”¨çš„æ•°æ®å…‹éš†å‡ºä¸€ä¸ªæ‹¥æœ‰æ‰€æœ‰æƒçš„æ•°æ®ã€‚</p>
</div>
</details>
<details id="admonition-owned" class="admonition info">
<summary class="admonition-title">
<p><B as ToOwned>::Owned</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-owned"></a></p>
</summary>
<div>
<h2 id="å®ƒå¯¹-b-åšäº†ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢è½¬æˆ-toowned-traitç„¶åè®¿é—®-toowned-trait-å†…éƒ¨çš„-owned-ç±»å‹"><a class="header" href="#å®ƒå¯¹-b-åšäº†ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢è½¬æˆ-toowned-traitç„¶åè®¿é—®-toowned-trait-å†…éƒ¨çš„-owned-ç±»å‹">å®ƒå¯¹ B åšäº†ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè½¬æˆ ToOwned traitï¼Œç„¶åè®¿é—® ToOwned trait å†…éƒ¨çš„ Owned ç±»å‹</a></h2>
<p>å› ä¸ºåœ¨ Rust é‡Œï¼Œå­ç±»å‹å¯ä»¥å¼ºåˆ¶è½¬æ¢æˆçˆ¶ç±»å‹ï¼ŒB å¯ä»¥ç”¨ ToOwned çº¦æŸï¼Œæ‰€ä»¥å®ƒæ˜¯ ToOwned trait çš„å­ç±»å‹ï¼Œå› è€Œ B å¯ä»¥å®‰å…¨åœ°å¼ºåˆ¶è½¬æ¢æˆ ToOwnedã€‚è¿™é‡Œ B as ToOwned æ˜¯æˆç«‹çš„ã€‚</p>
</div>
</details>
<h2 id="å®ç°æ–¹å¼"><a class="header" href="#å®ç°æ–¹å¼">å®ç°æ–¹å¼</a></h2>
<details id="admonition-ä¸åŒè¯­è¨€å®ç°æ³›å‹çš„æ–¹å¼" class="admonition info">
<summary class="admonition-title">
<p>ä¸åŒè¯­è¨€å®ç°æ³›å‹çš„æ–¹å¼</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ä¸åŒè¯­è¨€å®ç°æ³›å‹çš„æ–¹å¼"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/12%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9ARust%E7%9A%84%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%E6%9C%89%E4%BB%80%E4%B9%88%E7%89%B9%E7%82%B9%EF%BC%9F.png" alt="ä¸åŒè¯­è¨€å®ç°æ³›å‹çš„æ–¹å¼" /></p>
</div>
</details>
<h2 id="æ³›å‹æ•°æ®ç»“æ„"><a class="header" href="#æ³›å‹æ•°æ®ç»“æ„">æ³›å‹æ•°æ®ç»“æ„</a></h2>
<h3 id="é€æ­¥çº¦æŸæŠŠå†³ç­–äº¤ç»™ä½¿ç”¨è€…"><a class="header" href="#é€æ­¥çº¦æŸæŠŠå†³ç­–äº¤ç»™ä½¿ç”¨è€…">é€æ­¥çº¦æŸï¼šæŠŠå†³ç­–äº¤ç»™ä½¿ç”¨è€…</a></h3>
<details id="admonition-åœ¨ä¸åŒçš„å®ç°ä¸‹é€æ­¥æ·»åŠ çº¦æŸ" class="admonition info">
<summary class="admonition-title">
<p>åœ¨ä¸åŒçš„å®ç°ä¸‹é€æ­¥æ·»åŠ çº¦æŸ</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-åœ¨ä¸åŒçš„å®ç°ä¸‹é€æ­¥æ·»åŠ çº¦æŸ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::fs::File;
use std::io::{BufReader, Read, Result};

struct MyReader&lt;R&gt; {
    reader: R,
    buf: String,
}

impl&lt;R&gt; MyReader&lt;R&gt; {
    pub fn new(reader: R) -&gt; Self {
        Self {
            reader,
            buf: String::with_capacity(1024),
        }
    }
}

impl&lt;R&gt; MyReader&lt;R&gt;
where
    R: Read,
{
    pub fn process(&amp;mut self) -&gt; Result&lt;usize&gt; {
        self.reader.read_to_string(&amp;mut self.buf)
    }
}

fn main() {
    let f = File::open(&quot;/etc/hosts&quot;).unwrap();
    let mut reader = MyReader::new(BufReader::new(f));

    let size = reader.process().unwrap();
    println!(&quot;total size read: {}&quot;, size);
}
</code></pre></pre>
</div>
</details>
<h2 id="æ³›å‹å‚æ•°"><a class="header" href="#æ³›å‹å‚æ•°">æ³›å‹å‚æ•°</a></h2>
<h3 id="å‚æ•°å¤šæ€"><a class="header" href="#å‚æ•°å¤šæ€">å‚æ•°å¤šæ€</a></h3>
<h3 id="ä¸‰ç§ä½¿ç”¨åœºæ™¯"><a class="header" href="#ä¸‰ç§ä½¿ç”¨åœºæ™¯">ä¸‰ç§ä½¿ç”¨åœºæ™¯</a></h3>
<h4 id="å»¶è¿Ÿç»‘å®š"><a class="header" href="#å»¶è¿Ÿç»‘å®š">å»¶è¿Ÿç»‘å®š</a></h4>
<h4 id="å»¶è¿Ÿç»‘å®š-1"><a class="header" href="#å»¶è¿Ÿç»‘å®š-1">å»¶è¿Ÿç»‘å®š</a></h4>
<h4 id="å¤šä¸ªå®ç°"><a class="header" href="#å¤šä¸ªå®ç°">å¤šä¸ªå®ç°</a></h4>
<h2 id="æ³›å‹å‡½æ•°"><a class="header" href="#æ³›å‹å‡½æ•°">æ³›å‹å‡½æ•°</a></h2>
<h3 id="å•æ€åŒ–"><a class="header" href="#å•æ€åŒ–">å•æ€åŒ–</a></h3>
<details id="admonition-ç¼–è¯‘æ—¶å±•å¼€æ³›å‹å‚æ•°å•æ€åŒ–" class="admonition info">
<summary class="admonition-title">
<p>ç¼–è¯‘æ—¶å±•å¼€æ³›å‹å‚æ•°å•æ€åŒ–</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ç¼–è¯‘æ—¶å±•å¼€æ³›å‹å‚æ•°å•æ€åŒ–"></a></p>
</summary>
<div>
<blockquote>
<p>å¯¹äºæ³›å‹å‡½æ•°ï¼ŒRust ä¼šè¿›è¡Œå•æ€åŒ–ï¼ˆMonomorphizationï¼‰å¤„ç†ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¼–è¯‘æ—¶ï¼ŒæŠŠæ‰€æœ‰ç”¨åˆ°çš„æ³›å‹å‡½æ•°çš„æ³›å‹å‚æ•°å±•å¼€ï¼Œç”Ÿæˆè‹¥å¹²ä¸ªå‡½æ•°ã€‚
æ‰€ä»¥ï¼Œä¸‹æ–¹çš„ id() ç¼–è¯‘åä¼šå¾—åˆ° ä¸€ä¸ªå¤„ç†åçš„å¤šä¸ªç‰ˆæœ¬</p>
</blockquote>
<hr />
<pre><pre class="playground"><code class="language-rust  editable">fn id&lt;T&gt;(x: T) -&gt; T {
    x
}

fn main() {
    let int = id(42);
    let string = id(&quot;Tyr&quot;);
    println!(&quot;{}, {}&quot;, int, string);
}
</code></pre></pre>
</div>
</details>
<details id="admonition-å•æ€åŒ–çš„ä¼˜åŠ£" class="admonition info">
<summary class="admonition-title">
<p>å•æ€åŒ–çš„ä¼˜åŠ£</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å•æ€åŒ–çš„ä¼˜åŠ£"></a></p>
</summary>
<div>
<ol>
<li>å•æ€åŒ–çš„å¥½å¤„æ˜¯:</li>
</ol>
<ul>
<li>æ³›å‹å‡½æ•°çš„è°ƒç”¨æ˜¯é™æ€åˆ†æ´¾ï¼ˆstatic dispatchï¼‰ åœ¨ç¼–è¯‘æ—¶å°±ä¸€ä¸€å¯¹åº”</li>
<li>æ—¢ä¿æœ‰å¤šæ€çš„çµæ´»æ€§ï¼Œåˆæ²¡æœ‰ä»»ä½•æ•ˆç‡çš„æŸå¤±ï¼Œå’Œæ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ ·é«˜æ•ˆã€‚</li>
</ul>
<ol start="2">
<li>åå¤„ï¼šç¼–è¯‘æ…¢ã€æ–‡ä»¶å¤§ã€ä¸¢å¤±æ³›å‹ä¿¡æ¯ã€‚è¿™åè¿‡æ¥åˆæ˜¯åŠ¨æ€åˆ†æ´¾çš„å¥½å¤„</li>
</ol>
<ul>
<li>ä½†æ˜¯å¯¹æ¯”åˆšæ‰ç¼–è¯‘ä¼šå±•å¼€çš„ä»£ç ä¹Ÿèƒ½å¾ˆæ¸…æ¥šçœ‹å‡ºæ¥ï¼Œå•æ€åŒ–æœ‰å¾ˆæ˜æ˜¾çš„åå¤„</li>
<li>å°±æ˜¯ç¼–è¯‘é€Ÿåº¦å¾ˆæ…¢ï¼Œä¸€ä¸ªæ³›å‹å‡½æ•°ï¼Œç¼–è¯‘å™¨éœ€è¦æ‰¾åˆ°æ‰€æœ‰ç”¨åˆ°çš„ä¸åŒç±»å‹ï¼Œä¸€ä¸ªä¸ªç¼–è¯‘</li>
<li>æ‰€ä»¥ Rust ç¼–è¯‘ä»£ç çš„é€Ÿåº¦æ€»è¢«äººåæ§½ï¼Œè¿™å’Œå•æ€åŒ–è„±ä¸å¼€å¹²ç³»ï¼ˆå¦ä¸€ä¸ªé‡è¦å› ç´ æ˜¯å®ï¼‰ã€‚</li>
<li>åŒæ—¶ï¼Œè¿™æ ·ç¼–å‡ºæ¥çš„äºŒè¿›åˆ¶ä¼šæ¯”è¾ƒå¤§ï¼Œå› ä¸ºæ³›å‹å‡½æ•°çš„äºŒè¿›åˆ¶ä»£ç å®é™…å­˜åœ¨ N ä»½ã€‚</li>
<li>è¿˜æœ‰ä¸€ä¸ªå¯èƒ½ä½ ä¸æ€ä¹ˆæ³¨æ„çš„é—®é¢˜ï¼šå› ä¸ºå•æ€åŒ–ï¼Œä»£ç ä»¥äºŒè¿›åˆ¶åˆ†å‘ä¼šæŸå¤±æ³›å‹çš„ä¿¡æ¯ã€‚</li>
<li>å¦‚æœæˆ‘å†™äº†ä¸€ä¸ªåº“ï¼Œæä¾›äº†å¦‚ä¸Šçš„ id() å‡½æ•°ï¼Œä½¿ç”¨è¿™ä¸ªåº“çš„å¼€å‘è€…å¦‚æœæ‹¿åˆ°çš„æ˜¯äºŒè¿›åˆ¶</li>
<li>é‚£ä¹ˆè¿™ä¸ªäºŒè¿›åˆ¶ä¸­å¿…é¡»å¸¦æœ‰åŸå§‹çš„æ³›å‹å‡½æ•°ï¼Œæ‰èƒ½æ­£ç¡®è°ƒç”¨ã€‚ä½†å•æ€åŒ–ä¹‹åï¼ŒåŸæœ¬çš„æ³›å‹ä¿¡æ¯å°±è¢«ä¸¢å¼ƒäº†ã€‚</li>
</ul>
</div>
</details>
<h4 id="ä¼˜åŠ£"><a class="header" href="#ä¼˜åŠ£">ä¼˜åŠ£</a></h4>
<h3 id="è¿”å›å€¼æºå¸¦æ³›å‹å‚æ•°"><a class="header" href="#è¿”å›å€¼æºå¸¦æ³›å‹å‚æ•°">è¿”å›å€¼æºå¸¦æ³›å‹å‚æ•°</a></h3>
<h1 id="trait"><a class="header" href="#trait">Trait</a></h1>
<div id="admonition-traitæ¦‚è§ˆå›¾" class="admonition info">
<div class="admonition-title">
<p>traitæ¦‚è§ˆå›¾</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-traitæ¦‚è§ˆå›¾"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/13%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8trait%E6%9D%A5%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3%EF%BC%9F.jpg" alt="traitæ¦‚è§ˆå›¾" /></p>
</div>
</div>
<h2 id="åŸºæœ¬ç»ƒä¹ "><a class="header" href="#åŸºæœ¬ç»ƒä¹ ">åŸºæœ¬ç»ƒä¹ </a></h2>
<h3 id="selfå’Œself"><a class="header" href="#selfå’Œself">Selfå’Œself</a></h3>
<details id="admonition-selfå’ŒselfåŒºåˆ«ä½¿ç”¨-selfå…¶å®å°±æ˜¯é™æ€æ–¹æ³•" class="admonition info">
<summary class="admonition-title">
<p>Selfå’ŒselfåŒºåˆ«ä½¿ç”¨, Selfå…¶å®å°±æ˜¯é™æ€æ–¹æ³•</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-selfå’ŒselfåŒºåˆ«ä½¿ç”¨-selfå…¶å®å°±æ˜¯é™æ€æ–¹æ³•"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::fmt;
use std::io::Write;

struct BufBuilder {
    buf: Vec&lt;u8&gt;,
}

impl BufBuilder {
    pub fn new() -&gt; Self {
        Self {
            buf: Vec::with_capacity(1024),
        }
    }
}

impl fmt::Debug for BufBuilder {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter) -&gt; fmt::Result {
        write!(f, &quot;{}&quot;, String::from_utf8_lossy(self.buf.as_ref()))
    }
}

impl Write for BufBuilder {
    fn write(&amp;mut self, buf: &amp;[u8]) -&gt; std::io::Result&lt;usize&gt; {
        self.buf.extend_from_slice(buf);
        Ok(buf.len())
    }

    fn flush(&amp;mut self) -&gt; std::io::Result&lt;()&gt; {
        Ok(())
    }
}

fn main() {
    let mut buf = BufBuilder::new();
    buf.write_all(b&quot;Hello world!&quot;).unwrap();
    println!(&quot;{:?}&quot;, buf);
}
</code></pre></pre>
</div>
</details>
<details id="admonition-self-self-å®ä¾‹æ¥è‡ªäºç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>self: Self, å®ä¾‹æ¥è‡ªäºç±»å‹</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-self-self-å®ä¾‹æ¥è‡ªäºç±»å‹"></a></p>
</summary>
<div>
<ol>
<li>Self ä»£è¡¨å½“å‰çš„ç±»å‹ï¼Œæ¯”å¦‚ File ç±»å‹å®ç°äº† Writeï¼Œé‚£ä¹ˆå®ç°è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„ Self å°±æŒ‡ä»£ Fileã€‚</li>
<li>self åœ¨ç”¨ä½œæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ—¶ï¼Œå®é™…ä¸Šæ˜¯ self: Self çš„ç®€å†™ï¼Œæ‰€ä»¥ &amp;self æ˜¯ self: &amp;Self, è€Œ &amp;mut self æ˜¯ self: &amp;mut Selfã€‚</li>
</ol>
</div>
</details>
<h3 id="é€’è¿›ç»ƒä¹ traitä½¿ç”¨"><a class="header" href="#é€’è¿›ç»ƒä¹ traitä½¿ç”¨">é€’è¿›ç»ƒä¹ traitä½¿ç”¨</a></h3>
<h4 id="åŸºç¡€å®šä¹‰trait"><a class="header" href="#åŸºç¡€å®šä¹‰trait">åŸºç¡€å®šä¹‰trait</a></h4>
<details id="admonition-å®šä¹‰parse-traitå¹¶å®ç°ä½¿ç”¨" class="admonition info">
<summary class="admonition-title">
<p>å®šä¹‰Parse traitå¹¶å®ç°ä½¿ç”¨</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å®šä¹‰parse-traitå¹¶å®ç°ä½¿ç”¨"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use regex::Regex;
pub trait Parse {
    fn parse(s: &amp;str) -&gt; Self;
}

impl Parse for u8 {
    fn parse(s: &amp;str) -&gt; Self {
        let re: Regex = Regex::new(r&quot;^[0-9]+&quot;).unwrap();
        if let Some(captures) = re.captures(s) {
            captures
                .get(0)
                .map_or(0, |s| s.as_str().parse().unwrap_or(0))
        } else {
            0
        }
    }
}

#[test]
fn parse_should_work() {
    assert_eq!(u8::parse(&quot;123abcd&quot;), 123);
    assert_eq!(u8::parse(&quot;1234abcd&quot;), 0);
    assert_eq!(u8::parse(&quot;abcd&quot;), 0);
}

fn main() {
    println!(&quot;result: {}&quot;, u8::parse(&quot;255 hello world&quot;));
}
</code></pre></pre>
</div>
</details>
<h4 id="æ·»åŠ æ³›å‹å‚æ•°ä½œä¸ºæ³›å‹çº¦æŸ"><a class="header" href="#æ·»åŠ æ³›å‹å‚æ•°ä½œä¸ºæ³›å‹çº¦æŸ">æ·»åŠ æ³›å‹å‚æ•°ä½œä¸ºæ³›å‹çº¦æŸ</a></h4>
<details id="admonition-impl-parse-for-t" class="admonition info">
<summary class="admonition-title">
<p>impl<T> Parse for T</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-impl-parse-for-t"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::str::FromStr;

use regex::Regex;
pub trait Parse {
    fn parse(s: &amp;str) -&gt; Self;
}

impl&lt;T&gt; Parse for T
where
    T: FromStr + Default,
{
    fn parse(s: &amp;str) -&gt; Self {
        let re: Regex = Regex::new(r&quot;^[0-9]+(\.[0-9]+)?&quot;).unwrap();
        let d = || Default::default();
        if let Some(captures) = re.captures(s) {
            captures
                .get(0)
                .map_or(d(), |s| s.as_str().parse().unwrap_or_else(|_| d()))
        } else {
            d()
        }
    }
}

#[test]
fn parse_should_work() {
    assert_eq!(u32::parse(&quot;123abcd&quot;), 123);
    assert_eq!(u32::parse(&quot;123.45abcd&quot;), 0);
    assert_eq!(f64::parse(&quot;123.45abcd&quot;).to_string(), &quot;123.45&quot;);
    assert_eq!(f64::parse(&quot;abcd&quot;).to_string(), &quot;0&quot;);
}

fn main() {
    println!(&quot;result: {}&quot;, u8::parse(&quot;255 hello world&quot;));
}
</code></pre></pre>
</div>
</details>
<h4 id="ä½¿ç”¨å…³è”ç±»å‹æ·»åŠ resultt-e"><a class="header" href="#ä½¿ç”¨å…³è”ç±»å‹æ·»åŠ resultt-e">ä½¿ç”¨å…³è”ç±»å‹+æ·»åŠ Result&lt;T, E&gt;</a></h4>
<details id="admonition-å…³è”ç±»å‹è‡ªå®šä¹‰error" class="admonition info">
<summary class="admonition-title">
<p>å…³è”ç±»å‹è‡ªå®šä¹‰Error</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å…³è”ç±»å‹è‡ªå®šä¹‰error"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::str::FromStr;

use regex::Regex;
pub trait Parse {
    type Error;
    fn parse(s: &amp;str) -&gt; Result&lt;Self, Self::Error&gt;
    where
        Self: Sized;
}

impl&lt;T&gt; Parse for T
where
    T: FromStr + Default,
{
    // å®šä¹‰å…³è”ç±»å‹ Error ä¸º String
    type Error = String;
    fn parse(s: &amp;str) -&gt; Result&lt;Self, Self::Error&gt; {
        let re: Regex = Regex::new(r&quot;^[0-9]+(\.[0-9]+)?&quot;).unwrap();
        if let Some(captures) = re.captures(s) {
            // å½“å‡ºé”™æ—¶æˆ‘ä»¬è¿”å› Err(String)
            captures
                .get(0)
                .map_or(Err(&quot;failed to capture&quot;.to_string()), |s| {
                    s.as_str()
                        .parse()
                        .map_err(|_err| &quot;failed to parse captured string&quot;.to_string())
                })
        } else {
            Err(&quot;failed to parse string&quot;.to_string())
        }
    }
}

#[test]
fn parse_should_work() {
    assert_eq!(u32::parse(&quot;123abcd&quot;), Ok(123));
    assert_eq!(
        u32::parse(&quot;123.45abcd&quot;),
        Err(&quot;failed to parse captured string&quot;.into())
    );
    assert_eq!(f64::parse(&quot;123.45abcd&quot;), Ok(123.45));
    assert!(f64::parse(&quot;abcd&quot;).is_err());
}

fn main() {
    println!(&quot;result: {:?}&quot;, u8::parse(&quot;255 hello world&quot;));
}
</code></pre></pre>
</div>
</details>
<h3 id="æ³›å‹çº¦æŸ-æ”¯æŒæ³›å‹çš„trait"><a class="header" href="#æ³›å‹çº¦æŸ-æ”¯æŒæ³›å‹çš„trait">æ³›å‹çº¦æŸ: æ”¯æŒæ³›å‹çš„trait</a></h3>
<h4 id="æ€è€ƒé¢˜"><a class="header" href="#æ€è€ƒé¢˜">æ€è€ƒé¢˜</a></h4>
<details id="admonition-æ³›å‹å‚æ•°implæŠ¥é”™" class="admonition info">
<summary class="admonition-title">
<p>æ³›å‹å‚æ•°implæŠ¥é”™</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-æ³›å‹å‚æ•°implæŠ¥é”™"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::io::{BufWriter, Write};
use std::net::TcpStream;

#[derive(Debug)]
struct MyWriter&lt;W&gt; {
    writer: W,
}

impl&lt;W: Write&gt; MyWriter&lt;W&gt; {
    pub fn new(addr: &amp;str) -&gt; Self {
        let stream = TcpStream::connect(&quot;127.0.0.1:8080&quot;).unwrap();
        Self {
            writer: BufWriter::new(stream),
        }
    }

    pub fn write(&amp;mut self, buf: &amp;str) -&gt; std::io::Result&lt;()&gt; {
        self.writer.write_all(buf.as_bytes())
    }
}

fn main() {
    let writer = MyWriter::new(&quot;127.0.0.1:8080&quot;);
    writer.write(&quot;hello world!&quot;);
}
</code></pre></pre>
</div>
</details>
<div id="admonition-åˆ†æç¼–è¯‘æŠ¥é”™åŸå› " class="admonition tip">
<div class="admonition-title">
<p>åˆ†æç¼–è¯‘æŠ¥é”™åŸå› </p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-åˆ†æç¼–è¯‘æŠ¥é”™åŸå› "></a></p>
</div>
<div>
<p>ä¸»è¦åŸå› æ˜¯ï¼Œå®ç° new æ–¹æ³•æ—¶ï¼Œå¯¹æ³›å‹çš„çº¦æŸè¦æ±‚è¦æ»¡è¶³ W: Writeï¼Œè€Œ new çš„å£°æ˜è¿”å›å€¼æ˜¯ Selfï¼Œä¹Ÿå°±æ˜¯è¯´ self.wirter å¿…é¡»æ˜¯ W: Write ç±»å‹(æ³›å‹)ï¼Œä½†å®é™…è¿”å›å€¼æ˜¯ä¸€ä¸ªç¡®å®šçš„ç±»å‹ BufWriter<TcpStream>ï¼Œè¿™ä¸æ»¡è¶³è¦æ±‚ã€‚</p>
</div>
</div>
<h4 id="è§£å†³æ–¹æ¡ˆ"><a class="header" href="#è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</a></h4>
<div id="admonition-è§£å†³æ–¹æ¡ˆæ¢³ç†" class="admonition info">
<div class="admonition-title">
<p>è§£å†³æ–¹æ¡ˆæ¢³ç†</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-è§£å†³æ–¹æ¡ˆæ¢³ç†"></a></p>
</div>
<div>
<ol>
<li>ä¿®æ”¹ new æ–¹æ³•çš„è¿”å›å€¼</li>
<li>å¯¹ç¡®å®šçš„ç±»å‹ MyWriter&lt;BufWriter<TcpStream>&gt;å®ç° new æ–¹æ³•</li>
<li>ä¿®æ”¹ new æ–¹æ³•çš„å®ç°ï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥</li>
</ol>
</div>
</div>
<details id="admonition-1-ä¿®æ”¹newæ–¹æ³•è¿”å›å€¼" class="admonition info">
<summary class="admonition-title">
<ol>
<li>ä¿®æ”¹newæ–¹æ³•è¿”å›å€¼</li>
</ol>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-1-ä¿®æ”¹newæ–¹æ³•è¿”å›å€¼"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::io::{BufWriter, Write};
use std::net::TcpStream;

#[derive(Debug)]
struct MyWriter&lt;W&gt; {
    writer: W,
}

impl&lt;W: Write&gt; MyWriter&lt;W&gt; {
    pub fn new(writer: W) -&gt; Self {
        Self { writer }
    }

    pub fn write(&amp;mut self, buf: &amp;str) -&gt; std::io::Result&lt;()&gt; {
        self.writer.write_all(buf.as_bytes())
    }
}

fn main() {
    let stream = TcpStream::connect(&quot;127.0.0.1:8080&quot;).unwrap();

    let mut writer = MyWriter::new(BufWriter::new(stream));
    writer.write(&quot;hello world!&quot;).unwrap();
}
</code></pre></pre>
</div>
</details>
<details id="admonition-2-é’ˆå¯¹å®ç°newæ–¹æ³•" class="admonition info">
<summary class="admonition-title">
<ol start="2">
<li>é’ˆå¯¹å®ç°newæ–¹æ³•</li>
</ol>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-2-é’ˆå¯¹å®ç°newæ–¹æ³•"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">impl MyWriter&lt;BufWriter&lt;TcpStream&gt;&gt; {
    pub fn new(addr: &amp;str) -&gt; Self {
        let stream = TcpStream::connect(addr).unwrap();
        Self {
            writer: BufWriter::new(stream),
        }
    }
}

fn main() {
    let mut writer = MyWriter::new(&quot;127.0.0.1:8080&quot;);
    writer.write(&quot;hello world!&quot;);
}
</code></pre></pre>
</div>
</details>
<details id="admonition-3-ä½¿ç”¨ä¾èµ–æ³¨å…¥ä¿®æ”¹newæ–¹æ³•å®ç°" class="admonition info">
<summary class="admonition-title">
<ol start="3">
<li>ä½¿ç”¨ä¾èµ–æ³¨å…¥ä¿®æ”¹newæ–¹æ³•å®ç°</li>
</ol>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-3-ä½¿ç”¨ä¾èµ–æ³¨å…¥ä¿®æ”¹newæ–¹æ³•å®ç°"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">impl&lt;W: Write&gt; MyWriter&lt;W&gt; {
    pub fn new(writer: W) -&gt; Self {
        Self {
            writer,
        }
    }
}

fn main() {
    let stream = TcpStream::connect(&quot;127.0.0.1:8080&quot;).unwrap();
    let mut writer = MyWriter::new(BufWriter::new(stream));
    writer.write(&quot;hello world!&quot;);
}
</code></pre></pre>
</div>
</details>
<h3 id="å…³è”ç±»å‹"><a class="header" href="#å…³è”ç±»å‹">å…³è”ç±»å‹</a></h3>
<h3 id="æ”¯æŒæ³›å‹"><a class="header" href="#æ”¯æŒæ³›å‹">æ”¯æŒæ³›å‹</a></h3>
<details id="admonition-ç‰ˆæœ¬ä¸€æ”¯æŒæ•°å­—ç›¸åŠ " class="admonition info">
<summary class="admonition-title">
<p>ç‰ˆæœ¬ä¸€ï¼šæ”¯æŒæ•°å­—ç›¸åŠ </p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ç‰ˆæœ¬ä¸€æ”¯æŒæ•°å­—ç›¸åŠ "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::ops::Add;

#[derive(Debug)]
struct Complex {
    real: f64,
    imagine: f64,
}

impl Complex {
    pub fn new(real: f64, imagine: f64) -&gt; Self {
        Self { real, imagine }
    }
}

// å¯¹ Complex ç±»å‹çš„å®ç°
impl Add for Complex {
    type Output = Self;

    // æ³¨æ„ add ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼Œä¼šç§»åŠ¨æ‰€æœ‰æƒ
    fn add(self, rhs: Self) -&gt; Self::Output {
        let real = self.real + rhs.real;
        let imagine = self.imagine + rhs.imagine;
        Self::new(real, imagine)
    }
}


fn main() {
    let c1 = Complex::new(1.0, 1f64);
    let c2 = Complex::new(2 as f64, 3.0);
    println!(&quot;{:?}&quot;, c1 + c2);
    // c1, c2 å·²ç»è¢«ç§»åŠ¨ï¼Œæ‰€ä»¥ä¸‹é¢è¿™å¥æ— æ³•ç¼–è¯‘
    // println!(&quot;{:?}&quot;, c1 + c2);
}
</code></pre></pre>
</div>
</details>
<h3 id="æ”¯æŒç»§æ‰¿"><a class="header" href="#æ”¯æŒç»§æ‰¿">æ”¯æŒç»§æ‰¿</a></h3>
<details id="admonition-trait-ba" class="admonition info">
<summary class="admonition-title">
<p>trait B:A</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-trait-ba"></a></p>
</summary>
<div>
<p>åœ¨ Rust ä¸­ï¼Œä¸€ä¸ª trait å¯ä»¥â€œç»§æ‰¿â€å¦ä¸€ä¸ª trait çš„å…³è”ç±»å‹å’Œå…³è”å‡½æ•°ã€‚æ¯”å¦‚ trait B: A ï¼Œæ˜¯è¯´ä»»ä½•ç±»å‹ Tï¼Œå¦‚æœå®ç°äº† trait Bï¼Œå®ƒä¹Ÿå¿…é¡»å®ç° trait Aï¼Œæ¢å¥è¯è¯´ï¼Œtrait B åœ¨å®šä¹‰æ—¶å¯ä»¥ä½¿ç”¨ trait A ä¸­çš„å…³è”ç±»å‹å’Œæ–¹æ³•ã€‚</p>
<pre><pre class="playground"><code class="language-rust  editable">impl&lt;T: ?Sized&gt; StreamExt for T where T: Stream {}
</code></pre></pre>
<hr />
<p>å¦‚æœä½ å®ç°äº† Stream traitï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ StreamExt é‡Œçš„æ–¹æ³•äº†</p>
</div>
</details>
<h3 id="æ¥å£æŠ½è±¡-or-ç‰¹è®¾å¤šæ€"><a class="header" href="#æ¥å£æŠ½è±¡-or-ç‰¹è®¾å¤šæ€">æ¥å£æŠ½è±¡ or ç‰¹è®¾å¤šæ€</a></h3>
<details id="admonition-å¯¹ä¸åŒç±»å‹ç»Ÿä¸€å®ç°-traitå°†å„ç§æ¥å£å®šä¹‰åœºæ™¯è€ƒè™‘è¿›å»" class="admonition info">
<summary class="admonition-title">
<p>å¯¹ä¸åŒç±»å‹ç»Ÿä¸€å®ç°: traitå°†å„ç§æ¥å£å®šä¹‰åœºæ™¯è€ƒè™‘è¿›å»</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å¯¹ä¸åŒç±»å‹ç»Ÿä¸€å®ç°-traitå°†å„ç§æ¥å£å®šä¹‰åœºæ™¯è€ƒè™‘è¿›å»"></a></p>
</summary>
<div>
<p>trait ä½œä¸ºå¯¹ä¸åŒæ•°æ®ç»“æ„ä¸­ç›¸åŒè¡Œä¸ºçš„ä¸€ç§æŠ½è±¡ã€‚</p>
<ol>
<li>é™¤äº†åŸºæœ¬ trait ä¹‹å¤–ï¼Œå½“è¡Œä¸ºå’Œå…·ä½“çš„æ•°æ®å…³è”æ—¶ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²è§£ææ—¶å®šä¹‰çš„ Parse traitï¼Œæˆ‘ä»¬å¼•å…¥äº†å¸¦æœ‰å…³è”ç±»å‹çš„ traitï¼ŒæŠŠå’Œè¡Œä¸ºæœ‰å…³çš„æ•°æ®ç±»å‹çš„å®šä¹‰ï¼Œè¿›ä¸€æ­¥å»¶è¿Ÿåˆ° trait å®ç°çš„æ—¶å€™ã€‚</li>
<li>å¯¹äºåŒä¸€ä¸ªç±»å‹çš„åŒä¸€ä¸ª trait è¡Œä¸ºï¼Œå¯ä»¥æœ‰ä¸åŒçš„å®ç°ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹‹å‰å¤§é‡ä½¿ç”¨çš„ Fromï¼Œæ­¤æ—¶å¯ä»¥ç”¨æ³›å‹ traitã€‚å¯ä»¥è¯´ Rust çš„ trait å°±åƒä¸€æŠŠç‘å£«å†›åˆ€ï¼ŒæŠŠéœ€è¦å®šä¹‰æ¥å£çš„å„ç§åœºæ™¯éƒ½è€ƒè™‘è¿›å»äº†ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-å¯¹ä¸åŒç±»å‹çš„ä¸åŒå®ç°-ç‰¹è®¾å¤šæ€" class="admonition info">
<summary class="admonition-title">
<p>å¯¹ä¸åŒç±»å‹çš„ä¸åŒå®ç°: ç‰¹è®¾å¤šæ€</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å¯¹ä¸åŒç±»å‹çš„ä¸åŒå®ç°-ç‰¹è®¾å¤šæ€"></a></p>
</summary>
<div>
<p>ç‰¹è®¾å¤šæ€æ˜¯åŒä¸€ç§è¡Œä¸ºçš„ä¸åŒå®ç°ã€‚æ‰€ä»¥å…¶å®ï¼Œé€šè¿‡å®šä¹‰ trait ä»¥åŠä¸ºä¸åŒçš„ç±»å‹å®ç°è¿™ä¸ª traitï¼Œæˆ‘ä»¬å°±å·²ç»å®ç°äº†ç‰¹è®¾å¤šæ€ã€‚</p>
<ol>
<li>Add trait å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ç‰¹è®¾å¤šæ€ï¼ŒåŒæ ·æ˜¯åŠ æ³•æ“ä½œï¼Œæ ¹æ®æ“ä½œæ•°æ®çš„ä¸åŒè¿›è¡Œä¸åŒçš„å¤„ç†ã€‚</li>
<li>Service trait æ˜¯ä¸€ä¸ªä¸é‚£ä¹ˆæ˜æ˜¾çš„ç‰¹è®¾å¤šæ€ï¼ŒåŒæ ·æ˜¯ Web è¯·æ±‚ï¼Œå¯¹äºä¸åŒçš„ URLï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸åŒçš„ä»£ç å»å¤„ç†ã€‚</li>
</ol>
</div>
</details>
<h2 id="trait-object"><a class="header" href="#trait-object">Trait Object</a></h2>
<h3 id="å­ç±»å‹å¤šæ€-åŠ¨æ€åˆ†æ´¾"><a class="header" href="#å­ç±»å‹å¤šæ€-åŠ¨æ€åˆ†æ´¾">å­ç±»å‹å¤šæ€: åŠ¨æ€åˆ†æ´¾</a></h3>
<details id="admonition-åœ¨è¿è¡ŒæœŸå†³å®š" class="admonition info">
<summary class="admonition-title">
<p>åœ¨è¿è¡ŒæœŸå†³å®š</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-åœ¨è¿è¡ŒæœŸå†³å®š"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">pub trait Formatter {
    fn format(&amp;self, input: &amp;mut String) -&gt; bool;
}

struct MarkdownFormatter;
impl Formatter for MarkdownFormatter {
    fn format(&amp;self, input: &amp;mut String) -&gt; bool {
        input.push_str(&quot;\nformatted with Markdown formatter&quot;);
        true
    }
}

struct RustFormatter;
impl Formatter for RustFormatter {
    fn format(&amp;self, input: &amp;mut String) -&gt; bool {
        input.push_str(&quot;\nformatted with Rust formatter&quot;);
        true
    }
}

struct HtmlFormatter;
impl Formatter for HtmlFormatter {
    fn format(&amp;self, input: &amp;mut String) -&gt; bool {
        input.push_str(&quot;\nformatted with HTML formatter&quot;);
        true
    }
}

pub fn format(input: &amp;mut String, formatters: Vec&lt;&amp;dyn Formatter&gt;) {
    for formatter in formatters {
        formatter.format(input);
    }
}

fn main() {
    let mut text = &quot;Hello world!&quot;.to_string();
    let html: &amp;dyn Formatter = &amp;HtmlFormatter;
    let rust: &amp;dyn Formatter = &amp;RustFormatter;
    let formatters = vec![html, rust];
    format(&amp;mut text, formatters);

    println!(&quot;text: {}&quot;, text);
}
</code></pre></pre>
<hr />
<p>è¦æœ‰ä¸€ç§æ‰‹æ®µï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œæ­¤å¤„éœ€è¦å¹¶ä¸”ä»…éœ€è¦ä»»ä½•å®ç°äº† Formatter æ¥å£çš„æ•°æ®ç±»å‹ã€‚åœ¨ Rust é‡Œï¼Œè¿™ç§ç±»å‹å« Trait Objectï¼Œè¡¨ç°ä¸º &amp;dyn Trait æˆ–è€… Boxã€‚</p>
<ol>
<li>è¿™é‡Œç»“æ„ä½“åªæ˜¯å£°æ˜äº†ä¸€ä¸‹ï¼Œå¹¶ä¸å…³æ³¨å…¶åŒ…å«ä»€ä¹ˆå­—æ®µ</li>
</ol>
</div>
</details>
<h3 id="å®ç°æœºç†ptrvtable"><a class="header" href="#å®ç°æœºç†ptrvtable">å®ç°æœºç†ï¼šptr+vtable</a></h3>
<details id="admonition-trait-objectçš„åº•å±‚é€»è¾‘å°±æ˜¯èƒ–æŒ‡é’ˆ" class="admonition info">
<summary class="admonition-title">
<p>Trait Objectçš„åº•å±‚é€»è¾‘å°±æ˜¯èƒ–æŒ‡é’ˆ</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-trait-objectçš„åº•å±‚é€»è¾‘å°±æ˜¯èƒ–æŒ‡é’ˆ"></a></p>
</summary>
<div>
<h2 id="-4"><a class="header" href="#-4"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/13%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8trait%E6%9D%A5%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3%EF%BC%9F-4258625.jpg" alt="13ï½œç±»å‹ç³»ç»Ÿï¼šå¦‚ä½•ä½¿ç”¨traitæ¥å®šä¹‰æ¥å£ï¼Ÿ" /></a></h2>
<p>HtmlFormatter çš„å¼•ç”¨èµ‹å€¼ç»™ Formatter åï¼Œä¼šç”Ÿæˆä¸€ä¸ª Trait Objectï¼Œåœ¨ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒTrait Object çš„åº•å±‚é€»è¾‘å°±æ˜¯èƒ–æŒ‡é’ˆã€‚</p>
<blockquote>
<p>å…¶ä¸­ï¼Œä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°æ®æœ¬èº«ï¼Œå¦ä¸€ä¸ªåˆ™æŒ‡å‘è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰ã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-vtableæ˜¯ä¸€å¼ é™æ€è¡¨" class="admonition info">
<summary class="admonition-title">
<p>vtableæ˜¯ä¸€å¼ é™æ€è¡¨</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-vtableæ˜¯ä¸€å¼ é™æ€è¡¨"></a></p>
</summary>
<div>
<h2 id="-5"><a class="header" href="#-5"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/13%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8trait%E6%9D%A5%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3%EF%BC%9F-4258661.jpg" alt="13ï½œç±»å‹ç³»ç»Ÿï¼šå¦‚ä½•ä½¿ç”¨traitæ¥å®šä¹‰æ¥å£ï¼Ÿ" /></a></h2>
<ol>
<li>vtable æ˜¯ä¸€å¼ é™æ€çš„è¡¨ï¼ŒRust åœ¨ç¼–è¯‘æ—¶ä¼šä¸ºä½¿ç”¨äº† trait object çš„ç±»å‹çš„ trait å®ç°ç”Ÿæˆä¸€å¼ è¡¨ï¼Œæ”¾åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼ˆä¸€èˆ¬åœ¨ TEXT æˆ– RODATA æ®µï¼‰</li>
</ol>
<blockquote>
<p>åœ¨è¿™å¼ è¡¨é‡Œï¼ŒåŒ…å«å…·ä½“ç±»å‹çš„ä¸€äº›ä¿¡æ¯ï¼Œå¦‚ sizeã€aligment ä»¥åŠä¸€ç³»åˆ—å‡½æ•°æŒ‡é’ˆ
è¿™ä¸ªæ¥å£æ”¯æŒçš„æ‰€æœ‰çš„æ–¹æ³•ï¼Œæ¯”å¦‚ format() ï¼›å…·ä½“ç±»å‹çš„ drop traitï¼Œå½“ Trait object è¢«é‡Šæ”¾ï¼Œå®ƒç”¨æ¥é‡Šæ”¾å…¶ä½¿ç”¨çš„æ‰€æœ‰èµ„æºã€‚è¿™æ ·ï¼Œå½“åœ¨è¿è¡Œæ—¶æ‰§è¡Œ formatter.format() æ—¶ï¼Œformatter å°±å¯ä»¥ä» vtable é‡Œæ‰¾åˆ°å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆï¼Œæ‰§è¡Œå…·ä½“çš„æ“ä½œã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-vtableä¼šä¸ºæ¯ä¸ªç±»å‹çš„æ¯ä¸ªtraitå®ç°ä¸€å¼ è¡¨" class="admonition info">
<summary class="admonition-title">
<p>vtableä¼šä¸ºæ¯ä¸ªç±»å‹çš„æ¯ä¸ªtraitå®ç°ä¸€å¼ è¡¨</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-vtableä¼šä¸ºæ¯ä¸ªç±»å‹çš„æ¯ä¸ªtraitå®ç°ä¸€å¼ è¡¨"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::fmt::{Debug, Display};
use std::mem::transmute;

fn main() {
    let s = String::from(&quot;hello world!&quot;);
    let s1 = String::from(&quot;goodbye world!&quot;);
    // Display / Debug trait object for s
    let w1: &amp;dyn Display = &amp;s;
    let w2: &amp;dyn Debug = &amp;s;

    // Display / Debug trait object for s1
    let w3: &amp;dyn Display = &amp;s1;
    let w4: &amp;dyn Debug = &amp;s1;

    // å¼ºè¡ŒæŠŠ triat object è½¬æ¢æˆä¸¤ä¸ªåœ°å€ (usize, usize)
    // è¿™æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æ˜¯ unsafe
    let (addr1, vtable1): (usize, usize) = unsafe { transmute(w1) };
    let (addr2, vtable2): (usize, usize) = unsafe { transmute(w2) };
    let (addr3, vtable3): (usize, usize) = unsafe { transmute(w3) };
    let (addr4, vtable4): (usize, usize) = unsafe { transmute(w4) };

    // s å’Œ s1 åœ¨æ ˆä¸Šçš„åœ°å€ï¼Œä»¥åŠ main åœ¨ TEXT æ®µçš„åœ°å€
    println!(
        &quot;s: {:p}, s1: {:p}, main(): {:p}&quot;,
        &amp;s, &amp;s1, main as *const ()
    );
    // trait object(s / Display) çš„ ptr åœ°å€å’Œ vtable åœ°å€
    println!(&quot;addr1: 0x{:x}, vtable1: 0x{:x}&quot;, addr1, vtable1);
    // trait object(s / Debug) çš„ ptr åœ°å€å’Œ vtable åœ°å€
    println!(&quot;addr2: 0x{:x}, vtable2: 0x{:x}&quot;, addr2, vtable2);

    // trait object(s1 / Display) çš„ ptr åœ°å€å’Œ vtable åœ°å€
    println!(&quot;addr3: 0x{:x}, vtable3: 0x{:x}&quot;, addr3, vtable3);

    // trait object(s1 / Display) çš„ ptr åœ°å€å’Œ vtable åœ°å€
    println!(&quot;addr4: 0x{:x}, vtable4: 0x{:x}&quot;, addr4, vtable4);

    // æŒ‡å‘åŒä¸€ä¸ªæ•°æ®çš„ trait object å…¶ ptr åœ°å€ç›¸åŒ
    assert_eq!(addr1, addr2);
    assert_eq!(addr3, addr4);

    // æŒ‡å‘åŒä¸€ç§ç±»å‹çš„åŒä¸€ä¸ª trait çš„ vtable åœ°å€ç›¸åŒ
    // è¿™é‡Œéƒ½æ˜¯ String + Display
    assert_eq!(vtable1, vtable3);
    // è¿™é‡Œéƒ½æ˜¯ String + Debug
    assert_eq!(vtable2, vtable4);
}
</code></pre></pre>
</div>
</details>
<h3 id="å¯¹è±¡å®‰å…¨"><a class="header" href="#å¯¹è±¡å®‰å…¨">å¯¹è±¡å®‰å…¨</a></h3>
<details id="admonition-é‚£ä»€ä¹ˆæ ·çš„-trait-ä¸æ˜¯å¯¹è±¡å®‰å…¨çš„å‘¢" class="admonition info">
<summary class="admonition-title">
<p>é‚£ä»€ä¹ˆæ ·çš„ trait ä¸æ˜¯å¯¹è±¡å®‰å…¨çš„å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-é‚£ä»€ä¹ˆæ ·çš„-trait-ä¸æ˜¯å¯¹è±¡å®‰å…¨çš„å‘¢"></a></p>
</summary>
<div>
<ol>
<li>å¦‚æœ trait æ‰€æœ‰çš„æ–¹æ³•ï¼Œè¿”å›å€¼æ˜¯ Self æˆ–è€…æºå¸¦æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ª trait å°±ä¸èƒ½äº§ç”Ÿ trait objectã€‚</li>
<li>ä¸å…è®¸è¿”å› Selfï¼Œæ˜¯å› ä¸º trait object åœ¨äº§ç”Ÿæ—¶ï¼ŒåŸæ¥çš„ç±»å‹ä¼šè¢«æŠ¹å»ï¼Œæ‰€ä»¥ Self ç©¶ç«Ÿæ˜¯è°ä¸çŸ¥é“ã€‚</li>
<li>æ¯”å¦‚ Clone trait åªæœ‰ä¸€ä¸ªæ–¹æ³• clone()ï¼Œè¿”å› Selfï¼Œæ‰€ä»¥å®ƒå°±ä¸èƒ½äº§ç”Ÿ trait objectã€‚</li>
<li>ä¸å…è®¸æºå¸¦æ³›å‹å‚æ•°ï¼Œæ˜¯å› ä¸º Rust é‡Œå¸¦æ³›å‹çš„ç±»å‹åœ¨ç¼–è¯‘æ—¶ä¼šåšå•æ€åŒ–ï¼Œè€Œ trait object æ˜¯è¿è¡Œæ—¶çš„äº§ç‰©ï¼Œä¸¤è€…ä¸èƒ½å…¼å®¹ã€‚</li>
<li>æ¯”å¦‚ Fromtraitï¼Œå› ä¸ºæ•´ä¸ª trait å¸¦äº†æ³›å‹ï¼Œæ¯ä¸ªæ–¹æ³•ä¹Ÿè‡ªç„¶åŒ…å«æ³›å‹ï¼Œå°±ä¸èƒ½äº§ç”Ÿ trait objectã€‚å¦‚æœä¸€ä¸ª trait åªæœ‰éƒ¨åˆ†æ–¹æ³•è¿”å› Self æˆ–è€…ä½¿ç”¨äº†æ³›å‹å‚æ•°ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ–¹æ³•åœ¨ trait object ä¸­ä¸èƒ½è°ƒç”¨ã€‚</li>
</ol>
</div>
</details>
<h3 id="ä½¿ç”¨åœºæ™¯"><a class="header" href="#ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</a></h3>
<h4 id="åœ¨å‡½æ•°ä¸­ä½¿ç”¨"><a class="header" href="#åœ¨å‡½æ•°ä¸­ä½¿ç”¨">åœ¨å‡½æ•°ä¸­ä½¿ç”¨</a></h4>
<h4 id="åœ¨å‡½æ•°è¿”å›å€¼ä¸­ä½¿ç”¨"><a class="header" href="#åœ¨å‡½æ•°è¿”å›å€¼ä¸­ä½¿ç”¨">åœ¨å‡½æ•°è¿”å›å€¼ä¸­ä½¿ç”¨</a></h4>
<h5 id="åœ¨æ•°æ®ç»“æ„ä¸­ä½¿ç”¨"><a class="header" href="#åœ¨æ•°æ®ç»“æ„ä¸­ä½¿ç”¨">åœ¨æ•°æ®ç»“æ„ä¸­ä½¿ç”¨</a></h5>
<h2 id="å­¤å„¿è§„åˆ™"><a class="header" href="#å­¤å„¿è§„åˆ™">å­¤å„¿è§„åˆ™</a></h2>
<details id="admonition-å®šä¹‰æˆ–å®ç°è‡³å°‘æœ‰ä¸€ä¸ª" class="admonition info">
<summary class="admonition-title">
<p>å®šä¹‰æˆ–å®ç°ï¼Œè‡³å°‘æœ‰ä¸€ä¸ª</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å®šä¹‰æˆ–å®ç°è‡³å°‘æœ‰ä¸€ä¸ª"></a></p>
</summary>
<div>
<p>trait å’Œå®ç° trait çš„æ•°æ®ç±»å‹ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªæ˜¯åœ¨å½“å‰ crate ä¸­å®šä¹‰çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ ä¸èƒ½ä¸ºç¬¬ä¸‰æ–¹çš„ç±»å‹å®ç°ç¬¬ä¸‰æ–¹çš„ traitï¼Œå½“ä½ å°è¯•è¿™ä¹ˆåšæ—¶ï¼ŒRust ç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚</p>
</div>
</details>
<h2 id="å¸¸ç”¨trait"><a class="header" href="#å¸¸ç”¨trait">å¸¸ç”¨trait</a></h2>
<div id="admonition-å¸¸ç”¨traitåˆ†ç±»æ•´ç†" class="admonition info">
<div class="admonition-title">
<p>å¸¸ç”¨traitåˆ†ç±»æ•´ç†</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å¸¸ç”¨traitåˆ†ç±»æ•´ç†"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/14%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9A%E6%9C%89%E5%93%AA%E4%BA%9B%E5%BF%85%E9%A1%BB%E6%8E%8C%E6%8F%A1%E7%9A%84trait%EF%BC%9F.jpg" alt="14ï½œç±»å‹ç³»ç»Ÿï¼šæœ‰å“ªäº›å¿…é¡»æŒæ¡çš„traitï¼Ÿ" /></p>
</div>
</div>
<h3 id="å†…å­˜ç›¸å…³"><a class="header" href="#å†…å­˜ç›¸å…³">å†…å­˜ç›¸å…³</a></h3>
<details id="admonition-cloneä½¿ç”¨ç¤ºä¾‹" class="admonition info">
<summary class="admonition-title">
<p>Cloneä½¿ç”¨ç¤ºä¾‹</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-cloneä½¿ç”¨ç¤ºä¾‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Clone {
  fn clone(&amp;self) -&gt; Self;

  fn clone_from(&amp;mut self, source: &amp;Self) {
    *self = source.clone()
  }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-cloneä¸clone_from" class="admonition info">
<summary class="admonition-title">
<p>clone()ä¸clone_from()</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-cloneä¸clone_from"></a></p>
</summary>
<div>
<p>Clone trait æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œ clone() å’Œ clone_from() ï¼Œåè€…æœ‰ç¼ºçœå®ç°ï¼Œæ‰€ä»¥å¹³æ—¶æˆ‘ä»¬åªéœ€è¦å®ç° clone() æ–¹æ³•å³å¯ã€‚ä½ ä¹Ÿè®¸ä¼šç–‘æƒ‘ï¼Œè¿™ä¸ª clone_from() æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå› ä¸ºçœ‹èµ·æ¥ a.clone_from(&amp;b) ï¼Œå’Œ a = b.clone() æ˜¯ç­‰ä»·çš„ã€‚å…¶å®ä¸æ˜¯ï¼Œå¦‚æœ a å·²ç»å­˜åœ¨ï¼Œåœ¨ clone è¿‡ç¨‹ä¸­ä¼šåˆ†é…å†…å­˜ï¼Œé‚£ä¹ˆç”¨ a.clone_from(&amp;b) å¯ä»¥é¿å…å†…å­˜åˆ†é…ï¼Œæé«˜æ•ˆç‡ã€‚b.clone() æ˜¯ç­‰ä»·çš„ã€‚å…¶å®ä¸æ˜¯ï¼Œå¦‚æœ a å·²ç»å­˜åœ¨ï¼Œåœ¨ clone è¿‡ç¨‹ä¸­ä¼šåˆ†é…å†…å­˜ï¼Œé‚£ä¹ˆç”¨ a.clone_from(&amp;b) å¯ä»¥é¿å…å†…å­˜åˆ†é…ï¼Œæé«˜æ•ˆç‡ã€‚</p>
</div>
</details>
<details id="admonition-clone-trait-å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥å®ç°è¿™æ ·èƒ½ç®€åŒ–ä¸å°‘ä»£ç " class="admonition info">
<summary class="admonition-title">
<p>Clone trait å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥å®ç°ï¼Œè¿™æ ·èƒ½ç®€åŒ–ä¸å°‘ä»£ç </p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-clone-trait-å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥å®ç°è¿™æ ·èƒ½ç®€åŒ–ä¸å°‘ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">#[derive(Clone, Debug)]
struct Developer {
  name: String,
  age: u8,
  lang: Language
}

#[allow(dead_code)]
#[derive(Clone, Debug)]
enum Language {
  Rust,
  TypeScript,
  Elixir,
  Haskell
}

fn main() {
    let dev = Developer {
        name: &quot;Tyr&quot;.to_string(),
        age: 18,
        lang: Language::Rust
    };
    let dev1 = dev.clone();
    println!(&quot;dev: {:?}, addr of dev name: {:p}&quot;, dev, dev.name.as_str());
    println!(&quot;dev1: {:?}, addr of dev1 name: {:p}&quot;, dev1, dev1.name.as_str())
}
</code></pre></pre>
<hr />
<p>å¦‚æœæ²¡æœ‰ä¸º Language å®ç° Clone çš„è¯ï¼ŒDeveloper çš„æ´¾ç”Ÿå® Clone å°†ä¼šç¼–è¯‘å‡ºé”™ã€‚è¿è¡Œè¿™æ®µä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº nameï¼Œä¹Ÿå°±æ˜¯ String ç±»å‹çš„ Cloneï¼Œå…¶å †ä¸Šçš„å†…å­˜ä¹Ÿè¢« Clone äº†ä¸€ä»½ï¼Œæ‰€ä»¥ Clone æ˜¯æ·±åº¦æ‹·è´ï¼Œæ ˆå†…å­˜å’Œå †å†…å­˜ä¸€èµ·æ‹·è´ã€‚</p>
</div>
</details>
<details id="admonition-clone-æ–¹æ³•çš„æ¥å£æ˜¯-self" class="admonition info">
<summary class="admonition-title">
<p>clone æ–¹æ³•çš„æ¥å£æ˜¯ &amp;self</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-clone-æ–¹æ³•çš„æ¥å£æ˜¯-self"></a></p>
</summary>
<div>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œclone æ–¹æ³•çš„æ¥å£æ˜¯ &amp;selfï¼Œè¿™åœ¨ç»å¤§å¤šæ•°åœºåˆä¸‹éƒ½æ˜¯é€‚ç”¨çš„ï¼Œæˆ‘ä»¬åœ¨ clone ä¸€ä¸ªæ•°æ®æ—¶åªéœ€è¦æœ‰å·²æœ‰æ•°æ®çš„åªè¯»å¼•ç”¨ã€‚ä½†å¯¹ Rc è¿™æ ·åœ¨ clone() æ—¶ç»´æŠ¤å¼•ç”¨è®¡æ•°çš„æ•°æ®ç»“æ„ï¼Œclone() è¿‡ç¨‹ä¸­ä¼šæ”¹å˜è‡ªå·±ï¼Œæ‰€ä»¥è¦ç”¨ Cell è¿™æ ·æä¾›å†…éƒ¨å¯å˜æ€§çš„ç»“æ„æ¥è¿›è¡Œæ”¹å˜ï¼Œå¦‚æœä½ ä¹Ÿæœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼Œå¯ä»¥å‚è€ƒ</p>
</div>
</details>
<h4 id="copy"><a class="header" href="#copy">Copy</a></h4>
<details id="admonition-ä¸å¯å˜å¼•ç”¨å®ç°äº†-copyè€Œå¯å˜å¼•ç”¨-mut-t-æ²¡æœ‰å®ç°-copy" class="admonition info">
<summary class="admonition-title">
<p>ä¸å¯å˜å¼•ç”¨å®ç°äº† Copyï¼Œè€Œå¯å˜å¼•ç”¨ &amp;mut T æ²¡æœ‰å®ç° Copy</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ä¸å¯å˜å¼•ç”¨å®ç°äº†-copyè€Œå¯å˜å¼•ç”¨-mut-t-æ²¡æœ‰å®ç°-copy"></a></p>
</summary>
<div>
<p>ä¸å¯å˜å¼•ç”¨å®ç°äº† Copyï¼Œè€Œå¯å˜å¼•ç”¨ &amp;mut T æ²¡æœ‰å®ç° Copyã€‚ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·ï¼Ÿå› ä¸ºå¦‚æœå¯å˜å¼•ç”¨å®ç°äº† Copy traitï¼Œé‚£ä¹ˆç”Ÿæˆä¸€ä¸ªå¯å˜å¼•ç”¨ç„¶åæŠŠå®ƒèµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡æ—¶ï¼Œå°±ä¼šè¿èƒŒæ‰€æœ‰æƒè§„åˆ™ï¼š
åŒä¸€ä¸ªä½œç”¨åŸŸä¸‹åªèƒ½æœ‰ä¸€ä¸ªå¯å˜å¼•ç”¨ã€‚å¯è§ï¼ŒRust æ ‡å‡†åº“åœ¨å“ªäº›ç»“æ„å¯ä»¥ Copyã€å“ªäº›ä¸å¯ä»¥ Copy ä¸Šï¼Œæœ‰ç€ä»”ç»†çš„è€ƒé‡ã€‚</p>
</div>
</details>
<h4 id="drop"><a class="header" href="#drop">Drop</a></h4>
<details id="admonition-æœ‰ä¸¤ç§æƒ…å†µä½ å¯èƒ½éœ€è¦æ‰‹å·¥å®ç°-drop" class="admonition info">
<summary class="admonition-title">
<p>æœ‰ä¸¤ç§æƒ…å†µä½ å¯èƒ½éœ€è¦æ‰‹å·¥å®ç° Drop</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-æœ‰ä¸¤ç§æƒ…å†µä½ å¯èƒ½éœ€è¦æ‰‹å·¥å®ç°-drop"></a></p>
</summary>
<div>
<p>å¤§éƒ¨åˆ†åœºæ™¯æ— éœ€ä¸ºæ•°æ®ç»“æ„æä¾› Drop traitï¼Œç³»ç»Ÿé»˜è®¤ä¼šä¾æ¬¡å¯¹æ•°æ®ç»“æ„çš„æ¯ä¸ªåŸŸåš dropã€‚ä½†æœ‰ä¸¤ç§æƒ…å†µä½ å¯èƒ½éœ€è¦æ‰‹å·¥å®ç° Dropã€‚</p>
<ol>
<li>ç¬¬ä¸€ç§æ˜¯å¸Œæœ›åœ¨æ•°æ®ç»“æŸç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚è®°æ—¥å¿—ã€‚</li>
<li>ç¬¬äºŒç§æ˜¯éœ€è¦å¯¹èµ„æºå›æ”¶çš„åœºæ™¯ã€‚ç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“ä½ é¢å¤–ä½¿ç”¨äº†å“ªäº›èµ„æºï¼Œä¹Ÿå°±æ— æ³•å¸®åŠ©ä½  drop å®ƒä»¬ã€‚æ¯”å¦‚è¯´é”èµ„æºçš„é‡Šæ”¾ï¼Œ</li>
<li>åœ¨ MutexGuard ä¸­å®ç°äº† Drop æ¥é‡Šæ”¾é”èµ„æºï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">impl&lt;T: ?Sized&gt; Drop for MutexGuard&lt;'_, T&gt; {
    #[inline]
    fn drop(&amp;mut self) {
        unsafe {
            self.lock.poison.done(&amp;self.poison);
            self.lock.inner.raw_unlock();
        }
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-copyä¸dropäº’æ–¥" class="admonition info">
<summary class="admonition-title">
<p>Copyä¸Dropäº’æ–¥</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-copyä¸dropäº’æ–¥"></a></p>
</summary>
<div>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCopy trait å’Œ Drop trait æ˜¯äº’æ–¥çš„ï¼Œä¸¤è€…ä¸èƒ½å…±å­˜ï¼Œå½“ä½ å°è¯•ä¸ºåŒä¸€ç§æ•°æ®ç±»å‹å®ç° Copy æ—¶ï¼Œä¹Ÿå®ç° Dropï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥é”™ã€‚</p>
<blockquote>
<p>è¿™å…¶å®å¾ˆå¥½ç†è§£ï¼š</p>
</blockquote>
<ul>
<li>Copy æ˜¯æŒ‰ä½åšæµ…æ‹·è´ï¼Œé‚£ä¹ˆå®ƒä¼šé»˜è®¤æ‹·è´çš„æ•°æ®æ²¡æœ‰éœ€è¦é‡Šæ”¾çš„èµ„æºï¼›</li>
<li>è€Œ Drop æ°æ°æ˜¯ä¸ºäº†é‡Šæ”¾é¢å¤–çš„èµ„æºè€Œç”Ÿçš„ã€‚</li>
</ul>
<hr />
<p>è¾…åŠ©ç†è§£ï¼Œåœ¨ä»£ç ä¸­ï¼Œå¼ºè¡Œç”¨ Box::into_raw è·å¾—å †å†…å­˜çš„æŒ‡é’ˆï¼Œæ”¾å…¥ RawBuffer ç»“æ„ä¸­ï¼Œè¿™æ ·å°±æ¥ç®¡äº†è¿™å—å †å†…å­˜çš„é‡Šæ”¾ã€‚
è™½ç„¶ RawBuffer å¯ä»¥å®ç° Copy traitï¼Œä½†è¿™æ ·ä¸€æ¥å°±æ— æ³•å®ç° Drop traitã€‚
å¦‚æœç¨‹åºéè¦è¿™ä¹ˆå†™ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå› ä¸ºè¯¥é‡Šæ”¾çš„å †å†…å­˜æ²¡æœ‰é‡Šæ”¾ã€‚</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{fmt, slice};

// æ³¨æ„è¿™é‡Œï¼Œæˆ‘ä»¬å®ç°äº† Copyï¼Œè¿™æ˜¯å› ä¸º *mut u8/usize éƒ½æ”¯æŒ Copy
#[derive(Clone, Copy)]
struct RawBuffer {
    // è£¸æŒ‡é’ˆç”¨ *const / *mut æ¥è¡¨è¿°ï¼Œè¿™å’Œå¼•ç”¨çš„ &amp; ä¸åŒ
    ptr: *mut u8,
    len: usize,
}

impl From&lt;Vec&lt;u8&gt;&gt; for RawBuffer {
    fn from(vec: Vec&lt;u8&gt;) -&gt; Self {
        let slice = vec.into_boxed_slice();
        Self {
            len: slice.len(),
            // into_raw ä¹‹åï¼ŒBox å°±ä¸ç®¡è¿™å—å†…å­˜çš„é‡Šæ”¾äº†ï¼ŒRawBuffer éœ€è¦å¤„ç†é‡Šæ”¾
            ptr: Box::into_raw(slice) as *mut u8,
        }
    }
}

// å¦‚æœ RawBuffer å®ç°äº† Drop traitï¼Œå°±å¯ä»¥åœ¨æ‰€æœ‰è€…é€€å‡ºæ—¶é‡Šæ”¾å †å†…å­˜
// ç„¶åï¼ŒDrop trait ä¼šè·Ÿ Copy trait å†²çªï¼Œè¦ä¹ˆä¸å®ç° Copyï¼Œè¦ä¹ˆä¸å®ç° Drop
// å¦‚æœä¸å®ç° Dropï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œä½†å®ƒä¸ä¼šå¯¹æ­£ç¡®æ€§æœ‰ä»»ä½•ç ´å
// æ¯”å¦‚ä¸ä¼šå‡ºç° use after free è¿™æ ·çš„é—®é¢˜ã€‚
// ä½ å¯ä»¥è¯•ç€æŠŠä¸‹é¢æ³¨é‡Šå»æ‰ï¼Œçœ‹çœ‹ä¼šå‡ºä»€ä¹ˆé—®é¢˜
// impl Drop for RawBuffer {
//     #[inline]
//     fn drop(&amp;mut self) {
//         let data = unsafe { Box::from_raw(slice::from_raw_parts_mut(self.ptr, self.len)) };
//         drop(data)
//     }
// }

impl fmt::Debug for RawBuffer {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        let data = self.as_ref();
        write!(f, &quot;{:p}: {:?}&quot;, self.ptr, data)
    }
}

impl AsRef&lt;[u8]&gt; for RawBuffer {
    fn as_ref(&amp;self) -&gt; &amp;[u8] {
        unsafe { slice::from_raw_parts(self.ptr, self.len) }
    }
}

fn main() {
    let data = vec![1, 2, 3, 4];

    let buf: RawBuffer = data.into();

    // å› ä¸º buf å…è®¸ Copyï¼Œæ‰€ä»¥è¿™é‡Œ Copy äº†ä¸€ä»½
    use_buffer(buf);

    // buf è¿˜èƒ½ç”¨
    println!(&quot;buf: {:?}&quot;, buf);
}

fn use_buffer(buf: RawBuffer) {
    println!(&quot;buf to die: {:?}&quot;, buf);

    // è¿™é‡Œä¸ç”¨ç‰¹æ„ dropï¼Œå†™å‡ºæ¥åªæ˜¯ä¸ºäº†è¯´æ˜ Copy å‡ºæ¥çš„ buf è¢« Drop äº†
    drop(buf)
}
</code></pre></pre>
<hr />
<p>ä½†æ˜¯è¿™ä¸ªæ“ä½œä¸ä¼šç ´å Rust çš„æ­£ç¡®æ€§ä¿è¯ï¼šå³ä¾¿ä½  Copy äº† N ä»½ RawBufferï¼Œç”±äºæ— æ³•å®ç° Drop traitï¼ŒRawBuffer æŒ‡å‘çš„é‚£åŒä¸€å—å †å†…å­˜ä¸ä¼šé‡Šæ”¾ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç° use after free çš„å†…å­˜å®‰å…¨é—®é¢˜</p>
</div>
</details>
<details id="admonition-å¯¹äºä»£ç å®‰å…¨æ¥è¯´å†…å­˜æ³„æ¼å±å®³å¤§è¿˜æ˜¯-use-after-free-å±å®³å¤§å‘¢" class="admonition info">
<summary class="admonition-title">
<p>å¯¹äºä»£ç å®‰å…¨æ¥è¯´ï¼Œå†…å­˜æ³„æ¼å±å®³å¤§ï¼Ÿè¿˜æ˜¯ use after free å±å®³å¤§å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å¯¹äºä»£ç å®‰å…¨æ¥è¯´å†…å­˜æ³„æ¼å±å®³å¤§è¿˜æ˜¯-use-after-free-å±å®³å¤§å‘¢"></a></p>
</summary>
<div>
<p>å¯¹äºä»£ç å®‰å…¨æ¥è¯´ï¼Œå†…å­˜æ³„æ¼å±å®³å¤§ï¼Ÿè¿˜æ˜¯ use after free å±å®³å¤§å‘¢ï¼Ÿ</p>
<blockquote>
<p>è‚¯å®šæ˜¯åè€…ã€‚</p>
</blockquote>
<ul>
<li>Rust çš„åº•çº¿æ˜¯å†…å­˜å®‰å…¨ï¼Œæ‰€ä»¥ä¸¤å®³ç›¸æƒå–å…¶è½»ã€‚</li>
<li>å®é™…ä¸Šï¼Œä»»ä½•ç¼–ç¨‹è¯­è¨€éƒ½æ— æ³•ä¿è¯ä¸å‘ç”Ÿäººä¸ºçš„å†…å­˜æ³„æ¼</li>
<li>æ¯”å¦‚ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œå¼€å‘è€…ç–å¿½äº†ï¼Œå¯¹å“ˆå¸Œè¡¨åªæ·»åŠ ä¸åˆ é™¤ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚</li>
<li>ä½† Rust ä¼šä¿è¯å³ä½¿å¼€å‘è€…ç–å¿½äº†ï¼Œä¹Ÿä¸ä¼šå‡ºç°å†…å­˜å®‰å…¨é—®é¢˜ã€‚</li>
</ul>
</div>
</details>
<h3 id="æ ‡ç­¾trait"><a class="header" href="#æ ‡ç­¾trait">æ ‡ç­¾trait</a></h3>
<h4 id="sized"><a class="header" href="#sized">Sized</a></h4>
<details id="admonition-size-data-å’Œå¤„ç†-data-çš„å‡½æ•°-process_data" class="admonition info">
<summary class="admonition-title">
<p>Size: Data å’Œå¤„ç† Data çš„å‡½æ•° process_data</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-size-data-å’Œå¤„ç†-data-çš„å‡½æ•°-process_data"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
struct Data&lt;T&gt; {
    inner: T,
}

fn process_data&lt;T&gt;(data: Data&lt;T&gt;) {
    todo!();
}
</code></pre></pre>
<p>ç­‰ä»·äºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Data&lt;T: Sized&gt; {
    inner: T,
}

fn process_data&lt;T: Sized&gt;(data: Data&lt;T&gt;) {
    todo!();
}
</code></pre></pre>
<hr />
<p>å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›èƒ½è‡ªåŠ¨æ·»åŠ è¿™æ ·çš„çº¦æŸï¼Œå› ä¸ºè¿™æ ·å®šä¹‰å‡ºçš„æ³›å‹ç»“æ„ï¼Œåœ¨ç¼–è¯‘æœŸï¼Œå¤§å°æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªçº¦æŸï¼ŒT æ˜¯å¤§å°ä¸å›ºå®šçš„ç±»å‹ï¼Œ process_data å‡½æ•°ä¼šæ— æ³•ç¼–è¯‘ã€‚</p>
</div>
</details>
<details id="admonition-sized-åœ¨å°‘æ•°æƒ…å†µä¸‹éœ€è¦-t-æ˜¯å¯å˜ç±»å‹çš„" class="admonition info">
<summary class="admonition-title">
<p>?Sized: åœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦ T æ˜¯å¯å˜ç±»å‹çš„</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-sized-åœ¨å°‘æ•°æƒ…å†µä¸‹éœ€è¦-t-æ˜¯å¯å˜ç±»å‹çš„"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub enum Cow&lt;'a, B: ?Sized + 'a&gt; where B: ToOwned,
{
    // å€Ÿç”¨çš„æ•°æ®
    Borrowed(&amp;'a B),
    // æ‹¥æœ‰çš„æ•°æ®
    Owned(&lt;B as ToOwned&gt;::Owned),
}
</code></pre></pre>
<hr />
<p>è¿™æ · B å°±å¯ä»¥æ˜¯ [T] æˆ–è€… str ç±»å‹ï¼Œå¤§å°éƒ½æ˜¯ä¸å›ºå®šçš„ã€‚è¦æ³¨æ„ Borrowed(&amp;â€™a B) å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› ä¸ºå®ƒå†…éƒ¨æ˜¯å¯¹ B çš„ä¸€ä¸ªå¼•ç”¨ï¼Œè€Œå¼•ç”¨çš„å¤§å°æ˜¯å›ºå®šçš„</p>
</div>
</details>
<h4 id="sendsync"><a class="header" href="#sendsync">Send/Sync</a></h4>
<details id="admonition-è¿™ä¸¤ä¸ª-trait-éƒ½æ˜¯-unsafe-auto-trait" class="admonition info">
<summary class="admonition-title">
<p>è¿™ä¸¤ä¸ª trait éƒ½æ˜¯ unsafe auto trait</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-è¿™ä¸¤ä¸ª-trait-éƒ½æ˜¯-unsafe-auto-trait"></a></p>
</summary>
<div>
<p>è¿™ä¸¤ä¸ª trait éƒ½æ˜¯ unsafe auto trait:</p>
<ul>
<li>auto æ„å‘³ç€ç¼–è¯‘å™¨ä¼šåœ¨åˆé€‚çš„åœºåˆï¼Œè‡ªåŠ¨ä¸ºæ•°æ®ç»“æ„æ·»åŠ å®ƒä»¬çš„å®ç°</li>
<li>è€Œ unsafe ä»£è¡¨å®ç°çš„è¿™ä¸ª trait å¯èƒ½ä¼šè¿èƒŒ Rust çš„å†…å­˜å®‰å…¨å‡†åˆ™</li>
<li>å¦‚æœå¼€å‘è€…æ‰‹å·¥å®ç°è¿™ä¸¤ä¸ª trait ï¼Œè¦è‡ªå·±ä¸ºå®ƒä»¬çš„å®‰å…¨æ€§è´Ÿè´£ã€‚</li>
</ul>
</div>
</details>
<details id="admonition-sendsync-æ˜¯-rust-å¹¶å‘å®‰å…¨çš„åŸºç¡€" class="admonition info">
<summary class="admonition-title">
<p>Send/Sync æ˜¯ Rust å¹¶å‘å®‰å…¨çš„åŸºç¡€</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-sendsync-æ˜¯-rust-å¹¶å‘å®‰å…¨çš„åŸºç¡€"></a></p>
</summary>
<div>
<p>Send/Sync æ˜¯ Rust å¹¶å‘å®‰å…¨çš„åŸºç¡€ï¼š</p>
<ul>
<li>å¦‚æœä¸€ä¸ªç±»å‹ T å®ç°äº† Send traitï¼Œæ„å‘³ç€ T å¯ä»¥å®‰å…¨åœ°ä»ä¸€ä¸ªçº¿ç¨‹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æƒå¯ä»¥åœ¨çº¿ç¨‹é—´ç§»åŠ¨ã€‚</li>
<li>å¦‚æœä¸€ä¸ªç±»å‹ T å®ç°äº† Sync traitï¼Œåˆ™æ„å‘³ç€ &amp;T å¯ä»¥å®‰å…¨åœ°åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«ã€‚ä¸€ä¸ªç±»å‹ T æ»¡è¶³ Sync traitï¼Œå½“ä¸”ä»…å½“ &amp;T æ»¡è¶³ Send traitã€‚</li>
</ul>
</div>
</details>
<details id="admonition-sendsync-åœ¨çº¿ç¨‹å®‰å…¨ä¸­çš„ä½œç”¨" class="admonition info">
<summary class="admonition-title">
<p>Send/Sync åœ¨çº¿ç¨‹å®‰å…¨ä¸­çš„ä½œç”¨</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-sendsync-åœ¨çº¿ç¨‹å®‰å…¨ä¸­çš„ä½œç”¨"></a></p>
</summary>
<div>
<p>å¯¹äº Send/Sync åœ¨çº¿ç¨‹å®‰å…¨ä¸­çš„ä½œç”¨ï¼Œå¯ä»¥è¿™ä¹ˆçœ‹:</p>
<ol>
<li>å¦‚æœä¸€ä¸ªç±»å‹ T: Sendï¼Œé‚£ä¹ˆ T åœ¨æŸä¸ªçº¿ç¨‹ä¸­çš„ç‹¬å è®¿é—®æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›</li>
<li>å¦‚æœä¸€ä¸ªç±»å‹ T: Syncï¼Œé‚£ä¹ˆ T åœ¨çº¿ç¨‹é—´çš„åªè¯»å…±äº«æ˜¯å®‰å…¨çš„ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-ç»å¤§å¤šæ•°è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„éƒ½æ˜¯æ»¡è¶³-send--sync-çš„æ ‡å‡†åº“ä¸­ä¸æ”¯æŒ-send--sync-çš„æ•°æ®ç»“æ„ä¸»è¦æœ‰" class="admonition info">
<summary class="admonition-title">
<p>ç»å¤§å¤šæ•°è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„éƒ½æ˜¯æ»¡è¶³ Send / Sync çš„ã€‚æ ‡å‡†åº“ä¸­ï¼Œä¸æ”¯æŒ Send / Sync çš„æ•°æ®ç»“æ„ä¸»è¦æœ‰</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ç»å¤§å¤šæ•°è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„éƒ½æ˜¯æ»¡è¶³-send--sync-çš„æ ‡å‡†åº“ä¸­ä¸æ”¯æŒ-send--sync-çš„æ•°æ®ç»“æ„ä¸»è¦æœ‰"></a></p>
</summary>
<div>
<ol>
<li>è£¸æŒ‡é’ˆ *const T / *mut Tã€‚
å®ƒä»¬æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æ—¢ä¸æ˜¯ Send ä¹Ÿä¸æ˜¯ Syncã€‚</li>
<li>UnsafeCell ä¸æ”¯æŒ Syncã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•ä½¿ç”¨äº† Cell æˆ–è€… RefCell çš„æ•°æ®ç»“æ„ä¸æ”¯æŒ Syncã€‚</li>
<li>å¼•ç”¨è®¡æ•° Rc ä¸æ”¯æŒ Send ä¹Ÿä¸æ”¯æŒ Syncã€‚æ‰€ä»¥ Rc æ— æ³•è·¨çº¿ç¨‹ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-å°è¯•è·¨çº¿ç¨‹ä½¿ç”¨-rc--refcellä¼šå‘ç”Ÿä»€ä¹ˆ" class="admonition info">
<summary class="admonition-title">
<p>å°è¯•è·¨çº¿ç¨‹ä½¿ç”¨ Rc / RefCellï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å°è¯•è·¨çº¿ç¨‹ä½¿ç”¨-rc--refcellä¼šå‘ç”Ÿä»€ä¹ˆ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::{
    cell::RefCell,
    rc::Rc,
    sync::{Arc, Mutex},
    thread,
};

// Rc æ—¢ä¸æ˜¯ Sendï¼Œä¹Ÿä¸æ˜¯ Sync
#[allow(dead_code, unused_variables)]
fn rc_is_not_send_and_sync() {
    let a = Rc::new(1);
    let b = a.clone();
    let c = a.clone();

    println!(&quot;{:?} {:?} {:?}&quot;, a, b, c);

    // æ— æ³•ç¼–è¯‘é€šè¿‡
    // thread::spawn(move || {
    //     println!(&quot;c= {:?}&quot;, c);
    // });
}

#[allow(dead_code)]
fn refcell_is_send() {
    let a = RefCell::new(1);
    thread::spawn(move || {
        println!(&quot;a= {:?}&quot;, a);
    });
}

// RefCell ç°åœ¨æœ‰å¤šä¸ª Arc æŒæœ‰å®ƒï¼Œè™½ç„¶ Arc æ˜¯ Send/Syncï¼Œä½† RefCell ä¸æ˜¯ Sync
#[allow(dead_code, unused_variables)]
fn refcell_is_not_sync() {
    let a = Arc::new(RefCell::new(1));
    let b = a.clone();
    let c = a.clone();

    println!(&quot;{:?} {:?} {:?}&quot;, a, b, c);

    // æ— æ³•ç¼–è¯‘é€šè¿‡
    // thread::spawn(move || {
    //     println!(&quot;c= {:?}&quot;, c);
    // });
}

// Arc&lt;Mutext&lt;T&gt;&gt; å¯ä»¥å¤šçº¿ç¨‹å…±äº«ä¸”ä¿®æ”¹æ•°æ®
#[allow(dead_code)]
fn arc_mutext_is_send_sync() {
    let a = Arc::new(Mutex::new(1));
    let b = a.clone();
    let c = a.clone();
    let handle = thread::spawn(move || {
        let mut g = c.lock().unwrap();
        *g += 1;
    });

    {
        let mut g = b.lock().unwrap();
        *g += 1;
    }

    handle.join().unwrap();
    println!(&quot;a= {:?}&quot;, a);
}

// æ— æ³•ç¼–è¯‘é€šè¿‡
// fn mutex_guard_is_not_send() {
//     let mutex = Mutex::new(1);
//     let guard = mutex.lock().unwrap();
//     thread::spawn(|| {
//         println!(&quot;data= {:?}&quot;, guard);
//     });

//     thread::spawn(move || {
//         println!(&quot;data= {:?}&quot;, guard);
//     });
// }

fn main() {}
</code></pre></pre>
</div>
</details>
<details id="admonition-ç”¨åˆ°çš„stdthreadspawn" class="admonition info">
<summary class="admonition-title">
<p>ç”¨åˆ°çš„std::thread::spawn</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ç”¨åˆ°çš„stdthreadspawn"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt; 
where
    F: FnOnce() -&gt; T,
    F: Send + 'static,
    T: Send + 'static,
</code></pre></pre>
<hr />
<p>å®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œè¿™ä¸ªé—­åŒ…éœ€è¦ Send + â€™staticï¼š</p>
<ol>
<li>â€™static æ„æ€æ˜¯é—­åŒ…æ•è·çš„è‡ªç”±å˜é‡å¿…é¡»æ˜¯ä¸€ä¸ªæ‹¥æœ‰æ‰€æœ‰æƒçš„ç±»å‹ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ‹¥æœ‰é™æ€ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨ï¼›</li>
<li>Send æ„æ€æ˜¯ï¼Œè¿™äº›è¢«æ•è·è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒå¯ä»¥ä»ä¸€ä¸ªçº¿ç¨‹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</li>
</ol>
<blockquote>
<p>ä»è¿™ä¸ªæ¥å£ä¸Šï¼Œå¯ä»¥å¾—å‡ºç»“è®ºï¼šå¦‚æœåœ¨çº¿ç¨‹é—´ä¼ é€’ Rcï¼Œæ˜¯æ— æ³•ç¼–è¯‘é€šè¿‡çš„</p>
</blockquote>
</div>
</details>
<details id="admonition-rcä¸æ”¯æŒsendå’Œsync" class="admonition info">
<summary class="admonition-title">
<p>Rcä¸æ”¯æŒSendå’ŒSync</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-rcä¸æ”¯æŒsendå’Œsync"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// Rc æ—¢ä¸æ˜¯ Sendï¼Œä¹Ÿä¸æ˜¯ Sync
fn rc_is_not_send_and_sync() {
    let a = Rc::new(1);
    let b = a.clone();
    let c = a.clone();
    thread::spawn(move || {
        println!(&quot;c= {:?}&quot;, c);
    });
}
</code></pre></pre>
<hr />
<h2 id="-6"><a class="header" href="#-6"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/14%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9A%E6%9C%89%E5%93%AA%E4%BA%9B%E5%BF%85%E9%A1%BB%E6%8E%8C%E6%8F%A1%E7%9A%84trait%EF%BC%9F-4694742.jpg" alt="Rcä¸æ”¯æŒSend/Sync" /></a></h2>
<p><a href="https://doc.rust-lang.org/std/rc/struct.Rc.html#impl-Send">Rc çš„å®ç°ä¸æ”¯æŒ Send å’Œ Sync</a></p>
</div>
</details>
<details id="admonition-refcell-å¯ä»¥åœ¨çº¿ç¨‹é—´è½¬ç§»æ‰€æœ‰æƒä¹ˆ" class="admonition info">
<summary class="admonition-title">
<p>RefCell å¯ä»¥åœ¨çº¿ç¨‹é—´è½¬ç§»æ‰€æœ‰æƒä¹ˆï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-refcell-å¯ä»¥åœ¨çº¿ç¨‹é—´è½¬ç§»æ‰€æœ‰æƒä¹ˆ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">fn refcell_is_send() {
    let a = RefCell::new(1);
    thread::spawn(move || {
        println!(&quot;a= {:?}&quot;, a);
    });
}
</code></pre></pre>
<hr />
<blockquote>
<p><a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html#impl-Send">RefCell å®ç°äº† Sendï¼Œä½†æ²¡æœ‰å®ç° Sync</a></p>
</blockquote>
</div>
</details>
<details id="admonition-arcæ”¯æŒsendsync" class="admonition info">
<summary class="admonition-title">
<p>Arcæ”¯æŒSend/Sync</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-arcæ”¯æŒsendsync"></a></p>
</summary>
<div>
<blockquote>
<p><a href="https://doc.rust-lang.org/std/sync/struct.Arc.html#impl-Send">Arcæ”¯æŒSend/Sync</a></p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
// RefCell ç°åœ¨æœ‰å¤šä¸ª Arc æŒæœ‰å®ƒï¼Œè™½ç„¶ Arc æ˜¯ Send/Syncï¼Œä½† RefCell ä¸æ˜¯ Sync
fn refcell_is_not_sync() {
    let a = Arc::new(RefCell::new(1));
    let b = a.clone();
    let c = a.clone();
    thread::spawn(move || {
        println!(&quot;c= {:?}&quot;, c);
    });
}

</code></pre></pre>
<hr />
<p>å› ä¸º Arc å†…éƒ¨çš„æ•°æ®æ˜¯å…±äº«çš„ï¼Œéœ€è¦æ”¯æŒ Sync çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯ RefCell ä¸æ˜¯ Syncï¼Œç¼–è¯‘å¤±è´¥ã€‚</p>
</div>
</details>
<details id="admonition-åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æˆ‘ä»¬åªèƒ½ä½¿ç”¨æ”¯æŒ-sendsync-çš„-arc-å’Œ-mutex-ä¸€èµ·æ„é€ ä¸€ä¸ªå¯ä»¥åœ¨å¤šçº¿ç¨‹é—´å…±äº«ä¸”å¯ä»¥ä¿®æ”¹çš„ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªèƒ½ä½¿ç”¨æ”¯æŒ Send/Sync çš„ Arc ï¼Œå’Œ Mutex ä¸€èµ·ï¼Œæ„é€ ä¸€ä¸ªå¯ä»¥åœ¨å¤šçº¿ç¨‹é—´å…±äº«ä¸”å¯ä»¥ä¿®æ”¹çš„ç±»å‹</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æˆ‘ä»¬åªèƒ½ä½¿ç”¨æ”¯æŒ-sendsync-çš„-arc-å’Œ-mutex-ä¸€èµ·æ„é€ ä¸€ä¸ªå¯ä»¥åœ¨å¤šçº¿ç¨‹é—´å…±äº«ä¸”å¯ä»¥ä¿®æ”¹çš„ç±»å‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{
    sync::{Arc, Mutex},
    thread,
};

// Arc&lt;Mutex&lt;T&gt;&gt; å¯ä»¥å¤šçº¿ç¨‹å…±äº«ä¸”ä¿®æ”¹æ•°æ®
fn arc_mutext_is_send_sync() {
    let a = Arc::new(Mutex::new(1));
    let b = a.clone();
    let c = a.clone();
    let handle = thread::spawn(move || {
        let mut g = c.lock().unwrap();
        *g += 1;
    });

    {
        let mut g = b.lock().unwrap();
        *g += 1;
    }

    handle.join().unwrap();
    println!(&quot;a= {:?}&quot;, a);
}

fn main() {
    arc_mutext_is_send_sync();
}
</code></pre></pre>
<hr />
<p>æœ€åä¸€ä¸ªæ ‡è®° trait Unpinï¼Œæ˜¯ç”¨äºè‡ªå¼•ç”¨ç±»å‹çš„ï¼Œå±äºFuture traitã€‚</p>
</div>
</details>
<h3 id="ç±»å‹è½¬æ¢-1"><a class="header" href="#ç±»å‹è½¬æ¢-1">ç±»å‹è½¬æ¢</a></h3>
<details id="admonition-å¯¹æ¯”ä¸¤ç§è½¬åŒ–æ–¹å¼" class="admonition info">
<summary class="admonition-title">
<p>å¯¹æ¯”ä¸¤ç§è½¬åŒ–æ–¹å¼</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å¯¹æ¯”ä¸¤ç§è½¬åŒ–æ–¹å¼"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// ç¬¬ä¸€ç§æ–¹æ³•ï¼Œä¸ºæ¯ä¸€ç§è½¬æ¢æä¾›ä¸€ä¸ªæ–¹æ³•
// æŠŠå­—ç¬¦ä¸² s è½¬æ¢æˆ Path
let v = s.to_path();
// æŠŠå­—ç¬¦ä¸² s è½¬æ¢æˆ u64
let v = s.to_u64();

// ç¬¬äºŒç§æ–¹æ³•ï¼Œä¸º s å’Œè¦è½¬æ¢çš„ç±»å‹ä¹‹é—´å®ç°ä¸€ä¸ª Into&lt;T&gt; trait
// v çš„ç±»å‹æ ¹æ®ä¸Šä¸‹æ–‡å¾—å‡º
let v = s.into();
// æˆ–è€…ä¹Ÿå¯ä»¥æ˜¾å¼åœ°æ ‡æ³¨ v çš„ç±»å‹
let v: u64 = s.into();
</code></pre></pre>
<hr />
<p>æ˜¾ç„¶ï¼Œç¬¬äºŒç§æ–¹æ³•è¦æ›´å¥½ï¼Œå› ä¸ºå®ƒç¬¦åˆè½¯ä»¶å¼€å‘çš„å¼€é—­åŸåˆ™ï¼ˆOpen-Close Principleï¼‰ï¼Œ</p>
<blockquote>
<p>â€œè½¯ä»¶ä¸­çš„å¯¹è±¡ï¼ˆç±»ã€æ¨¡å—ã€å‡½æ•°ç­‰ç­‰ï¼‰å¯¹æ‰©å±•æ˜¯å¼€æ”¾çš„ï¼Œä½†æ˜¯å¯¹ä¿®æ”¹æ˜¯å°é—­çš„â€ã€‚</p>
</blockquote>
<ol>
<li>åœ¨ç¬¬ä¸€ç§æ–¹å¼ä¸‹ï¼Œæœªæ¥æ¯æ¬¡è¦æ·»åŠ å¯¹æ–°ç±»å‹çš„è½¬æ¢ï¼Œéƒ½è¦é‡æ–°ä¿®æ”¹ç±»å‹ T çš„å®ç°</li>
<li>è€Œç¬¬äºŒç§æ–¹å¼ï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ ä¸€ä¸ªå¯¹äºæ•°æ®è½¬æ¢ trait çš„æ–°å®ç°å³å¯ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-rust-æä¾›äº†ä¸¤å¥—ä¸åŒçš„-trait" class="admonition info">
<summary class="admonition-title">
<p>Rust æä¾›äº†ä¸¤å¥—ä¸åŒçš„ trait</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-rust-æä¾›äº†ä¸¤å¥—ä¸åŒçš„-trait"></a></p>
</summary>
<div>
<ol>
<li>å€¼ç±»å‹åˆ°å€¼ç±»å‹çš„è½¬æ¢ï¼šFrom / Into / TryFrom / TryInto</li>
<li>å¼•ç”¨ç±»å‹åˆ°å¼•ç”¨ç±»å‹çš„è½¬æ¢ï¼šAsRef / AsMut</li>
</ol>
</div>
</details>
<h4 id="frominto-å€¼åˆ°å€¼"><a class="header" href="#frominto-å€¼åˆ°å€¼">From/Into: å€¼åˆ°å€¼</a></h4>
<details id="admonition-è¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„æ€ä¹ˆé€‰å‘¢" class="admonition info">
<summary class="admonition-title">
<p>è¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼Œæ€ä¹ˆé€‰å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-è¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„æ€ä¹ˆé€‰å‘¢"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">let s = String::from(&quot;Hello world!&quot;);
let s: String = &quot;Hello world!&quot;.into();
</code></pre></pre>
<hr />
<p>è¿™ä¸¤ç§æ–¹å¼æ˜¯ç­‰ä»·çš„ï¼Œæ€ä¹ˆé€‰å‘¢ï¼Ÿ</p>
<ol>
<li>From å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡åšç±»å‹æ¨å¯¼ï¼Œä½¿ç”¨åœºæ™¯æ›´å¤šï¼›</li>
<li>è€Œä¸”å› ä¸ºå®ç°äº† From ä¼šè‡ªåŠ¨å®ç° Intoï¼Œåä¹‹ä¸ä¼šã€‚</li>
<li>æ‰€ä»¥éœ€è¦çš„æ—¶å€™ï¼Œä¸è¦å»å®ç° Intoï¼Œåªè¦å®ç° From å°±å¥½äº†ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-from-å’Œ-into-è¿˜æ˜¯è‡ªåçš„" class="admonition info">
<summary class="admonition-title">
<p>From å’Œ Into è¿˜æ˜¯è‡ªåçš„</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-from-å’Œ-into-è¿˜æ˜¯è‡ªåçš„"></a></p>
</summary>
<div>
<p>æŠŠç±»å‹ T çš„å€¼è½¬æ¢æˆç±»å‹ Tï¼Œä¼šç›´æ¥è¿”å›ã€‚è¿™æ˜¯å› ä¸ºæ ‡å‡†åº“æœ‰å¦‚ä¸‹çš„å®ç°ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
// Fromï¼ˆä»¥åŠ Intoï¼‰æ˜¯è‡ªåçš„
impl&lt;T&gt; From&lt;T&gt; for T {
    fn from(t: T) -&gt; T {
        t
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-æœ‰äº†-from-å’Œ-intoå¾ˆå¤šå‡½æ•°çš„æ¥å£å°±å¯ä»¥å˜å¾—çµæ´»" class="admonition info">
<summary class="admonition-title">
<p>æœ‰äº† From å’Œ Intoï¼Œå¾ˆå¤šå‡½æ•°çš„æ¥å£å°±å¯ä»¥å˜å¾—çµæ´»</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-æœ‰äº†-from-å’Œ-intoå¾ˆå¤šå‡½æ•°çš„æ¥å£å°±å¯ä»¥å˜å¾—çµæ´»"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::net::{IpAddr, Ipv4Addr, Ipv6Addr};

fn print(v: impl Into&lt;IpAddr&gt;) {
    println!(&quot;{:?}&quot;, v.into());
}

fn main() {
    let v4: Ipv4Addr = &quot;2.2.2.2&quot;.parse().unwrap();
    let v6: Ipv6Addr = &quot;::1&quot;.parse().unwrap();
    
    // IPAddr å®ç°äº† From&lt;[u8; 4]ï¼Œè½¬æ¢ IPv4 åœ°å€
    print([1, 1, 1, 1]);
    // IPAddr å®ç°äº† From&lt;[u16; 8]ï¼Œè½¬æ¢ IPv6 åœ°å€
    print([0xfe80, 0, 0, 0, 0xaede, 0x48ff, 0xfe00, 0x1122]);
    // IPAddr å®ç°äº† From&lt;Ipv4Addr&gt;
    print(v4);
    // IPAddr å®ç°äº† From&lt;Ipv6Addr&gt;
    print(v6);
}
</code></pre></pre>
<hr />
<p>å‡½æ•°å¦‚æœæ¥å—ä¸€ä¸ª IpAddr ä¸ºå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Into è®©æ›´å¤šçš„ç±»å‹å¯ä»¥è¢«è¿™ä¸ªå‡½æ•°ä½¿ç”¨
æ‰€ä»¥ï¼Œåˆç†åœ°ä½¿ç”¨ From / Intoï¼Œå¯ä»¥è®©ä»£ç å˜å¾—ç®€æ´ï¼Œç¬¦åˆ Rust å¯è¯»æ€§å¼ºçš„é£æ ¼ï¼Œæ›´ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</p>
</div>
</details>
<h4 id="tryfromtryinto-å€¼åˆ°å€¼å¯èƒ½å‡ºç°é”™è¯¯"><a class="header" href="#tryfromtryinto-å€¼åˆ°å€¼å¯èƒ½å‡ºç°é”™è¯¯">TryFrom/TryInto: å€¼åˆ°å€¼ï¼Œå¯èƒ½å‡ºç°é”™è¯¯</a></h4>
<p>æ³¨æ„ï¼Œå¦‚æœä½ çš„æ•°æ®ç±»å‹åœ¨è½¬æ¢è¿‡ç¨‹ä¸­æœ‰å¯èƒ½å‡ºç°é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ TryFrom å’Œ TryIntoï¼Œå®ƒä»¬çš„ç”¨æ³•å’Œ From / Into ä¸€æ ·ï¼Œåªæ˜¯ trait å†…å¤šäº†ä¸€ä¸ªå…³è”ç±»å‹ Errorï¼Œä¸”è¿”å›çš„ç»“æœæ˜¯ Resultã€‚</p>
<h4 id="asrefasmut-å¼•ç”¨åˆ°å¼•ç”¨"><a class="header" href="#asrefasmut-å¼•ç”¨åˆ°å¼•ç”¨">AsRef/AsMut: å¼•ç”¨åˆ°å¼•ç”¨</a></h4>
<details id="admonition-asrefasmutå®šä¹‰" class="admonition info">
<summary class="admonition-title">
<p>AsRef/AsMutå®šä¹‰</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-asrefasmutå®šä¹‰"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait AsRef&lt;T&gt; where T: ?Sized {
    fn as_ref(&amp;self) -&gt; &amp;T;
}

pub trait AsMut&lt;T&gt; where T: ?Sized {
    fn as_mut(&amp;mut self) -&gt; &amp;mut T;
}
</code></pre></pre>
<hr />
<p>åœ¨ trait çš„å®šä¹‰ä¸Šï¼Œéƒ½å…è®¸ T ä½¿ç”¨å¤§å°å¯å˜çš„ç±»å‹ï¼Œå¦‚ strã€[u8] ç­‰ã€‚
AsMut é™¤äº†ä½¿ç”¨å¯å˜å¼•ç”¨ç”Ÿæˆå¯å˜å¼•ç”¨å¤–ï¼Œå…¶å®ƒéƒ½å’Œ AsRef ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹çœ‹ AsRef</p>
</div>
</details>
<details id="admonition-ä½“éªŒä¸€ä¸‹-asref-çš„ä½¿ç”¨å’Œå®ç°" class="admonition info">
<summary class="admonition-title">
<p>ä½“éªŒä¸€ä¸‹ AsRef çš„ä½¿ç”¨å’Œå®ç°</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ä½“éªŒä¸€ä¸‹-asref-çš„ä½¿ç”¨å’Œå®ç°"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[allow(dead_code)]
enum Language {
    Rust,
    TypeScript,
    Elixir,
    Haskell,
}

impl AsRef&lt;str&gt; for Language {
    fn as_ref(&amp;self) -&gt; &amp;str {
        match self {
            Language::Rust =&gt; &quot;Rust&quot;,
            Language::TypeScript =&gt; &quot;TypeScript&quot;,
            Language::Elixir =&gt; &quot;Elixir&quot;,
            Language::Haskell =&gt; &quot;Haskell&quot;,
        }
    }
}

fn print_ref(v: impl AsRef&lt;str&gt;) {
    println!(&quot;{}&quot;, v.as_ref());
}

fn main() {
    let lang = Language::Rust;
    // &amp;str å®ç°äº† AsRef&lt;str&gt;
    print_ref(&quot;Hello world!&quot;);
    // String å®ç°äº† AsRef&lt;str&gt;
    print_ref(&quot;Hello world!&quot;.to_string());
    // æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ enum ä¹Ÿå®ç°äº† AsRef&lt;str&gt;
    print_ref(lang);
}
</code></pre></pre>
<hr />
</div>
</details>
<details id="admonition-vas_refclone" class="admonition info">
<summary class="admonition-title">
<p>v.as_ref().clone()</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-vas_refclone"></a></p>
</summary>
<div>
<p>é¢å¤–è¯´æ˜ä¸€ä¸‹çš„æ˜¯:
å¦‚æœä»£ç å‡ºç° v.as_ref().clone() è¿™æ ·çš„è¯­å¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ è¦å¯¹ v è¿›è¡Œå¼•ç”¨è½¬æ¢ï¼Œç„¶ååˆå¾—åˆ°äº†æ‹¥æœ‰æ‰€æœ‰æƒçš„å€¼ï¼Œé‚£ä¹ˆåº”è¯¥å®ç° Fromï¼Œç„¶ååš v.into()ã€‚</p>
</div>
</details>
<h3 id="æ“ä½œç¬¦ç›¸å…³-derefderefmut"><a class="header" href="#æ“ä½œç¬¦ç›¸å…³-derefderefmut">æ“ä½œç¬¦ç›¸å…³: Deref/DerefMut</a></h3>
<details id="admonition-derefderefmutå®šä¹‰åŠè¯´æ˜" class="admonition info">
<summary class="admonition-title">
<p>Deref/DerefMutå®šä¹‰åŠè¯´æ˜</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-derefderefmutå®šä¹‰åŠè¯´æ˜"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Deref {
    // è§£å¼•ç”¨å‡ºæ¥çš„ç»“æœç±»å‹
    type Target: ?Sized;
    fn deref(&amp;self) -&gt; &amp;Self::Target;
}

pub trait DerefMut: Deref {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target;
}
</code></pre></pre>
<hr />
<p>å¯ä»¥çœ‹åˆ°ï¼ŒDerefMut â€œç»§æ‰¿â€äº† Derefï¼Œåªæ˜¯å®ƒé¢å¤–æä¾›äº†ä¸€ä¸ª deref_mut æ–¹æ³•ï¼Œç”¨æ¥è·å–å¯å˜çš„è§£å¼•ç”¨ã€‚æ‰€ä»¥è¿™é‡Œé‡ç‚¹å­¦ä¹  Derefã€‚</p>
</div>
</details>
<details id="admonition-å¯¹äºæ™®é€šçš„å¼•ç”¨è§£å¼•ç”¨å¾ˆç›´è§‚" class="admonition info">
<summary class="admonition-title">
<p>å¯¹äºæ™®é€šçš„å¼•ç”¨ï¼Œè§£å¼•ç”¨å¾ˆç›´è§‚</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-å¯¹äºæ™®é€šçš„å¼•ç”¨è§£å¼•ç”¨å¾ˆç›´è§‚"></a></p>
</summary>
<div>
<blockquote>
<p>å¯¹äºæ™®é€šçš„å¼•ç”¨ï¼Œè§£å¼•ç”¨å¾ˆç›´è§‚ï¼Œå› ä¸ºå®ƒåªæœ‰ä¸€ä¸ªæŒ‡å‘å€¼çš„åœ°å€ï¼Œä»è¿™ä¸ªåœ°å€å¯ä»¥è·å–åˆ°æ‰€éœ€è¦çš„å€¼</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
let mut x = 42;
let y = &amp;mut x;
// è§£å¼•ç”¨ï¼Œå†…éƒ¨è°ƒç”¨ DerefMutï¼ˆå…¶å®ç°å°±æ˜¯ *selfï¼‰
*y += 1;
</code></pre></pre>
</div>
</details>
<details id="admonition-æ™ºèƒ½æŒ‡é’ˆæ¥è¯´æ‹¿ä»€ä¹ˆåŸŸæ¥è§£å¼•ç”¨å°±ä¸é‚£ä¹ˆç›´è§‚-çœ‹çœ‹rcå¦‚ä½•å®ç°deref" class="admonition info">
<summary class="admonition-title">
<p>æ™ºèƒ½æŒ‡é’ˆæ¥è¯´ï¼Œæ‹¿ä»€ä¹ˆåŸŸæ¥è§£å¼•ç”¨å°±ä¸é‚£ä¹ˆç›´è§‚, çœ‹çœ‹Rcå¦‚ä½•å®ç°Deref</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-æ™ºèƒ½æŒ‡é’ˆæ¥è¯´æ‹¿ä»€ä¹ˆåŸŸæ¥è§£å¼•ç”¨å°±ä¸é‚£ä¹ˆç›´è§‚-çœ‹çœ‹rcå¦‚ä½•å®ç°deref"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T: ?Sized&gt; Deref for Rc&lt;T&gt; {
    type Target = T;

    fn deref(&amp;self) -&gt; &amp;T {
        &amp;self.inner().value
    }
}
</code></pre></pre>
<hr />
<h2 id="å¯ä»¥çœ‹åˆ°å®ƒæœ€ç»ˆæŒ‡å‘äº†å †ä¸Šçš„-rcbox-å†…éƒ¨çš„-value-çš„åœ°å€ç„¶åå¦‚æœå¯¹å…¶è§£å¼•ç”¨çš„è¯å¾—åˆ°äº†-value-å¯¹åº”çš„å€¼ä»¥ä¸‹å›¾ä¸ºä¾‹æœ€ç»ˆæ‰“å°å‡º-v--1"><a class="header" href="#å¯ä»¥çœ‹åˆ°å®ƒæœ€ç»ˆæŒ‡å‘äº†å †ä¸Šçš„-rcbox-å†…éƒ¨çš„-value-çš„åœ°å€ç„¶åå¦‚æœå¯¹å…¶è§£å¼•ç”¨çš„è¯å¾—åˆ°äº†-value-å¯¹åº”çš„å€¼ä»¥ä¸‹å›¾ä¸ºä¾‹æœ€ç»ˆæ‰“å°å‡º-v--1">å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæœ€ç»ˆæŒ‡å‘äº†å †ä¸Šçš„ RcBox å†…éƒ¨çš„ value çš„åœ°å€ï¼Œç„¶åå¦‚æœå¯¹å…¶è§£å¼•ç”¨çš„è¯ï¼Œå¾—åˆ°äº† value å¯¹åº”çš„å€¼ã€‚ä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œæœ€ç»ˆæ‰“å°å‡º v = 1ã€‚</a></h2>
<p>ä»å›¾ä¸­è¿˜å¯ä»¥çœ‹åˆ°ï¼ŒDeref å’Œ DerefMut æ˜¯è‡ªåŠ¨è°ƒç”¨çš„ï¼Œ*b ä¼šè¢«å±•å¼€ä¸º *(b.deref())ã€‚</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/14%EF%BD%9C%E7%B1%BB%E5%9E%8B%E7%B3%BB%E7%BB%9F%EF%BC%9A%E6%9C%89%E5%93%AA%E4%BA%9B%E5%BF%85%E9%A1%BB%E6%8E%8C%E6%8F%A1%E7%9A%84trait%EF%BC%9F-4696029.jpg" alt="RcBoxè§£å¼•ç”¨" /></p>
</div>
</details>
<details id="admonition-åœ¨-rust-é‡Œç»å¤§å¤šæ•°æ™ºèƒ½æŒ‡é’ˆéƒ½å®ç°äº†-derefæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºè‡ªå·±çš„æ•°æ®ç»“æ„å®ç°-deref" class="admonition info">
<summary class="admonition-title">
<p>åœ¨ Rust é‡Œï¼Œç»å¤§å¤šæ•°æ™ºèƒ½æŒ‡é’ˆéƒ½å®ç°äº† Derefï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºè‡ªå·±çš„æ•°æ®ç»“æ„å®ç° Deref</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-åœ¨-rust-é‡Œç»å¤§å¤šæ•°æ™ºèƒ½æŒ‡é’ˆéƒ½å®ç°äº†-derefæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ºè‡ªå·±çš„æ•°æ®ç»“æ„å®ç°-deref"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::ops::{Deref, DerefMut};

#[derive(Debug)]
struct Buffer&lt;T&gt;(Vec&lt;T&gt;);

impl&lt;T&gt; Buffer&lt;T&gt; {
    pub fn new(v: impl Into&lt;Vec&lt;T&gt;&gt;) -&gt; Self {
        Self(v.into())
    }
}

impl&lt;T&gt; Deref for Buffer&lt;T&gt; {
    type Target = [T];

    fn deref(&amp;self) -&gt; &amp;Self::Target {
        &amp;self.0
    }
}

impl&lt;T&gt; DerefMut for Buffer&lt;T&gt; {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut Self::Target {
        &amp;mut self.0
    }
}

fn main() {
    let mut buf = Buffer::new([1, 3, 2, 4]);
    // å› ä¸ºå®ç°äº† Deref å’Œ DerefMutï¼Œè¿™é‡Œ buf å¯ä»¥ç›´æ¥è®¿é—® Vec&lt;T&gt; çš„æ–¹æ³•
    // ä¸‹é¢è¿™å¥ç›¸å½“äºï¼š(&amp;mut buf).deref_mut().sort()ï¼Œä¹Ÿå°±æ˜¯ (&amp;mut buf.0).sort()
    buf.sort();
    println!(&quot;buf: {:?}&quot;, buf);
}
</code></pre></pre>
<hr />
<p>ä½†æ˜¯åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæ•°æ®ç»“æ„ Buffer åŒ…è£¹ä½äº† Vecï¼Œä½†è¿™æ ·ä¸€æ¥ï¼ŒåŸæœ¬ Vec å®ç°äº†çš„å¾ˆå¤šæ–¹æ³•ï¼Œç°åœ¨ä½¿ç”¨èµ·æ¥å°±å¾ˆä¸æ–¹ä¾¿ï¼Œéœ€è¦ç”¨ buf.0 æ¥è®¿é—®ã€‚æ€ä¹ˆåŠï¼Ÿ
å¯ä»¥å®ç° Deref å’Œ DerefMutï¼Œè¿™æ ·åœ¨è§£å¼•ç”¨çš„æ—¶å€™ï¼Œç›´æ¥è®¿é—®åˆ° buf.0ï¼Œçœå»äº†ä»£ç çš„å•°å—¦å’Œæ•°æ®ç»“æ„å†…éƒ¨å­—æ®µçš„éšè—ã€‚</p>
</div>
</details>
<details id="admonition-ç¼–è¯‘å™¨é»˜è®¤å¼ºåˆ¶åšè§£å¼•ç”¨" class="admonition info">
<summary class="admonition-title">
<p>ç¼–è¯‘å™¨é»˜è®¤å¼ºåˆ¶åšè§£å¼•ç”¨</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-ç¼–è¯‘å™¨é»˜è®¤å¼ºåˆ¶åšè§£å¼•ç”¨"></a></p>
</summary>
<div>
<p>åœ¨ä¸Šé¢ä»£ç é‡Œï¼Œè¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼š
å†™ buf.sort() çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰åšè§£å¼•ç”¨çš„æ“ä½œï¼Œä¸ºä»€ä¹ˆä¼šç›¸å½“äºè®¿é—®äº† buf.0.sort() å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º sort() æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ &amp;mut selfï¼Œæ­¤æ—¶ Rust ç¼–è¯‘å™¨ä¼šå¼ºåˆ¶åš Deref/DerefMut çš„è§£å¼•ç”¨ï¼Œæ‰€ä»¥è¿™ç›¸å½“äº (*(&amp;mut buf)).sort()ã€‚</p>
</div>
</details>
<h3 id="å…¶ä»–debugdisplaydefault"><a class="header" href="#å…¶ä»–debugdisplaydefault">å…¶ä»–ï¼šDebug/Display/Default</a></h3>
<details id="admonition-debugdisplaydefalutå®šä¹‰" class="admonition info">
<summary class="admonition-title">
<p>Debug/Display/Defalutå®šä¹‰</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-debugdisplaydefalutå®šä¹‰"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Debug {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt;;
}

pub trait Display {
    fn fmt(&amp;self, f: &amp;mut Formatter&lt;'_&gt;) -&gt; Result&lt;(), Error&gt;;
}
</code></pre></pre>
<hr />
<p>å¯ä»¥çœ‹åˆ°ï¼ŒDebug å’Œ Display ä¸¤ä¸ª trait çš„ç­¾åä¸€æ ·ï¼Œéƒ½æ¥å—ä¸€ä¸ª &amp;self å’Œä¸€ä¸ª &amp;mut Formatterã€‚é‚£ä¸ºä»€ä¹ˆè¦æœ‰ä¸¤ä¸ªä¸€æ ·çš„ trait å‘¢ï¼Ÿ</p>
<h2 id="è¿™æ˜¯å› ä¸º-debug-æ˜¯ä¸ºå¼€å‘è€…è°ƒè¯•æ‰“å°æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„è€Œ-display-æ˜¯ç»™ç”¨æˆ·æ˜¾ç¤ºæ•°æ®ç»“æ„æ‰€è®¾è®¡çš„è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ-debug-trait-çš„å®ç°å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥ç”Ÿæˆè€Œ-display-å¿…é¡»æ‰‹å·¥å®ç°åœ¨ä½¿ç”¨çš„æ—¶å€™debug-ç”¨--æ¥æ‰“å°display-ç”¨--æ‰“å°"><a class="header" href="#è¿™æ˜¯å› ä¸º-debug-æ˜¯ä¸ºå¼€å‘è€…è°ƒè¯•æ‰“å°æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„è€Œ-display-æ˜¯ç»™ç”¨æˆ·æ˜¾ç¤ºæ•°æ®ç»“æ„æ‰€è®¾è®¡çš„è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ-debug-trait-çš„å®ç°å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥ç”Ÿæˆè€Œ-display-å¿…é¡»æ‰‹å·¥å®ç°åœ¨ä½¿ç”¨çš„æ—¶å€™debug-ç”¨--æ¥æ‰“å°display-ç”¨--æ‰“å°">è¿™æ˜¯å› ä¸º Debug æ˜¯ä¸ºå¼€å‘è€…è°ƒè¯•æ‰“å°æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ï¼Œè€Œ Display æ˜¯ç»™ç”¨æˆ·æ˜¾ç¤ºæ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Debug trait çš„å®ç°å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®ç›´æ¥ç”Ÿæˆï¼Œè€Œ Display å¿…é¡»æ‰‹å·¥å®ç°ã€‚åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼ŒDebug ç”¨ {:?} æ¥æ‰“å°ï¼ŒDisplay ç”¨ {} æ‰“å°ã€‚</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Default {
    fn default() -&gt; Self;
}
---
Default trait ç”¨äºä¸ºç±»å‹æä¾›ç¼ºçœå€¼ã€‚å®ƒä¹Ÿå¯ä»¥é€šè¿‡ derive å® #[derive(Default)] æ¥ç”Ÿæˆå®ç°ï¼Œå‰ææ˜¯ç±»å‹ä¸­çš„æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Default traitã€‚åœ¨åˆå§‹åŒ–ä¸€ä¸ªæ•°æ®ç»“æ„æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥éƒ¨åˆ†åˆå§‹åŒ–ï¼Œç„¶åå‰©ä½™çš„éƒ¨åˆ†ä½¿ç”¨ Default::default()ã€‚
</code></pre></pre>
</div>
</details>
<details id="admonition-debugdisplaydefaultç»Ÿä¸€ä½¿ç”¨ä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>Debug/Display/Defaultç»Ÿä¸€ä½¿ç”¨ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="2_type_system.html#admonition-debugdisplaydefaultç»Ÿä¸€ä½¿ç”¨ä¾‹å­"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::fmt;
// struct å¯ä»¥ derive Defaultï¼Œä½†æˆ‘ä»¬éœ€è¦æ‰€æœ‰å­—æ®µéƒ½å®ç°äº† Default
#[derive(Clone, Debug, Default)]
struct Developer {
    name: String,
    age: u8,
    lang: Language,
}

// enum ä¸èƒ½ derive Default
#[allow(dead_code)]
#[derive(Clone, Debug)]
enum Language {
    Rust,
    TypeScript,
    Elixir,
    Haskell,
}

// æ‰‹å·¥å®ç° Default
impl Default for Language {
    fn default() -&gt; Self {
        Language::Rust
    }
}

impl Developer {
    pub fn new(name: &amp;str) -&gt; Self {
        // ç”¨ ..Default::default() ä¸ºå‰©ä½™å­—æ®µä½¿ç”¨ç¼ºçœå€¼
        Self {
            name: name.to_owned(),
            ..Default::default()
        }
    }
}

impl fmt::Display for Developer {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(
            f,
            &quot;{}({} years old): {:?} developer&quot;,
            self.name, self.age, self.lang
        )
    }
}

fn main() {
    // ä½¿ç”¨ T::default()
    let dev1 = Developer::default();
    // ä½¿ç”¨ Default::default()ï¼Œä½†æ­¤æ—¶ç±»å‹æ— æ³•é€šè¿‡ä¸Šä¸‹æ–‡æ¨æ–­ï¼Œéœ€è¦æä¾›ç±»å‹
    let dev2: Developer = Default::default();
    // ä½¿ç”¨ T::new
    let dev3 = Developer::new(&quot;Tyr&quot;);
    println!(&quot;dev1: {}\\ndev2: {}\\ndev3: {:?}&quot;, dev1, dev2, dev3);
}
</code></pre></pre>
</div>
</details>
<h2 id="è®¾è®¡æ¶æ„"><a class="header" href="#è®¾è®¡æ¶æ„">è®¾è®¡æ¶æ„</a></h2>
<h3 id="é¡ºæ‰‹è‡ªç„¶"><a class="header" href="#é¡ºæ‰‹è‡ªç„¶">é¡ºæ‰‹è‡ªç„¶</a></h3>
<h3 id="æ¡¥æ¥"><a class="header" href="#æ¡¥æ¥">æ¡¥æ¥</a></h3>
<h3 id="æ§åˆ¶åè½¬"><a class="header" href="#æ§åˆ¶åè½¬">æ§åˆ¶åè½¬</a></h3>
<h3 id="solidåŸåˆ™"><a class="header" href="#solidåŸåˆ™">SOLIDåŸåˆ™</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="iii-æ•°æ®ç»“æ„"><a class="header" href="#iii-æ•°æ®ç»“æ„">III. æ•°æ®ç»“æ„</a></h1>
<!--ts-->
<ul>
<li><a href="3_data_structure.html#iii-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">III. æ•°æ®ç»“æ„</a>
<ul>
<li><a href="3_data_structure.html#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%BF%AB%E9%80%9F%E4%B8%80%E8%A7%88">æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ</a></li>
<li><a href="3_data_structure.html#%E5%88%86%E7%B1%BB%E5%9B%BE">åˆ†ç±»å›¾</a></li>
</ul>
</li>
<li><a href="3_data_structure.html#%E4%B8%80%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88">ä¸€ã€æ™ºèƒ½æŒ‡é’ˆ</a>
<ul>
<li><a href="3_data_structure.html#%E6%8C%87%E9%92%88%E8%BF%98%E6%98%AF%E5%BC%95%E7%94%A8">æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨</a></li>
<li><a href="3_data_structure.html#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E4%B8%8D%E4%BB%85%E6%98%AF%E6%8C%87%E9%92%88">æ™ºèƒ½æŒ‡é’ˆä¸ä»…æ˜¯æŒ‡é’ˆ</a></li>
<li><a href="3_data_structure.html#box-%E5%9C%A8%E5%A0%86%E4%B8%8A%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98">Box: åœ¨å †ä¸Šåˆ†é…å†…å­˜</a>
<ul>
<li><a href="3_data_structure.html#%E5%AE%9E%E7%8E%B0%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8">å®ç°å†…å­˜åˆ†é…å™¨</a></li>
<li><a href="3_data_structure.html#%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E9%87%8A%E6%94%BE">å†…å­˜å¦‚ä½•é‡Šæ”¾</a></li>
</ul>
</li>
<li><a href="3_data_structure.html#cowa-b-%E5%86%99%E6%97%B6%E6%8B%B7%E8%B4%9D">Cow&lt;â€™a, B&gt;ï¼š å†™æ—¶æ‹·è´</a>
<ul>
<li><a href="3_data_structure.html#%E5%AE%9A%E4%B9%89">å®šä¹‰</a></li>
<li><a href="3_data_structure.html#%E4%B8%A4%E4%B8%AAtraittoownedborrowed">ä¸¤ä¸ªtraitï¼šToOwnedã€Borrowed</a></li>
<li><a href="3_data_structure.html#toowned">ToOwned</a></li>
<li><a href="3_data_structure.html#%E5%8C%B9%E9%85%8D%E5%88%86%E5%8F%91">åŒ¹é…åˆ†å‘</a></li>
<li><a href="3_data_structure.html#cow%E5%9C%A8%E9%9C%80%E8%A6%81%E6%97%B6%E6%89%8D%E8%BF%9B%E8%A1%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E6%8B%B7%E8%B4%9D">Cowåœ¨éœ€è¦æ—¶æ‰è¿›è¡Œå†…å­˜åˆ†é…æ‹·è´</a></li>
</ul>
</li>
<li><a href="3_data_structure.html#mutexguard-%E6%95%B0%E6%8D%AE%E5%8A%A0%E9%94%81">MutexGuardï¼š æ•°æ®åŠ é”</a>
<ul>
<li><a href="3_data_structure.html#mutexguard%E4%B8%8Estringboxcowa-b%E7%9A%84%E5%AF%B9%E6%AF%94">MutexGuardä¸Stringã€Boxã€Cow&lt;â€™a, B&gt;çš„å¯¹æ¯”</a></li>
<li><a href="3_data_structure.html#%E4%BD%BF%E7%94%A8mutexlock%E8%8E%B7%E5%8F%96">ä½¿ç”¨Mutex::lockè·å–</a></li>
<li><a href="3_data_structure.html#%E5%AE%9A%E4%B9%89%E4%B8%8Ederefdrop-trait%E5%AE%9E%E7%8E%B0">å®šä¹‰ä¸Derefã€Drop traitå®ç°</a></li>
<li><a href="3_data_structure.html#%E4%BD%BF%E7%94%A8mutex_mutexguard%E7%9A%84%E4%BE%8B%E5%AD%90">ä½¿ç”¨Mutex_MutexGuardçš„ä¾‹å­</a></li>
</ul>
</li>
<li><a href="3_data_structure.html#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88">è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ</a></li>
</ul>
</li>
<li><a href="3_data_structure.html#%E4%BA%8C%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8">äºŒã€é›†åˆå®¹å™¨</a>
<ul>
<li><a href="3_data_structure.html#%E5%AF%B9%E5%AE%B9%E5%99%A8%E8%BF%9B%E8%A1%8C%E5%AE%9A%E4%B9%89">å¯¹å®¹å™¨è¿›è¡Œå®šä¹‰</a></li>
<li><a href="3_data_structure.html#%E5%AF%B9%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E8%BF%9B%E8%A1%8C%E5%AE%9A%E4%B9%89">å¯¹é›†åˆå®¹å™¨è¿›è¡Œå®šä¹‰</a></li>
<li><a href="3_data_structure.html#%E5%88%87%E7%89%87">åˆ‡ç‰‡</a>
<ul>
<li><a href="3_data_structure.html#array-vs-vector">array vs vector</a></li>
<li>[Vec å’Œ &amp;[T]](#vec-å’Œ-t)</li>
<li><a href="3_data_structure.html#%E8%A7%A3%E5%BC%95%E7%94%A8">è§£å¼•ç”¨</a></li>
<li><a href="3_data_structure.html#%E5%88%87%E7%89%87%E5%92%8C%E8%BF%AD%E4%BB%A3%E5%99%A8-iterator">åˆ‡ç‰‡å’Œè¿­ä»£å™¨ Iterator</a></li>
<li><a href="3_data_structure.html#%E7%89%B9%E6%AE%8A%E7%9A%84%E5%88%87%E7%89%87str">ç‰¹æ®Šçš„åˆ‡ç‰‡ï¼š&amp;str</a></li>
<li>[Box&lt;[T]&gt;](#boxt)</li>
<li><a href="3_data_structure.html#%E5%B8%B8%E7%94%A8%E5%88%87%E7%89%87%E5%AF%B9%E6%AF%94%E5%9B%BE">å¸¸ç”¨åˆ‡ç‰‡å¯¹æ¯”å›¾</a></li>
</ul>
</li>
<li><a href="3_data_structure.html#%E5%93%88%E5%B8%8C%E8%A1%A8">å“ˆå¸Œè¡¨</a>
<ul>
<li><a href="3_data_structure.html#%E5%93%88%E5%B8%8C%E8%A1%A8%E8%BF%98%E6%98%AF%E5%88%97%E8%A1%A8">å“ˆå¸Œè¡¨è¿˜æ˜¯åˆ—è¡¨</a></li>
<li><a href="3_data_structure.html#rust-%E7%9A%84%E5%93%88%E5%B8%8C%E8%A1%A8">Rust çš„å“ˆå¸Œè¡¨</a></li>
</ul>
</li>
<li><a href="3_data_structure.html#-1"><a target="_blank" rel="noopener noreferrer nofollow" href="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882967.jpg"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882967.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" style="max-width: 100%;"></a>
</a>
<ul>
<li><a href="3_data_structure.html#hashmap-%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">HashMap çš„æ•°æ®ç»“æ„</a></li>
<li><a href="3_data_structure.html#hashmap-%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">HashMap çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</a></li>
<li><a href="3_data_structure.html#hashmap-%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80">HashMap çš„å†…å­˜å¸ƒå±€</a></li>
<li><a href="3_data_structure.html#ctrl-%E8%A1%A8">ctrl è¡¨</a></li>
<li><a href="3_data_structure.html#%E5%93%88%E5%B8%8C%E8%A1%A8%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D%E4%B8%8E%E5%A2%9E%E9%95%BF">å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿</a></li>
<li><a href="3_data_structure.html#%E5%88%A0%E9%99%A4%E4%B8%80%E4%B8%AA%E5%80%BC">åˆ é™¤ä¸€ä¸ªå€¼</a></li>
<li><a href="3_data_structure.html#%E8%AE%A9%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%81%9A-hash-key">è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš Hash key</a></li>
<li><a href="3_data_structure.html#hashset--btreemap--btreeset">HashSet / BTreeMap / BTreeSet</a></li>
<li><a href="3_data_structure.html#%E4%B8%BA%E4%BB%80%E4%B9%88-rust-%E7%9A%84-hashmap-%E8%A6%81%E7%BC%BA%E7%9C%81%E9%87%87%E7%94%A8%E5%8A%A0%E5%AF%86%E5%AE%89%E5%85%A8%E7%9A%84%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95">ä¸ºä»€ä¹ˆ Rust çš„ HashMap è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Ÿ</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="3_data_structure.html#%E4%B8%89%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">ä¸‰ã€é”™è¯¯å¤„ç†</a>
<ul>
<li><a href="3_data_structure.html#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%8C%85%E5%90%AB%E8%BF%99%E4%B9%88%E5%87%A0%E9%83%A8%E5%88%86">é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†</a></li>
<li><a href="3_data_structure.html#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%BB%E6%B5%81%E6%96%B9%E6%B3%95">é”™è¯¯å¤„ç†çš„ä¸»æµæ–¹æ³•</a></li>
<li><a href="3_data_structure.html#rust-%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">Rust çš„é”™è¯¯å¤„ç†</a>
<ul>
<li><a href="3_data_structure.html#rust-%E5%81%B7%E5%B8%88-haskell%E6%9E%84%E5%BB%BA%E4%BA%86%E5%AF%B9%E6%A0%87-maybe-%E7%9A%84-option-%E7%B1%BB%E5%9E%8B%E5%92%8C-%E5%AF%B9%E6%A0%87-either-%E7%9A%84-result-%E7%B1%BB%E5%9E%8B">Rust å·å¸ˆ Haskellï¼Œæ„å»ºäº†å¯¹æ ‡ Maybe çš„ Option ç±»å‹å’Œ å¯¹æ ‡ Either çš„ Result ç±»å‹ã€‚</a></li>
<li><a href="3_data_structure.html#-%E6%93%8D%E4%BD%9C%E7%AC%A6">? æ“ä½œç¬¦</a></li>
<li><a href="3_data_structure.html#%E5%87%BD%E6%95%B0%E5%BC%8F%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">å‡½æ•°å¼é”™è¯¯å¤„ç†</a></li>
<li><a href="3_data_structure.html#panic-%E5%92%8C-catch_unwind">panic! å’Œ catch_unwind</a></li>
<li><a href="3_data_structure.html#error-trait-%E5%92%8C%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BD%AC%E6%8D%A2">Error trait å’Œé”™è¯¯ç±»å‹çš„è½¬æ¢</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="3_data_structure.html#%E5%9B%9B%E9%97%AD%E5%8C%85%E7%BB%93%E6%9E%84">å››ã€é—­åŒ…ç»“æ„</a>
<ul>
<li><a href="3_data_structure.html#%E9%97%AD%E5%8C%85%E7%9A%84%E5%AE%9A%E4%B9%89">é—­åŒ…çš„å®šä¹‰</a></li>
<li><a href="3_data_structure.html#%E9%97%AD%E5%8C%85%E6%9C%AC%E8%B4%A8%E4%B8%8A%E6%98%AF%E4%BB%80%E4%B9%88">é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="3_data_structure.html#%E4%B8%8D%E5%90%8C%E8%AF%AD%E8%A8%80%E7%9A%84%E9%97%AD%E5%8C%85%E8%AE%BE%E8%AE%A1">ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡</a></li>
<li><a href="3_data_structure.html#rust-%E7%9A%84%E9%97%AD%E5%8C%85%E7%B1%BB%E5%9E%8B">Rust çš„é—­åŒ…ç±»å‹</a>
<ul>
<li><a href="3_data_structure.html#fnonce">FnOnce</a></li>
<li><a href="3_data_structure.html#%E6%80%8E%E4%B9%88%E7%90%86%E8%A7%A3-fnonce-%E7%9A%84-args-%E6%B3%9B%E5%9E%8B%E5%8F%82%E6%95%B0%E5%91%A2">æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ</a></li>
<li><a href="3_data_structure.html#fnmut">FnMut</a></li>
<li><a href="3_data_structure.html#fn">Fn</a></li>
<li><a href="3_data_structure.html#%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B%E4%B8%89%E7%A7%8D%E9%97%AD%E5%8C%85%E4%BD%BF%E7%94%A8%E7%9A%84%E6%83%85%E5%86%B5%E4%BB%A5%E5%8F%8A%E5%AE%83%E4%BB%AC%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB">æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»</a></li>
</ul>
</li>
<li><a href="3_data_structure.html#%E9%97%AD%E5%8C%85%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">é—­åŒ…çš„ä½¿ç”¨åœºæ™¯</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:43:59 UTC 2022 -->
<!--te-->
<h2 id="æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ"><a class="header" href="#æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ">æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ</a></h2>
<div id="admonition-æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ" class="admonition tip">
<div class="admonition-title">
<p>æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ•°æ®ç»“æ„å¿«é€Ÿä¸€è§ˆ"></a></p>
</div>
<div>
<blockquote>
<p>ç”¨40åˆ†é’Ÿçš„æ—¶é—´ï¼Œæ€»ç»“äº†Rustçš„ä¸»è¦æ•°æ®ç»“æ„çš„å†… å­˜å¸ƒå±€ã€‚å®ƒèƒ½å˜æ¸…â€œæ•°æ®æ˜¯å¦‚ä½•åœ¨å †å’Œæ ˆä¸Šå­˜å‚¨â€œçš„æ€è·¯ï¼Œåœ¨è¿™é‡Œä¹Ÿæ¨èç»™ä½ ã€‚
<a href="https://www.youtube.com/watch?v=rDoqT-a6UFg">Visualizing memory layout of Rustâ€™s data types - YouTube</a></p>
</blockquote>
</div>
</div>
<h2 id="åˆ†ç±»å›¾"><a class="header" href="#åˆ†ç±»å›¾">åˆ†ç±»å›¾</a></h2>
<blockquote>
<p>æ•°æ®ç»“æ„å¯ä»¥çœ‹ä½œå¯¹äºç±»å‹ç³»ç»Ÿçš„è¿›ä¸€æ­¥æ•´ç†ï¼Œç»“æ„åŒ–ã€‚è¿™å…¶å®æ˜¯è¿›ä¸€æ­¥æŠ½è±¡ï¼Œä»ç±»å‹ä¸­æå–å‡ºæ—¥å¸¸å¸¸ç”¨çš„å·¥å…·å¹¶åˆ†ç±»ã€‚</p>
</blockquote>
<div id="admonition-ä»ç³»ç»Ÿå®¹å™¨åŸç”Ÿä¸‰ä¸ªçº¬åº¦åˆ†ç±»" class="admonition info">
<div class="admonition-title">
<p>ä»ç³»ç»Ÿ/å®¹å™¨/åŸç”Ÿä¸‰ä¸ªçº¬åº¦åˆ†ç±»</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä»ç³»ç»Ÿå®¹å™¨åŸç”Ÿä¸‰ä¸ªçº¬åº¦åˆ†ç±»"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F.jpg" alt="" /></p>
</div>
</div>
<h1 id="ä¸€æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#ä¸€æ™ºèƒ½æŒ‡é’ˆ">ä¸€ã€æ™ºèƒ½æŒ‡é’ˆ</a></h1>
<h2 id="æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨"><a class="header" href="#æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨">æŒ‡é’ˆè¿˜æ˜¯å¼•ç”¨</a></h2>
<details id="admonition-å¼•ç”¨æ˜¯ç‰¹æ®Šçš„æŒ‡é’ˆ" class="admonition info">
<summary class="admonition-title">
<p>å¼•ç”¨æ˜¯ç‰¹æ®Šçš„æŒ‡é’ˆ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å¼•ç”¨æ˜¯ç‰¹æ®Šçš„æŒ‡é’ˆ"></a></p>
</summary>
<div>
<ol>
<li>æŒ‡é’ˆæ˜¯ä¸€ä¸ªæŒæœ‰å†…å­˜åœ°å€çš„å€¼ï¼Œå¯ä»¥é€šè¿‡è§£å¼•ç”¨æ¥è®¿é—®å®ƒæŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œç†è®ºä¸Šå¯ä»¥è§£å¼•ç”¨åˆ°ä»»æ„æ•°æ®ç±»å‹ï¼›</li>
<li>å¼•ç”¨æ˜¯ä¸€ä¸ªç‰¹æ®Š çš„æŒ‡é’ˆï¼Œå®ƒçš„è§£å¼•ç”¨è®¿é—®æ˜¯å—é™çš„ï¼Œåªèƒ½è§£å¼•ç”¨åˆ°å®ƒå¼•ç”¨æ•°æ®çš„ç±»å‹ï¼Œä¸èƒ½ç”¨ä½œå®ƒç”¨ã€‚</li>
</ol>
</div>
</details>
<h2 id="æ™ºèƒ½æŒ‡é’ˆä¸ä»…æ˜¯æŒ‡é’ˆ"><a class="header" href="#æ™ºèƒ½æŒ‡é’ˆä¸ä»…æ˜¯æŒ‡é’ˆ">æ™ºèƒ½æŒ‡é’ˆä¸ä»…æ˜¯æŒ‡é’ˆ</a></h2>
<details id="admonition-æ™ºèƒ½æŒ‡é’ˆæŒ‡é’ˆé¢å¤–å¤„ç†èƒ½åŠ›" class="admonition info">
<summary class="admonition-title">
<p>æ™ºèƒ½æŒ‡é’ˆ=æŒ‡é’ˆ+é¢å¤–å¤„ç†èƒ½åŠ›</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ™ºèƒ½æŒ‡é’ˆæŒ‡é’ˆé¢å¤–å¤„ç†èƒ½åŠ›"></a></p>
</summary>
<div>
<ol>
<li>åœ¨æŒ‡é’ˆå’Œå¼•ç”¨çš„åŸºç¡€ä¸Šï¼ŒRust å·å¸ˆ C++ï¼Œæä¾›äº†æ™ºèƒ½æŒ‡é’ˆã€‚</li>
<li>æ™ºèƒ½æŒ‡é’ˆæ˜¯ä¸€ä¸ªè¡¨ç°è¡Œä¸ºå¾ˆ åƒæŒ‡é’ˆçš„æ•°æ®ç»“æ„ï¼Œä½†é™¤äº†æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆå¤–ï¼Œå®ƒè¿˜æœ‰å…ƒæ•°æ®ä»¥æä¾›é¢å¤–çš„å¤„ç†èƒ½åŠ›ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-æ™ºèƒ½æŒ‡é’ˆèƒ–æŒ‡é’ˆæ‰€æœ‰æƒ" class="admonition info">
<summary class="admonition-title">
<p>æ™ºèƒ½æŒ‡é’ˆ=èƒ–æŒ‡é’ˆ+æ‰€æœ‰æƒ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ™ºèƒ½æŒ‡é’ˆèƒ–æŒ‡é’ˆæ‰€æœ‰æƒ"></a></p>
</summary>
<div>
<ol>
<li>æ™ºèƒ½æŒ‡é’ˆä¸€å®šæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œä½†èƒ–æŒ‡é’ˆä¸ä¸€å®šæ˜¯ä¸€ä¸ª æ™ºèƒ½æŒ‡é’ˆã€‚</li>
<li>æ¯”å¦‚ &amp;str å°±åªæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œå®ƒæœ‰æŒ‡å‘å †å†…å­˜å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼ŒåŒæ—¶è¿˜æœ‰å…³äºå­— ç¬¦ä¸²é•¿åº¦çš„å…ƒæ•°æ®ã€‚</li>
</ol>
<h2 id="-7"><a class="header" href="#-7"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/15%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BF%99%E4%BA%9B%E6%B5%93%E7%9C%89%E5%A4%A7%E7%9C%BC%E7%9A%84%E7%BB%93%E6%9E%84%E7%AB%9F%E7%84%B6%E9%83%BD%E6%98%AF%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9F.jpg" alt="" /></a></h2>
<ol>
<li>String é™¤äº†å¤šä¸€ä¸ª capacity å­—æ®µï¼Œä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šã€‚</li>
<li>ä½† String å¯¹ å †ä¸Šçš„å€¼æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;str æ˜¯æ²¡æœ‰æ‰€æœ‰æƒçš„</li>
<li>è¿™æ˜¯ Rust ä¸­æ™ºèƒ½æŒ‡é’ˆå’Œæ™®é€šèƒ–æŒ‡é’ˆçš„åŒº åˆ«ã€‚</li>
</ol>
</div>
</details>
<details id="admonition-æ™ºèƒ½æŒ‡é’ˆå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«" class="admonition info">
<summary class="admonition-title">
<p>æ™ºèƒ½æŒ‡é’ˆå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ™ºèƒ½æŒ‡é’ˆå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«"></a></p>
</summary>
<div>
<ol>
<li>Stringç”¨ç»“æ„ä½“å®šä¹‰ï¼Œå…¶å®å°±æ˜¯Vec<u8></li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>pub struct String {
    vec: Vec&lt;u8&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<ol start="2">
<li>å’Œæ™®é€šçš„ç»“æ„ä½“ä¸åŒçš„æ˜¯ï¼Œ<a href="https://doc.rust-lang.org/src/alloc/string.rs.html#2301-2316">String å®ç°äº† Deref å’Œ DerefMut</a>ï¼Œè¿™ä½¿å¾—å®ƒåœ¨è§£å¼•ç”¨çš„æ—¶
å€™ï¼Œä¼šå¾—åˆ° &amp;str</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>impl ops::Deref for String {
    type Target = str;

    fn deref(&amp;self) -&gt; &amp;str {
        unsafe { str::from_utf8_unchecked(&amp;self.vec) }
    }
}

impl ops::DerefMut for String {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut str {
        unsafe { str::from_utf8_unchecked_mut(&amp;mut *self.vec) }
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol start="3">
<li>å¦å¤–ï¼Œç”±äºåœ¨å †ä¸Šåˆ†é…äº†æ•°æ®ï¼ŒString è¿˜éœ€è¦ä¸ºå…¶åˆ†é…çš„èµ„æºåšç›¸åº”çš„å›æ”¶ã€‚è€Œ String å†…éƒ¨ä½¿ç”¨äº†
Vecï¼Œæ‰€ä»¥å®ƒå¯ä»¥<a href="https://doc.rust-lang.org/src/alloc/vec/mod.rs.html#2710-2720">ä¾èµ– Vec çš„èƒ½åŠ›æ¥é‡Šæ”¾å †å†…å­˜</a></li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>unsafe impl&lt;#[may_dangle] T, A: Allocator&gt; Drop for Vec&lt;T, A&gt; {
    fn drop(&amp;mut self) {
        unsafe {
            // use drop for [T]
            // use a raw slice to refer to the elements of the vector as weakest necessary type;
            // could avoid questions of validity in certain cases
            ptr::drop_in_place(ptr::slice_from_raw_parts_mut(self.as_mut_ptr(), self.len))
        }
        // RawVec handles deallocation
    }
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-åœ¨-rust-ä¸­å‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ä¸”å®ç°äº†-derefderefmutdropéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆ" class="admonition info">
<summary class="admonition-title">
<p>åœ¨ Rust ä¸­ï¼Œå‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ï¼Œä¸”å®ç°äº† Deref/DerefMut/Dropï¼Œéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-åœ¨-rust-ä¸­å‡¡æ˜¯éœ€è¦åšèµ„æºå›æ”¶çš„æ•°æ®ç»“æ„ä¸”å®ç°äº†-derefderefmutdropéƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆ"></a></p>
</summary>
<div>
<p>æŒ‰ç…§è¿™ä¸ªå®šä¹‰ï¼Œé™¤äº† Stringï¼Œè¿˜æœ‰å¾ˆå¤šæ™ºèƒ½æŒ‡é’ˆï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>
<p>ç”¨äºåœ¨å †ä¸Š åˆ†é…å†…å­˜çš„ Box<T> å’Œ Vec<T></p>
</li>
<li>
<p>ç”¨äºå¼•ç”¨è®¡æ•°çš„ Rc<T> å’Œ Arc<T> </p>
</li>
<li>
<p>å¾ˆå¤šå…¶ä»–æ•°æ®ç»“ æ„ï¼Œå¦‚ PathBufã€Cow&lt;â€™a, B&gt;ã€MutexGuard<T>ã€RwLockReadGuard<T> å’Œ RwLockWriteGuard ç­‰ä¹Ÿæ˜¯æ™ºèƒ½æŒ‡é’ˆã€‚</p>
</li>
</ol>
</div>
</details>
<h2 id="box-åœ¨å †ä¸Šåˆ†é…å†…å­˜"><a class="header" href="#box-åœ¨å †ä¸Šåˆ†é…å†…å­˜">Box<T>: åœ¨å †ä¸Šåˆ†é…å†…å­˜</a></h2>
<details id="admonition-ä»ccå¾—åˆ°boxçµæ„Ÿ" class="admonition info">
<summary class="admonition-title">
<p>ä»c/c++å¾—åˆ°Box<T>çµæ„Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä»ccå¾—åˆ°boxçµæ„Ÿ"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬å…ˆçœ‹ Box<T>ï¼Œå®ƒæ˜¯ Rust ä¸­æœ€åŸºæœ¬çš„åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„æ–¹å¼ï¼Œç»å¤§å¤šæ•°å…¶å®ƒåŒ…å«å †å†… å­˜åˆ†é…çš„æ•°æ®ç±»å‹ï¼Œå†…éƒ¨éƒ½æ˜¯é€šè¿‡ Box<T> å®Œæˆçš„ï¼Œæ¯”å¦‚ Vec<T>ã€‚</p>
<p>ä¸ºä»€ä¹ˆæœ‰ Box<T> çš„è®¾è®¡ï¼Œæˆ‘ä»¬å¾—å…ˆå›å¿†ä¸€ä¸‹åœ¨ C è¯­è¨€ä¸­ï¼Œå †å†…å­˜æ˜¯æ€ä¹ˆåˆ†é…çš„ã€‚</p>
<ol>
<li>
<p>C éœ€è¦ä½¿ç”¨ malloc/calloc/realloc/free æ¥å¤„ç†å†…å­˜çš„åˆ†é…ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œè¢«åˆ†é…å‡ºæ¥çš„å†…å­˜ åœ¨å‡½æ•°è°ƒç”¨ä¸­æ¥æ¥å›å›ä½¿ç”¨ï¼Œå¯¼è‡´è°åº”è¯¥è´Ÿè´£é‡Šæ”¾è¿™ä»¶äº‹æƒ…å¾ˆéš¾ç¡®å®šï¼Œç»™å¼€å‘è€…é€ æˆäº†æ å¤§çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</p>
</li>
<li>
<p>C++ åœ¨æ­¤åŸºç¡€ä¸Šæ”¹è¿›äº†ä¸€ä¸‹ï¼Œæä¾›äº†ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆ î›¼ unique_ptrï¼Œå¯ä»¥åœ¨æŒ‡é’ˆé€€å‡ºä½œç”¨ åŸŸçš„æ—¶å€™é‡Šæ”¾å †å†…å­˜ï¼Œè¿™æ ·ä¿è¯äº†å †å†…å­˜çš„å•ä¸€æ‰€æœ‰æƒã€‚è¿™ä¸ª unique_ptr å°±æ˜¯ Rust çš„ Box<T> çš„å‰èº«ã€‚</p>
</li>
</ol>
<hr />
<p><a href="https://doc.rust-lang.org/src/core/ptr/unique.rs.html#36-44">Box<T> çš„å®šä¹‰</a>é‡Œï¼Œå†…éƒ¨å°±æ˜¯ä¸€ä¸ª Unique<T> ç”¨äºè‡´æ•¬ C++ï¼ŒUnique<T> æ˜¯
ä¸€ä¸ªç§æœ‰çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå®ƒåŒ…è£¹äº†ä¸€ä¸ª *const T æŒ‡é’ˆï¼Œå¹¶å”¯ä¸€æ‹¥æœ‰è¿™ä¸ª æŒ‡é’ˆã€‚</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Unique&lt;T: ?Sized&gt; {
    pointer: *const T,
    // NOTE: this marker has no consequences for variance, but is necessary
    // for dropck to understand that we logically own a `T`.
    //
    // For details, see:
    // https://github.com/rust-lang/rfcs/blob/master/text/0769-sound-generic-drop.md#phantom-data
    _marker: PhantomData&lt;T&gt;,
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-å †ä¸Šåˆ†é…å†…å­˜çš„-box-å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•°-a" class="admonition info">
<summary class="admonition-title">
<p>å †ä¸Šåˆ†é…å†…å­˜çš„ Box<T> å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•° A</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å †ä¸Šåˆ†é…å†…å­˜çš„-box-å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•°-a"></a></p>
</summary>
<div>
<p>è®¾è®¡å†…å­˜åˆ†é…å™¨çš„ç›®çš„é™¤äº†ä¿è¯æ­£ç¡®æ€§ä¹‹å¤–ï¼Œå°±æ˜¯ä¸ºäº†æœ‰æ•ˆåœ°åˆ©ç”¨å‰©ä½™å†…å­˜ï¼Œå¹¶æ§åˆ¶å†…å­˜ åœ¨åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¢ç‰‡çš„æ•°é‡ã€‚
åœ¨å¤šæ ¸ç¯å¢ƒä¸‹ï¼Œå®ƒè¿˜è¦èƒ½å¤Ÿé«˜æ•ˆåœ°å¤„ç†å¹¶å‘è¯· æ±‚ã€‚ï¼ˆå¦‚æœä½ å¯¹é€šç”¨å†…å­˜åˆ†é…å™¨æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹å‚è€ƒèµ„æ–™ï¼‰ å †ä¸Šåˆ†é…å†…å­˜çš„ Box<T></p>
<p>å…¶å®æœ‰ä¸€ä¸ªç¼ºçœçš„æ³›å‹å‚æ•° Aï¼Œå°±éœ€è¦æ»¡è¶³ <a href="https://doc.rust-lang.org/std/alloc/trait.Allocator.html">Allocator trait</a>ï¼Œ å¹¶ä¸”é»˜è®¤æ˜¯ Globalï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>pub struct Box&lt;T: ?Sized, A: Allocator = Global&gt;(Unique&lt;T&gt;, A);
<span class="boring">}
</span></code></pre></pre>
<hr />
<p>Allocator trait æä¾›å¾ˆå¤šæ–¹æ³•ï¼š</p>
<ol>
<li>
<p>allocate æ˜¯ä¸»è¦æ–¹æ³•ï¼Œç”¨äºåˆ†é…å†…å­˜ï¼Œå¯¹åº” C çš„ malloc/callocï¼›</p>
</li>
<li>
<p>deallocateï¼Œç”¨äºé‡Šæ”¾å†…å­˜ï¼Œå¯¹åº” C çš„ freeï¼›</p>
</li>
<li>
<p>è¿˜æœ‰ grow / shrinkï¼Œç”¨æ¥æ‰©å¤§æˆ–ç¼©å°å †ä¸Šå·²åˆ†é…çš„å†…å­˜ï¼Œå¯¹åº” C çš„ reallocã€‚</p>
</li>
</ol>
</div>
</details>
<details id="admonition-æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨" class="admonition info">
<summary class="admonition-title">
<p>æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨"></a></p>
</summary>
<div>
<p>å¦‚æœä½ æƒ³æ›¿æ¢é»˜è®¤çš„å†…å­˜åˆ†é…å™¨ï¼Œå¯ä»¥ä½¿ç”¨ #[global_allocator] æ ‡è®°å®ï¼Œå®šä¹‰ä½ è‡ªå·±çš„å…¨å±€åˆ†é…å™¨ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•åœ¨ Rust
ä¸‹ä½¿ç”¨<a href="https://crates.io/crates/jemallocator">jemalloc</a>:</p>
<pre><pre class="playground"><code class="language-rust">
use jemallocator::Jemalloc;

#[global_allocator]
static GLOBAL: Jemalloc = Jemalloc;

fn main() {}
</code></pre></pre>
</div>
</details>
<h3 id="å®ç°å†…å­˜åˆ†é…å™¨"><a class="header" href="#å®ç°å†…å­˜åˆ†é…å™¨">å®ç°å†…å­˜åˆ†é…å™¨</a></h3>
<details id="admonition-å†…å­˜åˆ†é…å™¨" class="admonition info">
<summary class="admonition-title">
<p>å†…å­˜åˆ†é…å™¨</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å†…å­˜åˆ†é…å™¨"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::alloc::{GlobalAlloc, Layout, System};

struct MyAllocator;

unsafe impl GlobalAlloc for MyAllocator {
    unsafe fn alloc(&amp;self, layout: Layout) -&gt; *mut u8 {
        let data = System.alloc(layout);
        eprintln!(&quot;ALLOC: {:p}, size {}&quot;, data, layout.size());
        data
    }

    unsafe fn dealloc(&amp;self, ptr: *mut u8, layout: Layout) {
        System.dealloc(ptr, layout);
        eprintln!(&quot;FREE: {:p}, size {}&quot;, ptr, layout.size());
    }
}

#[global_allocator]
static GLOBAL: MyAllocator = MyAllocator;

#[allow(dead_code)]
struct Matrix {
    // ä½¿ç”¨ä¸è§„åˆ™çš„æ•°å­—å¦‚ 505 å¯ä»¥è®© dbg! çš„æ‰“å°å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºæ¥
    data: [u8; 505],
}

impl Default for Matrix {
    fn default() -&gt; Self {
        Self { data: [0; 505] }
    }
}

fn main() {
    // åœ¨è¿™å¥æ‰§è¡Œä¹‹å‰å·²ç»æœ‰ä¸€äº›å†…å­˜åˆ†é…å’Œé‡Šæ”¾
    let data = Box::new(Matrix::default());
    println!(
        &quot;!!! allocated memory: {:p}, len: {}&quot;,
        &amp;*data,
        std::mem::size_of::&lt;Matrix&gt;()
    );

    // data åœ¨è¿™é‡Œ dropï¼Œå¯ä»¥åœ¨æ‰“å°ä¸­çœ‹åˆ° FREE
    // ä¹‹åè¿˜æœ‰å¾ˆå¤šå…¶å®ƒå†…å­˜è¢«é‡Šæ”¾
}
</code></pre></pre>
<hr />
<ol>
<li>è¿™é‡Œ MyAllocator å°±ç”¨ System allocatorï¼Œç„¶ååŠ  eprintln!()ï¼Œå’Œæˆ‘ ä»¬å¸¸ç”¨çš„ println!() ä¸åŒçš„æ˜¯ï¼Œeprintln!() å°†æ•°æ®æ‰“å°åˆ° stderr</li>
<li>æ³¨æ„è¿™é‡Œä¸èƒ½ä½¿ç”¨ println!() ã€‚å› ä¸º stdout ä¼šæ‰“å°åˆ°ä¸€ä¸ªç”± Mutex äº’æ–¥é”ä¿æŠ¤çš„å…±äº«å…¨ å±€ buffer ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæ¶‰åŠå†…å­˜çš„åˆ†é…ï¼Œåˆ†é…çš„å†…å­˜åˆä¼šè§¦å‘ println!()ï¼Œæœ€ç»ˆé€ æˆ ç¨‹åºå´©æºƒã€‚è€Œ
eprintln! ç›´æ¥æ‰“å°åˆ° stderrï¼Œä¸ä¼š bufferã€‚</li>
<li>åœ¨ä½¿ç”¨ Box åˆ†é…å †å†…å­˜çš„æ—¶å€™è¦æ³¨æ„ï¼ŒBox::new() æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ä¼ å…¥å®ƒçš„æ•°æ®ä¼šå‡ºç° åœ¨æ ˆä¸Šï¼Œå†ç§»åŠ¨åˆ°å †ä¸Šã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬çš„ Matrix ç»“æ„ä¸æ˜¯ 505 ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¤§ çš„ç»“æ„ï¼Œå°±æœ‰å¯èƒ½å‡ºé—®é¢˜ã€‚</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">// #![feature(dropck_eyepatch)]

// struct MyBox&lt;T&gt;(Box&lt;T&gt;);

// unsafe impl&lt;#[may_dangle] T&gt; Drop for MyBox&lt;T&gt; {
//     fn drop(&amp;mut self) {
//         todo!();
//     }
// }

fn main() {
    // åœ¨å †ä¸Šåˆ†é… 16M å†…å­˜ï¼Œä½†å®ƒä¼šç°åœ¨æ ˆä¸Šå‡ºç°ï¼Œå†ç§»åŠ¨åˆ°å †ä¸Š
    let boxed = Box::new([0u8; 1 &lt;&lt; 24]);
    println!(&quot;len: {}&quot;, boxed.len());
}
</code></pre></pre>
<ul>
<li><code>cargo run --bin box</code>æˆ–è€…åœ¨ playground é‡Œè¿è¡Œï¼Œç›´æ¥æ ˆæº¢å‡º stack overflow</li>
<li>æœ¬åœ°ä½¿ç”¨ â€œcargo run â€“bin box â€”releaseâ€ ç¼–è¯‘æˆ release ä»£ç è¿è¡Œï¼Œä¼šæ­£å¸¸æ‰§è¡Œï¼</li>
</ul>
<blockquote>
<p>è¿™æ˜¯å› ä¸º â€œcargo runâ€ æˆ–è€…åœ¨ playground ä¸‹è¿è¡Œï¼Œé»˜è®¤æ˜¯ debug buildï¼Œå®ƒä¸ä¼šåšä»» ä½• inline çš„ä¼˜åŒ–ï¼Œè€Œ Box::new() çš„å®ç°å°±ä¸€è¡Œä»£ç ï¼Œå¹¶æ³¨æ˜äº†è¦ inlineï¼Œåœ¨ release æ¨¡å¼
ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨ä¼šè¢«ä¼˜åŒ–æ‰, æœ¬è´¨æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨ä¸‹åˆ—æ–¹å¼:</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>#[cfg(not(no_global_oom_handling))]
#[inline(always)]
#[doc(alias = &quot;alloc&quot;)]
#[doc(alias = &quot;malloc&quot;)]
#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
pub fn new(x: T) -&gt; Self {
    box x
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>è¿™é‡Œçš„å…³é”®å­— boxæ˜¯ Rust å†…éƒ¨çš„å…³é”®å­—ï¼Œç”¨æˆ·ä»£ç æ— æ³•è°ƒç”¨ï¼Œå®ƒåªå‡ºç°åœ¨ Rust ä»£ç ä¸­ï¼Œç”¨äºåˆ†é…å †å†…å­˜ï¼Œbox å…³é”®å­—åœ¨ç¼–è¯‘æ—¶ï¼Œä¼šä½¿ç”¨å†…å­˜åˆ†é…å™¨ åˆ†é…å†…å­˜ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="å†…å­˜å¦‚ä½•é‡Šæ”¾"><a class="header" href="#å†…å­˜å¦‚ä½•é‡Šæ”¾">å†…å­˜å¦‚ä½•é‡Šæ”¾</a></h3>
<details id="admonition-boxé»˜è®¤å®ç°çš„drop-trait" class="admonition info">
<summary class="admonition-title">
<p>Box<T>é»˜è®¤å®ç°çš„Drop trait</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-boxé»˜è®¤å®ç°çš„drop-trait"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
unsafe impl&lt;#[may_dangle] T: ?Sized, A: Allocator&gt; Drop for Box&lt;T, A&gt; {
    fn drop(&amp;mut self) {
        // FIXME: Do nothing, drop is currently performed by compiler.
    }
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-å…ˆç¨³å®šæ¥å£å†è¿­ä»£ç¨³å®šå®ç°" class="admonition info">
<summary class="admonition-title">
<p>å…ˆç¨³å®šæ¥å£ï¼Œå†è¿­ä»£ç¨³å®šå®ç°</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å…ˆç¨³å®šæ¥å£å†è¿­ä»£ç¨³å®šå®ç°"></a></p>
</summary>
<div>
<p>ç›®å‰ drop trait ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥ deallocate çš„ä»£ç ã€‚è¿™æ˜¯ Rust è¯­ è¨€çš„ä¸€ç§ç­–ç•¥ï¼šåœ¨å…·ä½“å®ç°è¿˜æ²¡æœ‰ç¨³å®šä¸‹æ¥ä¹‹å‰ï¼Œæˆ‘å…ˆæŠŠæ¥å£ç¨³å®šï¼Œå®ç°éšç€ä¹‹åçš„è¿­ä»£ æ…¢æ…¢ç¨³å®šã€‚</p>
</div>
</details>
<h2 id="cowa-b-å†™æ—¶æ‹·è´"><a class="header" href="#cowa-b-å†™æ—¶æ‹·è´">Cow&lt;â€™a, B&gt;ï¼š å†™æ—¶æ‹·è´</a></h2>
<div id="admonition-å†™æ—¶å¤åˆ¶copy-on-writeæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™" class="admonition info">
<div class="admonition-title">
<p>å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-writeï¼‰æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å†™æ—¶å¤åˆ¶copy-on-writeæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™"></a></p>
</div>
<div>
<p>Cow æ˜¯ Rust ä¸‹ç”¨äºæä¾›å†™æ—¶å…‹éš†ï¼ˆClone-on-Writeï¼‰çš„ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒè·Ÿè™šæ‹Ÿå†…å­˜ç®¡ ç†çš„å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-writeï¼‰æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼š</p>
<blockquote>
<p>åŒ…è£¹ä¸€ä¸ªåªè¯»å€Ÿç”¨ï¼Œä½†å¦‚æœè°ƒç”¨è€…éœ€ è¦æ‰€æœ‰æƒæˆ–è€…éœ€è¦ä¿®æ”¹å†…å®¹ï¼Œé‚£ä¹ˆå®ƒä¼š clone å€Ÿç”¨çš„æ•°æ®</p>
</blockquote>
</div>
</div>
<h3 id="å®šä¹‰"><a class="header" href="#å®šä¹‰">å®šä¹‰</a></h3>
<div id="admonition-cowå®šä¹‰" class="admonition info">
<div class="admonition-title">
<p>Cowå®šä¹‰</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-cowå®šä¹‰"></a></p>
</div>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>pub enum Cow&lt;'a, B&gt; where B: 'a + ToOwned + ?Sized {
    Borrowed(&amp;'a B),
    Owned(&lt;B as ToOwned&gt;::Owned),
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>å®ƒæ˜¯ä¸€ä¸ª enumï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªå¯¹ç±»å‹ B çš„åªè¯»å¼•ç”¨ï¼Œæˆ–è€…åŒ…å«å¯¹ç±»å‹ B çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„ æ•°æ®ã€‚</p>
</blockquote>
</div>
</div>
<h3 id="ä¸¤ä¸ªtraittoownedborrowed"><a class="header" href="#ä¸¤ä¸ªtraittoownedborrowed">ä¸¤ä¸ªtraitï¼šToOwnedã€Borrowed</a></h3>
<div id="admonition-cowå®šä¹‰ç”¨åˆ°ä¸¤ä¸ªtraittoownedå’Œborrowed" class="admonition info">
<div class="admonition-title">
<p>Cowå®šä¹‰ç”¨åˆ°ä¸¤ä¸ªtraitï¼šToOwnedå’ŒBorrowed</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-cowå®šä¹‰ç”¨åˆ°ä¸¤ä¸ªtraittoownedå’Œborrowed"></a></p>
</div>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>pub trait ToOwned {
    type Owned: Borrow&lt;Self&gt;;
    #[must_use = &quot;cloning is often expensive and is not expected to have side effects&quot;]
    fn to_owned(&amp;self) -&gt; Self::Owned;

    fn clone_into(&amp;self, target: &amp;mut Self::Owned) { ... }
}

pub trait Borrow&lt;Borrowed&gt; where Borrowed: ?Sized {
    fn borrow(&amp;self) -&gt; &amp;Borrowed;
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>å®ƒæ˜¯ä¸€ä¸ª enumï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªå¯¹ç±»å‹ B çš„åªè¯»å¼•ç”¨ï¼Œæˆ–è€…åŒ…å«å¯¹ç±»å‹ B çš„æ‹¥æœ‰æ‰€æœ‰æƒçš„ æ•°æ®ã€‚</p>
</blockquote>
</div>
</div>
<h3 id="toowned"><a class="header" href="#toowned">ToOwned</a></h3>
<div id="admonition-type-owned-borrow" class="admonition info">
<div class="admonition-title">
<p>type Owned: Borrow<Self></p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-type-owned-borrow"></a></p>
</div>
<div>
<ol>
<li>é¦–å…ˆï¼Œtype Owned: Borrow<Self> æ˜¯ä¸€ä¸ªå¸¦æœ‰å…³è”ç±»å‹çš„ trait. è¿™é‡Œ Owned æ˜¯å…³è”ç±»å‹ï¼Œéœ€è¦ä½¿ç”¨è€…å®šä¹‰.</li>
<li>è¿™é‡Œ Owned ä¸èƒ½æ˜¯ä»»æ„ç±»å‹ï¼Œå®ƒå¿…é¡»æ»¡è¶³ Borrow<T> trait</li>
<li><a href="https://doc.rust-lang.org/src/alloc/str.rs.html#215-227">å‚è€ƒstrå¯¹ToOwned traitçš„å®ç°</a>ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>impl ToOwned for str {
    type Owned = String;
    #[inline]
    fn to_owned(&amp;self) -&gt; String {
        unsafe { String::from_utf8_unchecked(self.as_bytes().to_owned()) }
    }

    fn clone_into(&amp;self, target: &amp;mut String) {
        let mut b = mem::take(target).into_bytes();
        self.as_bytes().clone_into(&amp;mut b);
        *target = unsafe { String::from_utf8_unchecked(b) }
    }
}
<span class="boring">}
</span></code></pre></pre>
<ol start="4">
<li>å¯ä»¥çœ‹åˆ°å…³è”ç±»å‹ Owned è¢«å®šä¹‰ä¸º Stringï¼Œè€Œæ ¹æ®è¦æ±‚ï¼ŒString å¿…é¡»å®šä¹‰ Borrowï¼Œé‚£è¿™é‡Œ Borrow é‡Œçš„æ³›å‹å˜é‡ T æ˜¯è°å‘¢ï¼Ÿ</li>
<li>ToOwned è¦æ±‚æ˜¯ Borrowï¼Œè€Œæ­¤åˆ»å®ç° ToOwned çš„ä¸»ä½“æ˜¯ strï¼Œæ‰€ä»¥ Borrow æ˜¯ Borrowï¼Œä¹Ÿå°±æ˜¯è¯´ String è¦å®ç° Borrow</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>impl Borrow&lt;str&gt; for String {
    #[inline]
    fn borrow(&amp;self) -&gt; &amp;str {
        &amp;self[..]
    }
}
<span class="boring">}
</span></code></pre></pre>
</div>
</div>
<div id="admonition-cow-å’Œ-toowned--borrow-ä¹‹é—´çš„å…³ç³»ç¤ºæ„å›¾" class="admonition info">
<div class="admonition-title">
<p>Cow å’Œ ToOwned / Borrow<T> ä¹‹é—´çš„å…³ç³»ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-cow-å’Œ-toowned--borrow-ä¹‹é—´çš„å…³ç³»ç¤ºæ„å›¾"></a></p>
</div>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/15%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BF%99%E4%BA%9B%E6%B5%93%E7%9C%89%E5%A4%A7%E7%9C%BC%E7%9A%84%E7%BB%93%E6%9E%84%E7%AB%9F%E7%84%B6%E9%83%BD%E6%98%AF%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9F-4781304.jpg" alt="type Owned: Borrow&lt;Self&gt; " /></p>
</div>
</div>
<h3 id="åŒ¹é…åˆ†å‘"><a class="header" href="#åŒ¹é…åˆ†å‘">åŒ¹é…åˆ†å‘</a></h3>
<div id="admonition-ä¸ºä½•-borrow-è¦å®šä¹‰æˆä¸€ä¸ªæ³›å‹-trait-å‘¢" class="admonition info">
<div class="admonition-title">
<p>ä¸ºä½• Borrow è¦å®šä¹‰æˆä¸€ä¸ªæ³›å‹ trait å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä¸ºä½•-borrow-è¦å®šä¹‰æˆä¸€ä¸ªæ³›å‹-trait-å‘¢"></a></p>
</div>
<div>
<ol>
<li>ä¾‹å­1ï¼šStringä¸åŒå€Ÿç”¨æ–¹å¼</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use std::borrow::Borrow;

fn main() {
    let s = &quot;hello world!&quot;.to_owned();

    // è¿™é‡Œå¿…é¡»å£°æ˜ç±»å‹ï¼Œå› ä¸º String æœ‰å¤šä¸ª Borrow&lt;T&gt; å®ç°
    // å€Ÿç”¨ä¸º &amp;String
    let r1: &amp;String = s.borrow();
    // å€Ÿç”¨ä¸º &amp;str
    let r2: &amp;str = s.borrow();

    println!(&quot;r1: {:p}, r2: {:p}&quot;, r1, r2);
}
</code></pre></pre>
<blockquote>
<p>String å¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;Stringï¼Œä¹Ÿå¯ä»¥è¢«å€Ÿç”¨ä¸º &amp;str</p>
</blockquote>
<hr />
<ol start="2">
<li>ä¾‹å­2ï¼šCowä¸åŒè§£å¼•ç”¨æ–¹å¼</li>
</ol>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>impl&lt;B: ?Sized + ToOwned&gt; Deref for Cow&lt;'_, B&gt; {
    type Target = B;

    fn deref(&amp;self) -&gt; &amp;B {
        match *self {
            Borrowed(borrowed) =&gt; borrowed,
            Owned(ref owned) =&gt; owned.borrow(),
        }
    }
}

<span class="boring">}
</span></code></pre></pre>
<hr />
<p>å®ç°çš„åŸç†å¾ˆç®€å•ï¼Œæ ¹æ® self æ˜¯ Borrowed è¿˜æ˜¯ Ownedï¼Œæˆ‘ä»¬åˆ†åˆ«å–å…¶å†…å®¹ï¼Œç”Ÿæˆå¼• ç”¨ï¼š</p>
<ol>
<li>
<p>å¯¹äº Borrowedï¼Œç›´æ¥å°±æ˜¯å¼•ç”¨ï¼›</p>
</li>
<li>
<p>å¯¹äº Ownedï¼Œè°ƒç”¨å…¶ borrow() æ–¹æ³•ï¼Œè·å¾—å¼•ç”¨ã€‚</p>
</li>
</ol>
</div>
</div>
<div id="admonition-åŒ¹é…åˆ†å‘ä½¿ç”¨matchåŒ¹é…å®ç°é™æ€åŠ¨æ€åˆ†å‘ä¹‹å¤–çš„ç¬¬ä¸‰ç§åˆ†å‘" class="admonition info">
<div class="admonition-title">
<p>åŒ¹é…åˆ†å‘ï¼šä½¿ç”¨matchåŒ¹é…å®ç°é™æ€ã€åŠ¨æ€åˆ†å‘ä¹‹å¤–çš„ç¬¬ä¸‰ç§åˆ†å‘</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-åŒ¹é…åˆ†å‘ä½¿ç”¨matchåŒ¹é…å®ç°é™æ€åŠ¨æ€åˆ†å‘ä¹‹å¤–çš„ç¬¬ä¸‰ç§åˆ†å‘"></a></p>
</div>
<div>
<p>è™½ç„¶ Cow æ˜¯ä¸€ä¸ª enumï¼Œä½†æ˜¯é€šè¿‡ Deref çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ç»Ÿä¸€çš„ ä½“éªŒ.
æ¯”å¦‚ Cow<str>ï¼Œä½¿ç”¨çš„æ„Ÿè§‰å’Œ &amp;str / String æ˜¯åŸºæœ¬ä¸€è‡´çš„ã€‚
æ³¨æ„ï¼Œè¿™ç§æ ¹æ® enum çš„ä¸åŒçŠ¶æ€æ¥è¿›è¡Œç»Ÿä¸€åˆ†å‘çš„æ–¹æ³•æ˜¯ç¬¬ä¸‰ç§åˆ†å‘æ‰‹æ®µï¼Œå¦å¤–è¿˜å¯ä»¥ä½¿ç”¨æ³›å‹å‚æ•° åšé™æ€åˆ†å‘å’Œä½¿ç”¨ trait object åšåŠ¨æ€åˆ†å‘</p>
</div>
</div>
<h3 id="cowåœ¨éœ€è¦æ—¶æ‰è¿›è¡Œå†…å­˜åˆ†é…æ‹·è´"><a class="header" href="#cowåœ¨éœ€è¦æ—¶æ‰è¿›è¡Œå†…å­˜åˆ†é…æ‹·è´">Cowåœ¨éœ€è¦æ—¶æ‰è¿›è¡Œå†…å­˜åˆ†é…æ‹·è´</a></h3>
<div id="admonition-å†™æ—¶æ‹·è´" class="admonition info">
<div class="admonition-title">
<p>å†™æ—¶æ‹·è´</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å†™æ—¶æ‹·è´"></a></p>
</div>
<div>
<p>é‚£ä¹ˆ Cow æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p>
<ol>
<li>æ˜¾ç„¶ï¼Œå®ƒå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™æ‰è¿›è¡Œå†…å­˜çš„åˆ†é…å’Œæ‹·è´ï¼Œåœ¨å¾ˆå¤šåº”ç”¨ åœºåˆï¼Œå®ƒå¯ä»¥å¤§å¤§æå‡ç³»ç»Ÿçš„æ•ˆç‡ã€‚</li>
<li>å¦‚æœ Cow&lt;â€™a, B&gt; ä¸­çš„ Owned æ•°æ®ç±»å‹æ˜¯ä¸€ä¸ªéœ€è¦ åœ¨å †ä¸Šåˆ†é…å†…å­˜çš„ç±»å‹ï¼Œå¦‚ Stringã€Vec<T> ç­‰ï¼Œè¿˜èƒ½å‡å°‘å †å†…å­˜åˆ†é…çš„æ¬¡æ•°ã€‚ </li>
<li>ç›¸å¯¹äºæ ˆå†…å­˜çš„åˆ†é…é‡Šæ”¾æ¥è¯´ï¼Œå †å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾æ•ˆç‡è¦ä½å¾ˆå¤šï¼Œå…¶å†…éƒ¨è¿˜ æ¶‰åŠç³»ç»Ÿè°ƒç”¨å’Œé”ï¼Œå‡å°‘ä¸å¿…è¦çš„å †å†…å­˜åˆ†é…æ˜¯æå‡ç³»ç»Ÿæ•ˆç‡çš„å…³é”®æ‰‹æ®µã€‚</li>
<li>è€Œ Rust çš„ Cow&lt;â€™a, B&gt;ï¼Œåœ¨å¸®åŠ©ä½ è¾¾æˆè¿™ä¸ªæ•ˆæœçš„åŒæ—¶ï¼Œä½¿ç”¨ä½“éªŒè¿˜éå¸¸ç®€å•èˆ’æœã€‚</li>
</ol>
</div>
</div>
<details id="admonition-ä¸¾ä¾‹ä½¿ç”¨cowè¿›è¡Œurlè§£æ" class="admonition info">
<summary class="admonition-title">
<p>ä¸¾ä¾‹ä½¿ç”¨Cowè¿›è¡ŒURLè§£æ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä¸¾ä¾‹ä½¿ç”¨cowè¿›è¡Œurlè§£æ"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::borrow::Cow;

use url::Url;
fn main() {
    let url = Url::parse(&quot;https://tyr.com/rust?page=1024&amp;sort=desc&amp;extra=hello%20world&quot;).unwrap();
    let mut pairs = url.query_pairs();

    assert_eq!(pairs.count(), 3);

    let (mut k, v) = pairs.next().unwrap();
    // å› ä¸º k, v éƒ½æ˜¯ Cow&lt;str&gt; ä»–ä»¬ç”¨èµ·æ¥æ„Ÿè§‰å’Œ &amp;str æˆ–è€… String ä¸€æ ·
    // æ­¤åˆ»ï¼Œä»–ä»¬éƒ½æ˜¯ Borrowed
    println!(&quot;key: {}, v: {}&quot;, k, v);
    // å½“ä¿®æ”¹å‘ç”Ÿæ—¶ï¼Œk å˜æˆ Owned
    k.to_mut().push_str(&quot;_lala&quot;);

    print_pairs((k, v));

    print_pairs(pairs.next().unwrap());
    print_pairs(pairs.next().unwrap());
}

fn print_pairs(pair: (Cow&lt;str&gt;, Cow&lt;str&gt;)) {
    println!(&quot;key: {}, value: {}&quot;, show_cow(pair.0), show_cow(pair.1));
}

fn show_cow(cow: Cow&lt;str&gt;) -&gt; String {
    match cow {
        Cow::Borrowed(v) =&gt; format!(&quot;Borrowed {}&quot;, v),
        Cow::Owned(v) =&gt; format!(&quot;Owned {}&quot;, v),
    }
}
</code></pre></pre>
<hr />
<blockquote>
<p>åœ¨è§£æ URL çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°† querystring ä¸­çš„å‚æ•°ï¼Œæå–æˆ KV pair æ¥è¿›ä¸€æ­¥ä½¿ ç”¨ã€‚
ç»å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œæå–å‡ºæ¥çš„ KV éƒ½æ˜¯æ–°çš„å­—ç¬¦ä¸²ï¼Œåœ¨æ¯ç§’é’Ÿå¤„ç†å‡ å k ç”šè‡³ä¸Šç™¾ k è¯·æ±‚çš„ç³»ç»Ÿä¸­ï¼Œä½ å¯ä»¥æƒ³è±¡è¿™ä¼šå¸¦æ¥å¤šå°‘æ¬¡å †å†…å­˜çš„åˆ†é…ã€‚ 
ä½†åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Cow ç±»å‹è½»æ¾é«˜æ•ˆå¤„ç†å®ƒï¼Œåœ¨è¯»å– URL çš„è¿‡ç¨‹ä¸­ï¼š</p>
</blockquote>
<ol>
<li>æ¯è§£æå‡ºä¸€ä¸ª key æˆ–è€… valueï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª &amp;str æŒ‡å‘ URL ä¸­ç›¸åº”çš„ä½ç½®ï¼Œç„¶åç”¨ Cow å°è£…å®ƒ </li>
<li>è€Œå½“è§£æå‡ºæ¥çš„å†…å®¹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ decode æ—¶ï¼Œæ¯”å¦‚ â€œhello%20worldâ€ï¼Œæˆ‘ä»¬ å¯ä»¥ç”Ÿæˆä¸€ä¸ªè§£æåçš„ Stringï¼ŒåŒæ ·ç”¨ Cow å°è£…å®ƒã€‚</li>
</ol>
</div>
</details>
<details id="admonition-ä¸¾ä¾‹serdeä½¿ç”¨cowè¿›è¡Œåºåˆ—åŒ–ååºåˆ—åŒ–" class="admonition info">
<summary class="admonition-title">
<p>ä¸¾ä¾‹serdeä½¿ç”¨Cowè¿›è¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä¸¾ä¾‹serdeä½¿ç”¨cowè¿›è¡Œåºåˆ—åŒ–ååºåˆ—åŒ–"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use serde::Deserialize;
use std::borrow::Cow;

#[allow(dead_code)]
#[derive(Debug, Deserialize)]
struct User&lt;'input&gt; {
    #[serde(borrow)]
    name: Cow&lt;'input, str&gt;,
    age: u8,
}

fn main() {
    let input = r#&quot;{ &quot;name&quot;: &quot;Tyr&quot;, &quot;age&quot;: 18 }&quot;#;
    let user: User = serde_json::from_str(input).unwrap();

    match user.name {
        Cow::Borrowed(x) =&gt; println!(&quot;borrowed {}&quot;, x),
        Cow::Owned(x) =&gt; println!(&quot;owned {}&quot;, x),
    }
}
</code></pre></pre>
</div>
</details>
<h2 id="mutexguard-æ•°æ®åŠ é”"><a class="header" href="#mutexguard-æ•°æ®åŠ é”">MutexGuard<T>ï¼š æ•°æ®åŠ é”</a></h2>
<h3 id="mutexguardä¸stringboxcowa-bçš„å¯¹æ¯”"><a class="header" href="#mutexguardä¸stringboxcowa-bçš„å¯¹æ¯”">MutexGuardä¸Stringã€Box<T>ã€Cow&lt;â€™a, B&gt;çš„å¯¹æ¯”</a></h3>
<details id="admonition-derefdrop" class="admonition info">
<summary class="admonition-title">
<p>Deref+Drop</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-derefdrop"></a></p>
</summary>
<div>
<p>Stringã€Box<T>ã€Cow&lt;â€™a, B&gt; ç­‰æ™ºèƒ½æŒ‡é’ˆï¼Œéƒ½æ˜¯é€šè¿‡ Deref æ¥æ ä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œ 
MutexGuard<T> æ˜¯å¦å¤–ä¸€ç±»å¾ˆæœ‰æ„æ€çš„æ™ºèƒ½æŒ‡é’ˆï¼š</p>
<ol>
<li>å®ƒä¸ä½†é€šè¿‡ Deref æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ</li>
<li>è¿˜é€šè¿‡ Drop trait æ¥ç¡®ä¿ï¼Œä½¿ç”¨åˆ°çš„å†…å­˜ä»¥å¤–çš„èµ„æºåœ¨é€€å‡º æ—¶è¿›è¡Œé‡Šæ”¾ã€‚</li>
</ol>
</div>
</details>
<h3 id="ä½¿ç”¨mutexlockè·å–"><a class="header" href="#ä½¿ç”¨mutexlockè·å–">ä½¿ç”¨Mutex::lockè·å–</a></h3>
<details id="admonition-mutexguardè¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨-mutexlock-æ—¶ç”Ÿæˆçš„" class="admonition info">
<summary class="admonition-title">
<p>MutexGuardè¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨ Mutex::lock æ—¶ç”Ÿæˆçš„</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-mutexguardè¿™ä¸ªç»“æ„æ˜¯åœ¨è°ƒç”¨-mutexlock-æ—¶ç”Ÿæˆçš„"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn lock(&amp;self) -&gt; LockResult&lt;MutexGuard&lt;'_, T&gt;&gt; {
    unsafe {
        self.inner.raw_lock();
        MutexGuard::new(self)
    }
}
</code></pre></pre>
<hr />
<p><a href="https://doc.rust-lang.org/src/std/sync/mutex.rs.html#279-284">rustæ–‡æ¡£</a></p>
<ol>
<li>é¦–å…ˆï¼Œå®ƒä¼šå–å¾—é”èµ„æºï¼Œå¦‚æœæ‹¿ä¸åˆ°ï¼Œä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼›</li>
<li>å¦‚æœæ‹¿åˆ°äº†ï¼Œä¼šæŠŠ Mutex ç»“æ„çš„å¼• ç”¨ä¼ é€’ç»™ MutexGuardã€‚</li>
</ol>
</div>
</details>
<h3 id="å®šä¹‰ä¸derefdrop-traitå®ç°"><a class="header" href="#å®šä¹‰ä¸derefdrop-traitå®ç°">å®šä¹‰ä¸Derefã€Drop traitå®ç°</a></h3>
<details id="admonition-mutexguard-çš„å®šä¹‰ä»¥åŠå®ƒçš„-deref-å’Œ-drop-çš„å®ç°" class="admonition info">
<summary class="admonition-title">
<p>MutexGuard çš„å®šä¹‰ä»¥åŠå®ƒçš„ Deref å’Œ Drop çš„å®ç°</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-mutexguard-çš„å®šä¹‰ä»¥åŠå®ƒçš„-deref-å’Œ-drop-çš„å®ç°"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
// è¿™é‡Œç”¨ must_useï¼Œå½“ä½ å¾—åˆ°äº†å´ä¸ä½¿ç”¨ MutexGuard æ—¶ä¼šæŠ¥è­¦
#[must_use = &quot;if unused the Mutex will immediately unlock&quot;]
pub struct MutexGuard&lt;'a, T: ?Sized + 'a&gt; {
    lock: &amp;'a Mutex&lt;T&gt;,
    poison: poison::Guard,
}

impl&lt;T: ?Sized&gt; Deref for MutexGuard&lt;'_, T&gt; {
    type Target = T;

    fn deref(&amp;self) -&gt; &amp;T {
        unsafe { &amp;*self.lock.data.get() }
    }
}

impl&lt;T: ?Sized&gt; DerefMut for MutexGuard&lt;'_, T&gt; {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut T {
        unsafe { &amp;mut *self.lock.data.get() }
    }
}

impl&lt;T: ?Sized&gt; Drop for MutexGuard&lt;'_, T&gt; {
    #[inline]
    fn drop(&amp;mut self) {
        unsafe {
            self.lock.poison.done(&amp;self.poison);
            self.lock.inner.raw_unlock();
        }
    }
}
</code></pre></pre>
<hr />
<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>å½“ MutexGuard ç»“æŸæ—¶ï¼ŒMutex ä¼šåš unlock</li>
<li>è¿™æ ·ç”¨æˆ·åœ¨ä½¿ç”¨ Mutex æ—¶ï¼Œå¯ä»¥ä¸å¿…å…³å¿ƒä½•æ—¶é‡Šæ”¾è¿™ä¸ªäº’æ–¥é”ã€‚</li>
<li>å› ä¸ºæ— è®ºä½ åœ¨è°ƒç”¨æ ˆä¸Šæ€æ ·ä¼ é€’ MutexGuard ï¼Œå“ªæ€•åœ¨é”™è¯¯å¤„ç†æµç¨‹ä¸Šæå‰é€€å‡ºï¼ŒRust æœ‰æ‰€æœ‰æƒæœºåˆ¶ï¼Œå¯ä»¥ç¡®ä¿åªè¦ MutexGuard ç¦»å¼€ä½œç”¨åŸŸï¼Œé”å°±ä¼šè¢«é‡Šæ”¾</li>
</ol>
</div>
</details>
<h3 id="ä½¿ç”¨mutex_mutexguardçš„ä¾‹å­"><a class="header" href="#ä½¿ç”¨mutex_mutexguardçš„ä¾‹å­">ä½¿ç”¨Mutex_MutexGuardçš„ä¾‹å­</a></h3>
<details id="admonition-mutex--mutexguard-example" class="admonition info">
<summary class="admonition-title">
<p>Mutex &amp; MutexGuard example</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-mutex--mutexguard-example"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use lazy_static::lazy_static;
use std::borrow::Cow;
use std::collections::HashMap;
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

// lazy_static å®å¯ä»¥ç”Ÿæˆå¤æ‚çš„ static å¯¹è±¡
lazy_static! {
    // ä¸€èˆ¬æƒ…å†µä¸‹ Mutex å’Œ Arc ä¸€èµ·åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æä¾›å¯¹å…±äº«å†…å­˜çš„ä½¿ç”¨
    // å¦‚æœä½ æŠŠ Mutex å£°æ˜æˆ staticï¼Œå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯é™æ€çš„ï¼Œä¸éœ€è¦ Arc
    static ref METRICS: Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt; =
        Mutex::new(HashMap::new());
}

fn main() {
    // ç”¨ Arc æ¥æä¾›å¹¶å‘ç¯å¢ƒä¸‹çš„å…±äº«æ‰€æœ‰æƒï¼ˆä½¿ç”¨å¼•ç”¨è®¡æ•°ï¼‰
    let metrics: Arc&lt;Mutex&lt;HashMap&lt;Cow&lt;'static, str&gt;, usize&gt;&gt;&gt; =
        Arc::new(Mutex::new(HashMap::new()));
    for _ in 0..32 {
        let m = metrics.clone();
        thread::spawn(move || {
            let mut g = m.lock().unwrap();
            // æ­¤æ—¶åªæœ‰æ‹¿åˆ° MutexGuard çš„çº¿ç¨‹å¯ä»¥è®¿é—® HashMap
            let data = &amp;mut *g;
            // Cow å®ç°äº†å¾ˆå¤šæ•°æ®ç»“æ„çš„ From traitï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ &quot;hello&quot;.into() ç”Ÿæˆ Cow
            let entry = data.entry(&quot;hello&quot;.into()).or_insert(0);
            *entry += 1;
            // MutexGuard è¢« Dropï¼Œé”è¢«é‡Šæ”¾
        });
    }

    thread::sleep(Duration::from_millis(100));

    println!(&quot;metrics: {:?}&quot;, metrics.lock().unwrap());
}
</code></pre></pre>
<hr />
<blockquote>
<p>åœ¨è§£æ URL çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°† querystring ä¸­çš„å‚æ•°ï¼Œæå–æˆ KV pair æ¥è¿›ä¸€æ­¥ä½¿ ç”¨ã€‚
ç»å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œæå–å‡ºæ¥çš„ KV éƒ½æ˜¯æ–°çš„å­—ç¬¦ä¸²ï¼Œåœ¨æ¯ç§’é’Ÿå¤„ç†å‡ å k ç”šè‡³ä¸Šç™¾ k è¯·æ±‚çš„ç³»ç»Ÿä¸­ï¼Œä½ å¯ä»¥æƒ³è±¡è¿™ä¼šå¸¦æ¥å¤šå°‘æ¬¡å †å†…å­˜çš„åˆ†é…ã€‚ 
ä½†åœ¨ Rust ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Cow ç±»å‹è½»æ¾é«˜æ•ˆå¤„ç†å®ƒï¼Œåœ¨è¯»å– URL çš„è¿‡ç¨‹ä¸­ï¼š</p>
</blockquote>
<ol>
<li>æ¯è§£æå‡ºä¸€ä¸ª key æˆ–è€… valueï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª &amp;str æŒ‡å‘ URL ä¸­ç›¸åº”çš„ä½ç½®ï¼Œç„¶åç”¨ Cow å°è£…å®ƒ </li>
<li>è€Œå½“è§£æå‡ºæ¥çš„å†…å®¹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦ decode æ—¶ï¼Œæ¯”å¦‚ â€œhello%20worldâ€ï¼Œæˆ‘ä»¬ å¯ä»¥ç”Ÿæˆä¸€ä¸ªè§£æåçš„ Stringï¼ŒåŒæ ·ç”¨ Cow å°è£…å®ƒã€‚</li>
</ol>
</div>
</details>
<details id="admonition-ä½ å¯ä»¥æŠŠ-mutexguard-çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ä½†ä½ æ— æ³•æŠŠ-mutexguard-æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹" class="admonition info">
<summary class="admonition-title">
<p>ä½ å¯ä»¥æŠŠ MutexGuard çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä½†ä½ æ— æ³•æŠŠ MutexGuard æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä½ å¯ä»¥æŠŠ-mutexguard-çš„å¼•ç”¨ä¼ ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ä½†ä½ æ— æ³•æŠŠ-mutexguard-æ•´ä¸ªç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::sync::Mutex;

fn main() {
    //
    let m = Mutex::new(Mutex::new(1));
    let g = m.lock().unwrap();
    {
        rayon::join(
            || {
                let mut g1 = g.lock().unwrap();
                *g1 += 1;
                println!(&quot;Thread 1: {:?}&quot;, *g1);
            },
            || {
                let mut g1 = g.lock().unwrap();
                *g1 += 1;
                println!(&quot;Thread 1: {:?}&quot;, *g1);
            },
        );
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-mutexguard-çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”" class="admonition info">
<summary class="admonition-title">
<p>MutexGuard çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-mutexguard-çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”"></a></p>
</summary>
<div>
<ul>
<li>r2d2ç±»ä¼¼å®ç°ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ï¼š<a href="https://github.com/sfackler/r2d2/blob/master/src/lib.rs#L611-L638">æºç </a></li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;M&gt; Drop for PooledConnection&lt;M&gt;
where
    M: ManageConnection,
{
    fn drop(&amp;mut self) {
        self.pool.put_back(self.checkout, self.conn.take().unwrap());
    }
}

impl&lt;M&gt; Deref for PooledConnection&lt;M&gt;
where
    M: ManageConnection,
{
    type Target = M::Connection;

    fn deref(&amp;self) -&gt; &amp;M::Connection {
        &amp;self.conn.as_ref().unwrap().conn
    }
}

impl&lt;M&gt; DerefMut for PooledConnection&lt;M&gt;
where
    M: ManageConnection,
{
    fn deref_mut(&amp;mut self) -&gt; &amp;mut M::Connection {
        &amp;mut self.conn.as_mut().unwrap().conn
    }
}
<span class="boring">}
</span></code></pre></pre>
<ul>
<li>ç±»ä¼¼ MutexGuard çš„æ™ºèƒ½æŒ‡é’ˆæœ‰å¾ˆå¤šç”¨é€”ã€‚æ¯”å¦‚è¦åˆ›å»ºä¸€ä¸ªè¿æ¥æ± ï¼Œä½ å¯ä»¥åœ¨ Drop trait ä¸­ï¼Œå›æ”¶ checkout å‡ºæ¥çš„è¿æ¥ï¼Œå°†å…¶å†æ”¾å›è¿æ¥æ± ã€‚</li>
</ul>
</div>
</details>
<h2 id="è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ">è‡ªå®šä¹‰æ™ºèƒ½æŒ‡é’ˆ</a></h2>
<details id="admonition-mystringç»“æ„ç¤ºæ„å›¾" class="admonition info">
<summary class="admonition-title">
<p>MyStringç»“æ„ç¤ºæ„å›¾</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-mystringç»“æ„ç¤ºæ„å›¾"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/15%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BF%99%E4%BA%9B%E6%B5%93%E7%9C%89%E5%A4%A7%E7%9C%BC%E7%9A%84%E7%BB%93%E6%9E%84%E7%AB%9F%E7%84%B6%E9%83%BD%E6%98%AF%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%EF%BC%9F-4783668.jpg" alt="MyString" /></p>
</div>
</details>
<details id="admonition-mystringå®ç°ä»£ç " class="admonition info">
<summary class="admonition-title">
<p>MyStringå®ç°ä»£ç </p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-mystringå®ç°ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use std::{fmt, ops::Deref, str};

const MINI_STRING_MAX_LEN: usize = 30;

// MyString é‡Œï¼ŒString æœ‰ 3 ä¸ª wordï¼Œä¾› 24 å­—èŠ‚ï¼Œæ‰€ä»¥å®ƒä»¥ 8 å­—èŠ‚å¯¹é½
// æ‰€ä»¥ enum çš„ tag + padding æœ€å°‘ 8 å­—èŠ‚ï¼Œæ•´ä¸ªç»“æ„å  32 å­—èŠ‚ã€‚
// MiniString å¯ä»¥æœ€å¤šæœ‰ 30 å­—èŠ‚ï¼ˆå†åŠ ä¸Š 1 å­—èŠ‚é•¿åº¦å’Œ 1å­—èŠ‚ tagï¼‰ï¼Œå°±æ˜¯ 32 å­—èŠ‚.
struct MiniString {
    len: u8,
    data: [u8; MINI_STRING_MAX_LEN],
}

impl MiniString {
    // è¿™é‡Œ new æ¥å£ä¸æš´éœ²å‡ºå»ï¼Œä¿è¯ä¼ å…¥çš„ v çš„å­—èŠ‚é•¿åº¦å°äºç­‰äº 30
    fn new(v: impl AsRef&lt;str&gt;) -&gt; Self {
        let bytes = v.as_ref().as_bytes();
        // æˆ‘ä»¬åœ¨æ‹·è´å†…å®¹æ—¶ä¸€å®šè¦è¦ä½¿ç”¨å­—ç¬¦ä¸²çš„å­—èŠ‚é•¿åº¦
        let len = bytes.len();
        let mut data = [0u8; MINI_STRING_MAX_LEN];
        data[..len].copy_from_slice(bytes);
        Self {
            len: len as u8,
            data,
        }
    }
}

impl Deref for MiniString {
    type Target = str;

    fn deref(&amp;self) -&gt; &amp;Self::Target {
        // ç”±äºç”Ÿæˆ MiniString çš„æ¥å£æ˜¯éšè—çš„ï¼Œå®ƒåªèƒ½æ¥è‡ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¸‹é¢è¿™è¡Œæ˜¯å®‰å…¨çš„
        str::from_utf8(&amp;self.data[..self.len as usize]).unwrap()
        // ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ unsafe ç‰ˆæœ¬
        // unsafe { str::from_utf8_unchecked(&amp;self.data[..self.len as usize]) }
    }
}

impl fmt::Debug for MiniString {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        // è¿™é‡Œç”±äºå®ç°äº† Deref traitï¼Œå¯ä»¥ç›´æ¥å¾—åˆ°ä¸€ä¸ª &amp;str è¾“å‡º
        write!(f, &quot;{}&quot;, self.deref())
    }
}

#[derive(Debug)]
enum MyString {
    Inline(MiniString),
    Standard(String),
}

// å®ç° Deref æ¥å£å¯¹ä¸¤ç§ä¸åŒçš„åœºæ™¯ç»Ÿä¸€å¾—åˆ° &amp;str
impl Deref for MyString {
    type Target = str;

    fn deref(&amp;self) -&gt; &amp;Self::Target {
        match *self {
            MyString::Inline(ref v) =&gt; v.deref(),
            MyString::Standard(ref v) =&gt; v.deref(),
        }
    }
}

// impl From&lt;&amp;str&gt; for MyString {
//     fn from(s: &amp;str) -&gt; Self {
//         match s.len() &gt; MINI_STRING_MAX_LEN {
//             true =&gt; Self::Standard(s.to_owned()),
//             _ =&gt; Self::Inline(MiniString::new(s)),
//         }
//     }
// }

// impl From&lt;String&gt; for MyString {
//     fn from(s: String) -&gt; Self {
//         match s.len() &gt; MINI_STRING_MAX_LEN {
//             true =&gt; Self::Standard(s),
//             _ =&gt; Self::Inline(MiniString::new(s)),
//         }
//     }
// }

impl&lt;T&gt; From&lt;T&gt; for MyString
where
    T: AsRef&lt;str&gt;,
{
    fn from(s: T) -&gt; Self {
        match s.as_ref().len() &gt; MINI_STRING_MAX_LEN {
            true =&gt; Self::Standard(s.as_ref().to_owned()),
            _ =&gt; Self::Inline(MiniString::new(s)),
        }
    }
}

impl fmt::Display for MyString {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, &quot;{}&quot;, self.deref())
    }
}

impl MyString {
    pub fn push_str(&amp;mut self, s: &amp;str) {
        match *self {
            MyString::Inline(ref mut v) =&gt; {
                let len = v.len as usize;
                let len1 = s.len();
                if len + len1 &gt; MINI_STRING_MAX_LEN {
                    let mut owned = v.deref().to_string();
                    owned.push_str(s);
                    *self = MyString::Standard(owned);
                } else {
                    let total = len + len1;
                    v.data[len..len + len1].copy_from_slice(s.as_bytes());
                    v.len = total as u8;
                }
            }
            MyString::Standard(ref mut v) =&gt; v.push_str(s),
        }
    }
}

fn main() {
    let len1 = std::mem::size_of::&lt;MyString&gt;();
    let len2 = std::mem::size_of::&lt;MiniString&gt;();
    println!(&quot;Len: MyString {}, MiniString {}&quot;, len1, len2);

    let s1: MyString = &quot;hello world&quot;.into();
    let s2: MyString = &quot;è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²&quot;.into();

    // debug è¾“å‡º
    println!(&quot;s1: {:?}, s2: {:?}&quot;, s1, s2);
    // display è¾“å‡º
    println!(
        &quot;s1: {}({} bytes, {} chars), s2: {}({} bytes, {} chars)&quot;,
        s1,
        s1.len(),
        s1.chars().count(),
        s2,
        s2.len(),
        s2.chars().count()
    );

    // MyString å¯ä»¥ä½¿ç”¨ä¸€åˆ‡ &amp;str æ¥å£ï¼Œæ„Ÿè°¢ Rust çš„è‡ªåŠ¨ Deref
    assert!(s1.ends_with(&quot;world&quot;));
    assert!(s2.starts_with('è¿™'));

    let s = String::from(&quot;è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²&quot;);
    println!(&quot;s: {:p}&quot;, &amp;*s);
    // From&lt;T: AsRef&lt;str&gt;&gt; çš„å®ç°ä¼šå¯¼è‡´é¢å¤–çš„å¤åˆ¶
    let s3: MyString = s.into();
    println!(&quot;s3: {:p}&quot;, &amp;*s3);

    let mut s4: MyString = &quot;Hello Tyr! &quot;.into();
    println!(&quot;s4: {:?}&quot;, s4);
    s4.push_str(&quot;è¿™æ˜¯ä¸€ä¸ªè¶…è¿‡äº†ä¸‰åä¸ªå­—èŠ‚çš„å¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²&quot;);
    println!(&quot;s4: {:?}&quot;, s4);
}
</code></pre></pre>
<hr />
<p>ä¸ºäº†è®© MyString è¡¨ç°è¡Œä¸ºå’Œ &amp;str ä¸€è‡´:</p>
<ol>
<li>æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç° Deref trait è®© MyString å¯ä»¥è¢«è§£å¼•ç”¨æˆ &amp;strã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®ç° Debug/Display å’Œ From<T> traitï¼Œè®© MyString ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿ã€‚</li>
<li>è¿™ä¸ªç®€å•å®ç°çš„ MyStringï¼Œä¸ç®¡å®ƒå†…éƒ¨çš„æ•°æ®æ˜¯çº¯æ ˆä¸Šçš„ MiniString ç‰ˆæœ¬ï¼Œè¿˜æ˜¯åŒ…å«å † ä¸Šå†…å­˜çš„ String ç‰ˆæœ¬ï¼Œä½¿ç”¨çš„ä½“éªŒå’Œ &amp;str éƒ½ä¸€è‡´ï¼Œä»…ä»…ç‰ºç‰²äº†ä¸€ç‚¹ç‚¹æ•ˆç‡å’Œå†…å­˜ï¼Œå°±å¯
ä»¥è®©å°å®¹é‡çš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥é«˜æ•ˆåœ°å­˜å‚¨åœ¨æ ˆä¸Šå¹¶ä¸”è‡ªå¦‚åœ°ä½¿ç”¨ã€‚</li>
<li><a href="https://github.com/bodil/smartstring">smartstring</a> çš„ç¬¬ä¸‰æ–¹åº“å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Œè¿˜åšäº†ä¼˜åŒ–ã€‚</li>
</ol>
</div>
</details>
<h1 id="äºŒé›†åˆå®¹å™¨"><a class="header" href="#äºŒé›†åˆå®¹å™¨">äºŒã€é›†åˆå®¹å™¨</a></h1>
<h2 id="å¯¹å®¹å™¨è¿›è¡Œå®šä¹‰"><a class="header" href="#å¯¹å®¹å™¨è¿›è¡Œå®šä¹‰">å¯¹å®¹å™¨è¿›è¡Œå®šä¹‰</a></h2>
<details id="admonition-å®¹å™¨æ•°æ®ç»“æ„å¦‚ä½•ç†è§£" class="admonition tip">
<summary class="admonition-title">
<p>å®¹å™¨æ•°æ®ç»“æ„å¦‚ä½•ç†è§£</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å®¹å™¨æ•°æ®ç»“æ„å¦‚ä½•ç†è§£"></a></p>
</summary>
<div>
<p>æåˆ°å®¹å™¨ï¼Œå¾ˆå¯èƒ½ä½ é¦–å…ˆä¼šæƒ³åˆ°çš„å°±æ˜¯æ•°ç»„ã€åˆ—è¡¨è¿™äº›å¯ä»¥éå†çš„å®¹å™¨ï¼Œä½†å…¶å®åªè¦æŠŠæŸ ç§ç‰¹å®šçš„æ•°æ®å°è£…åœ¨æŸä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„å°±æ˜¯ä¸€ä¸ªå®¹å™¨ã€‚æ¯”å¦‚ Option<T>ï¼Œå®ƒ æ˜¯ä¸€ä¸ªåŒ…è£¹äº† T å­˜åœ¨æˆ–ä¸å­˜åœ¨çš„å®¹å™¨ï¼Œè€Œ Cow æ˜¯ä¸€ä¸ªå°è£…äº†å†…éƒ¨æ•°æ® B æˆ–è¢«å€Ÿç”¨æˆ–æ‹¥æœ‰ æ‰€æœ‰æƒçš„å®¹å™¨ã€‚</p>
</div>
</details>
<h2 id="å¯¹é›†åˆå®¹å™¨è¿›è¡Œå®šä¹‰"><a class="header" href="#å¯¹é›†åˆå®¹å™¨è¿›è¡Œå®šä¹‰">å¯¹é›†åˆå®¹å™¨è¿›è¡Œå®šä¹‰</a></h2>
<details id="admonition-æŠŠæ‹¥æœ‰ç›¸åŒç±»å‹å¯¹æ•°æ®æ”¾åœ¨ä¸€èµ·ç»Ÿä¸€å¤„ç†" class="admonition tip">
<summary class="admonition-title">
<p>æŠŠæ‹¥æœ‰ç›¸åŒç±»å‹å¯¹æ•°æ®æ”¾åœ¨ä¸€èµ·ï¼Œç»Ÿä¸€å¤„ç†</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æŠŠæ‹¥æœ‰ç›¸åŒç±»å‹å¯¹æ•°æ®æ”¾åœ¨ä¸€èµ·ç»Ÿä¸€å¤„ç†"></a></p>
</summary>
<div>
<p>é›†åˆå®¹å™¨ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æŠŠä¸€ç³»åˆ—æ‹¥æœ‰ç›¸åŒç±»å‹çš„æ•°æ®æ”¾åœ¨ä¸€èµ·ï¼Œç»Ÿä¸€å¤„ç†ï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>
<p>æˆ‘ä»¬ç†Ÿæ‚‰çš„å­—ç¬¦ä¸² Stringã€æ•°ç»„ [T; n]ã€åˆ—è¡¨ Vec<T> å’Œå“ˆå¸Œè¡¨ HashMap&lt;K, V&gt; ç­‰ï¼›</p>
</li>
<li>
<p>è™½ç„¶åˆ°å¤„åœ¨ä½¿ç”¨ï¼Œä½†è¿˜å¹¶ä¸ç†Ÿæ‚‰çš„åˆ‡ç‰‡ sliceï¼›</p>
</li>
<li>
<p>åœ¨å…¶ä»–è¯­è¨€ä¸­ä½¿ç”¨è¿‡ï¼Œä½†åœ¨ Rust ä¸­è¿˜æ²¡æœ‰ç”¨è¿‡çš„å¾ªç¯ç¼“å†²åŒº VecDeque<T>ã€åŒå‘åˆ— è¡¨ LinkedList<T> ç­‰ã€‚</p>
</li>
</ol>
<blockquote>
<p>è¿™äº›é›†åˆå®¹å™¨æœ‰å¾ˆå¤šå…±æ€§ï¼Œæ¯”å¦‚å¯ä»¥è¢«éå†ã€å¯ä»¥è¿›è¡Œ map-reduce æ“ä½œã€å¯ä»¥ä»ä¸€ç§ç±» å‹è½¬æ¢æˆå¦ä¸€ç§ç±»å‹ç­‰ç­‰ã€‚</p>
</blockquote>
</div>
</details>
<h2 id="åˆ‡ç‰‡"><a class="header" href="#åˆ‡ç‰‡">åˆ‡ç‰‡</a></h2>
<details id="admonition-åˆ‡ç‰‡åˆ°åº•æ˜¯ä»€ä¹ˆ" class="admonition tip">
<summary class="admonition-title">
<p>åˆ‡ç‰‡åˆ°åº•æ˜¯ä»€ä¹ˆ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-åˆ‡ç‰‡åˆ°åº•æ˜¯ä»€ä¹ˆ"></a></p>
</summary>
<div>
<p>åœ¨ Rust é‡Œï¼Œåˆ‡ç‰‡æ˜¯æè¿°ä¸€ç»„å±äºåŒä¸€ç±»å‹ã€é•¿åº¦ä¸ç¡®å®šçš„ã€åœ¨å†…å­˜ä¸­è¿ç»­å­˜æ”¾çš„æ•°æ®ç»“ æ„ï¼Œç”¨ [T] æ¥è¡¨è¿°ã€‚å› ä¸ºé•¿åº¦ä¸ç¡®å®šï¼Œæ‰€ä»¥åˆ‡ç‰‡æ˜¯ä¸ª DSTï¼ˆDynamically Sized Typeï¼‰ã€‚</p>
<p>åˆ‡ç‰‡ä¸€èˆ¬åªå‡ºç°åœ¨æ•°æ®ç»“æ„çš„å®šä¹‰ä¸­ï¼Œä¸èƒ½ç›´æ¥è®¿é—®ï¼Œåœ¨ä½¿ç”¨ä¸­ä¸»è¦ç”¨ä»¥ä¸‹å½¢å¼ï¼š</p>
<ul>
<li>
<p>&amp;[T]ï¼šè¡¨ç¤ºä¸€ä¸ªåªè¯»çš„åˆ‡ç‰‡å¼•ç”¨ã€‚</p>
</li>
<li>
<p>&amp;mut [T]ï¼šè¡¨ç¤ºä¸€ä¸ªå¯å†™çš„åˆ‡ç‰‡å¼•ç”¨ã€‚</p>
</li>
<li>
<p>Box&lt;[T]&gt;ï¼šä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„åˆ‡ç‰‡ã€‚</p>
</li>
</ul>
</div>
</details>
<details id="admonition-åˆ‡ç‰‡ä¸æ•°æ®çš„å…³ç³»" class="admonition tip">
<summary class="admonition-title">
<p>åˆ‡ç‰‡ä¸æ•°æ®çš„å…³ç³»</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-åˆ‡ç‰‡ä¸æ•°æ®çš„å…³ç³»"></a></p>
</summary>
<div>
<h2 id="æ€ä¹ˆç†è§£åˆ‡ç‰‡å‘¢æˆ‘æ‰“ä¸ªæ¯”æ–¹åˆ‡ç‰‡ä¹‹äºå…·ä½“çš„æ•°æ®ç»“æ„å°±åƒæ•°æ®åº“ä¸­çš„è§†å›¾ä¹‹äºè¡¨-ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ç§å·¥å…·è®©æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€è®¿é—®è¡Œä¸ºç›¸åŒç»“æ„ç±»ä¼¼ä½†æœ‰äº›è®¸å·®å¼‚çš„ç±»-å‹"><a class="header" href="#æ€ä¹ˆç†è§£åˆ‡ç‰‡å‘¢æˆ‘æ‰“ä¸ªæ¯”æ–¹åˆ‡ç‰‡ä¹‹äºå…·ä½“çš„æ•°æ®ç»“æ„å°±åƒæ•°æ®åº“ä¸­çš„è§†å›¾ä¹‹äºè¡¨-ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ç§å·¥å…·è®©æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€è®¿é—®è¡Œä¸ºç›¸åŒç»“æ„ç±»ä¼¼ä½†æœ‰äº›è®¸å·®å¼‚çš„ç±»-å‹">æ€ä¹ˆç†è§£åˆ‡ç‰‡å‘¢ï¼Ÿæˆ‘æ‰“ä¸ªæ¯”æ–¹ï¼Œåˆ‡ç‰‡ä¹‹äºå…·ä½“çš„æ•°æ®ç»“æ„ï¼Œå°±åƒæ•°æ®åº“ä¸­çš„è§†å›¾ä¹‹äºè¡¨ã€‚ ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ç§å·¥å…·ï¼Œè®©æˆ‘ä»¬å¯ä»¥ç»Ÿä¸€è®¿é—®è¡Œä¸ºç›¸åŒã€ç»“æ„ç±»ä¼¼ä½†æœ‰äº›è®¸å·®å¼‚çš„ç±» å‹ã€‚</a></h2>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let arr = [1, 2, 3, 4, 5];
    let vec = vec![1, 2, 3, 4, 5];
    let s1 = &amp;arr[1..3];
    let s2 = &amp;vec[1..3];
    println!(&quot;s1: {:?}, s2: {:?}&quot;, s1, s2);

    // &amp;[T] å’Œ &amp;[T] æ˜¯å¦ç›¸ç­‰å–å†³äºé•¿åº¦å’Œå†…å®¹æ˜¯å¦ç›¸ç­‰
    assert_eq!(s1, s2);
    // &amp;[T] å¯ä»¥å’Œ Vec&lt;T&gt;/[T;n] æ¯”è¾ƒï¼Œä¹Ÿä¼šçœ‹é•¿åº¦å’Œå†…å®¹
    assert_eq!(&amp;arr[..], vec);
    assert_eq!(&amp;vec[..], arr);
}
</code></pre></pre>
<ol>
<li>å¯¹äº array å’Œ vectorï¼Œè™½ç„¶æ˜¯ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œä¸€ä¸ªæ”¾åœ¨æ ˆä¸Šï¼Œä¸€ä¸ªæ”¾åœ¨å †ä¸Šï¼Œä½†å®ƒä»¬çš„ åˆ‡ç‰‡æ˜¯ç±»ä¼¼çš„ï¼›</li>
<li>è€Œä¸”å¯¹äºç›¸åŒå†…å®¹æ•°æ®çš„ç›¸åŒåˆ‡ç‰‡ï¼Œæ¯”å¦‚ &amp;arr[1â€¦3] å’Œ &amp;vec[1â€¦3]ï¼Œè¿™ ä¸¤è€…æ˜¯ç­‰ä»·çš„ã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œåˆ‡ç‰‡å’Œå¯¹åº”çš„æ•°æ®ç»“æ„ä¹Ÿå¯ä»¥ç›´æ¥æ¯”è¾ƒï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬ä¹‹é—´å® ç°äº† PartialEq trait
<img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4785008.jpg" alt="åˆ‡ç‰‡ä¸å…·ä½“æ•°æ®çš„å…³ç³»" /></li>
</ol>
</div>
</details>
<h3 id="array-vs-vector"><a class="header" href="#array-vs-vector">array vs vector</a></h3>
<details id="admonition-arrayå’Œvectorçš„åŒºåˆ«ä¸è”ç³»" class="admonition info">
<summary class="admonition-title">
<p>arrayå’Œvectorçš„åŒºåˆ«ä¸è”ç³»</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-arrayå’Œvectorçš„åŒºåˆ«ä¸è”ç³»"></a></p>
</summary>
<div>
<p>å¯¹äº array å’Œ vectorï¼Œè™½ç„¶æ˜¯ä¸åŒçš„æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ”¾åœ¨æ ˆä¸Š</li>
<li>ä¸€ä¸ªæ”¾åœ¨å †ä¸Š</li>
</ul>
<blockquote>
<p>ä½†å®ƒä»¬çš„åˆ‡ç‰‡æ˜¯ç±»ä¼¼çš„, è€Œä¸”å¯¹äºç›¸åŒå†…å®¹æ•°æ®çš„ç›¸åŒåˆ‡ç‰‡</p>
</blockquote>
<ul>
<li>æ¯”å¦‚ &amp;arr[1â€¦3] å’Œ &amp;vec[1â€¦3]ï¼Œè¿™ä¸¤è€…æ˜¯ç­‰ä»·çš„ã€‚</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼Œåˆ‡ç‰‡å’Œå¯¹åº”çš„æ•°æ®ç»“æ„ä¹Ÿå¯ä»¥ç›´æ¥æ¯”è¾ƒï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬ä¹‹é—´å®ç°äº† PartialEq traitï¼ˆæºç å‚è€ƒèµ„æ–™ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>ä¸‹å›¾æ¯”è¾ƒæ¸…æ™°åœ°å‘ˆç°äº†åˆ‡ç‰‡å’Œæ•°æ®ä¹‹é—´çš„å…³ç³»ï¼š
<img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4866674.jpg" alt="åˆ‡ç‰‡å’Œæ•°æ®ä¹‹é—´çš„å…³ç³»" /></p>
</blockquote>
</div>
</details>
<h3 id="vec-å’Œ-t"><a class="header" href="#vec-å’Œ-t">Vec<T> å’Œ &amp;[T]</a></h3>
<details id="admonition-tä¸vectå…³ç³»" class="admonition tip">
<summary class="admonition-title">
<p>&amp;[T]ä¸&amp;Vec[T]å…³ç³»</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-tä¸vectå…³ç³»"></a></p>
</summary>
<div>
<p>![&amp;[T]å’Œ&amp;Vec[T]](https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4785147.jpg)</p>
</div>
</details>
<h3 id="è§£å¼•ç”¨"><a class="header" href="#è§£å¼•ç”¨">è§£å¼•ç”¨</a></h3>
<details id="admonition-æ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹å¯ä»¥æ ¹æ®éœ€è¦è§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>æ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹å¯ä»¥æ ¹æ®éœ€è¦è§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹å¯ä»¥æ ¹æ®éœ€è¦è§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹"></a></p>
</summary>
<div>
<p>åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæ”¯æŒåˆ‡ç‰‡çš„å…·ä½“æ•°æ®ç±»å‹ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ï¼Œè§£å¼•ç”¨è½¬æ¢æˆåˆ‡ç‰‡ç±»å‹ã€‚</p>
<ul>
<li>æ¯”å¦‚ Vec<T> å’Œ [T; n] ä¼šè½¬åŒ–æˆä¸º &amp;[T]ï¼Œè¿™æ˜¯å› ä¸º Vec<T> å®ç°äº† Deref traitï¼Œè€Œ array å†…å»ºäº†åˆ° &amp;[T] çš„è§£å¼•ç”¨ã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥å†™ä¸€æ®µä»£ç éªŒè¯è¿™ä¸€è¡Œä¸ºï¼ˆä»£ç ï¼‰ï¼š</li>
</ul>
<hr />
<pre><pre class="playground"><code class="language-rust  editable">
use std::fmt;
fn main() {
    let v = vec![1, 2, 3, 4];

    // Vec å®ç°äº† Derefï¼Œ&amp;Vec&lt;T&gt; ä¼šè¢«è‡ªåŠ¨è§£å¼•ç”¨ä¸º &amp;[T]ï¼Œç¬¦åˆæ¥å£å®šä¹‰
    print_slice(&amp;v);
    // ç›´æ¥æ˜¯ &amp;[T]ï¼Œç¬¦åˆæ¥å£å®šä¹‰
    print_slice(&amp;v[..]);

    // &amp;Vec&lt;T&gt; æ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(&amp;v);
    // &amp;[T] æ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(&amp;v[..]);
    // Vec&lt;T&gt; ä¹Ÿæ”¯æŒ AsRef&lt;[T]&gt;
    print_slice1(v);

    let arr = [1, 2, 3, 4];
    // æ•°ç»„è™½æ²¡æœ‰å®ç° Derefï¼Œä½†å®ƒçš„è§£å¼•ç”¨å°±æ˜¯ &amp;[T]
    print_slice(&amp;arr);
    print_slice(&amp;arr[..]);
    print_slice1(&amp;arr);
    print_slice1(&amp;arr[..]);
    print_slice1(arr);
}

// æ³¨æ„ä¸‹é¢çš„æ³›å‹å‡½æ•°çš„ä½¿ç”¨
fn print_slice&lt;T: fmt::Debug&gt;(s: &amp;[T]) {
    println!(&quot;{:?}&quot;, s);
}

fn print_slice1&lt;T, U&gt;(s: T)
where
    T: AsRef&lt;[U]&gt;,
    U: fmt::Debug,
{
    println!(&quot;{:?}&quot;, s.as_ref());
}
</code></pre></pre>
<hr />
<blockquote>
<p>è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œé€šè¿‡è§£å¼•ç”¨ï¼Œè¿™å‡ ä¸ªå’Œåˆ‡ç‰‡æœ‰å…³çš„æ•°æ®ç»“æ„éƒ½ä¼šè·å¾—åˆ‡ç‰‡çš„æ‰€æœ‰èƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼šbinary_searchã€chunksã€concatã€containsã€start_withã€end_withã€group_byã€iterã€joinã€sortã€splitã€swap ç­‰ä¸€ç³»åˆ—ä¸°å¯Œçš„åŠŸèƒ½ï¼Œ</p>
</blockquote>
</div>
</details>
<h3 id="åˆ‡ç‰‡å’Œè¿­ä»£å™¨-iterator"><a class="header" href="#åˆ‡ç‰‡å’Œè¿­ä»£å™¨-iterator">åˆ‡ç‰‡å’Œè¿­ä»£å™¨ Iterator</a></h3>
<details id="admonition-è¿­ä»£å™¨å¯ä»¥è¯´æ˜¯åˆ‡ç‰‡çš„å­ªç”Ÿå…„å¼Ÿ" class="admonition info">
<summary class="admonition-title">
<p>è¿­ä»£å™¨å¯ä»¥è¯´æ˜¯åˆ‡ç‰‡çš„å­ªç”Ÿå…„å¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-è¿­ä»£å™¨å¯ä»¥è¯´æ˜¯åˆ‡ç‰‡çš„å­ªç”Ÿå…„å¼Ÿ"></a></p>
</summary>
<div>
<p>è¿­ä»£å™¨å¯ä»¥è¯´æ˜¯åˆ‡ç‰‡çš„å­ªç”Ÿå…„å¼Ÿã€‚åˆ‡ç‰‡æ˜¯é›†åˆæ•°æ®çš„è§†å›¾ï¼Œè€Œè¿­ä»£å™¨å®šä¹‰äº†å¯¹é›†åˆæ•°æ®çš„å„ç§å„æ ·çš„è®¿é—®æ“ä½œã€‚</p>
<p>Iterator trait æœ‰å¤§é‡çš„æ–¹æ³•ï¼Œä½†ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€è¦å®šä¹‰å®ƒçš„å…³è”ç±»å‹ Item å’Œ next() æ–¹æ³•ã€‚</p>
<ul>
<li>Item å®šä¹‰äº†æ¯æ¬¡æˆ‘ä»¬ä»è¿­ä»£å™¨ä¸­å–å‡ºçš„æ•°æ®ç±»å‹ï¼›</li>
<li>next() æ˜¯ä»è¿­ä»£å™¨é‡Œå–ä¸‹ä¸€ä¸ªå€¼çš„æ–¹æ³•ã€‚å½“ä¸€ä¸ªè¿­ä»£å™¨çš„ next() æ–¹æ³•è¿”å› None æ—¶ï¼Œè¡¨æ˜è¿­ä»£å™¨ä¸­æ²¡æœ‰æ•°æ®äº†ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>#[must_use = &quot;iterators are lazy and do nothing unless consumed&quot;]
pub trait Iterator {
    type Item;
    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;;
    // å¤§é‡ç¼ºçœçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ size_hint, count, chain, zip, map, 
    // filter, for_each, skip, take_while, flat_map, flatten
    // collect, partition ç­‰
    ... 
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-å¯¹-vec-ä½¿ç”¨-iter-æ–¹æ³•å¹¶è¿›è¡Œå„ç§-map--filter--take-æ“ä½œ" class="admonition info">
<summary class="admonition-title">
<p>å¯¹ Vec<T> ä½¿ç”¨ iter() æ–¹æ³•ï¼Œå¹¶è¿›è¡Œå„ç§ map / filter / take æ“ä½œ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å¯¹-vec-ä½¿ç”¨-iter-æ–¹æ³•å¹¶è¿›è¡Œå„ç§-map--filter--take-æ“ä½œ"></a></p>
</summary>
<div>
<p>ä¸€ä¸ªä¾‹å­ï¼šå¯¹ Vec<T> ä½¿ç”¨ iter() æ–¹æ³•ï¼Œå¹¶è¿›è¡Œå„ç§ map / filter / take æ“ä½œã€‚åœ¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œè¿™æ ·çš„å†™æ³•å¾ˆå¸¸è§ï¼Œä»£ç çš„å¯è¯»æ€§å¾ˆå¼ºã€‚Rust ä¹Ÿæ”¯æŒè¿™ç§å†™æ³•ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
fn main() {
    // è¿™é‡Œ Vec&lt;T&gt; åœ¨è°ƒç”¨ iter() æ—¶è¢«è§£å¼•ç”¨æˆ &amp;[T]ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—® iter()
    let result = vec![1, 2, 3, 4]
        .iter()
        .map(|v| v * v)
        .filter(|v| *v &lt; 16)
        .take(1)
        .collect::&lt;Vec&lt;_&gt;&gt;();

    println!(&quot;{:?}&quot;, result);
}
</code></pre></pre>
</div>
</details>
<details id="admonition-rustçš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£è¿™æ˜¯å¦‚ä½•å®ç°çš„" class="admonition info">
<summary class="admonition-title">
<p>Rustçš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£ï¼Œè¿™æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-rustçš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£è¿™æ˜¯å¦‚ä½•å®ç°çš„"></a></p>
</summary>
<div>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ Rust ä¸‹çš„è¿­ä»£å™¨æ˜¯ä¸ªæ‡’æ¥å£ï¼ˆlazy interfaceï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ®µä»£ç ç›´åˆ°è¿è¡Œåˆ° collect æ—¶æ‰çœŸæ­£å¼€å§‹æ‰§è¡Œï¼Œä¹‹å‰çš„éƒ¨åˆ†ä¸è¿‡æ˜¯åœ¨ä¸æ–­åœ°ç”Ÿæˆæ–°çš„ç»“æ„ï¼Œæ¥ç´¯ç§¯å¤„ç†é€»è¾‘è€Œå·²ã€‚ä½ å¯èƒ½å¥½å¥‡ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>åŸæ¥ï¼ŒIterator å¤§éƒ¨åˆ†æ–¹æ³•éƒ½è¿”å›ä¸€ä¸ªå®ç°äº† Iterator çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·ä¸€è·¯é“¾å¼ä¸‹å»ï¼Œåœ¨ Rust æ ‡å‡†åº“ä¸­ï¼Œè¿™äº›æ•°æ®ç»“æ„è¢«ç§°ä¸º <a href="https://doc.rust-lang.org/src/core/iter/adapters/mod.rs.html">Iterator Adapter</a>ã€‚æ¯”å¦‚ä¸Šé¢çš„ map æ–¹æ³•ï¼Œå®ƒè¿”å› Map ç»“æ„ï¼Œè€Œ Map ç»“æ„å®ç°äº† <a href="https://doc.rust-lang.org/src/core/iter/adapters/map.rs.html#93-133">Iteratorï¼ˆæºç ï¼‰</a>ã€‚
æ•´ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼ˆé“¾æ¥å‡ä¸ºæºç èµ„æ–™ï¼‰ï¼š</p>
<ol>
<li>åœ¨ collect() æ‰§è¡Œçš„æ—¶å€™ï¼Œå®ƒ<a href="https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#1744-1749">å®é™…è¯•å›¾ä½¿ç”¨ FromIterator ä»è¿­ä»£å™¨ä¸­æ„å»ºä¸€ä¸ªé›†åˆç±»å‹</a>ï¼Œè¿™ä¼šä¸æ–­è°ƒç”¨ next() è·å–ä¸‹ä¸€ä¸ªæ•°æ®ï¼›</li>
<li>æ­¤æ—¶çš„ Iterator æ˜¯ Takeï¼ŒTake è°ƒè‡ªå·±çš„ next()ï¼Œä¹Ÿå°±æ˜¯å®ƒä¼š<a href="https://doc.rust-lang.org/src/core/iter/adapters/take.rs.html#34-41">è°ƒç”¨ Filter çš„ next()</a>ï¼›</li>
<li>Filter çš„ next() å®é™…ä¸Š<a href="https://time.geekbang.org/column/article/422975">è°ƒç”¨è‡ªå·±å†…éƒ¨çš„ iter çš„ find()</a>ï¼Œæ­¤æ—¶å†…éƒ¨çš„ iter æ˜¯ Mapï¼Œfind() ä¼šä½¿ç”¨ <a href="https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#2312-2325">try_fold()</a>ï¼Œå®ƒä¼š<a href="https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#2382-2406">ç»§ç»­è°ƒç”¨ next()</a>ï¼Œä¹Ÿå°±æ˜¯ Map çš„ next()ï¼›</li>
<li>Map çš„ next() ä¼š<a href="https://time.geekbang.org/column/article/422975">è°ƒç”¨å…¶å†…éƒ¨çš„ iter å– next() ç„¶åæ‰§è¡Œ map å‡½æ•°</a>ã€‚è€Œæ­¤æ—¶å†…éƒ¨çš„ iter æ¥è‡ª Vec<i32>ã€‚</li>
</ol>
<p>æ‰€ä»¥ï¼Œåªæœ‰åœ¨ collect() æ—¶ï¼Œæ‰è§¦å‘ä»£ç ä¸€å±‚å±‚è°ƒç”¨ä¸‹å»ï¼Œå¹¶ä¸”è°ƒç”¨ä¼šæ ¹æ®éœ€è¦éšæ—¶ç»“æŸã€‚è¿™æ®µä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨äº† take(1)ï¼Œæ•´ä¸ªè°ƒç”¨é“¾å¾ªç¯ä¸€æ¬¡ï¼Œå°±èƒ½æ»¡è¶³ take(1) ä»¥åŠæ‰€æœ‰ä¸­é—´è¿‡ç¨‹çš„è¦æ±‚ï¼Œæ‰€ä»¥å®ƒåªä¼šå¾ªç¯ä¸€æ¬¡ã€‚</p>
</div>
</details>
<details id="admonition-rustçš„å‡½æ•°å¼ç¼–ç¨‹å†™æ³•æ€§èƒ½å¦‚ä½•" class="admonition info">
<summary class="admonition-title">
<p>Rustçš„å‡½æ•°å¼ç¼–ç¨‹å†™æ³•æ€§èƒ½å¦‚ä½•ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-rustçš„å‡½æ•°å¼ç¼–ç¨‹å†™æ³•æ€§èƒ½å¦‚ä½•"></a></p>
</summary>
<div>
<p>ä½ å¯èƒ½ä¼šæœ‰ç–‘æƒ‘ï¼šè¿™ç§å‡½æ•°å¼ç¼–ç¨‹çš„å†™æ³•ï¼Œä»£ç æ˜¯æ¼‚äº®äº†ï¼Œç„¶è€Œè¿™ä¹ˆå¤šæ— è°“çš„å‡½æ•°è°ƒç”¨ï¼Œæ€§èƒ½è‚¯å®šå¾ˆå·®å§ï¼Ÿæ¯•ç«Ÿï¼Œå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€çš„ä¸€å¤§æ¶åå°±æ˜¯æ€§èƒ½å·®ã€‚</p>
<p>è¿™ä¸ªä½ å®Œå…¨ä¸ç”¨æ‹…å¿ƒï¼Œ Rust å¤§é‡ä½¿ç”¨äº† inline ç­‰ä¼˜åŒ–æŠ€å·§ï¼Œè¿™æ ·éå¸¸æ¸…æ™°å‹å¥½çš„è¡¨è¾¾æ–¹å¼ï¼Œæ€§èƒ½å’Œ C è¯­è¨€çš„ for å¾ªç¯å·®åˆ«ä¸å¤§ã€‚</p>
</div>
</details>
<details id="admonition-rustçš„iteratoré™¤äº†æ ‡å‡†åº“è¿˜æœ‰itertoolsæä¾›æ›´å¤šåŠŸèƒ½" class="admonition info">
<summary class="admonition-title">
<p>Rustçš„iteratoré™¤äº†æ ‡å‡†åº“ï¼Œè¿˜æœ‰itertoolsæä¾›æ›´å¤šåŠŸèƒ½</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-rustçš„iteratoré™¤äº†æ ‡å‡†åº“è¿˜æœ‰itertoolsæä¾›æ›´å¤šåŠŸèƒ½"></a></p>
</summary>
<div>
<p>å¦‚æœæ ‡å‡†åº“ä¸­çš„åŠŸèƒ½è¿˜ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½ å¯ä»¥çœ‹çœ‹ itertoolsï¼Œå®ƒæ˜¯å’Œ Python ä¸‹ itertools åŒåä¸”åŠŸèƒ½ç±»ä¼¼çš„å·¥å…·ï¼Œæä¾›äº†å¤§é‡é¢å¤–çš„ adapterã€‚å¯ä»¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use itertools::Itertools;

fn main() {
    let err_str = &quot;bad happened&quot;;
    let input = vec![Ok(21), Err(err_str), Ok(7)];
    let it = input
        .into_iter()
        .filter_map_ok(|i| if i &gt; 10 { Some(i * 2) } else { None });
    // ç»“æœåº”è¯¥æ˜¯ï¼švec![Ok(42), Err(err_str)]
    println!(&quot;{:?}&quot;, it.collect::&lt;Vec&lt;_&gt;&gt;());
}
</code></pre></pre>
<p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä»ä¸€ç»„ Future ä¸­æ±‡èšå‡ºä¸€ç»„ç»“æœï¼Œé‡Œé¢æœ‰æˆåŠŸæ‰§è¡Œçš„ç»“æœï¼Œä¹Ÿæœ‰å¤±è´¥çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœæƒ³å¯¹æˆåŠŸçš„ç»“æœè¿›ä¸€æ­¥åš filter/mapï¼Œé‚£ä¹ˆæ ‡å‡†åº“å°±æ— æ³•å¸®å¿™äº†ï¼Œå°±éœ€è¦ç”¨ itertools é‡Œçš„ filter_map_ok()ã€‚</p>
</div>
</details>
<h3 id="ç‰¹æ®Šçš„åˆ‡ç‰‡str"><a class="header" href="#ç‰¹æ®Šçš„åˆ‡ç‰‡str">ç‰¹æ®Šçš„åˆ‡ç‰‡ï¼š&amp;str</a></h3>
<details id="admonition-stringstringå’Œstrçš„åŒºåˆ«ä¸è”ç³»" class="admonition info">
<summary class="admonition-title">
<p>Stringã€&amp;Stringå’Œ&amp;strçš„åŒºåˆ«ä¸è”ç³»</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-stringstringå’Œstrçš„åŒºåˆ«ä¸è”ç³»"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ç§ç‰¹æ®Šçš„åˆ‡ç‰‡ï¼š&amp;strã€‚ä¹‹å‰è®²è¿‡ï¼ŒString æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Vec<u8>ï¼Œæ‰€ä»¥åœ¨ String ä¸Šåšåˆ‡ç‰‡ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ &amp;strã€‚</p>
<p>å¯¹äº Stringã€&amp;Stringã€&amp;strï¼Œå¾ˆå¤šäººä¹Ÿç»å¸¸åˆ†ä¸æ¸…å®ƒä»¬çš„åŒºåˆ«ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰çš„ä¸€ç¯‡åŠ é¤ä¸­ç®€å•èŠäº†è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ä¸Šä¸€è®²æ™ºèƒ½æŒ‡é’ˆä¸­ï¼Œä¹Ÿå¯¹æ¯”è¿‡ String å’Œ &amp;strã€‚å¯¹äº &amp;String å’Œ &amp;strï¼Œå¦‚æœä½ ç†è§£äº†ä¸Šæ–‡ä¸­ &amp;Vec<T> å’Œ &amp;[T] çš„åŒºåˆ«ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š
<img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4867212.jpg" alt="&amp;Stringå’Œ&amp;str" /></p>
</div>
</details>
<details id="admonition-stringåœ¨è§£å¼•ç”¨æ—¶ä¼šè½¬æ¢æˆstr" class="admonition info">
<summary class="admonition-title">
<p>Stringåœ¨è§£å¼•ç”¨æ—¶ä¼šè½¬æ¢æˆ&amp;str</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-stringåœ¨è§£å¼•ç”¨æ—¶ä¼šè½¬æ¢æˆstr"></a></p>
</summary>
<div>
<p>String åœ¨è§£å¼•ç”¨æ—¶ï¼Œä¼šè½¬æ¢æˆ &amp;strã€‚å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç éªŒè¯ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::fmt;
fn main() {
    let s = String::from(&quot;hello&quot;);
    // &amp;String ä¼šè¢«è§£å¼•ç”¨æˆ &amp;str
    print_slice(&amp;s);
    // &amp;s[..] å’Œ s.as_str() ä¸€æ ·ï¼Œéƒ½ä¼šå¾—åˆ° &amp;str
    print_slice(&amp;s[..]);

    // String æ”¯æŒ AsRef&lt;str&gt;
    print_slice1(&amp;s);
    print_slice1(&amp;s[..]);
    print_slice1(s.clone());

    // String ä¹Ÿå®ç°äº† AsRef&lt;[u8]&gt;ï¼Œæ‰€ä»¥ä¸‹é¢çš„ä»£ç æˆç«‹
    // æ‰“å°å‡ºæ¥æ˜¯ [104, 101, 108, 108, 111]
    print_slice2(&amp;s);
    print_slice2(&amp;s[..]);
    print_slice2(s);
}

fn print_slice(s: &amp;str) {
    println!(&quot;{:?}&quot;, s);
}

fn print_slice1&lt;T: AsRef&lt;str&gt;&gt;(s: T) {
    println!(&quot;{:?}&quot;, s.as_ref());
}

fn print_slice2&lt;T, U&gt;(s: T)
where
    T: AsRef&lt;[U]&gt;,
    U: fmt::Debug,
{
    println!(&quot;{:?}&quot;, s.as_ref());
}
</code></pre></pre>
</div>
</details>
<details id="admonition-å­—ç¬¦çš„åˆ—è¡¨å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå…³ç³»å’ŒåŒºåˆ«" class="admonition info">
<summary class="admonition-title">
<p>å­—ç¬¦çš„åˆ—è¡¨å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå…³ç³»å’ŒåŒºåˆ«</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å­—ç¬¦çš„åˆ—è¡¨å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå…³ç³»å’ŒåŒºåˆ«"></a></p>
</summary>
<div>
<p>é‚£ä¹ˆå­—ç¬¦çš„åˆ—è¡¨å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå…³ç³»å’ŒåŒºåˆ«ï¼Ÿæˆ‘ä»¬ç›´æ¥å†™ä¸€æ®µä»£ç æ¥çœ‹çœ‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::iter::FromIterator;

fn main() {
    let arr = ['h', 'e', 'l', 'l', 'o'];
    let vec = vec!['h', 'e', 'l', 'l', 'o'];
    let s = String::from(&quot;hello&quot;);
    let s1 = &amp;arr[1..3];
    let s2 = &amp;vec[1..3];
    // &amp;str æœ¬èº«å°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ slice
    let s3 = &amp;s[1..3];
    println!(&quot;s1: {:?}, s2: {:?}, s3: {:?}&quot;, s1, s2, s3);

    // &amp;[char] å’Œ &amp;[char] æ˜¯å¦ç›¸ç­‰å–å†³äºé•¿åº¦å’Œå†…å®¹æ˜¯å¦ç›¸ç­‰
    assert_eq!(s1, s2);
    // &amp;[char] å’Œ &amp;str ä¸èƒ½ç›´æ¥å¯¹æ¯”ï¼Œæˆ‘ä»¬æŠŠ s3 å˜æˆ Vec&lt;char&gt;
    assert_eq!(s2, s3.chars().collect::&lt;Vec&lt;_&gt;&gt;());
    // &amp;[char] å¯ä»¥é€šè¿‡è¿­ä»£å™¨è½¬æ¢æˆ Stringï¼ŒString å’Œ &amp;str å¯ä»¥ç›´æ¥å¯¹æ¯”
    assert_eq!(String::from_iter(s2), s3);
}
</code></pre></pre>
<hr />
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå­—ç¬¦åˆ—è¡¨å¯ä»¥é€šè¿‡è¿­ä»£å™¨è½¬æ¢æˆ Stringï¼ŒString ä¹Ÿå¯ä»¥é€šè¿‡ chars() å‡½æ•°è½¬æ¢æˆå­—ç¬¦åˆ—è¡¨ï¼Œå¦‚æœä¸è½¬æ¢ï¼ŒäºŒè€…ä¸èƒ½æ¯”è¾ƒã€‚</p>
</blockquote>
<hr />
<p>ä¸‹å›¾æŠŠæ•°ç»„ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²ä»¥åŠå®ƒä»¬çš„åˆ‡ç‰‡æ”¾åœ¨ä¸€èµ·æ¯”è¾ƒï¼Œå¯ä»¥æ›´å¥½åœ°ç†è§£å®ƒä»¬çš„åŒºåˆ«ï¼š
<img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4867332.jpg" alt="æ•°ç»„ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²å’Œå„è‡ªçš„åˆ‡ç‰‡" /></p>
</div>
</details>
<h3 id="boxt"><a class="header" href="#boxt">Box&lt;[T]&gt;</a></h3>
<details id="admonition-boxå’Œvectå¯¹æ¯”" class="admonition info">
<summary class="admonition-title">
<p>Box&lt;[T]&gt;å’ŒVec<T>&amp;[T]å¯¹æ¯”</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-boxå’Œvectå¯¹æ¯”"></a></p>
</summary>
<div>
<p>åˆ‡ç‰‡ä¸»è¦æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š</p>
<ul>
<li>åˆ‡ç‰‡çš„åªè¯»å¼•ç”¨ &amp;[T]</li>
<li>åˆ‡ç‰‡çš„å¯å˜å¼•ç”¨ &amp;mut [T]: å’Œ&amp;[T]ç±»ä¼¼</li>
<li>Box&lt;[T]&gt;</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ Box&lt;[T]&gt;ã€‚</p>
<p>Box&lt;[T]&gt; æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„å­˜åœ¨ï¼Œå®ƒå’Œ Vec<T> æœ‰ä¸€ç‚¹ç‚¹å·®åˆ«ï¼š</p>
<ul>
<li>Vec<T> æœ‰é¢å¤–çš„ capacityï¼Œå¯ä»¥å¢é•¿ï¼›</li>
<li>è€Œ Box&lt;[T]&gt; ä¸€æ—¦ç”Ÿæˆå°±å›ºå®šä¸‹æ¥ï¼Œæ²¡æœ‰ capacityï¼Œä¹Ÿæ— æ³•å¢é•¿ã€‚</li>
</ul>
<p>Box&lt;[T]&gt; å’Œåˆ‡ç‰‡çš„å¼•ç”¨ &amp;[T] ä¹Ÿå¾ˆç±»ä¼¼ï¼š</p>
<ol>
<li>å®ƒä»¬éƒ½æ˜¯åœ¨æ ˆä¸Šæœ‰ä¸€ä¸ªåŒ…å«é•¿åº¦çš„èƒ–æŒ‡é’ˆï¼ŒæŒ‡å‘å­˜å‚¨æ•°æ®çš„å†…å­˜ä½ç½®ã€‚</li>
<li>åŒºåˆ«æ˜¯ï¼šBox&lt;[T]&gt; åªä¼šæŒ‡å‘å †ï¼Œ&amp;[T] æŒ‡å‘çš„ä½ç½®å¯ä»¥æ˜¯æ ˆä¹Ÿå¯ä»¥æ˜¯å †ï¼›</li>
<li>æ­¤å¤–ï¼ŒBox&lt;[T]&gt; å¯¹æ•°æ®å…·æœ‰æ‰€æœ‰æƒï¼Œè€Œ &amp;[T] åªæ˜¯ä¸€ä¸ªå€Ÿç”¨ã€‚</li>
</ol>
<hr />
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4867436.jpg" alt="" /></p>
</div>
</details>
<details id="admonition-é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ-box-å‘¢" class="admonition info">
<summary class="admonition-title">
<p>é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ Box&lt;[T]&gt; å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ-box-å‘¢"></a></p>
</summary>
<div>
<p>é‚£ä¹ˆå¦‚ä½•äº§ç”Ÿ Box&lt;[T]&gt; å‘¢ï¼Ÿ
ç›®å‰å¯ç”¨çš„æ¥å£å°±åªæœ‰ä¸€ä¸ªï¼šä»å·²æœ‰çš„ Vec<T> ä¸­è½¬æ¢ã€‚æˆ‘ä»¬çœ‹ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::ops::Deref;

fn main() {
    let mut v1 = vec![1, 2, 3, 4];
    v1.push(5);
    println!(&quot;cap should be 8: {}&quot;, v1.capacity());

    // ä» Vec&lt;T&gt; è½¬æ¢æˆ Box&lt;[T]&gt;ï¼Œæ­¤æ—¶ä¼šä¸¢å¼ƒå¤šä½™çš„ capacity
    let b1 = v1.into_boxed_slice();
    let mut b2 = b1.clone();

    let v2 = b1.into_vec();
    println!(&quot;cap should be exactly 5: {}&quot;, v2.capacity());

    assert!(b2.deref() == v2);

    // Box&lt;[T]&gt; å¯ä»¥æ›´æ”¹å…¶å†…éƒ¨æ•°æ®ï¼Œä½†æ— æ³• push
    b2[0] = 2;
    // b2.push(6);
    println!(&quot;b2: {:?}&quot;, b2);

    // æ³¨æ„ Box&lt;[T]&gt; å’Œ Box&lt;[T; n]&gt; å¹¶ä¸ç›¸åŒ
    let b3 = Box::new([2, 2, 3, 4, 5]);
    println!(&quot;b3: {:?}&quot;, b3);

    // b2 å’Œ b3 ç›¸ç­‰ï¼Œä½† b3.deref() å’Œ v2 æ— æ³•æ¯”è¾ƒ
    assert!(b2 == b3);
    // assert!(b3.deref() == v2);
}
</code></pre></pre>
<hr />
<p>è¿è¡Œä»£ç å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>Vec<T> å¯ä»¥é€šè¿‡ into_boxed_slice() è½¬æ¢æˆ Box&lt;[T]&gt;</li>
<li>Box&lt;[T]&gt; ä¹Ÿå¯ä»¥é€šè¿‡ into_vec() è½¬æ¢å› Vec<T>ã€‚</li>
</ol>
<p>è¿™ä¸¤ä¸ªè½¬æ¢éƒ½æ˜¯å¾ˆè½»é‡çš„è½¬æ¢ï¼Œåªæ˜¯å˜æ¢ä¸€ä¸‹ç»“æ„ï¼Œä¸æ¶‰åŠæ•°æ®çš„æ‹·è´ã€‚</p>
<p>åŒºåˆ«æ˜¯:</p>
<ol>
<li>å½“ Vec<T> è½¬æ¢æˆ Box&lt;[T]&gt; æ—¶ï¼Œæ²¡æœ‰ä½¿ç”¨åˆ°çš„å®¹é‡å°±ä¼šè¢«ä¸¢å¼ƒï¼Œæ‰€ä»¥æ•´ä½“å ç”¨çš„å†…å­˜å¯èƒ½ä¼šé™ä½ã€‚</li>
<li>è€Œä¸” Box&lt;[T]&gt; æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç‰¹æ€§æ˜¯ï¼Œä¸åƒ Box&lt;[T;n]&gt; é‚£æ ·åœ¨ç¼–è¯‘æ—¶å°±è¦ç¡®å®šå¤§å°ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡ŒæœŸç”Ÿæˆï¼Œä»¥åå¤§å°ä¸ä¼šå†æ”¹å˜ã€‚</li>
</ol>
<p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬éœ€è¦åœ¨å †ä¸Šåˆ›å»ºå›ºå®šå¤§å°çš„é›†åˆæ•°æ®ï¼Œä¸”ä¸å¸Œæœ›è‡ªåŠ¨å¢é•¿ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥å…ˆåˆ›å»º Vec<T>ï¼Œå†è½¬æ¢æˆ Box&lt;[T]&gt;ã€‚</p>
<blockquote>
<p>tokio åœ¨æä¾› broadcast channel æ—¶ï¼Œå°±ä½¿ç”¨äº† Box&lt;[T]&gt; è¿™ä¸ªç‰¹æ€§ï¼Œä½ æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è‡ªå·±çœ‹çœ‹<a href="https://github.com/tokio-rs/tokio/blob/master/tokio/src/sync/broadcast.rs#L447">æºç </a>ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="å¸¸ç”¨åˆ‡ç‰‡å¯¹æ¯”å›¾"><a class="header" href="#å¸¸ç”¨åˆ‡ç‰‡å¯¹æ¯”å›¾">å¸¸ç”¨åˆ‡ç‰‡å¯¹æ¯”å›¾</a></h3>
<div id="admonition-strtnvectmuttçš„åŒºåˆ«ä¸è”ç³»å›¾" class="admonition info">
<div class="admonition-title">
<p>&amp;strã€[T;n]ã€Vec<T>ã€&amp;[T]ã€&amp;mut[T]çš„åŒºåˆ«ä¸è”ç³»å›¾ </p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-strtnvectmuttçš„åŒºåˆ«ä¸è”ç³»å›¾"></a></p>
</div>
<div>
<p>ä¸‹å›¾æè¿°äº†åˆ‡ç‰‡å’Œæ•°ç»„ [T;n]ã€åˆ—è¡¨ Vec<T>ã€åˆ‡ç‰‡å¼•ç”¨ &amp;[T] /&amp;mut [T]ï¼Œä»¥åŠåœ¨å †ä¸Šåˆ†é…çš„åˆ‡ç‰‡ Box&lt;[T]&gt; ä¹‹é—´çš„å…³ç³»ã€‚</p>
<blockquote>
<p>å»ºè®®èŠ±äº›æ—¶é—´ç†è§£è¿™å¼ å›¾ï¼Œä¹Ÿå¯ä»¥ç”¨ç›¸åŒçš„æ–¹å¼å»æ€»ç»“å­¦åˆ°çš„å…¶ä»–æœ‰å…³è”çš„æ•°æ®ç»“æ„ã€‚</p>
</blockquote>
<hr />
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/16%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9AVecT%E3%80%81%5BT%5D%E3%80%81Box%5BT%5D%20%EF%BC%8C%E4%BD%A0%E7%9C%9F%E7%9A%84%E4%BA%86%E8%A7%A3%E9%9B%86%E5%90%88%E5%AE%B9%E5%99%A8%E4%B9%88%EF%BC%9F-4867546.jpg" alt="" /></p>
</div>
</div>
<h2 id="å“ˆå¸Œè¡¨"><a class="header" href="#å“ˆå¸Œè¡¨">å“ˆå¸Œè¡¨</a></h2>
<h3 id="å“ˆå¸Œè¡¨è¿˜æ˜¯åˆ—è¡¨"><a class="header" href="#å“ˆå¸Œè¡¨è¿˜æ˜¯åˆ—è¡¨">å“ˆå¸Œè¡¨è¿˜æ˜¯åˆ—è¡¨</a></h3>
<details id="admonition-å“ˆå¸Œè¡¨å’Œåˆ—è¡¨çš„é€‰æ‹©" class="admonition info">
<summary class="admonition-title">
<p>å“ˆå¸Œè¡¨å’Œåˆ—è¡¨çš„é€‰æ‹©</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å“ˆå¸Œè¡¨å’Œåˆ—è¡¨çš„é€‰æ‹©"></a></p>
</summary>
<div>
<h2 id="æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨å’Œåˆ—è¡¨ç±»ä¼¼éƒ½ç”¨äºå¤„ç†éœ€è¦éšæœºè®¿é—®çš„æ•°æ®ç»“æ„å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”é‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨å¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”é‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨"><a class="header" href="#æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨å’Œåˆ—è¡¨ç±»ä¼¼éƒ½ç”¨äºå¤„ç†éœ€è¦éšæœºè®¿é—®çš„æ•°æ®ç»“æ„å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”é‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨å¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”é‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨">æˆ‘ä»¬çŸ¥é“ï¼Œå“ˆå¸Œè¡¨å’Œåˆ—è¡¨ç±»ä¼¼ï¼Œéƒ½ç”¨äºå¤„ç†éœ€è¦éšæœºè®¿é—®çš„æ•°æ®ç»“æ„ã€‚å¦‚æœæ•°æ®ç»“æ„çš„è¾“å…¥å’Œè¾“å‡ºèƒ½ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨åˆ—è¡¨ï¼Œå¦‚æœæ— æ³•ä¸€ä¸€å¯¹åº”ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨å“ˆå¸Œè¡¨ã€‚</a></h2>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882989.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></p>
</div>
</details>
<h3 id="rust-çš„å“ˆå¸Œè¡¨"><a class="header" href="#rust-çš„å“ˆå¸Œè¡¨">Rust çš„å“ˆå¸Œè¡¨</a></h3>
<details id="admonition-å“ˆå¸Œè¡¨çš„æ ¸å¿ƒç‰¹ç‚¹ä¸è§£å†³" class="admonition info">
<summary class="admonition-title">
<p>å“ˆå¸Œè¡¨çš„æ ¸å¿ƒç‰¹ç‚¹ä¸è§£å†³</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å“ˆå¸Œè¡¨çš„æ ¸å¿ƒç‰¹ç‚¹ä¸è§£å†³"></a></p>
</summary>
<div>
<p>å“ˆå¸Œè¡¨æœ€æ ¸å¿ƒçš„ç‰¹ç‚¹å°±æ˜¯ï¼šå·¨é‡çš„å¯èƒ½è¾“å…¥å’Œæœ‰é™çš„å“ˆå¸Œè¡¨å®¹é‡ã€‚è¿™å°±ä¼šå¼•å‘å“ˆå¸Œå†²çªï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªæˆ–è€…å¤šä¸ªè¾“å…¥çš„å“ˆå¸Œè¢«æ˜ å°„åˆ°äº†åŒä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦èƒ½å¤Ÿå¤„ç†å“ˆå¸Œå†²çªã€‚</p>
<p>è¦è§£å†³å†²çªï¼Œé¦–å…ˆå¯ä»¥é€šè¿‡æ›´å¥½çš„ã€åˆ†å¸ƒæ›´å‡åŒ€çš„å“ˆå¸Œå‡½æ•°ï¼Œä»¥åŠä½¿ç”¨æ›´å¤§çš„å“ˆå¸Œè¡¨æ¥ç¼“è§£å†²çªï¼Œä½†æ— æ³•å®Œå…¨è§£å†³ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨å†²çªè§£å†³æœºåˆ¶ã€‚</p>
</div>
</details>
<p>å¦‚ä½•è§£å†³å†²çªï¼Ÿ</p>
<p>ç†è®ºä¸Šï¼Œä¸»è¦çš„å†²çªè§£å†³æœºåˆ¶æœ‰é“¾åœ°å€æ³•ï¼ˆchainingï¼‰å’Œå¼€æ”¾å¯»å€æ³•ï¼ˆopen addressingï¼‰ã€‚</p>
<ul>
<li>é“¾åœ°å€æ³•ï¼Œæˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå°±æ˜¯æŠŠè½åœ¨åŒä¸€ä¸ªå“ˆå¸Œä¸Šçš„æ•°æ®ç”¨å•é“¾è¡¨æˆ–è€…åŒé“¾è¡¨è¿æ¥èµ·æ¥ã€‚è¿™æ ·åœ¨æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå…ˆæ‰¾åˆ°å¯¹åº”çš„å“ˆå¸Œæ¡¶ï¼ˆhash bucketï¼‰ï¼Œç„¶åå†åœ¨å†²çªé“¾ä¸ŠæŒ¨ä¸ªæ¯”è¾ƒï¼Œç›´åˆ°æ‰¾åˆ°åŒ¹é…çš„é¡¹ã€‚</li>
</ul>
<blockquote>
<p>å†²çªé“¾å¤„ç†å“ˆå¸Œå†²çªéå¸¸ç›´è§‚ï¼Œå¾ˆå®¹æ˜“ç†è§£å’Œæ’°å†™ä»£ç ï¼Œä½†ç¼ºç‚¹æ˜¯å“ˆå¸Œè¡¨å’Œå†²çªé“¾ä½¿ç”¨äº†ä¸åŒçš„å†…å­˜ï¼Œå¯¹ç¼“å­˜ä¸å‹å¥½ã€‚</p>
</blockquote>
<hr />
<h2 id="-8"><a class="header" href="#-8"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882976.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></a></h2>
<ul>
<li>
<p>å¼€æ”¾å¯»å€æ³•æŠŠæ•´ä¸ªå“ˆå¸Œè¡¨çœ‹åšä¸€ä¸ªå¤§æ•°ç»„ï¼Œä¸å¼•å…¥é¢å¤–çš„å†…å­˜ï¼Œå½“å†²çªäº§ç”Ÿæ—¶ï¼ŒæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æŠŠæ•°æ®æ’å…¥åˆ°å…¶å®ƒç©ºé—²çš„ä½ç½®ã€‚æ¯”å¦‚çº¿æ€§æ¢å¯»ï¼ˆlinear probingï¼‰åœ¨å‡ºç°å“ˆå¸Œå†²çªæ—¶ï¼Œä¸æ–­å¾€åæ¢å¯»ï¼Œç›´åˆ°æ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ã€‚</p>
</li>
<li>
<p>è€ŒäºŒæ¬¡æ¢æŸ¥ï¼Œç†è®ºä¸Šæ˜¯åœ¨å†²çªå‘ç”Ÿæ—¶ï¼Œä¸æ–­æ¢å¯»å“ˆå¸Œä½ç½®åŠ å‡ n çš„äºŒæ¬¡æ–¹ï¼Œæ‰¾åˆ°ç©ºé—²çš„ä½ç½®æ’å…¥ï¼Œæˆ‘ä»¬çœ‹å›¾ï¼Œæ›´å®¹æ˜“ç†è§£ï¼š</p>
</li>
</ul>
<hr />
<h2 id="-9"><a class="header" href="#-9"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882967.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></a></h2>
<blockquote>
<p>å›¾ä¸­ç¤ºæ„æ˜¯ç†è®ºä¸Šçš„å¤„ç†æ–¹æ³•ï¼Œå®é™…ä¸ºäº†æ€§èƒ½ä¼šæœ‰å¾ˆå¤šä¸åŒçš„å¤„ç†ã€‚</p>
</blockquote>
<h3 id="hashmap-çš„æ•°æ®ç»“æ„"><a class="header" href="#hashmap-çš„æ•°æ®ç»“æ„">HashMap çš„æ•°æ®ç»“æ„</a></h3>
<details id="admonition-æ·±å…¥rustå“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„hashmap-hashbrown-rawtable" class="admonition info">
<summary class="admonition-title">
<p>æ·±å…¥Rustå“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ï¼šHashMap-&gt;hashbrown-&gt;RawTable</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ·±å…¥rustå“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„hashmap-hashbrown-rawtable"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ Rust å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œæ‰“å¼€æ ‡å‡†åº“çš„ <a href="https://doc.rust-lang.org/src/std/collections/hash/map.rs.html#206-208">æºä»£ç </a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use hashbrown::hash_map as base;

#[derive(Clone)]
pub struct RandomState {
    k0: u64,
    k1: u64,
}

pub struct HashMap&lt;K, V, S = RandomState&gt; {
    base: base::HashMap&lt;K, V, S&gt;,
}
</code></pre></pre>
<hr />
<p>å¯ä»¥çœ‹åˆ°ï¼ŒHashMap æœ‰ä¸‰ä¸ªæ³›å‹å‚æ•°:</p>
<ol>
<li>K å’Œ V ä»£è¡¨ key / value çš„ç±»å‹</li>
<li>S æ˜¯å“ˆå¸Œç®—æ³•çš„çŠ¶æ€ï¼Œå®ƒé»˜è®¤æ˜¯ RandomStateï¼Œå ä¸¤ä¸ª u64ã€‚</li>
</ol>
<blockquote>
<p>RandomState ä½¿ç”¨ SipHash ä½œä¸ºç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼ˆcryptographically secure hashingï¼‰ã€‚</p>
</blockquote>
<p>ä»å®šä¹‰ä¸­è¿˜èƒ½çœ‹åˆ°ï¼ŒRust çš„ HashMap å¤ç”¨äº† hashbrown çš„ HashMap: 
hashbrown æ˜¯ Rust ä¸‹å¯¹ <a href="https://abseil.io/blog/20180927-swisstables">Google Swiss Table</a> çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆå®ç°ï¼Œæˆ‘ä»¬<a href="https://docs.rs/hashbrown/0.11.2/src/hashbrown/map.rs.html#192-195">æ‰“å¼€ hashbrown çš„ä»£ç </a>ï¼Œçœ‹å®ƒçš„ç»“æ„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">pub struct HashMap&lt;K, V, S = DefaultHashBuilder, A: Allocator + Clone = Global&gt; {
    pub(crate) hash_builder: S,
    pub(crate) table: RawTable&lt;(K, V), A&gt;,
}
</code></pre></pre>
<hr />
<p>å¯ä»¥çœ‹åˆ°ï¼ŒHashMap é‡Œæœ‰ä¸¤ä¸ªåŸŸ:</p>
<ol>
<li>ä¸€ä¸ªæ˜¯ hash_builderï¼Œç±»å‹æ˜¯åˆšæ‰æˆ‘ä»¬æåˆ°çš„æ ‡å‡†åº“ä½¿ç”¨çš„ RandomState</li>
<li>è¿˜æœ‰ä¸€ä¸ªæ˜¯å…·ä½“çš„ RawTableï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct RawTable&lt;T, A: Allocator + Clone = Global&gt; {
    table: RawTableInner&lt;A&gt;,
    // Tell dropck that we own instances of T.
    marker: PhantomData&lt;T&gt;,
}

struct RawTableInner&lt;A&gt; {
    // Mask to get an index from a hash value. The value is one less than the
    // number of buckets in the table.
    bucket_mask: usize,

    // [Padding], T1, T2, ..., Tlast, C1, C2, ...
    //                                ^ points here
    ctrl: NonNull&lt;u8&gt;,

    // Number of elements that can be inserted before we need to grow the table
    growth_left: usize,

    // Number of elements in the table, only really used by len()
    items: usize,

    alloc: A,
}
</code></pre></pre>
<p>RawTable ä¸­ï¼Œå®é™…ä¸Šæœ‰æ„ä¹‰çš„æ•°æ®ç»“æ„æ˜¯ RawTableInner:</p>
<blockquote>
<p>å‰å››ä¸ªå­—æ®µå¾ˆé‡è¦ï¼š</p>
</blockquote>
<ol>
<li>usize çš„ bucket_maskï¼Œæ˜¯å“ˆå¸Œè¡¨ä¸­å“ˆå¸Œæ¡¶çš„æ•°é‡å‡ä¸€ï¼›</li>
<li>åå­—å« ctrl çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘å“ˆå¸Œè¡¨å †å†…å­˜æœ«ç«¯çš„ ctrl åŒºï¼›</li>
<li>usize çš„å­—æ®µ growth_leftï¼ŒæŒ‡å“ˆå¸Œè¡¨åœ¨ä¸‹æ¬¡è‡ªåŠ¨å¢é•¿å‰è¿˜èƒ½å­˜å‚¨å¤šå°‘æ•°æ®ï¼›</li>
<li>Usize çš„ itemsï¼Œè¡¨æ˜å“ˆå¸Œè¡¨ç°åœ¨æœ‰å¤šå°‘æ•°æ®ã€‚</li>
</ol>
<blockquote>
<p>è¿™é‡Œæœ€åçš„ alloc å­—æ®µï¼Œå’Œ RawTable çš„ marker ä¸€æ ·ï¼Œåªæ˜¯ä¸€ä¸ªç”¨æ¥å ä½çš„ç±»å‹ï¼Œå®ƒç”¨æ¥åˆ†é…åœ¨å †ä¸Šçš„å†…å­˜ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="hashmap-çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•"><a class="header" href="#hashmap-çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•">HashMap çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</a></h3>
<details id="admonition-hashmapåŸºæœ¬ä½¿ç”¨æ–¹æ³•" class="admonition info">
<summary class="admonition-title">
<p>HashMapåŸºæœ¬ä½¿ç”¨æ–¹æ³•</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-hashmapåŸºæœ¬ä½¿ç”¨æ–¹æ³•"></a></p>
</summary>
<div>
<p>æ•°æ®ç»“æ„ææ¸…æ¥šï¼Œæˆ‘ä»¬å†çœ‹å…·ä½“ä½¿ç”¨æ–¹æ³•ã€‚Rust å“ˆå¸Œè¡¨çš„ä½¿ç”¨å¾ˆç®€å•ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—å¾ˆæ–¹ä¾¿çš„æ–¹æ³•ï¼Œä½¿ç”¨èµ·æ¥å’Œå…¶å®ƒè¯­è¨€éå¸¸ç±»ä¼¼ï¼Œä½ åªè¦çœ‹çœ‹æ–‡æ¡£ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬æ¥å†™æ®µä»£ç ï¼Œå°è¯•ä¸€ä¸‹ï¼ˆä»£ç ï¼‰ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::collections::HashMap;

fn main() {
    let mut map = HashMap::new();
    explain(&quot;empty&quot;, &amp;map);

    map.insert('a', 1);
    explain(&quot;added 1&quot;, &amp;map);

    map.insert('b', 2);
    map.insert('c', 3);
    explain(&quot;added 3&quot;, &amp;map);

    map.insert('d', 4);
    explain(&quot;added 4&quot;, &amp;map);

    // get æ—¶éœ€è¦ä½¿ç”¨å¼•ç”¨ï¼Œå¹¶ä¸”ä¹Ÿè¿”å›å¼•ç”¨
    assert_eq!(map.get(&amp;'a'), Some(&amp;1));
    assert_eq!(map.get_key_value(&amp;'b'), Some((&amp;'b', &amp;2)));

    map.remove(&amp;'a');
    // åˆ é™¤åå°±æ‰¾ä¸åˆ°äº†
    assert_eq!(map.contains_key(&amp;'a'), false);
    assert_eq!(map.get(&amp;'a'), None);
    explain(&quot;removed&quot;, &amp;map);
    // shrink åå“ˆå¸Œè¡¨å˜å°
    map.shrink_to_fit();
    explain(&quot;shrinked&quot;, &amp;map);
}

fn explain&lt;K, V&gt;(name: &amp;str, map: &amp;HashMap&lt;K, V&gt;) {
    println!(&quot;{}: len: {}, cap: {}&quot;, name, map.len(), map.capacity());
}
</code></pre></pre>
<hr />
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå½“ HashMap::new() æ—¶ï¼Œå®ƒå¹¶æ²¡æœ‰åˆ†é…ç©ºé—´ï¼Œå®¹é‡ä¸ºé›¶</li>
<li>éšç€å“ˆå¸Œè¡¨ä¸æ–­æ’å…¥æ•°æ®ï¼Œå®ƒä¼šä»¥ 2 çš„å¹‚å‡ä¸€çš„æ–¹å¼å¢é•¿ï¼Œæœ€å°æ˜¯ 3ã€‚</li>
<li>å½“åˆ é™¤è¡¨ä¸­çš„æ•°æ®æ—¶ï¼ŒåŸæœ‰çš„è¡¨å¤§å°ä¸å˜ï¼Œåªæœ‰æ˜¾å¼åœ°è°ƒç”¨ shrink_to_fitï¼Œæ‰ä¼šè®©å“ˆå¸Œè¡¨å˜å°ã€‚</li>
</ol>
</div>
</details>
<h3 id="hashmap-çš„å†…å­˜å¸ƒå±€"><a class="header" href="#hashmap-çš„å†…å­˜å¸ƒå±€">HashMap çš„å†…å­˜å¸ƒå±€</a></h3>
<details id="admonition-ctrlè¡¨çš„å˜åŒ–å€ŸåŠ©stdmemtransmuteæŸ¥çœ‹å†…å­˜å¸ƒå±€" class="admonition info">
<summary class="admonition-title">
<p>ctrlè¡¨çš„å˜åŒ–ï¼šå€ŸåŠ©std::mem::transmuteæŸ¥çœ‹å†…å­˜å¸ƒå±€</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ctrlè¡¨çš„å˜åŒ–å€ŸåŠ©stdmemtransmuteæŸ¥çœ‹å†…å­˜å¸ƒå±€"></a></p>
</summary>
<div>
<p>é€šè¿‡ HashMap çš„å…¬å¼€æ¥å£æ— æ³•çœ‹åˆ° HashMap åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•å¸ƒå±€ï¼Œè¿˜æ˜¯éœ€è¦å€ŸåŠ© std::mem::transmute æ–¹æ³•ï¼Œæ¥æŠŠæ•°æ®ç»“æ„æ‰“å‡ºæ¥ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬æŠŠåˆšæ‰çš„ä»£ç æ”¹ä¸€æ”¹ï¼ˆä»£ç ï¼‰ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::collections::HashMap;

fn main() {
    let map = HashMap::new();
    let mut map = explain(&quot;empty&quot;, map);

    map.insert('a', 1);
    let mut map = explain(&quot;added 1&quot;, map);
    map.insert('b', 2);
    map.insert('c', 3);

    let mut map = explain(&quot;added 3&quot;, map);

    map.insert('d', 4);

    let mut map = explain(&quot;added 4&quot;, map);

    map.remove(&amp;'a');

    explain(&quot;final&quot;, map);
}

// HashMap ç»“æ„æœ‰ä¸¤ä¸ª u64 çš„ RandomStateï¼Œç„¶åæ˜¯å››ä¸ª usizeï¼Œ
// åˆ†åˆ«æ˜¯ bucket_mask, ctrl, growth_left å’Œ items
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain&lt;K, V&gt;(name: &amp;str, map: HashMap&lt;K, V&gt;) -&gt; HashMap&lt;K, V&gt; {
    let arr: [usize; 6] = unsafe { std::mem::transmute(map) };
    println!(
        &quot;{}: bucket_mask 0x{:x}, ctrl 0x{:x}, growth_left: {}, items: {}&quot;,
        name, arr[2], arr[3], arr[4], arr[5]
    );
    unsafe { std::mem::transmute(arr) }
}
</code></pre></pre>
<hr />
<p>è¿è¡Œä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<pre><code class="language-shell">empty: bucket_mask 0x0, ctrl 0x1056df820, growth_left: 0, items: 0

added 1: bucket_mask 0x3, ctrl 0x7fa0d1405e30, growth_left: 2, items: 1

added 3: bucket_mask 0x3, ctrl 0x7fa0d1405e30, growth_left: 0, items: 3

added 4: bucket_mask 0x7, ctrl 0x7fa0d1405e90, growth_left: 3, items: 4

final: bucket_mask 0x7, ctrl 0x7fa0d1405e90, growth_left: 4, items: 3
</code></pre>
<blockquote>
<p>å‘ç°åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œctrl å¯¹åº”çš„å †åœ°å€å‘ç”Ÿäº†æ”¹å˜ã€‚</p>
</blockquote>
<ul>
<li>åœ¨æˆ‘çš„ OS X ä¸‹ï¼Œä¸€å¼€å§‹å“ˆå¸Œè¡¨ä¸ºç©ºï¼Œctrl åœ°å€çœ‹ä¸Šå»æ˜¯ä¸€ä¸ª TEXT/RODATA æ®µçš„åœ°å€ï¼Œåº”è¯¥æ˜¯æŒ‡å‘äº†ä¸€ä¸ªé»˜è®¤çš„ç©ºè¡¨åœ°å€ï¼›</li>
<li>æ’å…¥ç¬¬ä¸€ä¸ªæ•°æ®åï¼Œå“ˆå¸Œè¡¨åˆ†é…äº† 4 ä¸ª bucketï¼Œctrl åœ°å€å‘ç”Ÿæ”¹å˜ï¼›</li>
<li>åœ¨æ’å…¥ä¸‰ä¸ªæ•°æ®åï¼Œgrowth_left ä¸ºé›¶</li>
<li>å†æ’å…¥æ—¶ï¼Œå“ˆå¸Œè¡¨é‡æ–°åˆ†é…ï¼Œctrl åœ°å€ç»§ç»­æ”¹å˜ã€‚</li>
</ul>
<blockquote>
<p>åœ¨æ¢ç´¢ HashMap æ•°æ®ç»“æ„æ—¶ï¼Œè¯´è¿‡ ctrl æ˜¯ä¸€ä¸ªæŒ‡å‘å“ˆå¸Œè¡¨å †åœ°å€æœ«ç«¯ ctrl åŒºçš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªåœ°å€ï¼Œè®¡ç®—å‡ºå“ˆå¸Œè¡¨å †åœ°å€çš„èµ·å§‹åœ°å€ã€‚</p>
</blockquote>
<p>å› ä¸ºå“ˆå¸Œè¡¨æœ‰ 8 ä¸ª bucketï¼ˆ0x7 + 1ï¼‰ï¼Œæ¯ä¸ª bucket å¤§å°æ˜¯ keyï¼ˆcharï¼‰ + valueï¼ˆi32ï¼‰ çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä¸€å…±æ˜¯ 64 ä¸ªå­—èŠ‚ã€‚
å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œé€šè¿‡ ctrl åœ°å€å‡å» 64ï¼Œå°±å¯ä»¥å¾—åˆ°å“ˆå¸Œè¡¨çš„å †å†…å­˜èµ·å§‹åœ°å€ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ rust-gdb / rust-lldb æ¥æ‰“å°è¿™ä¸ªå†…å­˜ã€‚</p>
<blockquote>
<p>å¯ä»¥ç”¨ Linux ä¸‹çš„ rust-gdb è®¾ç½®æ–­ç‚¹ï¼Œä¾æ¬¡æŸ¥çœ‹å“ˆå¸Œè¡¨æœ‰ä¸€ä¸ªã€ä¸‰ä¸ªã€å››ä¸ªå€¼ï¼Œä»¥åŠåˆ é™¤ä¸€ä¸ªå€¼çš„çŠ¶æ€ï¼š</p>
</blockquote>
<pre><code class="language-shell">
â¯ rust-gdb ~/.target/debug/hashmap2
GNU gdb (Ubuntu 9.2-0ubuntu2) 9.2
...
(gdb) b hashmap2.rs:32
Breakpoint 1 at 0xa43e: file src/hashmap2.rs, line 32.
(gdb) r
Starting program: /home/tchen/.target/debug/hashmap2
...
# æœ€åˆçš„çŠ¶æ€ï¼Œå“ˆå¸Œè¡¨ä¸ºç©º
empty: bucket_mask 0x0, ctrl 0x555555597be0, growth_left: 0, items: 0

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) c
Continuing.
# æ’å…¥äº†ä¸€ä¸ªå…ƒç´ åï¼Œbucket æœ‰ 4 ä¸ªï¼ˆ0x3+1ï¼‰ï¼Œå †åœ°å€èµ·å§‹ä½ç½® 0x5555555a7af0 - 4*8(0x20)
added 1: bucket_mask 0x3, ctrl 0x5555555a7af0, growth_left: 2, items: 1

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x /12x 0x5555555a7ad0
0x5555555a7ad0:  0x00000061  0x00000001  0x00000000  0x00000000
0x5555555a7ae0:  0x00000000  0x00000000  0x00000000  0x00000000
0x5555555a7af0:  0x0affffff  0xffffffff  0xffffffff  0xffffffff
(gdb) c
Continuing.
# æ’å…¥äº†ä¸‰ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ²¡æœ‰å‰©ä½™ç©ºé—´ï¼Œå †åœ°å€èµ·å§‹ä½ç½®ä¸å˜ 0x5555555a7af0 - 4*8(0x20)
added 3: bucket_mask 0x3, ctrl 0x5555555a7af0, growth_left: 0, items: 3

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x /12x 0x5555555a7ad0
0x5555555a7ad0:  0x00000061  0x00000001  0x00000062  0x00000002
0x5555555a7ae0:  0x00000000  0x00000000  0x00000063  0x00000003
0x5555555a7af0:  0x0a72ff02  0xffffffff  0xffffffff  0xffffffff
(gdb) c
Continuing.
# æ’å…¥ç¬¬å››ä¸ªå…ƒç´ åï¼Œå“ˆå¸Œè¡¨æ‰©å®¹ï¼Œå †åœ°å€èµ·å§‹ä½ç½®å˜ä¸º 0x5555555a7b50 - 8*8(0x40)
added 4: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 3, items: 4

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x /20x 0x5555555a7b10
0x5555555a7b10:  0x00000061  0x00000001  0x00000000  0x00000000
0x5555555a7b20:  0x00000064  0x00000004  0x00000063  0x00000003
0x5555555a7b30:  0x00000000  0x00000000  0x00000062  0x00000002
0x5555555a7b40:  0x00000000  0x00000000  0x00000000  0x00000000
0x5555555a7b50:  0xff72ffff  0x0aff6502  0xffffffff  0xffffffff
(gdb) c
Continuing.
# åˆ é™¤ a åï¼Œå‰©ä½™ 4 ä¸ªä½ç½®ã€‚æ³¨æ„ ctrl bit çš„å˜åŒ–ï¼Œä»¥åŠ 0x61 0x1 å¹¶æ²¡æœ‰è¢«æ¸…é™¤
final: bucket_mask 0x7, ctrl 0x5555555a7b50, growth_left: 4, items: 3

Breakpoint 1, hashmap2::explain (name=..., map=...) at src/hashmap2.rs:32
32      unsafe { std::mem::transmute(arr) }
(gdb) x /20x 0x5555555a7b10
0x5555555a7b10:  0x00000061  0x00000001  0x00000000  0x00000000
0x5555555a7b20:  0x00000064  0x00000004  0x00000063  0x00000003
0x5555555a7b30:  0x00000000  0x00000000  0x00000062  0x00000002
0x5555555a7b40:  0x00000000  0x00000000  0x00000000  0x00000000
0x5555555a7b50:  0xff72ffff  0xffff6502  0xffffffff  0xffffffff
</code></pre>
<hr />
<p>è¿™æ®µè¾“å‡ºè•´è—äº†å¾ˆå¤šä¿¡æ¯ï¼Œç»“åˆç¤ºæ„å›¾æ¥ä»”ç»†æ¢³ç†ã€‚</p>
<ol>
<li>é¦–å…ˆï¼Œæ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´  â€˜aâ€™: 1 åï¼Œå“ˆå¸Œè¡¨çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882958.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></p>
<ul>
<li>key â€˜aâ€™ çš„ hash å’Œ bucket_mask 0x3 è¿ç®—åå¾—åˆ°ç¬¬ 0 ä¸ªä½ç½®æ’å…¥ã€‚</li>
<li>åŒæ—¶ï¼Œè¿™ä¸ª hash çš„å¤´ 7 ä½å–å‡ºæ¥ï¼Œåœ¨ ctrl è¡¨ä¸­å¯¹åº”çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 0 ä¸ªå­—èŠ‚ï¼ŒæŠŠè¿™ä¸ªå€¼å†™å…¥ã€‚</li>
</ul>
<p>è¦ç†è§£è¿™ä¸ªæ­¥éª¤ï¼Œå…³é”®å°±æ˜¯è¦ææ¸…æ¥šè¿™ä¸ª ctrl è¡¨æ˜¯ä»€ä¹ˆã€‚</p>
</div>
</details>
<h3 id="ctrl-è¡¨"><a class="header" href="#ctrl-è¡¨">ctrl è¡¨</a></h3>
<details id="admonition-ctrl-è¡¨çš„ä¸»è¦ç›®çš„ä¸è®¾è®¡" class="admonition info">
<summary class="admonition-title">
<p>ctrl è¡¨çš„ä¸»è¦ç›®çš„ä¸è®¾è®¡</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ctrl-è¡¨çš„ä¸»è¦ç›®çš„ä¸è®¾è®¡"></a></p>
</summary>
<div>
<p>ctrl è¡¨çš„ä¸»è¦ç›®çš„æ˜¯å¿«é€ŸæŸ¥æ‰¾ã€‚å®ƒçš„è®¾è®¡éå¸¸ä¼˜é›…ï¼Œå€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
<p>ä¸€å¼  ctrl è¡¨é‡Œ:</p>
<ul>
<li>æœ‰è‹¥å¹²ä¸ª 128bit æˆ–è€…è¯´ 16 ä¸ªå­—èŠ‚çš„åˆ†ç»„ï¼ˆgroupï¼‰</li>
<li>group é‡Œçš„æ¯ä¸ªå­—èŠ‚å« ctrl byteï¼Œå¯¹åº”ä¸€ä¸ª bucketï¼Œé‚£ä¹ˆä¸€ä¸ª group å¯¹åº” 16 ä¸ª bucketã€‚</li>
<li>å¦‚æœä¸€ä¸ª bucket å¯¹åº”çš„ ctrl byte é¦–ä½ä¸ä¸º 1ï¼Œå°±è¡¨ç¤ºè¿™ä¸ª ctrl byte è¢«ä½¿ç”¨ï¼›</li>
<li>å¦‚æœæ‰€æœ‰ä½éƒ½æ˜¯ 1ï¼Œæˆ–è€…è¯´è¿™ä¸ªå­—èŠ‚æ˜¯ 0xffï¼Œé‚£ä¹ˆå®ƒæ˜¯ç©ºé—²çš„ã€‚</li>
</ul>
<blockquote>
<p>ä¸€ç»„ control byte çš„æ•´ä¸ª 128 bit çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤è¢«åŠ è½½è¿›æ¥ï¼Œç„¶åå’ŒæŸä¸ªå€¼è¿›è¡Œ maskï¼Œæ‰¾åˆ°å®ƒæ‰€åœ¨çš„ä½ç½®ã€‚è¿™å°±æ˜¯HashMapçš„ SIMD æŸ¥è¡¨ã€‚</p>
</blockquote>
<blockquote>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œç°ä»£ CPU éƒ½æ”¯æŒå•æŒ‡ä»¤å¤šæ•°æ®é›†çš„æ“ä½œï¼Œè€Œ Rust å……åˆ†åˆ©ç”¨äº† CPU è¿™ç§èƒ½åŠ›ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥è®©å¤šä¸ªç›¸å…³çš„æ•°æ®è½½å…¥åˆ°ç¼“å­˜ä¸­å¤„ç†ï¼Œå¤§å¤§åŠ å¿«æŸ¥è¡¨çš„é€Ÿåº¦ã€‚æ‰€ä»¥ï¼ŒRust çš„å“ˆå¸Œè¡¨æŸ¥è¯¢çš„æ•ˆç‡éå¸¸é«˜ã€‚</p>
</blockquote>
<p>å…·ä½“æ€ä¹ˆæ“ä½œï¼Œæˆ‘ä»¬æ¥çœ‹ HashMap æ˜¯å¦‚ä½•é€šè¿‡ ctrl è¡¨æ¥è¿›è¡Œæ•°æ®æŸ¥è¯¢çš„ã€‚</p>
<blockquote>
<p>å‡è®¾è¿™å¼ è¡¨é‡Œå·²ç»æ·»åŠ äº†ä¸€äº›æ•°æ®ï¼Œæˆ‘ä»¬ç°åœ¨è¦æŸ¥æ‰¾ key ä¸º â€˜câ€™ çš„æ•°æ®ï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882948.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></p>
<ol>
<li>æŠŠ h è·Ÿ bucket_mask åšä¸ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ï¼Œå›¾ä¸­æ˜¯ 139ï¼›</li>
<li>æ‹¿ç€è¿™ä¸ª 139ï¼Œæ‰¾åˆ°å¯¹åº”çš„ ctrl group çš„èµ·å§‹ä½ç½®ï¼Œå› ä¸º ctrl group ä»¥ 16 ä¸ºä¸€ç»„ï¼Œæ‰€ä»¥è¿™é‡Œæ‰¾åˆ° 128ï¼›</li>
<li>ç”¨ SIMD æŒ‡ä»¤åŠ è½½ä» 128 å¯¹åº”åœ°å€å¼€å§‹çš„ 16 ä¸ªå­—èŠ‚ï¼›</li>
<li>å¯¹ hash å–å¤´ 7 ä¸ª bitï¼Œç„¶åå’Œåˆšåˆšå–å‡ºçš„ 16 ä¸ªå­—èŠ‚ä¸€èµ·åšä¸ï¼Œæ‰¾åˆ°å¯¹åº”çš„åŒ¹é…ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå®ƒï¼ˆä»¬ï¼‰å¾ˆå¤§æ¦‚ç‡æ˜¯è¦æ‰¾çš„å€¼ï¼›</li>
<li>å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆä»¥äºŒæ¬¡æ¢æŸ¥ï¼ˆä»¥ 16 çš„å€æ•°ä¸æ–­ç´¯ç§¯ï¼‰çš„æ–¹å¼å¾€åæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚</li>
</ol>
<blockquote>
<p>æ‰€ä»¥ï¼Œå½“ HashMap æ’å…¥å’Œåˆ é™¤æ•°æ®ï¼Œä»¥åŠå› æ­¤å¯¼è‡´é‡æ–°åˆ†é…çš„æ—¶å€™ï¼Œä¸»è¦å·¥ä½œå°±æ˜¯åœ¨ç»´æŠ¤è¿™å¼  ctrl è¡¨å’Œæ•°æ®çš„å¯¹åº”ã€‚</p>
</blockquote>
<blockquote>
<p>å› ä¸º ctrl è¡¨æ˜¯æ‰€æœ‰æ“ä½œæœ€å…ˆè§¦åŠçš„å†…å­˜ï¼Œæ‰€ä»¥ï¼Œåœ¨ HashMap çš„ç»“æ„ä¸­ï¼Œå †å†…å­˜çš„æŒ‡é’ˆç›´æ¥æŒ‡å‘ ctrl è¡¨ï¼Œè€Œä¸æ˜¯æŒ‡å‘å †å†…å­˜çš„èµ·å§‹ä½ç½®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å†…å­˜çš„è®¿é—®ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿"><a class="header" href="#å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿">å“ˆå¸Œè¡¨é‡æ–°åˆ†é…ä¸å¢é•¿</a></h3>
<details id="admonition-æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨åœ¨åŠ å…¥-d-4-æ—¶hash-mapæ˜¯å¦‚ä½•å¢é•¿çš„" class="admonition info">
<summary class="admonition-title">
<p>æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨ï¼Œåœ¨åŠ å…¥ â€˜dâ€™: 4 æ—¶ï¼Œhash mapæ˜¯å¦‚ä½•å¢é•¿çš„</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨åœ¨åŠ å…¥-d-4-æ—¶hash-mapæ˜¯å¦‚ä½•å¢é•¿çš„"></a></p>
</summary>
<div>
<p>åœ¨æ’å…¥ç¬¬ä¸€æ¡æ•°æ®åï¼Œå“ˆå¸Œè¡¨åªæœ‰ 4 ä¸ª bucketï¼Œæ‰€ä»¥åªæœ‰å¤´ 4 ä¸ªå­—èŠ‚çš„ ctrl è¡¨æœ‰ç”¨ã€‚éšç€å“ˆå¸Œè¡¨çš„å¢é•¿ï¼Œbucket ä¸å¤Ÿï¼Œå°±ä¼šå¯¼è‡´é‡æ–°åˆ†é…ã€‚ç”±äº bucket_mask æ°¸è¿œæ¯” bucket æ•°é‡å°‘ 1ï¼Œæ‰€ä»¥æ’å…¥ä¸‰ä¸ªå…ƒç´ åå°±ä¼šé‡æ–°åˆ†é…ã€‚</p>
<p>æ ¹æ® rust-gdb ä¸­å¾—åˆ°çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬çœ‹æ’å…¥ä¸‰ä¸ªå…ƒç´ åæ²¡æœ‰å‰©ä½™ç©ºé—´çš„å“ˆå¸Œè¡¨ï¼Œåœ¨åŠ å…¥ â€˜dâ€™: 4 æ—¶ï¼Œæ˜¯å¦‚ä½•å¢é•¿çš„: </p>
<ol>
<li>é¦–å…ˆï¼Œå“ˆå¸Œè¡¨ä¼šæŒ‰å¹‚æ‰©å®¹ï¼Œä» 4 ä¸ª bucket æ‰©å±•åˆ° 8 ä¸ª bucketã€‚</li>
</ol>
<p>è¿™ä¼šå¯¼è‡´åˆ†é…æ–°çš„å †å†…å­˜ï¼Œç„¶ååŸæ¥çš„ ctrl table å’Œå¯¹åº”çš„ kv æ•°æ®ä¼šè¢«ç§»åŠ¨åˆ°æ–°çš„å†…å­˜ä¸­ã€‚</p>
<ul>
<li>è¿™ä¸ªä¾‹å­é‡Œå› ä¸º char å’Œ i32 å®ç°äº† Copy traitï¼Œæ‰€ä»¥æ˜¯æ‹·è´ï¼›</li>
<li>å¦‚æœ key çš„ç±»å‹æ˜¯ Stringï¼Œé‚£ä¹ˆåªæœ‰ String çš„ 24 ä¸ªå­—èŠ‚ (ptr|cap|len) çš„ç»“æ„è¢«ç§»åŠ¨ï¼ŒString çš„å®é™…å†…å­˜ä¸éœ€è¦å˜åŠ¨ã€‚</li>
<li>åœ¨ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠå“ˆå¸Œçš„é‡åˆ†é…ã€‚</li>
<li>ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œâ€˜aâ€™ / â€˜câ€™ çš„ç›¸å¯¹ä½ç½®å’Œå®ƒä»¬çš„ ctrl byte æ²¡æœ‰å˜åŒ–ï¼Œä½†é‡æ–°åš hash åï¼Œâ€˜bâ€™ çš„ ctrl byte å’Œä½ç½®éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼š</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882903-4882936.jpg" alt="" /></p>
</div>
</details>
<h3 id="åˆ é™¤ä¸€ä¸ªå€¼"><a class="header" href="#åˆ é™¤ä¸€ä¸ªå€¼">åˆ é™¤ä¸€ä¸ªå€¼</a></h3>
<details id="admonition-å“ˆå¸Œè¡¨åˆ é™¤æ—¶å†…å­˜å¦‚ä½•é‡Šæ”¾" class="admonition info">
<summary class="admonition-title">
<p>å“ˆå¸Œè¡¨åˆ é™¤æ—¶å†…å­˜å¦‚ä½•é‡Šæ”¾ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å“ˆå¸Œè¡¨åˆ é™¤æ—¶å†…å­˜å¦‚ä½•é‡Šæ”¾"></a></p>
</summary>
<div>
<p>æ˜ç™½äº†å“ˆå¸Œè¡¨æ˜¯å¦‚ä½•å¢é•¿çš„ï¼Œæˆ‘ä»¬å†æ¥çœ‹åˆ é™¤çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<p>å½“è¦åœ¨å“ˆå¸Œè¡¨ä¸­åˆ é™¤ä¸€ä¸ªå€¼æ—¶ï¼Œæ•´ä¸ªè¿‡ç¨‹å’ŒæŸ¥æ‰¾ç±»ä¼¼:</p>
<ol>
<li>å…ˆè¦æ‰¾åˆ°è¦è¢«åˆ é™¤çš„ key æ‰€åœ¨çš„ä½ç½®ã€‚</li>
<li>åœ¨æ‰¾åˆ°å…·ä½“ä½ç½®åï¼Œå¹¶ä¸éœ€è¦å®é™…æ¸…é™¤å†…å­˜ï¼Œåªéœ€è¦å°†å®ƒçš„ ctrl byte è®¾å› 0xffï¼ˆæˆ–è€…æ ‡è®°æˆåˆ é™¤çŠ¶æ€ï¼‰ã€‚è¿™æ ·ï¼Œè¿™ä¸ª bucket å°±å¯ä»¥è¢«å†æ¬¡ä½¿ç”¨äº†</li>
</ol>
<blockquote>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå½“ key/value æœ‰é¢å¤–çš„å†…å­˜æ—¶ï¼Œæ¯”å¦‚ Stringï¼Œå®ƒçš„å†…å­˜ä¸ä¼šç«‹å³å›æ”¶ï¼Œåªæœ‰åœ¨ä¸‹ä¸€æ¬¡å¯¹åº”çš„ bucket è¢«ä½¿ç”¨æ—¶ï¼Œè®© HashMap ä¸å†æ‹¥æœ‰è¿™ä¸ª String çš„æ‰€æœ‰æƒä¹‹åï¼Œè¿™ä¸ª String çš„å†…å­˜æ‰è¢«å›æ”¶ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢çš„ç¤ºæ„å›¾ï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/17%EF%BD%9C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%9A%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A0%B8%E5%BF%83%E9%83%A8%E4%BB%B6%E5%93%88%E5%B8%8C%E8%A1%A8%EF%BC%8C%E5%86%85%E5%AD%98%E5%A6%82%E4%BD%95%E5%B8%83%E5%B1%80%EF%BC%9F-4882903.jpg" alt="17ï½œæ•°æ®ç»“æ„ï¼šè½¯ä»¶ç³»ç»Ÿæ ¸å¿ƒéƒ¨ä»¶å“ˆå¸Œè¡¨ï¼Œå†…å­˜å¦‚ä½•å¸ƒå±€ï¼Ÿ" /></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿™å¹¶ä¸ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜ï¼Œé¡¶å¤šæ˜¯å†…å­˜å ç”¨ç‡ç¨é«˜ä¸€äº›ã€‚ä½†æŸäº›æç«¯æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åœ¨å“ˆå¸Œè¡¨ä¸­æ·»åŠ å¤§é‡å†…å®¹ï¼Œåˆåˆ é™¤å¤§é‡å†…å®¹åè¿è¡Œï¼Œè¿™æ—¶ä½ å¯ä»¥é€šè¿‡ shrink_to_fit / shrink_to é‡Šæ”¾æ‰ä¸éœ€è¦çš„å†…å­˜ã€‚</p>
</div>
</details>
<h3 id="è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš-hash-key"><a class="header" href="#è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš-hash-key">è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„åš Hash key</a></h3>
<details id="admonition-è‡ªå®šä¹‰æ•°æ®ç»“æ„éœ€è¦å®ç°hashpartialeqeqè¿™ä¸‰ä¸ªtrait" class="admonition info">
<summary class="admonition-title">
<p>è‡ªå®šä¹‰æ•°æ®ç»“æ„éœ€è¦å®ç°Hashã€PartialEqã€Eqè¿™ä¸‰ä¸ªtrait</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-è‡ªå®šä¹‰æ•°æ®ç»“æ„éœ€è¦å®ç°hashpartialeqeqè¿™ä¸‰ä¸ªtrait"></a></p>
</summary>
<div>
<p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„æˆä¸º HashMap çš„ keyã€‚æ­¤æ—¶ï¼Œè¦ä½¿ç”¨åˆ°ä¸‰ä¸ª traitï¼š<a href="https://doc.rust-lang.org/std/hash/trait.Hash.html">Hash</a>ã€<a href="https://doc.rust-lang.org/std/cmp/trait.PartialEq.html">PartialEq</a>ã€<a href="https://doc.rust-lang.org/std/cmp/trait.Eq.html">Eq</a>ï¼Œä¸è¿‡è¿™ä¸‰ä¸ª trait éƒ½å¯ä»¥é€šè¿‡æ´¾ç”Ÿå®è‡ªåŠ¨ç”Ÿæˆã€‚å…¶ä¸­ï¼š</p>
<ol>
<li>å®ç°äº† Hash ï¼Œå¯ä»¥è®©æ•°æ®ç»“æ„è®¡ç®—å“ˆå¸Œï¼›</li>
<li>å®ç°äº† PartialEq/Eqï¼Œå¯ä»¥è®©æ•°æ®ç»“æ„è¿›è¡Œç›¸ç­‰å’Œä¸ç›¸ç­‰çš„æ¯”è¾ƒã€‚</li>
<li>Eq å®ç°äº†æ¯”è¾ƒçš„è‡ªåæ€§ï¼ˆa == aï¼‰ã€å¯¹ç§°æ€§ï¼ˆa == b åˆ™ b == aï¼‰ä»¥åŠä¼ é€’æ€§ï¼ˆa == bï¼Œb == cï¼Œåˆ™ a == cï¼‰</li>
<li>PartialEq æ²¡æœ‰å®ç°è‡ªåæ€§ã€‚</li>
</ol>
<p>æˆ‘ä»¬å¯ä»¥å†™ä¸ªä¾‹å­ï¼Œçœ‹çœ‹è‡ªå®šä¹‰æ•°æ®ç»“æ„å¦‚ä½•æ”¯æŒ HashMapï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{
    collections::{hash_map::DefaultHasher, HashMap},
    hash::{Hash, Hasher},
};

// å¦‚æœè¦æ”¯æŒ Hashï¼Œå¯ä»¥ç”¨ #[derive(Hash)]ï¼Œå‰ææ˜¯æ¯ä¸ªå­—æ®µéƒ½å®ç°äº† Hash
// å¦‚æœè¦èƒ½ä½œä¸º HashMap çš„ keyï¼Œè¿˜éœ€è¦ PartialEq å’Œ Eq
#[derive(Debug, Hash, PartialEq, Eq)]
struct Student&lt;'a&gt; {
    name: &amp;'a str,
    age: u8,
}

impl&lt;'a&gt; Student&lt;'a&gt; {
    pub fn new(name: &amp;'a str, age: u8) -&gt; Self {
        Self { name, age }
    }
}
fn main() {
    let mut hasher = DefaultHasher::new();
    let student = Student::new(&quot;Tyr&quot;, 18);
    // å®ç°äº† Hash çš„æ•°æ®ç»“æ„å¯ä»¥ç›´æ¥è°ƒç”¨ hash æ–¹æ³•
    student.hash(&amp;mut hasher);
    let mut map = HashMap::new();
    // å®ç°äº† Hash / PartialEq / Eq çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º HashMap çš„ key
    map.insert(student, vec![&quot;Math&quot;, &quot;Writing&quot;]);
    println!(&quot;hash: 0x{:x}, map: {:?}&quot;, hasher.finish(), map);
}
</code></pre></pre>
</div>
</details>
<h3 id="hashset--btreemap--btreeset"><a class="header" href="#hashset--btreemap--btreeset">HashSet / BTreeMap / BTreeSet</a></h3>
<details id="admonition-hashsetåªç”¨äºç¡®è®¤å­˜åœ¨å­˜æ”¾æ— åºé›†åˆ" class="admonition info">
<summary class="admonition-title">
<p>HashSetåªç”¨äºç¡®è®¤å­˜åœ¨ï¼Œå­˜æ”¾æ— åºé›†åˆ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-hashsetåªç”¨äºç¡®è®¤å­˜åœ¨å­˜æ”¾æ— åºé›†åˆ"></a></p>
</summary>
<div>
<p>æœ‰æ—¶æˆ‘ä»¬åªéœ€è¦ç®€å•ç¡®è®¤å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœç”¨ HashMap å°±æœ‰äº›æµªè´¹ç©ºé—´äº†ã€‚è¿™æ—¶å¯ä»¥ç”¨ HashSetï¼Œå®ƒå°±æ˜¯ç®€åŒ–çš„ HashMapï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æ— åºçš„é›†åˆï¼Œå®šä¹‰ç›´æ¥æ˜¯ HashMap&lt;K, ()&gt;ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use hashbrown::hash_set as base;

pub struct HashSet&lt;T, S = RandomState&gt; {
    base: base::HashSet&lt;T, S&gt;,
}

pub struct HashSet&lt;T, S = DefaultHashBuilder, A: Allocator + Clone = Global&gt; {
    pub(crate) map: HashMap&lt;T, (), S, A&gt;,
}
</code></pre></pre>
<blockquote>
<p>ä½¿ç”¨ HashSet æŸ¥çœ‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºé›†åˆçš„æ•ˆç‡éå¸¸é«˜ã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-btreemapå’Œbtreesetéƒ½æ˜¯ç”¨äºæŸ¥æ‰¾å­˜æ”¾æœ‰åºé›†åˆ" class="admonition info">
<summary class="admonition-title">
<p>BTreeMapå’ŒBTreeSetéƒ½æ˜¯ç”¨äºæŸ¥æ‰¾ï¼Œå­˜æ”¾æœ‰åºé›†åˆ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-btreemapå’Œbtreesetéƒ½æ˜¯ç”¨äºæŸ¥æ‰¾å­˜æ”¾æœ‰åºé›†åˆ"></a></p>
</summary>
<div>
<p>BTreeMap æ˜¯å†…éƒ¨ä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/B-tree">B-tree</a> æ¥ç»„ç»‡å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ã€‚å¦å¤– BTreeSet å’Œ HashSet ç±»ä¼¼ï¼Œæ˜¯ BTreeMap çš„ç®€åŒ–ç‰ˆï¼Œå¯ä»¥ç”¨æ¥å­˜æ”¾æœ‰åºé›†åˆã€‚
æˆ‘ä»¬è¿™é‡Œé‡ç‚¹çœ‹ä¸‹ BTreeMapï¼Œå®ƒçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct BTreeMap&lt;K, V&gt; {
    root: Option&lt;Root&lt;K, V&gt;&gt;,
    length: usize,
}

pub type Root&lt;K, V&gt; = NodeRef&lt;marker::Owned, K, V, marker::LeafOrInternal&gt;;

pub struct NodeRef&lt;BorrowType, K, V, Type&gt; {
    height: usize,
    node: NonNull&lt;LeafNode&lt;K, V&gt;&gt;,
    _marker: PhantomData&lt;(BorrowType, Type)&gt;,
}

struct LeafNode&lt;K, V&gt; {
    parent: Option&lt;NonNull&lt;InternalNode&lt;K, V&gt;&gt;&gt;,
    parent_idx: MaybeUninit&lt;u16&gt;,
    len: u16,
    keys: [MaybeUninit&lt;K&gt;; CAPACITY],
    vals: [MaybeUninit&lt;V&gt;; CAPACITY],
}

struct InternalNode&lt;K, V&gt; {
    data: LeafNode&lt;K, V&gt;,
    edges: [MaybeUninit&lt;BoxedNode&lt;K, V&gt;&gt;; 2 * B],
}
</code></pre></pre>
<blockquote>
<p>å’Œ HashMap ä¸åŒçš„æ˜¯ï¼ŒBTreeMap æ˜¯æœ‰åºçš„ã€‚æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰:</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::collections::BTreeMap;

fn main() {
    let map = BTreeMap::new();
    let mut map = explain(&quot;empty&quot;, map);

    for i in 0..16usize {
        map.insert(format!(&quot;Tyr {}&quot;, i), i);
    }

    let mut map = explain(&quot;added&quot;, map);

    map.remove(&quot;Tyr 1&quot;);

    let map = explain(&quot;remove 1&quot;, map);

    for item in map.iter() {
        println!(&quot;{:?}&quot;, item);
    }
}

// BTreeMap ç»“æ„æœ‰ heightï¼Œnode å’Œ length
// æˆ‘ä»¬ transmute æ‰“å°ä¹‹åï¼Œå† transmute å›å»
fn explain&lt;K, V&gt;(name: &amp;str, map: BTreeMap&lt;K, V&gt;) -&gt; BTreeMap&lt;K, V&gt; {
    let arr: [usize; 3] = unsafe { std::mem::transmute(map) };
    println!(
        &quot;{}: height: {}, root node: 0x{:x}, len: 0x{:x}&quot;,
        name, arr[0], arr[1], arr[2]
    );
    unsafe { std::mem::transmute(arr) }
}
</code></pre></pre>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨éå†æ—¶ï¼ŒBTreeMap ä¼šæŒ‰ç…§ key çš„é¡ºåºæŠŠå€¼æ‰“å°å‡ºæ¥ã€‚å¦‚æœä½ æƒ³è®©è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„å¯ä»¥ä½œä¸º BTreeMap çš„ keyï¼Œé‚£ä¹ˆéœ€è¦å®ç° PartialOrd å’Œ Ordï¼Œè¿™ä¸¤è€…çš„å…³ç³»å’Œ PartialEq / Eq ç±»ä¼¼ï¼ŒPartialOrd ä¹Ÿæ²¡æœ‰å®ç°è‡ªåæ€§ã€‚åŒæ ·çš„ï¼ŒPartialOrd å’Œ Ord ä¹Ÿå¯ä»¥é€šè¿‡æ´¾ç”Ÿå®æ¥å®ç°ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="ä¸ºä»€ä¹ˆ-rust-çš„-hashmap-è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•"><a class="header" href="#ä¸ºä»€ä¹ˆ-rust-çš„-hashmap-è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•">ä¸ºä»€ä¹ˆ Rust çš„ HashMap è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Ÿ</a></h3>
<details id="admonition-ä¸ºä»€ä¹ˆ-rust-çš„-hashmap-è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•" class="admonition info">
<summary class="admonition-title">
<p>ä¸ºä»€ä¹ˆ Rust çš„ HashMap è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä¸ºä»€ä¹ˆ-rust-çš„-hashmap-è¦ç¼ºçœé‡‡ç”¨åŠ å¯†å®‰å…¨çš„å“ˆå¸Œç®—æ³•"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨åœ¨è½¯ä»¶ç³»ç»Ÿä¸­çš„é‡è¦åœ°ä½ï¼Œä½†å“ˆå¸Œè¡¨åœ¨æœ€åæƒ…å†µä¸‹ï¼Œå¦‚æœç»å¤§å¤šæ•° key çš„ hash éƒ½ç¢°æ’åœ¨ä¸€èµ·ï¼Œæ€§èƒ½ä¼šåˆ° O(n)ï¼Œè¿™ä¼šæå¤§æ‹–ç´¯ç³»ç»Ÿçš„æ•ˆç‡ã€‚</p>
<p>æ¯”å¦‚ 1M å¤§å°çš„ session è¡¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹æŸ¥è¡¨é€Ÿåº¦æ˜¯ O(1)ï¼Œä½†æç«¯æƒ…å†µä¸‹ï¼Œéœ€è¦æ¯”è¾ƒ 1M ä¸ªæ•°æ®åæ‰èƒ½æ‰¾åˆ°ï¼Œè¿™æ ·çš„ç³»ç»Ÿå°±å®¹æ˜“è¢« DoS æ”»å‡»ã€‚æ‰€ä»¥å¦‚æœä¸æ˜¯åŠ å¯†å®‰å…¨çš„å“ˆå¸Œå‡½æ•°ï¼Œåªè¦é»‘å®¢çŸ¥é“å“ˆå¸Œç®—æ³•ï¼Œå°±å¯ä»¥æ„é€ å‡ºå¤§é‡çš„ key äº§ç”Ÿè¶³å¤Ÿå¤šçš„å“ˆå¸Œç¢°æ’ï¼Œé€ æˆç›®æ ‡ç³»ç»Ÿ DoSã€‚</p>
<p>SipHash å°±æ˜¯ä¸ºäº†å›åº” DoS æ”»å‡»è€Œåˆ›å»ºçš„å“ˆå¸Œç®—æ³•ï¼Œè™½ç„¶å’Œ sha2 è¿™æ ·çš„åŠ å¯†å“ˆå¸Œä¸åŒï¼ˆä¸è¦å°† SipHash ç”¨äºåŠ å¯†ï¼ï¼‰ï¼Œä½†å®ƒå¯ä»¥æä¾›ç±»ä¼¼ç­‰çº§çš„å®‰å…¨æ€§ã€‚æŠŠ SipHash ä½œä¸º HashMap çš„ç¼ºçœçš„å“ˆå¸Œç®—æ³•ï¼ŒRust å¯ä»¥é¿å…å¼€å‘è€…åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è¢« DoSï¼Œå°±åƒæ›¾ç»åœ¨ Web ä¸–ç•Œå‘ç”Ÿçš„é‚£æ ·ã€‚
å½“ç„¶ï¼Œè¿™ä¸€åˆ‡çš„ä»£ä»·æ˜¯æ€§èƒ½æŸè€—ï¼Œè™½ç„¶ SipHash éå¸¸å¿«ï¼Œä½†å®ƒæ¯” hashbrown ç¼ºçœä½¿ç”¨çš„ Ahash æ…¢äº†ä¸å°‘ã€‚å¦‚æœä½ ç¡®å®šä½¿ç”¨çš„ HashMap ä¸éœ€è¦ DoS é˜²æŠ¤ï¼ˆæ¯”å¦‚ä¸€ä¸ªå®Œå…¨å†…éƒ¨ä½¿ç”¨çš„ HashMapï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ Ahash æ¥æ›¿æ¢ã€‚ä½ åªéœ€è¦ä½¿ç”¨ Ahash æä¾›çš„ RandomState å³å¯ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use ahash::{AHasher, RandomState};
use std::collections::HashMap;
let mut map: HashMap&lt;char, i32, RandomState&gt; = HashMap::default();
map.insert('a', 1);
</code></pre></pre>
</div>
</details>
<h1 id="ä¸‰é”™è¯¯å¤„ç†"><a class="header" href="#ä¸‰é”™è¯¯å¤„ç†">ä¸‰ã€é”™è¯¯å¤„ç†</a></h1>
<h2 id="é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†"><a class="header" href="#é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†">é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†</a></h2>
<details id="admonition-é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†" class="admonition info">
<summary class="admonition-title">
<p>é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-é”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†"></a></p>
</summary>
<div>
<p>åœ¨ä¸€é—¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ§åˆ¶æµç¨‹æ˜¯è¯­è¨€çš„æ ¸å¿ƒæµç¨‹ï¼Œè€Œé”™è¯¯å¤„ç†åˆæ˜¯æ§åˆ¶æµç¨‹çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p>
<p>è¯­è¨€ä¼˜ç§€çš„é”™è¯¯å¤„ç†èƒ½åŠ›ï¼Œä¼šå¤§å¤§å‡å°‘é”™è¯¯å¤„ç†å¯¹æ•´ä½“æµç¨‹çš„ç ´åï¼Œè®©æˆ‘ä»¬å†™ä»£ç æ›´è¡Œäº‘æµæ°´ï¼Œè¯»èµ·æ¥å¿ƒæ™ºè´Ÿæ‹…ä¹Ÿæ›´å°ã€‚</p>
<p>å¯¹æˆ‘ä»¬å¼€å‘è€…æ¥è¯´ï¼Œé”™è¯¯å¤„ç†åŒ…å«è¿™ä¹ˆå‡ éƒ¨åˆ†ï¼š</p>
<ol>
<li>é”™è¯¯æ•è·åï¼Œå¯ä»¥ç«‹åˆ»å¤„ç†</li>
<li>ä¹Ÿå¯ä»¥å»¶è¿Ÿåˆ°ä¸å¾—ä¸å¤„ç†çš„åœ°æ–¹å†å¤„ç†ï¼Œè¿™å°±æ¶‰åŠåˆ°é”™è¯¯çš„ä¼ æ’­ï¼ˆpropagateï¼‰ã€‚</li>
<li>æœ€åï¼Œæ ¹æ®ä¸åŒçš„é”™è¯¯ç±»å‹ï¼Œç»™ç”¨æˆ·è¿”å›åˆé€‚çš„ã€å¸®åŠ©ä»–ä»¬ç†è§£é—®é¢˜æ‰€åœ¨çš„é”™è¯¯æ¶ˆæ¯ã€‚</li>
</ol>
<hr />
<h2 id="-10"><a class="header" href="#-10"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895295.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></a></h2>
<blockquote>
<p>ä½œä¸ºä¸€é—¨æå…¶æ³¨é‡ç”¨æˆ·ä½“éªŒçš„ç¼–ç¨‹è¯­è¨€ï¼ŒRust ä»å…¶å®ƒä¼˜ç§€çš„è¯­è¨€ä¸­ï¼Œå°¤å…¶æ˜¯ Haskell ï¼Œå¸æ”¶äº†é”™è¯¯å¤„ç†çš„ç²¾é«“ï¼Œå¹¶ä»¥è‡ªå·±ç‹¬åˆ°çš„æ–¹å¼å±•ç°å‡ºæ¥ã€‚</p>
</blockquote>
</div>
</details>
<h2 id="é”™è¯¯å¤„ç†çš„ä¸»æµæ–¹æ³•"><a class="header" href="#é”™è¯¯å¤„ç†çš„ä¸»æµæ–¹æ³•">é”™è¯¯å¤„ç†çš„ä¸»æµæ–¹æ³•</a></h2>
<details id="admonition-é”™è¯¯å¤„ç†çš„ä¸‰ç§ä¸»æµæ–¹æ³•ä»¥åŠå…¶ä»–è¯­è¨€æ˜¯å¦‚ä½•åº”ç”¨è¿™äº›æ–¹æ³•çš„" class="admonition info">
<summary class="admonition-title">
<p>é”™è¯¯å¤„ç†çš„ä¸‰ç§ä¸»æµæ–¹æ³•ä»¥åŠå…¶ä»–è¯­è¨€æ˜¯å¦‚ä½•åº”ç”¨è¿™äº›æ–¹æ³•çš„ã€‚</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-é”™è¯¯å¤„ç†çš„ä¸‰ç§ä¸»æµæ–¹æ³•ä»¥åŠå…¶ä»–è¯­è¨€æ˜¯å¦‚ä½•åº”ç”¨è¿™äº›æ–¹æ³•çš„"></a></p>
</summary>
<div>
<ol>
<li>ä½¿ç”¨è¿”å›å€¼ï¼ˆé”™è¯¯ç ï¼‰</li>
</ol>
<p>ä½¿ç”¨è¿”å›å€¼æ¥è¡¨å¾é”™è¯¯ï¼Œæ˜¯æœ€å¤è€ä¹Ÿæ˜¯æœ€å®ç”¨çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒçš„ä½¿ç”¨èŒƒå›´å¾ˆå¹¿ï¼Œä»å‡½æ•°è¿”å›å€¼ï¼Œåˆ°æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨çš„é”™è¯¯ç  errnoã€è¿›ç¨‹é€€å‡ºçš„é”™è¯¯ç  retvalï¼Œç”šè‡³ HTTP API çš„çŠ¶æ€ç ï¼Œéƒ½èƒ½çœ‹åˆ°è¿™ç§æ–¹æ³•çš„èº«å½±ã€‚</p>
<blockquote>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ C è¯­è¨€ä¸­ï¼Œå¦‚æœ fopen(filename) æ— æ³•æ‰“å¼€æ–‡ä»¶ï¼Œä¼šè¿”å› NULLï¼Œè°ƒç”¨è€…é€šè¿‡åˆ¤æ–­è¿”å›å€¼æ˜¯å¦ä¸º NULLï¼Œæ¥è¿›è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†ã€‚</p>
</blockquote>
<blockquote>
<p>æˆ‘ä»¬å†çœ‹ä¸ªä¾‹å­ï¼š</p>
</blockquote>
<pre><code class="language-c">
size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream)
</code></pre>
<p>å•çœ‹è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¾ˆéš¾ç›´è§‚äº†è§£ï¼Œå½“è¯»æ–‡ä»¶å‡ºé”™æ—¶ï¼Œé”™è¯¯æ˜¯å¦‚ä½•è¿”å›çš„ã€‚ä»æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥ï¼Œå¦‚æœè¿”å›çš„ size_t å’Œä¼ å…¥çš„ size_t ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆè¦ä¹ˆå‘ç”Ÿäº†é”™è¯¯ï¼Œè¦ä¹ˆæ˜¯è¯»åˆ°æ–‡ä»¶å°¾ï¼ˆEOFï¼‰ï¼Œè°ƒç”¨è€…è¦è¿›ä¸€æ­¥é€šè¿‡ ferror æ‰èƒ½å¾—åˆ°æ›´è¯¦ç»†çš„é”™è¯¯ã€‚</p>
<p>åƒ C è¿™æ ·ï¼Œé€šè¿‡è¿”å›å€¼æºå¸¦é”™è¯¯ä¿¡æ¯ï¼Œæœ‰å¾ˆå¤šå±€é™ã€‚è¿”å›å€¼æœ‰å®ƒåŸæœ¬çš„è¯­ä¹‰ï¼Œå¼ºè¡ŒæŠŠé”™è¯¯ç±»å‹åµŒå…¥åˆ°è¿”å›å€¼åŸæœ¬çš„è¯­ä¹‰ä¸­ï¼Œéœ€è¦å…¨é¢ä¸”å®æ—¶æ›´æ–°çš„æ–‡æ¡£ï¼Œæ¥ç¡®ä¿å¼€å‘è€…èƒ½æ­£ç¡®åŒºåˆ«å¯¹å¾…ï¼Œæ­£å¸¸è¿”å›å’Œé”™è¯¯è¿”å›ã€‚</p>
<p>æ‰€ä»¥ Golang å¯¹å…¶åšäº†æ‰©å±•ï¼Œåœ¨å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œå¯ä»¥ä¸“é—¨æºå¸¦ä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚æ¯”å¦‚ä¸Šæ–‡çš„ freadï¼Œåœ¨ Golang ä¸‹å¯ä»¥è¿™ä¹ˆå®šä¹‰ï¼š</p>
<pre><code class="language-go">
func Fread(file *File, b []byte) (n int, err error)
</code></pre>
<p>Golang è¿™æ ·ï¼ŒåŒºåˆ†å¼€é”™è¯¯è¿”å›å’Œæ­£å¸¸è¿”å›ï¼Œç›¸å¯¹ C æ¥è¯´è¿›äº†ä¸€å¤§æ­¥ã€‚</p>
<blockquote>
<p>ä½†æ˜¯ä½¿ç”¨è¿”å›å€¼çš„æ–¹å¼ï¼Œå§‹ç»ˆæœ‰ä¸ªè‡´å‘½çš„é—®é¢˜ï¼šåœ¨è°ƒç”¨è€…è°ƒç”¨æ—¶ï¼Œé”™è¯¯å°±å¿…é¡»å¾—åˆ°å¤„ç†æˆ–è€…æ˜¾å¼çš„ä¼ æ’­ã€‚</p>
</blockquote>
<p>å¦‚æœå‡½æ•° A è°ƒç”¨äº†å‡½æ•° Bï¼Œåœ¨ A è¿”å›é”™è¯¯çš„æ—¶å€™ï¼Œå°±è¦æŠŠ B çš„é”™è¯¯è½¬æ¢æˆ A çš„é”™è¯¯ï¼Œæ˜¾ç¤ºå‡ºæ¥ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895283.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<p>è¿™æ ·å†™å‡ºæ¥çš„ä»£ç ä¼šéå¸¸å†—é•¿ï¼Œå¯¹æˆ‘ä»¬å¼€å‘è€…çš„ç”¨æˆ·ä½“éªŒä¸å¤ªå¥½ã€‚å¦‚æœä¸å¤„ç†ï¼Œåˆä¼šä¸¢æ‰è¿™ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œé€ æˆéšæ‚£ã€‚</p>
<p>å¦å¤–ï¼Œå¤§éƒ¨åˆ†ç”Ÿäº§ç¯å¢ƒä¸‹çš„é”™è¯¯æ˜¯åµŒå¥—çš„ã€‚ä¸€ä¸ª SQL æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºçš„é”™è¯¯ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨å‡ºé”™ï¼Œè€Œæ›´æ·±å±‚æ¬¡çš„é”™è¯¯å¯èƒ½æ˜¯ï¼Œè¿æ¥æ•°æ®åº“æœåŠ¡å™¨çš„ TLS session çŠ¶æ€å¼‚å¸¸ã€‚</p>
<p>å…¶å®çŸ¥é“æœåŠ¡å™¨å‡ºé”™ä¹‹å¤–ï¼Œæˆ‘ä»¬æ›´éœ€è¦æ¸…æ¥šæœåŠ¡å™¨å‡ºé”™çš„å†…åœ¨åŸå› ã€‚</p>
<ul>
<li>å› ä¸ºæœåŠ¡å™¨å‡ºé”™è¿™ä¸ªè¡¨å±‚é”™è¯¯ä¼šæä¾›ç»™æœ€ç»ˆç”¨æˆ·ï¼Œè€Œå‡ºé”™çš„æ·±å±‚åŸå› è¦æä¾›ç»™æˆ‘ä»¬è‡ªå·±ï¼ŒæœåŠ¡çš„ç»´æŠ¤è€…ã€‚</li>
<li>ä½†æ˜¯è¿™æ ·çš„åµŒå¥—é”™è¯¯åœ¨ C / Golang éƒ½æ˜¯å¾ˆéš¾å®Œç¾è¡¨è¿°çš„ã€‚</li>
</ul>
<hr />
<ol start="2">
<li>ä½¿ç”¨å¼‚å¸¸</li>
</ol>
<p>å› ä¸ºè¿”å›å€¼ä¸åˆ©äºé”™è¯¯çš„ä¼ æ’­ï¼Œæœ‰è¯¸å¤šé™åˆ¶ï¼ŒJava ç­‰å¾ˆå¤šè¯­è¨€ä½¿ç”¨å¼‚å¸¸æ¥å¤„ç†é”™è¯¯ã€‚</p>
<p>ä½ å¯ä»¥æŠŠå¼‚å¸¸çœ‹æˆä¸€ç§å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰ï¼š</p>
<ol>
<li>é”™è¯¯çš„äº§ç”Ÿå’Œé”™è¯¯çš„å¤„ç†å®Œå…¨è¢«åˆ†éš”å¼€</li>
<li>è°ƒç”¨è€…ä¸å¿…å…³å¿ƒé”™è¯¯ï¼Œè€Œè¢«è°ƒè€…ä¹Ÿä¸å¼ºæ±‚è°ƒç”¨è€…å…³å¿ƒé”™è¯¯ã€‚</li>
</ol>
<ul>
<li>ç¨‹åºä¸­ä»»ä½•å¯èƒ½å‡ºé”™çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼›</li>
<li>è€Œå¼‚å¸¸å¯ä»¥é€šè¿‡æ ˆå›æº¯ï¼ˆstack unwindï¼‰è¢«ä¸€å±‚å±‚è‡ªåŠ¨ä¼ é€’ï¼Œç›´åˆ°é‡åˆ°æ•è·å¼‚å¸¸çš„åœ°æ–¹ï¼Œ</li>
<li>å¦‚æœå›æº¯åˆ° main å‡½æ•°è¿˜æ— äººæ•è·ï¼Œç¨‹åºå°±ä¼šå´©æºƒã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895270.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<p>ä½¿ç”¨å¼‚å¸¸æ¥è¿”å›é”™è¯¯å¯ä»¥æå¤§åœ°ç®€åŒ–é”™è¯¯å¤„ç†çš„æµç¨‹ï¼Œå®ƒè§£å†³äº†è¿”å›å€¼çš„ä¼ æ’­é—®é¢˜ã€‚</p>
<p>ç„¶è€Œï¼Œä¸Šå›¾ä¸­å¼‚å¸¸è¿”å›çš„è¿‡ç¨‹çœ‹ä¸Šå»å¾ˆç›´è§‚ï¼Œå°±åƒæ•°æ®åº“ä¸­çš„äº‹åŠ¡ï¼ˆtransactionï¼‰åœ¨å‡ºé”™æ—¶ä¼šè¢«æ•´ä½“æ’¤é”€ï¼ˆrollbackï¼‰ä¸€æ ·ã€‚</p>
<blockquote>
<p>ä½†å®é™…ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹è¿œæ¯”ä½ æƒ³è±¡çš„å¤æ‚ï¼Œè€Œä¸”éœ€è¦é¢å¤–æ“å¿ƒ<a href="https://www.lighterra.com/papers/exceptionsharmful/">å¼‚å¸¸å®‰å…¨ï¼ˆexception safetyï¼‰</a>ã€‚
æˆ‘ä»¬çœ‹ä¸‹é¢ç”¨æ¥åˆ‡æ¢èƒŒæ™¯å›¾ç‰‡çš„ï¼ˆä¼ªï¼‰ä»£ç ï¼š</p>
</blockquote>
<pre><code class="language-c++">
void transition(...) {
  lock(&amp;mutex);
  delete background;
  ++changed;
  background = new Background(...);
  unlock(&amp;mutex);
}
</code></pre>
<p>è¯•æƒ³, å¦‚æœåœ¨åˆ›å»ºæ–°çš„èƒŒæ™¯æ—¶å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œä¼šè·³è¿‡åç»­çš„å¤„ç†æµç¨‹ï¼Œä¸€è·¯æ ˆå›æº¯åˆ° try catch çš„ä»£ç ï¼Œé‚£ä¹ˆï¼Œè¿™é‡Œé”ä½çš„ mutex æ— æ³•å¾—åˆ°é‡Šæ”¾ï¼Œè€Œå·²æœ‰çš„èƒŒæ™¯è¢«æ¸…ç©ºï¼Œæ–°çš„èƒŒæ™¯æ²¡æœ‰åˆ›å»ºï¼Œç¨‹åºè¿›å…¥åˆ°ä¸€ä¸ªå¥‡æ€ªçš„çŠ¶æ€ã€‚</p>
<p>ç¡®å®åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç”¨å¼‚å¸¸æ›´å®¹æ˜“å†™ä»£ç ï¼Œä½†å½“å¼‚å¸¸å®‰å…¨æ— æ³•ä¿è¯æ—¶ï¼Œç¨‹åºçš„æ­£ç¡®æ€§ä¼šå—åˆ°å¾ˆå¤§çš„æŒ‘æˆ˜ã€‚å› æ­¤ï¼Œä½ åœ¨ä½¿ç”¨å¼‚å¸¸å¤„ç†æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„å¼‚å¸¸å®‰å…¨ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ã€‚</p>
<p>å¼‚å¸¸å¤„ç†å¦å¤–ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„é—®é¢˜æ˜¯ï¼šå¼€å‘è€…ä¼šæ»¥ç”¨å¼‚å¸¸ã€‚åªè¦æœ‰é”™è¯¯ï¼Œä¸è®ºæ˜¯å¦ä¸¥é‡ã€æ˜¯å¦å¯æ¢å¤ï¼Œéƒ½ä¸€è‚¡è„‘æŠ›ä¸ªå¼‚å¸¸ã€‚åˆ°äº†éœ€è¦çš„åœ°æ–¹ï¼Œæ•è·ä¸€ä¸‹äº†ä¹‹ã€‚æ®Šä¸çŸ¥ï¼Œå¼‚å¸¸å¤„ç†çš„å¼€é”€è¦æ¯”å¤„ç†è¿”å›å€¼å¤§å¾—å¤šï¼Œæ»¥ç”¨ä¼šæœ‰å¾ˆå¤šé¢å¤–çš„å¼€é”€ã€‚</p>
</div>
</details>
<ol start="3">
<li>ä½¿ç”¨ç±»å‹ç³»ç»Ÿ</li>
</ol>
<p>ç¬¬ä¸‰ç§é”™è¯¯å¤„ç†çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨ç±»å‹ç³»ç»Ÿã€‚å…¶å®ï¼Œåœ¨ä½¿ç”¨è¿”å›å€¼å¤„ç†é”™è¯¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ç±»å‹ç³»ç»Ÿçš„é›å½¢ã€‚</p>
<p>é”™è¯¯ä¿¡æ¯æ—¢ç„¶å¯ä»¥é€šè¿‡å·²æœ‰çš„ç±»å‹æºå¸¦ï¼Œæˆ–è€…é€šè¿‡å¤šè¿”å›å€¼çš„æ–¹å¼æä¾›ï¼Œé‚£ä¹ˆé€šè¿‡ç±»å‹æ¥è¡¨å¾é”™è¯¯ï¼Œä½¿ç”¨ä¸€ä¸ªå†…éƒ¨åŒ…å«æ­£å¸¸è¿”å›ç±»å‹å’Œé”™è¯¯è¿”å›ç±»å‹çš„å¤åˆç±»å‹ï¼Œé€šè¿‡ç±»å‹ç³»ç»Ÿæ¥å¼ºåˆ¶é”™è¯¯çš„å¤„ç†å’Œä¼ é€’ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è¾¾åˆ°æ›´å¥½çš„æ•ˆæœå‘¢ï¼Ÿ</p>
<p>çš„ç¡®å¦‚æ­¤ã€‚è¿™ç§æ–¹å¼è¢«å¤§é‡ä½¿ç”¨åœ¨æœ‰å¼ºå¤§ç±»å‹ç³»ç»Ÿæ”¯æŒçš„å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¦‚ Haskell/Scala/Swiftã€‚å…¶ä¸­æœ€å…¸å‹çš„åŒ…å«äº†é”™è¯¯ç±»å‹çš„å¤åˆç±»å‹æ˜¯ Haskell çš„ Maybe å’Œ Either ç±»å‹ã€‚</p>
<ul>
<li>
<p>Maybe ç±»å‹å…è®¸æ•°æ®åŒ…å«ä¸€ä¸ªå€¼ï¼ˆJustï¼‰æˆ–è€…æ²¡æœ‰å€¼ï¼ˆNothingï¼‰ï¼Œè¿™å¯¹ç®€å•çš„ä¸éœ€è¦ç±»å‹çš„é”™è¯¯å¾ˆæœ‰ç”¨ã€‚è¿˜æ˜¯ä»¥æ‰“å¼€æ–‡ä»¶ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬åªå…³å¿ƒæˆåŠŸæ‰“å¼€æ–‡ä»¶çš„å¥æŸ„ï¼Œé‚£ä¹ˆ Maybe å°±è¶³å¤Ÿäº†ã€‚</p>
</li>
<li>
<p>å½“æˆ‘ä»¬éœ€è¦æ›´ä¸ºå¤æ‚çš„é”™è¯¯å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Either ç±»å‹ã€‚å®ƒå…è®¸æ•°æ®æ˜¯ Left a æˆ–è€… Right b ã€‚å…¶ä¸­ï¼Œa æ˜¯è¿è¡Œå‡ºé”™çš„æ•°æ®ç±»å‹ï¼Œb å¯ä»¥æ˜¯æˆåŠŸçš„æ•°æ®ç±»å‹ã€‚</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895260.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹æ³•ä¾æ—§æ˜¯é€šè¿‡è¿”å›å€¼è¿”å›é”™è¯¯ï¼Œä½†æ˜¯é”™è¯¯è¢«åŒ…è£¹åœ¨ä¸€ä¸ªå®Œæ•´çš„ã€å¿…é¡»å¤„ç†çš„ç±»å‹ä¸­ï¼Œæ¯” Golang çš„æ–¹æ³•æ›´å®‰å…¨ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å‰é¢æåˆ°ï¼Œä½¿ç”¨è¿”å›å€¼è¿”å›é”™è¯¯çš„ä¸€å¤§ç¼ºç‚¹æ˜¯ï¼Œé”™è¯¯éœ€è¦è¢«è°ƒç”¨è€…ç«‹å³å¤„ç†æˆ–è€…æ˜¾å¼ä¼ é€’ã€‚ä½†æ˜¯ä½¿ç”¨ Maybe / Either è¿™æ ·çš„ç±»å‹æ¥å¤„ç†é”™è¯¯çš„å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å‡½æ•°å¼ç¼–ç¨‹çš„æ–¹æ³•ç®€åŒ–é”™è¯¯çš„å¤„ç†ï¼Œæ¯”å¦‚ mapã€fold
ç­‰å‡½æ•°ï¼Œè®©ä»£ç ç›¸å¯¹ä¸é‚£ä¹ˆå†—ä½™ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¾ˆå¤šä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œå¦‚â€œç£ç›˜å†™æ»¡ï¼Œæ— æ³•å†™å…¥â€çš„é”™è¯¯ï¼Œä½¿ç”¨å¼‚å¸¸å¤„ç†å¯ä»¥é¿å…ä¸€å±‚å±‚ä¼ é€’é”™è¯¯ï¼Œè®©ä»£ç ç®€æ´é«˜æ•ˆï¼Œæ‰€ä»¥å¤§å¤šæ•°ä½¿ç”¨ç±»å‹ç³»ç»Ÿæ¥å¤„ç†é”™è¯¯çš„è¯­è¨€ï¼Œä¼šåŒæ—¶ä½¿ç”¨å¼‚å¸¸å¤„ç†ä½œä¸ºè¡¥å……ã€‚</p>
<h2 id="rust-çš„é”™è¯¯å¤„ç†"><a class="header" href="#rust-çš„é”™è¯¯å¤„ç†">Rust çš„é”™è¯¯å¤„ç†</a></h2>
<p>ç”±äºè¯ç”Ÿçš„å¹´ä»£æ¯”è¾ƒæ™šï¼ŒRust æœ‰æœºä¼šä»å·²æœ‰çš„è¯­è¨€ä¸­å­¦ä¹ åˆ°å„ç§é”™è¯¯å¤„ç†çš„ä¼˜åŠ£ã€‚å¯¹äº Rust æ¥è¯´ï¼Œç›®å‰çš„å‡ ç§æ–¹å¼ç›¸æ¯”è€Œè¨€ï¼Œæœ€ä½³çš„æ–¹æ³•æ˜¯ï¼Œä½¿ç”¨ç±»å‹ç³»ç»Ÿæ¥æ„å»ºä¸»è¦çš„é”™è¯¯å¤„ç†æµç¨‹ã€‚</p>
<h3 id="rust-å·å¸ˆ-haskellæ„å»ºäº†å¯¹æ ‡-maybe-çš„-option-ç±»å‹å’Œ-å¯¹æ ‡-either-çš„-result-ç±»å‹"><a class="header" href="#rust-å·å¸ˆ-haskellæ„å»ºäº†å¯¹æ ‡-maybe-çš„-option-ç±»å‹å’Œ-å¯¹æ ‡-either-çš„-result-ç±»å‹">Rust å·å¸ˆ Haskellï¼Œæ„å»ºäº†å¯¹æ ‡ Maybe çš„ Option ç±»å‹å’Œ å¯¹æ ‡ Either çš„ Result ç±»å‹ã€‚</a></h3>
<details id="admonition-rust-å·å¸ˆ-haskellæ„å»ºäº†å¯¹æ ‡-maybe-çš„-option-ç±»å‹å’Œ-å¯¹æ ‡-either-çš„-result-ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>Rust å·å¸ˆ Haskellï¼Œæ„å»ºäº†å¯¹æ ‡ Maybe çš„ Option ç±»å‹å’Œ å¯¹æ ‡ Either çš„ Result ç±»å‹</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-rust-å·å¸ˆ-haskellæ„å»ºäº†å¯¹æ ‡-maybe-çš„-option-ç±»å‹å’Œ-å¯¹æ ‡-either-çš„-result-ç±»å‹"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895260.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<ul>
<li>Option æ˜¯ä¸€ä¸ª enumï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
pub enum Option&lt;T&gt; {
    None,
    Some(T),
}
</code></pre></pre>
<blockquote>
<p>å®ƒå¯ä»¥æ‰¿è½½æœ‰å€¼ / æ— å€¼è¿™ç§æœ€ç®€å•çš„é”™è¯¯ç±»å‹ã€‚</p>
</blockquote>
<ul>
<li>Result æ˜¯ä¸€ä¸ªæ›´åŠ å¤æ‚çš„ enumï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
#[must_use = &quot;this `Result` may be an `Err` variant, which should be handled&quot;]
pub enum Result&lt;T, E&gt; {
    Ok(T),
    Err(E),
}
</code></pre></pre>
<blockquote>
<p>å½“å‡½æ•°å‡ºé”™æ—¶ï¼Œå¯ä»¥è¿”å› Err(E)ï¼Œå¦åˆ™ Ok(T)ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼ŒResult ç±»å‹å£°æ˜æ—¶è¿˜æœ‰ä¸ª must_use çš„æ ‡æ³¨ï¼Œç¼–è¯‘å™¨ä¼šå¯¹æœ‰ must_use æ ‡æ³¨çš„æ‰€æœ‰ç±»å‹åšç‰¹æ®Šå¤„ç†ï¼šå¦‚æœè¯¥ç±»å‹å¯¹åº”çš„å€¼æ²¡æœ‰è¢«æ˜¾å¼ä½¿ç”¨ï¼Œåˆ™ä¼šå‘Šè­¦ã€‚è¿™æ ·ï¼Œä¿è¯é”™è¯¯è¢«å¦¥å–„å¤„ç†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/e2100e3f17a9587c4d4bf50523c10653.png" alt="img" /></p>
<p>è¿™é‡Œï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨ read_file å‡½æ•°æ—¶ï¼Œç›´æ¥ä¸¢å¼ƒè¿”å›å€¼ï¼Œç”±äº #[must_use] çš„æ ‡æ³¨ï¼ŒRust ç¼–è¯‘å™¨æŠ¥è­¦ï¼Œè¦æ±‚æˆ‘ä»¬ä½¿ç”¨å…¶è¿”å›å€¼ã€‚</p>
</div>
</details>
<h3 id="-æ“ä½œç¬¦"><a class="header" href="#-æ“ä½œç¬¦">? æ“ä½œç¬¦</a></h3>
<details id="admonition--æ“ä½œç¬¦çš„ç”±æ¥" class="admonition info">
<summary class="admonition-title">
<p>? æ“ä½œç¬¦çš„ç”±æ¥</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition--æ“ä½œç¬¦çš„ç”±æ¥"></a></p>
</summary>
<div>
<p>è¿™è™½ç„¶å¯ä»¥æå¤§é¿å…é—å¿˜é”™è¯¯çš„æ˜¾ç¤ºå¤„ç†ï¼Œä½†å¦‚æœæˆ‘ä»¬å¹¶ä¸å…³å¿ƒé”™è¯¯ï¼Œåªéœ€è¦ä¼ é€’é”™è¯¯ï¼Œè¿˜æ˜¯ä¼šå†™å‡ºåƒ C æˆ–è€… Golang ä¸€æ ·æ¯”è¾ƒå†—ä½™çš„ä»£ç ã€‚æ€ä¹ˆåŠï¼Ÿ</p>
<p>å¥½åœ¨ Rust é™¤äº†æœ‰å¼ºå¤§çš„ç±»å‹ç³»ç»Ÿå¤–ï¼Œè¿˜å…·å¤‡å…ƒç¼–ç¨‹çš„èƒ½åŠ›ã€‚æ—©æœŸ Rust æä¾›äº† try! å®æ¥ç®€åŒ–é”™è¯¯çš„æ˜¾å¼å¤„ç†ï¼Œåæ¥ä¸ºäº†è¿›ä¸€æ­¥æå‡ç”¨æˆ·ä½“éªŒï¼Œtry! è¢«è¿›åŒ–æˆ ? æ“ä½œç¬¦ã€‚</p>
<p>æ‰€ä»¥åœ¨ Rust ä»£ç ä¸­ï¼Œå¦‚æœä½ åªæƒ³ä¼ æ’­é”™è¯¯ï¼Œä¸æƒ³å°±åœ°å¤„ç†ï¼Œå¯ä»¥ç”¨ ? æ“ä½œç¬¦ï¼Œæ¯”å¦‚ï¼ˆä»£ç ï¼‰:</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::fs::File;
use std::io::Read;

fn read_file(name: &amp;str) -&gt; Result&lt;String, std::io::Error&gt; {
  let mut f = File::open(name)?;
  let mut contents = String::new();
  f.read_to_string(&amp;mut contents)?;
  Ok(contents)
}
</code></pre></pre>
<blockquote>
<p>é€šè¿‡ ? æ“ä½œç¬¦ï¼ŒRust è®©é”™è¯¯ä¼ æ’­çš„ä»£ä»·å’Œå¼‚å¸¸å¤„ç†ä¸ç›¸ä¸Šä¸‹ï¼ŒåŒæ—¶åˆé¿å…äº†å¼‚å¸¸å¤„ç†çš„è¯¸å¤šé—®é¢˜ã€‚</p>
</blockquote>
<hr />
<p>? æ“ä½œç¬¦å†…éƒ¨è¢«å±•å¼€æˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
match result {
  Ok(v) =&gt; v,
  Err(e) =&gt; return Err(e.into())
}
</code></pre></pre>
<blockquote>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°å†™å‡ºç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼Œç®€æ´æ˜“æ‡‚ï¼Œå¯è¯»æ€§å¾ˆå¼ºï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
fut
  .await?
  .process()?
  .next()
  .await?;
</code></pre></pre>
<p>æ•´ä¸ªä»£ç çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F-4895239.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<p>è™½ç„¶ ? æ“ä½œç¬¦ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼Œä½†ä½ è¦æ³¨æ„åœ¨ä¸åŒçš„é”™è¯¯ç±»å‹ä¹‹é—´æ˜¯æ— æ³•ç›´æ¥ä½¿ç”¨çš„ï¼Œéœ€è¦å®ç° From trait åœ¨äºŒè€…ä¹‹é—´å»ºç«‹èµ·è½¬æ¢çš„æ¡¥æ¢ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„éº»çƒ¦ã€‚</p>
</div>
</details>
<h3 id="å‡½æ•°å¼é”™è¯¯å¤„ç†"><a class="header" href="#å‡½æ•°å¼é”™è¯¯å¤„ç†">å‡½æ•°å¼é”™è¯¯å¤„ç†</a></h3>
<details id="admonition-map--map_err--and_then-ä½¿ç”¨å‡½æ•°å¼é”™è¯¯å¤„ç†" class="admonition info">
<summary class="admonition-title">
<p>map / map_err / and_then: ä½¿ç”¨å‡½æ•°å¼é”™è¯¯å¤„ç†</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-map--map_err--and_then-ä½¿ç”¨å‡½æ•°å¼é”™è¯¯å¤„ç†"></a></p>
</summary>
<div>
<p>Rust è¿˜ä¸º Option å’Œ Result æä¾›äº†å¤§é‡çš„è¾…åŠ©å‡½æ•°ï¼Œå¦‚ map / map_err / and_thenï¼Œä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¤„ç†æ•°æ®ç»“æ„ä¸­éƒ¨åˆ†æƒ…å†µã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/18%EF%BD%9C%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88Rust%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E4%BC%97%E4%B8%8D%E5%90%8C%EF%BC%9F.jpg" alt="18ï½œé”™è¯¯å¤„ç†ï¼šä¸ºä»€ä¹ˆRustçš„é”™è¯¯å¤„ç†ä¸ä¼—ä¸åŒï¼Ÿ" /></p>
<p>é€šè¿‡è¿™äº›å‡½æ•°ï¼Œä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹é”™è¯¯å¤„ç†å¼•å…¥ <a href="https://www.slideshare.net/ScottWlaschin/railway-oriented-programming">Railroad oriented programming èŒƒå¼</a>ã€‚æ¯”å¦‚ç”¨æˆ·æ³¨å†Œçš„æµç¨‹ï¼Œä½ éœ€è¦æ ¡éªŒç”¨æˆ·è¾“å…¥ï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œè½¬æ¢ï¼Œç„¶åå­˜å…¥æ•°æ®åº“ä¸­ã€‚ä½ å¯ä»¥è¿™ä¹ˆæ’°å†™è¿™ä¸ªæµç¨‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
Ok(data)
  .and_then(validate)
  .and_then(process)
  .map(transform)
  .and_then(store)
  .map_error(...)
</code></pre></pre>
<blockquote>
<p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/image-20221004225336162.png" alt="image-20221004225336162" /></p>
<p>æ­¤å¤–ï¼ŒOption å’Œ Result çš„äº’ç›¸è½¬æ¢ä¹Ÿå¾ˆæ–¹æ¢ï¼Œè¿™ä¹Ÿå¾—ç›Šäº Rust æ„å»ºçš„å¼ºå¤§çš„å‡½æ•°å¼ç¼–ç¨‹çš„èƒ½åŠ›ã€‚</p>
</div>
</details>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯é€šè¿‡ ? æ“ä½œç¬¦ï¼Œè¿˜æ˜¯å‡½æ•°å¼ç¼–ç¨‹è¿›è¡Œé”™è¯¯å¤„ç†ï¼ŒRust éƒ½åŠ›æ±‚è®©é”™è¯¯å¤„ç†çµæ´»é«˜æ•ˆï¼Œè®©å¼€å‘è€…ä½¿ç”¨èµ·æ¥ç®€å•ç›´è§‚ã€‚</p>
<h3 id="panic-å’Œ-catch_unwind"><a class="header" href="#panic-å’Œ-catch_unwind">panic! å’Œ catch_unwind</a></h3>
<details id="admonition-rust-ä¹Ÿæä¾›äº†ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†èƒ½åŠ›-panicå’Œcatch_unwind" class="admonition info">
<summary class="admonition-title">
<p>Rust ä¹Ÿæä¾›äº†ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†èƒ½åŠ›: panic!å’Œcatch_unwind</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-rust-ä¹Ÿæä¾›äº†ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†èƒ½åŠ›-panicå’Œcatch_unwind"></a></p>
</summary>
<div>
<p>ä½¿ç”¨ Option å’Œ Result æ˜¯ Rust ä¸­å¤„ç†é”™è¯¯çš„é¦–é€‰ï¼Œç»å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬ä¹Ÿåº”è¯¥ä½¿ç”¨ï¼Œä½† Rust ä¹Ÿæä¾›äº†ç‰¹æ®Šçš„å¼‚å¸¸å¤„ç†èƒ½åŠ›ã€‚</p>
<p>åœ¨ Rust çœ‹æ¥ï¼Œä¸€æ—¦ä½ éœ€è¦æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£æŠ›å‡ºçš„ä¸€å®šæ˜¯ä¸¥é‡çš„é”™è¯¯ã€‚æ‰€ä»¥ï¼ŒRust è·Ÿ Golang ä¸€æ ·ï¼Œä½¿ç”¨äº†è¯¸å¦‚ panic! è¿™æ ·çš„å­—çœ¼è­¦ç¤ºå¼€å‘è€…ï¼šæƒ³æ¸…æ¥šäº†å†ä½¿ç”¨æˆ‘ã€‚åœ¨ä½¿ç”¨ Option å’Œ Result ç±»å‹æ—¶ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥å¯¹å…¶ unwarp() æˆ–è€… expect()ï¼Œå¼ºåˆ¶æŠŠ Option<T> å’Œ Result&lt;T, E&gt; è½¬æ¢æˆ Tï¼Œå¦‚æœæ— æ³•å®Œæˆè¿™ç§è½¬æ¢ï¼Œä¹Ÿä¼š panic! å‡ºæ¥ã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œpanic! æ˜¯ä¸å¯æ¢å¤æˆ–è€…ä¸æƒ³æ¢å¤çš„é”™è¯¯ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ­¤åˆ»ï¼Œç¨‹åºç»ˆæ­¢è¿è¡Œå¹¶å¾—åˆ°å´©æºƒä¿¡æ¯ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œå®ƒè§£æ<a href="https://noiseprotocol.org/noise.html#protocol-names-and-modifiers"> noise protocol</a>çš„åè®®å˜é‡ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let params: NoiseParams = &quot;Noise_XX_25519_AESGCM_SHA256&quot;.parse().unwrap();
</code></pre></pre>
<h2 id="å¦‚æœå¼€å‘è€…ä¸å°å¿ƒæŠŠåè®®å˜é‡å†™é”™äº†æœ€ä½³çš„æ–¹å¼æ˜¯ç«‹åˆ»-panic-å‡ºæ¥è®©é”™è¯¯ç«‹åˆ»æš´éœ²ä»¥ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜"><a class="header" href="#å¦‚æœå¼€å‘è€…ä¸å°å¿ƒæŠŠåè®®å˜é‡å†™é”™äº†æœ€ä½³çš„æ–¹å¼æ˜¯ç«‹åˆ»-panic-å‡ºæ¥è®©é”™è¯¯ç«‹åˆ»æš´éœ²ä»¥ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜">å¦‚æœå¼€å‘è€…ä¸å°å¿ƒæŠŠåè®®å˜é‡å†™é”™äº†ï¼Œæœ€ä½³çš„æ–¹å¼æ˜¯ç«‹åˆ» panic! å‡ºæ¥ï¼Œè®©é”™è¯¯ç«‹åˆ»æš´éœ²ï¼Œä»¥ä¾¿è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</a></h2>
<p>æœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿåƒå¼‚å¸¸å¤„ç†é‚£æ ·èƒ½å¤Ÿæ ˆå›æº¯ï¼ŒæŠŠç¯å¢ƒæ¢å¤åˆ°æ•è·å¼‚å¸¸çš„ä¸Šä¸‹æ–‡ã€‚Rust æ ‡å‡†åº“ä¸‹æä¾›äº† catch_unwind() ï¼ŒæŠŠè°ƒç”¨æ ˆå›æº¯åˆ° catch_unwind è¿™ä¸€åˆ»ï¼Œä½œç”¨å’Œå…¶å®ƒè¯­è¨€çš„ try {â€¦} catch {â€¦} ä¸€æ ·ã€‚è§å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::panic;

fn main() {
    let result = panic::catch_unwind(|| {
        println!(&quot;hello!&quot;);
    });
    assert!(result.is_ok());
    let result = panic::catch_unwind(|| {
        panic!(&quot;oh no!&quot;);
    });
    assert!(result.is_err());
    println!(&quot;panic captured: {:#?}&quot;, result);
}
</code></pre></pre>
<p>å½“ç„¶ï¼Œå’Œå¼‚å¸¸å¤„ç†ä¸€æ ·ï¼Œå¹¶ä¸æ„å‘³ç€ä½ å¯ä»¥æ»¥ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œæˆ‘æƒ³ï¼Œè¿™ä¹Ÿæ˜¯ Rust æŠŠæŠ›å‡ºå¼‚å¸¸ç§°ä½œ panic! ï¼Œè€Œæ•è·å¼‚å¸¸ç§°ä½œ catch_unwind çš„åŸå› ï¼Œè®©åˆå­¦è€…æœ›è€Œç”Ÿç•ï¼Œä¸æ•¢è½»æ˜“ä½¿ç”¨ã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„ç”¨æˆ·ä½“éªŒã€‚</p>
<p>catch_unwind åœ¨æŸäº›åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨:</p>
<ol>
<li>æ¯”å¦‚ä½ åœ¨ä½¿ç”¨ Rust ä¸º erlang VM æ’°å†™ NIFï¼Œä½ ä¸å¸Œæœ› Rust ä»£ç ä¸­çš„ä»»ä½• panic! å¯¼è‡´ erlang VM å´©æºƒã€‚å› ä¸ºå´©æºƒæ˜¯ä¸€ä¸ªéå¸¸ä¸å¥½çš„ä½“éªŒï¼Œå®ƒè¿èƒŒäº† erlang çš„è®¾è®¡åŸåˆ™ï¼šprocess å¯ä»¥ let it crashï¼Œä½†é”™è¯¯ä»£ç ä¸è¯¥å¯¼è‡´ VM å´©æºƒã€‚</li>
<li>æ­¤åˆ»ï¼Œä½ å°±å¯ä»¥æŠŠ Rust ä»£ç æ•´ä¸ªå°è£…åœ¨ catch_unwind() å‡½æ•°æ‰€éœ€è¦ä¼ å…¥çš„é—­åŒ…ä¸­ã€‚è¿™æ ·ï¼Œä¸€æ—¦ä»»ä½•ä»£ç ä¸­ï¼ŒåŒ…æ‹¬ç¬¬ä¸‰æ–¹ crates çš„ä»£ç ï¼Œå«æœ‰èƒ½å¤Ÿå¯¼è‡´ panic! çš„ä»£ç ï¼Œéƒ½ä¼šè¢«æ•è·ï¼Œå¹¶è¢«è½¬æ¢ä¸ºä¸€ä¸ª Resultã€‚</li>
</ol>
</div>
</details>
<h3 id="error-trait-å’Œé”™è¯¯ç±»å‹çš„è½¬æ¢"><a class="header" href="#error-trait-å’Œé”™è¯¯ç±»å‹çš„è½¬æ¢">Error trait å’Œé”™è¯¯ç±»å‹çš„è½¬æ¢</a></h3>
<details id="admonition-ä½¿ç”¨error-traitè‡ªå®šä¹‰é”™è¯¯ç±»å‹" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨Error traitè‡ªå®šä¹‰é”™è¯¯ç±»å‹</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä½¿ç”¨error-traitè‡ªå®šä¹‰é”™è¯¯ç±»å‹"></a></p>
</summary>
<div>
<p>ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬è®²åˆ° Result&lt;T, E&gt; é‡Œ E æ˜¯ä¸€ä¸ªä»£è¡¨é”™è¯¯çš„æ•°æ®ç±»å‹ã€‚ä¸ºäº†è§„èŒƒè¿™ä¸ªä»£è¡¨é”™è¯¯çš„æ•°æ®ç±»å‹çš„è¡Œä¸ºï¼ŒRust å®šä¹‰äº† Error traitï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Error: Debug + Display {
    fn source(&amp;self) -&gt; Option&lt;&amp;(dyn Error + 'static)&gt; { ... }
    fn backtrace(&amp;self) -&gt; Option&lt;&amp;Backtrace&gt; { ... }
    fn description(&amp;self) -&gt; &amp;str { ... }
    fn cause(&amp;self) -&gt; Option&lt;&amp;dyn Error&gt; { ... }
}
</code></pre></pre>
<p>æˆ‘ä»¬å¯ä»¥å®šä¹‰æˆ‘ä»¬è‡ªå·±çš„æ•°æ®ç±»å‹ï¼Œç„¶åä¸ºå…¶å®ç° Error traitã€‚</p>
</div>
</details>
<details id="admonition-ä½¿ç”¨thiserrorå’Œanyhowç®€åŒ–æ­¥éª¤" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨thiserrorå’Œanyhowç®€åŒ–æ­¥éª¤</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä½¿ç”¨thiserrorå’Œanyhowç®€åŒ–æ­¥éª¤"></a></p>
</summary>
<div>
<p>ä¸è¿‡ï¼Œè¿™æ ·çš„å·¥ä½œå·²ç»æœ‰äººæ›¿æˆ‘ä»¬ç®€åŒ–äº†ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ thiserrorå’Œ anyhowæ¥ç®€åŒ–è¿™ä¸ªæ­¥éª¤ã€‚</p>
<ul>
<li>thiserror æä¾›äº†ä¸€ä¸ªæ´¾ç”Ÿå®ï¼ˆderive macroï¼‰æ¥ç®€åŒ–é”™è¯¯ç±»å‹çš„å®šä¹‰ï¼Œæ¯”å¦‚ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
use thiserror::Error;
#[derive(Error, Debug)]
#[non_exhaustive]
pub enum DataStoreError {
    #[error(&quot;data store disconnected&quot;)]
    Disconnect(#[from] io::Error),
    #[error(&quot;the data for key `{0}` is not available&quot;)]
    Redaction(String),
    #[error(&quot;invalid header (expected {expected:?}, found {found:?})&quot;)]
    InvalidHeader {
        expected: String,
        found: String,
    },
    #[error(&quot;unknown data store error&quot;)]
    Unknown,
}
</code></pre></pre>
<p>å¦‚æœä½ åœ¨æ’°å†™ä¸€ä¸ª Rust åº“ï¼Œé‚£ä¹ˆ thiserror å¯ä»¥å¾ˆå¥½åœ°ååŠ©ä½ å¯¹è¿™ä¸ªåº“é‡Œæ‰€æœ‰å¯èƒ½å‘ç”Ÿçš„é”™è¯¯è¿›è¡Œå»ºæ¨¡ã€‚</p>
<ul>
<li>anyhow å®ç°äº† anyhow::Error å’Œä»»æ„ç¬¦åˆ Error trait çš„é”™è¯¯ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œè®©ä½ å¯ä»¥ä½¿ç”¨ ? æ“ä½œç¬¦ï¼Œä¸å¿…å†æ‰‹å·¥è½¬æ¢é”™è¯¯ç±»å‹ã€‚</li>
</ul>
<blockquote>
<p>anyhow è¿˜å¯ä»¥è®©ä½ å¾ˆå®¹æ˜“åœ°æŠ›å‡ºä¸€äº›ä¸´æ—¶çš„é”™è¯¯ï¼Œè€Œä¸å¿…è´¹åŠ›å®šä¹‰é”™è¯¯ç±»å‹ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬ä¸æå€¡æ»¥ç”¨è¿™ä¸ªèƒ½åŠ›ã€‚</p>
</blockquote>
<p>ä½œä¸ºä¸€åä¸¥è‚ƒçš„å¼€å‘è€…ï¼Œæˆ‘éå¸¸å»ºè®®ä½ åœ¨å¼€å‘å‰ï¼Œå…ˆç”¨ç±»ä¼¼ thiserror çš„åº“å®šä¹‰å¥½ä½ é¡¹ç›®ä¸­ä¸»è¦çš„é”™è¯¯ç±»å‹ï¼Œå¹¶éšç€é¡¹ç›®çš„æ·±å…¥ï¼Œä¸æ–­å¢åŠ æ–°çš„é”™è¯¯ç±»å‹ï¼Œè®©ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ½œåœ¨é”™è¯¯éƒ½æ— æ‰€éå½¢ã€‚</p>
</div>
</details>
<h1 id="å››é—­åŒ…ç»“æ„"><a class="header" href="#å››é—­åŒ…ç»“æ„">å››ã€é—­åŒ…ç»“æ„</a></h1>
<h2 id="é—­åŒ…çš„å®šä¹‰"><a class="header" href="#é—­åŒ…çš„å®šä¹‰">é—­åŒ…çš„å®šä¹‰</a></h2>
<details id="admonition-é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µ" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µ"></a></p>
</summary>
<div>
<p>é—­åŒ…çš„åŸºæœ¬æ¦‚å¿µï¼š</p>
<ul>
<li>é—­åŒ…æ˜¯å°†å‡½æ•°ï¼Œæˆ–è€…è¯´ä»£ç å’Œå…¶ç¯å¢ƒä¸€èµ·å­˜å‚¨çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚</li>
<li>é—­åŒ…å¼•ç”¨çš„ä¸Šä¸‹æ–‡ä¸­çš„è‡ªç”±å˜é‡ï¼Œä¼šè¢«æ•è·åˆ°é—­åŒ…çš„ç»“æ„ä¸­ï¼Œæˆä¸ºé—­åŒ…ç±»å‹çš„ä¸€éƒ¨åˆ†</li>
<li>é—­åŒ…ä¼šæ ¹æ®å†…éƒ¨çš„ä½¿ç”¨æƒ…å†µï¼Œæ•è·ç¯å¢ƒä¸­çš„è‡ªç”±å˜é‡ã€‚</li>
</ul>
</div>
</details>
<details id="admonition-rustä¸­é—­åŒ…æ•è·è‡ªç”±å˜é‡çš„ä¸¤ä¸ªæ–¹æ³•" class="admonition info">
<summary class="admonition-title">
<p>Rustä¸­é—­åŒ…æ•è·è‡ªç”±å˜é‡çš„ä¸¤ä¸ªæ–¹æ³•</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-rustä¸­é—­åŒ…æ•è·è‡ªç”±å˜é‡çš„ä¸¤ä¸ªæ–¹æ³•"></a></p>
</summary>
<div>
<blockquote>
<p>åœ¨ Rust é‡Œï¼Œé—­åŒ…å¯ä»¥ç”¨ |args| {code} æ¥è¡¨è¿°ï¼Œå›¾ä¸­é—­åŒ… c æ•è·äº†ä¸Šä¸‹æ–‡ä¸­çš„ a å’Œ bï¼Œå¹¶é€šè¿‡å¼•ç”¨æ¥ä½¿ç”¨è¿™ä¸¤ä¸ªè‡ªç”±å˜é‡ï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F-4897625.jpg" alt="19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ" /></p>
<blockquote>
<p>é™¤äº†ç”¨å¼•ç”¨æ¥æ•è·è‡ªç”±å˜é‡ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨ move å…³é”®å­— move |args| {code} ã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-threadspawnçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ä½¿ç”¨moveå…³é”®å­—" class="admonition info">
<summary class="admonition-title">
<p>thread::spawnçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œä½¿ç”¨moveå…³é”®å­—</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-threadspawnçš„å‚æ•°æ˜¯ä¸€ä¸ªé—­åŒ…ä½¿ç”¨moveå…³é”®å­—"></a></p>
</summary>
<div>
<p>æ¯”å¦‚åˆ›å»ºæ–°çº¿ç¨‹çš„ thread::spawnï¼Œå®ƒçš„å‚æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt; 
where
    F: FnOnce() -&gt; T,
    F: Send + 'static,
    T: Send + 'static,
</code></pre></pre>
<blockquote>
<p>ä»”ç»†çœ‹è¿™ä¸ªæ¥å£ï¼š</p>
</blockquote>
<ol>
<li>F: FnOnce() â†’ Tï¼Œè¡¨æ˜ F æ˜¯ä¸€ä¸ªæ¥å— 0 ä¸ªå‚æ•°ã€è¿”å› T çš„é—­åŒ…ã€‚FnOnce æˆ‘ä»¬ç¨åå†è¯´ã€‚</li>
<li>F: Send + â€™staticï¼Œè¯´æ˜é—­åŒ… F è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Œå¹¶ä¸”å®ƒè¿˜èƒ½è¢«å‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚a</li>
<li>T: Send + â€™staticï¼Œè¯´æ˜é—­åŒ… F è¿”å›çš„æ•°æ®ç»“æ„ Tï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Œå¹¶ä¸”å®ƒè¿˜èƒ½è¢«å‘é€ç»™å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</li>
</ol>
<blockquote>
<p>1 å’Œ 3 éƒ½å¾ˆå¥½ç†è§£ï¼Œ2 å°±æœ‰äº›è´¹è§£äº†ã€‚ä¸€ä¸ªé—­åŒ…ï¼Œå®ƒä¸å°±æ˜¯ä¸€æ®µä»£ç  + è¢«æ•è·çš„å˜é‡ä¹ˆï¼Ÿéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p>
</blockquote>
<p>æ‹†å¼€çœ‹:</p>
<ul>
<li>ä»£ç è‡ªç„¶æ˜¯é™æ€ç”Ÿå‘½å‘¨æœŸ</li>
<li>é‚£ä¹ˆæ˜¯ä¸æ˜¯æ„å‘³ç€è¢«æ•è·çš„å˜é‡ï¼Œéœ€è¦é™æ€ç”Ÿå‘½å‘¨æœŸæˆ–è€…æ‹¥æœ‰æ‰€æœ‰æƒï¼Ÿ</li>
</ul>
<blockquote>
<p>çš„ç¡®å¦‚æ­¤ã€‚åœ¨ä½¿ç”¨ thread::spawn æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ move å…³é”®å­—ï¼ŒæŠŠå˜é‡çš„æ‰€æœ‰æƒä»å½“å‰ä½œç”¨åŸŸç§»åŠ¨åˆ°é—­åŒ…çš„ä½œç”¨åŸŸï¼Œè®© thread::spawn å¯ä»¥æ­£å¸¸ç¼–è¯‘é€šè¿‡ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::thread;

fn main() {
    let s = String::from(&quot;hello world&quot;);

    let handle = thread::spawn(move || {
        println!(&quot;moved: {:?}&quot;, s);
    });

    handle.join().unwrap();
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>ä½†ä½ æœ‰æ²¡æœ‰å¥½å¥‡è¿‡ï¼ŒåŠ  move å’Œä¸åŠ  moveï¼Œè¿™ä¸¤ç§é—­åŒ…æœ‰ä»€ä¹ˆæœ¬è´¨ä¸Šçš„ä¸åŒï¼Ÿé—­åŒ…ç©¶ç«Ÿæ˜¯ä¸€ç§ä»€ä¹ˆæ ·çš„æ•°æ®ç±»å‹ï¼Œè®©ç¼–è¯‘å™¨å¯ä»¥åˆ¤æ–­å®ƒæ˜¯å¦æ»¡è¶³ Send + â€™static å‘¢ï¼Ÿæˆ‘ä»¬ä»é—­åŒ…çš„æœ¬è´¨ä¸‹æ‰‹æ¥å°è¯•å›ç­”è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p>
</blockquote>
<h2 id="é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆ"><a class="header" href="#é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆ">é—­åŒ…æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆï¼Ÿ</a></h2>
<details id="admonition-é—­åŒ…çš„æœ¬è´¨æ˜¯åŒ¿åç»“æ„ä½“moveä¼šè½¬ç§»è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒ" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…çš„æœ¬è´¨æ˜¯åŒ¿åç»“æ„ä½“ï¼Œmoveä¼šè½¬ç§»è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-é—­åŒ…çš„æœ¬è´¨æ˜¯åŒ¿åç»“æ„ä½“moveä¼šè½¬ç§»è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒ"></a></p>
</summary>
<div>
<p>åœ¨å®˜æ–¹çš„ Rust reference ä¸­ï¼Œæœ‰è¿™æ ·çš„å®šä¹‰ï¼š</p>
<blockquote>
<p>A closure expression produces a closure value with a unique, anonymous type that cannot be written out. A closure type is approximately equivalent to a struct which contains the captured variables.</p>
</blockquote>
<hr />
<p>é—­åŒ…æ˜¯ä¸€ç§åŒ¿åç±»å‹ï¼Œä¸€æ—¦å£°æ˜ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œä½†è¿™ä¸ªç±»å‹æ— æ³•è¢«å…¶å®ƒåœ°æ–¹ä½¿ç”¨ã€‚è¿™ä¸ªç±»å‹å°±åƒä¸€ä¸ªç»“æ„ä½“ï¼Œä¼šåŒ…å«æ‰€æœ‰æ•è·çš„å˜é‡ã€‚</p>
<p>æ‰€ä»¥é—­åŒ…ç±»ä¼¼ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ä½“ï¼Ÿ</p>
<p>ä¸ºäº†ææ˜ç™½è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¾—å†™æ®µä»£ç æ¢ç´¢ä¸€ä¸‹ï¼Œå»ºè®®ä½ è·Ÿç€æ•²ä¸€éè®¤çœŸæ€è€ƒï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{collections::HashMap, mem::size_of_val};
fn main() {
    // é•¿åº¦ä¸º 0
    let c1 = || println!(&quot;hello world!&quot;);
    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
    let c2 = |i: i32| println!(&quot;hello: {}&quot;, i);
    let name = String::from(&quot;tyr&quot;);
    let name1 = name.clone();
    let mut table = HashMap::new();
    table.insert(&quot;hello&quot;, &quot;world&quot;);
    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
    let c3 = || println!(&quot;hello: {}&quot;, name);
    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
    let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
    let name2 = name.clone();
    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
    let c5 = move || {
        let x = 1;
        let name3 = String::from(&quot;lindsey&quot;);
        println!(&quot;hello: {}, {:?}, {:?}&quot;, x, name2, name3);
    };

    println!(
        &quot;c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}&quot;,
        size_of_val(&amp;c1),
        size_of_val(&amp;c2),
        size_of_val(&amp;c3),
        size_of_val(&amp;c4),
        size_of_val(&amp;c5),
        size_of_val(&amp;main),
    )
}
</code></pre></pre>
<blockquote>
<p>åˆ†åˆ«ç”Ÿæˆäº† 5 ä¸ªé—­åŒ…ï¼š</p>
</blockquote>
<ol>
<li>c1 æ²¡æœ‰å‚æ•°ï¼Œä¹Ÿæ²¡æ•è·ä»»ä½•å˜é‡ï¼Œä»ä»£ç è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œc1 é•¿åº¦ä¸º 0ï¼›</li>
<li>c2 æœ‰ä¸€ä¸ª i32 ä½œä¸ºå‚æ•°ï¼Œæ²¡æœ‰æ•è·ä»»ä½•å˜é‡ï¼Œé•¿åº¦ä¹Ÿä¸º 0ï¼Œå¯ä»¥çœ‹å‡ºå‚æ•°è·Ÿé—­åŒ…çš„å¤§å°æ— å…³ï¼›</li>
<li>c3 æ•è·äº†ä¸€ä¸ªå¯¹å˜é‡ name çš„å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æ˜¯ &amp;Stringï¼Œé•¿åº¦ä¸º 8ã€‚è€Œ c3 çš„é•¿åº¦ä¹Ÿæ˜¯ 8ï¼›</li>
<li>c4 æ•è·äº†å˜é‡ name1 å’Œ tableï¼Œç”±äºç”¨äº† moveï¼Œå®ƒä»¬çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°äº† c4 ä¸­ã€‚c4 é•¿åº¦æ˜¯ 72ï¼Œæ°å¥½ç­‰äº String çš„ 24 å­—èŠ‚ï¼ŒåŠ ä¸Š HashMap çš„ 48 å­—èŠ‚ã€‚</li>
<li>c5 æ•è·äº† name2ï¼Œname2 çš„æ‰€æœ‰æƒç§»åŠ¨åˆ°äº† c5ï¼Œè™½ç„¶ c5 æœ‰å±€éƒ¨å˜é‡ï¼Œä½†å®ƒçš„å¤§å°å’Œå±€éƒ¨å˜é‡ä¹Ÿæ— å…³ï¼Œc5 çš„å¤§å°ç­‰äº String çš„ 24 å­—èŠ‚ã€‚</li>
</ol>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸å¸¦ move æ—¶ï¼Œé—­åŒ…æ•è·çš„æ˜¯å¯¹åº”è‡ªç”±å˜é‡çš„å¼•ç”¨ï¼›å¸¦ move æ—¶ï¼Œå¯¹åº”è‡ªç”±å˜é‡çš„æ‰€æœ‰æƒä¼šè¢«ç§»åŠ¨åˆ°é—­åŒ…ç»“æ„ä¸­ã€‚</p>
</blockquote>
</div>
</details>
<p>ç»§ç»­åˆ†æè¿™æ®µä»£ç çš„è¿è¡Œç»“æœã€‚</p>
<details id="admonition-é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-é—­åŒ…å¤§å°åªè·Ÿæ•è·çš„å˜é‡æœ‰å…³"></a></p>
</summary>
<div>
<p>è¿˜çŸ¥é“äº†ï¼Œé—­åŒ…çš„å¤§å°è·Ÿå‚æ•°ã€å±€éƒ¨å˜é‡éƒ½æ— å…³ï¼Œåªè·Ÿæ•è·çš„å˜é‡æœ‰å…³:</p>
<blockquote>
<p>å› ä¸ºå®ƒä»¬æ˜¯åœ¨è°ƒç”¨çš„æ—¶åˆ»æ‰åœ¨æ ˆä¸Šäº§ç”Ÿçš„å†…å­˜åˆ†é…ï¼Œè¯´åˆ°åº•å’Œé—­åŒ…ç±»å‹æœ¬èº«æ˜¯æ— å…³çš„ï¼Œæ‰€ä»¥é—­åŒ…çš„å¤§å°è·Ÿå®ƒä»¬è‡ªç„¶æ— å…³ã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{collections::HashMap, mem::size_of_val};
fn main() {
    // é•¿åº¦ä¸º 0
    let c1 = || println!(&quot;hello world!&quot;);
    // å’Œå‚æ•°æ— å…³ï¼Œé•¿åº¦ä¹Ÿä¸º 0
    let c2 = |i: i32| println!(&quot;hello: {}&quot;, i);
    let name = String::from(&quot;tyr&quot;);
    let name1 = name.clone();
    let mut table = HashMap::new();
    table.insert(&quot;hello&quot;, &quot;world&quot;);
    // å¦‚æœæ•è·ä¸€ä¸ªå¼•ç”¨ï¼Œé•¿åº¦ä¸º 8
    let c3 = || println!(&quot;hello: {}&quot;, name);
    // æ•è·ç§»åŠ¨çš„æ•°æ® name1(é•¿åº¦ 24) + table(é•¿åº¦ 48)ï¼Œclosure é•¿åº¦ 72
    let c4 = move || println!(&quot;hello: {}, {:?}&quot;, name1, table);
    let name2 = name.clone();
    // å’Œå±€éƒ¨å˜é‡æ— å…³ï¼Œæ•è·äº†ä¸€ä¸ª String name2ï¼Œclosure é•¿åº¦ 24
    let c5 = move || {
        let x = 1;
        let name3 = String::from(&quot;lindsey&quot;);
        println!(&quot;hello: {}, {:?}, {:?}&quot;, x, name2, name3);
    };

    println!(
        &quot;c1: {}, c2: {}, c3: {}, c4: {}, c5: {}, main: {}&quot;,
        size_of_val(&amp;c1),
        size_of_val(&amp;c2),
        size_of_val(&amp;c3),
        size_of_val(&amp;c4),
        size_of_val(&amp;c5),
        size_of_val(&amp;main),
    )
}
</code></pre></pre>
</div>
</details>
<details id="admonition-é—­åŒ…çš„å†…å­˜å¸ƒå±€ä¸ç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«" class="admonition info">
<summary class="admonition-title">
<p>é—­åŒ…çš„å†…å­˜å¸ƒå±€ä¸ç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-é—­åŒ…çš„å†…å­˜å¸ƒå±€ä¸ç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«"></a></p>
</summary>
<div>
<p>é‚£ä¸€ä¸ªé—­åŒ…ç±»å‹åœ¨å†…å­˜ä¸­ç©¶ç«Ÿæ˜¯å¦‚ä½•æ’å¸ƒçš„ï¼Œå’Œç»“æ„ä½“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<blockquote>
<p>æˆ‘ä»¬è¦å†æ¬¡ç»“åˆ rust-gdb æ¢ç´¢ï¼Œçœ‹çœ‹ä¸Šé¢çš„ä»£ç åœ¨è¿è¡Œç»“æŸå‰ï¼Œå‡ ä¸ªé•¿åº¦ä¸ä¸º 0 é—­åŒ…å†…å­˜é‡Œéƒ½æ”¾äº†ä»€ä¹ˆï¼š</p>
</blockquote>
<h2 id="-11"><a class="header" href="#-11"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F-4897598.png" alt="19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ" /></a></h2>
<p>å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>c3 çš„ç¡®æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼ŒæŠŠå®ƒæŒ‡å‘çš„å†…å­˜åœ°å€çš„ 24 ä¸ªå­—èŠ‚æ‰“å‡ºæ¥ï¼Œæ˜¯ (ptr | cap | len) çš„æ ‡å‡†ç»“æ„ã€‚å¦‚æœæ‰“å° ptr å¯¹åº”çš„å †å†…å­˜çš„ 3 ä¸ªå­—èŠ‚ï¼Œæ˜¯ â€˜tâ€™ â€˜yâ€™ â€˜râ€™ã€‚</li>
<li>è€Œ c4 æ•è·çš„ name å’Œ tableï¼Œå†…å­˜ç»“æ„å’Œä¸‹é¢çš„ç»“æ„ä½“ä¸€æ¨¡ä¸€æ ·ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
struct Closure4 {
    name: String,  // (ptr|cap|len)=24å­—èŠ‚
    table: HashMap&lt;&amp;str, &amp;str&gt; // (RandomState(16)|mask|ctrl|left|len)=48å­—èŠ‚
}
</code></pre></pre>
<p>ä¸è¿‡ï¼Œå¯¹äº closure ç±»å‹æ¥è¯´ï¼Œç¼–è¯‘å™¨çŸ¥é“åƒå‡½æ•°ä¸€æ ·è°ƒç”¨é—­åŒ… c4() æ˜¯åˆæ³•çš„ï¼Œå¹¶ä¸”çŸ¥é“æ‰§è¡Œ c4() æ—¶ï¼Œä»£ç åº”è¯¥è·³è½¬åˆ°ä»€ä¹ˆåœ°å€æ¥æ‰§è¡Œã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ° nameã€tableï¼Œå¯ä»¥ä»è‡ªå·±çš„æ•°æ®ç»“æ„ä¸­è·å–ã€‚</p>
<p>é‚£ä¹ˆå¤šæƒ³ä¸€æ­¥ï¼Œé—­åŒ…æ•è·å˜é‡çš„é¡ºåºï¼Œå’Œå…¶å†…å­˜ç»“æ„çš„é¡ºåºæ˜¯ä¸€è‡´çš„ä¹ˆï¼Ÿ</p>
<p>çš„ç¡®å¦‚æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è°ƒæ•´é—­åŒ…é‡Œä½¿ç”¨ name1 å’Œ table çš„é¡ºåºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let c4 = move || println!(&quot;hello: {:?}, {}&quot;, table, name1);
</code></pre></pre>
<p>å…¶æ•°æ®çš„ä½ç½®æ˜¯ç›¸åçš„ï¼Œç±»ä¼¼äºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Closure4 {
    table: HashMap&lt;&amp;str, &amp;str&gt; // (RandomState(16)|mask|ctrl|left|len)=48å­—èŠ‚
    name: String,  // (ptr|cap|len)=24å­—èŠ‚
}
</code></pre></pre>
<p>ä» gdb ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°åŒæ ·çš„ç»“æœï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F.png" alt="19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ" /></p>
<blockquote>
<p>ä¸è¿‡è¿™åªæ˜¯é€»è¾‘ä¸Šçš„ä½ç½®ï¼ŒRust ç¼–è¯‘å™¨ä¼šé‡æ’å†…å­˜ï¼Œè®©æ•°æ®èƒ½å¤Ÿä»¥æœ€å°çš„ä»£ä»·å¯¹é½ï¼Œæ‰€ä»¥æœ‰äº›æƒ…å†µä¸‹ï¼Œå†…å­˜ä¸­æ•°æ®çš„é¡ºåºå¯èƒ½å’Œ struct å®šä¹‰ä¸ä¸€è‡´ã€‚</p>
</blockquote>
<p>æ‰€ä»¥å›åˆ°åˆšæ‰é—­åŒ…å’Œç»“æ„ä½“çš„æ¯”è¾ƒã€‚</p>
<p>åœ¨ Rust é‡Œï¼Œé—­åŒ…äº§ç”Ÿçš„åŒ¿åæ•°æ®ç±»å‹ï¼Œæ ¼å¼å’Œ struct æ˜¯ä¸€æ ·çš„ã€‚çœ‹å›¾ä¸­ gdb çš„è¾“å‡ºï¼Œé—­åŒ…æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå¹¶ä¸”é™¤äº†æ•è·çš„æ•°æ®å¤–ï¼Œé—­åŒ…æœ¬èº«ä¸åŒ…å«ä»»ä½•é¢å¤–å‡½æ•°æŒ‡é’ˆæŒ‡å‘é—­åŒ…çš„ä»£ç ã€‚å¦‚æœä½ ç†è§£äº† c3 / c4 è¿™ä¸¤ä¸ªé—­åŒ…ï¼Œc5 æ˜¯å¦‚ä½•æ„é€ çš„å°±å¾ˆå¥½ç†è§£äº†ã€‚</p>
<p>ç°åœ¨ï¼Œä½ æ˜¯ä¸æ˜¯å¯ä»¥å›ç­”ä¸ºä»€ä¹ˆ thread::spawn å¯¹ä¼ å…¥çš„é—­åŒ…çº¦æŸæ˜¯ Send + â€™static äº†ï¼Ÿç©¶ç«Ÿä»€ä¹ˆæ ·çš„é—­åŒ…æ»¡è¶³å®ƒå‘¢ï¼Ÿ</p>
<blockquote>
<p>å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨äº† move ä¸” move åˆ°é—­åŒ…å†…çš„æ•°æ®ç»“æ„æ»¡è¶³ Sendï¼Œå› ä¸ºæ­¤æ—¶ï¼Œé—­åŒ…çš„æ•°æ®ç»“æ„æ‹¥æœ‰æ‰€æœ‰æ•°æ®çš„æ‰€æœ‰æƒï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ â€™staticã€‚</p>
</blockquote>
</div>
</details>
<p>çœ‹å®Œ Rust é—­åŒ…çš„å†…å­˜ç»“æ„ï¼Œä½ æ˜¯ä¸æ˜¯æƒ³è¯´â€œå°±è¿™â€ï¼Œæ²¡å•¥ç‹¬ç‰¹ä¹‹å¤„å§ï¼Ÿä½†æ˜¯å¯¹æ¯”å…¶ä»–è¯­è¨€ï¼Œç»“åˆæ¥ä¸‹æ¥æˆ‘çš„è§£é‡Šï¼Œä½ å†ä»”ç»†æƒ³æƒ³å°±ä¼šæœ‰ä¸€ç§â€œè¿™æ€ä¹ˆå¯èƒ½â€çš„æƒŠè®¶ã€‚</p>
<h2 id="ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡"><a class="header" href="#ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡">ä¸åŒè¯­è¨€çš„é—­åŒ…è®¾è®¡</a></h2>
<details id="admonition-å…¶ä»–è¯­è¨€é—­åŒ…è®¾è®¡æœ‰ä»€ä¹ˆé—®é¢˜ä¸ºä½•rustå¯ä»¥ä¿è¯é—­åŒ…çš„æ€§èƒ½ä¸å‡½æ•°å·®ä¸å¤š" class="admonition info">
<summary class="admonition-title">
<p>å…¶ä»–è¯­è¨€é—­åŒ…è®¾è®¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿä¸ºä½•Rustå¯ä»¥ä¿è¯é—­åŒ…çš„æ€§èƒ½ä¸å‡½æ•°å·®ä¸å¤š</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-å…¶ä»–è¯­è¨€é—­åŒ…è®¾è®¡æœ‰ä»€ä¹ˆé—®é¢˜ä¸ºä½•rustå¯ä»¥ä¿è¯é—­åŒ…çš„æ€§èƒ½ä¸å‡½æ•°å·®ä¸å¤š"></a></p>
</summary>
<div>
<p>é—­åŒ…æœ€å¤§çš„é—®é¢˜æ˜¯å˜é‡çš„å¤šé‡å¼•ç”¨å¯¼è‡´ç”Ÿå‘½å‘¨æœŸä¸æ˜ç¡®ï¼Œæ‰€ä»¥ä½ å…ˆæƒ³ï¼Œå…¶å®ƒæ”¯æŒé—­åŒ…çš„è¯­è¨€ï¼ˆlambda ä¹Ÿæ˜¯é—­åŒ…ï¼‰ï¼Œå®ƒä»¬çš„é—­åŒ…ä¼šæ”¾åœ¨å“ªé‡Œï¼Ÿ</p>
<p>æ ˆä¸Šä¹ˆï¼Ÿæ˜¯ï¼Œåˆå¥½åƒä¸æ˜¯ã€‚</p>
<p>å› ä¸ºé—­åŒ…è¿™ç©æ„ï¼Œä»å½“å‰ä¸Šä¸‹æ–‡ä¸­æ•è·äº†äº›å˜é‡ï¼Œå˜å¾—æœ‰ç‚¹ä¸ä¼¦ä¸ç±»ï¼Œä¸åƒå‡½æ•°é‚£æ ·æ¸…æ¥šï¼Œå°¤å…¶æ˜¯è¿™äº›è¢«æ•è·çš„å˜é‡ï¼Œå®ƒä»¬çš„å½’å±å’Œç”Ÿå‘½å‘¨æœŸå¤„ç†èµ·æ¥å¾ˆéº»çƒ¦ã€‚æ‰€ä»¥ï¼Œå¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€çš„é—­åŒ…å¾ˆå¤šæ—¶å€™æ— æ³•æ”¾åœ¨æ ˆä¸Šï¼Œéœ€è¦é¢å¤–çš„å †åˆ†é…ã€‚<a href="https://github.com/golang/go/issues/43210">ä½ å¯ä»¥çœ‹è¿™ä¸ª Golang çš„ä¾‹å­</a>ã€‚</p>
<p>ä¸å…‰ Golangï¼ŒJava / Swift / Python / JavaScript ç­‰è¯­è¨€éƒ½æ˜¯å¦‚æ­¤ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€é—­åŒ…çš„æ€§èƒ½è¦è¿œä½äºå‡½æ•°è°ƒç”¨ã€‚</p>
<p>å› ä¸ºä½¿ç”¨é—­åŒ…å°±æ„å‘³ç€ï¼š</p>
<ol>
<li>é¢å¤–çš„å †å†…å­˜åˆ†é…</li>
<li>æ½œåœ¨çš„åŠ¨æ€åˆ†æ´¾ï¼ˆå¾ˆå¤šè¯­è¨€ä¼šæŠŠé—­åŒ…å¤„ç†æˆå‡½æ•°æŒ‡é’ˆï¼‰</li>
<li>é¢å¤–çš„å†…å­˜å›æ”¶ã€‚</li>
</ol>
<p>åœ¨æ€§èƒ½ä¸Šï¼Œå”¯æœ‰ C++ çš„ lambda å’Œ Rust é—­åŒ…ç±»ä¼¼ï¼Œä¸è¿‡ C++ çš„é—­åŒ…è¿˜æœ‰ä¸€äº›åœºæ™¯ä¼šè§¦å‘å †å†…å­˜åˆ†é…ã€‚</p>
<p>Rust / Swift / Kotlin iterator å‡½æ•°å¼ç¼–ç¨‹çš„æ€§èƒ½æµ‹è¯•ï¼š</p>
<ol>
<li>Kotlin è¿è¡Œè¶…æ—¶</li>
<li>Swift å¾ˆæ…¢</li>
<li>Rust çš„æ€§èƒ½å´å’Œä½¿ç”¨å‘½ä»¤å¼ç¼–ç¨‹çš„ C å‡ ä¹ä¸€æ ·ï¼Œé™¤äº†ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ•ˆæœï¼Œä¹Ÿå› ä¸º Rust é—­åŒ…çš„æ€§èƒ½å’Œå‡½æ•°å·®ä¸å¤šã€‚</li>
</ol>
<blockquote>
<p>ä¸ºä»€ä¹ˆ Rust å¯ä»¥åšåˆ°è¿™æ ·å‘¢ï¼Ÿ</p>
</blockquote>
<p>è¿™åˆè·Ÿ Rust ä»æ ¹æœ¬ä¸Šä½¿ç”¨æ‰€æœ‰æƒå’Œå€Ÿç”¨ï¼Œè§£å†³äº†å†…å­˜å½’å±é—®é¢˜æœ‰å…³ã€‚</p>
<p>åœ¨å…¶ä»–è¯­è¨€ä¸­ï¼Œé—­åŒ…å˜é‡å› ä¸ºå¤šé‡å¼•ç”¨å¯¼è‡´ç”Ÿå‘½å‘¨æœŸä¸æ˜ç¡®ï¼Œä½† Rust ä»ä¸€å¼€å§‹å°±æ¶ˆç­äº†è¿™ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>
<p>å¦‚æœä¸ä½¿ç”¨ move è½¬ç§»æ‰€æœ‰æƒï¼Œé—­åŒ…ä¼šå¼•ç”¨ä¸Šä¸‹æ–‡ä¸­çš„å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å—å€Ÿç”¨è§„åˆ™çš„çº¦æŸï¼Œæ‰€ä»¥åªè¦ç¼–è¯‘é€šè¿‡ï¼Œé‚£ä¹ˆé—­åŒ…å¯¹å˜é‡çš„å¼•ç”¨å°±ä¸ä¼šè¶…è¿‡å˜é‡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ²¡æœ‰å†…å­˜å®‰å…¨é—®é¢˜ã€‚</p>
</li>
<li>
<p>å¦‚æœä½¿ç”¨ move è½¬ç§»æ‰€æœ‰æƒï¼Œä¸Šä¸‹æ–‡ä¸­çš„å˜é‡åœ¨è½¬ç§»åå°±æ— æ³•è®¿é—®ï¼Œé—­åŒ…å®Œå…¨æ¥ç®¡è¿™äº›å˜é‡ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œé—­åŒ…ä¸€è‡´ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šæœ‰å†…å­˜å®‰å…¨é—®é¢˜ã€‚</p>
</li>
<li>
<p>è€Œ Rust ä¸ºæ¯ä¸ªé—­åŒ…ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œåˆä½¿å¾—è°ƒç”¨é—­åŒ…æ—¶å¯ä»¥ç›´æ¥å’Œä»£ç å¯¹åº”ï¼Œçœå»äº†ä½¿ç”¨å‡½æ•°æŒ‡é’ˆå†è½¬ä¸€é“æ‰‹çš„é¢å¤–æ¶ˆè€—ã€‚</p>
</li>
</ul>
<blockquote>
<p>æ‰€ä»¥è¿˜æ˜¯é‚£å¥è¯ï¼Œå½“å›å½’åˆ°æœ€åˆçš„æœ¬åŸï¼Œä½ è§£å†³çš„ä¸æ˜¯å•ä¸ªé—®é¢˜ï¼Œè€Œæ˜¯ç”±æ­¤å¼•å‘çš„æ‰€æœ‰é—®é¢˜ã€‚æˆ‘ä»¬ä¸å¿…ä¸ºå †å†…å­˜ç®¡ç†è®¾è®¡ GCã€ä¸å¿…ä¸ºå…¶å®ƒèµ„æºçš„å›æ”¶æä¾› defer å…³é”®å­—ã€ä¸å¿…ä¸ºå¹¶å‘å®‰å…¨è¿›è¡Œè¯¸å¤šé™åˆ¶ã€ä¹Ÿä¸å¿…ä¸ºé—­åŒ…æŒ–ç©ºå¿ƒæ€æä¼˜åŒ–ã€‚</p>
</blockquote>
</div>
</details>
<h2 id="rust-çš„é—­åŒ…ç±»å‹"><a class="header" href="#rust-çš„é—­åŒ…ç±»å‹">Rust çš„é—­åŒ…ç±»å‹</a></h2>
<p>ç°åœ¨æˆ‘ä»¬ææ˜ç™½äº†é—­åŒ…ç©¶ç«Ÿæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œåœ¨å†…å­˜ä¸­æ€ä¹ˆè¡¨ç¤ºï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ FnOnce / FnMut / Fn è¿™ä¸‰ç§é—­åŒ…ç±»å‹æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p>
<p>åœ¨å£°æ˜é—­åŒ…çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦æŒ‡å®šé—­åŒ…è¦æ»¡è¶³çš„çº¦æŸï¼Œä½†æ˜¯å½“é—­åŒ…ä½œä¸ºå‡½æ•°çš„å‚æ•°æˆ–è€…æ•°æ®ç»“æ„çš„ä¸€ä¸ªåŸŸæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰è°ƒç”¨è€…ï¼Œå¯¹é—­åŒ…çš„çº¦æŸã€‚</p>
<p>è¿˜ä»¥ thread::spawn ä¸ºä¾‹ï¼Œå®ƒè¦æ±‚ä¼ å…¥çš„é—­åŒ…æ»¡è¶³ FnOnce traitã€‚</p>
<h3 id="fnonce"><a class="header" href="#fnonce">FnOnce</a></h3>
<details id="admonition-fnonceå®šä¹‰-ä¾‹å­è§£æ" class="admonition info">
<summary class="admonition-title">
<p>FnOnceå®šä¹‰-&gt;ä¾‹å­è§£æ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-fnonceå®šä¹‰-ä¾‹å­è§£æ"></a></p>
</summary>
<div>
<p>å…ˆæ¥çœ‹ FnOnceã€‚å®ƒçš„<a href="https://doc.rust-lang.org/std/ops/trait.FnOnce.html">å®šä¹‰</a>å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait FnOnce&lt;Args&gt; {
    type Output;
    extern &quot;rust-call&quot; fn call_once(self, args: Args) -&gt; Self::Output;
}
</code></pre></pre>
<ol>
<li>FnOnce æœ‰ä¸€ä¸ªå…³è”ç±»å‹ Outputï¼Œæ˜¾ç„¶ï¼Œå®ƒæ˜¯é—­åŒ…è¿”å›å€¼çš„ç±»å‹ï¼›</li>
<li>è¿˜æœ‰ä¸€ä¸ªæ–¹æ³• call_onceï¼Œè¦æ³¨æ„çš„æ˜¯ call_once ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼Œå®ƒä¼šè½¬ç§» self çš„æ‰€æœ‰æƒåˆ° call_once å‡½æ•°ä¸­ã€‚</li>
</ol>
<blockquote>
<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ FnOnce è¢«ç§°ä½œ Once ï¼šå®ƒåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚å†æ¬¡è°ƒç”¨ï¼Œç¼–è¯‘å™¨å°±ä¼šæŠ¥å˜é‡å·²ç»è¢« move è¿™æ ·çš„å¸¸è§æ‰€æœ‰æƒé”™è¯¯äº†ã€‚</p>
</blockquote>
<p>è‡³äº FnOnce çš„å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå« Args çš„æ³›å‹å‚æ•°ï¼Œå®ƒå¹¶æ²¡æœ‰ä»»ä½•çº¦æŸã€‚</p>
<p>çœ‹ä¸€ä¸ªéšå¼çš„ FnOnce çš„ä¾‹å­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let name = String::from(&quot;Tyr&quot;);
    // è¿™ä¸ªé—­åŒ…å•¥ä¹Ÿä¸å¹²ï¼Œåªæ˜¯æŠŠæ•è·çš„å‚æ•°è¿”å›å»
    let c = move |greeting: String| (greeting, name);

    let result = c(&quot;hello&quot;.to_string());

    println!(&quot;result: {:?}&quot;, result);

    // æ— æ³•å†æ¬¡è°ƒç”¨
    let result = c(&quot;hi&quot;.to_string());
}
</code></pre></pre>
<ol>
<li>è¿™ä¸ªé—­åŒ… cï¼Œå•¥ä¹Ÿæ²¡åšï¼Œåªæ˜¯æŠŠæ•è·çš„å‚æ•°è¿”å›ã€‚</li>
<li>å°±åƒä¸€ä¸ªç»“æ„ä½“é‡Œï¼ŒæŸä¸ªå­—æ®µè¢«è½¬ç§»èµ°ä¹‹åï¼Œå°±ä¸èƒ½å†è®¿é—®ä¸€æ ·ï¼Œé—­åŒ…å†…éƒ¨çš„æ•°æ®ä¸€æ—¦è¢«è½¬ç§»ï¼Œè¿™ä¸ªé—­åŒ…å°±ä¸å®Œæ•´äº†ï¼Œä¹Ÿå°±æ— æ³•å†æ¬¡ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª FnOnce çš„é—­åŒ…ã€‚</li>
</ol>
<p>å¦‚æœä¸€ä¸ªé—­åŒ…å¹¶ä¸è½¬ç§»è‡ªå·±çš„å†…éƒ¨æ•°æ®ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯ FnOnceï¼Œç„¶è€Œï¼Œä¸€æ—¦å®ƒè¢«å½“åš FnOnce è°ƒç”¨ï¼Œè‡ªå·±ä¼šè¢«è½¬ç§»åˆ° call_once å‡½æ•°çš„ä½œç”¨åŸŸä¸­ï¼Œä¹‹åå°±æ— æ³•å†æ¬¡è°ƒç”¨äº†ï¼Œæˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let name = String::from(&quot;Tyr&quot;);

    // è¿™ä¸ªé—­åŒ…ä¼š clone å†…éƒ¨çš„æ•°æ®è¿”å›ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯ FnOnce
    let c = move |greeting: String| (greeting, name.clone());

    // æ‰€ä»¥ c1 å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡

    println!(&quot;c1 call once: {:?}&quot;, c(&quot;qiao&quot;.into()));
    println!(&quot;c1 call twice: {:?}&quot;, c(&quot;bonjour&quot;.into()));

    // ç„¶è€Œä¸€æ—¦å®ƒè¢«å½“æˆ FnOnce è¢«è°ƒç”¨ï¼Œå°±æ— æ³•è¢«å†æ¬¡è°ƒç”¨
    println!(&quot;result: {:?}&quot;, call_once(&quot;hi&quot;.into(), c));

    // æ— æ³•å†æ¬¡è°ƒç”¨
    // let result = c(&quot;hi&quot;.to_string());

    // Fn ä¹Ÿå¯ä»¥è¢«å½“æˆ FnOnce è°ƒç”¨ï¼Œåªè¦æ¥å£ä¸€è‡´å°±å¯ä»¥
    println!(&quot;result: {:?}&quot;, call_once(&quot;hola&quot;.into(), not_closure));
}

fn call_once(arg: String, c: impl FnOnce(String) -&gt; (String, String)) -&gt; (String, String) {
    c(arg)
}

fn not_closure(arg: String) -&gt; (String, String) {
    (arg, &quot;Rosie&quot;.into())
}
</code></pre></pre>
</div>
</details>
<h3 id="æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢"><a class="header" href="#æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢">æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ</a></h3>
<details id="admonition-æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢" class="admonition info">
<summary class="admonition-title">
<p>æ€ä¹ˆç†è§£ FnOnce çš„ Args æ³›å‹å‚æ•°å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ€ä¹ˆç†è§£-fnonce-çš„-args-æ³›å‹å‚æ•°å‘¢"></a></p>
</summary>
<div>
<p>Args åˆæ˜¯æ€ä¹ˆå’Œ FnOnce çš„çº¦æŸï¼Œæ¯”å¦‚ FnOnce(String) è¿™æ ·çš„å‚æ•°åŒ¹é…å‘¢ï¼Ÿæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå®ƒï¼ˆä¸å®Œå…¨ï¼‰æ¨¡æ‹Ÿäº† FnOnce ä¸­é—­åŒ…çš„ä½¿ç”¨ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct ClosureOnce&lt;Captured, Args, Output&gt; {
    // æ•è·çš„æ•°æ®
    captured: Captured,
    // closure çš„æ‰§è¡Œä»£ç 
    func: fn(Args, Captured) -&gt; Output,
}

impl&lt;Captured, Args, Output&gt; ClosureOnce&lt;Captured, Args, Output&gt; {
    // æ¨¡æ‹Ÿ FnOnce çš„ call_onceï¼Œç›´æ¥æ¶ˆè€— self
    fn call_once(self, greeting: Args) -&gt; Output {
        (self.func)(greeting, self.captured)
    }
}

// ç±»ä¼¼ greeting é—­åŒ…çš„å‡½æ•°ä½“
fn greeting_code1(args: (String,), captured: (String,)) -&gt; (String, String) {
    (args.0, captured.0)
}

fn greeting_code2(args: (String, String), captured: (String, u8)) -&gt; (String, String, String, u8) {
    (args.0, args.1, captured.0, captured.1)
}

fn main() {
    let name = &quot;Tyr&quot;.into();
    // æ¨¡æ‹Ÿå˜é‡æ•æ‰
    let c = ClosureOnce {
        captured: (name,),
        func: greeting_code1,
    };

    // æ¨¡æ‹Ÿé—­åŒ…è°ƒç”¨ï¼Œè¿™é‡Œå’Œ FnOnce ä¸å®Œå…¨ä¸€æ ·ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ª tuple æ¥åŒ¹é… Args å‚æ•°
    println!(&quot;{:?}&quot;, c.call_once((&quot;hola&quot;.into(),)));
    // è°ƒç”¨ä¸€æ¬¡åæ— æ³•ç»§ç»­è°ƒç”¨
    // println!(&quot;{:?}&quot;, clo.call_once(&quot;hola&quot;.into()));

    // æ›´å¤æ‚ä¸€äº›çš„å¤æ‚çš„é—­åŒ…
    let c1 = ClosureOnce {
        captured: (&quot;Tyr&quot;.into(), 18),
        func: greeting_code2,
    };

    println!(&quot;{:?}&quot;, c1.call_once((&quot;hola&quot;.into(), &quot;hallo&quot;.into())));
}
</code></pre></pre>
</div>
</details>
<h3 id="fnmut"><a class="header" href="#fnmut">FnMut</a></h3>
<details id="admonition-fnmutçš„å®šä¹‰ä¸ä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>FnMutçš„å®šä¹‰ä¸ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-fnmutçš„å®šä¹‰ä¸ä¾‹å­"></a></p>
</summary>
<div>
<p>ç†è§£äº† FnOnceï¼Œæˆ‘ä»¬å†æ¥çœ‹ FnMutï¼Œ<a href="https://doc.rust-lang.org/std/ops/trait.FnMut.html">å®ƒçš„å®šä¹‰å¦‚ä¸‹</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait FnMut&lt;Args&gt;: FnOnce&lt;Args&gt; {
    extern &quot;rust-call&quot; fn call_mut(
        &amp;mut self, 
        args: Args
    ) -&gt; Self::Output;
}
</code></pre></pre>
<ol>
<li>é¦–å…ˆï¼ŒFnMut â€œç»§æ‰¿â€äº† FnOnceï¼Œæˆ–è€…è¯´ FnOnce æ˜¯ FnMut çš„ super traitã€‚</li>
<li>æ‰€ä»¥ FnMut ä¹Ÿæ‹¥æœ‰ Output è¿™ä¸ªå…³è”ç±»å‹å’Œ call_once è¿™ä¸ªæ–¹æ³•ã€‚</li>
<li>æ­¤å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª call_mut() æ–¹æ³•ã€‚</li>
<li>æ³¨æ„ call_mut() ä¼ å…¥ &amp;mut selfï¼Œå®ƒä¸ç§»åŠ¨ selfï¼Œæ‰€ä»¥ FnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ã€‚</li>
</ol>
<blockquote>
<p>å› ä¸º FnOnce æ˜¯ FnMut çš„ super traitï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ª FnMut é—­åŒ…ï¼Œå¯ä»¥è¢«ä¼ ç»™ä¸€ä¸ªéœ€è¦ FnOnce çš„ä¸Šä¸‹æ–‡ï¼Œæ­¤æ—¶è°ƒç”¨é—­åŒ…ç›¸å½“äºè°ƒç”¨äº† call_once()ã€‚</p>
</blockquote>
<p>å¦‚æœä½ ç†è§£äº†å‰é¢è®²çš„é—­åŒ…çš„å†…å­˜ç»„ç»‡ç»“æ„ï¼Œé‚£ä¹ˆ FnMut å°±ä¸éš¾ç†è§£ï¼Œå°±åƒç»“æ„ä½“å¦‚æœæƒ³æ”¹å˜æ•°æ®éœ€è¦ç”¨ let mut å£°æ˜ä¸€æ ·ï¼Œå¦‚æœä½ æƒ³æ”¹å˜é—­åŒ…æ•è·çš„æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆå°±éœ€è¦ FnMutã€‚</p>
<p>æˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">

fn main() {
    let mut name = String::from(&quot;hello&quot;);
    let mut name1 = String::from(&quot;hola&quot;);

    // æ•è· &amp;mut name
    let mut c = || {
        name.push_str(&quot; Tyr&quot;);
        println!(&quot;c: {}&quot;, name);
    };

    // æ•è· mut name1ï¼Œæ³¨æ„ name1 éœ€è¦å£°æ˜æˆ mut
    let mut c1 = move || {
        name1.push_str(&quot;!&quot;);
        println!(&quot;c1: {}&quot;, name1);
    };

    c();
    c1();

    call_mut(&amp;mut c);
    call_mut(&amp;mut c1);

    call_once(c);
    call_once(c1);
}

// åœ¨ä½œä¸ºå‚æ•°æ—¶ï¼ŒFnMut ä¹Ÿè¦æ˜¾å¼åœ°ä½¿ç”¨ mutï¼Œæˆ–è€… &amp;mut
fn call_mut(c: &amp;mut impl FnMut()) {
    c();
}

// æƒ³æƒ³çœ‹ï¼Œä¸ºå•¥ call_once ä¸éœ€è¦ mutï¼Ÿ
fn call_once(c: impl FnOnce()) {
    c();
}

</code></pre></pre>
<ol>
<li>åœ¨å£°æ˜çš„é—­åŒ… c å’Œ c1 é‡Œï¼Œæˆ‘ä»¬ä¿®æ”¹äº†æ•è·çš„ name å’Œ name1ã€‚</li>
<li>ä¸åŒçš„æ˜¯ name ä½¿ç”¨äº†å¼•ç”¨ï¼Œè€Œ name1 ç§»åŠ¨äº†æ‰€æœ‰æƒï¼Œè¿™ä¸¤ç§æƒ…å†µå’Œå…¶å®ƒä»£ç ä¸€æ ·ï¼Œä¹Ÿéœ€è¦éµå¾ªæ‰€æœ‰æƒå’Œå€Ÿç”¨æœ‰å…³çš„è§„åˆ™ã€‚</li>
<li>æ‰€ä»¥ï¼Œå¦‚æœåœ¨é—­åŒ… c é‡Œå€Ÿç”¨äº† nameï¼Œä½ å°±ä¸èƒ½æŠŠ name ç§»åŠ¨ç»™å¦ä¸€ä¸ªé—­åŒ… c1ã€‚</li>
</ol>
<blockquote>
<p>è¿™é‡Œä¹Ÿå±•ç¤ºäº†ï¼Œc å’Œ c1 è¿™ä¸¤ä¸ªç¬¦åˆ FnMut çš„é—­åŒ…ï¼Œèƒ½ä½œä¸º FnOnce æ¥è°ƒç”¨ã€‚æˆ‘ä»¬åœ¨ä»£ç ä¸­ä¹Ÿç¡®è®¤äº†ï¼ŒFnMut å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸º call_mut() ä½¿ç”¨çš„æ˜¯ &amp;mut selfï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒã€‚</p>
</blockquote>
</div>
</details>
<h3 id="fn"><a class="header" href="#fn">Fn</a></h3>
<details id="admonition-fnçš„å®šä¹‰ä¸ä¾‹å­" class="admonition info">
<summary class="admonition-title">
<p>Fnçš„å®šä¹‰ä¸ä¾‹å­</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-fnçš„å®šä¹‰ä¸ä¾‹å­"></a></p>
</summary>
<div>
<p>æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ Fn traitã€‚<a href="https://doc.rust-lang.org/std/ops/trait.Fn.html">å®ƒçš„å®šä¹‰å¦‚ä¸‹</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Fn&lt;Args&gt;: FnMut&lt;Args&gt; {
    extern &quot;rust-call&quot; fn call(&amp;self, args: Args) -&gt; Self::Output;
}
</code></pre></pre>
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒâ€œç»§æ‰¿â€äº† FnMutï¼Œæˆ–è€…è¯´ FnMut æ˜¯ Fn çš„ super traitã€‚</li>
<li>è¿™ä¹Ÿå°±æ„å‘³ç€ä»»ä½•éœ€è¦ FnOnce æˆ–è€… FnMut çš„åœºåˆï¼Œéƒ½å¯ä»¥ä¼ å…¥æ»¡è¶³ Fn çš„é—­åŒ…ã€‚</li>
</ol>
<p>æˆ‘ä»¬ç»§ç»­çœ‹ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let v = vec![0u8; 1024];
    let v1 = vec![0u8; 1023];

    // Fnï¼Œä¸ç§»åŠ¨æ‰€æœ‰æƒ
    let mut c = |x: u64| v.len() as u64 * x;
    // Fnï¼Œç§»åŠ¨æ‰€æœ‰æƒ
    let mut c1 = move |x: u64| v1.len() as u64 * x;

    println!(&quot;direct call: {}&quot;, c(2));
    println!(&quot;direct call: {}&quot;, c1(2));

    println!(&quot;call: {}&quot;, call(3, &amp;c));
    println!(&quot;call: {}&quot;, call(3, &amp;c1));

    println!(&quot;call_mut: {}&quot;, call_mut(4, &amp;mut c));
    println!(&quot;call_mut: {}&quot;, call_mut(4, &amp;mut c1));

    println!(&quot;call_once: {}&quot;, call_once(5, c));
    println!(&quot;call_once: {}&quot;, call_once(5, c1));
}

fn call(arg: u64, c: &amp;impl Fn(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}

fn call_mut(arg: u64, c: &amp;mut impl FnMut(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}

fn call_once(arg: u64, c: impl FnOnce(u64) -&gt; u64) -&gt; u64 {
    c(arg)
}
</code></pre></pre>
</div>
</details>
<h3 id="æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»"><a class="header" href="#æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»">æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»</a></h3>
<details id="admonition-æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»" class="admonition info">
<summary class="admonition-title">
<p>æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-æ€»ç»“ä¸€ä¸‹ä¸‰ç§é—­åŒ…ä½¿ç”¨çš„æƒ…å†µä»¥åŠå®ƒä»¬ä¹‹é—´çš„å…³ç³»"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/19%EF%BD%9C%E9%97%AD%E5%8C%85%EF%BC%9AFnOnce%E3%80%81FnMut%E5%92%8CFn%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E8%BF%99%E4%B9%88%E5%A4%9A%E7%B1%BB%E5%9E%8B%EF%BC%9F.jpg" alt="19ï½œé—­åŒ…ï¼šFnOnceã€FnMutå’ŒFnï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¹ˆå¤šç±»å‹ï¼Ÿ" /></p>
</div>
</details>
<h2 id="é—­åŒ…çš„ä½¿ç”¨åœºæ™¯"><a class="header" href="#é—­åŒ…çš„ä½¿ç”¨åœºæ™¯">é—­åŒ…çš„ä½¿ç”¨åœºæ™¯</a></h2>
<details id="admonition-åœ¨å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸­ä½¿ç”¨é—­åŒ…" class="admonition info">
<summary class="admonition-title">
<p>åœ¨å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸­ä½¿ç”¨é—­åŒ…</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-åœ¨å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸­ä½¿ç”¨é—­åŒ…"></a></p>
</summary>
<div>
<p>thread::spawn è‡ªä¸å¿…è¯´ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ Iterator trait é‡Œé¢å¤§éƒ¨åˆ†å‡½æ•°éƒ½æ¥å—ä¸€ä¸ªé—­åŒ…ï¼Œ<a href="https://doc.rust-lang.org/src/core/iter/traits/iterator.rs.html#682-685">æ¯”å¦‚ map</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn map&lt;B, F&gt;(self, f: F) -&gt; Map&lt;Self, F&gt;
where
    Self: Sized,
    F: FnMut(Self::Item) -&gt; B,
{
    Map::new(self, f)
}
</code></pre></pre>
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼ŒIterator çš„ map() æ–¹æ³•æ¥å—ä¸€ä¸ª FnMut</li>
<li>å®ƒçš„å‚æ•°æ˜¯ Self::Item</li>
<li>è¿”å›å€¼æ˜¯æ²¡æœ‰çº¦æŸçš„æ³›å‹å‚æ•° Bã€‚</li>
<li>Self::Item æ˜¯ Iterator::next() æ–¹æ³•åå‡ºæ¥çš„æ•°æ®ï¼Œè¢« map ä¹‹åï¼Œå¯ä»¥å¾—åˆ°å¦ä¸€ä¸ªç»“æœã€‚</li>
</ol>
<p>æ‰€ä»¥åœ¨å‡½æ•°çš„å‚æ•°ä¸­ä½¿ç”¨é—­åŒ…ï¼Œæ˜¯é—­åŒ…ä¸€ç§éå¸¸å…¸å‹çš„ç”¨æ³•ã€‚å¦å¤–é—­åŒ…ä¹Ÿå¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::ops::Mul;

fn main() {
    let c1 = curry(5);
    println!(&quot;5 multiply 2 is: {}&quot;, c1(2));

    let adder2 = curry(3.14);
    println!(&quot;pi multiply 4^2 is: {}&quot;, adder2(4. * 4.));
}

fn curry&lt;T&gt;(x: T) -&gt; impl Fn(T) -&gt; T
where
    T: Mul&lt;Output = T&gt; + Copy,
{
    move |y| x * y
}
</code></pre></pre>
</div>
</details>
<details id="admonition-ä¸ºé—­åŒ…å®ç°æŸä¸ª-traitä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨" class="admonition info">
<summary class="admonition-title">
<p>ä¸ºé—­åŒ…å®ç°æŸä¸ª traitï¼Œä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨ã€‚</p>
<p><a class="admonition-anchor-link" href="3_data_structure.html#admonition-ä¸ºé—­åŒ…å®ç°æŸä¸ª-traitä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨"></a></p>
</summary>
<div>
<p>æœ€åï¼Œé—­åŒ…è¿˜æœ‰ä¸€ç§å¹¶ä¸å°‘è§ï¼Œä½†å¯èƒ½ä¸å¤ªå®¹æ˜“ç†è§£çš„ç”¨æ³•ï¼š</p>
<p>ä¸ºå®ƒå®ç°æŸä¸ª traitï¼Œä½¿å…¶ä¹Ÿèƒ½è¡¨ç°å‡ºå…¶ä»–è¡Œä¸ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä½œä¸ºå‡½æ•°è¢«è°ƒç”¨ã€‚</p>
<p>æ¯”å¦‚è¯´æœ‰äº›æ¥å£æ—¢å¯ä»¥ä¼ å…¥ä¸€ä¸ªç»“æ„ä½“ï¼Œåˆå¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°æˆ–è€…é—­åŒ…ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬çœ‹ä¸€ä¸ª <a href="https://github.com/hyperium/tonic">tonicï¼ˆRust ä¸‹çš„ gRPC åº“ï¼‰</a>çš„<a href="https://docs.rs/tonic/0.5.2/src/tonic/service/interceptor.rs.html#41-53">ä¾‹å­</a></p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Interceptor {
    /// Intercept a request before it is sent, optionally cancelling it.
    fn call(&amp;mut self, request: crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt;;
}

impl&lt;F&gt; Interceptor for F
where
    F: FnMut(crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt;,
{
    fn call(&amp;mut self, request: crate::Request&lt;()&gt;) -&gt; Result&lt;crate::Request&lt;()&gt;, Status&gt; {
        self(request)
    }
}
</code></pre></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼ŒInterceptor æœ‰ä¸€ä¸ª call æ–¹æ³•ï¼Œå®ƒå¯ä»¥è®© gRPC Request è¢«å‘é€å‡ºå»ä¹‹å‰è¢«ä¿®æ”¹ï¼Œä¸€èˆ¬æ˜¯æ·»åŠ å„ç§å¤´ï¼Œæ¯”å¦‚ Authorization å¤´ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œä¸ºå®ƒå®ç° Interceptorï¼Œä¸è¿‡å¤§éƒ¨åˆ†æ—¶å€™ Interceptor å¯ä»¥ç›´æ¥é€šè¿‡ä¸€ä¸ªé—­åŒ…å‡½æ•°å®Œæˆã€‚ä¸ºäº†è®©ä¼ å…¥çš„é—­åŒ…ä¹Ÿèƒ½é€šè¿‡ Interceptor::call() æ¥ç»Ÿä¸€è°ƒç”¨ï¼Œå¯ä»¥ä¸ºç¬¦åˆæŸä¸ªæ¥å£çš„é—­åŒ…å®ç° Interceptor traitã€‚æŒæ¡äº†è¿™ç§ç”¨æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŸäº› trait æŠŠç‰¹å®šçš„ç»“æ„ä½“å’Œé—­åŒ…ç»Ÿä¸€èµ·æ¥è°ƒç”¨ï¼Œæ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ã€‚</p>
</div>
</details>
<div style="break-before: page; page-break-before: always;"></div><style>.extended-markdown-table {
    display: grid;
}

.extended-markdown-table > div {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 3px 20px;
    border-bottom: 1px solid var(--table-border-color);
    border-right: 1px solid var(--table-border-color);
}

.extended-markdown-table > div.extended-markdown-left-border {
    border-left: 1px solid var(--table-border-color);
}

.extended-markdown-table > div.extended-markdown-header {
    text-align: center;
    background: var(--table-header-bg);
    border-bottom: 1px solid var(--table-header-bg);
    border-right: 1px solid var(--table-header-bg);
    font-weight: bold;
}

.extended-markdown-table > div.extended-markdown-header.extended-markdown-left-border {
    border-left: 1px solid var(--table-header-bg);
}
</style>
<h1 id="iv-å®ç¼–ç¨‹"><a class="header" href="#iv-å®ç¼–ç¨‹">IV å®ç¼–ç¨‹</a></h1>
<!--ts-->
<ul>
<li><a href="4_macros.html#iv-%E5%AE%8F%E7%BC%96%E7%A8%8B">IV å®ç¼–ç¨‹</a>
<ul>
<li><a href="4_macros.html#%E8%B5%84%E6%96%99">èµ„æ–™</a></li>
<li><a href="4_macros.html#%E5%AE%8F%E7%9A%84%E5%88%86%E7%B1%BB">å®çš„åˆ†ç±»</a>
<ul>
<li><a href="4_macros.html#%E4%BD%BF%E7%94%A8%E6%B3%B3%E9%81%93%E5%9B%BE">ä½¿ç”¨æ³³é“å›¾</a></li>
<li><a href="4_macros.html#%E8%A1%A8%E6%A0%BC">è¡¨æ ¼</a></li>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8F%E7%9A%84%E7%BC%BA%E9%99%B7%E8%80%8C%E5%90%8E%E6%9C%89%E4%BA%86%E8%BF%87%E7%A8%8B%E5%AE%8F">å£°æ˜å®çš„ç¼ºé™·ï¼Œè€Œåæœ‰äº†è¿‡ç¨‹å®</a></li>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8Fdeclarative-macros-macro_rulesbang">å£°æ˜å®(declarative macros): macro_rules!(bang)</a></li>
<li><a href="4_macros.html#%E8%BF%87%E7%A8%8B%E5%AE%8F%E6%B7%B1%E5%BA%A6%E5%AE%9A%E5%88%B6%E4%B8%8E%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81">è¿‡ç¨‹å®ï¼šæ·±åº¦å®šåˆ¶ä¸ç”Ÿæˆä»£ç </a>
<ul>
<li><a href="4_macros.html#%E5%87%BD%E6%95%B0%E5%AE%8F">å‡½æ•°å®</a></li>
<li><a href="4_macros.html#%E5%B1%9E%E6%80%A7%E5%AE%8F">å±æ€§å®</a></li>
<li><a href="4_macros.html#%E6%B4%BE%E7%94%9F%E5%AE%8F">æ´¾ç”Ÿå®</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8F">å£°æ˜å®</a>
<ul>
<li><a href="4_macros.html#rust%E5%B8%B8%E7%94%A8%E5%A3%B0%E6%98%8E%E5%AE%8F">Rustå¸¸ç”¨å£°æ˜å®</a>
<ul>
<li><a href="4_macros.html#println">println!</a></li>
<li><a href="4_macros.html#writeln">writeln!</a></li>
<li><a href="4_macros.html#eprintln">eprintln!</a></li>
</ul>
</li>
<li><a href="4_macros.html#%E7%A4%BA%E4%BE%8B">ç¤ºä¾‹</a>
<ul>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8F%E7%A4%BA%E6%84%8F%E5%9B%BE">å£°æ˜å®ç¤ºæ„å›¾</a></li>
<li><a href="4_macros.html#macro_rules%E5%AE%9A%E4%B9%89">macro_rules!å®šä¹‰</a></li>
<li><a href="4_macros.html#%E4%BD%BF%E7%94%A8">ä½¿ç”¨</a></li>
</ul>
</li>
<li><a href="4_macros.html#%E5%A3%B0%E6%98%8E%E5%AE%8F%E7%94%A8%E5%88%B0%E7%9A%84%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B">å£°æ˜å®ç”¨åˆ°çš„å‚æ•°ç±»å‹</a></li>
</ul>
</li>
<li><a href="4_macros.html#%E8%BF%87%E7%A8%8B%E5%AE%8F%E6%89%8B%E5%B7%A5%E5%AE%9A%E4%B9%89%E5%9B%BE">è¿‡ç¨‹å®æ‰‹å·¥å®šä¹‰å›¾</a>
<ul>
<li><a href="4_macros.html#cargotoml%E6%B7%BB%E5%8A%A0proc-macro%E5%A3%B0%E6%98%8E">Cargo.tomlæ·»åŠ proc-macroå£°æ˜</a></li>
</ul>
</li>
<li>[è¿‡ç¨‹å‡½æ•°å®: #[proc_macro]](#è¿‡ç¨‹å‡½æ•°å®-proc_macro)
<ul>
<li><a href="4_macros.html#srclibrs%E5%AE%9A%E4%B9%89%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0%E5%AE%8F">src/lib.rs:å®šä¹‰è¿‡ç¨‹å‡½æ•°å®</a></li>
<li><a href="4_macros.html#examplesqueryrs%E4%BD%BF%E7%94%A8">examples/query.rs:ä½¿ç”¨</a></li>
</ul>
</li>
<li>[è¿‡ç¨‹æ´¾ç”Ÿå®: /#[proc_macro_devive(DeriveMacroName)]](#è¿‡ç¨‹æ´¾ç”Ÿå®-proc_macro_devivederivemacroname)
<ul>
<li><a href="4_macros.html#%E5%B8%B8%E7%94%A8%E6%B4%BE%E7%94%9F%E5%AE%8F">å¸¸ç”¨æ´¾ç”Ÿå®</a>
<ul>
<li>[#[derive(Debug)]](#derivedebug)</li>
</ul>
</li>
<li><a href="4_macros.html#%E5%8E%9F%E5%A7%8B%E5%AE%9E%E7%8E%B0builder%E6%A8%A1%E5%BC%8F">åŸå§‹å®ç°builderæ¨¡å¼</a>
<ul>
<li><a href="4_macros.html#%E6%83%B3%E5%88%B0%E8%BE%BE%E5%88%B0%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E7%9A%84%E6%95%88%E6%9E%9C">æƒ³åˆ°è¾¾åˆ°é“¾å¼è°ƒç”¨çš„æ•ˆæœ</a></li>
<li><a href="4_macros.html#%E5%8F%AF%E4%BB%A5%E8%BF%99%E6%A0%B7%E5%AE%9A%E4%B9%89">å¯ä»¥è¿™æ ·å®šä¹‰</a></li>
<li><a href="4_macros.html#%E4%BD%86%E6%98%AF%E6%9C%89%E7%82%B9%E7%B9%81%E7%90%90%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E6%B4%BE%E7%94%9F%E5%AE%8F%E6%B4%BE%E7%94%9F%E5%87%BA%E8%BF%99%E4%BA%9B%E4%BB%A3%E7%A0%81">ä½†æ˜¯æœ‰ç‚¹ç¹çï¼Œå¯ä»¥ä½¿ç”¨æ´¾ç”Ÿå®æ´¾ç”Ÿå‡ºè¿™äº›ä»£ç </a></li>
</ul>
</li>
<li><a href="4_macros.html#%E6%B4%BE%E7%94%9F%E5%AE%8F%E6%80%9D%E8%B7%AF">æ´¾ç”Ÿå®æ€è·¯</a>
<ul>
<li><a href="4_macros.html#%E8%A6%81%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81%E6%A8%A1%E7%89%88">è¦ç”Ÿæˆçš„ä»£ç æ¨¡ç‰ˆ</a></li>
<li><a href="4_macros.html#%E6%9E%84%E5%BB%BA%E5%AF%B9%E5%BA%94%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">æ„å»ºå¯¹åº”æ•°æ®ç»“æ„</a></li>
<li><a href="4_macros.html#srclibrs-%E4%BD%BF%E7%94%A8%E6%B4%BE%E7%94%9F%E5%AE%8F%E4%BB%8Etokenstream%E6%8A%BD%E5%8F%96%E5%87%BA%E6%83%B3%E8%A6%81%E7%9A%84%E4%BF%A1%E6%81%AF">src/lib.rs: ä½¿ç”¨æ´¾ç”Ÿå®ä»TokenStreamæŠ½å–å‡ºæƒ³è¦çš„ä¿¡æ¯</a></li>
<li><a href="4_macros.html#examplesraw_commandrs-%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E6%B4%BE%E7%94%9F%E5%AE%8F%E6%8A%BD%E5%8F%96">examples/raw_command.rs: ä½¿ç”¨è¿™ä¸ªæ´¾ç”Ÿå®æŠ½å–</a></li>
<li><a href="4_macros.html#%E8%BF%90%E8%A1%8C%E6%9F%A5%E7%9C%8B%E8%8E%B7%E5%8F%96%E7%9A%84tokenstream">è¿è¡Œï¼ŒæŸ¥çœ‹è·å–çš„TokenStream</a></li>
<li><a href="4_macros.html#srcraw_builderrs-%E4%BD%BF%E7%94%A8anyhow%E4%B8%8Easkama%E6%8A%BD%E5%8F%96tokenstream%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF">src/raw_builder.rs: ä½¿ç”¨anyhowä¸askamaæŠ½å–TokenStreamä¸­çš„ä¿¡æ¯</a></li>
<li><a href="4_macros.html#templatesbuilderj2-%E4%B8%8A%E9%9D%A2askama%E7%94%A8%E5%88%B0%E7%9A%84jinja2%E6%A8%A1%E7%89%88">templates/builder.j2: ä¸Šé¢askamaç”¨åˆ°çš„jinja2æ¨¡ç‰ˆ</a></li>
<li><a href="4_macros.html#srcraw_builderrs-%E5%AE%9E%E7%8E%B0%E5%AF%B9%E5%BA%94%E6%8A%BD%E5%8F%96%E6%96%B9%E6%B3%95">src/raw_builder.rs: å®ç°å¯¹åº”æŠ½å–æ–¹æ³•</a></li>
</ul>
</li>
<li><a href="4_macros.html#%E4%BD%BF%E7%94%A8synquote%E5%8F%AF%E4%BB%A5%E4%B8%8D%E7%94%A8%E8%87%AA%E5%B7%B1%E5%AE%9A%E4%B9%89%E6%A8%A1%E7%89%88">ä½¿ç”¨syn/quoteå¯ä»¥ä¸ç”¨è‡ªå·±å®šä¹‰æ¨¡ç‰ˆ</a></li>
</ul>
</li>
<li><a href="4_macros.html#%E8%BF%87%E7%A8%8B%E5%B1%9E%E6%80%A7%E5%AE%8F-proc_macro_derivemacro_name-attributesattr_name">è¿‡ç¨‹å±æ€§å®: proc_macro_derive(macro_name, attributes(attr_name))</a>
<ul>
<li><a href="4_macros.html#%E4%BD%BF%E7%94%A8synquote%E5%AE%9A%E4%B9%89%E5%B1%9E%E6%80%A7%E5%AE%8F">ä½¿ç”¨syn/quoteå®šä¹‰å±æ€§å®</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:43:59 UTC 2022 -->
<!--te-->
<h2 id="èµ„æ–™"><a class="header" href="#èµ„æ–™">èµ„æ–™</a></h2>
<ul>
<li><a href="https://kaisery.github.io/trpl-zh-cn/ch19-06-macros.html">å® - Rust ç¨‹åºè®¾è®¡è¯­è¨€ ç®€ä½“ä¸­æ–‡ç‰ˆ</a></li>
<li><a href="https://doc.rust-lang.org/book/ch19-06-macros.html">Macros - The Rust Programming Language</a></li>
<li><a href="https://doc.rust-lang.org/reference/macros-by-example.html">Macros By Example - The Rust Reference</a></li>
</ul>
<h2 id="å®çš„åˆ†ç±»"><a class="header" href="#å®çš„åˆ†ç±»">å®çš„åˆ†ç±»</a></h2>
<h3 id="ä½¿ç”¨æ³³é“å›¾"><a class="header" href="#ä½¿ç”¨æ³³é“å›¾">ä½¿ç”¨æ³³é“å›¾</a></h3>
<details id="admonition-å®ç¼–ç¨‹ä½¿ç”¨å¯¹æ¯”æ³³é“å›¾" class="admonition info">
<summary class="admonition-title">
<p>å®ç¼–ç¨‹ä½¿ç”¨å¯¹æ¯”æ³³é“å›¾</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-å®ç¼–ç¨‹ä½¿ç”¨å¯¹æ¯”æ³³é“å›¾"></a></p>
</summary>
<div>
<figure><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2887px" preserveAspectRatio="none" style="width:943px;height:2887px;background:#FFFFFF;" version="1.1" viewBox="0 0 943 2887" width="943px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="42.5938" id="_title" style="stroke:none;stroke-width:1.0;" width="192" x="374" y="15"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="98" x="421" y="32.9951">ä¸¤ç±»å››ç§å®å¯¹æ¯”</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="182" x="379" y="49.292">ï¼ˆå…·ä½“å†…å®¹çœ‹è¯¦ç»†ç‰ˆæ³³é“å›¾ï¼‰</text><rect fill="none" height="20.9531" style="stroke:none;stroke-width:1.0;" width="910" x="15" y="66.3389"/><ellipse cx="128.5" cy="320.167" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="47.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="131" x="63" y="350.167"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="107" x="77" y="371.3057">åŸºäºTokenStream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="73" y="385.2744">å®šä¹‰è¿‡ç¨‹å‡½æ•°å®</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="88.5" y="418.1045"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="98.5" y="439.2432">æ‰“å¼€è¿‡ç¨‹å®</text><ellipse cx="128.5" cy="699.9482" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="215" x="21" y="729.9482"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="191" x="35" y="751.0869">æ‰‹å·¥æŠ½å–TokenStreamå®šä¹‰æ´¾ç”Ÿå®</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="84" x="86.5" y="783.917"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="100.5" y="805.0557">æ‰“å¼€è¿‡ç¨‹å®</text><ellipse cx="128.5" cy="1461.167" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="47.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="193" x="32" y="1491.167"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="169" x="46" y="1512.3057">syn/quoteæŠ½å–TokenStream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="42" y="1526.2744">ä¸ºDeriveInputå®šä¹‰æ´¾ç”Ÿå®</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="84" x="86.5" y="1559.1045"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="100.5" y="1580.2432">æ‰“å¼€è¿‡ç¨‹å®</text><ellipse cx="128.5" cy="2126.5107" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="47.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="193" x="32" y="2156.5107"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="169" x="46" y="2177.6494">syn/quoteæŠ½å–TokenStream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="42" y="2191.6182">ä¸ºDeriveInputå®šä¹‰å±æ€§å®</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="84" x="86.5" y="2224.4482"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="100.5" y="2245.5869">æ‰“å¼€è¿‡ç¨‹å®</text><line style="stroke:#000000;stroke-width:1.5;" x1="15" x2="15" y1="66.3389" y2="2875.667"/><rect fill="#FAEBD7" height="2809.3281" style="stroke:#FAEBD7;stroke-width:1.0;" width="318" x="240" y="66.3389"/><rect fill="#F1F1F1" height="85.875" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="307" x="246" y="837.8857"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="287" x="256" y="859.0244">ä½¿ç”¨anyhowä¸askamaæŠ½å–TokenStreamä¸­çš„ä¿¡æ¯</text><line style="stroke:#181818;stroke-width:1.0;" x1="246" x2="553" y1="866.8545" y2="866.8545"/><line style="stroke:#181818;stroke-width:1.0;" x1="246" x2="553" y1="868.8545" y2="868.8545"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="182" x="256" y="882.9932">1. åˆ†åˆ«å®šä¹‰BuilderContextå’ŒFd</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="228" x="256" y="896.9619">2. BuilderContextå¤„ç†jinjaæ¨¡ç‰ˆæ•°æ®ç»“æ„</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="105" x="256" y="910.9307">3. Fdæè¿°æ¯ä¸ªfield</text><rect fill="#AAAAAA" height="75.875" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="327" y="943.7607"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="125" x="337" y="964.8994">templates/builder.j2</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="4" x="337" y="978.8682">Â </text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="116" x="337" y="992.8369">ç¼–å†™ä¸tokenstream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="93" x="337" y="1006.8057">å¯¹åº”çš„jinja2æ¨¡ç‰ˆ</text><rect fill="#F1F1F1" height="169.6875" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="227" x="286" y="1039.6357"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="296" y="1060.7744">å®ç°å¯¹åº”æŠ½å–æ–¹æ³•</text><line style="stroke:#181818;stroke-width:1.0;" x1="286" x2="513" y1="1068.6045" y2="1068.6045"/><line style="stroke:#181818;stroke-width:1.0;" x1="286" x2="513" y1="1070.6045" y2="1070.6045"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="194" x="296" y="1084.7432">1. Fdå®ç°newæ–¹æ³•å¤„ç†TokenTree</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="191" x="296" y="1098.7119">2. BuilderContextå®ç°ä¸‹åˆ—æ–¹æ³•ï¼š</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="37" x="296" y="1112.6807">- new:</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="175" x="328" y="1126.6494">ä» TokenStream ä¸­æå–ä¿¡æ¯ï¼Œ</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="119" x="328" y="1140.6182">æ„å»º BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="54" x="296" y="1154.5869">- render:</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="165" x="328" y="1168.5557">æŠŠjinja2æ¨¡ç‰ˆæ¸²æŸ“æˆå­—ç¬¦ä¸²ä»£ç </text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="142" x="328" y="1182.5244">&gt; renderé‡Œé¢ç”¨åˆ°splitå’Œ</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="127" x="344" y="1196.4932">get_struct_fieldsæ–¹æ³•</text><rect fill="#F1F1F1" height="57.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="273" x="263" y="1613.0732"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="253" x="273" y="1634.2119">ä½¿ç”¨synä¸quoteæŠ½å– TokenStreamä¸­çš„ä¿¡æ¯</text><line style="stroke:#181818;stroke-width:1.0;" x1="263" x2="536" y1="1642.042" y2="1642.042"/><line style="stroke:#181818;stroke-width:1.0;" x1="263" x2="536" y1="1644.042" y2="1644.042"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="182" x="273" y="1658.1807">1. åŒæ ·å®šä¹‰BuilderContextå’ŒFd</text><rect fill="#F1F1F1" height="183.6563" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="219" x="290" y="1691.0107"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="108" x="300" y="1712.1494">ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨å®šä¹‰</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="132" x="300" y="1726.1182">æŠ½å–æ¨¡ç‰ˆï¼Œç›´æ¥å®ç°æ–¹æ³•</text><line style="stroke:#181818;stroke-width:1.0;" x1="290" x2="509" y1="1733.9482" y2="1733.9482"/><line style="stroke:#181818;stroke-width:1.0;" x1="290" x2="509" y1="1735.9482" y2="1735.9482"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="191" x="300" y="1750.0869">1. æ¯”èµ·æ‰‹åŠ¨æ–¹å¼ï¼ŒBuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="162" x="316" y="1764.0557">å’ŒFdè¿˜éœ€è¦å®ç°From Traitã€‚</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="187" x="300" y="1778.0244">2. æ¥ç€Fdå°±ä¸éœ€è¦å†å¤„ç†ï¼Œä¸»è¦åœ¨</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="91" x="316" y="1791.9932">BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="179" x="300" y="1805.9619">3. BuilderContextå®ç°ä¸‹åˆ—æ–¹æ³•</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="124" x="316" y="1819.9307">- render: ç”¨åˆ°quote!</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="183" x="316" y="1833.8994">- gen_optionized_fields(&amp;self)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="135" x="316" y="1847.8682">- gen_methods(&amp;self)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="128" x="316" y="1861.8369">- gen_assigns(&amp;self)</text><rect fill="#F1F1F1" height="71.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="273" x="263" y="2278.417"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="253" x="273" y="2299.5557">ä½¿ç”¨synä¸quoteæŠ½å– TokenStreamä¸­çš„ä¿¡æ¯</text><line style="stroke:#181818;stroke-width:1.0;" x1="263" x2="536" y1="2307.3857" y2="2307.3857"/><line style="stroke:#181818;stroke-width:1.0;" x1="263" x2="536" y1="2309.3857" y2="2309.3857"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="199" x="273" y="2323.5244">1. å®šä¹‰Optsã€Fdã€BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="240" x="273" y="2337.4932">2. æ¯”èµ·æ´¾ç”Ÿå®ï¼Œå¤šäº†Optsç”¨äºæ•è·Fdçš„å±æ€§</text><rect fill="#F1F1F1" height="155.7188" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="250" x="274.5" y="2370.3232"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="284.5" y="2391.4619">ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨å®š</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="132" x="284.5" y="2405.4307">æŠ½å–æ¨¡ç‰ˆï¼Œç›´æ¥å®ç°æ–¹æ³•</text><line style="stroke:#181818;stroke-width:1.0;" x1="274.5" x2="524.5" y1="2413.2607" y2="2413.2607"/><line style="stroke:#181818;stroke-width:1.0;" x1="274.5" x2="524.5" y1="2415.2607" y2="2415.2607"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="230" x="284.5" y="2429.3994">1. å’Œæ´¾ç”Ÿå®ä¸€æ ·ï¼Œç»™Fdã€BuilderContext</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="150" x="300.5" y="2443.3682">å’ŒFdè¿˜éœ€è¦å®ç°From Trait</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="215" x="284.5" y="2457.3369">2. BuilderContextåŒæ ·å®ç°ä¸‹åˆ—æ–¹æ³•ï¼š</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="124" x="300.5" y="2471.3057">- render: ç”¨åˆ°quote!</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="183" x="300.5" y="2485.2744">- gen_optionized_fields(&amp;self)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="135" x="300.5" y="2499.2432">- gen_methods(&amp;self)</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="128" x="300.5" y="2513.2119">- gen_assigns(&amp;self)</text><line style="stroke:#000000;stroke-width:1.5;" x1="240" x2="240" y1="66.3389" y2="2875.667"/><ellipse cx="652" cy="102.292" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="612" y="132.292"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="622" y="153.4307">å®šä¹‰å£°æ˜å®</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="612" y="472.0732"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="622" y="493.2119">å®šä¹‰è¿‡ç¨‹å®</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="600" y="1229.3232"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="610" y="1250.4619">å®šä¹‰è¿‡ç¨‹æ´¾ç”Ÿå®</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="600" y="1894.667"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="610" y="1915.8057">å®šä¹‰è¿‡ç¨‹æ´¾ç”Ÿå®</text><rect fill="#F1F1F1" height="151.75" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="176" x="564" y="2546.042"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="574" y="2567.1807">å®šä¹‰è¿‡ç¨‹æ´¾ç”Ÿå®</text><line style="stroke:#181818;stroke-width:1.0;" x1="564" x2="740" y1="2575.0107" y2="2575.0107"/><line style="stroke:#181818;stroke-width:1.0;" x1="564" x2="740" y1="2577.0107" y2="2577.0107"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="574" y="2591.1494">å’Œæ´¾ç”Ÿå®ä¸åŒçš„æ˜¯</text><line style="stroke:#181818;stroke-width:1.0;" x1="564" x2="740" y1="2598.9795" y2="2598.9795"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="72" x="574" y="2615.1182">è¿™é‡Œå¤šäº†ä¸€ä¸ª</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="155" x="574" y="2629.0869">attributes(builder) å±æ€§ï¼Œ</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="96" x="574" y="2643.0557">è¿™æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œ</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="108" x="574" y="2657.0244">è¯·å…è®¸ä»£ç ä¸­å‡ºç°çš„</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="12" x="574" y="2670.9932">1.</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="87" x="590" y="2670.9932">[builder(...)]ï¼Œ</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="156" x="574" y="2684.9619">å®ƒæ˜¯æˆ‘è¿™ä¸ªå®è®¤è¯†å¹¶è¦å¤„ç†çš„</text><line style="stroke:#000000;stroke-width:1.5;" x1="558" x2="558" y1="66.3389" y2="2875.667"/><rect fill="#F1F1F1" height="71.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="127" x="771" y="186.2607"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="781" y="207.3994">ä½¿ç”¨å£°æ˜å®</text><line style="stroke:#181818;stroke-width:1.0;" x1="771" x2="898" y1="215.2295" y2="215.2295"/><line style="stroke:#181818;stroke-width:1.0;" x1="771" x2="898" y1="217.2295" y2="217.2295"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="107" x="781" y="231.3682">æ²¡æœ‰TokenStream</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="48" x="781" y="245.3369">éš¾ä»¥è°ƒè¯•</text><ellipse cx="834.5" cy="289.167" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="834.5" cy="289.167" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="794.5" y="526.042"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="804.5" y="547.1807">ä½¿ç”¨è¿‡ç¨‹å®</text><rect fill="#F1F1F1" height="57.9375" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="163" x="753" y="580.0107"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="763" y="601.1494">Terminal</text><line style="stroke:#181818;stroke-width:1.0;" x1="753" x2="916" y1="608.9795" y2="608.9795"/><line style="stroke:#181818;stroke-width:1.0;" x1="753" x2="916" y1="610.9795" y2="610.9795"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="763" y="625.1182">æŸ¥çœ‹æ‰“å°çš„TokenStream</text><ellipse cx="834.5" cy="668.9482" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="834.5" cy="668.9482" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="782.5" y="1283.292"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="792.5" y="1304.4307">ä½¿ç”¨æ´¾ç”Ÿå®æŠ½å–</text><rect fill="#F1F1F1" height="61.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="103" x="783" y="1337.2607"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="793" y="1358.3994">Terminal</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="793" y="1372.3682">æŸ¥çœ‹æ‰“å°çš„</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="83" x="793" y="1386.3369">TokenStream</text><ellipse cx="834.5" cy="1430.167" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="834.5" cy="1430.167" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="782.5" y="1948.6357"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="792.5" y="1969.7744">ä½¿ç”¨æ´¾ç”Ÿå®æŠ½å–</text><rect fill="#F1F1F1" height="61.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="91" x="789" y="2002.6045"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="799" y="2023.7432">Terminal</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="799" y="2037.7119">æŸ¥çœ‹æ‰“å°çš„</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="71" x="799" y="2051.6807">DeriveInput</text><ellipse cx="834.5" cy="2095.5107" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="834.5" cy="2095.5107" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="782.5" y="2717.792"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="84" x="792.5" y="2738.9307">ä½¿ç”¨æ´¾ç”Ÿå®æŠ½å–</text><rect fill="#F1F1F1" height="61.9063" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="91" x="789" y="2771.7607"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="53" x="799" y="2792.8994">Terminal</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="799" y="2806.8682">æŸ¥çœ‹æ‰“å°çš„</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="71" x="799" y="2820.8369">DeriveInput</text><ellipse cx="834.5" cy="2864.667" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="834.5" cy="2864.667" fill="#222222" rx="6" ry="6" style="stroke:#111111;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.5;" x1="745" x2="745" y1="66.3389" y2="2875.667"/><line style="stroke:#000000;stroke-width:1.5;" x1="923" x2="923" y1="66.3389" y2="2875.667"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="330.167" y2="350.167"/><polygon fill="#181818" points="124.5,340.167,128.5,350.167,132.5,340.167,128.5,344.167" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="398.1045" y2="418.1045"/><polygon fill="#181818" points="124.5,408.1045,128.5,418.1045,132.5,408.1045,128.5,412.1045" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="709.9482" y2="729.9482"/><polygon fill="#181818" points="124.5,719.9482,128.5,729.9482,132.5,719.9482,128.5,723.9482" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="763.917" y2="783.917"/><polygon fill="#181818" points="124.5,773.917,128.5,783.917,132.5,773.917,128.5,777.917" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="1471.167" y2="1491.167"/><polygon fill="#181818" points="124.5,1481.167,128.5,1491.167,132.5,1481.167,128.5,1485.167" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="1539.1045" y2="1559.1045"/><polygon fill="#181818" points="124.5,1549.1045,128.5,1559.1045,132.5,1549.1045,128.5,1553.1045" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="2136.5107" y2="2156.5107"/><polygon fill="#181818" points="124.5,2146.5107,128.5,2156.5107,132.5,2146.5107,128.5,2150.5107" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="2204.4482" y2="2224.4482"/><polygon fill="#181818" points="124.5,2214.4482,128.5,2224.4482,132.5,2214.4482,128.5,2218.4482" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="923.7607" y2="943.7607"/><polygon fill="#181818" points="395.5,933.7607,399.5,943.7607,403.5,933.7607,399.5,937.7607" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="1019.6357" y2="1039.6357"/><polygon fill="#181818" points="395.5,1029.6357,399.5,1039.6357,403.5,1029.6357,399.5,1033.6357" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="1671.0107" y2="1691.0107"/><polygon fill="#181818" points="395.5,1681.0107,399.5,1691.0107,403.5,1681.0107,399.5,1685.0107" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="2350.3232" y2="2370.3232"/><polygon fill="#181818" points="395.5,2360.3232,399.5,2370.3232,403.5,2360.3232,399.5,2364.3232" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="112.292" y2="132.292"/><polygon fill="#181818" points="648,122.292,652,132.292,656,122.292,652,126.292" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="258.167" y2="278.167"/><polygon fill="#181818" points="830.5,268.167,834.5,278.167,838.5,268.167,834.5,272.167" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="560.0107" y2="580.0107"/><polygon fill="#181818" points="830.5,570.0107,834.5,580.0107,838.5,570.0107,834.5,574.0107" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="637.9482" y2="657.9482"/><polygon fill="#181818" points="830.5,647.9482,834.5,657.9482,838.5,647.9482,834.5,651.9482" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="1317.2607" y2="1337.2607"/><polygon fill="#181818" points="830.5,1327.2607,834.5,1337.2607,838.5,1327.2607,834.5,1331.2607" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="1399.167" y2="1419.167"/><polygon fill="#181818" points="830.5,1409.167,834.5,1419.167,838.5,1409.167,834.5,1413.167" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="1982.6045" y2="2002.6045"/><polygon fill="#181818" points="830.5,1992.6045,834.5,2002.6045,838.5,1992.6045,834.5,1996.6045" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="2064.5107" y2="2084.5107"/><polygon fill="#181818" points="830.5,2074.5107,834.5,2084.5107,838.5,2074.5107,834.5,2078.5107" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="2751.7607" y2="2771.7607"/><polygon fill="#181818" points="830.5,2761.7607,834.5,2771.7607,838.5,2761.7607,834.5,2765.7607" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="2833.667" y2="2853.667"/><polygon fill="#181818" points="830.5,2843.667,834.5,2853.667,838.5,2843.667,834.5,2847.667" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="166.2607" y2="171.2607"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="834.5" y1="171.2607" y2="171.2607"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="171.2607" y2="186.2607"/><polygon fill="#181818" points="830.5,176.2607,834.5,186.2607,838.5,176.2607,834.5,180.2607" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="452.0732" y2="457.0732"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="652" y1="457.0732" y2="457.0732"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="457.0732" y2="472.0732"/><polygon fill="#181818" points="648,462.0732,652,472.0732,656,462.0732,652,466.0732" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="506.042" y2="511.042"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="834.5" y1="511.042" y2="511.042"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="511.042" y2="526.042"/><polygon fill="#181818" points="830.5,516.042,834.5,526.042,838.5,516.042,834.5,520.042" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="817.8857" y2="822.8857"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="399.5" y1="822.8857" y2="822.8857"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="822.8857" y2="837.8857"/><polygon fill="#181818" points="395.5,827.8857,399.5,837.8857,403.5,827.8857,399.5,831.8857" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="1209.3232" y2="1214.3232"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="652" y1="1214.3232" y2="1214.3232"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="1214.3232" y2="1229.3232"/><polygon fill="#181818" points="648,1219.3232,652,1229.3232,656,1219.3232,652,1223.3232" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="1263.292" y2="1268.292"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="834.5" y1="1268.292" y2="1268.292"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="1268.292" y2="1283.292"/><polygon fill="#181818" points="830.5,1273.292,834.5,1283.292,838.5,1273.292,834.5,1277.292" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="1593.0732" y2="1598.0732"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="399.5" y1="1598.0732" y2="1598.0732"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="1598.0732" y2="1613.0732"/><polygon fill="#181818" points="395.5,1603.0732,399.5,1613.0732,403.5,1603.0732,399.5,1607.0732" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="1874.667" y2="1879.667"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="652" y1="1879.667" y2="1879.667"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="1879.667" y2="1894.667"/><polygon fill="#181818" points="648,1884.667,652,1894.667,656,1884.667,652,1888.667" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="1928.6357" y2="1933.6357"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="834.5" y1="1933.6357" y2="1933.6357"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="1933.6357" y2="1948.6357"/><polygon fill="#181818" points="830.5,1938.6357,834.5,1948.6357,838.5,1938.6357,834.5,1942.6357" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="128.5" y1="2258.417" y2="2263.417"/><line style="stroke:#181818;stroke-width:1.0;" x1="128.5" x2="399.5" y1="2263.417" y2="2263.417"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="2263.417" y2="2278.417"/><polygon fill="#181818" points="395.5,2268.417,399.5,2278.417,403.5,2268.417,399.5,2272.417" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="399.5" y1="2526.042" y2="2531.042"/><line style="stroke:#181818;stroke-width:1.0;" x1="399.5" x2="652" y1="2531.042" y2="2531.042"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="2531.042" y2="2546.042"/><polygon fill="#181818" points="648,2536.042,652,2546.042,656,2536.042,652,2540.042" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="652" y1="2697.792" y2="2702.792"/><line style="stroke:#181818;stroke-width:1.0;" x1="652" x2="834.5" y1="2702.792" y2="2702.792"/><line style="stroke:#181818;stroke-width:1.0;" x1="834.5" x2="834.5" y1="2702.792" y2="2717.792"/><polygon fill="#181818" points="830.5,2707.792,834.5,2717.792,838.5,2707.792,834.5,2711.792" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="99" x="81" y="83.0469">Cargo.toml</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="281" x="261.5" y="83.0469">src/&lt;å¯¹åº”æŠ½å–å­—æ®µä¸æ–¹æ³•å®šä¹‰&gt;.rs</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="74" x="617.5" y="83.0469">src/lib.rs</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="162" x="756" y="83.0469">examples/è°ƒç”¨ä»£ç </text></g></svg></figure>
</div>
</details>
<h3 id="è¡¨æ ¼"><a class="header" href="#è¡¨æ ¼">è¡¨æ ¼</a></h3>
<div class="extended-markdown-table"><div class="extended-markdown-header extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 1; grid-row-end: 2">Macros</div><div class="extended-markdown-header" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 1; grid-row-end: 2">Define</div><div class="extended-markdown-header" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 1; grid-row-end: 2">Usage</div><div class="extended-markdown-header" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 1; grid-row-end: 2">note</div><div class="extended-markdown-header" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 1; grid-row-end: 2">Example</div><div class="extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 2; grid-row-end: 3">Declarative Macro</div><div class="" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 2; grid-row-end: 3">#[macro_export]/macro_rules! macro_name{}</div><div class="" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 2; grid-row-end: 3">macro_name!()</div><div class="" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 2; grid-row-end: 3"></div><div class="" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 2; grid-row-end: 3">println!</div><div class="extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 3; grid-row-end: 4">Function Macro</div><div class="" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 3; grid-row-end: 4">#[proc_macros]/pub fn macro_name</div><div class="" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 3; grid-row-end: 4">macro_name!()</div><div class="" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 3; grid-row-end: 4">advanced declarative macro</div><div class="" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 3; grid-row-end: 4"></div><div class="extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 4; grid-row-end: 5">Derive Macro</div><div class="" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 4; grid-row-end: 5">#[proc_macros_derive(DeriveMacroName)]/pub  fn other_fn_name</div><div class="" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 4; grid-row-end: 5">DeriveMacroName!()</div><div class="" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 4; grid-row-end: 5"></div><div class="" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 4; grid-row-end: 5">#[derive(Debug)]</div><div class="extended-markdown-left-border" style="grid-column-start: 1; grid-column-end: 2; grid-row-start: 5; grid-row-end: 6">Attritubte Macro</div><div class="" style="grid-column-start: 2; grid-column-end: 3; grid-row-start: 5; grid-row-end: 6">#[proc_macros_derive(AttributeMacroName, attributes(attr_name))]/pub  fn other_fn_name</div><div class="" style="grid-column-start: 3; grid-column-end: 4; grid-row-start: 5; grid-row-end: 6">Only Diff with DeriveMacro when define struct</div><div class="" style="grid-column-start: 4; grid-column-end: 5; grid-row-start: 5; grid-row-end: 6"></div><div class="" style="grid-column-start: 5; grid-column-end: 6; grid-row-start: 5; grid-row-end: 6"></div></div>
<h3 id="å£°æ˜å®çš„ç¼ºé™·è€Œåæœ‰äº†è¿‡ç¨‹å®"><a class="header" href="#å£°æ˜å®çš„ç¼ºé™·è€Œåæœ‰äº†è¿‡ç¨‹å®">å£°æ˜å®çš„ç¼ºé™·ï¼Œè€Œåæœ‰äº†è¿‡ç¨‹å®</a></h3>
<ul>
<li><a href="https://blog.logrocket.com/macros-in-rust-a-tutorial-with-examples/#limitationsofdeclarativemacros">Macros in Rust: A tutorial with examples - LogRocket Blog</a></li>
</ul>
<details id="admonition-ä¸ºä»€ä¹ˆè¿‡ç¨‹å®å’Œå£°æ˜å®é‚£ä¹ˆåƒ" class="admonition tip">
<summary class="admonition-title">
<p>ä¸ºä»€ä¹ˆè¿‡ç¨‹å®å’Œå£°æ˜å®é‚£ä¹ˆåƒ</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-ä¸ºä»€ä¹ˆè¿‡ç¨‹å®å’Œå£°æ˜å®é‚£ä¹ˆåƒ"></a></p>
</summary>
<div>
<blockquote>
<p>è¿‡ç¨‹å®çš„ç¼ºé™·</p>
</blockquote>
<ol>
<li>ç¼ºä¹å¯¹å®è‡ªåŠ¨å®Œæˆå’Œæ‰©å±•çš„æ”¯æŒ </li>
<li>è°ƒè¯•å£°æ˜æ€§å®å¾ˆå›°éš¾ </li>
<li>ä¿®æ”¹èƒ½åŠ›æœ‰é™ </li>
<li>è¾ƒå¤§çš„äºŒè¿›åˆ¶æ–‡ä»¶ </li>
<li>æ›´é•¿çš„ç¼–è¯‘æ—¶é—´ï¼ˆè¿™é€‚ç”¨äºå£°æ˜æ€§å®å’Œè¿‡ç¨‹å®ï¼‰</li>
</ol>
<blockquote>
<p>è¿‡ç¨‹å®æ˜¯è¯­æ³•æ ‘çº§åˆ«çš„è½¬æ¢
è¿‡ç¨‹å®æ˜¯å®çš„æ›´é«˜çº§ç‰ˆæœ¬ã€‚è¿‡ç¨‹å®å…è®¸ä½ æ‰©å±•ç°æœ‰çš„ Rust è¯­æ³•ã€‚å®ƒæ¥å—ä»»æ„è¾“å…¥å¹¶è¿”å›æœ‰æ•ˆçš„ Rust ä»£ç ã€‚ 
è¿‡ç¨‹å®æ˜¯å°† TokenStream ä½œä¸ºè¾“å…¥å¹¶è¿”å›å¦ä¸€ä¸ª Token Stream çš„å‡½æ•°ã€‚è¿‡ç¨‹å®æ“ä½œè¾“å…¥ TokenStream ä»¥äº§ç”Ÿè¾“å‡ºæµã€‚</p>
</blockquote>
</div>
</details>
<h3 id="å£°æ˜å®declarative-macros-macro_rulesbang"><a class="header" href="#å£°æ˜å®declarative-macros-macro_rulesbang">å£°æ˜å®(declarative macros): macro_rules!(bang)</a></h3>
<blockquote>
<p>å¯¹ä»£ç æ¨¡ç‰ˆåšç®€å•æ›¿æ¢
å£°æ˜å®å¯ä»¥ç”¨ macro_rules! æ¥æè¿°, å¦‚æœé‡å¤æ€§çš„ä»£ç æ— æ³•ç”¨å‡½æ•°æ¥å°è£…ï¼Œé‚£ä¹ˆå£°æ˜å®å°±æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©</p>
</blockquote>
<h3 id="è¿‡ç¨‹å®æ·±åº¦å®šåˆ¶ä¸ç”Ÿæˆä»£ç "><a class="header" href="#è¿‡ç¨‹å®æ·±åº¦å®šåˆ¶ä¸ç”Ÿæˆä»£ç ">è¿‡ç¨‹å®ï¼šæ·±åº¦å®šåˆ¶ä¸ç”Ÿæˆä»£ç </a></h3>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Za411q7LQ">Rust è¿‡ç¨‹å®(1): å¦‚ä½•ç¡¬ç”Ÿç”Ÿè§£æå’Œæ‰‹å†™è¿‡ç¨‹å®</a></li>
</ul>
<blockquote>
<p>ä¸»è¦ä»¥å¦‚ä½•ä½¿ç”¨ function-like macro åœ¨ä¸ä¾èµ–äº syn / quote çš„æƒ…å†µä¸‹ï¼ŒæŠŠ Json Schema åœ¨ç¼–è¯‘æœŸè½¬æ¢æˆ Rust structã€‚ä¸»è¦ç›®çš„æ˜¯è®©å¤§å®¶ç†Ÿæ‚‰åŸºæœ¬çš„å¤„ç† TokenStream çš„æ€è·¯</p>
</blockquote>
<ul>
<li><a href="https://www.bilibili.com/video/BV1Fu411m7W7">Rust è¿‡ç¨‹å®(2): ä½¿ç”¨ syn/quote æ’°å†™è¿‡ç¨‹å®</a></li>
</ul>
<blockquote>
<p>ä¸»è¦é€šè¿‡ä¸€ä¸ª derive Builder å®ï¼Œæ¥å±•ç¤ºä½¿ç”¨ syn/quote å¦‚ä½•å¼€å‘è¿‡ç¨‹å®ã€‚</p>
</blockquote>
<ul>
<li><a href="https://www.bilibili.com/video/BV1dr4y1v74n">Rust è¿‡ç¨‹å®(3): ä½¿ç”¨ darling å¤„ç† attributes</a></li>
</ul>
<blockquote>
<p>åšä¸ªæ”¶å°¾ï¼Œå¯¹ä¸Šä¸€è®²çš„ derive macro æ”¯æŒ attributesã€‚ æˆ‘ä»¬å¯ä»¥ç›´æ¥è§£æ attributes ç›¸å…³çš„ TokenStreamï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ darling è¿™ä¸ªå¾ˆæ–¹ä¾¿çš„åº“ï¼Œç›´æ¥æŠŠ attributes åƒ
Clap/Structopts é‚£æ ·æ”¶é›†åˆ°ä¸€ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œç„¶åå†è¿›ä¸€æ­¥å¤„ç†ã€‚</p>
</blockquote>
<details id="admonition-æ€»ç»“" class="admonition info">
<summary class="admonition-title">
<p>æ€»ç»“</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-æ€»ç»“"></a></p>
</summary>
<div>
<p>è¿™ä¸‰è®²çš„å†…å®¹è™½ç„¶ç®€å•ï¼Œä½†è¶³ä»¥åº”ä»˜å¤§å®¶ç»å¤§å¤šæ•°å®ç¼–ç¨‹çš„éœ€æ±‚ã€‚
å…¶å®æˆ‘ä»¬ç°åœ¨å¯¹ syn åº“çš„ä½¿ç”¨è¿˜åªæ˜¯ä¸€ä¸ªçš®æ¯›ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ·±å…¥
å»æ’°å†™è‡ªå·±çš„æ•°æ®ç»“æ„å»å®ç° Parse traitï¼Œåƒ DeriveInput 
é‚£æ ·å¯ä»¥ç›´æ¥æŠŠ TokenStream è½¬æ¢æˆæˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿ã€‚</p>
<p>å¤§å®¶æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è‡ªè¡Œå»çœ‹ syn åº“çš„æ–‡æ¡£ã€‚</p>
</div>
</details>
<h4 id="å‡½æ•°å®"><a class="header" href="#å‡½æ•°å®">å‡½æ•°å®</a></h4>
<p>çœ‹èµ·æ¥åƒå‡½æ•°çš„å®ï¼Œä½†åœ¨ç¼–è¯‘æœŸè¿›è¡Œå¤„ç†.</p>
<blockquote>
<p>sqlx ç”¨å‡½æ•°å®æ¥å¤„ç†SQL queryã€tokioä½¿ç”¨å±æ€§å® #[tokio::main] æ¥å¼•å…¥ runtimeã€‚
å®ƒä»¬å¯ä»¥å¸®åŠ©ç›®æ ‡ä»£ç çš„å®ç°é€»è¾‘å˜å¾—æ›´åŠ ç®€å•ï¼Œ ä½†ä¸€èˆ¬é™¤éç‰¹åˆ«å¿…è¦ï¼Œå¦åˆ™å¹¶ä¸æ¨èå†™ã€‚
å¹¶æ²¡æœ‰ç‰¹å®šçš„ä½¿ç”¨åœºæ™¯</p>
</blockquote>
<h4 id="å±æ€§å®"><a class="header" href="#å±æ€§å®">å±æ€§å®</a></h4>
<p>å¯ä»¥åœ¨å…¶ä»–ä»£ç å—ä¸Šæ·»åŠ å±æ€§ï¼Œä¸ºä»£ç å—æä¾›æ›´å¤šåŠŸèƒ½ã€‚</p>
<h4 id="æ´¾ç”Ÿå®"><a class="header" href="#æ´¾ç”Ÿå®">æ´¾ç”Ÿå®</a></h4>
<p>ä¸º deriveå±æ€§æ·»åŠ æ–°çš„åŠŸèƒ½ã€‚è¿™æ˜¯æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨æœ€å¤šçš„å®ï¼Œæ¯”å¦‚ #[derive(Debug)].</p>
<blockquote>
<p>å¦‚æœä½ å®šä¹‰çš„ trait åˆ«äººå®ç°èµ·æ¥æœ‰å›ºå®šçš„æ¨¡å¼å¯å¾ªï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä¸ºå…¶æ„å»ºæ´¾ç”Ÿå®</p>
</blockquote>
<h2 id="å£°æ˜å®"><a class="header" href="#å£°æ˜å®">å£°æ˜å®</a></h2>
<h3 id="rustå¸¸ç”¨å£°æ˜å®"><a class="header" href="#rustå¸¸ç”¨å£°æ˜å®">Rustå¸¸ç”¨å£°æ˜å®</a></h3>
<h4 id="println"><a class="header" href="#println">println!</a></h4>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.println.html">println in std - Rust</a></li>
<li><a href="https://blog.csdn.net/jiangjkd/article/details/120994956">Rustå£°æ˜å®printlnå‰–æ_ä¸€çº¿coderçš„åšå®¢-CSDNåšå®¢_rust å£°æ˜å®</a></li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[macro_export]
#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
#[allow_internal_unstable(print_internals, format_args_nl)]
macro_rules! println {
    () =&gt; ($crate::print!(&quot;\n&quot;));
    ($($arg:tt)*) =&gt; ({
        $crate::io::_print($crate::format_args_nl!($($arg)*));
    })
}
<span class="boring">}
</span></code></pre></pre>
<h4 id="writeln"><a class="header" href="#writeln">writeln!</a></h4>
<blockquote>
<p>å¯ä»¥å°†å†…å®¹è¾“å…¥åˆ°æŒ‡å®šæ–‡ä»¶</p>
</blockquote>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.writeln.html">writeln in std - Rust</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/148945862">rustå…¥é—¨ç¬”è®°â€”ç¿»è¯‘rust writeï¼å® - çŸ¥ä¹</a></li>
</ul>
<pre><code class="language-shell">cargo run --example raw_command &gt; examples/raw_command_output.txt
</code></pre>
<h4 id="eprintln"><a class="header" href="#eprintln">eprintln!</a></h4>
<ul>
<li><a href="https://doc.rust-lang.org/std/macro.eprintln.html">eprintln in std - Rust</a></li>
</ul>
<h3 id="ç¤ºä¾‹"><a class="header" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></h3>
<h4 id="å£°æ˜å®ç¤ºæ„å›¾"><a class="header" href="#å£°æ˜å®ç¤ºæ„å›¾">å£°æ˜å®ç¤ºæ„å›¾</a></h4>
<figure><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="633px" preserveAspectRatio="none" style="width:474px;height:633px;background:#FFFFFF;" version="1.1" viewBox="0 0 474 633" width="474px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="26.2969" id="_title" style="stroke:none;stroke-width:1.0;" width="136" x="167.5" y="15"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="126" x="172.5" y="32.9951">å£°æ˜å®å®šä¹‰ä½¿ç”¨æµç¨‹</text><ellipse cx="51" cy="57.2969" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><path d="M101,77.2969 L101,389.9531 L462,389.9531 L462,87.2969 L452,77.2969 L101,77.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M452,77.2969 L452,87.2969 L462,87.2969 L452,77.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="107" y="94.3638">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="123" y="94.3638">[macro_export]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="107" y="109.4966">macro_rules! my_vec {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299" x="123" y="124.6294">// æ²¡å¸¦ä»»ä½•å‚æ•°çš„ my_vecï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºçš„ vec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="324" x="123" y="139.7622">// æ³¨æ„ï¼Œç”±äºå®è¦åœ¨è°ƒç”¨çš„åœ°æ–¹å±•å¼€ï¼Œæˆ‘ä»¬æ— æ³•é¢„æµ‹è°ƒç”¨</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="316" x="123" y="154.895">// è€…çš„ç¯å¢ƒæ˜¯å¦å·²ç» åšäº†ç›¸å…³çš„ useï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨çš„</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="123" y="170.0278">// ä»£ç æœ€å¥½å¸¦ç€å®Œæ•´çš„å‘½åç©ºé—´ã€‚</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="123" y="185.1606">() =&gt; {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="139" y="200.2935">std::vec::Vec::new()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12" x="123" y="215.4263">};</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="123" y="230.5591">// å¤„ç† my_vec![1, 2, 3, 4]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="123" y="245.6919">($($el:expr),*) =&gt; ({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="139" y="260.8247">let mut v = std::vec::Vec::new();</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="139" y="275.9575">$(v.push($el);)*</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="7" x="139" y="291.0903">v</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="17" x="123" y="306.2231">});</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="123" y="321.356">// å¤„ç† my_vec![0; 10]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="123" y="336.4888">($el:expr; $n:expr) =&gt; {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="139" y="351.6216">std::vec::from_elem($el, $n)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="123" y="366.7544">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="107" y="381.8872">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="11" y="216.6406"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="21" y="237.7793">å®šä¹‰å£°æ˜å®</text><path d="M101,399.9531 L101,621.8125 L318,621.8125 L318,409.9531 L308,399.9531 L101,399.9531 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M308,399.9531 L308,409.9531 L318,409.9531 L308,399.9531 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="107" y="417.02">fn main() {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="123" y="432.1528">let mut v = my_vec![];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="123" y="447.2856">v.push(1);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="123" y="462.4185">// è°ƒç”¨æ—¶å¯ä»¥ä½¿ç”¨ [], (), {}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="123" y="477.5513">let _v = my_vec!(1, 2, 3, 4);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="123" y="492.6841">let _v = my_vec![1, 2, 3, 4];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="123" y="507.8169">let v = my_vec! {1, 2, 3, 4};</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="123" y="522.9497">println!("{:?}", v);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="107" y="538.0825">Â </text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="123" y="553.2153">println!("{:?}", v);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="123" y="568.3481">//</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146" x="123" y="583.481">let v = my_vec![1; 10];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="123" y="598.6138">println!("{:?}", v);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="8" x="107" y="613.7466">}</text><rect fill="#F1F1F1" height="33.9688" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="80" x="11" y="493.8984"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="60" x="21" y="515.0371">ä½¿ç”¨å£°æ˜å®</text><line style="stroke:#181818;stroke-width:1.0;" x1="51" x2="51" y1="67.2969" y2="216.6406"/><polygon fill="#181818" points="47,206.6406,51,216.6406,55,206.6406,51,210.6406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="51" x2="51" y1="250.6094" y2="493.8984"/><polygon fill="#181818" points="47,483.8984,51,493.8984,55,483.8984,51,487.8984" style="stroke:#181818;stroke-width:1.0;"/></g></svg></figure>
<h4 id="macro_ruleså®šä¹‰"><a class="header" href="#macro_ruleså®šä¹‰">macro_rules!å®šä¹‰</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">#[macro_export]
macro_rules! my_vec {
    // æ²¡å¸¦ä»»ä½•å‚æ•°çš„ my_vecï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºçš„ vec
    // æ³¨æ„ï¼Œç”±äºå®è¦åœ¨è°ƒç”¨çš„åœ°æ–¹å±•å¼€ï¼Œæˆ‘ä»¬æ— æ³•é¢„æµ‹è°ƒç”¨
    // è€…çš„ç¯å¢ƒæ˜¯å¦å·²ç» åšäº†ç›¸å…³çš„ useï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨çš„
    // ä»£ç æœ€å¥½å¸¦ç€å®Œæ•´çš„å‘½åç©ºé—´ã€‚
    () =&gt; {
        std::vec::Vec::new()
    };
    // å¤„ç† my_vec![1, 2, 3, 4]
    ($($el:expr),*) =&gt; ({
        let mut v = std::vec::Vec::new();
        $(v.push($el);)*
        v
    });
    // å¤„ç† my_vec![0; 10]
    ($el:expr; $n:expr) =&gt; {
        std::vec::from_elem($el, $n)
    }
}
</code></pre></pre>
<details id="admonition-elexpr-" class="admonition info">
<summary class="admonition-title">
<p>$($el:expr), *)</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-elexpr-"></a></p>
</summary>
<div>
<ol>
<li>åœ¨å£°æ˜å®ä¸­ï¼Œæ¡ä»¶æ•è·çš„å‚æ•°ä½¿ç”¨ $ å¼€å¤´çš„æ ‡è¯†ç¬¦æ¥å£°æ˜ã€‚</li>
<li>æ¯ä¸ªå‚æ•°éƒ½éœ€è¦æä¾›ç±»å‹ï¼Œè¿™é‡Œ<code>expr</code>ä»£è¡¨è¡¨è¾¾å¼ï¼Œæ‰€ä»¥ $el:expr æ˜¯è¯´æŠŠåŒ¹é…åˆ°çš„è¡¨è¾¾å¼å‘½åä¸º $elã€‚</li>
<li>$(â€¦),* å‘Šè¯‰ç¼–è¯‘å™¨å¯ä»¥åŒ¹é…ä»»æ„å¤šä¸ªä»¥é€—å·åˆ†éš”çš„è¡¨è¾¾å¼ï¼Œç„¶åæ•è·åˆ°çš„æ¯ä¸€ä¸ªè¡¨è¾¾å¼å¯ä»¥ç”¨ $el æ¥è®¿é—®ã€‚</li>
<li>ç”±äºåŒ¹é…çš„æ—¶å€™åŒ¹é…åˆ°ä¸€ä¸ª $(â€¦)* ï¼ˆæˆ‘ä»¬å¯ä»¥ä¸ç®¡åˆ†éš”ç¬¦ï¼‰ï¼Œåœ¨æ‰§è¡Œçš„ä»£ç å—ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç›¸åº”åœ°ä½¿ç”¨ $(â€¦)* å±•å¼€ã€‚</li>
<li>æ‰€ä»¥è¿™å¥ $(v.push($el);)* ç›¸å½“äºåŒ¹é…å‡ºå¤šå°‘ä¸ª $elå°±å±•å¼€å¤šå°‘å¥ push è¯­å¥ã€‚</li>
</ol>
</div>
</details>
<h4 id="ä½¿ç”¨-2"><a class="header" href="#ä½¿ç”¨-2">ä½¿ç”¨</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let mut v = my_vec![];
    v.push(1);
    // è°ƒç”¨æ—¶å¯ä»¥ä½¿ç”¨ [], (), {}
    let _v = my_vec!(1, 2, 3, 4);
    let _v = my_vec![1, 2, 3, 4];
    let v = my_vec! {1, 2, 3, 4};
    println!(&quot;{:?}&quot;, v);

    println!(&quot;{:?}&quot;, v);
    //
    let v = my_vec![1; 10];
    println!(&quot;{:?}&quot;, v);
}
</code></pre></pre>
<h3 id="å£°æ˜å®ç”¨åˆ°çš„å‚æ•°ç±»å‹"><a class="header" href="#å£°æ˜å®ç”¨åˆ°çš„å‚æ•°ç±»å‹">å£°æ˜å®ç”¨åˆ°çš„å‚æ•°ç±»å‹</a></h3>
<details id="admonition-ç±»å‹åˆ—è¡¨" class="admonition info">
<summary class="admonition-title">
<p>ç±»å‹åˆ—è¡¨</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-ç±»å‹åˆ—è¡¨"></a></p>
</summary>
<div>
<ol>
<li>itemï¼Œæ¯”å¦‚ä¸€ä¸ªå‡½æ•°ã€ç»“æ„ä½“ã€æ¨¡å—ç­‰ã€‚ </li>
<li>blockï¼Œä»£ç å—ã€‚æ¯”å¦‚ä¸€ç³»åˆ—ç”±èŠ±æ‹¬å·åŒ…è£¹çš„è¡¨è¾¾å¼å’Œè¯­å¥ã€‚ </li>
<li>stmtï¼Œè¯­å¥ã€‚æ¯”å¦‚ä¸€ä¸ªèµ‹å€¼è¯­å¥ã€‚ </li>
<li>patï¼Œæ¨¡å¼ã€‚ </li>
<li>exprï¼Œè¡¨è¾¾å¼ã€‚åˆšæ‰çš„ä¾‹å­ä½¿ç”¨è¿‡äº†ã€‚ </li>
<li>tyï¼Œç±»å‹ã€‚æ¯”å¦‚ Vecã€‚ </li>
<li>identï¼Œæ ‡è¯†ç¬¦ã€‚æ¯”å¦‚ä¸€ä¸ªå˜é‡åã€‚ </li>
<li>pathï¼Œè·¯å¾„ã€‚æ¯”å¦‚ï¼šfooã€::std::mem::replaceã€transmute::&lt;_, int&gt;ã€‚ </li>
<li>metaï¼Œå…ƒæ•°æ®ã€‚ä¸€èˆ¬æ˜¯åœ¨ #[â€¦] å’Œ #![â€¦] å±æ€§å†…éƒ¨çš„æ•°æ®ã€‚ </li>
<li>ttï¼Œå•ä¸ªçš„ token æ ‘ã€‚ </li>
<li>visï¼Œå¯èƒ½ä¸ºç©ºçš„ä¸€ä¸ª Visibility ä¿®é¥°ç¬¦ã€‚æ¯”å¦‚ pubã€pub(crate)</li>
</ol>
</div>
</details>
<h2 id="è¿‡ç¨‹å®æ‰‹å·¥å®šä¹‰å›¾"><a class="header" href="#è¿‡ç¨‹å®æ‰‹å·¥å®šä¹‰å›¾">è¿‡ç¨‹å®æ‰‹å·¥å®šä¹‰å›¾</a></h2>
<blockquote>
<p>è¿‡ç¨‹å®è¦æ¯”å£°æ˜å®è¦å¤æ‚å¾ˆå¤šï¼Œä¸è¿‡æ— è®ºæ˜¯å“ªä¸€ç§è¿‡ç¨‹å®ï¼Œæœ¬è´¨éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ¶‰åŠè¦æŠŠ <code>è¾“å…¥çš„ TokenStream</code> å¤„ç†æˆ<code>è¾“å‡ºçš„ TokenStream</code>ã€‚</p>
</blockquote>
<h3 id="cargotomlæ·»åŠ proc-macroå£°æ˜"><a class="header" href="#cargotomlæ·»åŠ proc-macroå£°æ˜">Cargo.tomlæ·»åŠ proc-macroå£°æ˜</a></h3>
<blockquote>
<p>è¿™æ ·ï¼Œç¼–è¯‘å™¨æ‰å…è®¸ä½ ä½¿ç”¨ #[proc_macro] ç›¸å…³çš„å®ã€‚</p>
</blockquote>
<pre><code class="language-toml  editable">[lib]
proc-macro = true
</code></pre>
<h2 id="è¿‡ç¨‹å‡½æ•°å®-proc_macro"><a class="header" href="#è¿‡ç¨‹å‡½æ•°å®-proc_macro">è¿‡ç¨‹å‡½æ•°å®: #[proc_macro]</a></h2>
<blockquote>
<p>å’Œmacro_rules! åŠŸèƒ½ç±»ä¼¼ï¼Œä½†æ›´ä¸ºå¼ºå¤§ã€‚</p>
</blockquote>
<h3 id="srclibrså®šä¹‰è¿‡ç¨‹å‡½æ•°å®"><a class="header" href="#srclibrså®šä¹‰è¿‡ç¨‹å‡½æ•°å®">src/lib.rs:å®šä¹‰è¿‡ç¨‹å‡½æ•°å®</a></h3>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œéƒ½æ˜¯å¤„ç†TokenStream</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">mod builder;
mod builder_with_attr;
mod raw_builder;

use proc_macro::TokenStream;
use raw_builder::BuilderContext;
use syn::{parse_macro_input, DeriveInput};

#[proc_macro]
pub fn query(input: TokenStream) -&gt; TokenStream {
    // åªæœ‰ä¿®æ”¹ä»£ç ä¹‹åå†æ¬¡ç¼–è¯‘æ‰ä¼šæ‰§è¡Œ
    println!(&quot;{:#?}&quot;, input);
    &quot;fn hello() { println!(\&quot;Hello world!\&quot;); }&quot;
        .parse()
        .unwrap()
}

#[proc_macro_derive(RawBuilder)]
pub fn derive_raw_builder(input: TokenStream) -&gt; TokenStream {
    // åªæœ‰ä¿®æ”¹ä»£ç ä¹‹åå†æ¬¡ç¼–è¯‘æ‰ä¼šæ‰§è¡Œ
    println!(&quot;{:#?}&quot;, input);
    BuilderContext::render(input).unwrap().parse().unwrap()
}

#[proc_macro_derive(Builder)]
pub fn derive_builder(input: TokenStream) -&gt; TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    println!(&quot;{:#?}&quot;, input);
    builder::BuilderContext::from(input).render().into()
}

#[proc_macro_derive(BuilderWithAttr, attributes(builder))]
pub fn derive_builder_with_attr(input: TokenStream) -&gt; TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    println!(&quot;{:#?}&quot;, input);
    builder_with_attr::BuilderContext::from(input)
        .render()
        .into()
}
</code></pre></pre>
<details id="admonition-tokenstream" class="admonition info">
<summary class="admonition-title">
<p>TokenStream</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-tokenstream"></a></p>
</summary>
<div>
<p>ä½¿ç”¨è€…å¯ä»¥é€šè¿‡ query!(â€¦) æ¥è°ƒç”¨ã€‚æˆ‘ä»¬æ‰“å°ä¼ å…¥çš„ TokenStreamï¼Œ
ç„¶åæŠŠä¸€æ®µåŒ…å«åœ¨å­—ç¬¦ä¸²ä¸­çš„ä»£ç è§£ææˆ TokenStream è¿”å›ã€‚</p>
<p>è¿™é‡Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°ç”¨å­—ç¬¦ä¸²çš„ parse() æ–¹æ³•æ¥è·å¾— TokenStreamï¼Œ
æ˜¯å› ä¸º TokenStream å®ç°äº†  FromStr traitã€‚</p>
</div>
</details>
<h3 id="examplesqueryrsä½¿ç”¨"><a class="header" href="#examplesqueryrsä½¿ç”¨">examples/query.rs:ä½¿ç”¨</a></h3>
<pre><pre class="playground"><code class="language-rust  editable">use macros::query;

fn main() {
    // query!(SELECT * FROM users WHERE age &gt; 10);
    query!(SELECT * FROM users u JOIN (SELECT * from profiles p) WHERE u.id = p.id);
    hello()
}
</code></pre></pre>
<ol>
<li>.parse().unwrap(): å­—ç¬¦ä¸²è‡ªåŠ¨è½¬ä¸ºTokenStreamç±»å‹</li>
</ol>
<pre><code class="language-shell">cargo run --example query &gt; examples/query_output.txt
</code></pre>
<pre><code class="language-shell">TokenStream [
    Ident {
        ident: &quot;SELECT&quot;,
        span: #0 bytes(94..100),
    },
    Punct {
        ch: '*',
        spacing: Alone,
        span: #0 bytes(101..102),
    },
    Ident {
        ident: &quot;FROM&quot;,
        span: #0 bytes(103..107),
    },
    Ident {
        ident: &quot;users&quot;,
        span: #0 bytes(108..113),
    },
    Ident {
        ident: &quot;u&quot;,
        span: #0 bytes(114..115),
    },
    Ident {
        ident: &quot;JOIN&quot;,
        span: #0 bytes(116..120),
    },
    Group {
        delimiter: Parenthesis,
        stream: TokenStream [
            Ident {
                ident: &quot;SELECT&quot;,
                span: #0 bytes(122..128),
            },
            Punct {
                ch: '*',
                spacing: Alone,
                span: #0 bytes(129..130),
            },
            Ident {
                ident: &quot;from&quot;,
                span: #0 bytes(131..135),
            },
            Ident {
                ident: &quot;profiles&quot;,
                span: #0 bytes(136..144),
            },
            Ident {
                ident: &quot;p&quot;,
                span: #0 bytes(145..146),
            },
        ],
        span: #0 bytes(121..147),
    },
    Ident {
        ident: &quot;WHERE&quot;,
        span: #0 bytes(148..153),
    },
    Ident {
        ident: &quot;u&quot;,
        span: #0 bytes(154..155),
    },
    Punct {
        ch: '.',
        spacing: Alone,
        span: #0 bytes(155..156),
    },
    Ident {
        ident: &quot;id&quot;,
        span: #0 bytes(156..158),
    },
    Punct {
        ch: '=',
        spacing: Alone,
        span: #0 bytes(159..160),
    },
    Ident {
        ident: &quot;p&quot;,
        span: #0 bytes(161..162),
    },
    Punct {
        ch: '.',
        spacing: Alone,
        span: #0 bytes(162..163),
    },
    Ident {
        ident: &quot;id&quot;,
        span: #0 bytes(163..165),
    },
]
Hello world!
</code></pre>
<details id="admonition-tokenstreamæ˜¯ä¸€ä¸ªiteratoré‡Œé¢åŒ…å«ä¸€ç³»åˆ—çš„tokentree" class="admonition tip">
<summary class="admonition-title">
<p>TokenStreamæ˜¯ä¸€ä¸ªIteratorï¼Œé‡Œé¢åŒ…å«ä¸€ç³»åˆ—çš„TokenTree</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-tokenstreamæ˜¯ä¸€ä¸ªiteratoré‡Œé¢åŒ…å«ä¸€ç³»åˆ—çš„tokentree"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum TokenTree {
    // ç»„ï¼Œå¦‚æœä»£ç ä¸­åŒ…å«æ‹¬å·ï¼Œæ¯”å¦‚{} [] &lt;&gt; () ï¼Œé‚£ä¹ˆå†…éƒ¨çš„å†…å®¹ä¼šè¢«åˆ†ææˆä¸€ä¸ªGroupï¼ˆç»„ï¼‰
    Group(Group), 
    // æ ‡è¯†ç¬¦
    Ident(Ident),
    // æ ‡ç‚¹ç¬¦å· 
    Punct(Punct),
    // å­—é¢é‡ 
    Literal(Literal), 
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<details id="admonition-group-example" class="admonition info">
<summary class="admonition-title">
<p>Group Example</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-group-example"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust">use macros::query;

fn main() {
    // query!(SELECT * FROM users WHERE age &gt; 10);
    query!(SELECT * FROM users u JOIN (SELECT * from profiles p) WHERE u.id = p.id);
    hello()
}
</code></pre></pre>
</div>
</details>
<h2 id="è¿‡ç¨‹æ´¾ç”Ÿå®-proc_macro_devivederivemacroname"><a class="header" href="#è¿‡ç¨‹æ´¾ç”Ÿå®-proc_macro_devivederivemacroname">è¿‡ç¨‹æ´¾ç”Ÿå®: /#[proc_macro_devive(DeriveMacroName)]</a></h2>
<blockquote>
<p>ç”¨äºç»“æ„ä½“ï¼ˆstructï¼‰ã€æšä¸¾ï¼ˆenumï¼‰ã€è”åˆï¼ˆunionï¼‰ç±»å‹ï¼Œå¯ä¸ºå…¶å®ç°å‡½æ•°æˆ–ç‰¹å¾ï¼ˆTraitï¼‰</p>
</blockquote>
<h3 id="å¸¸ç”¨æ´¾ç”Ÿå®"><a class="header" href="#å¸¸ç”¨æ´¾ç”Ÿå®">å¸¸ç”¨æ´¾ç”Ÿå®</a></h3>
<h4 id="derivedebug"><a class="header" href="#derivedebug">#[derive(Debug)]</a></h4>
<h3 id="åŸå§‹å®ç°builderæ¨¡å¼"><a class="header" href="#åŸå§‹å®ç°builderæ¨¡å¼">åŸå§‹å®ç°builderæ¨¡å¼</a></h3>
<h4 id="æƒ³åˆ°è¾¾åˆ°é“¾å¼è°ƒç”¨çš„æ•ˆæœ"><a class="header" href="#æƒ³åˆ°è¾¾åˆ°é“¾å¼è°ƒç”¨çš„æ•ˆæœ">æƒ³åˆ°è¾¾åˆ°é“¾å¼è°ƒç”¨çš„æ•ˆæœ</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">fn main() {
    let command = Command::builder()
        .executable(&quot;cargo&quot;.to_owned())
        .args(vec![&quot;build&quot;.to_owned(), &quot;--release&quot;.to_owned()])
        .env(vec![])
        .build()
        .unwrap();
    assert!(command.current_dir.is_none());

    let command = Command::builder()
        .executable(&quot;cargo&quot;.to_owned())
        .args(vec![&quot;build&quot;.to_owned(), &quot;--release&quot;.to_owned()])
        .env(vec![])
        .current_dir(&quot;..&quot;.to_owned())
        .build()
        .unwrap();
    assert!(command.current_dir.is_some());
    println!(&quot;{:?}&quot;, command);
}
</code></pre></pre>
<h4 id="å¯ä»¥è¿™æ ·å®šä¹‰"><a class="header" href="#å¯ä»¥è¿™æ ·å®šä¹‰">å¯ä»¥è¿™æ ·å®šä¹‰</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// è¿™æ˜¯command.rsçš„æ´¾ç”Ÿå®å®ç°çš„ä»£ç æ ·å­
#[allow(dead_code)]
#[derive(Debug)]
pub struct Command {
    executable: String,
    args: Vec&lt;String&gt;,
    env: Vec&lt;String&gt;,
    current_dir: Option&lt;String&gt;,
}

#[derive(Debug, Default)]
pub struct CommandBuilder {
    executable: Option&lt;String&gt;,
    args: Option&lt;Vec&lt;String&gt;&gt;,
    env: Option&lt;Vec&lt;String&gt;&gt;,
    current_dir: Option&lt;String&gt;,
}

impl Command {
    pub fn builder() -&gt; CommandBuilder {
        Default::default()
    }
}

impl CommandBuilder {
    pub fn executable(mut self, v: String) -&gt; Self {
        self.executable = Some(v.to_owned());
        self
    }

    pub fn args(mut self, v: Vec&lt;String&gt;) -&gt; Self {
        self.args = Some(v.to_owned());
        self
    }

    pub fn env(mut self, v: Vec&lt;String&gt;) -&gt; Self {
        self.env = Some(v.to_owned());
        self
    }

    pub fn current_dir(mut self, v: String) -&gt; Self {
        self.current_dir = Some(v.to_owned());
        self
    }

    pub fn build(mut self) -&gt; Result&lt;Command, &amp;'static str&gt; {
        Ok(Command {
            executable: self.executable.take().ok_or(&quot;executable must be set&quot;)?,
            args: self.args.take().ok_or(&quot;args must be set&quot;)?,
            env: self.env.take().ok_or(&quot;env must be set&quot;)?,
            current_dir: self.current_dir.take(),
        })
    }
</code></pre></pre>
<h4 id="ä½†æ˜¯æœ‰ç‚¹ç¹çå¯ä»¥ä½¿ç”¨æ´¾ç”Ÿå®æ´¾ç”Ÿå‡ºè¿™äº›ä»£ç "><a class="header" href="#ä½†æ˜¯æœ‰ç‚¹ç¹çå¯ä»¥ä½¿ç”¨æ´¾ç”Ÿå®æ´¾ç”Ÿå‡ºè¿™äº›ä»£ç ">ä½†æ˜¯æœ‰ç‚¹ç¹çï¼Œå¯ä»¥ä½¿ç”¨æ´¾ç”Ÿå®æ´¾ç”Ÿå‡ºè¿™äº›ä»£ç </a></h4>
<h3 id="æ´¾ç”Ÿå®æ€è·¯"><a class="header" href="#æ´¾ç”Ÿå®æ€è·¯">æ´¾ç”Ÿå®æ€è·¯</a></h3>
<h4 id="è¦ç”Ÿæˆçš„ä»£ç æ¨¡ç‰ˆ"><a class="header" href="#è¦ç”Ÿæˆçš„ä»£ç æ¨¡ç‰ˆ">è¦ç”Ÿæˆçš„ä»£ç æ¨¡ç‰ˆ</a></h4>
<p>æŠŠè¾“å…¥çš„ TokenStream æŠ½å–å‡ºæ¥ï¼Œä¹Ÿå°±æ˜¯æŠŠåœ¨ struct çš„å®šä¹‰å†…éƒ¨ï¼Œæ¯ä¸ªåŸŸçš„åå­—åŠå…¶ç±»å‹éƒ½æŠ½å‡ºæ¥ï¼Œç„¶åç”Ÿæˆå¯¹åº”çš„æ–¹æ³•ä»£ç ã€‚</p>
<pre><pre class="playground"><code class="language-rust  editable">impl {{ name }} {
    pub fn builder() -&gt; {{ builder_name }} {
        Default::default()
    }
}

#[derive(Debug, Default)]
pub struct {{ builder_name }} {
    {% for field in fields %}
        {{ field.name }}: Option&lt;{{ field.ty }}&gt;,
    {% endfor %}
}

impl {{ builder_name }} {
    {% for field in fields %}
    pub fn {{ field.name }}(mut self, v: impl Into&lt;{{ field.ty }}&gt;) -&gt; {{ builder_name }} {
        self.{{ field.name }} = Some(v.into());
        self
    }
    {% endfor %}

    pub fn build(self) -&gt; Result&lt;{{ name }}, &amp;'static str&gt; {
        Ok({{ name }} {
            {% for field in fields %}
                {% if field.optional %}
                {{ field.name }}: self.{{ field.name }},
                {% else %}
                {{ field.name }}: self.{{ field.name }}.ok_or(&quot;Build failed: missing {{ field.name }}&quot;)?,
                {% endif %}
            {% endfor %}
        })
    }
}
</code></pre></pre>
<ol>
<li>7-12: è¿™é‡Œçš„ fileds / builder_name æ˜¯æˆ‘ä»¬è¦ä¼ å…¥çš„å‚æ•°ï¼Œæ¯ä¸ª field è¿˜éœ€è¦ name å’Œ ty ä¸¤ä¸ª å±æ€§ï¼Œåˆ†åˆ«å¯¹åº” field çš„åå­—å’Œç±»å‹</li>
<li>25-26: å¯¹äºåŸæœ¬æ˜¯ Option<T> ç±»å‹çš„åŸŸï¼Œè¦é¿å…ç”Ÿæˆ Option<Option>ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ˜¯å¦æ˜¯ Option å•ç‹¬æŠ½å–å‡ºæ¥ï¼Œå¦‚æœæ˜¯ Option<T>ï¼Œé‚£ä¹ˆ ty å°±æ˜¯ Tã€‚æ‰€ä»¥ï¼Œfield è¿˜éœ€è¦ä¸€ä¸ªå± æ€§
optionalã€‚</li>
</ol>
<h4 id="æ„å»ºå¯¹åº”æ•°æ®ç»“æ„"><a class="header" href="#æ„å»ºå¯¹åº”æ•°æ®ç»“æ„">æ„å»ºå¯¹åº”æ•°æ®ç»“æ„</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">/// å¤„ç† jinja æ¨¡æ¿çš„æ•°æ®ç»“æ„ï¼Œåœ¨æ¨¡æ¿ä¸­æˆ‘ä»¬ä½¿ç”¨äº† name / builder_name / fields
#[derive(Template)]
#[template(path = &quot;builder.j2&quot;, escape = &quot;none&quot;)]
pub struct BuilderContext {
    name: String,
    builder_name: String,
    fields: Vec&lt;Fd&gt;,
}
</code></pre></pre>
<h4 id="srclibrs-ä½¿ç”¨æ´¾ç”Ÿå®ä»tokenstreamæŠ½å–å‡ºæƒ³è¦çš„ä¿¡æ¯"><a class="header" href="#srclibrs-ä½¿ç”¨æ´¾ç”Ÿå®ä»tokenstreamæŠ½å–å‡ºæƒ³è¦çš„ä¿¡æ¯">src/lib.rs: ä½¿ç”¨æ´¾ç”Ÿå®ä»TokenStreamæŠ½å–å‡ºæƒ³è¦çš„ä¿¡æ¯</a></h4>
<blockquote>
<p>å¯¹äº derive macroï¼Œè¦ä½¿ç”¨ proce_macro_derive è¿™ä¸ªå®ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ª derive macro å‘½åä¸º Builderã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">#[proc_macro_derive(RawBuilder)]
pub fn derive_raw_builder(input: TokenStream) -&gt; TokenStream {
    // åªæœ‰ä¿®æ”¹ä»£ç ä¹‹åå†æ¬¡ç¼–è¯‘æ‰ä¼šæ‰§è¡Œ
    println!(&quot;{:#?}&quot;, input);
    BuilderContext::render(input).unwrap().parse().unwrap()
}
</code></pre></pre>
<h4 id="examplesraw_commandrs-ä½¿ç”¨è¿™ä¸ªæ´¾ç”Ÿå®æŠ½å–"><a class="header" href="#examplesraw_commandrs-ä½¿ç”¨è¿™ä¸ªæ´¾ç”Ÿå®æŠ½å–">examples/raw_command.rs: ä½¿ç”¨è¿™ä¸ªæ´¾ç”Ÿå®æŠ½å–</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">use macros::RawBuilder;

#[allow(dead_code)]
#[derive(Debug, RawBuilder)]
pub struct Command {
    executable: String,
    args: Vec&lt;String&gt;,
    env: Vec&lt;String&gt;,
    current_dir: Option&lt;String&gt;,
}

fn main() {
    let command = Command::builder()
        .executable(&quot;cargo&quot;.to_owned())
        .args(vec![&quot;build&quot;.to_owned(), &quot;--release&quot;.to_owned()])
        .env(vec![])
        .build()
        .unwrap();
    assert!(command.current_dir.is_none());

    let command = Command::builder()
        .executable(&quot;cargo&quot;.to_owned())
        .args(vec![&quot;build&quot;.to_owned(), &quot;--release&quot;.to_owned()])
        .env(vec![])
        .current_dir(&quot;..&quot;.to_owned())
        .build()
        .unwrap();
    assert!(command.current_dir.is_some());
    println!(&quot;{:?}&quot;, command);
}
</code></pre></pre>
<h4 id="è¿è¡ŒæŸ¥çœ‹è·å–çš„tokenstream"><a class="header" href="#è¿è¡ŒæŸ¥çœ‹è·å–çš„tokenstream">è¿è¡Œï¼ŒæŸ¥çœ‹è·å–çš„TokenStream</a></h4>
<pre><code class="language-shell">cargo run --example raw_command &gt; examples/raw_command_output.txt
</code></pre>
<pre><code class="language-shell">TokenStream [
    Punct {
        ch: '#',
        spacing: Alone,
        span: #0 bytes(25..26),
    },
    Group {
        delimiter: Bracket,
        stream: TokenStream [
            Ident {
                ident: &quot;allow&quot;,
                span: #0 bytes(27..32),
            },
            Group {
                delimiter: Parenthesis,
                stream: TokenStream [
                    Ident {
                        ident: &quot;dead_code&quot;,
                        span: #0 bytes(33..42),
                    },
                ],
                span: #0 bytes(32..43),
            },
        ],
        span: #0 bytes(26..44),
    },
    Ident {
        ident: &quot;pub&quot;,
        span: #0 bytes(74..77),
    },
    Ident {
        ident: &quot;struct&quot;,
        span: #0 bytes(78..84),
    },
    Ident {
        ident: &quot;Command&quot;,
        span: #0 bytes(85..92),
    },
    Group {
        delimiter: Brace,
        stream: TokenStream [
            Ident {
                ident: &quot;executable&quot;,
                span: #0 bytes(99..109),
            },
            Punct {
                ch: ':',
                spacing: Alone,
                span: #0 bytes(109..110),
            },
            Ident {
                ident: &quot;String&quot;,
                span: #0 bytes(111..117),
            },
            Punct {
                ch: ',',
                spacing: Alone,
                span: #0 bytes(117..118),
            },
            Ident {
                ident: &quot;args&quot;,
                span: #0 bytes(123..127),
            },
            Punct {
                ch: ':',
                spacing: Alone,
                span: #0 bytes(127..128),
            },
            Ident {
                ident: &quot;Vec&quot;,
                span: #0 bytes(129..132),
            },
            Punct {
                ch: '&lt;',
                spacing: Alone,
                span: #0 bytes(132..133),
            },
            Ident {
                ident: &quot;String&quot;,
                span: #0 bytes(133..139),
            },
            Punct {
                ch: '&gt;',
                spacing: Joint,
                span: #0 bytes(139..140),
            },
            Punct {
                ch: ',',
                spacing: Alone,
                span: #0 bytes(140..141),
            },
            Ident {
                ident: &quot;env&quot;,
                span: #0 bytes(146..149),
            },
            Punct {
                ch: ':',
                spacing: Alone,
                span: #0 bytes(149..150),
            },
            Ident {
                ident: &quot;Vec&quot;,
                span: #0 bytes(151..154),
            },
            Punct {
                ch: '&lt;',
                spacing: Alone,
                span: #0 bytes(154..155),
            },
            Ident {
                ident: &quot;String&quot;,
                span: #0 bytes(155..161),
            },
            Punct {
                ch: '&gt;',
                spacing: Joint,
                span: #0 bytes(161..162),
            },
            Punct {
                ch: ',',
                spacing: Alone,
                span: #0 bytes(162..163),
            },
            Ident {
                ident: &quot;current_dir&quot;,
                span: #0 bytes(168..179),
            },
            Punct {
                ch: ':',
                spacing: Alone,
                span: #0 bytes(179..180),
            },
            Ident {
                ident: &quot;Option&quot;,
                span: #0 bytes(181..187),
            },
            Punct {
                ch: '&lt;',
                spacing: Alone,
                span: #0 bytes(187..188),
            },
            Ident {
                ident: &quot;String&quot;,
                span: #0 bytes(188..194),
            },
            Punct {
                ch: '&gt;',
                spacing: Joint,
                span: #0 bytes(194..195),
            },
            Punct {
                ch: ',',
                spacing: Alone,
                span: #0 bytes(195..196),
            },
        ],
        span: #0 bytes(93..198),
    },
]
Command { executable: &quot;cargo&quot;, args: [&quot;build&quot;, &quot;--release&quot;], env: [], current_dir: Some(&quot;..&quot;) }
</code></pre>
<div id="admonition-æ‰“å°ä¿¡æ¯è¯´æ˜" class="admonition info">
<div class="admonition-title">
<p>æ‰“å°ä¿¡æ¯è¯´æ˜</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-æ‰“å°ä¿¡æ¯è¯´æ˜"></a></p>
</div>
<div>
<ol>
<li>
<p>é¦–å…ˆæœ‰ä¸€ä¸ª Groupï¼ŒåŒ…å«äº† #[allow(dead_code)] å±æ€§çš„ä¿¡æ¯ã€‚å› ä¸ºæˆ‘ä»¬ç°åœ¨æ‹¿åˆ° çš„ derive ä¸‹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æ‰€æœ‰ä¸å±äº #[derive(â€¦)] çš„å±æ€§ï¼Œéƒ½ä¼šè¢«æ”¾å…¥ TokenStream ä¸­ã€‚</p>
</li>
<li>
<p>ä¹‹åæ˜¯ pub / struct / Command ä¸‰ä¸ª identã€‚</p>
</li>
<li>
<p>éšååˆæ˜¯ä¸€ä¸ª Groupï¼ŒåŒ…å«äº†æ¯ä¸ª field çš„ä¿¡æ¯ã€‚æˆ‘ä»¬çœ‹åˆ°ï¼Œfield ä¹‹é—´ç”¨é€—å·è¿™ä¸ª Punct åˆ†éš”ï¼Œfield çš„åå­—å’Œç±»å‹åˆæ˜¯é€šè¿‡å†’å·è¿™ä¸ª Punct åˆ†éš”ã€‚è€Œç±»å‹ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ª Identï¼Œå¦‚ Stringï¼Œæˆ–è€…ä¸€ç³»åˆ— Ident / Punctï¼Œå¦‚ Vec / &lt; / String / &gt;ã€‚</p>
</li>
</ol>
</div>
</div>
<h4 id="srcraw_builderrs-ä½¿ç”¨anyhowä¸askamaæŠ½å–tokenstreamä¸­çš„ä¿¡æ¯"><a class="header" href="#srcraw_builderrs-ä½¿ç”¨anyhowä¸askamaæŠ½å–tokenstreamä¸­çš„ä¿¡æ¯">src/raw_builder.rs: ä½¿ç”¨anyhowä¸askamaæŠ½å–TokenStreamä¸­çš„ä¿¡æ¯</a></h4>
<blockquote>
<p>æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼ŒæŠŠè¿™ä¸ª TokenStream ä¸­çš„ struct åå­—ï¼Œä»¥åŠæ¯ä¸ª field çš„åå­—å’Œç±»å‹æ‹¿å‡ºæ¥ã€‚
å¦‚æœç±»å‹æ˜¯ Option<T>ï¼Œé‚£ä¹ˆæŠŠ T æ‹¿å‡ºæ¥ï¼ŒæŠŠ optional è®¾ç½®ä¸º trueã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">use anyhow::Result;
use askama::Template;
use proc_macro::{Ident, TokenStream, TokenTree};
use std::collections::VecDeque;

/// å¤„ç† jinja æ¨¡æ¿çš„æ•°æ®ç»“æ„ï¼Œåœ¨æ¨¡æ¿ä¸­æˆ‘ä»¬ä½¿ç”¨äº† name / builder_name / fields
#[derive(Template)]
#[template(path = &quot;builder.j2&quot;, escape = &quot;none&quot;)]
pub struct BuilderContext {
    name: String,
    builder_name: String,
    fields: Vec&lt;Fd&gt;,
}

/// æè¿° struct çš„æ¯ä¸ª field
#[derive(Debug, Default)]
struct Fd {
    name: String,
    ty: String,
    optional: bool,
}
</code></pre></pre>
<h4 id="templatesbuilderj2-ä¸Šé¢askamaç”¨åˆ°çš„jinja2æ¨¡ç‰ˆ"><a class="header" href="#templatesbuilderj2-ä¸Šé¢askamaç”¨åˆ°çš„jinja2æ¨¡ç‰ˆ">templates/builder.j2: ä¸Šé¢askamaç”¨åˆ°çš„jinja2æ¨¡ç‰ˆ</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">impl {{ name }} {
    pub fn builder() -&gt; {{ builder_name }} {
        Default::default()
    }
}

#[derive(Debug, Default)]
pub struct {{ builder_name }} {
    {% for field in fields %}
        {{ field.name }}: Option&lt;{{ field.ty }}&gt;,
    {% endfor %}
}

impl {{ builder_name }} {
    {% for field in fields %}
    pub fn {{ field.name }}(mut self, v: impl Into&lt;{{ field.ty }}&gt;) -&gt; {{ builder_name }} {
        self.{{ field.name }} = Some(v.into());
        self
    }
    {% endfor %}

    pub fn build(self) -&gt; Result&lt;{{ name }}, &amp;'static str&gt; {
        Ok({{ name }} {
            {% for field in fields %}
                {% if field.optional %}
                {{ field.name }}: self.{{ field.name }},
                {% else %}
                {{ field.name }}: self.{{ field.name }}.ok_or(&quot;Build failed: missing {{ field.name }}&quot;)?,
                {% endif %}
            {% endfor %}
        })
    }
}
</code></pre></pre>
<h4 id="srcraw_builderrs-å®ç°å¯¹åº”æŠ½å–æ–¹æ³•"><a class="header" href="#srcraw_builderrs-å®ç°å¯¹åº”æŠ½å–æ–¹æ³•">src/raw_builder.rs: å®ç°å¯¹åº”æŠ½å–æ–¹æ³•</a></h4>
<pre><pre class="playground"><code class="language-rust  editable">impl Fd {
    /// name å’Œ field éƒ½æ˜¯é€šè¿‡å†’å· Punct åˆ‡åˆ†å‡ºæ¥çš„ TokenTree åˆ‡ç‰‡
    pub fn new(name: &amp;[TokenTree], ty: &amp;[TokenTree]) -&gt; Self {
        // æŠŠç±»ä¼¼ Ident(&quot;Option&quot;), Punct('&lt;'), Ident(&quot;String&quot;), Punct('&gt;) çš„ ty
        // æ”¶é›†æˆä¸€ä¸ª String åˆ—è¡¨ï¼Œå¦‚ vec![&quot;Option&quot;, &quot;&lt;&quot;, &quot;String&quot;, &quot;&gt;&quot;]
        let ty = ty
            .iter()
            .map(|v| match v {
                TokenTree::Ident(n) =&gt; n.to_string(),
                TokenTree::Punct(p) =&gt; p.as_char().to_string(),
                e =&gt; panic!(&quot;Expect ident, got {:?}&quot;, e),
            })
            .collect::&lt;Vec&lt;_&gt;&gt;();
        // å†’å·å‰æœ€åä¸€ä¸ª TokenTree æ˜¯ field çš„åå­—
        // æ¯”å¦‚ï¼šexecutable: String,
        // æ³¨æ„è¿™é‡Œä¸åº”è¯¥ç”¨ name[0]ï¼Œå› ä¸ºæœ‰å¯èƒ½æ˜¯ pub executable: String
        // ç”šè‡³ï¼Œå¸¦ attributes çš„ fieldï¼Œ
        // æ¯”å¦‚ï¼š#[builder(hello = world)] pub executable: String
        match name.last() {
            Some(TokenTree::Ident(name)) =&gt; {
                // å¦‚æœ ty ç¬¬ 0 é¡¹æ˜¯ Optionï¼Œé‚£ä¹ˆä»ç¬¬äºŒé¡¹å–åˆ°å€’æ•°ç¬¬ä¸€é¡¹
                // å–å®Œåä¸Šé¢çš„ä¾‹å­ä¸­çš„ ty ä¼šå˜æˆ [&quot;String&quot;]ï¼Œoptiona = true
                let (ty, optional) = if ty[0].as_str() == &quot;Option&quot; {
                    (&amp;ty[2..ty.len() - 1], true)
                } else {
                    (&amp;ty[..], false)
                };
                Self {
                    name: name.to_string(),
                    ty: ty.join(&quot;&quot;), // æŠŠ ty join æˆå­—ç¬¦ä¸²
                    optional,
                }
            }
            e =&gt; panic!(&quot;Expect ident, got {:?}&quot;, e),
        }
    }
}

impl BuilderContext {
    /// ä» TokenStream ä¸­æå–ä¿¡æ¯ï¼Œæ„å»º BuilderContext
    fn new(input: TokenStream) -&gt; Self {
        let (name, input) = split(input);
        let fields = get_struct_fields(input);
        Self {
            builder_name: format!(&quot;{}Builder&quot;, name),
            name: name.to_string(),
            fields,
        }
    }

    /// æŠŠæ¨¡æ¿æ¸²æŸ“æˆå­—ç¬¦ä¸²ä»£ç 
    pub fn render(input: TokenStream) -&gt; Result&lt;String&gt; {
        let template = Self::new(input);
        Ok(template.render()?)
    }
}

/// æŠŠ TokenStream åˆ†å‡º struct çš„åå­—ï¼Œå’ŒåŒ…å« fields çš„ TokenStream
fn split(input: TokenStream) -&gt; (Ident, TokenStream) {
    let mut input = input.into_iter().collect::&lt;VecDeque&lt;_&gt;&gt;();
    // ä¸€ç›´å¾€åæ‰¾ï¼Œæ‰¾åˆ° struct åœä¸‹æ¥
    while let Some(item) = input.pop_front() {
        if let TokenTree::Ident(v) = item {
            if v.to_string() == &quot;struct&quot; {
                break;
            }
        }
    }

    // struct åé¢ï¼Œåº”è¯¥æ˜¯ struct name
    let ident;
    if let Some(TokenTree::Ident(v)) = input.pop_front() {
        ident = v;
    } else {
        panic!(&quot;Didn't find struct name&quot;);
    }

    // struct åé¢å¯èƒ½è¿˜æœ‰è‹¥å¹² TokenTreeï¼Œæˆ‘ä»¬ä¸ç®¡ï¼Œä¸€è·¯æ‰¾åˆ°ç¬¬ä¸€ä¸ª Group
    let mut group = None;
    for item in input {
        if let TokenTree::Group(g) = item {
            group = Some(g);
            break;
        }
    }

    (ident, group.expect(&quot;Didn't find field group&quot;).stream())
}

/// ä»åŒ…å« fields çš„ TokenStream ä¸­åˆ‡å‡ºæ¥ä¸€ä¸ªä¸ª Fd
fn get_struct_fields(input: TokenStream) -&gt; Vec&lt;Fd&gt; {
    let input = input.into_iter().collect::&lt;Vec&lt;_&gt;&gt;();
    input
        .split(|v| match v {
            // å…ˆç”¨ ',' åˆ‡å‡ºæ¥ä¸€ä¸ªä¸ªåŒ…å« field æ‰€æœ‰ä¿¡æ¯çš„ &amp;[TokenTree]
            TokenTree::Punct(p) =&gt; p.as_char() == ',',
            _ =&gt; false,
        })
        .map(|tokens| {
            tokens
                .split(|v| match v {
                    // å†ç”¨ ':' æŠŠ &amp;[TokenTree] åˆ‡æˆ [&amp;[TokenTree], &amp;[TokenTree]]
                    // å®ƒä»¬åˆ†åˆ«å¯¹åº”åå­—å’Œç±»å‹
                    TokenTree::Punct(p) =&gt; p.as_char() == ':',
                    _ =&gt; false,
                })
                .collect::&lt;Vec&lt;_&gt;&gt;()
        })
        // æ­£å¸¸æƒ…å†µä¸‹ï¼Œåº”è¯¥å¾—åˆ° [&amp;[TokenTree], &amp;[TokenTree]]ï¼Œå¯¹äºåˆ‡å‡ºæ¥é•¿åº¦ä¸ä¸º 2 çš„ç»Ÿç»Ÿè¿‡æ»¤æ‰
        .filter(|tokens| tokens.len() == 2)
        // ä½¿ç”¨ Fd::new åˆ›å»ºå‡ºæ¯ä¸ª Fd
        .map(|tokens| Fd::new(tokens[0], tokens[1]))
        .collect()
}
</code></pre></pre>
<div id="admonition-tip" class="admonition tip">
<div class="admonition-title">
<p>Tip</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-tip"></a></p>
</div>
<div>
<p>å¯ä»¥å¯¹ç€æ‰“å°å‡ºæ¥çš„ TokenStream å’Œåˆšæ‰çš„åˆ†æè¿›è¡Œç†è§£ã€‚
æ ¸å¿ƒçš„å°±æ˜¯ get_struct_fields() æ–¹æ³•ï¼Œå¦‚æœè§‰å¾—éš¾æ‡‚ï¼Œ
å¯ä»¥æƒ³æƒ³å¦‚æœè¦æŠŠä¸€ä¸ª a=1,b=2 çš„å­—ç¬¦ä¸²åˆ‡æˆ [[a, 1], [b, 2]] è¯¥æ€ä¹ˆåšï¼Œå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p>
</div>
</div>
<h3 id="ä½¿ç”¨synquoteå¯ä»¥ä¸ç”¨è‡ªå·±å®šä¹‰æ¨¡ç‰ˆ"><a class="header" href="#ä½¿ç”¨synquoteå¯ä»¥ä¸ç”¨è‡ªå·±å®šä¹‰æ¨¡ç‰ˆ">ä½¿ç”¨syn/quoteå¯ä»¥ä¸ç”¨è‡ªå·±å®šä¹‰æ¨¡ç‰ˆ</a></h3>
<blockquote>
<p>è¯¦è§ä¸Šæ–¹å¯¹æ¯”å›¾</p>
</blockquote>
<h2 id="è¿‡ç¨‹å±æ€§å®-proc_macro_derivemacro_name-attributesattr_name"><a class="header" href="#è¿‡ç¨‹å±æ€§å®-proc_macro_derivemacro_name-attributesattr_name">è¿‡ç¨‹å±æ€§å®: proc_macro_derive(macro_name, attributes(attr_name))</a></h2>
<blockquote>
<p>ç”¨äºå±æ€§å®ï¼Œ ç”¨åœ¨ç»“æ„ä½“ã€å­—æ®µã€å‡½æ•°ç­‰åœ°æ–¹ï¼Œä¸ºå…¶æŒ‡å®šå±æ€§ç­‰åŠŸèƒ½, ç±»ä¼¼pythonçš„è®¡ç®—å±æ€§</p>
</blockquote>
<details id="admonition-å®šä¹‰ç»“æ„ä½“æ—¶åœ¨æŸä¸ªå­—æ®µä¸Šæ–¹ä½¿ç”¨å¯¹åº”attr_name" class="admonition tip">
<summary class="admonition-title">
<p>å®šä¹‰ç»“æ„ä½“æ—¶åœ¨æŸä¸ªå­—æ®µä¸Šæ–¹ä½¿ç”¨å¯¹åº”attr_name</p>
<p><a class="admonition-anchor-link" href="4_macros.html#admonition-å®šä¹‰ç»“æ„ä½“æ—¶åœ¨æŸä¸ªå­—æ®µä¸Šæ–¹ä½¿ç”¨å¯¹åº”attr_name"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[allow(dead_code)]
#[derive(Debug, BuilderWithAttr)]
pub struct Command {
    executable: String,
    #[builder(each = &quot;arg&quot;)]
    args: Vec&lt;String&gt;,
    #[builder(each = &quot;env&quot;, default = &quot;vec![]&quot;)]
    env: Vec&lt;String&gt;,
    current_dir: Option&lt;String&gt;,
}
<span class="boring">}
</span></code></pre></pre>
</div>
</details>
<h3 id="ä½¿ç”¨synquoteå®šä¹‰å±æ€§å®"><a class="header" href="#ä½¿ç”¨synquoteå®šä¹‰å±æ€§å®">ä½¿ç”¨syn/quoteå®šä¹‰å±æ€§å®</a></h3>
<blockquote>
<p>è¯¦è§ä¸Šæ–¹å¯¹æ¯”å›¾</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="v-å¹¶å‘ä¸å¼‚æ­¥"><a class="header" href="#v-å¹¶å‘ä¸å¼‚æ­¥">V å¹¶å‘ä¸å¼‚æ­¥</a></h1>
<!--ts-->
<ul>
<li><a href="5_concurrency_async.html#v-%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%BC%82%E6%AD%A5">V å¹¶å‘ä¸å¼‚æ­¥</a>
<ul>
<li><a href="5_concurrency_async.html#%E5%8C%BA%E5%88%86%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C">åŒºåˆ†å¹¶å‘ä¸å¹¶è¡Œ</a></li>
<li><a href="5_concurrency_async.html#%E5%B9%B6%E5%8F%91%E7%9A%84%E9%9A%BE%E7%82%B9%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E5%92%8C%E6%A0%B8%E5%BF%83">å¹¶å‘çš„éš¾ç‚¹ã€å·¥ä½œæ¨¡å¼å’Œæ ¸å¿ƒ</a></li>
<li><a href="5_concurrency_async.html#%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD">å¹¶å‘åŸè¯­</a>
<ul>
<li><a href="5_concurrency_async.html#atomic">Atomic</a>
<ul>
<li><a href="5_concurrency_async.html#%E4%BB%8E%E9%94%81%E5%BC%80%E5%A7%8B">ä»é”å¼€å§‹</a></li>
<li><a href="5_concurrency_async.html#atomiccas">Atomic+CAS</a></li>
<li><a href="5_concurrency_async.html#ordering">ordering</a></li>
</ul>
</li>
<li><a href="5_concurrency_async.html#mutex">Mutex</a></li>
<li><a href="5_concurrency_async.html#atomic%E5%92%8Cmutex%E7%9A%84%E8%81%94%E7%B3%BB">Atomicå’ŒMutexçš„è”ç³»</a></li>
<li><a href="5_concurrency_async.html#condvar">Condvar</a>
<ul>
<li><a href="5_concurrency_async.html#atomic%E5%92%8Cmutex%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3dag%E6%A8%A1%E5%BC%8F">Atomicå’ŒMutexä¸èƒ½è§£å†³DAGæ¨¡å¼</a></li>
<li><a href="5_concurrency_async.html#condvar%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8">condvarä»‹ç»ä¸ä½¿ç”¨</a></li>
</ul>
</li>
<li><a href="5_concurrency_async.html#channel">Channel</a></li>
<li><a href="5_concurrency_async.html#actor">Actor</a></li>
<li><a href="5_concurrency_async.html#%E5%B0%8F%E7%BB%93%E4%B8%80%E4%B8%8B%E5%90%84%E7%A7%8D%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯</a></li>
</ul>
</li>
<li><a href="5_concurrency_async.html#%E8%87%AA%E5%B7%B1%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%9F%BA%E6%9C%AC%E7%9A%84mpsc-channel">è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC Channel</a>
<ul>
<li><a href="5_concurrency_async.html#%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E7%9A%84%E8%AE%BE%E8%AE%A1">æµ‹è¯•é©±åŠ¨çš„è®¾è®¡</a></li>
<li><a href="5_concurrency_async.html#%E5%AE%9E%E7%8E%B0-mpsc-channel">å®ç° MPSC channel</a></li>
<li><a href="5_concurrency_async.html#%E5%9B%9E%E9%A1%BE%E6%B5%8B%E8%AF%95%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91">å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘</a></li>
</ul>
</li>
<li><a href="5_concurrency_async.html#%E5%B9%B6%E5%8F%91%E5%8E%9F%E8%AF%AD%E4%B8%8E%E5%BC%82%E6%AD%A5%E7%9A%84%E5%85%B3%E7%B3%BB">å¹¶å‘åŸè¯­ä¸å¼‚æ­¥çš„å…³ç³»</a></li>
<li><a href="5_concurrency_async.html#future">Future</a>
<ul>
<li><a href="5_concurrency_async.html#actor%E6%98%AF%E6%9C%89%E6%A0%88%E5%8D%8F%E7%A8%8Bfuture%E6%98%AF%E6%97%A0%E6%A0%88%E5%8D%8F%E7%A8%8B">actoræ˜¯æœ‰æ ˆåç¨‹ï¼ŒFutureæ˜¯æ— æ ˆåç¨‹</a></li>
<li><a href="5_concurrency_async.html#rust%E7%9A%84future">Rustçš„Future</a></li>
<li><a href="5_concurrency_async.html#future%E5%92%8Casyncawait">Futureå’Œasync/await</a></li>
<li><a href="5_concurrency_async.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-future">ä¸ºä»€ä¹ˆéœ€è¦ Futureï¼Ÿ</a></li>
<li><a href="5_concurrency_async.html#%E6%B7%B1%E5%85%A5%E6%80%9D%E8%B7%AF">æ·±å…¥æ€è·¯</a></li>
<li><a href="5_concurrency_async.html#%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3">æ·±å…¥äº†è§£</a></li>
<li><a href="5_concurrency_async.html#executor">executor</a></li>
<li><a href="5_concurrency_async.html#reactor-pattern">reactor pattern</a></li>
<li><a href="5_concurrency_async.html#%E6%80%8E%E4%B9%88%E7%94%A8-future-%E5%81%9A%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86">æ€ä¹ˆç”¨ Future åšå¼‚æ­¥å¤„ç†ï¼Ÿ</a></li>
<li><a href="5_concurrency_async.html#%E4%BD%BF%E7%94%A8-future-%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">ä½¿ç”¨ Future çš„æ³¨æ„äº‹é¡¹</a></li>
<li><a href="5_concurrency_async.html#%E5%AF%B9%E6%AF%94%E7%BA%BF%E7%A8%8B%E5%AD%A6%E4%B9%A0future">å¯¹æ¯”çº¿ç¨‹å­¦ä¹ Future</a></li>
<li><a href="5_concurrency_async.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%A0%87%E5%87%86%E5%BA%93%E7%9A%84-mutex-%E4%B8%8D%E8%83%BD%E8%B7%A8%E8%B6%8A-await">ä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„ Mutex ä¸èƒ½è·¨è¶Š awaitï¼Ÿ</a></li>
</ul>
</li>
<li><a href="5_concurrency_async.html#asyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84">async/awaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</a>
<ul>
<li><a href="5_concurrency_async.html#contextpin">Contextã€Pin</a></li>
<li><a href="5_concurrency_async.html#contextwaker-waker-%E7%9A%84%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6">Context::waker: Waker çš„è°ƒç”¨æœºåˆ¶</a></li>
<li><a href="5_concurrency_async.html#async-%E7%A9%B6%E7%AB%9F%E7%94%9F%E6%88%90%E4%BA%86%E4%BB%80%E4%B9%88">async ç©¶ç«Ÿç”Ÿæˆäº†ä»€ä¹ˆï¼Ÿ</a></li>
<li><a href="5_concurrency_async.html#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-pin">ä¸ºä»€ä¹ˆéœ€è¦ Pinï¼Ÿ</a></li>
<li><a href="5_concurrency_async.html#%E8%87%AA%E5%BC%95%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">è‡ªå¼•ç”¨æ•°æ®ç»“æ„</a></li>
<li><a href="5_concurrency_async.html#unpin">Unpin</a></li>
<li><a href="5_concurrency_async.html#-box%E7%9A%84unpin%E6%80%9D%E8%80%83">### Boxçš„Unpinæ€è€ƒ</a></li>
<li><a href="5_concurrency_async.html#async-%E4%BA%A7%E7%94%9F%E7%9A%84-future-%E7%A9%B6%E7%AB%9F%E6%98%AF%E4%BB%80%E4%B9%88%E7%B1%BB%E5%9E%8B">async äº§ç”Ÿçš„ Future ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</a></li>
<li><a href="5_concurrency_async.html#%E5%9B%9E%E9%A1%BE%E6%95%B4%E7%90%86future%E7%9A%84contextpinunpin%E4%BB%A5%E5%8F%8Aasyncawait">å›é¡¾æ•´ç†Futureçš„Contextã€Pin/Unpinï¼Œä»¥åŠasync/await</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Wed Oct  5 10:43:59 UTC 2022 -->
<!--te-->
<h2 id="åŒºåˆ†å¹¶å‘ä¸å¹¶è¡Œ"><a class="header" href="#åŒºåˆ†å¹¶å‘ä¸å¹¶è¡Œ">åŒºåˆ†å¹¶å‘ä¸å¹¶è¡Œ</a></h2>
<details id="admonition-å†æ¬¡åŒºåˆ†å¹¶å‘ä¸å¹¶è¡Œ" class="admonition info">
<summary class="admonition-title">
<p>å†æ¬¡åŒºåˆ†å¹¶å‘ä¸å¹¶è¡Œ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å†æ¬¡åŒºåˆ†å¹¶å‘ä¸å¹¶è¡Œ"></a></p>
</summary>
<div>
<p>å¾ˆå¤šäººåˆ†ä¸æ¸…å¹¶å‘å’Œå¹¶è¡Œçš„æ¦‚å¿µï¼ŒRob Pikeï¼ŒGolang çš„åˆ›å§‹äººä¹‹ä¸€ï¼Œå¯¹æ­¤æœ‰å¾ˆç²¾è¾Ÿå¾ˆç›´è§‚çš„è§£é‡Šï¼š</p>
<p>Concurrency is about dealing with lots of things at once. Parallelism is about doing lots of things at once.</p>
<ul>
<li>å¹¶å‘æ˜¯ä¸€ç§åŒæ—¶å¤„ç†å¾ˆå¤šäº‹æƒ…çš„èƒ½åŠ›</li>
<li>å¹¶è¡Œæ˜¯ä¸€ç§åŒæ—¶æ‰§è¡Œå¾ˆå¤šäº‹æƒ…çš„æ‰‹æ®µã€‚</li>
</ul>
<p>æˆ‘ä»¬æŠŠè¦åšçš„äº‹æƒ…æ”¾åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ï¼Œæˆ–è€…å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ä¸­å¤„ç†ï¼Œè¿™æ˜¯å¹¶å‘çš„èƒ½åŠ›ã€‚åœ¨å¤šæ ¸å¤š CPU çš„æœºå™¨ä¸ŠåŒæ—¶è¿è¡Œè¿™äº›çº¿ç¨‹æˆ–è€…å¼‚æ­¥ä»»åŠ¡ï¼Œæ˜¯å¹¶è¡Œçš„æ‰‹æ®µã€‚å¯ä»¥è¯´ï¼Œå¹¶å‘æ˜¯ä¸ºå¹¶è¡Œèµ‹èƒ½ã€‚å½“æˆ‘ä»¬å…·å¤‡äº†å¹¶å‘çš„èƒ½åŠ›ï¼Œå¹¶è¡Œå°±æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…ã€‚</p>
</div>
</details>
<h2 id="å¹¶å‘çš„éš¾ç‚¹å·¥ä½œæ¨¡å¼å’Œæ ¸å¿ƒ"><a class="header" href="#å¹¶å‘çš„éš¾ç‚¹å·¥ä½œæ¨¡å¼å’Œæ ¸å¿ƒ">å¹¶å‘çš„éš¾ç‚¹ã€å·¥ä½œæ¨¡å¼å’Œæ ¸å¿ƒ</a></h2>
<details id="admonition-å¤„ç†å¹¶å‘çš„éš¾ç‚¹åœ¨å“ªé‡Œè¡ç”Ÿå‡ºå“ªäº›å·¥ä½œæ¨¡å¼æ ¸å¿ƒæ˜¯ä»€ä¹ˆ" class="admonition info">
<summary class="admonition-title">
<p>å¤„ç†å¹¶å‘çš„éš¾ç‚¹åœ¨å“ªé‡Œï¼Ÿè¡ç”Ÿå‡ºå“ªäº›å·¥ä½œæ¨¡å¼ï¼Ÿæ ¸å¿ƒæ˜¯ä»€ä¹ˆ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å¤„ç†å¹¶å‘çš„éš¾ç‚¹åœ¨å“ªé‡Œè¡ç”Ÿå‡ºå“ªäº›å·¥ä½œæ¨¡å¼æ ¸å¿ƒæ˜¯ä»€ä¹ˆ"></a></p>
</summary>
<div>
<p>å…¶å®æœ‰å¾ˆå¤šå’Œå¹¶å‘ç›¸å…³çš„å†…å®¹ã€‚æ¯”å¦‚ç”¨ std::thread æ¥åˆ›å»ºçº¿ç¨‹ã€ç”¨ std::sync ä¸‹çš„å¹¶å‘åŸè¯­ï¼ˆMutexï¼‰æ¥å¤„ç†å¹¶å‘è¿‡ç¨‹ä¸­çš„åŒæ­¥é—®é¢˜ã€ç”¨ Send/Sync trait æ¥ä¿è¯å¹¶å‘çš„å®‰å…¨ç­‰ç­‰ã€‚</p>
<p>åœ¨å¤„ç†å¹¶å‘çš„è¿‡ç¨‹ä¸­ï¼Œéš¾ç‚¹å¹¶ä¸åœ¨äºå¦‚ä½•åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥åˆ†é…å·¥ä½œï¼Œåœ¨äºå¦‚ä½•åœ¨è¿™äº›å¹¶å‘çš„ä»»åŠ¡ä¸­è¿›è¡ŒåŒæ­¥ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹å¹¶å‘çŠ¶æ€ä¸‹å‡ ç§å¸¸è§çš„å·¥ä½œæ¨¡å¼ï¼šè‡ªç”±ç«äº‰æ¨¡å¼ã€map/reduce æ¨¡å¼ã€DAG æ¨¡å¼ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/33%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F-4950283.jpg" alt="33ï½œå¹¶å‘å¤„ç†ï¼ˆä¸Šï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
<hr />
<ol>
<li>åœ¨è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹ï¼Œå¤šä¸ªå¹¶å‘ä»»åŠ¡ä¼šç«äº‰åŒä¸€ä¸ªä¸´ç•ŒåŒºçš„è®¿é—®æƒã€‚ä»»åŠ¡ä¹‹é—´åœ¨ä½•æ—¶ã€ä»¥ä½•ç§æ–¹å¼å»è®¿é—®ä¸´ç•ŒåŒºï¼Œæ˜¯ä¸ç¡®å®šçš„ï¼Œæˆ–è€…è¯´æ˜¯æœ€ä¸ºçµæ´»çš„ï¼Œåªè¦åœ¨è¿›å…¥ä¸´ç•ŒåŒºæ—¶è·å¾—ç‹¬å è®¿é—®å³å¯ã€‚</li>
</ol>
<ul>
<li>Atomic &amp; Mutex</li>
</ul>
<ol start="2">
<li>åœ¨è‡ªç”±ç«äº‰çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é™åˆ¶å¹¶å‘çš„åŒæ­¥æ¨¡å¼ï¼Œå…¸å‹çš„æœ‰ map/reduce æ¨¡å¼å’Œ DAG æ¨¡å¼ï¼š</li>
</ol>
<ul>
<li>map/reduce æ¨¡å¼ï¼ŒæŠŠå·¥ä½œæ‰“æ•£ï¼ŒæŒ‰ç…§ç›¸åŒçš„å¤„ç†å®Œæˆåï¼Œå†æŒ‰ç…§ä¸€å®šçš„é¡ºåºå°†ç»“æœç»„ç»‡èµ·æ¥ï¼›</li>
<li>DAG æ¨¡å¼ï¼ŒæŠŠå·¥ä½œåˆ‡æˆä¸ç›¸äº¤çš„ã€æœ‰ä¾èµ–å…³ç³»çš„å­ä»»åŠ¡ï¼Œç„¶åæŒ‰ä¾èµ–å…³ç³»å¹¶å‘æ‰§è¡Œã€‚</li>
</ul>
<blockquote>
<p>è¿™ä¸‰ç§åŸºæœ¬æ¨¡å¼ç»„åˆèµ·æ¥ï¼Œå¯ä»¥å¤„ç†éå¸¸å¤æ‚çš„å¹¶å‘åœºæ™¯ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬å¤„ç†å¤æ‚é—®é¢˜çš„æ—¶å€™ï¼Œåº”è¯¥å…ˆå˜æ¸…å…¶è„‰ç»œï¼Œç”¨åˆ†æ²»çš„æ€æƒ³æŠŠé—®é¢˜æ‹†è§£æˆæ­£äº¤çš„å­é—®é¢˜ï¼Œç„¶åç»„åˆåˆé€‚çš„å¹¶å‘æ¨¡å¼æ¥å¤„ç†è¿™äº›å­é—®é¢˜ã€‚</p>
</blockquote>
</div>
</details>
<h2 id="å¹¶å‘åŸè¯­"><a class="header" href="#å¹¶å‘åŸè¯­">å¹¶å‘åŸè¯­</a></h2>
<details id="admonition-åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢" class="admonition info">
<summary class="admonition-title">
<p>åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåï¼Œéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢"></a></p>
</summary>
<div>
<p>åœ¨è¿™äº›å¹¶å‘æ¨¡å¼èƒŒåï¼Œéƒ½æœ‰å“ªäº›å¹¶å‘åŸè¯­å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨å‘¢ï¼š</p>
<ol>
<li>Atomic</li>
<li>Mutex</li>
<li>Condvar</li>
<li>Channel </li>
<li>Actor model</li>
</ol>
</div>
</details>
<h3 id="atomic"><a class="header" href="#atomic">Atomic</a></h3>
<p>Atomic æ˜¯æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºç¡€ï¼Œå®ƒä¸ºå¹¶å‘ä»»åŠ¡çš„åŒæ­¥å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚</p>
<h4 id="ä»é”å¼€å§‹"><a class="header" href="#ä»é”å¼€å§‹">ä»é”å¼€å§‹</a></h4>
<details id="admonition-äº’æ–¥é”ä¼šå¯¼è‡´ä¹±åº" class="admonition info">
<summary class="admonition-title">
<p>äº’æ–¥é”ä¼šå¯¼è‡´ä¹±åº</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-äº’æ–¥é”ä¼šå¯¼è‡´ä¹±åº"></a></p>
</summary>
<div>
<p>è°ˆåˆ°åŒæ­¥ï¼Œç›¸ä¿¡ä½ é¦–å…ˆä¼šæƒ³åˆ°é”ï¼Œæ‰€ä»¥åœ¨å…·ä½“ä»‹ç» atomic ä¹‹å‰ï¼Œæˆ‘ä»¬ä»æœ€åŸºæœ¬çš„é”è¯¥å¦‚ä½•å®ç°è®²èµ·ã€‚è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨äº’æ–¥é”æ¥ä¿æŠ¤æŸä¸ªä¸´ç•ŒåŒºï¼Œä½¿è¿›å…¥ä¸´ç•ŒåŒºçš„ä»»åŠ¡æ‹¥æœ‰ç‹¬å è®¿é—®çš„æƒé™ã€‚</p>
<blockquote>
<p>ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œåœ¨è·å–è¿™æŠŠé”çš„æ—¶å€™ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œå°±ä¸€ç›´æ­»å¾ªç¯ï¼Œç›´åˆ°æ‹¿åˆ°é”ä¸ºæ­¢ï¼ˆä»£ç ï¼‰ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{cell::RefCell, fmt, sync::Arc, thread};

struct Lock&lt;T&gt; {
    locked: RefCell&lt;bool&gt;,
    data: RefCell&lt;T&gt;,
}

impl&lt;T&gt; fmt::Debug for Lock&lt;T&gt;
where
    T: fmt::Debug,
{
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, &quot;Lock&lt;{:?}&gt;&quot;, self.data.borrow())
    }
}

// SAFETY: æˆ‘ä»¬ç¡®ä¿¡ Lock&lt;T&gt; å¾ˆå®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«
unsafe impl&lt;T&gt; Sync for Lock&lt;T&gt; {}

impl&lt;T&gt; Lock&lt;T&gt; {
    pub fn new(data: T) -&gt; Self {
        Self {
            data: RefCell::new(data),
            locked: RefCell::new(false),
        }
    }

    pub fn lock(&amp;self, op: impl FnOnce(&amp;mut T)) {
        // å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin
        while *self.locked.borrow() != false {} // **1

        // æ‹¿åˆ°ï¼Œèµ¶ç´§åŠ é”
        *self.locked.borrow_mut() = true; // **2

        // å¼€å§‹å¹²æ´»
        op(&amp;mut self.data.borrow_mut()); // **3

        // è§£é”
        *self.locked.borrow_mut() = false; // **4
    }
}

fn main() {
    let data = Arc::new(Lock::new(0));

    let data1 = data.clone();
    let t1 = thread::spawn(move || {
        data1.lock(|v| *v += 10);
    });

    let data2 = data.clone();
    let t2 = thread::spawn(move || {
        data2.lock(|v| *v *= 10);
    });
    t1.join().unwrap();
    t2.join().unwrap();

    println!(&quot;data: {:?}&quot;, data);
}
</code></pre></pre>
<blockquote>
<p>è¿™æ®µä»£ç æ¨¡æ‹Ÿäº† Mutex çš„å®ç°ï¼Œå®ƒçš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯ lock() æ–¹æ³•ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼ŒMutex åœ¨è°ƒç”¨ lock() åï¼Œä¼šå¾—åˆ°ä¸€ä¸ª MutexGuard çš„ RAII ç»“æ„ï¼Œè¿™é‡Œä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œè¦æ±‚è°ƒç”¨è€…ä¼ å…¥ä¸€ä¸ªé—­åŒ…ï¼Œæ¥å¤„ç†åŠ é”åçš„äº‹åŠ¡ã€‚åœ¨ lock() æ–¹æ³•é‡Œï¼Œæ‹¿ä¸åˆ°é”çš„å¹¶å‘ä»»åŠ¡ä¼šä¸€ç›´ spinï¼Œæ‹¿åˆ°é”çš„ä»»åŠ¡å¯ä»¥å¹²æ´»ï¼Œå¹²å®Œæ´»åä¼šè§£é”ï¼Œè¿™æ ·ä¹‹å‰ spin çš„ä»»åŠ¡ä¼šç«äº‰åˆ°é”ï¼Œè¿›å…¥ä¸´ç•ŒåŒºã€‚</p>
<blockquote>
<p>è¿™æ ·çš„å®ç°çœ‹ä¸Šå»ä¼¼ä¹é—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯ä½ ç»†æƒ³ï¼Œå®ƒæœ‰å¥½å‡ ä¸ªé—®é¢˜ï¼š</p>
</blockquote>
<ol>
<li>
<p>åœ¨å¤šæ ¸æƒ…å†µä¸‹ï¼Œ**1 å’Œ **2 ä¹‹é—´ï¼Œæœ‰å¯èƒ½å…¶å®ƒçº¿ç¨‹ä¹Ÿç¢°å·§ spin ç»“æŸï¼ŒæŠŠ locked ä¿®æ”¹ä¸º trueã€‚è¿™æ ·ï¼Œå­˜åœ¨å¤šä¸ªçº¿ç¨‹æ‹¿åˆ°è¿™æŠŠé”ï¼Œç ´åäº†ä»»ä½•çº¿ç¨‹éƒ½æœ‰ç‹¬å è®¿é—®çš„ä¿è¯ã€‚</p>
</li>
<li>
<p>å³ä¾¿åœ¨å•æ ¸æƒ…å†µä¸‹ï¼Œ**1 å’Œ **2 ä¹‹é—´ï¼Œä¹Ÿå¯èƒ½å› ä¸ºæ“ä½œç³»ç»Ÿçš„å¯æŠ¢å å¼è°ƒåº¦ï¼Œå¯¼è‡´é—®é¢˜ 1 å‘ç”Ÿã€‚</p>
</li>
<li>
<p>å¦‚ä»Šçš„ç¼–è¯‘å™¨ä¼šæœ€å¤§ç¨‹åº¦ä¼˜åŒ–ç”Ÿæˆçš„æŒ‡ä»¤ï¼Œå¦‚æœæ“ä½œä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå¯èƒ½ä¼šç”Ÿæˆä¹±åºçš„æœºå™¨ç ï¼Œæ¯”å¦‚**3 è¢«ä¼˜åŒ–æ”¾åœ¨ **1 ä¹‹å‰ï¼Œä»è€Œç ´åäº†è¿™ä¸ª lock çš„ä¿è¯ã€‚</p>
</li>
<li>
<p>å³ä¾¿ç¼–è¯‘å™¨ä¸åšä¹±åºå¤„ç†ï¼ŒCPU ä¹Ÿä¼šæœ€å¤§ç¨‹åº¦åšæŒ‡ä»¤çš„ä¹±åºæ‰§è¡Œï¼Œè®©æµæ°´çº¿çš„æ•ˆç‡æœ€é«˜ã€‚åŒæ ·ä¼šå‘ç”Ÿ 3 çš„é—®é¢˜ã€‚</p>
</li>
</ol>
<blockquote>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å®ç°è¿™ä¸ªé”çš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚å¯èƒ½å¤§éƒ¨åˆ†æ—¶é—´å¦‚æˆ‘ä»¬æ‰€æ„¿ï¼Œä½†ä¼šéšæœºå‡ºç°å¥‡å¥‡æ€ªæ€ªçš„è¡Œä¸ºã€‚ä¸€æ—¦è¿™æ ·çš„äº‹æƒ…å‘ç”Ÿï¼Œbug å¯èƒ½ä¼šä»¥å„ç§ä¸åŒçš„é¢è²Œå‡ºç°åœ¨ç³»ç»Ÿçš„å„ä¸ªè§’è½ã€‚è€Œä¸”ï¼Œè¿™æ ·çš„ bug å‡ ä¹æ˜¯æ— è§£çš„ï¼Œå› ä¸ºå®ƒå¾ˆéš¾ç¨³å®šå¤ç°ï¼Œè¡¨ç°è¡Œä¸ºå¾ˆä¸ä¸€è‡´ï¼Œç”šè‡³ï¼Œåªåœ¨æŸä¸ª CPU ä¸‹å‡ºç°ã€‚</p>
</blockquote>
<blockquote>
<p>è¿™é‡Œå†å¼ºè°ƒä¸€ä¸‹ unsafe ä»£ç éœ€è¦è¶³å¤Ÿä¸¥è°¨ï¼Œéœ€è¦éå¸¸æœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆå»å®¡æŸ¥ï¼Œè¿™æ®µä»£ç ä¹‹æ‰€ä»¥ç ´å¿«äº†å¹¶å‘å®‰å…¨æ€§ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬é”™è¯¯åœ°è®¤ä¸ºï¼šä¸º Lock<T> å®ç° Syncï¼Œæ˜¯å®‰å…¨çš„ã€‚</p>
</blockquote>
<p>ä¸ºäº†è§£å†³ä¸Šé¢è¿™æ®µä»£ç çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ CPU å±‚é¢åšä¸€äº›ä¿è¯ï¼Œè®©æŸäº›æ“ä½œæˆä¸ºåŸå­æ“ä½œã€‚</p>
</div>
</details>
<h4 id="atomiccas"><a class="header" href="#atomiccas">Atomic+CAS</a></h4>
<details id="admonition-ä½¿ç”¨atomiccasç¡®ä¿åŸå­æ“ä½œé¡ºåºl" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨Atomic+CASç¡®ä¿åŸå­æ“ä½œé¡ºåºl</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä½¿ç”¨atomiccasç¡®ä¿åŸå­æ“ä½œé¡ºåºl"></a></p>
</summary>
<div>
<p>æœ€åŸºç¡€çš„ä¿è¯æ˜¯ï¼šCAS</p>
<ol>
<li>å¯ä»¥é€šè¿‡ä¸€æ¡æŒ‡ä»¤è¯»å–æŸä¸ªå†…å­˜åœ°å€ï¼Œåˆ¤æ–­å…¶å€¼æ˜¯å¦ç­‰äºæŸä¸ªå‰ç½®å€¼ï¼Œå¦‚æœç›¸ç­‰ï¼Œå°†å…¶ä¿®æ”¹ä¸ºæ–°çš„å€¼ã€‚è¿™å°±æ˜¯ Compare-and-swap æ“ä½œï¼Œç®€ç§°CASã€‚å®ƒæ˜¯æ“ä½œç³»ç»Ÿçš„å‡ ä¹æ‰€æœ‰å¹¶å‘åŸè¯­çš„åŸºçŸ³ï¼Œä½¿å¾—æˆ‘ä»¬èƒ½å®ç°ä¸€ä¸ªå¯ä»¥æ­£å¸¸å·¥ä½œçš„é”ã€‚</li>
</ol>
<p>æ‰€ä»¥ï¼Œåˆšæ‰çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€å¼€å§‹çš„å¾ªç¯æ”¹æˆï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
while self
  .locked
  .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)
  .is_err() {}
</code></pre></pre>
<p>è¿™å¥çš„æ„æ€æ˜¯ï¼š</p>
<ol>
<li>å¦‚æœ locked å½“å‰çš„å€¼æ˜¯ falseï¼Œå°±å°†å…¶æ”¹æˆ trueã€‚</li>
<li>è¿™æ•´ä¸ªæ“ä½œåœ¨ä¸€æ¡æŒ‡ä»¤é‡Œå®Œæˆï¼Œä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹æ‰“æ–­æˆ–è€…ä¿®æ”¹ï¼›</li>
<li>å¦‚æœ locked çš„å½“å‰å€¼ä¸æ˜¯ falseï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›é”™è¯¯ï¼Œæˆ‘ä»¬ä¼šåœ¨æ­¤ä¸åœ spinï¼Œç›´åˆ°å‰ç½®æ¡ä»¶å¾—åˆ°æ»¡è¶³ã€‚</li>
<li>è¿™é‡Œï¼Œcompare_exchange æ˜¯ Rust æä¾›çš„ CAS æ“ä½œï¼Œå®ƒä¼šè¢«ç¼–è¯‘æˆ CPU çš„å¯¹åº” CAS æŒ‡ä»¤ã€‚</li>
</ol>
<blockquote>
<p>å½“è¿™å¥æ‰§è¡ŒæˆåŠŸåï¼Œlocked å¿…ç„¶ä¼šè¢«æ”¹å˜ä¸º trueï¼Œæˆ‘ä»¬æˆåŠŸæ‹¿åˆ°äº†é”ï¼Œè€Œä»»ä½•å…¶ä»–çº¿ç¨‹éƒ½ä¼šåœ¨è¿™å¥è¯ä¸Š spinã€‚</p>
</blockquote>
<p>åŒæ ·åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œç›¸åº”åœ°éœ€è¦ä½¿ç”¨ atomic çš„ç‰ˆæœ¬ï¼Œè€Œéç›´æ¥èµ‹å€¼æˆ falseï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
self.locked.store(false, Ordering::Release);
</code></pre></pre>
<p>å½“ç„¶ï¼Œä¸ºäº†é…åˆè¿™æ ·çš„æ”¹åŠ¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠ locked ä» bool æ”¹æˆ AtomicBoolã€‚</p>
<p>åœ¨ Rust é‡Œï¼Œstd::sync::atomic æœ‰å¤§é‡çš„ atomic æ•°æ®ç»“æ„ï¼Œå¯¹åº”å„ç§åŸºç¡€ç»“æ„ã€‚</p>
<p>æˆ‘ä»¬çœ‹ä½¿ç”¨äº† AtomicBool çš„æ–°å®ç°ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{
    cell::RefCell,
    fmt,
    sync::{
        atomic::{AtomicBool, Ordering},
        Arc,
    },
    thread,
};

struct Lock&lt;T&gt; {
    locked: AtomicBool,
    data: RefCell&lt;T&gt;,
}

impl&lt;T&gt; fmt::Debug for Lock&lt;T&gt;
where
    T: fmt::Debug,
{
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, &quot;Lock&lt;{:?}&gt;&quot;, self.data.borrow())
    }
}

// SAFETY: æˆ‘ä»¬ç¡®ä¿¡ Lock&lt;T&gt; å¾ˆå®‰å…¨ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«
unsafe impl&lt;T&gt; Sync for Lock&lt;T&gt; {}

impl&lt;T&gt; Lock&lt;T&gt; {
    pub fn new(data: T) -&gt; Self {
        Self {
            data: RefCell::new(data),
            locked: AtomicBool::new(false),
        }
    }

    pub fn lock(&amp;self, op: impl FnOnce(&amp;mut T)) {
        // å¦‚æœæ²¡æ‹¿åˆ°é”ï¼Œå°±ä¸€ç›´ spin
        while self
            .locked
            .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)
            .is_err()
        {} // **1

        // å·²ç»æ‹¿åˆ°å¹¶åŠ é”ï¼Œå¼€å§‹å¹²æ´»
        op(&amp;mut self.data.borrow_mut()); // **3

        // è§£é”
        self.locked.store(false, Ordering::Release);
    }
}

fn main() {
    let data = Arc::new(Lock::new(0));

    let data1 = data.clone();
    let t1 = thread::spawn(move || {
        data1.lock(|v| *v += 10);
    });

    let data2 = data.clone();
    let t2 = thread::spawn(move || {
        data2.lock(|v| *v *= 10);
    });
    t1.join().unwrap();
    t2.join().unwrap();

    println!(&quot;data: {:?}&quot;, data);
}
</code></pre></pre>
<p>å¯ä»¥çœ‹åˆ°:</p>
<ol>
<li>é€šè¿‡ä½¿ç”¨ compare_exchange ï¼Œè§„é¿äº† 1 å’Œ 2 é¢ä¸´çš„é—®é¢˜</li>
<li>ä½†å¯¹äºå’Œç¼–è¯‘å™¨ /CPU è‡ªåŠ¨ä¼˜åŒ–ç›¸å…³çš„ 3 å’Œ 4ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›é¢å¤–å¤„ç†ã€‚</li>
</ol>
</div>
</details>
<h4 id="ordering"><a class="header" href="#ordering">ordering</a></h4>
<details id="admonition-orderingæšä¸¾ä½“è¯´æ˜" class="admonition info">
<summary class="admonition-title">
<p>Orderingæšä¸¾ä½“è¯´æ˜</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-orderingæšä¸¾ä½“è¯´æ˜"></a></p>
</summary>
<div>
<p>è¿™å°±æ˜¯è¿™ä¸ªå‡½æ•°é‡Œé¢å¤–çš„ä¸¤ä¸ªå’Œ <a href="https://doc.rust-lang.org/std/sync/atomic/enum.Ordering.html">Ordering</a> æœ‰å…³çš„å¥‡æ€ªå‚æ•°ã€‚</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub enum Ordering {
    Relaxed,
    Release,
    Acquire,
    AcqRel,
    SeqCst,
}
</code></pre></pre>
<blockquote>
<p>æ–‡æ¡£é‡Œè§£é‡Šäº†å‡ ç§ Ordering çš„ç”¨é€”ï¼Œç¨ç¨æ‰©å±•ä¸€ä¸‹ã€‚</p>
</blockquote>
<ol>
<li>ç¬¬ä¸€ä¸ª Relaxedï¼Œè¿™æ˜¯æœ€å®½æ¾çš„è§„åˆ™ï¼Œå®ƒå¯¹ç¼–è¯‘å™¨å’Œ CPU ä¸åšä»»ä½•é™åˆ¶ï¼Œå¯ä»¥ä¹±åºæ‰§è¡Œã€‚</li>
<li>Releaseï¼Œå½“æˆ‘ä»¬å†™å…¥æ•°æ®ï¼ˆæ¯”å¦‚ä¸Šé¢ä»£ç é‡Œçš„ storeï¼‰çš„æ—¶å€™ï¼Œå¦‚æœç”¨äº† Release orderï¼Œé‚£ä¹ˆï¼š</li>
</ol>
<ul>
<li>å¯¹äºå½“å‰çº¿ç¨‹ï¼Œä»»ä½•è¯»å–æˆ–å†™å…¥æ“ä½œéƒ½ä¸èƒ½è¢«ä¹±åºæ’åœ¨è¿™ä¸ª store ä¹‹åã€‚</li>
<li>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼ŒCPU æˆ–è€…ç¼–è¯‘å™¨ä¸èƒ½æŠŠ **3 æŒªåˆ° **4 ä¹‹åæ‰§è¡Œã€‚</li>
</ul>
<ol start="3">
<li>å¯¹äºå…¶å®ƒçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨äº† Acquire æ¥è¯»å–è¿™ä¸ª atomic çš„æ•°æ®ï¼Œ é‚£ä¹ˆå®ƒä»¬çœ‹åˆ°çš„æ˜¯ä¿®æ”¹åçš„ç»“æœã€‚</li>
</ol>
<ul>
<li>ä¸Šé¢ä»£ç æˆ‘ä»¬åœ¨ compare_exchange é‡Œä½¿ç”¨äº† Acquire æ¥è¯»å–ï¼Œæ‰€ä»¥èƒ½ä¿è¯è¯»åˆ°æœ€æ–°çš„å€¼ã€‚</li>
<li>è€Œ Acquire æ˜¯å½“æˆ‘ä»¬è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœç”¨äº† Acquire orderï¼Œé‚£ä¹ˆï¼š</li>
<li>å¯¹äºå½“å‰çº¿ç¨‹ï¼Œä»»ä½•è¯»å–æˆ–è€…å†™å…¥æ“ä½œéƒ½ä¸èƒ½è¢«ä¹±åºæ’åœ¨è¿™ä¸ªè¯»å–ä¹‹å‰ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼ŒCPU æˆ–è€…ç¼–è¯‘å™¨ä¸èƒ½æŠŠ **3 æŒªåˆ° **1 ä¹‹å‰æ‰§è¡Œã€‚</li>
<li>å¯¹äºå…¶å®ƒçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨äº† Release æ¥ä¿®æ”¹æ•°æ®ï¼Œé‚£ä¹ˆï¼Œä¿®æ”¹çš„å€¼å¯¹å½“å‰çº¿ç¨‹å¯è§ã€‚</li>
</ul>
<ol start="4">
<li>ç¬¬å››ä¸ª AcqRel æ˜¯ Acquire å’Œ Release çš„ç»“åˆï¼ŒåŒæ—¶æ‹¥æœ‰ Acquire å’Œ Release çš„ä¿è¯ã€‚</li>
</ol>
<ul>
<li>è¿™ä¸ªä¸€èˆ¬ç”¨åœ¨ fetch_xxx ä¸Šï¼Œæ¯”å¦‚ä½ è¦å¯¹ä¸€ä¸ª atomic è‡ªå¢ 1ï¼Œä½ å¸Œæœ›è¿™ä¸ªæ“ä½œä¹‹å‰å’Œä¹‹åçš„è¯»å–æˆ–å†™å…¥æ“ä½œä¸ä¼šè¢«ä¹±åºï¼Œå¹¶ä¸”æ“ä½œçš„ç»“æœå¯¹å…¶å®ƒçº¿ç¨‹å¯è§ã€‚</li>
</ul>
<ol start="5">
<li>æœ€åçš„ SeqCst æ˜¯æœ€ä¸¥æ ¼çš„ orderingï¼Œé™¤äº† AcqRel çš„ä¿è¯å¤–ï¼Œå®ƒè¿˜ä¿è¯æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ‰€æœ‰ SeqCst æ“ä½œçš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚</li>
</ol>
</div>
</details>
<p>å› ä¸º CAS å’Œ ordering éƒ½æ˜¯ç³»ç»Ÿçº§çš„æ“ä½œï¼Œæ‰€ä»¥è¿™é‡Œæè¿°çš„ Ordering çš„ç”¨é€”åœ¨å„ç§è¯­è¨€ä¸­éƒ½å¤§åŒå°å¼‚ã€‚å¯¹äº Rust æ¥è¯´ï¼Œå®ƒçš„ atomic
åŸè¯­<a href="https://en.cppreference.com/w/cpp/atomic/memory_order">ç»§æ‰¿äº C++</a>ã€‚å¦‚æœè¯» Rust çš„æ–‡æ¡£ä½ æ„Ÿè§‰äº‘é‡Œé›¾é‡Œï¼Œé‚£ä¹ˆ C++ å…³äº ordering çš„æ–‡æ¡£è¦æ¸…æ™°å¾—å¤šã€‚</p>
<details id="admonition-å¯¹atomicèƒŒåçš„casè¿›è¡Œè·å–é”çš„ä¼˜åŒ–" class="admonition info">
<summary class="admonition-title">
<p>å¯¹AtomicèƒŒåçš„CASè¿›è¡Œè·å–é”çš„ä¼˜åŒ–</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å¯¹atomicèƒŒåçš„casè¿›è¡Œè·å–é”çš„ä¼˜åŒ–"></a></p>
</summary>
<div>
<p>å…¶å®ä¸Šé¢è·å–é”çš„ spin è¿‡ç¨‹æ€§èƒ½ä¸å¤Ÿå¥½ï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯è¿™æ ·å¤„ç†ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
while self
    .locked
    .compare_exchange(false, true, Ordering::Acquire, Ordering::Relaxed)
    .is_err()
{
    // æ€§èƒ½ä¼˜åŒ–ï¼šcompare_exchange éœ€è¦ç‹¬å è®¿é—®ï¼Œå½“æ‹¿ä¸åˆ°é”æ—¶ï¼Œæˆ‘ä»¬
    // å…ˆä¸åœæ£€æµ‹ locked çš„çŠ¶æ€ï¼Œç›´åˆ°å…¶ unlocked åï¼Œå†å°è¯•æ‹¿é”
    while self.locked.load(Ordering::Relaxed) == true {}
}
</code></pre></pre>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ while loop é‡Œï¼ŒåˆåµŒå…¥äº†ä¸€ä¸ª loopã€‚</p>
<ol>
<li>è¿™æ˜¯å› ä¸º CAS æ˜¯ä¸ªä»£ä»·æ¯”è¾ƒé«˜çš„æ“ä½œï¼Œå®ƒéœ€è¦è·å¾—å¯¹åº”å†…å­˜çš„ç‹¬å è®¿é—®ï¼ˆexclusive accessï¼‰</li>
<li>æˆ‘ä»¬å¸Œæœ›å¤±è´¥çš„æ—¶å€™åªæ˜¯ç®€å•è¯»å– atomic çš„çŠ¶æ€ï¼Œåªæœ‰ç¬¦åˆæ¡ä»¶çš„æ—¶å€™å†å»åšç‹¬å è®¿é—®ï¼Œè¿›è¡Œ CASã€‚</li>
<li>æ‰€ä»¥ï¼Œçœ‹ä¸Šå»å¤šåšäº†ä¸€å±‚å¾ªç¯ï¼Œå®é™…ä»£ç çš„æ•ˆç‡æ›´é«˜ã€‚</li>
</ol>
<blockquote>
<p>ä»¥ä¸‹æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ­¥çš„è¿‡ç¨‹ï¼Œä¸€å¼€å§‹ t1 æ‹¿åˆ°é”ã€t2 spinï¼Œä¹‹å t1 é‡Šæ”¾é”ã€t2 è¿›å…¥åˆ°ä¸´ç•ŒåŒºæ‰§è¡Œï¼š</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/33%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F-4950274.jpg" alt="33ï½œå¹¶å‘å¤„ç†ï¼ˆä¸Šï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
</div>
</details>
<p>è®²åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¯¹ atomic ä»¥åŠå…¶èƒŒåçš„ CAS æœ‰åˆæ­¥çš„äº†è§£äº†ã€‚</p>
<details id="admonition-é‚£ä¹ˆatomic-é™¤äº†åšå…¶å®ƒå¹¶å‘åŸè¯­è¿˜æœ‰ä»€ä¹ˆä½œç”¨" class="admonition info">
<summary class="admonition-title">
<p>é‚£ä¹ˆï¼Œatomic é™¤äº†åšå…¶å®ƒå¹¶å‘åŸè¯­ï¼Œè¿˜æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-é‚£ä¹ˆatomic-é™¤äº†åšå…¶å®ƒå¹¶å‘åŸè¯­è¿˜æœ‰ä»€ä¹ˆä½œç”¨"></a></p>
</summary>
<div>
<p>é‚£ä¹ˆï¼Œatomic é™¤äº†åšå…¶å®ƒå¹¶å‘åŸè¯­ï¼Œè¿˜æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p>
<p>æˆ‘ä¸ªäººç”¨çš„æœ€å¤šçš„æ˜¯åšå„ç§ lock-free çš„æ•°æ®ç»“æ„ã€‚æ¯”å¦‚ï¼Œéœ€è¦ä¸€ä¸ªå…¨å±€çš„ ID ç”Ÿæˆå™¨ã€‚å½“ç„¶å¯ä»¥ä½¿ç”¨ UUID è¿™æ ·çš„æ¨¡å—æ¥ç”Ÿæˆå”¯ä¸€çš„ IDï¼Œä½†å¦‚æœæˆ‘ä»¬åŒæ—¶éœ€è¦è¿™ä¸ª ID æ˜¯æœ‰åºçš„ï¼Œé‚£ä¹ˆ AtomicUsize å°±æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</p>
<p>ä½ å¯ä»¥ç”¨ fetch_add æ¥å¢åŠ è¿™ä¸ª IDï¼Œè€Œ fetch_add è¿”å›çš„ç»“æœå°±å¯ä»¥ç”¨äºå½“å‰çš„ IDã€‚è¿™æ ·ï¼Œä¸éœ€è¦åŠ é”ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸­å®‰å…¨ä½¿ç”¨çš„ ID ç”Ÿæˆå™¨ã€‚</p>
<p>å¦å¤–ï¼Œatomic è¿˜å¯ä»¥ç”¨äºè®°å½•ç³»ç»Ÿçš„å„ç§ metricsã€‚æ¯”å¦‚ä¸€ä¸ªç®€å•çš„ in-memory Metrics æ¨¡å—ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{
    collections::HashMap,
    sync::atomic::{AtomicUsize, Ordering},
};

// server statistics
pub struct Metrics(HashMap&lt;&amp;'static str, AtomicUsize&gt;);

impl Metrics {
    pub fn new(names: &amp;[&amp;'static str]) -&gt; Self {
        let mut metrics: HashMap&lt;&amp;'static str, AtomicUsize&gt; = HashMap::new();
        for name in names.iter() {
            metrics.insert(name, AtomicUsize::new(0));
        }
        Self(metrics)
    }

    pub fn inc(&amp;self, name: &amp;'static str) {
        if let Some(m) = self.0.get(name) {
            m.fetch_add(1, Ordering::Relaxed);
        }
    }

    pub fn add(&amp;self, name: &amp;'static str, val: usize) {
        if let Some(m) = self.0.get(name) {
            m.fetch_add(val, Ordering::Relaxed);
        }
    }

    pub fn dec(&amp;self, name: &amp;'static str) {
        if let Some(m) = self.0.get(name) {
            m.fetch_sub(1, Ordering::Relaxed);
        }
    }

    pub fn snapshot(&amp;self) -&gt; Vec&lt;(&amp;'static str, usize)&gt; {
        self.0
            .iter()
            .map(|(k, v)| (*k, v.load(Ordering::Relaxed)))
            .collect()
    }
}
</code></pre></pre>
<p>å®ƒå…è®¸ä½ åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€çš„ metrics è¡¨ï¼Œç„¶ååœ¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹ï¼Œæ— é”åœ°æ“ä½œç›¸åº”çš„ metricsï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use lazy_static::lazy_static;
use std::{
    collections::HashMap,
    sync::atomic::{AtomicUsize, Ordering},
};

lazy_static! {
    pub(crate) static ref METRICS: Metrics = Metrics::new(&amp;[
        &quot;topics&quot;,
        &quot;clients&quot;,
        &quot;peers&quot;,
        &quot;broadcasts&quot;,
        &quot;servers&quot;,
        &quot;states&quot;,
        &quot;subscribers&quot;
    ]);
}

// server statistics
pub struct Metrics(HashMap&lt;&amp;'static str, AtomicUsize&gt;);

impl Metrics {
    pub fn new(names: &amp;[&amp;'static str]) -&gt; Self {
        let mut metrics: HashMap&lt;&amp;'static str, AtomicUsize&gt; = HashMap::new();
        for name in names.iter() {
            metrics.insert(name, AtomicUsize::new(0));
        }
        Self(metrics)
    }

    pub fn inc(&amp;self, name: &amp;'static str) {
        if let Some(m) = self.0.get(name) {
            m.fetch_add(1, Ordering::Relaxed);
        }
    }

    pub fn add(&amp;self, name: &amp;'static str, val: usize) {
        if let Some(m) = self.0.get(name) {
            m.fetch_add(val, Ordering::Relaxed);
        }
    }

    pub fn dec(&amp;self, name: &amp;'static str) {
        if let Some(m) = self.0.get(name) {
            m.fetch_sub(1, Ordering::Relaxed);
        }
    }

    pub fn snapshot(&amp;self) -&gt; Vec&lt;(&amp;'static str, usize)&gt; {
        self.0
            .iter()
            .map(|(k, v)| (*k, v.load(Ordering::Relaxed)))
            .collect()
    }
}

fn main() {
    METRICS.inc(&quot;topics&quot;);
    METRICS.inc(&quot;subscribers&quot;);

    println!(&quot;{:?}&quot;, METRICS.snapshot());
}

</code></pre></pre>
</div>
</details>
<h3 id="mutex"><a class="header" href="#mutex">Mutex</a></h3>
<details id="admonition-atomicæœ‰ä»€ä¹ˆé™åˆ¶mutexåˆå¦‚ä½•è§£å†³" class="admonition info">
<summary class="admonition-title">
<p>Atomicæœ‰ä»€ä¹ˆé™åˆ¶ï¼ŒMutexåˆå¦‚ä½•è§£å†³ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-atomicæœ‰ä»€ä¹ˆé™åˆ¶mutexåˆå¦‚ä½•è§£å†³"></a></p>
</summary>
<div>
<p>Atomic è™½ç„¶å¯ä»¥å¤„ç†è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹åŠ é”çš„éœ€æ±‚ï¼Œä½†æ¯•ç«Ÿç”¨èµ·æ¥ä¸é‚£ä¹ˆæ–¹ä¾¿ï¼Œæˆ‘ä»¬éœ€è¦æ›´é«˜å±‚çš„å¹¶å‘åŸè¯­ï¼Œæ¥ä¿è¯è½¯ä»¶ç³»ç»Ÿæ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå…±äº«èµ„æºçš„è®¿é—®ï¼Œä½¿å¾—æ¯ä¸ªçº¿ç¨‹åœ¨è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ï¼Œå¯ä»¥ç‹¬å æˆ–è€…è¯´äº’æ–¥è®¿é—®ï¼ˆmutual exclusive accessï¼‰ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“:</p>
<ol>
<li>å¯¹äºä¸€ä¸ªå…±äº«èµ„æºï¼Œå¦‚æœæ‰€æœ‰çº¿ç¨‹åªåšè¯»æ“ä½œï¼Œé‚£ä¹ˆæ— éœ€äº’æ–¥ï¼Œå¤§å®¶éšæ—¶å¯ä»¥è®¿é—®ï¼Œå¾ˆå¤š immutable languageï¼ˆå¦‚ Erlang / Elixirï¼‰åšäº†è¯­è¨€å±‚é¢çš„åªè¯»ä¿è¯ï¼Œç¡®ä¿äº†å¹¶å‘ç¯å¢ƒä¸‹çš„æ— é”æ“ä½œã€‚</li>
</ol>
<ul>
<li>è¿™ç‰ºç‰²äº†ä¸€äº›æ•ˆç‡ï¼ˆå¸¸è§çš„ list/hashmap éœ€è¦ä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/Persistent_data_structure">persistent data structure</a>ï¼‰ï¼Œé¢å¤–åšäº†ä¸å°‘å†…å­˜æ‹·è´ï¼Œæ¢æ¥äº†å¹¶å‘æ§åˆ¶ä¸‹çš„ç®€å•è½»çµã€‚</li>
</ul>
<ol start="2">
<li>ç„¶è€Œï¼Œä¸€æ—¦æœ‰ä»»ä½•ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è¦ä¿®æ”¹å…±äº«èµ„æºï¼Œä¸ä½†å†™è€…ä¹‹é—´è¦äº’æ–¥ï¼Œè¯»å†™ä¹‹é—´ä¹Ÿéœ€è¦äº’æ–¥ã€‚æ¯•ç«Ÿå¦‚æœè¯»å†™ä¹‹é—´ä¸äº’æ–¥çš„è¯ï¼Œè¯»è€…è½»åˆ™è¯»åˆ°è„æ•°æ®ï¼Œé‡åˆ™ä¼šè¯»åˆ°å·²ç»è¢«ç ´åçš„æ•°æ®ï¼Œå¯¼è‡´ crashã€‚</li>
</ol>
<ul>
<li>æ¯”å¦‚è¯»è€…è¯»åˆ°é“¾è¡¨é‡Œçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå†™è€…æ°å·§æŠŠè¿™ä¸ªèŠ‚ç‚¹çš„å†…å­˜é‡Šæ”¾æ‰äº†ï¼Œå¦‚æœä¸åšäº’æ–¥è®¿é—®ï¼Œç³»ç»Ÿä¸€å®šä¼šå´©æºƒã€‚</li>
</ul>
<blockquote>
<p>æ‰€ä»¥æ“ä½œç³»ç»Ÿæä¾›äº†ç”¨æ¥è§£å†³è¿™ç§è¯»å†™äº’æ–¥é—®é¢˜çš„åŸºæœ¬å·¥å…·ï¼šMutexï¼ˆRwLock æˆ‘ä»¬æ”¾ä¸‹ä¸è¡¨ï¼‰ã€‚</p>
</blockquote>
<p>å…¶å®ä¸Šæ–‡ä¸­ï¼Œä¸ºäº†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ atomicï¼Œæˆ‘ä»¬åˆ¶ä½œäº†ä¸€ä¸ªéå¸¸ç²—ç³™ç®€å•çš„ SpinLockï¼Œå°±å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå¹¿ä¹‰çš„ Mutexã€‚SpinLockï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯çº¿ç¨‹é€šè¿‡ CPU ç©ºè½¬ï¼ˆspinï¼Œå°±åƒå‰é¢çš„ while loopï¼‰å¿™ç­‰ï¼ˆbusy waitï¼‰ï¼Œæ¥ç­‰å¾…æŸä¸ªä¸´ç•ŒåŒºå¯ç”¨çš„ä¸€ç§é”ã€‚</p>
<blockquote>
<p>ç„¶è€Œï¼Œè¿™ç§é€šè¿‡ SpinLock åšäº’æ–¥çš„å®ç°æ–¹å¼æœ‰ä½¿ç”¨åœºæ™¯çš„é™åˆ¶ï¼šå¦‚æœå—ä¿æŠ¤çš„ä¸´ç•ŒåŒºå¤ªå¤§ï¼Œé‚£ä¹ˆæ•´ä½“çš„æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ï¼Œ CPU å¿™ç­‰ï¼Œæµªè´¹èµ„æºè¿˜ä¸å¹²å®äº‹ï¼Œä¸é€‚åˆä½œä¸ºä¸€ç§é€šç”¨çš„å¤„ç†æ–¹æ³•ã€‚</p>
</blockquote>
<p>æ›´é€šç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š</p>
<ol>
<li>å½“å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ª Mutex æ—¶ï¼Œè·å¾—é”çš„çº¿ç¨‹å¾—åˆ°ä¸´ç•ŒåŒºçš„è®¿é—®ï¼Œå…¶å®ƒçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œæ”¾å…¥è¯¥ Mutex ä¸Šçš„ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é‡Œ</li>
<li>å½“è·å¾—é”çš„çº¿ç¨‹å®Œæˆå·¥ä½œï¼Œé€€å‡ºä¸´ç•ŒåŒºæ—¶ï¼ŒMutex ä¼šç»™ç­‰å¾…é˜Ÿåˆ—å‘ä¸€ä¸ªä¿¡å·ï¼ŒæŠŠé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªçº¿ç¨‹å”¤é†’ï¼Œäºæ˜¯è¿™ä¸ªçº¿ç¨‹å¯ä»¥è¿›è¡Œåç»­çš„è®¿é—®ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/33%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F.jpg" alt="33ï½œå¹¶å‘å¤„ç†ï¼ˆä¸Šï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
</div>
</details>
<h3 id="atomicå’Œmutexçš„è”ç³»"><a class="header" href="#atomicå’Œmutexçš„è”ç³»">Atomicå’ŒMutexçš„è”ç³»</a></h3>
<details id="admonition-atomicmutexsemaphoreçš„è”ç³»" class="admonition info">
<summary class="admonition-title">
<p>Atomicã€Mutexã€semaphoreçš„è”ç³»</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-atomicmutexsemaphoreçš„è”ç³»"></a></p>
</summary>
<div>
<p>æˆ‘ä»¬å‰é¢ä¹Ÿè®²è¿‡ï¼Œçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä»£ä»·å¾ˆå¤§ï¼Œæ‰€ä»¥é¢‘ç¹å°†çº¿ç¨‹æŒ‚èµ·å†å”¤é†’ï¼Œä¼šé™ä½æ•´ä¸ªç³»ç»Ÿçš„æ•ˆç‡ã€‚æ‰€ä»¥å¾ˆå¤š Mutex å…·ä½“çš„å®ç°ä¼šå°† SpinLockï¼ˆç¡®åˆ‡åœ°è¯´æ˜¯ spin waitï¼‰å’Œçº¿ç¨‹æŒ‚èµ·ç»“åˆä½¿ç”¨ï¼š
çº¿ç¨‹çš„ lock è¯·æ±‚å¦‚æœæ‹¿ä¸åˆ°ä¼šå…ˆå°è¯• spin ä¸€ä¼šï¼Œç„¶åå†æŒ‚èµ·æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚</p>
<p>Rust ä¸‹çš„ <a href="https://github.com/Amanieu/parking_lot">parking_lot </a>å°±æ˜¯è¿™æ ·å®ç°çš„ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™æ ·å®ç°ä¼šå¸¦æ¥å…¬å¹³æ€§çš„é—®é¢˜ï¼š</p>
<ol>
<li>å¦‚æœæ–°æ¥çš„çº¿ç¨‹æ°å·§åœ¨ spin è¿‡ç¨‹ä¸­æ‹¿åˆ°äº†é”</li>
<li>è€Œå½“å‰ç­‰å¾…é˜Ÿåˆ—ä¸­è¿˜æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ç­‰å¾…é”</li>
<li>é‚£ä¹ˆç­‰å¾…çš„çº¿ç¨‹åªèƒ½ç»§ç»­ç­‰å¾…ä¸‹å»</li>
<li>è¿™ä¸ç¬¦åˆ FIFOï¼Œä¸é€‚åˆé‚£äº›éœ€è¦ä¸¥æ ¼æŒ‰å…ˆæ¥ååˆ°æ’é˜Ÿçš„ä½¿ç”¨åœºæ™¯ã€‚</li>
<li>ä¸ºæ­¤ï¼Œparking_lot æä¾›äº† fair mutexã€‚</li>
</ol>
<p>Mutex çš„å®ç°ä¾èµ–äº CPU æä¾›çš„ atomicã€‚ä½ å¯ä»¥æŠŠ Mutex æƒ³è±¡æˆä¸€ä¸ªç²’åº¦æ›´å¤§çš„ atomicï¼Œåªä¸è¿‡è¿™ä¸ª atomic æ— æ³•ç”± CPU ä¿è¯ï¼Œè€Œæ˜¯é€šè¿‡è½¯ä»¶ç®—æ³•æ¥å®ç°ã€‚</p>
<p>ä¸¤ä¸ªåŸºæœ¬çš„å¹¶å‘åŸè¯­ Atomic å’Œ Mutexã€‚Atomic æ˜¯ä¸€åˆ‡å¹¶å‘åŒæ­¥çš„åŸºç¡€ï¼Œé€šè¿‡ CPU æä¾›ç‰¹æ®Šçš„ CAS æŒ‡ä»¤ï¼Œæ“ä½œç³»ç»Ÿå’Œåº”ç”¨è½¯ä»¶å¯ä»¥æ„å»ºæ›´åŠ é«˜å±‚çš„å¹¶å‘åŸè¯­ï¼Œæ¯”å¦‚ SpinLock å’Œ Mutexã€‚</p>
<p>SpinLock å’Œ Mutex æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œä½¿ç”¨ SpinLockï¼Œçº¿ç¨‹åœ¨å¿™ç­‰ï¼ˆbusy waitï¼‰ï¼Œè€Œä½¿ç”¨ Mutex lockï¼Œçº¿ç¨‹åœ¨ç­‰å¾…é”çš„æ—¶å€™ä¼šè¢«è°ƒåº¦å‡ºå»ï¼Œç­‰é”å¯ç”¨æ—¶å†è¢«è°ƒåº¦å›æ¥ã€‚</p>
<p>å¬ä¸Šå» SpinLock ä¼¼ä¹æ•ˆç‡å¾ˆä½ï¼Œå…¶å®ä¸æ˜¯ï¼Œè¿™è¦å…·ä½“çœ‹é”çš„ä¸´ç•ŒåŒºå¤§å°ã€‚å¦‚æœä¸´ç•ŒåŒºè¦æ‰§è¡Œçš„ä»£ç å¾ˆå°‘ï¼Œé‚£ä¹ˆå’Œ Mutex lock å¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆcontext switchï¼‰ç›¸æ¯”ï¼ŒSpinLock æ˜¯å€¼å¾—çš„ã€‚åœ¨ Linux Kernel ä¸­ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬åªèƒ½ä½¿ç”¨ SpinLockã€‚</p>
<p>è‡³äºæ“ä½œç³»ç»Ÿé‡Œå¦ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µä¿¡å·é‡ï¼ˆsemaphoreï¼‰ï¼Œä½ å¯ä»¥è®¤ä¸ºæ˜¯ Mutex æ›´é€šç”¨çš„è¡¨ç°å½¢å¼ã€‚æ¯”å¦‚åœ¨æ–°å† ç–«æƒ…ä¸‹ï¼Œå›¾ä¹¦é¦†è¦æ§åˆ¶åŒæ—¶åœ¨é¦†å†…çš„äººæ•°ï¼Œå¦‚æœæ»¡äº†ï¼Œå…¶ä»–äººå°±å¿…é¡»æ’é˜Ÿï¼Œå‡ºæ¥ä¸€ä¸ªæ‰èƒ½å†è¿›ä¸€ä¸ªã€‚è¿™é‡Œï¼Œå¦‚æœæ€»äººæ•°é™åˆ¶ä¸º 1ï¼Œå°±æ˜¯ Mutexï¼Œå¦‚æœ &gt; 1ï¼Œå°±æ˜¯ semaphoreã€‚</p>
</div>
</details>
<h3 id="condvar"><a class="header" href="#condvar">Condvar</a></h3>
<h4 id="atomicå’Œmutexä¸èƒ½è§£å†³dagæ¨¡å¼"><a class="header" href="#atomicå’Œmutexä¸èƒ½è§£å†³dagæ¨¡å¼">Atomicå’ŒMutexä¸èƒ½è§£å†³DAGæ¨¡å¼</a></h4>
<details id="admonition-atomicå’Œmutexä¸»è¦ç”¨äºå“ªç§å·¥ä½œæ¨¡å¼åŸºäºä»€ä¹ˆéœ€æ±‚æå‡ºcondvaråŸè¯­" class="admonition info">
<summary class="admonition-title">
<p>Atomicå’ŒMutexä¸»è¦ç”¨äºå“ªç§å·¥ä½œæ¨¡å¼ï¼ŸåŸºäºä»€ä¹ˆéœ€æ±‚æå‡ºCondvaråŸè¯­ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-atomicå’Œmutexä¸»è¦ç”¨äºå“ªç§å·¥ä½œæ¨¡å¼åŸºäºä»€ä¹ˆéœ€æ±‚æå‡ºcondvaråŸè¯­"></a></p>
</summary>
<div>
<p>å¯¹äºå¹¶å‘çŠ¶æ€ä¸‹è¿™ä¸‰ç§å¸¸è§çš„å·¥ä½œæ¨¡å¼ï¼šè‡ªç”±ç«äº‰æ¨¡å¼ã€map/reduce æ¨¡å¼ã€DAG æ¨¡å¼ï¼Œæˆ‘ä»¬çš„éš¾ç‚¹æ˜¯å¦‚ä½•åœ¨è¿™äº›å¹¶å‘çš„ä»»åŠ¡ä¸­è¿›è¡ŒåŒæ­¥ã€‚atomic / Mutex è§£å†³äº†è‡ªç”±ç«äº‰æ¨¡å¼ä¸‹å¹¶å‘ä»»åŠ¡çš„åŒæ­¥é—®é¢˜ï¼Œä¹Ÿèƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³ map/reduce æ¨¡å¼ä¸‹çš„åŒæ­¥é—®é¢˜ï¼Œå› ä¸ºæ­¤æ—¶åŒæ­¥åªå‘ç”Ÿåœ¨ map å’Œ reduce ä¸¤ä¸ªé˜¶æ®µã€‚</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/34%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F-4951814.jpg" alt="34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
<p>ç„¶è€Œï¼Œå®ƒä»¬æ²¡æœ‰è§£å†³ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ DAG æ¨¡å¼ï¼šå¦‚æœè¿™ç§è®¿é—®éœ€è¦æŒ‰ç…§ä¸€å®šé¡ºåºè¿›è¡Œæˆ–è€…å‰åæœ‰ä¾èµ–å…³ç³»ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ</p>
<p>è¿™ä¸ªé—®é¢˜çš„å…¸å‹åœºæ™¯æ˜¯ç”Ÿäº§è€… - æ¶ˆè´¹è€…æ¨¡å¼ï¼šç”Ÿäº§è€…ç”Ÿäº§å‡ºæ¥å†…å®¹åï¼Œéœ€è¦æœ‰æœºåˆ¶é€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹ã€‚æ¯”å¦‚ socket ä¸Šæœ‰æ•°æ®äº†ï¼Œé€šçŸ¥å¤„ç†çº¿ç¨‹æ¥å¤„ç†æ•°æ®ï¼Œå¤„ç†å®Œæˆä¹‹åï¼Œå†é€šçŸ¥ socket æ”¶å‘çš„çº¿ç¨‹å‘é€æ•°æ®ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ“ä½œç³»ç»Ÿè¿˜æä¾›äº† Condvarã€‚</p>
</div>
</details>
<h4 id="condvarä»‹ç»ä¸ä½¿ç”¨"><a class="header" href="#condvarä»‹ç»ä¸ä½¿ç”¨">condvarä»‹ç»ä¸ä½¿ç”¨</a></h4>
<details id="admonition-condvarä»‹ç»ä¸ä½¿ç”¨" class="admonition info">
<summary class="admonition-title">
<p>Condvarä»‹ç»ä¸ä½¿ç”¨</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-condvarä»‹ç»ä¸ä½¿ç”¨"></a></p>
</summary>
<div>
<p>Condvar æœ‰ä¸¤ç§çŠ¶æ€ï¼š</p>
<ol>
<li>ç­‰å¾…ï¼ˆwaitï¼‰ï¼šçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°æ»¡è¶³æŸä¸ªæ¡ä»¶ã€‚</li>
<li>é€šçŸ¥ï¼ˆnotifyï¼‰ï¼šå½“ condvar çš„æ¡ä»¶æ»¡è¶³æ—¶ï¼Œå½“å‰çº¿ç¨‹é€šçŸ¥å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥è¢«å”¤é†’ã€‚é€šçŸ¥å¯ä»¥æ˜¯å•ä¸ªé€šçŸ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªé€šçŸ¥ï¼Œç”šè‡³å¹¿æ’­ï¼ˆé€šçŸ¥æ‰€æœ‰äººï¼‰ã€‚</li>
</ol>
<p>åœ¨å®è·µä¸­ï¼ŒCondvar å¾€å¾€å’Œ Mutex ä¸€èµ·ä½¿ç”¨ï¼š</p>
<ul>
<li>Mutex ç”¨äºä¿è¯æ¡ä»¶åœ¨è¯»å†™æ—¶äº’æ–¥</li>
<li>Condvar ç”¨äºæ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::sync::{Arc, Condvar, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    let pair = Arc::new((Mutex::new(false), Condvar::new()));
    let pair2 = Arc::clone(&amp;pair);

    thread::spawn(move || {
        let (lock, cvar) = &amp;*pair2;
        let mut started = lock.lock().unwrap();
        *started = true;
        eprintln!(&quot;I'm a happy worker!&quot;);
        // é€šçŸ¥ä¸»çº¿ç¨‹
        cvar.notify_one();
        loop {
            thread::sleep(Duration::from_secs(1));
            println!(&quot;working...&quot;);
        }
    });

    // ç­‰å¾…å·¥ä½œçº¿ç¨‹çš„é€šçŸ¥
    let (lock, cvar) = &amp;*pair;
    let mut started = lock.lock().unwrap();
    while !*started {
        started = cvar.wait(started).unwrap();
    }
    eprintln!(&quot;Worker started!&quot;);
}
</code></pre></pre>
<ol>
<li>
<p>è¿™æ®µä»£ç é€šè¿‡ condvarï¼Œæˆ‘ä»¬å®ç°äº† worker çº¿ç¨‹åœ¨æ‰§è¡Œåˆ°ä¸€å®šé˜¶æ®µåé€šçŸ¥ä¸»çº¿ç¨‹ï¼Œç„¶åä¸»çº¿ç¨‹å†åšä¸€äº›äº‹æƒ…ã€‚</p>
</li>
<li>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª Mutex ä½œä¸ºäº’æ–¥æ¡ä»¶ï¼Œç„¶ååœ¨ <a href="https://doc.rust-lang.org/src/std/sync/condvar.rs.html#184-191">cvar.wait() </a>ä¸­ä¼ å…¥è¿™ä¸ª Mutexã€‚è¿™ä¸ªæ¥å£éœ€è¦ä¸€ä¸ª MutexGuardï¼Œä»¥ä¾¿äºçŸ¥é“éœ€è¦å”¤é†’å“ªä¸ª Mutex ä¸‹ç­‰å¾…çš„çº¿ç¨‹ï¼š</p>
</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn wait&lt;'a, T&gt;(
    &amp;self,
    guard: MutexGuard&lt;'a, T&gt;
) -&gt; LockResult&lt;MutexGuard&lt;'a, T&gt;&gt;
</code></pre></pre>
</div>
</details>
<h3 id="channel"><a class="header" href="#channel">Channel</a></h3>
<details id="admonition-mutexå’Œcondvarçš„å±€é™æ€§åœ¨å“ªchannelå¦‚ä½•è§£å†³çš„" class="admonition info">
<summary class="admonition-title">
<p>Mutexå’ŒCondvarçš„å±€é™æ€§åœ¨å“ªï¼ŸChannelå¦‚ä½•è§£å†³çš„ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-mutexå’Œcondvarçš„å±€é™æ€§åœ¨å“ªchannelå¦‚ä½•è§£å†³çš„"></a></p>
</summary>
<div>
<p>ä½†æ˜¯ç”¨ Mutex å’Œ Condvar æ¥å¤„ç†å¤æ‚çš„ DAG å¹¶å‘æ¨¡å¼ä¼šæ¯”è¾ƒåƒåŠ›ã€‚æ‰€ä»¥ï¼ŒRust è¿˜æä¾›äº†å„ç§å„æ ·çš„ Channel ç”¨äºå¤„ç†å¹¶å‘ä»»åŠ¡ä¹‹é—´çš„é€šè®¯ã€‚</p>
<p>ç”±äº Golang ä¸é—ä½™åŠ›åœ°æ¨å¹¿ï¼ŒChannel å¯èƒ½æ˜¯æœ€å¹¿ä¸ºäººçŸ¥çš„å¹¶å‘æ‰‹æ®µã€‚ç›¸å¯¹äº Mutexï¼ŒChannel çš„æŠ½è±¡ç¨‹åº¦æœ€é«˜ï¼Œæ¥å£æœ€ä¸ºç›´è§‚ï¼Œä½¿ç”¨èµ·æ¥çš„å¿ƒç†è´Ÿæ‹…ä¹Ÿæ²¡é‚£ä¹ˆå¤§ã€‚ä½¿ç”¨ Mutex æ—¶ï¼Œä½ éœ€è¦å¾ˆå°å¿ƒåœ°é¿å…æ­»é”ï¼Œæ§åˆ¶ä¸´ç•ŒåŒºçš„å¤§å°ï¼Œé˜²æ­¢ä¸€åˆ‡å¯èƒ½å‘ç”Ÿçš„æ„å¤–ã€‚</p>
<blockquote>
<p>è™½ç„¶åœ¨ Rust é‡Œï¼Œæˆ‘ä»¬å¯ä»¥â€œæ— ç•å¹¶å‘â€ï¼ˆFearless concurrencyï¼‰â€”â€” å½“ä»£ç ç¼–è¯‘é€šè¿‡ï¼Œç»å¤§å¤šæ•°å¹¶å‘é—®é¢˜éƒ½å¯ä»¥è§„é¿ï¼Œä½†æ€§èƒ½ä¸Šçš„é—®é¢˜ã€é€»è¾‘ä¸Šçš„æ­»é”è¿˜éœ€è¦å¼€å‘è€…ç…§æ–™ã€‚</p>
</blockquote>
<p>Channel æŠŠé”å°è£…åœ¨äº†é˜Ÿåˆ—å†™å…¥å’Œè¯»å–çš„å°å—åŒºåŸŸå†…ï¼Œç„¶åæŠŠè¯»è€…å’Œå†™è€…å®Œå…¨åˆ†ç¦»ï¼Œä½¿å¾—è¯»è€…è¯»å–æ•°æ®å’Œå†™è€…å†™å…¥æ•°æ®ï¼Œå¯¹å¼€å‘è€…è€Œè¨€ï¼Œé™¤äº†æ½œåœ¨çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¤–ï¼Œå®Œå…¨å’Œé”æ— å…³ï¼Œå°±åƒè®¿é—®ä¸€ä¸ªæœ¬åœ°é˜Ÿåˆ—ä¸€æ ·ã€‚æ‰€ä»¥ï¼Œå¯¹äºå¤§éƒ¨åˆ†å¹¶å‘é—®é¢˜ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”¨ Channel æˆ–è€…ç±»ä¼¼çš„æ€æƒ³æ¥å¤„ç†ï¼ˆæ¯”å¦‚ actor modelï¼‰ã€‚</p>
</div>
</details>
<details id="admonition-channelæ ¹æ®ä½¿ç”¨åœºæ™¯å’Œè¯»å†™è€…æ•°é‡åˆ†åˆ«å¦‚ä½•åˆ†ç±»" class="admonition info">
<summary class="admonition-title">
<p>Channelæ ¹æ®ä½¿ç”¨åœºæ™¯å’Œè¯»å†™è€…æ•°é‡åˆ†åˆ«å¦‚ä½•åˆ†ç±»ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-channelæ ¹æ®ä½¿ç”¨åœºæ™¯å’Œè¯»å†™è€…æ•°é‡åˆ†åˆ«å¦‚ä½•åˆ†ç±»"></a></p>
</summary>
<div>
<p>Channel åœ¨å…·ä½“å®ç°çš„æ—¶å€™ï¼Œæ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œä¼šé€‰æ‹©ä¸åŒçš„å·¥å…·ã€‚Rust æä¾›äº†ä»¥ä¸‹å››ç§ Channelï¼š</p>
<ol>
<li>oneshotï¼šè¿™å¯èƒ½æ˜¯æœ€ç®€å•çš„ Channelï¼Œå†™è€…å°±åªå‘ä¸€æ¬¡æ•°æ®ï¼Œè€Œè¯»è€…ä¹Ÿåªè¯»ä¸€æ¬¡ã€‚</li>
</ol>
<p>è¿™ç§ä¸€æ¬¡æ€§çš„ã€å¤šä¸ªçº¿ç¨‹é—´çš„åŒæ­¥å¯ä»¥ç”¨ oneshot channel å®Œæˆã€‚ç”±äº oneshot ç‰¹æ®Šçš„ç”¨é€”ï¼Œå®ç°çš„æ—¶å€™å¯ä»¥ç›´æ¥ç”¨ atomic swap æ¥å®Œæˆã€‚</p>
<ol start="2">
<li>rendezvousï¼šå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦é€šè¿‡ Channel æ¥æ§åˆ¶çº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå¹¶ä¸éœ€è¦å‘é€æ•°æ®ã€‚</li>
</ol>
<p>rendezvous channel æ˜¯ channel size ä¸º 0 çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</p>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ Mutex + Condvar å®ç°å°±è¶³å¤Ÿäº†ï¼Œåœ¨å…·ä½“å®ç°ä¸­ï¼Œrendezvous channel å…¶å®ä¹Ÿå°±æ˜¯ Mutex + Condvar çš„ä¸€ä¸ªåŒ…è£…ã€‚</p>
<ol start="3">
<li>boundedï¼šbounded channel æœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†é˜Ÿåˆ—æœ‰ä¸Šé™ã€‚</li>
</ol>
<p>ä¸€æ—¦é˜Ÿåˆ—è¢«å†™æ»¡äº†ï¼Œå†™è€…ä¹Ÿéœ€è¦è¢«æŒ‚èµ·ç­‰å¾…ã€‚å½“é˜»å¡å‘ç”Ÿåï¼Œè¯»è€…ä¸€æ—¦è¯»å–æ•°æ®ï¼Œchannel å†…éƒ¨å°±ä¼šä½¿ç”¨ Condvar çš„ notify_one é€šçŸ¥å†™è€…ï¼Œå”¤é†’æŸä¸ªå†™è€…ä½¿å…¶èƒ½å¤Ÿç»§ç»­å†™å…¥ã€‚</p>
<p>å› æ­¤ï¼Œå®ç°ä¸­ï¼Œä¸€èˆ¬ä¼šç”¨åˆ° Mutex + Condvar + VecDeque æ¥å®ç°ï¼›å¦‚æœä¸ç”¨ Condvarï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ thread::park + thread::notify æ¥å®Œæˆï¼ˆflume çš„åšæ³•ï¼‰ï¼›å¦‚æœä¸ç”¨ VecDequeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒå‘é“¾è¡¨æˆ–è€…å…¶å®ƒçš„ ring buffer çš„å®ç°ã€‚</p>
<ol start="4">
<li>unboundedï¼šqueue æ²¡æœ‰ä¸Šé™ï¼Œå¦‚æœå†™æ»¡äº†ï¼Œå°±è‡ªåŠ¨æ‰©å®¹ã€‚
æˆ‘ä»¬çŸ¥é“ï¼ŒRust çš„å¾ˆå¤šæ•°æ®ç»“æ„å¦‚ Vec ã€VecDeque éƒ½æ˜¯è‡ªåŠ¨æ‰©å®¹çš„ã€‚unbounded å’Œ bounded ç›¸æ¯”ï¼Œé™¤äº†ä¸é˜»å¡å†™è€…ï¼Œå…¶å®ƒå®ç°éƒ½å¾ˆç±»ä¼¼ã€‚</li>
</ol>
<blockquote>
<p>æ‰€æœ‰è¿™äº› channel ç±»å‹ï¼ŒåŒæ­¥å’Œå¼‚æ­¥çš„å®ç°æ€è·¯å¤§åŒå°å¼‚ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºæŒ‚èµ· / å”¤é†’çš„å¯¹è±¡ï¼š</p>
</blockquote>
<ul>
<li>åœ¨åŒæ­¥çš„ä¸–ç•Œé‡Œï¼ŒæŒ‚èµ· / å”¤é†’çš„å¯¹è±¡æ˜¯çº¿ç¨‹ï¼›</li>
<li>è€Œå¼‚æ­¥çš„ä¸–ç•Œé‡Œï¼Œæ˜¯ç²’åº¦å¾ˆå°çš„ taskã€‚</li>
</ul>
<h2 id="-12"><a class="header" href="#-12"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/34%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F-4951803.jpg" alt="34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></a></h2>
<p>æ ¹æ® Channel è¯»è€…å’Œå†™è€…çš„æ•°é‡ï¼ŒChannel åˆå¯ä»¥åˆ†ä¸ºï¼š</p>
<ul>
<li>
<p>SPSCï¼šSingle-Producer Single-Consumerï¼Œå•ç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚æœ€ç®€å•ï¼Œå¯ä»¥ä¸ä¾èµ–äº Mutexï¼Œåªç”¨ atomics å°±å¯ä»¥å®ç°ã€‚</p>
</li>
<li>
<p>SPMCï¼šSingle-Producer Multi-Consumerï¼Œå•ç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨æ¶ˆè´¹è€…è¿™ä¾§è¯»å–æ—¶åŠ é”ã€‚</p>
</li>
<li>
<p>MPSCï¼šMulti-Producer Single-Consumerï¼Œå¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…è¿™ä¾§å†™å…¥æ—¶åŠ é”ã€‚</p>
</li>
<li>
<p>MPMCï¼šMulti-Producer Multi-Consumerã€‚å¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ã€‚éœ€è¦åœ¨ç”Ÿäº§è€…å†™å…¥æˆ–è€…æ¶ˆè´¹è€…è¯»å–æ—¶åŠ é”ã€‚</p>
</li>
</ul>
<blockquote>
<p>åœ¨ä¼—å¤š Channel ç±»å‹ä¸­ï¼Œä½¿ç”¨æœ€å¹¿çš„æ˜¯ MPSC channelï¼Œå¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…ï¼Œå› ä¸ºå¾€å¾€æˆ‘ä»¬å¸Œæœ›é€šè¿‡å•æ¶ˆè´¹è€…æ¥ä¿è¯ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯çš„æ•°æ®ç»“æ„æœ‰ç‹¬å çš„å†™è®¿é—®ã€‚</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/34%EF%BD%9C%E5%B9%B6%E5%8F%91%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89%EF%BC%9A%E4%BB%8Eatomics%E5%88%B0Channel%EF%BC%8CRust%E9%83%BD%E6%8F%90%E4%BE%9B%E4%BA%86%E4%BB%80%E4%B9%88%E5%B7%A5%E5%85%B7%EF%BC%9F.jpg" alt="34ï½œå¹¶å‘å¤„ç†ï¼ˆä¸‹ï¼‰ï¼šä»atomicsåˆ°Channelï¼ŒRustéƒ½æä¾›äº†ä»€ä¹ˆå·¥å…·ï¼Ÿ" /></p>
<p>æ¯”å¦‚ï¼Œ<a href="https://github.com/tyrchen/xunmi/blob/master/src/indexer.rs#L50">åœ¨ xunmi çš„å®ç°ä¸­</a>: </p>
<ol>
<li>index writer å†…éƒ¨æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹çš„å®ç°</li>
<li>ä½†åœ¨ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°å®ƒçš„å¯å†™å¼•ç”¨ã€‚</li>
</ol>
<p>å¦‚æœè¦èƒ½å¤Ÿåœ¨å„ç§ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ index writerï¼Œæˆ‘ä»¬å°±ä¸å¾—ä¸å°†å…¶ç”¨ Arc&lt;Mutex<T>&gt; åŒ…è£¹èµ·æ¥ï¼Œä½†è¿™æ ·åœ¨ç´¢å¼•å¤§é‡æ•°æ®æ—¶æ•ˆç‡å¤ªä½ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ MPSC channelï¼Œè®©å„ç§ä¸Šä¸‹æ–‡éƒ½æŠŠæ•°æ®å‘é€ç»™å•ä¸€çš„çº¿ç¨‹ï¼Œä½¿ç”¨ index writer ç´¢å¼•ï¼Œè¿™æ ·å°±é¿å…äº†é”ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct IndexInner {
    index: Index,
    reader: IndexReader,
    config: IndexConfig,
    updater: Sender&lt;Input&gt;,
}

pub struct IndexUpdater {
    sender: Sender&lt;Input&gt;,
    t2s: bool,
    schema: Schema,
}

impl Indexer {
    // æ‰“å¼€æˆ–è€…åˆ›å»ºä¸€ä¸ª index
    pub fn open_or_create(config: IndexConfig) -&gt; Result&lt;Self&gt; {
        let schema = config.schema.clone();
        let index = if let Some(dir) = &amp;config.path {
            fs::create_dir_all(dir)?;
            let dir = MmapDirectory::open(dir)?;
            Index::open_or_create(dir, schema.clone())?
        } else {
            Index::create_in_ram(schema.clone())
        };

        Self::set_tokenizer(&amp;index, &amp;config);

        let mut writer = index.writer(config.writer_memory)?;

        // åˆ›å»ºä¸€ä¸ª unbounded MPSC channel
        let (s, r) = unbounded::&lt;Input&gt;();

        // å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä» channel çš„ reader ä¸­è¯»å–æ•°æ®
        thread::spawn(move || {
            for input in r {
                // ç„¶åç”¨ index writer å¤„ç†è¿™ä¸ª input
                if let Err(e) = input.process(&amp;mut writer, &amp;schema) {
                    warn!(&quot;Failed to process input. Error: {:?}&quot;, e);
                }
            }
        });

        // æŠŠ channel çš„ sender éƒ¨åˆ†å­˜å…¥ IndexInner ç»“æ„
        Self::new(index, config, s)
    }

    pub fn get_updater(&amp;self) -&gt; IndexUpdater {
        let t2s = TextLanguage::Chinese(true) == self.config.text_lang;
        // IndexUpdater å†…éƒ¨åŒ…å« channel çš„ sender éƒ¨åˆ†
        // ç”±äºæ˜¯ MPSC channelï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç®€å• clone ä¸€ä¸‹ sender
        // è¿™ä¹Ÿæ„å‘³ç€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä»»æ„å¤šä¸ª IndexUpdater åœ¨ä¸åŒä¸Šä¸‹æ–‡å‘é€æ•°æ®
        // è€Œæ•°æ®æœ€ç»ˆéƒ½ä¼šé€šè¿‡ channel ç»™åˆ°ä¸Šé¢åˆ›å»ºçš„çº¿ç¨‹ï¼Œç”± index writer å¤„ç†
        IndexUpdater::new(self.updater.clone(), self.index.schema(), t2s)
    }
}
</code></pre></pre>
</div>
</details>
<h3 id="actor"><a class="header" href="#actor">Actor</a></h3>
<details id="admonition-ç®€å•ä»‹ç»actorå¹¶ä¸¾ä¾‹" class="admonition info">
<summary class="admonition-title">
<p>ç®€å•ä»‹ç»Actorï¼Œå¹¶ä¸¾ä¾‹</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ç®€å•ä»‹ç»actorå¹¶ä¸¾ä¾‹"></a></p>
</summary>
<div>
<p>æœ€åæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ <a href="https://en.wikipedia.org/wiki/Actor_model">actor model</a>ï¼Œå®ƒåœ¨ä¸šç•Œä¸»è¦çš„ä½¿ç”¨è€…æ˜¯ Erlang VM ä»¥åŠ <a href="https://akka.io/">akka</a>ã€‚actor æ˜¯ä¸€ç§æœ‰æ ˆåç¨‹:</p>
<ol>
<li>æ¯ä¸ª actorï¼Œæœ‰è‡ªå·±çš„ä¸€ä¸ªç‹¬ç«‹çš„ã€è½»é‡çº§çš„è°ƒç”¨æ ˆ</li>
<li>ä»¥åŠä¸€ä¸ªç”¨æ¥æ¥å—æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆmailbox æˆ–è€… message queueï¼‰</li>
<li>å¤–ç•Œè·Ÿ actor æ‰“äº¤é“çš„å”¯ä¸€æ‰‹æ®µå°±æ˜¯ï¼Œç»™å®ƒå‘é€æ¶ˆæ¯ã€‚</li>
</ol>
<p>Rust æ ‡å‡†åº“æ²¡æœ‰ actor çš„å®ç°ï¼Œä½†æ˜¯ç¤¾åŒºé‡Œæœ‰æ¯”è¾ƒæˆç†Ÿçš„ <a href="https://github.com/actix/actix">actix</a>ï¼ˆå¤§åé¼é¼çš„ actix-web å°±æ˜¯åŸºäº actix å®ç°çš„ï¼‰ï¼Œä»¥åŠ <a href="https://github.com/bastion-rs/bastion">bastion</a>ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç ç”¨ actix å®ç°äº†ä¸€ä¸ªç®€å•çš„ DummyActorï¼Œå®ƒå¯ä»¥æ¥æ”¶ä¸€ä¸ª InMsgï¼Œè¿”å›ä¸€ä¸ª OutMsgï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use actix::prelude::*;
use anyhow::Result;

// actor å¯ä»¥å¤„ç†çš„æ¶ˆæ¯
#[derive(Message, Debug, Clone, PartialEq)]
#[rtype(result = &quot;OutMsg&quot;)]
enum InMsg {
    Add((usize, usize)),
    Concat((String, String)),
}

#[derive(MessageResponse, Debug, Clone, PartialEq)]
enum OutMsg {
    Num(usize),
    Str(String),
}

// Actor
struct DummyActor;

impl Actor for DummyActor {
    type Context = Context&lt;Self&gt;;
}

// å®ç°å¤„ç† InMsg çš„ Handler trait
impl Handler&lt;InMsg&gt; for DummyActor {
    type Result = OutMsg; // &lt;-  è¿”å›çš„æ¶ˆæ¯

    fn handle(&amp;mut self, msg: InMsg, _ctx: &amp;mut Self::Context) -&gt; Self::Result {
        match msg {
            InMsg::Add((a, b)) =&gt; OutMsg::Num(a + b),
            InMsg::Concat((mut s1, s2)) =&gt; {
                s1.push_str(&amp;s2);
                OutMsg::Str(s1)
            }
        }
    }
}

#[actix::main]
async fn main() -&gt; Result&lt;()&gt; {
    let addr = DummyActor.start();
    let res = addr.send(InMsg::Add((21, 21))).await?;
    let res1 = addr
        .send(InMsg::Concat((&quot;hello, &quot;.into(), &quot;world&quot;.into())))
        .await?;

    println!(&quot;res: {:?}, res1: {:?}&quot;, res, res1);

    Ok(())
}
</code></pre></pre>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹ DummyActorï¼Œæˆ‘ä»¬åªéœ€è¦å®ç° Actor trait å’Œ Handler<InMsg> trait ã€‚</p>
</blockquote>
</div>
</details>
<h3 id="å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯"><a class="header" href="#å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯">å°ç»“ä¸€ä¸‹å„ç§å¹¶å‘åŸè¯­çš„ä½¿ç”¨åœºæ™¯</a></h3>
<details id="admonition-å¦‚ä½•æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ä½¿ç”¨atomicmutexrwlocksemaphorecondvarchannelactor" class="admonition info">
<summary class="admonition-title">
<p>å¦‚ä½•æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ä½¿ç”¨Atomicã€Mutexã€RwLockã€Semaphoreã€Condvarã€Channelã€Actor</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å¦‚ä½•æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©ä½¿ç”¨atomicmutexrwlocksemaphorecondvarchannelactor"></a></p>
</summary>
<div>
<blockquote>
<p>Atomicã€Mutexã€RwLockã€Semaphoreã€Condvarã€Channelã€Actorã€‚</p>
</blockquote>
<ol>
<li>Atomic åœ¨å¤„ç†ç®€å•çš„åŸç”Ÿç±»å‹æ—¶éå¸¸æœ‰ç”¨ï¼Œå¦‚æœä½ å¯ä»¥é€šè¿‡ AtomicXXX ç»“æ„è¿›è¡ŒåŒæ­¥ï¼Œé‚£ä¹ˆå®ƒä»¬æ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚</li>
<li>å½“ä½ çš„æ•°æ®ç»“æ„æ— æ³•ç®€å•é€šè¿‡ AtomicXXX è¿›è¡ŒåŒæ­¥ï¼Œä½†ä½ åˆçš„ç¡®éœ€è¦åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆ Mutex / RwLock å¯ä»¥æ˜¯ä¸€ç§é€‰æ‹©ã€‚ä¸è¿‡ï¼Œä½ éœ€è¦è€ƒè™‘é”çš„ç²’åº¦ï¼Œç²’åº¦å¤ªå¤§çš„ Mutex / RwLock æ•ˆç‡å¾ˆä½ã€‚</li>
<li>å¦‚æœä½ æœ‰ N ä»½èµ„æºå¯ä»¥ä¾›å¤šä¸ªå¹¶å‘ä»»åŠ¡ç«äº‰ä½¿ç”¨ï¼Œé‚£ä¹ˆï¼ŒSemaphore æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚æ¯”å¦‚ä½ è¦åšä¸€ä¸ª DB è¿æ¥æ± ã€‚</li>
<li>å½“ä½ éœ€è¦åœ¨å¹¶å‘ä»»åŠ¡ä¸­é€šçŸ¥ã€åä½œæ—¶ï¼ŒCondvar æä¾›äº†æœ€åŸºæœ¬çš„é€šçŸ¥æœºåˆ¶ï¼Œè€Œ Channel æŠŠè¿™ä¸ªé€šçŸ¥æœºåˆ¶è¿›ä¸€æ­¥å¹¿æ³›æ‰©å±•å¼€ï¼Œäºæ˜¯ä½ å¯ä»¥ç”¨ Condvar è¿›è¡Œç‚¹å¯¹ç‚¹çš„åŒæ­¥ï¼Œç”¨ Channel åšä¸€å¯¹å¤šã€å¤šå¯¹ä¸€ã€å¤šå¯¹å¤šçš„åŒæ­¥ã€‚</li>
</ol>
<blockquote>
<p>æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åšå¤§éƒ¨åˆ†å¤æ‚çš„ç³»ç»Ÿè®¾è®¡æ—¶ï¼ŒChannel å¾€å¾€æ˜¯æœ€æœ‰åŠ›çš„æ­¦å™¨ï¼Œé™¤äº†å¯ä»¥è®©æ•°æ®ç©¿æ¢­äºå„ä¸ªçº¿ç¨‹ã€å„ä¸ªå¼‚æ­¥ä»»åŠ¡é—´ï¼Œå®ƒçš„æ¥å£è¿˜å¯ä»¥å¾ˆä¼˜é›…åœ°è·Ÿ stream é€‚é…ã€‚</p>
</blockquote>
<p>å¦‚æœè¯´åœ¨åšæ•´ä¸ªåç«¯çš„ç³»ç»Ÿæ¶æ„æ—¶ï¼Œæˆ‘ä»¬ç€çœ¼çš„æ˜¯ï¼šæœ‰å“ªäº›æœåŠ¡ã€æœåŠ¡å’ŒæœåŠ¡ä¹‹é—´å¦‚ä½•é€šè®¯ã€æ•°æ®å¦‚ä½•æµåŠ¨ã€æœåŠ¡å’ŒæœåŠ¡é—´å¦‚ä½•åŒæ­¥ï¼›
é‚£ä¹ˆåœ¨åšæŸä¸€ä¸ªæœåŠ¡çš„æ¶æ„æ—¶ï¼Œç€çœ¼çš„æ˜¯æœ‰å“ªäº›åŠŸèƒ½æ€§çš„çº¿ç¨‹ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰ã€å®ƒä»¬ä¹‹é—´çš„æ¥å£æ˜¯ä»€ä¹ˆæ ·å­ã€æ•°æ®å¦‚ä½•æµåŠ¨ã€å¦‚ä½•åŒæ­¥ã€‚</p>
<p>åœ¨è¿™é‡Œï¼ŒChannel å…¼å…·æ¥å£ã€åŒæ­¥å’Œæ•°æ®æµä¸‰ç§åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘è¯´æ˜¯æœ€æœ‰åŠ›çš„æ­¦å™¨ã€‚</p>
<p>ç„¶è€Œå®ƒä¸è¯¥æ˜¯å”¯ä¸€çš„æ­¦å™¨ã€‚æˆ‘ä»¬é¢ä¸´çš„çœŸå®ä¸–ç•Œçš„å¹¶å‘é—®é¢˜æ˜¯å¤šæ ·çš„ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿåº”è¯¥æ˜¯å¤šæ ·çš„ï¼Œè®¡ç®—æœºç§‘å­¦å®¶ä»¬åœ¨è¿‡å»çš„å‡ åå¹´é‡Œä¸æ–­æ¢ç´¢ï¼Œæ„å»ºäº†ä¸€ç³»åˆ—çš„å¹¶å‘åŸè¯­ï¼Œä¹Ÿè¯´æ˜äº†å¾ˆéš¾æœ‰ä¸€ç§é“¶å¼¹è§£å†³æ‰€æœ‰é—®é¢˜ã€‚</p>
<p>å°±è¿ Mutex æœ¬èº«ï¼Œåœ¨å®ç°ä¸­ï¼Œè¿˜ä¼šæ ¹æ®ä¸åŒçš„åœºæ™¯åšä¸åŒçš„å¦¥åï¼ˆæ¯”å¦‚åš faireness çš„å¦¥åï¼‰ï¼Œå› ä¸ºè¿™ä¸ªä¸–ç•Œå°±æ˜¯è¿™æ ·ï¼Œé±¼ä¸ç†ŠæŒä¸å¯å…¼å¾—ï¼Œæ²¡æœ‰å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œåªæœ‰å¦¥åå‡ºæ¥çš„è§£å†³æ–¹æ¡ˆã€‚æ‰€ä»¥ Channel ä¸æ˜¯é“¶å¼¹ï¼Œactor model ä¸æ˜¯é“¶å¼¹ï¼Œlock ä¸æ˜¯é“¶å¼¹ã€‚</p>
<p>ä¸€é—¨å¥½çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¯ä»¥æä¾›å¤§éƒ¨åˆ†åœºæ™¯ä¸‹çš„æœ€ä½³å®è·µï¼ˆå¦‚ Erlang/Golangï¼‰ï¼Œä½†ä¸è¯¥è¥é€ ä¸€ç§æ°”æ°›ï¼Œåªæœ‰æŸä¸ªæœ€ä½³å®è·µæ‰æ˜¯å”¯ä¸€æ–¹æ¡ˆã€‚æˆ‘å¾ˆå–œæ¬¢ Erlang çš„ actor model å’Œ Golang çš„ Channelï¼Œä½†å¾ˆå¯æƒœï¼Œå®ƒä»¬è¿‡åˆ†ä¾èµ–ç‰¹å®šçš„ã€å”¯ä¸€çš„å¹¶å‘æ–¹æ¡ˆï¼Œä½¿å¾—å¼€å‘è€…æ‹¿ç€æ¦”å¤´ï¼Œçœ‹ä»€ä¹ˆéƒ½æ˜¯é’‰å­ã€‚</p>
<p>ç›¸åï¼ŒRust æä¾›å‡ ä¹ä½ éœ€è¦çš„æ‰€æœ‰è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”å¹¶ä¸é¼“å¹å®ƒä»¬çš„ä¼˜åŠ£ï¼Œå®Œå…¨äº¤ç”±ä½ æŒ‰éœ€é€‰æ‹©ã€‚æˆ‘åœ¨ç”¨ Rust æ’°å†™å¤šçº¿ç¨‹åº”ç”¨æ—¶ï¼ŒChannel ä»ç„¶æ˜¯ç¬¬ä¸€é€‰æ‹©ï¼Œä½†æˆ‘è¿˜æ˜¯ä¼šåœ¨åˆé€‚çš„æ—¶å€™ä½¿ç”¨ Mutexã€RwLockã€Semaphoreã€Condvarã€Atomic ç­‰å·¥å…·ï¼Œè€Œä¸æ˜¯è¯•å›¾ç¬¨æ‹™åœ°ç”¨ Channel å åŠ  Channel æ¥åº”å¯¹æ‰€æœ‰çš„åœºæ™¯ã€‚</p>
</div>
</details>
<h2 id="è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„mpsc-channel"><a class="header" href="#è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„mpsc-channel">è‡ªå·±å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC Channel</a></h2>
<p>ä¹‹å‰æˆ‘ä»¬è°ˆè®ºäº†å¦‚ä½•åœ¨æœç´¢å¼•æ“çš„ Index writer ä¸Šä½¿ç”¨ MPSC channelï¼š</p>
<ol>
<li>è¦æ›´æ–° index çš„ä¸Šä¸‹æ–‡æœ‰å¾ˆå¤šï¼ˆå¯ä»¥æ˜¯çº¿ç¨‹ä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼‰</li>
<li>è€Œ IndexWriter åªèƒ½æ˜¯å”¯ä¸€çš„ã€‚</li>
<li>ä¸ºäº†é¿å…åœ¨è®¿é—® IndexWriter æ—¶åŠ é”ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ MPSC channel</li>
<li>åœ¨å¤šä¸ªä¸Šä¸‹æ–‡ä¸­ç»™ channel å‘æ¶ˆæ¯ï¼Œç„¶ååœ¨å”¯ä¸€æ‹¥æœ‰ IndexWriter çš„çº¿ç¨‹ä¸­è¯»å–è¿™äº›æ¶ˆæ¯ï¼Œéå¸¸é«˜æ•ˆã€‚</li>
</ol>
<p>å¥½ï¼Œæ¥çœ‹çœ‹ä»Šå¤©è¦å®ç°çš„ MPSC channel çš„åŸºæœ¬åŠŸèƒ½ã€‚ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œæˆ‘ä»¬åªå…³å¿ƒ unbounded MPSC
channelã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“é˜Ÿåˆ—å®¹é‡ä¸å¤Ÿæ—¶ï¼Œä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œæ‰€ä»¥ï¼Œä»»ä½•æ—¶å€™ç”Ÿäº§è€…å†™å…¥æ•°æ®éƒ½ä¸ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œæ¶ˆè´¹è€…ä¼šè¢«é˜»å¡ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/35%EF%BD%9C%E5%AE%9E%E6%93%8D%E9%A1%B9%E7%9B%AE%EF%BC%9A%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%9F%BA%E6%9C%AC%E7%9A%84MPSC%20channel%EF%BC%9F.jpg" alt="35ï½œå®æ“é¡¹ç›®ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªåŸºæœ¬çš„MPSC channelï¼Ÿ" /></p>
<h3 id="æµ‹è¯•é©±åŠ¨çš„è®¾è®¡"><a class="header" href="#æµ‹è¯•é©±åŠ¨çš„è®¾è®¡">æµ‹è¯•é©±åŠ¨çš„è®¾è®¡</a></h3>
<p>ä¹‹å‰æˆ‘ä»¬ä¼šä»éœ€æ±‚çš„è§’åº¦æ¥è®¾è®¡æ¥å£å’Œæ•°æ®ç»“æ„ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¢ç§æ–¹å¼ï¼Œå®Œå…¨ç«™åœ¨ä½¿ç”¨è€…çš„è§’åº¦ï¼Œç”¨ä½¿ç”¨å®ä¾‹ï¼ˆæµ‹è¯•ï¼‰æ¥é©±åŠ¨æ¥å£å’Œæ•°æ®ç»“æ„çš„è®¾è®¡ã€‚</p>
<details id="admonition-éœ€æ±‚1-åŸºæœ¬çš„-sendrecv" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚1: åŸºæœ¬çš„ send/recv</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-éœ€æ±‚1-åŸºæœ¬çš„-sendrecv"></a></p>
</summary>
<div>
<p>è¦å®ç°åˆšæ‰è¯´çš„ MPSC channelï¼Œéƒ½æœ‰ä»€ä¹ˆéœ€æ±‚å‘¢ï¼Ÿé¦–å…ˆï¼Œç”Ÿäº§è€…å¯ä»¥äº§ç”Ÿæ•°æ®ï¼Œæ¶ˆè´¹è€…èƒ½å¤Ÿæ¶ˆè´¹äº§ç”Ÿå‡ºæ¥çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯åŸºæœ¬çš„ send/recvï¼Œæˆ‘ä»¬ä»¥ä¸‹é¢è¿™ä¸ªå•å…ƒæµ‹è¯• 1 æ¥æè¿°è¿™ä¸ªéœ€æ±‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn channel_should_work() {
    let (mut s, mut r) = unbounded();
    s.send(&quot;hello world!&quot;.to_string()).unwrap();
    let msg = r.recv().unwrap();
    assert_eq!(msg, &quot;hello world!&quot;);
}
</code></pre></pre>
<ol>
<li>è¿™é‡Œï¼Œé€šè¿‡ unbounded() æ–¹æ³•ï¼Œ å¯ä»¥åˆ›å»ºä¸€ä¸ª sender å’Œä¸€ä¸ª receiver</li>
<li>sender æœ‰ send() æ–¹æ³•ï¼Œå¯ä»¥å‘é€æ•°æ®</li>
<li>receiver æœ‰ recv() æ–¹æ³•ï¼Œå¯ä»¥æ¥å—æ•°æ®ã€‚</li>
<li>æ•´ä½“çš„æ¥å£ï¼Œæˆ‘ä»¬è®¾è®¡å’Œ std::sync::mpsc ä¿æŒä¸€è‡´ï¼Œé¿å…ä½¿ç”¨è€…ä½¿ç”¨ä¸Šçš„å¿ƒæ™ºè´Ÿæ‹…ã€‚</li>
</ol>
<p>ä¸ºäº†å®ç°è¿™æ ·ä¸€ä¸ªæ¥å£ï¼Œéœ€è¦ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å‘¢ï¼Ÿ</p>
<ol>
<li>é¦–å…ˆï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¼šå…±äº«ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨ VecDequeã€‚</li>
<li>æ˜¾ç„¶ï¼Œè¿™ä¸ªé˜Ÿåˆ—åœ¨æ’å…¥å’Œå–å‡ºæ•°æ®æ—¶éœ€è¦äº’æ–¥ï¼Œæ‰€ä»¥éœ€è¦ç”¨ Mutex æ¥ä¿æŠ¤å®ƒã€‚</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
}

pub struct Sender&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}

pub struct Receiver&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}
</code></pre></pre>
<p>è¿™æ ·çš„æ•°æ®ç»“æ„åº”è¯¥å¯ä»¥æ»¡è¶³å•å…ƒæµ‹è¯• 1ã€‚</p>
</div>
</details>
<details id="admonition-éœ€æ±‚2-å…è®¸å¤šä¸ª-sender-å¾€-channel-é‡Œå‘é€æ•°æ®" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚2: å…è®¸å¤šä¸ª sender å¾€ channel é‡Œå‘é€æ•°æ® </p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-éœ€æ±‚2-å…è®¸å¤šä¸ª-sender-å¾€-channel-é‡Œå‘é€æ•°æ®"></a></p>
</summary>
<div>
<p>ç”±äºéœ€è¦çš„æ˜¯ MPSCï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å…è®¸å¤šä¸ª sender å¾€ channel é‡Œå‘é€æ•°æ®ï¼Œç”¨å•å…ƒæµ‹è¯• 2 æ¥æè¿°è¿™ä¸ªéœ€æ±‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn multiple_senders_should_work() {
    let (mut s, mut r) = unbounded();
    let mut s1 = s.clone();
    let mut s2 = s.clone();
    let t = thread::spawn(move || {
        s.send(1).unwrap();
    });
    let t1 = thread::spawn(move || {
        s1.send(2).unwrap();
    });
    let t2 = thread::spawn(move || {
        s2.send(3).unwrap();
    });
    for handle in [t, t1, t2] {
        handle.join().unwrap();
    }

    let mut result = [r.recv().unwrap(), r.recv().unwrap(), r.recv().unwrap()];
    // åœ¨è¿™ä¸ªæµ‹è¯•é‡Œï¼Œæ•°æ®åˆ°è¾¾çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ’ä¸ªåºå† assert
    result.sort();

    assert_eq!(result, [1, 2, 3]);
}
</code></pre></pre>
<p>è¿™ä¸ªéœ€æ±‚ï¼Œåˆšæ‰çš„æ•°æ®ç»“æ„å°±å¯ä»¥æ»¡è¶³ï¼Œåªæ˜¯ Sender éœ€è¦å®ç° Clone traitã€‚ä¸è¿‡æˆ‘ä»¬åœ¨å†™è¿™ä¸ªæµ‹è¯•çš„æ—¶å€™ç¨å¾®æœ‰äº›åˆ«æ‰­ï¼Œå› ä¸ºè¿™ä¸€è¡Œæœ‰ä¸æ–­é‡å¤çš„ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let mut result = [r.recv().unwrap(), r.recv().unwrap(), r.recv().unwrap()];
</code></pre></pre>
<p>æ³¨æ„ï¼Œæµ‹è¯•ä»£ç çš„ DRY ä¹Ÿå¾ˆé‡è¦ï¼Œæˆ‘ä»¬ä¹‹å‰å¼ºè°ƒè¿‡ã€‚æ‰€ä»¥ï¼Œå½“å†™ä¸‹è¿™ä¸ªæµ‹è¯•çš„æ—¶å€™ï¼Œä¹Ÿè®¸ä¼šæƒ³ï¼Œæˆ‘ä»¬å¯å¦æä¾› Iterator çš„å®ç°ï¼Ÿæ©è¿™ä¸ªæƒ³æ³•å…ˆæš‚å­˜ä¸‹æ¥ã€‚</p>
</div>
</details>
<details id="admonition-éœ€æ±‚3-å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™receiver-æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚3: å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™ï¼Œreceiver æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-éœ€æ±‚3-å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™receiver-æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡"></a></p>
</summary>
<div>
<p>æ¥ä¸‹æ¥è€ƒè™‘å½“é˜Ÿåˆ—ç©ºçš„æ—¶å€™ï¼Œreceiver æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«é˜»å¡è¿™ä¸ªéœ€æ±‚ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•å¯¹è¿™ä¸ªéœ€æ±‚è¿›è¡Œæµ‹è¯•å‘¢ï¼Ÿè¿™å¹¶ä¸ç®€å•ï¼Œæˆ‘ä»¬æ²¡æœ‰æ¯”è¾ƒç›´è§‚çš„æ–¹å¼æ¥æ£€æµ‹çº¿ç¨‹çš„çŠ¶æ€ã€‚</p>
<p>ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æµ‹â€œçº¿ç¨‹æ˜¯å¦é€€å‡ºâ€æ¥é—´æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«é˜»å¡ã€‚</p>
<p>ç†ç”±å¾ˆç®€å•:</p>
<ol>
<li>å¦‚æœçº¿ç¨‹æ²¡æœ‰ç»§ç»­å·¥ä½œï¼Œåˆæ²¡æœ‰é€€å‡ºï¼Œé‚£ä¹ˆä¸€å®šè¢«é˜»å¡ä½äº†ã€‚</li>
<li>é˜»å¡ä½ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­å‘é€æ•°æ®ï¼Œæ¶ˆè´¹è€…æ‰€åœ¨çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­å·¥ä½œ</li>
<li>æ‰€ä»¥æœ€ç»ˆé˜Ÿåˆ—é•¿åº¦åº”è¯¥ä¸º 0ã€‚æˆ‘ä»¬çœ‹å•å…ƒæµ‹è¯• 3ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn receiver_should_be_blocked_when_nothing_to_read() {
    let (mut s, r) = unbounded();
    let mut s1 = s.clone();
    thread::spawn(move || {
        for (idx, i) in r.into_iter().enumerate() {
            // å¦‚æœè¯»åˆ°æ•°æ®ï¼Œç¡®ä¿å®ƒå’Œå‘é€çš„æ•°æ®ä¸€è‡´
            assert_eq!(idx, i);
        }
        // è¯»ä¸åˆ°åº”è¯¥ä¼‘çœ ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€å¥ï¼Œæ‰§è¡Œåˆ°è¿™ä¸€å¥è¯´æ˜é€»è¾‘å‡ºé”™
        assert!(false);
    });

    thread::spawn(move || {
        for i in 0..100usize {
            s.send(i).unwrap();
        }
    });

    // 1ms è¶³å¤Ÿè®©ç”Ÿäº§è€…å‘å®Œ 100 ä¸ªæ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹å®Œ 100 ä¸ªæ¶ˆæ¯å¹¶é˜»å¡
    thread::sleep(Duration::from_millis(1));

    // å†æ¬¡å‘é€æ•°æ®ï¼Œå”¤é†’æ¶ˆè´¹è€…
    for i in 100..200usize {
        s1.send(i).unwrap();
    }

    // ç•™ç‚¹æ—¶é—´è®© receiver å¤„ç†
    thread::sleep(Duration::from_millis(1));

    // å¦‚æœ receiver è¢«æ­£å¸¸å”¤é†’å¤„ç†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—é‡Œçš„æ•°æ®ä¼šéƒ½è¢«è¯»å®Œ
    assert_eq!(s1.total_queued_items(), 0);
}
</code></pre></pre>
<p>è¿™ä¸ªæµ‹è¯•ä»£ç ä¸­:</p>
<ol>
<li>æˆ‘ä»¬å‡å®š receiver å®ç°äº† Iterator</li>
<li>è¿˜å‡å®š sender æä¾›äº†ä¸€ä¸ªæ–¹æ³• total_queued_items()ã€‚è¿™äº›å¯ä»¥åœ¨å®ç°çš„æ—¶å€™å†å¤„ç†ã€‚</li>
</ol>
<p>ä½ å¯ä»¥èŠ±äº›æ—¶é—´ä»”ç»†çœ‹çœ‹è¿™æ®µä»£ç ï¼Œæƒ³æƒ³å…¶ä¸­çš„å¤„ç†é€»è¾‘ã€‚è™½ç„¶ä»£ç å¾ˆç®€å•ï¼Œä¸éš¾ç†è§£ï¼Œä½†æ˜¯æŠŠä¸€ä¸ªå®Œæ•´çš„éœ€æ±‚è½¬åŒ–æˆåˆé€‚çš„æµ‹è¯•ä»£ç ï¼Œè¿˜æ˜¯è¦é¢‡è´¹äº›å¿ƒæ€çš„ã€‚</p>
<p>å¥½ï¼Œå¦‚æœè¦èƒ½æ”¯æŒé˜Ÿåˆ—ä¸ºç©ºæ—¶é˜»å¡ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Condvarã€‚</p>
<p>æ‰€ä»¥ Shared<T> éœ€è¦ä¿®æ”¹ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
}
</code></pre></pre>
<p>è¿™æ ·å½“å®ç° Receiver çš„ recv() æ–¹æ³•åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯»ä¸åˆ°æ•°æ®æ—¶é˜»å¡çº¿ç¨‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
// æ‹¿åˆ°é”
let mut inner = self.shared.queue.lock().unwrap();
// ... å‡è®¾è¯»ä¸åˆ°æ•°æ®
// ä½¿ç”¨ condvar å’Œ MutexGuard é˜»å¡å½“å‰çº¿ç¨‹
self.shared.available.wait(inner)
</code></pre></pre>
</div>
</details>
<details id="admonition-éœ€æ±‚4-receiveræ²¡æœ‰æ•°æ®å¯è¯»" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚4: Receiveræ²¡æœ‰æ•°æ®å¯è¯»</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-éœ€æ±‚4-receiveræ²¡æœ‰æ•°æ®å¯è¯»"></a></p>
</summary>
<div>
<p>é¡ºç€åˆšæ‰çš„å¤šä¸ª sender æƒ³ï¼Œå¦‚æœç°åœ¨æ‰€æœ‰ Sender éƒ½é€€å‡ºä½œç”¨åŸŸï¼ŒReceiver ç»§ç»­æ¥æ”¶ï¼Œåˆ°æ²¡æœ‰æ•°æ®å¯è¯»äº†ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿæ˜¯ä¸æ˜¯åº”è¯¥äº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼Œè®©è°ƒç”¨è€…çŸ¥é“ï¼Œç°åœ¨ channel çš„å¦ä¸€ä¾§å·²ç»æ²¡æœ‰ç”Ÿäº§è€…äº†ï¼Œå†è¯»ä¹Ÿè¯»ä¸å‡ºæ•°æ®äº†ï¼Ÿ</p>
<p>æˆ‘ä»¬æ¥å†™å•å…ƒæµ‹è¯• 4ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn last_sender_drop_should_error_when_receive() {
    let (s, mut r) = unbounded();
    let s1 = s.clone();
    let senders = [s, s1];
    let total = senders.len();

    // sender å³ç”¨å³æŠ›
    for mut sender in senders {
        thread::spawn(move || {
            sender.send(&quot;hello&quot;).unwrap();
            // sender åœ¨æ­¤è¢«ä¸¢å¼ƒ
        })
        .join()
        .unwrap();
    }

    // è™½ç„¶æ²¡æœ‰ sender äº†ï¼Œæ¥æ”¶è€…ä¾ç„¶å¯ä»¥æ¥å—å·²ç»åœ¨é˜Ÿåˆ—é‡Œçš„æ•°æ®
    for _ in 0..total {
        r.recv().unwrap();
    }

    // ç„¶è€Œï¼Œè¯»å–æ›´å¤šæ•°æ®æ—¶ä¼šå‡ºé”™
    assert!(r.recv().is_err());
}
</code></pre></pre>
<p>è¿™ä¸ªæµ‹è¯•ä¾æ—§å¾ˆç®€å•ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œä½¿ç”¨ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å¯ä»¥è¾¾åˆ°è¿™æ ·çš„ç›®çš„:</p>
<ol>
<li>é¦–å…ˆï¼Œæ¯æ¬¡ Clone æ—¶ï¼Œè¦å¢åŠ  Sender çš„è®¡æ•°ï¼›</li>
<li>åœ¨ Sender Drop æ—¶ï¼Œå‡å°‘è¿™ä¸ªè®¡æ•°ï¼›</li>
<li>ç„¶åï¼Œæˆ‘ä»¬ä¸º Receiver æä¾›ä¸€ä¸ªæ–¹æ³• total_senders()ï¼Œæ¥è¯»å– Sender çš„è®¡æ•°</li>
<li>å½“è®¡æ•°ä¸º 0ï¼Œä¸”é˜Ÿåˆ—ä¸­æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œrecv() æ–¹æ³•å°±æŠ¥é”™ã€‚</li>
</ol>
<blockquote>
<p>æœ‰äº†è¿™ä¸ªæ€è·¯ï¼Œä½ æƒ³ä¸€æƒ³ï¼Œè¿™ä¸ªè®¡æ•°å™¨ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿç”¨é”ä¿æŠ¤ä¹ˆï¼Ÿ</p>
</blockquote>
<p>å“ˆï¼Œä½ ä¸€å®šæƒ³åˆ°äº†å¯ä»¥ä½¿ç”¨ atomicsã€‚å¯¹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ AtomicUsizeã€‚æ‰€ä»¥ï¼ŒShared æ•°æ®ç»“æ„éœ€è¦æ›´æ–°ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
    senders: AtomicUsize,
}
</code></pre></pre>
</div>
</details>
<details id="admonition-éœ€æ±‚5-æ²¡æœ‰receiverå¤„ç†æ•°æ®" class="admonition info">
<summary class="admonition-title">
<p>éœ€æ±‚5: æ²¡æœ‰Receiverå¤„ç†æ•°æ®</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-éœ€æ±‚5-æ²¡æœ‰receiverå¤„ç†æ•°æ®"></a></p>
</summary>
<div>
<p>æ—¢ç„¶æ²¡æœ‰ Sender äº†è¦æŠ¥é”™ï¼Œé‚£ä¹ˆå¦‚æœæ²¡æœ‰ Receiver äº†ï¼ŒSender å‘é€æ—¶æ˜¯ä¸æ˜¯ä¹Ÿåº”è¯¥é”™è¯¯è¿”å›ï¼Ÿè¿™ä¸ªéœ€æ±‚å’Œä¸Šé¢ç±»ä¼¼ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚çœ‹æ„é€ çš„å•å…ƒæµ‹è¯• 5ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn receiver_drop_should_error_when_send() {
    let (mut s1, mut s2) = {
        let (s, _) = unbounded();
        let s1 = s.clone();
        let s2 = s.clone();
        (s1, s2)
    };

    assert!(s1.send(1).is_err());
    assert!(s2.send(1).is_err());
}
</code></pre></pre>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª channelï¼Œäº§ç”Ÿä¸¤ä¸ª Sender åä¾¿ç«‹å³ä¸¢å¼ƒ Receiverã€‚ä¸¤ä¸ª Sender åœ¨å‘é€æ—¶éƒ½ä¼šå‡ºé”™ã€‚</p>
<p>åŒæ ·çš„ï¼ŒShared æ•°æ®ç»“æ„è¦æ›´æ–°ä¸€ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
    senders: AtomicUsize,
    receivers: AtomicUsize,
}
</code></pre></pre>
</div>
</details>
<h3 id="å®ç°-mpsc-channel"><a class="header" href="#å®ç°-mpsc-channel">å®ç° MPSC channel</a></h3>
<p>ç°åœ¨å†™äº†äº”ä¸ªå•å…ƒæµ‹è¯•ï¼Œæˆ‘ä»¬å·²ç»æŠŠéœ€æ±‚æ‘¸é€äº†ï¼Œå¹¶ä¸”æœ‰äº†åŸºæœ¬çš„æ¥å£å’Œæ•°æ®ç»“æ„çš„è®¾è®¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å†™å®ç°çš„ä»£ç ã€‚</p>
<details id="admonition-åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®" class="admonition info">
<summary class="admonition-title">
<p>åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®"></a></p>
</summary>
<div>
<pre><code class="language-shell">cargo new con_utils --lib
</code></pre>
<ol>
<li>åœ¨ cargo.toml ä¸­æ·»åŠ  anyhow ä½œä¸ºä¾èµ–ã€‚</li>
<li>åœ¨ lib.rs é‡Œï¼Œæˆ‘ä»¬å°±å†™å…¥ä¸€å¥ï¼špub mod channel , ç„¶ååˆ›å»º src/channel.rs</li>
<li>æŠŠåˆšæ‰è®¾è®¡æ—¶ä½¿ç”¨çš„ test caseã€è®¾è®¡çš„æ•°æ®ç»“æ„ï¼Œä»¥åŠ test case é‡Œä½¿ç”¨åˆ°çš„æ¥å£ï¼Œç”¨ä»£ç å…¨éƒ¨æ”¾è¿›æ¥ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use std::{
    collections::VecDeque,
    sync::{atomic::AtomicUsize, Arc, Condvar, Mutex},
};

/// å‘é€è€…
pub struct Sender&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}

/// æ¥æ”¶è€…
pub struct Receiver&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}

/// å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´å…±äº«ä¸€ä¸ª VecDequeï¼Œç”¨ Mutex äº’æ–¥ï¼Œç”¨ Condvar é€šçŸ¥
/// åŒæ—¶ï¼Œæˆ‘ä»¬è®°å½•æœ‰å¤šå°‘ä¸ª senders å’Œ receivers

struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
    senders: AtomicUsize,
    receivers: AtomicUsize,
}

impl&lt;T&gt; Sender&lt;T&gt; {
    /// ç”Ÿäº§è€…å†™å…¥ä¸€ä¸ªæ•°æ®
    pub fn send(&amp;mut self, t: T) -&gt; Result&lt;()&gt; {
        todo!()
    }

    pub fn total_receivers(&amp;self) -&gt; usize {
        todo!()
    }

    pub fn total_queued_items(&amp;self) -&gt; usize {
        todo!()
    }
}

impl&lt;T&gt; Receiver&lt;T&gt; {
    pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {
        todo!()
    }

    pub fn total_senders(&amp;self) -&gt; usize {
        todo!()
    }
}

impl&lt;T&gt; Iterator for Receiver&lt;T&gt; {
    type Item = T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        todo!()
    }
}

/// å…‹éš† sender
impl&lt;T&gt; Clone for Sender&lt;T&gt; {
    fn clone(&amp;self) -&gt; Self {
        todo!()
    }
}

/// Drop sender
impl&lt;T&gt; Drop for Sender&lt;T&gt; {
    fn drop(&amp;mut self) {
        todo!()
    }
}

impl&lt;T&gt; Drop for Receiver&lt;T&gt; {
    fn drop(&amp;mut self) {
        todo!()
    }
}

/// åˆ›å»ºä¸€ä¸ª unbounded channel
pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    todo!()
}

#[cfg(test)]
mod tests {
    use std::{thread, time::Duration};

    use super::*;
    // æ­¤å¤„çœç•¥æ‰€æœ‰ test case
}
</code></pre></pre>
</div>
</details>
<details id="admonition-å®ç°å•å…ƒæµ‹è¯•ç›¸å…³åŠŸèƒ½" class="admonition info">
<summary class="admonition-title">
<p>å®ç°å•å…ƒæµ‹è¯•ç›¸å…³åŠŸèƒ½</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å®ç°å•å…ƒæµ‹è¯•ç›¸å…³åŠŸèƒ½"></a></p>
</summary>
<div>
<p>ç›®å‰è¿™ä¸ªä»£ç è™½ç„¶èƒ½å¤Ÿç¼–è¯‘é€šè¿‡ï¼Œä½†å› ä¸ºæ²¡æœ‰ä»»ä½•å®ç°ï¼Œæ‰€ä»¥ cargo test å…¨éƒ¨å‡ºé”™ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ä¸€ç‚¹ç‚¹å®ç°åŠŸèƒ½ã€‚</p>
<ol>
<li>åˆ›å»º unbounded channel</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    let shared = Shared::default();
    let shared = Arc::new(shared);
    (
        Sender {
            shared: shared.clone(),
        },
        Receiver { shared },
    )
}

const INITIAL_SIZE: usize = 32;
impl&lt;T&gt; Default for Shared&lt;T&gt; {
    fn default() -&gt; Self {
        Self {
            queue: Mutex::new(VecDeque::with_capacity(INITIAL_SIZE)),
            available: Condvar::new(),
            senders: AtomicUsize::new(1),
            receivers: AtomicUsize::new(1),
        }
    }
}
</code></pre></pre>
<p>å› ä¸ºè¿™é‡Œä½¿ç”¨ default() åˆ›å»ºäº† Shared<T> ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºå…¶å®ç° Defaultã€‚åˆ›å»ºæ—¶ï¼Œæˆ‘ä»¬æœ‰ 1 ä¸ªç”Ÿäº§è€…å’Œ 1 ä¸ªæ¶ˆè´¹è€…ã€‚</p>
<ol start="2">
<li>å®ç°æ¶ˆè´¹è€…</li>
</ol>
<p>å¯¹äºæ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦å®ç° recv æ–¹æ³•ã€‚</p>
<p>åœ¨ recv ä¸­:</p>
<ul>
<li>å¦‚æœé˜Ÿåˆ—ä¸­æœ‰æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼›</li>
<li>å¦‚æœæ²¡æ•°æ®ï¼Œä¸”æ‰€æœ‰ç”Ÿäº§è€…éƒ½ç¦»å¼€äº†ï¼Œæˆ‘ä»¬å°±è¿”å›é”™è¯¯ï¼›</li>
<li>å¦‚æœæ²¡æ•°æ®ï¼Œä½†è¿˜æœ‰ç”Ÿäº§è€…ï¼Œæˆ‘ä»¬å°±é˜»å¡æ¶ˆè´¹è€…çš„çº¿ç¨‹ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Receiver&lt;T&gt; {
    pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {
        // æ‹¿åˆ°é˜Ÿåˆ—çš„é”
        let mut inner = self.shared.queue.lock().unwrap();
        loop {
            match inner.pop_front() {
                // è¯»åˆ°æ•°æ®è¿”å›ï¼Œé”è¢«é‡Šæ”¾
                Some(t) =&gt; {
                    return Ok(t);
                }
                // è¯»ä¸åˆ°æ•°æ®ï¼Œå¹¶ä¸”ç”Ÿäº§è€…éƒ½é€€å‡ºäº†ï¼Œé‡Šæ”¾é”å¹¶è¿”å›é”™è¯¯
                None if self.total_senders() == 0 =&gt; return Err(anyhow!(&quot;no sender left&quot;)),
                // è¯»ä¸åˆ°æ•°æ®ï¼ŒæŠŠé”æäº¤ç»™ available Condvarï¼Œå®ƒä¼šé‡Šæ”¾é”å¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾… notify
                None =&gt; {
                    // å½“ Condvar è¢«å”¤é†’åä¼šè¿”å› MutexGuardï¼Œæˆ‘ä»¬å¯ä»¥ loop å›å»æ‹¿æ•°æ®
                    // è¿™æ˜¯ä¸ºä»€ä¹ˆ Condvar è¦åœ¨ loop é‡Œä½¿ç”¨
                    inner = self
                        .shared
                        .available
                        .wait(inner)
                        .map_err(|_| anyhow!(&quot;lock poisoned&quot;))?;
                }
            }
        }
    }

    pub fn total_senders(&amp;self) -&gt; usize {
        self.shared.senders.load(Ordering::SeqCst)
    }
}
</code></pre></pre>
<p>æ³¨æ„çœ‹è¿™é‡Œ Condvar çš„ä½¿ç”¨ã€‚</p>
<ul>
<li>åœ¨ wait() æ–¹æ³•é‡Œï¼Œå®ƒæ¥æ”¶ä¸€ä¸ª MutexGuardï¼Œç„¶åé‡Šæ”¾è¿™ä¸ª Mutexï¼ŒæŒ‚èµ·çº¿ç¨‹ã€‚</li>
<li>ç­‰å¾—åˆ°é€šçŸ¥åï¼Œå®ƒä¼šå†è·å–é”ï¼Œå¾—åˆ°ä¸€ä¸ª MutexGuardï¼Œè¿”å›ã€‚æ‰€ä»¥è¿™é‡Œæ˜¯ï¼š</li>
</ul>
<pre><pre class="playground"><code class="language-rust  editable">
inner = self.shared.available.wait(inner).map_err(|_| anyhow!(&quot;lock poisoned&quot;))?;
</code></pre></pre>
<p>å› ä¸º recv() ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥é˜»å¡å›æ¥ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å¾ªç¯å›å»æ‹¿æ•°æ®ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆè¿™æ®µé€»è¾‘è¦è¢« loop {} åŒ…è£¹ã€‚æˆ‘ä»¬å‰é¢åœ¨è®¾è®¡æ—¶è€ƒè™‘è¿‡ï¼šå½“å‘é€è€…å‘é€æ•°æ®æ—¶ï¼Œåº”è¯¥é€šçŸ¥è¢«é˜»å¡çš„æ¶ˆè´¹è€…ã€‚æ‰€ä»¥ï¼Œåœ¨å®ç° Sender çš„ send() æ—¶ï¼Œéœ€è¦åšç›¸åº”çš„ notify å¤„ç†ã€‚</p>
<p>è®°å¾—è¿˜è¦å¤„ç†æ¶ˆè´¹è€…çš„ dropï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Drop for Receiver&lt;T&gt; {
    fn drop(&amp;mut self) {
        self.shared.receivers.fetch_sub(1, Ordering::AcqRel);
    }
}
</code></pre></pre>
<p>å¾ˆç®€å•ï¼Œæ¶ˆè´¹è€…ç¦»å¼€æ—¶ï¼Œå°† receivers å‡ä¸€ã€‚</p>
</div>
</details>
<details id="admonition-å®ç°ç”Ÿäº§è€…åŠŸèƒ½" class="admonition info">
<summary class="admonition-title">
<p>å®ç°ç”Ÿäº§è€…åŠŸèƒ½</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å®ç°ç”Ÿäº§è€…åŠŸèƒ½"></a></p>
</summary>
<div>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ç”Ÿäº§è€…çš„åŠŸèƒ½æ€ä¹ˆå®ç°ã€‚</p>
<ol>
<li>é¦–å…ˆï¼Œåœ¨æ²¡æœ‰æ¶ˆè´¹è€…çš„æƒ…å†µä¸‹ï¼Œåº”è¯¥æŠ¥é”™ã€‚</li>
<li>æ­£å¸¸åº”è¯¥ä½¿ç”¨ thiserror å®šä¹‰è‡ªå·±çš„é”™è¯¯ï¼Œä¸è¿‡è¿™é‡Œä¸ºäº†ç®€åŒ–ä»£ç ï¼Œå°±ä½¿ç”¨ anyhow! å®äº§ç”Ÿä¸€ä¸ª adhoc çš„é”™è¯¯ã€‚</li>
<li>å¦‚æœæ¶ˆè´¹è€…è¿˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è·å– VecDeque çš„é”ï¼ŒæŠŠæ•°æ®å‹å…¥ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Sender&lt;T&gt; {
    /// ç”Ÿäº§è€…å†™å…¥ä¸€ä¸ªæ•°æ®
    pub fn send(&amp;mut self, t: T) -&gt; Result&lt;()&gt; {
        // å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…äº†ï¼Œå†™å…¥æ—¶å‡ºé”™
        if self.total_receivers() == 0 {
            return Err(anyhow!(&quot;no receiver left&quot;));
        }

        // åŠ é”ï¼Œè®¿é—® VecDequeï¼Œå‹å…¥æ•°æ®ï¼Œç„¶åç«‹åˆ»é‡Šæ”¾é”
        let was_empty = {
            let mut inner = self.shared.queue.lock().unwrap();
            let empty = inner.is_empty();
            inner.push_back(t);
            empty
        };

        // é€šçŸ¥ä»»æ„ä¸€ä¸ªè¢«æŒ‚èµ·ç­‰å¾…çš„æ¶ˆè´¹è€…æœ‰æ•°æ®
        if was_empty {
            self.shared.available.notify_one();
        }

        Ok(())
    }

    pub fn total_receivers(&amp;self) -&gt; usize {
        self.shared.receivers.load(Ordering::SeqCst)
    }

    pub fn total_queued_items(&amp;self) -&gt; usize {
        let queue = self.shared.queue.lock().unwrap();
        queue.len()
    }
}
</code></pre></pre>
<p>è¿™é‡Œï¼Œè·å– total_receivers æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Ordering::SeqCstï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°åŒæ ·é¡ºåºçš„å¯¹ receivers çš„æ“ä½œã€‚è¿™ä¸ªå€¼æ˜¯æœ€æ–°çš„å€¼ã€‚</p>
<p>åœ¨å‹å…¥æ•°æ®æ—¶ï¼Œéœ€è¦åˆ¤æ–­ä¸€ä¸‹ä¹‹å‰æ˜¯é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå› ä¸ºé˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ notify_one() æ¥å”¤é†’æ¶ˆè´¹è€…ã€‚è¿™ä¸ªéå¸¸é‡è¦ï¼Œå¦‚æœæ²¡å¤„ç†çš„è¯ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹è€…é˜»å¡åæ— æ³•å¤åŸæ¥æ”¶æ•°æ®ã€‚</p>
<blockquote>
<p>ç”±äºæˆ‘ä»¬å¯ä»¥æœ‰å¤šä¸ªç”Ÿäº§è€…ï¼Œæ‰€ä»¥è¦å…è®¸å®ƒ cloneï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Clone for Sender&lt;T&gt; {
    fn clone(&amp;self) -&gt; Self {
        self.shared.senders.fetch_add(1, Ordering::AcqRel);
        Self {
            shared: Arc::clone(&amp;self.shared),
        }
    }
}
</code></pre></pre>
<p>å®ç° Clone trait çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä½†è®°å¾—è¦æŠŠ shared.senders åŠ  1ï¼Œä½¿å…¶ä¿æŒå’Œå½“å‰çš„ senders çš„æ•°é‡ä¸€è‡´ã€‚</p>
<blockquote>
<p>å½“ç„¶ï¼Œåœ¨ drop çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿè¦ç»´æŠ¤ shared.senders ä½¿å…¶å‡ 1ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Drop for Sender&lt;T&gt; {
    fn drop(&amp;mut self) {
        self.shared.senders.fetch_sub(1, Ordering::AcqRel);
        
    }
}
</code></pre></pre>
</div>
</details>
<details id="admonition-å…¶ä»–åŠŸèƒ½å®ç°" class="admonition info">
<summary class="admonition-title">
<p>å…¶ä»–åŠŸèƒ½å®ç°</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å…¶ä»–åŠŸèƒ½å®ç°"></a></p>
</summary>
<div>
<p>ç›®å‰è¿˜ç¼ºä¹ Receiver çš„ Iterator çš„å®ç°ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ next() é‡Œè°ƒç”¨ recv() æ–¹æ³•ï¼ŒRust æä¾›äº†æ”¯æŒåœ¨ Option / Result ä¹‹é—´å¾ˆæ–¹ä¾¿è½¬æ¢çš„å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ ok() æ¥å°† Result è½¬æ¢æˆ Optionï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Iterator for Receiver&lt;T&gt; {
    type Item = T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.recv().ok()
    }
}
</code></pre></pre>
<p>å¥½ï¼Œç›®å‰æ‰€æœ‰éœ€è¦å®ç°çš„ä»£ç éƒ½å®ç°å®Œæ¯•ï¼Œ cargo test æµ‹è¯•ä¸€ä¸‹ã€‚wowï¼æµ‹è¯•ä¸€æ¬¡æ€§é€šè¿‡ï¼è¿™ä¹Ÿå¤ªé¡ºåˆ©äº†å§ï¼</p>
<p>æœ€åæ¥ä»”ç»†å®¡è§†ä¸€ä¸‹ä»£ç ã€‚å¾ˆå¿«ï¼Œæˆ‘ä»¬å‘ç° Sender çš„ Drop å®ç°ä¼¼ä¹æœ‰ç‚¹é—®é¢˜ã€‚å¦‚æœ Receiver è¢«é˜»å¡ï¼Œè€Œæ­¤åˆ»æ‰€æœ‰ Sender éƒ½èµ°äº†ï¼Œé‚£ä¹ˆ Receiver å°±æ²¡æœ‰äººå”¤é†’ï¼Œä¼šå¸¦æ¥èµ„æºçš„æ³„éœ²ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆè¾¹è¾¹è§’è§’çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¹‹å‰çš„æµ‹è¯•æ²¡æœ‰è¦†ç›–åˆ°ã€‚</p>
<p>æˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªåœºæ™¯è®©è¿™ä¸ªé—®é¢˜æš´éœ²ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
fn receiver_shall_be_notified_when_all_senders_exit() {
    let (s, mut r) = unbounded::&lt;usize&gt;();
    // ç”¨äºä¸¤ä¸ªçº¿ç¨‹åŒæ­¥
    let (mut sender, mut receiver) = unbounded::&lt;usize&gt;();
    let t1 = thread::spawn(move || {
        // ä¿è¯ r.recv() å…ˆäº t2 çš„ drop æ‰§è¡Œ
        sender.send(0).unwrap();
        assert!(r.recv().is_err());
    });

    thread::spawn(move || {
        receiver.recv().unwrap();
        drop(s);
    });

    t1.join().unwrap();
}
</code></pre></pre>
<p>åœ¨æˆ‘è¿›ä¸€æ­¥è§£é‡Šä¹‹å‰ï¼Œä½ å¯ä»¥åœä¸‹æ¥æƒ³æƒ³:</p>
<ol>
<li>ä¸ºä»€ä¹ˆè¿™ä¸ªæµ‹è¯•å¯ä»¥ä¿è¯æš´éœ²è¿™ä¸ªé—®é¢˜ï¼Ÿ</li>
<li>å®ƒæ˜¯æ€ä¹ˆæš´éœ²çš„ï¼Ÿ</li>
<li>å¦‚æœæƒ³ä¸åˆ°ï¼Œå† cargo test çœ‹çœ‹ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ã€‚</li>
</ol>
<p>æ¥ä¸€èµ·åˆ†æåˆ†æï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ t1 å’Œ t2ï¼Œåˆ†åˆ«è®©å®ƒä»¬å¤„ç†æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ã€‚t1 è¯»å–æ•°æ®ï¼Œæ­¤æ—¶æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥ä¼šé˜»å¡ï¼Œè€Œ t2 ç›´æ¥æŠŠç”Ÿäº§è€… drop æ‰ã€‚æ‰€ä»¥ï¼Œæ­¤åˆ»å¦‚æœæ²¡æœ‰äººå”¤é†’ t1ï¼Œé‚£ä¹ˆ t1.join() å°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œå› ä¸º t1 ä¸€ç›´æ²¡æœ‰é€€å‡ºã€‚</p>
<blockquote>
<p>æ‰€ä»¥ï¼Œä¸ºäº†ä¿è¯ä¸€å®šæ˜¯ t1 r.recv()å…ˆæ‰§è¡Œå¯¼è‡´é˜»å¡ã€t2 å† drop(s)ï¼Œæˆ‘ä»¬ï¼ˆeat your own dog foodï¼‰ç”¨å¦ä¸€ä¸ª channel æ¥æ§åˆ¶ä¸¤ä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºã€‚è¿™æ˜¯ä¸€ç§å¾ˆé€šç”¨çš„åšæ³•ï¼Œä½ å¯ä»¥å¥½å¥½ç¢ç£¨ä¸€ä¸‹ã€‚</p>
</blockquote>
<p>è¿è¡Œ cargo test åï¼Œæµ‹è¯•è¢«é˜»å¡ã€‚è¿™æ˜¯å› ä¸ºï¼Œt1 æ²¡æœ‰æœºä¼šå¾—åˆ°å”¤é†’ï¼Œæ‰€ä»¥è¿™ä¸ªæµ‹è¯•å°±åœåœ¨é‚£é‡Œä¸åŠ¨äº†ã€‚</p>
<p>è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¦¥å–„å¤„ç† Sender çš„ Dropï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
impl&lt;T&gt; Drop for Sender&lt;T&gt; {
    fn drop(&amp;mut self) {
        let old = self.shared.senders.fetch_sub(1, Ordering::AcqRel);
        // sender èµ°å…‰äº†ï¼Œå”¤é†’ receiver è¯»å–æ•°æ®ï¼ˆå¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰çš„è¯ï¼‰ï¼Œè¯»ä¸åˆ°å°±å‡ºé”™
        if old &lt;= 1 {
            // å› ä¸ºæˆ‘ä»¬å®ç°çš„æ˜¯ MPSCï¼Œreceiver åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ notify_all å®é™…ç­‰ä»· notify_one
            self.shared.available.notify_all();
        }
    }
}
</code></pre></pre>
<p>è¿™é‡Œï¼Œå¦‚æœå‡ä¸€ä¹‹å‰ï¼Œæ—§çš„ senders çš„æ•°é‡å°äºç­‰äº 1ï¼Œæ„å‘³ç€ç°åœ¨æ˜¯æœ€åä¸€ä¸ª Sender è¦ç¦»å¼€äº†ï¼Œä¸ç®¡æ€æ ·æˆ‘ä»¬éƒ½è¦å”¤é†’ Receiver ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† notify_all()ã€‚å¦‚æœ Receiver ä¹‹å‰å·²ç»è¢«é˜»å¡ï¼Œæ­¤åˆ»å°±èƒ½è¢«å”¤é†’ã€‚ä¿®æ”¹å®Œæˆï¼Œcargo test ä¸€åˆ‡æ­£å¸¸ã€‚</p>
</div>
</details>
<details id="admonition-å¯¹é”è¿›è¡Œæ€§èƒ½ä¼˜åŒ–" class="admonition info">
<summary class="admonition-title">
<p>å¯¹é”è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å¯¹é”è¿›è¡Œæ€§èƒ½ä¼˜åŒ–"></a></p>
</summary>
<div>
<p>ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œç›®å‰æˆ‘ä»¬çš„ MPSC unbounded channel æ²¡æœ‰å¤ªå¤šçš„é—®é¢˜ï¼Œå¯ä»¥åº”ç”¨åœ¨ä»»ä½•éœ€è¦ MPSC channel çš„åœºæ™¯ã€‚ç„¶è€Œï¼Œæ¯æ¬¡è¯»å†™éƒ½éœ€è¦è·å–é”ï¼Œè™½ç„¶é”çš„ç²’åº¦å¾ˆå°ï¼Œä½†è¿˜æ˜¯è®©æ•´ä½“çš„æ€§èƒ½æ‰“äº†ä¸ªæŠ˜æ‰£ã€‚æœ‰æ²¡æœ‰å¯èƒ½ä¼˜åŒ–é”å‘¢ï¼Ÿ</p>
<p>ä¹‹å‰æˆ‘ä»¬è®²åˆ°ï¼Œä¼˜åŒ–é”çš„æ‰‹æ®µæ— éæ˜¯å‡å°ä¸´ç•ŒåŒºçš„å¤§å°ï¼Œè®©æ¯æ¬¡åŠ é”çš„æ—¶é—´å¾ˆçŸ­ï¼Œè¿™æ ·å†²çªçš„å‡ ç‡å°±å˜å°ã€‚å¦å¤–ï¼Œå°±æ˜¯é™ä½åŠ é”çš„é¢‘ç‡ï¼Œå¯¹äºæ¶ˆè´¹è€…æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¸€æ¬¡æ€§æŠŠé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è¯»å®Œç¼“å­˜èµ·æ¥ï¼Œä»¥ååœ¨éœ€è¦çš„æ—¶å€™ä»ç¼“å­˜ä¸­è¯»å–ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§å‡å°‘æ¶ˆè´¹è€…åŠ é”çš„é¢‘æ¬¡ã€‚</p>
<p>é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Receiver çš„ç»“æ„ä¸­æ”¾ä¸€ä¸ª cacheï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct Receiver&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
    cache: VecDeque&lt;T&gt;,
}
</code></pre></pre>
<p>å¦‚æœä½ ä¹‹å‰æœ‰ C è¯­è¨€å¼€å‘çš„ç»éªŒï¼Œä¹Ÿè®¸ä¼šæƒ³ï¼Œåˆ°äº†è¿™ä¸€æ­¥ï¼Œä½•å¿…æŠŠ queue ä¸­çš„æ•°æ®å…¨éƒ¨è¯»å‡ºæ¥ï¼Œå­˜å…¥ Receiver çš„ cache å‘¢ï¼Ÿè¿™æ ·æ•ˆç‡å¤ªä½ï¼Œå¦‚æœèƒ½å¤Ÿç›´æ¥ swap ä¸¤ä¸ªç»“æ„å†…éƒ¨çš„æŒ‡é’ˆï¼Œè¿™æ ·ï¼Œå³ä¾¿é˜Ÿåˆ—ä¸­æœ‰å†å¤šçš„æ•°æ®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª O(1) çš„æ“ä½œã€‚</p>
<p>Rust æœ‰ç±»ä¼¼çš„ <a href="https://doc.rust-lang.org/std/mem/fn.swap.html">std::mem::swap</a> æ–¹æ³•ã€‚æ¯”å¦‚</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::mem;

fn main() {
    let mut x = &quot;hello world&quot;.to_string();
    let mut y = &quot;goodbye world&quot;.to_string();
    
    mem::swap(&amp;mut x, &amp;mut y);
    
    assert_eq!(&quot;goodbye world&quot;, x);
    assert_eq!(&quot;hello world&quot;, y);
}
</code></pre></pre>
<blockquote>
<p>å¥½ï¼Œäº†è§£äº† swap æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä¿®æ”¹ Receiver çš„ recv() æ–¹æ³•æ¥æå‡æ€§èƒ½ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {
    // æ— é” fast path
    if let Some(v) = self.cache.pop_front() {
        return Ok(v);
    }

    // æ‹¿åˆ°é˜Ÿåˆ—çš„é”
    let mut inner = self.shared.queue.lock().unwrap();
    loop {
        match inner.pop_front() {
            // è¯»åˆ°æ•°æ®è¿”å›ï¼Œé”è¢«é‡Šæ”¾
            Some(t) =&gt; {
                // å¦‚æœå½“å‰é˜Ÿåˆ—ä¸­è¿˜æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±æŠŠæ¶ˆè´¹è€…è‡ªèº«ç¼“å­˜çš„é˜Ÿåˆ—ï¼ˆç©ºï¼‰å’Œå…±äº«é˜Ÿåˆ— swap ä¸€ä¸‹
                // è¿™æ ·ä¹‹åå†è¯»å–ï¼Œå°±å¯ä»¥ä» self.queue ä¸­æ— é”è¯»å–
                if !inner.is_empty() {
                    std::mem::swap(&amp;mut self.cache, &amp;mut inner);
                }
                return Ok(t);
            }
            // è¯»ä¸åˆ°æ•°æ®ï¼Œå¹¶ä¸”ç”Ÿäº§è€…éƒ½é€€å‡ºäº†ï¼Œé‡Šæ”¾é”å¹¶è¿”å›é”™è¯¯
            None if self.total_senders() == 0 =&gt; return Err(anyhow!(&quot;no sender left&quot;)),
            // è¯»ä¸åˆ°æ•°æ®ï¼ŒæŠŠé”æäº¤ç»™ available Condvarï¼Œå®ƒä¼šé‡Šæ”¾é”å¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾… notify
            None =&gt; {
                // å½“ Condvar è¢«å”¤é†’åä¼šè¿”å› MutexGuardï¼Œæˆ‘ä»¬å¯ä»¥ loop å›å»æ‹¿æ•°æ®
                // è¿™æ˜¯ä¸ºä»€ä¹ˆ Condvar è¦åœ¨ loop é‡Œä½¿ç”¨
                inner = self
                    .shared
                    .available
                    .wait(inner)
                    .map_err(|_| anyhow!(&quot;lock poisoned&quot;))?;
            }
        }
    }
}
</code></pre></pre>
<ol>
<li>å½“ cache ä¸­æœ‰æ•°æ®æ—¶ï¼Œæ€»æ˜¯ä» cache ä¸­è¯»å–ï¼›</li>
<li>å½“ cache ä¸­æ²¡æœ‰ï¼Œæˆ‘ä»¬æ‹¿åˆ°é˜Ÿåˆ—çš„é”ï¼Œè¯»å–ä¸€ä¸ªæ•°æ®</li>
<li>ç„¶åçœ‹çœ‹é˜Ÿåˆ—æ˜¯å¦è¿˜æœ‰æ•°æ®ï¼Œæœ‰çš„è¯ï¼Œå°± swap cache å’Œ queueï¼Œç„¶åè¿”å›ä¹‹å‰è¯»å–çš„æ•°æ®ã€‚</li>
</ol>
<p>å¥½ï¼Œåšå®Œè¿™ä¸ªé‡æ„å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œ cargo testï¼Œçœ‹çœ‹å·²æœ‰çš„æµ‹è¯•æ˜¯å¦æ­£å¸¸ã€‚å¦‚æœä½ é‡åˆ°æŠ¥é”™ï¼Œåº”è¯¥æ˜¯ cache æ²¡æœ‰åˆå§‹åŒ–ï¼Œä½ å¯ä»¥è‡ªè¡Œè§£å†³ï¼Œä¹Ÿå¯ä»¥å‚è€ƒï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    let shared = Shared::default();
    let shared = Arc::new(shared);
    (
        Sender {
            shared: shared.clone(),
        },
        Receiver {
            shared,
            cache: VecDeque::with_capacity(INITIAL_SIZE),
        },
    )
}
</code></pre></pre>
<p>è™½ç„¶ç°æœ‰çš„æµ‹è¯•å…¨æ•°é€šè¿‡ï¼Œä½†æˆ‘ä»¬å¹¶æ²¡æœ‰ä¸ºè¿™ä¸ªä¼˜åŒ–å†™æµ‹è¯•ï¼Œè¿™é‡Œè¡¥ä¸ªæµ‹è¯•ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[test]
    fn channel_fast_path_should_work() {
    let (mut s, mut r) = unbounded();
    for i in 0..10usize {
        s.send(i).unwrap();
    }

    assert!(r.cache.is_empty());
    // è¯»å–ä¸€ä¸ªæ•°æ®ï¼Œæ­¤æ—¶åº”è¯¥ä¼šå¯¼è‡´ swapï¼Œcache ä¸­æœ‰æ•°æ®
    assert_eq!(0, r.recv().unwrap());
    // è¿˜æœ‰ 9 ä¸ªæ•°æ®åœ¨ cache ä¸­
    assert_eq!(r.cache.len(), 9);
    // åœ¨ queue é‡Œæ²¡æœ‰æ•°æ®äº†
    assert_eq!(s.total_queued_items(), 0);

    // ä» cache é‡Œè¯»å–å‰©ä¸‹çš„æ•°æ®
    for (idx, i) in r.into_iter().take(9).enumerate() {
        assert_eq!(idx + 1, i);
    }
}
</code></pre></pre>
<p>è¿™ä¸ªæµ‹è¯•å¾ˆç®€å•ï¼Œè¯¦ç»†æ³¨é‡Šä¹Ÿéƒ½å†™ä¸Šäº†ã€‚</p>
</div>
</details>
<details id="admonition-å®Œæ•´ä»£ç " class="admonition info">
<summary class="admonition-title">
<p>å®Œæ•´ä»£ç </p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å®Œæ•´ä»£ç "></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">use anyhow::{anyhow, Result};
use std::{
    collections::VecDeque,
    sync::{
        atomic::{AtomicUsize, Ordering},
        Arc, Condvar, Mutex,
    },
};

/// å‘é€è€…
pub struct Sender&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
}

/// æ¥æ”¶è€…
pub struct Receiver&lt;T&gt; {
    shared: Arc&lt;Shared&lt;T&gt;&gt;,
    cache: VecDeque&lt;T&gt;,
}

/// å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´å…±äº«ä¸€ä¸ª VecDequeï¼Œç”¨ Mutex äº’æ–¥ï¼Œç”¨ Condvar é€šçŸ¥
/// åŒæ—¶ï¼Œæˆ‘ä»¬è®°å½•æœ‰å¤šå°‘ä¸ª senders å’Œ receivers

struct Shared&lt;T&gt; {
    queue: Mutex&lt;VecDeque&lt;T&gt;&gt;,
    available: Condvar,
    senders: AtomicUsize,
    receivers: AtomicUsize,
}

const INITIAL_SIZE: usize = 32;
impl&lt;T&gt; Default for Shared&lt;T&gt; {
    fn default() -&gt; Self {
        Self {
            queue: Mutex::new(VecDeque::with_capacity(INITIAL_SIZE)),
            available: Condvar::new(),
            senders: AtomicUsize::new(1),
            receivers: AtomicUsize::new(1),
        }
    }
}

impl&lt;T&gt; Sender&lt;T&gt; {
    /// ç”Ÿäº§è€…å†™å…¥ä¸€ä¸ªæ•°æ®
    pub fn send(&amp;mut self, t: T) -&gt; Result&lt;()&gt; {
        // å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…äº†ï¼Œå†™å…¥æ—¶å‡ºé”™
        if self.total_receivers() == 0 {
            return Err(anyhow!(&quot;no receiver left&quot;));
        }

        // åŠ é”ï¼Œè®¿é—® VecDequeï¼Œå‹å…¥æ•°æ®ï¼Œç„¶åç«‹åˆ»é‡Šæ”¾é”
        let was_empty = {
            let mut inner = self.shared.queue.lock().unwrap();
            let empty = inner.is_empty();
            inner.push_back(t);
            empty
        };

        // é€šçŸ¥ä»»æ„ä¸€ä¸ªè¢«æŒ‚èµ·ç­‰å¾…çš„æ¶ˆè´¹è€…æœ‰æ•°æ®
        if was_empty {
            self.shared.available.notify_one();
        }

        Ok(())
    }

    pub fn total_receivers(&amp;self) -&gt; usize {
        self.shared.receivers.load(Ordering::SeqCst)
    }

    pub fn total_queued_items(&amp;self) -&gt; usize {
        let queue = self.shared.queue.lock().unwrap();
        queue.len()
    }
}

/// å…‹éš† sender
impl&lt;T&gt; Clone for Sender&lt;T&gt; {
    fn clone(&amp;self) -&gt; Self {
        self.shared.senders.fetch_add(1, Ordering::AcqRel);
        Self {
            shared: Arc::clone(&amp;self.shared),
        }
    }
}

/// Drop sender
impl&lt;T&gt; Drop for Sender&lt;T&gt; {
    fn drop(&amp;mut self) {
        let old = self.shared.senders.fetch_sub(1, Ordering::AcqRel);
        // sender èµ°å…‰äº†ï¼Œå”¤é†’ receiver è¯»å–æ•°æ®ï¼ˆå¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰çš„è¯ï¼‰ï¼Œè¯»ä¸åˆ°å°±å‡ºé”™
        if old &lt;= 1 {
            // å› ä¸ºæˆ‘ä»¬å®ç°çš„æ˜¯ MPSCï¼Œreceiver åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥ notify_all å®é™…ç­‰ä»· notify_one
            self.shared.available.notify_all();
        }
    }
}

impl&lt;T&gt; Receiver&lt;T&gt; {
    pub fn recv(&amp;mut self) -&gt; Result&lt;T&gt; {
        // æ— é” fast path
        if let Some(v) = self.cache.pop_front() {
            return Ok(v);
        }

        // æ‹¿åˆ°é˜Ÿåˆ—çš„é”
        let mut inner = self.shared.queue.lock().unwrap();
        loop {
            match inner.pop_front() {
                // è¯»åˆ°æ•°æ®è¿”å›ï¼Œé”è¢«é‡Šæ”¾
                Some(t) =&gt; {
                    // å¦‚æœå½“å‰é˜Ÿåˆ—ä¸­è¿˜æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå°±æŠŠæ¶ˆè´¹è€…è‡ªèº«ç¼“å­˜çš„é˜Ÿåˆ—ï¼ˆç©ºï¼‰å’Œå…±äº«é˜Ÿåˆ— swap ä¸€ä¸‹
                    // è¿™æ ·ä¹‹åå†è¯»å–ï¼Œå°±å¯ä»¥ä» self.queue ä¸­æ— é”è¯»å–
                    if !inner.is_empty() {
                        std::mem::swap(&amp;mut self.cache, &amp;mut inner);
                    }
                    return Ok(t);
                }
                // è¯»ä¸åˆ°æ•°æ®ï¼Œå¹¶ä¸”ç”Ÿäº§è€…éƒ½é€€å‡ºäº†ï¼Œé‡Šæ”¾é”å¹¶è¿”å›é”™è¯¯
                None if self.total_senders() == 0 =&gt; return Err(anyhow!(&quot;no sender left&quot;)),
                // è¯»ä¸åˆ°æ•°æ®ï¼ŒæŠŠé”æäº¤ç»™ available Condvarï¼Œå®ƒä¼šé‡Šæ”¾é”å¹¶æŒ‚èµ·çº¿ç¨‹ï¼Œç­‰å¾… notify
                None =&gt; {
                    // å½“ Condvar è¢«å”¤é†’åä¼šè¿”å› MutexGuardï¼Œæˆ‘ä»¬å¯ä»¥ loop å›å»æ‹¿æ•°æ®
                    // è¿™æ˜¯ä¸ºä»€ä¹ˆ Condvar è¦åœ¨ loop é‡Œä½¿ç”¨
                    inner = self
                        .shared
                        .available
                        .wait(inner)
                        .map_err(|_| anyhow!(&quot;lock poisoned&quot;))?;
                }
            }
        }
    }

    pub fn total_senders(&amp;self) -&gt; usize {
        self.shared.senders.load(Ordering::SeqCst)
    }
}

impl&lt;T&gt; Iterator for Receiver&lt;T&gt; {
    type Item = T;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.recv().ok()
    }
}

impl&lt;T&gt; Drop for Receiver&lt;T&gt; {
    fn drop(&amp;mut self) {
        self.shared.receivers.fetch_sub(1, Ordering::AcqRel);
        // å› ä¸º sender ä¸ä¼šé˜»å¡ï¼Œæ‰€ä»¥ receiver ç¦»å¼€ä¸éœ€è¦å”¤é†’ sender
    }
}

/// åˆ›å»ºä¸€ä¸ª unbounded channel
pub fn unbounded&lt;T&gt;() -&gt; (Sender&lt;T&gt;, Receiver&lt;T&gt;) {
    let shared = Shared::default();
    let shared = Arc::new(shared);
    (
        Sender {
            shared: shared.clone(),
        },
        Receiver {
            shared,
            cache: VecDeque::with_capacity(INITIAL_SIZE),
        },
    )
}

#[cfg(test)]
mod tests {
    use std::{thread, time::Duration};

    use super::*;

    #[test]
    fn channel_should_work() {
        let (mut s, mut r) = unbounded();
        s.send(&quot;hello world!&quot;.to_string()).unwrap();
        let msg = r.recv().unwrap();
        assert_eq!(msg, &quot;hello world!&quot;);
    }

    #[test]
    fn multiple_senders_should_work() {
        let (mut s, mut r) = unbounded();
        let mut s1 = s.clone();
        let mut s2 = s.clone();
        let t = thread::spawn(move || {
            s.send(1).unwrap();
        });
        let t1 = thread::spawn(move || {
            s1.send(2).unwrap();
        });
        let t2 = thread::spawn(move || {
            s2.send(3).unwrap();
        });
        for handle in [t, t1, t2] {
            handle.join().unwrap();
        }

        let mut result = [r.recv().unwrap(), r.recv().unwrap(), r.recv().unwrap()];
        // åœ¨è¿™ä¸ªæµ‹è¯•é‡Œï¼Œæ•°æ®åˆ°è¾¾çš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ’ä¸ªåºå† assert
        result.sort_unstable();

        assert_eq!(result, [1, 2, 3]);
    }

    #[test]
    #[allow(clippy::all)]
    fn receiver_should_be_blocked_when_nothing_to_read() {
        let (mut s, r) = unbounded();
        let mut s1 = s.clone();
        thread::spawn(move || {
            for (idx, i) in r.into_iter().enumerate() {
                // å¦‚æœè¯»åˆ°æ•°æ®ï¼Œç¡®ä¿å®ƒå’Œå‘é€çš„æ•°æ®ä¸€è‡´
                assert_eq!(idx, i);
            }
            // è¯»ä¸åˆ°åº”è¯¥ä¼‘çœ ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€å¥ï¼Œæ‰§è¡Œåˆ°è¿™ä¸€å¥è¯´æ˜é€»è¾‘å‡ºé”™
            assert!(false);
        });

        thread::spawn(move || {
            for i in 0..100usize {
                s.send(i).unwrap();
            }
            // é˜²æ­¢æ‰€æœ‰ sender éƒ½ç¦»å¼€
            loop {}
        });

        // 1ms è¶³å¤Ÿè®©ç”Ÿäº§è€…å‘å®Œ 100 ä¸ªæ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹å®Œ 100 ä¸ªæ¶ˆæ¯å¹¶é˜»å¡
        thread::sleep(Duration::from_millis(1));

        // å†æ¬¡å‘é€æ•°æ®ï¼Œå”¤é†’æ¶ˆè´¹è€…
        for i in 100..200usize {
            s1.send(i).unwrap();
        }

        // ç•™ç‚¹æ—¶é—´è®© receiver å¤„ç†
        thread::sleep(Duration::from_millis(1));

        // å¦‚æœ receiver è¢«æ­£å¸¸å”¤é†’å¤„ç†ï¼Œé‚£ä¹ˆé˜Ÿåˆ—é‡Œçš„æ•°æ®ä¼šéƒ½è¢«è¯»å®Œ
        assert_eq!(s1.total_queued_items(), 0);
    }

    #[test]
    fn last_sender_drop_should_error_when_receive() {
        let (s, mut r) = unbounded();
        let s1 = s.clone();
        let senders = [s, s1];
        let total = senders.len();

        // sender å³ç”¨å³æŠ›
        for mut sender in senders {
            thread::spawn(move || {
                sender.send(&quot;hello&quot;).unwrap();
                // sender åœ¨æ­¤è¢«ä¸¢å¼ƒ
            })
            .join()
            .unwrap();
        }

        // è™½ç„¶æ²¡æœ‰ sender äº†ï¼Œæ¥æ”¶è€…ä¾ç„¶å¯ä»¥æ¥å—å·²ç»åœ¨é˜Ÿåˆ—é‡Œçš„æ•°æ®
        for _ in 0..total {
            r.recv().unwrap();
        }

        // ç„¶è€Œï¼Œè¯»å–æ›´å¤šæ•°æ®æ—¶ä¼šå‡ºé”™
        assert!(r.recv().is_err());
    }

    #[test]
    fn receiver_drop_should_error_when_send() {
        let (mut s1, mut s2) = {
            let (s, _) = unbounded();
            let s1 = s.clone();
            (s1, s)
        };

        assert!(s1.send(1).is_err());
        assert!(s2.send(1).is_err());
    }

    #[test]
    fn receiver_shall_be_notified_when_all_senders_exit() {
        let (s, mut r) = unbounded::&lt;usize&gt;();
        // ç”¨äºä¸¤ä¸ªçº¿ç¨‹åŒæ­¥
        let (mut sender, mut receiver) = unbounded::&lt;usize&gt;();
        let t1 = thread::spawn(move || {
            // ä¿è¯ r.recv() å…ˆäº t2 çš„ drop æ‰§è¡Œ
            sender.send(0).unwrap();
            assert!(r.recv().is_err());
        });

        thread::spawn(move || {
            receiver.recv().unwrap();
            drop(s);
        });

        t1.join().unwrap();
    }

    #[test]
    fn channel_fast_path_should_work() {
        let (mut s, mut r) = unbounded();
        for i in 0..10usize {
            s.send(i).unwrap();
        }

        assert!(r.cache.is_empty());
        // è¯»å–ä¸€ä¸ªæ•°æ®ï¼Œæ­¤æ—¶åº”è¯¥ä¼šå¯¼è‡´ swapï¼Œcache ä¸­æœ‰æ•°æ®
        assert_eq!(0, r.recv().unwrap());
        // è¿˜æœ‰ 9 ä¸ªæ•°æ®åœ¨ cache ä¸­
        assert_eq!(r.cache.len(), 9);
        // åœ¨ queue é‡Œæ²¡æœ‰æ•°æ®äº†
        assert_eq!(s.total_queued_items(), 0);

        // ä» cache é‡Œè¯»å–å‰©ä¸‹çš„æ•°æ®
        for (idx, i) in r.into_iter().take(9).enumerate() {
            assert_eq!(idx + 1, i);
        }
    }
}
</code></pre></pre>
</div>
</details>
<h3 id="å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘"><a class="header" href="#å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘">å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘</a></h3>
<details id="admonition-å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘" class="admonition info">
<summary class="admonition-title">
<p>å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å›é¡¾æµ‹è¯•é©±åŠ¨å¼€å‘"></a></p>
</summary>
<div>
<p>è¿™é‡Œå®Œå…¨é¡ºç€éœ€æ±‚å†™æµ‹è¯•ï¼Œç„¶ååœ¨å†™æµ‹è¯•çš„è¿‡ç¨‹ä¸­è¿›è¡Œæ•°æ®ç»“æ„å’Œæ¥å£çš„è®¾è®¡ã€‚å’Œæ™®é€šçš„ TDD ä¸åŒçš„æ˜¯ï¼Œå…ˆä¸€å£æ°”æŠŠä¸»è¦éœ€æ±‚æ¶‰åŠçš„è¡Œä¸ºç”¨æµ‹è¯•æ¥è¡¨è¿°ï¼Œç„¶åé€šè¿‡è¿™ä¸ªè¡¨è¿°ï¼Œæ„å»ºåˆé€‚çš„æ¥å£ï¼Œä»¥åŠèƒ½å¤Ÿè¿è¡Œè¿™ä¸ªæ¥å£çš„æ•°æ®ç»“æ„ã€‚</p>
<p>åœ¨å¼€å‘äº§å“çš„æ—¶å€™ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ‰‹æ®µï¼Œå¯ä»¥è®©æˆ‘ä»¬é€šè¿‡æµ‹è¯•å®Œå–„è®¾è®¡ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªèƒ½å¤Ÿè®©æµ‹è¯•ç¼–è¯‘é€šè¿‡çš„ã€å®Œå…¨æ²¡æœ‰å®ç°ä»£ç ã€åªæœ‰æ¥å£çš„ç‰ˆæœ¬ã€‚ä¹‹åï¼Œæˆ‘ä»¬å†ä¸€ä¸ªæ¥å£ä¸€ä¸ªæ¥å£å®ç°ï¼Œå…¨éƒ¨å®ç°å®Œæˆä¹‹åï¼Œè¿è¡Œæµ‹è¯•ï¼Œçœ‹çœ‹æ˜¯å¦å‡ºé—®é¢˜ã€‚</p>
<p>åœ¨è¿™é‡Œä½ å¯ä»¥å¤šå¤šå…³æ³¨æ„å»ºæµ‹è¯•ç”¨ä¾‹çš„æŠ€å·§ã€‚ä¹‹å‰çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘åå¤å¼ºè°ƒè¿‡å•å…ƒæµ‹è¯•çš„é‡è¦æ€§ï¼Œä¹Ÿä»¥èº«ä½œåˆ™åœ¨å‡ ä¸ªé‡è¦çš„å®æ“ä¸­éƒ½æœ‰è¯¦å°½åœ°æµ‹è¯•ã€‚ä¸è¿‡ç›¸æ¯”ä¹‹å‰å†™çš„æµ‹è¯•ï¼Œè¿™ä¸€è®²ä¸­çš„æµ‹è¯•è¦æ›´éš¾å†™ä¸€äº›ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘åœºæ™¯ä¸‹é‚£äº›è¾¹è¾¹è§’è§’çš„åŠŸèƒ½æµ‹è¯•ã€‚</p>
<p>ä¸è¦å°çœ‹æµ‹è¯•ä»£ç ï¼Œæœ‰æ—¶å€™æ„é€ æµ‹è¯•ä»£ç æ¯”æ’°å†™åŠŸèƒ½ä»£ç è¿˜è¦çƒ§è„‘ã€‚ä½†æ˜¯ï¼Œå½“ä½ æœ‰äº†æ‰å®çš„å•å…ƒæµ‹è¯•è¦†ç›–åï¼Œå†åšé‡æ„ï¼Œæ¯”å¦‚æœ€åæˆ‘ä»¬åšå’Œæ€§èƒ½ç›¸å…³çš„é‡æ„ï¼Œå°±å˜å¾—è½»æ¾å¾ˆå¤šï¼Œå› ä¸ºåªè¦cargo testé€šè¿‡ï¼Œèµ·ç è¿™ä¸ªé‡æ„æ²¡æœ‰å¼•èµ·ä»»ä½•å›å½’é—®é¢˜ï¼ˆregression bugï¼‰ã€‚</p>
<p>å½“ç„¶ï¼Œé‡æ„æ²¡æœ‰å¼•å…¥å›å½’é—®é¢˜ï¼Œå¹¶ä¸æ„å‘³ç€é‡æ„å®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘æ’°å†™æ–°çš„æµ‹è¯•ï¼Œè¦†ç›–é‡æ„å¸¦æ¥çš„æ”¹åŠ¨ã€‚</p>
</div>
</details>
<h2 id="å¹¶å‘åŸè¯­ä¸å¼‚æ­¥çš„å…³ç³»"><a class="header" href="#å¹¶å‘åŸè¯­ä¸å¼‚æ­¥çš„å…³ç³»">å¹¶å‘åŸè¯­ä¸å¼‚æ­¥çš„å…³ç³»</a></h2>
<details id="admonition-åŒºåˆ«å¹¶å‘åŸè¯­ä¸future" class="admonition info">
<summary class="admonition-title">
<p>åŒºåˆ«å¹¶å‘åŸè¯­ä¸Future</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-åŒºåˆ«å¹¶å‘åŸè¯­ä¸future"></a></p>
</summary>
<div>
<ul>
<li>å¹¶å‘åŸè¯­æ˜¯å¹¶å‘ä»»åŠ¡ä¹‹é—´åŒæ­¥çš„æ‰‹æ®µ</li>
<li>Future ä»¥åŠåœ¨æ›´é«˜å±‚æ¬¡ä¸Šå¤„ç† Future çš„ async/awaitï¼Œæ˜¯äº§ç”Ÿå’Œè¿è¡Œå¹¶å‘ä»»åŠ¡çš„æ‰‹æ®µã€‚</li>
</ul>
<p>ä¸è¿‡äº§ç”Ÿå’Œè¿è¡Œå¹¶å‘ä»»åŠ¡çš„æ‰‹æ®µæœ‰å¾ˆå¤šï¼Œasync/await åªæ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚</p>
<ol>
<li>åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¹¶å‘ä»»åŠ¡å¯ä»¥è¿è¡Œåœ¨ç³»ç»Ÿçš„æŸä¸ªèŠ‚ç‚¹ä¸Šï¼›</li>
<li>åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶å‘ä»»åŠ¡åˆå¯ä»¥è¿è¡Œåœ¨å¤šä¸ªè¿›ç¨‹ä¸­ï¼›</li>
<li>è€Œåœ¨æŸä¸ªè¿›ç¨‹ä¸­ï¼Œå¹¶å‘ä»»åŠ¡å¯ä»¥è¿è¡Œåœ¨å¤šä¸ªçº¿ç¨‹ä¸­ï¼›</li>
<li>åœ¨æŸä¸ªï¼ˆäº›ï¼‰çº¿ç¨‹ä¸Šï¼Œå¹¶å‘ä»»åŠ¡å¯ä»¥è¿è¡Œåœ¨å¤šä¸ª Promise / Future / Goroutine / Erlang process è¿™æ ·çš„åç¨‹ä¸Šã€‚</li>
</ol>
<p>å®ƒä»¬çš„ç²’åº¦ä»å¤§åˆ°å°å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/38%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9AFuture%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AE%83%E5%92%8Casyncawait%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%9F-4959318.jpg" alt="38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasyncawaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" /></p>
</div>
</details>
<h2 id="future"><a class="header" href="#future">Future</a></h2>
<h3 id="actoræ˜¯æœ‰æ ˆåç¨‹futureæ˜¯æ— æ ˆåç¨‹"><a class="header" href="#actoræ˜¯æœ‰æ ˆåç¨‹futureæ˜¯æ— æ ˆåç¨‹">actoræ˜¯æœ‰æ ˆåç¨‹ï¼ŒFutureæ˜¯æ— æ ˆåç¨‹</a></h3>
<details id="admonition-actoræ˜¯æœ‰æ ˆåç¨‹futureæ˜¯æ— æ ˆåç¨‹" class="admonition info">
<summary class="admonition-title">
<p>actoræ˜¯æœ‰æ ˆåç¨‹ï¼ŒFutureæ˜¯æ— æ ˆåç¨‹</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-actoræ˜¯æœ‰æ ˆåç¨‹futureæ˜¯æ— æ ˆåç¨‹"></a></p>
</summary>
<div>
<p>å¾…è¡¥å……</p>
</div>
</details>
<h3 id="rustçš„future"><a class="header" href="#rustçš„future">Rustçš„Future</a></h3>
<details id="admonition-rust-çš„-future-è·Ÿ-javascript-çš„-promisepythonçš„futureéå¸¸ç›¸ä¼¼" class="admonition info">
<summary class="admonition-title">
<p>Rust çš„ Future è·Ÿ JavaScript çš„ Promiseã€Pythonçš„Futureéå¸¸ç›¸ä¼¼</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-rust-çš„-future-è·Ÿ-javascript-çš„-promisepythonçš„futureéå¸¸ç›¸ä¼¼"></a></p>
</summary>
<div>
<p>å…¶å® Rust çš„ Future è·Ÿ JavaScript çš„ Promise éå¸¸ç±»ä¼¼ã€‚</p>
<p>å¦‚æœä½ ç†Ÿæ‚‰ JavaScriptï¼Œåº”è¯¥ç†Ÿæ‚‰ Promise çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨äº†åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»æ‰èƒ½å¾—åˆ°çš„ç»“æœçš„å€¼ï¼ŒPromise ä¸€èˆ¬å­˜åœ¨ä¸‰ä¸ªçŠ¶æ€ï¼›</p>
<ol>
<li>ç­‰å¾…ï¼ˆpendingï¼‰çŠ¶æ€</li>
<li>Promise å·²è¿è¡Œï¼Œä½†è¿˜æœªç»“æŸï¼›</li>
<li>ç»“æŸçŠ¶æ€ï¼ŒPromise æˆåŠŸè§£æå‡ºä¸€ä¸ªå€¼ï¼Œæˆ–è€…æ‰§è¡Œå¤±è´¥ã€‚</li>
</ol>
<p>åªä¸è¿‡ JavaScript çš„ Promise å’Œçº¿ç¨‹ç±»ä¼¼ï¼Œä¸€æ—¦åˆ›å»ºå°±å¼€å§‹æ‰§è¡Œï¼Œå¯¹ Promise await åªæ˜¯ä¸ºäº†â€œç­‰å¾…â€å¹¶è·å–è§£æå‡ºæ¥çš„å€¼ï¼›è€Œ Rust çš„ Futureï¼Œåªæœ‰åœ¨ä¸»åŠ¨ await åæ‰å¼€å§‹æ‰§è¡Œã€‚</p>
</div>
</details>
<h3 id="futureå’Œasyncawait"><a class="header" href="#futureå’Œasyncawait">Futureå’Œasync/await</a></h3>
<details id="admonition-ä¸€èˆ¬è€Œè¨€asyncawaitå’Œfutureæ˜¯ä»€ä¹ˆå…³ç³»" class="admonition info">
<summary class="admonition-title">
<p>ä¸€èˆ¬è€Œè¨€ï¼Œasync/awaitå’ŒFutureæ˜¯ä»€ä¹ˆå…³ç³»</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä¸€èˆ¬è€Œè¨€asyncawaitå’Œfutureæ˜¯ä»€ä¹ˆå…³ç³»"></a></p>
</summary>
<div>
<p>è®²åˆ°è¿™é‡Œä¼°è®¡ä½ ä¹Ÿçœ‹å‡ºæ¥äº†ï¼Œè°ˆ Future çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ€»ä¼šè°ˆåˆ° async/awaitã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼š</p>
<ol>
<li>async å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡</li>
<li>è€Œ await åˆ™è§¦å‘è¿™ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚</li>
<li>å¤§å¤šæ•°è¯­è¨€ï¼ŒåŒ…æ‹¬ Rustï¼Œasync/await éƒ½æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼ˆsyntactic sugarï¼‰</li>
<li>å®ƒä»¬ä½¿ç”¨çŠ¶æ€æœºå°† Promise/Future è¿™æ ·çš„ç»“æ„åŒ…è£…èµ·æ¥è¿›è¡Œå¤„ç†ã€‚</li>
</ol>
</div>
</details>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦-future"><a class="header" href="#ä¸ºä»€ä¹ˆéœ€è¦-future">ä¸ºä»€ä¹ˆéœ€è¦ Futureï¼Ÿ</a></h3>
<details id="admonition-ä¸ºä»€ä¹ˆéœ€è¦futureé‚£ä¸ç”¨asyncawaitæœ‰ä»€ä¹ˆé—®é¢˜" class="admonition info">
<summary class="admonition-title">
<p>ä¸ºä»€ä¹ˆéœ€è¦Futureï¼Œé‚£ä¸ç”¨async/awaitæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä¸ºä»€ä¹ˆéœ€è¦futureé‚£ä¸ç”¨asyncawaitæœ‰ä»€ä¹ˆé—®é¢˜"></a></p>
</summary>
<div>
<p>é¦–å…ˆï¼Œè°ˆä¸€è°ˆä¸ºä»€ä¹ˆéœ€è¦ Future è¿™æ ·çš„å¹¶å‘ç»“æ„ã€‚</p>
<p>åœ¨ Future å‡ºç°ä¹‹å‰ï¼Œæˆ‘ä»¬çš„ Rust ä»£ç éƒ½æ˜¯åŒæ­¥çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<ol>
<li>å½“ä½ æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼ŒCPU å¤„ç†å®Œå‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªæŒ‡ä»¤æ‰ä¼šè¿”å›ã€‚</li>
<li>å¦‚æœè¿™ä¸ªå‡½æ•°é‡Œæœ‰ IO çš„æ“ä½œï¼Œå®é™…ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠå‡½æ•°å¯¹åº”çš„çº¿ç¨‹æŒ‚èµ·ï¼Œæ”¾åœ¨ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­</li>
<li>ç›´åˆ° IO æ“ä½œå®Œæˆï¼Œæ‰æ¢å¤è¿™ä¸ªçº¿ç¨‹ï¼Œå¹¶ä»æŒ‚èµ·çš„ä½ç½®ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</li>
</ol>
<blockquote>
<p>è¿™ä¸ªæ¨¡å‹éå¸¸ç®€å•ç›´è§‚ï¼Œä»£ç æ˜¯ä¸€è¡Œä¸€è¡Œæ‰§è¡Œçš„ï¼Œå¼€å‘è€…å¹¶ä¸éœ€è¦è€ƒè™‘å“ªäº›æ“ä½œä¼šé˜»å¡ï¼Œå“ªäº›ä¸ä¼šï¼Œåªå…³å¿ƒä»–çš„ä¸šåŠ¡é€»è¾‘å°±å¥½ã€‚</p>
</blockquote>
<blockquote>
<p>ç„¶è€Œï¼Œéšç€ CPU æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œæ–°ä¸–çºªåº”ç”¨è½¯ä»¶çš„ä¸»è¦çŸ›ç›¾ä¸å†æ˜¯ CPU ç®—åŠ›ä¸è¶³ï¼Œè€Œæ˜¯è¿‡äºå……æ²›çš„ CPU ç®—åŠ›å’Œæå‡ç¼“æ…¢çš„ IO é€Ÿåº¦ä¹‹é—´çš„çŸ›ç›¾ã€‚å¦‚æœæœ‰å¤§é‡çš„ IO æ“ä½œï¼Œä½ çš„ç¨‹åºå¤§éƒ¨åˆ†æ—¶é—´å¹¶æ²¡æœ‰åœ¨è¿ç®—ï¼Œè€Œæ˜¯åœ¨ä¸æ–­åœ°ç­‰å¾… IOã€‚</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use serde_yaml::Value;
use std::fs;

fn main() -&gt; Result&lt;()&gt; {
    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1
    let content1 = fs::read_to_string(&quot;./Cargo.toml&quot;)?;
    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2
    let content2 = fs::read_to_string(&quot;./Cargo.lock&quot;)?;

    // è®¡ç®—
    let yaml1 = toml2yaml(&amp;content1)?;
    let yaml2 = toml2yaml(&amp;content2)?;

    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3
    fs::write(&quot;/tmp/Cargo.yml&quot;, &amp;yaml1)?;
    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4
    fs::write(&quot;/tmp/Cargo.lock&quot;, &amp;yaml2)?;

    // æ‰“å°
    println!(&quot;{}&quot;, yaml1);
    println!(&quot;{}&quot;, yaml2);

    Ok(())
}

fn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {
    let value: Value = toml::from_str(&amp;content)?;
    Ok(serde_yaml::to_string(&amp;value)?)
}
</code></pre></pre>
<blockquote>
<p>è¿™æ®µä»£ç è¯»å– Cargo.toml å’Œ Cargo.lock å°†å…¶è½¬æ¢æˆ yamlï¼Œå†åˆ†åˆ«å†™å…¥åˆ° /tmp ä¸‹ã€‚</p>
</blockquote>
<p>è™½ç„¶è¯´è¿™æ®µä»£ç çš„é€»è¾‘å¹¶æ²¡æœ‰é—®é¢˜ï¼Œä½†æ€§èƒ½æœ‰å¾ˆå¤§çš„é—®é¢˜:</p>
<ol>
<li>åœ¨è¯» Cargo.toml æ—¶ï¼Œæ•´ä¸ªä¸»çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ° Cargo.toml è¯»å®Œï¼Œæ‰èƒ½ç»§ç»­è¯»ä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„æ–‡ä»¶ã€‚</li>
<li>æ•´ä¸ªä¸»çº¿ç¨‹ï¼Œåªæœ‰åœ¨è¿è¡Œ toml2yaml çš„æ—¶é—´ç‰‡å†…ï¼Œæ‰çœŸæ­£åœ¨æ‰§è¡Œè®¡ç®—ä»»åŠ¡ï¼Œä¹‹å‰çš„è¯»å–æ–‡ä»¶ä»¥åŠä¹‹åçš„å†™å…¥æ–‡ä»¶ï¼ŒCPU éƒ½åœ¨é—²ç½®ã€‚</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/38%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9AFuture%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AE%83%E5%92%8Casyncawait%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%9F-4959308.jpg" alt="38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasyncawaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" /></p>
<p>å½“ç„¶ï¼Œä½ ä¼šè¾©è§£ï¼Œåœ¨è¯»æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ç­‰å¾…ï¼Œå› ä¸º toml2yaml å‡½æ•°çš„æ‰§è¡Œæœ‰èµ–äºè¯»å–æ–‡ä»¶çš„ç»“æœã€‚</p>
<p>å—¯æ²¡é”™ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œè¿˜æœ‰å¾ˆå¤§çš„ CPU æµªè´¹ï¼šæˆ‘ä»¬è¯»å®Œç¬¬ä¸€ä¸ªæ–‡ä»¶æ‰å¼€å§‹è¯»ç¬¬äºŒä¸ªæ–‡ä»¶ï¼Œæœ‰æ²¡æœ‰å¯èƒ½ä¸¤ä¸ªæ–‡ä»¶åŒæ—¶è¯»å–å‘¢ï¼Ÿè¿™æ ·æ€»å…±ç­‰å¾…çš„æ—¶é—´æ˜¯ max(time_for_file1, time_for_file2)ï¼Œè€Œé time_for_file1 + time_for_file2 ã€‚</p>
<p>è¿™å¹¶ä¸éš¾ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ–‡ä»¶è¯»å–å’Œå†™å…¥çš„æ“ä½œæ”¾å…¥å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ¯”å¦‚ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::{anyhow, Result};
use serde_yaml::Value;
use std::{
    fs,
    thread::{self, JoinHandle},
};

/// åŒ…è£…ä¸€ä¸‹ JoinHandleï¼Œè¿™æ ·å¯ä»¥æä¾›é¢å¤–çš„æ–¹æ³•
struct MyJoinHandle&lt;T&gt;(JoinHandle&lt;Result&lt;T&gt;&gt;);

impl&lt;T&gt; MyJoinHandle&lt;T&gt; {
    /// ç­‰å¾… thread æ‰§è¡Œå®Œï¼ˆç±»ä¼¼ awaitï¼‰
    pub fn thread_await(self) -&gt; Result&lt;T&gt; {
        self.0.join().map_err(|_| anyhow!(&quot;failed&quot;))?
    }
}

fn main() -&gt; Result&lt;()&gt; {
    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1
    let t1 = thread_read(&quot;./Cargo.toml&quot;);
    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2
    let t2 = thread_read(&quot;./Cargo.lock&quot;);

    let content1 = t1.thread_await()?;
    let content2 = t2.thread_await()?;

    // è®¡ç®—
    let yaml1 = toml2yaml(&amp;content1)?;
    let yaml2 = toml2yaml(&amp;content2)?;

    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3
    let t3 = thread_write(&quot;/tmp/Cargo.yml&quot;, yaml1);
    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4
    let t4 = thread_write(&quot;/tmp/Cargo.lock&quot;, yaml2);

    let yaml1 = t3.thread_await()?;
    let yaml2 = t4.thread_await()?;

    fs::write(&quot;/tmp/Cargo.yml&quot;, &amp;yaml1)?;
    fs::write(&quot;/tmp/Cargo.lock&quot;, &amp;yaml2)?;

    // æ‰“å°
    println!(&quot;{}&quot;, yaml1);
    println!(&quot;{}&quot;, yaml2);

    Ok(())
}

fn thread_read(filename: &amp;'static str) -&gt; MyJoinHandle&lt;String&gt; {
    let handle = thread::spawn(move || {
        let s = fs::read_to_string(filename)?;
        Ok::&lt;_, anyhow::Error&gt;(s)
    });
    MyJoinHandle(handle)
}

fn thread_write(filename: &amp;'static str, content: String) -&gt; MyJoinHandle&lt;String&gt; {
    let handle = thread::spawn(move || {
        fs::write(filename, &amp;content)?;
        Ok::&lt;_, anyhow::Error&gt;(content)
    });
    MyJoinHandle(handle)
}

fn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {
    let value: Value = toml::from_str(&amp;content)?;
    Ok(serde_yaml::to_string(&amp;value)?)
}
</code></pre></pre>
<blockquote>
<p>è¿™æ ·ï¼Œè¯»å–æˆ–è€…å†™å…¥å¤šä¸ªæ–‡ä»¶çš„è¿‡ç¨‹å¹¶å‘æ‰§è¡Œï¼Œä½¿ç­‰å¾…çš„æ—¶é—´å¤§å¤§ç¼©çŸ­ã€‚</p>
</blockquote>
<ol>
<li>ä½†æ˜¯ï¼Œå¦‚æœè¦åŒæ—¶è¯»å– 100 ä¸ªæ–‡ä»¶å‘¢ï¼Ÿ</li>
</ol>
<ul>
<li>æ˜¾ç„¶ï¼Œåˆ›å»º 100 ä¸ªçº¿ç¨‹æ¥åšè¿™æ ·çš„äº‹æƒ…ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚</li>
<li>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œçº¿ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ï¼Œåˆ›å»º / é˜»å¡ / å”¤é†’ / é”€æ¯çº¿ç¨‹ï¼Œéƒ½æ¶‰åŠä¸å°‘çš„åŠ¨ä½œ</li>
<li>æ¯ä¸ªçº¿ç¨‹ä¹Ÿéƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªä¸å°çš„è°ƒç”¨æ ˆ</li>
<li>æ‰€ä»¥ä» CPU å’Œå†…å­˜çš„è§’åº¦æ¥çœ‹ï¼Œåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ä¼šå¤§å¤§å¢åŠ ç³»ç»Ÿçš„å¼€é”€ã€‚</li>
</ul>
<ol start="2">
<li>å…¶å®ï¼Œç»å¤§å¤šæ•°æ“ä½œç³»ç»Ÿå¯¹ I/O æ“ä½œæä¾›äº†éé˜»å¡æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´: </li>
</ol>
<ul>
<li>ä½ å¯ä»¥å‘èµ·ä¸€ä¸ªè¯»å–çš„æŒ‡ä»¤</li>
<li>è‡ªå·±å¤„ç†ç±»ä¼¼ EWOULDBLOCKè¿™æ ·çš„é”™è¯¯ç </li>
<li>æ¥æ›´å¥½åœ°åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†å¤šä¸ªæ–‡ä»¶çš„ IO</li>
<li>è€Œä¸æ˜¯ä¾èµ–æ“ä½œç³»ç»Ÿé€šè¿‡è°ƒåº¦å¸®ä½ å®Œæˆè¿™ä»¶äº‹ã€‚</li>
</ul>
<ol start="3">
<li>ä¸è¿‡è¿™æ ·å°±æ„å‘³ç€ï¼Œä½ éœ€è¦:</li>
</ol>
<ul>
<li>å®šä¹‰åˆé€‚çš„æ•°æ®ç»“æ„æ¥è¿½è¸ªæ¯ä¸ªæ–‡ä»¶çš„è¯»å–</li>
<li>åœ¨ç”¨æˆ·æ€è¿›è¡Œç›¸åº”çš„è°ƒåº¦</li>
<li>é˜»å¡ç­‰å¾… IO çš„æ•°æ®ç»“æ„çš„è¿è¡Œ</li>
<li>è®©æ²¡æœ‰ç­‰å¾… IO çš„æ•°æ®ç»“æ„å¾—åˆ°æœºä¼šä½¿ç”¨ CPU</li>
<li>ä»¥åŠå½“ IO æ“ä½œç»“æŸåï¼Œæ¢å¤ç­‰å¾… IO çš„æ•°æ®ç»“æ„çš„è¿è¡Œç­‰ç­‰ã€‚</li>
</ul>
<blockquote>
<p>è¿™æ ·çš„æ“ä½œç²’åº¦æ›´å°ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦åˆ©ç”¨ CPU èµ„æºã€‚
è¿™å°±æ˜¯ç±»ä¼¼ Future è¿™æ ·çš„å¹¶å‘ç»“æ„çš„ä¸»è¦ç”¨é€”ã€‚</p>
</blockquote>
<ol start="4">
<li>ç„¶è€Œï¼Œå¦‚æœè¿™ä¹ˆå¤„ç†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·æ€åšå¾ˆå¤šäº‹æƒ…,åŒ…æ‹¬:</li>
</ol>
<ul>
<li>å¤„ç† IO ä»»åŠ¡çš„äº‹ä»¶é€šçŸ¥</li>
<li>åˆ›å»º Future</li>
<li>åˆç†åœ°è°ƒåº¦ Future</li>
</ul>
<blockquote>
<p>è¿™äº›äº‹æƒ…ï¼Œç»Ÿç»Ÿäº¤ç»™å¼€å‘è€…åšæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚æ‰€ä»¥ï¼ŒRust æä¾›äº†ç›¸åº”å¤„ç†æ‰‹æ®µ async/await ï¼š</p>
</blockquote>
<ul>
<li>async æ¥æ–¹ä¾¿åœ°ç”Ÿæˆ Future</li>
<li>await æ¥è§¦å‘ Future çš„è°ƒåº¦å’Œæ‰§è¡Œã€‚</li>
</ul>
<hr />
<p>æˆ‘ä»¬çœ‹çœ‹ï¼ŒåŒæ ·çš„ä»»åŠ¡ï¼Œå¦‚ä½•ç”¨ async/await æ›´é«˜æ•ˆåœ°å¤„ç†ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use serde_yaml::Value;
use tokio::{fs, try_join};

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    // è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1
    let f1 = fs::read_to_string(&quot;./Cargo.toml&quot;);
    // è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2
    let f2 = fs::read_to_string(&quot;./Cargo.lock&quot;);
    let (content1, content2) = try_join!(f1, f2)?;

    // è®¡ç®—
    let yaml1 = toml2yaml(&amp;content1)?;
    let yaml2 = toml2yaml(&amp;content2)?;

    // å†™å…¥ /tmp/Cargo.ymlï¼ŒIO æ“ä½œ 3
    let f3 = fs::write(&quot;/tmp/Cargo.yml&quot;, &amp;yaml1);
    // å†™å…¥ /tmp/Cargo.lockï¼ŒIO æ“ä½œ 4
    let f4 = fs::write(&quot;/tmp/Cargo.lock&quot;, &amp;yaml2);
    try_join!(f3, f4)?;

    // æ‰“å°
    println!(&quot;{}&quot;, yaml1);
    println!(&quot;{}&quot;, yaml2);

    Ok(())
}

fn toml2yaml(content: &amp;str) -&gt; Result&lt;String&gt; {
    let value: Value = toml::from_str(&amp;content)?;
    Ok(serde_yaml::to_string(&amp;value)?)
}
</code></pre></pre>
<p>åœ¨è¿™æ®µä»£ç é‡Œ:</p>
<ol>
<li>æˆ‘ä»¬ä½¿ç”¨äº† tokio::fsï¼Œè€Œä¸æ˜¯ std::fs</li>
<li>tokio::fs çš„æ–‡ä»¶æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ª Futureï¼Œç„¶åå¯ä»¥ join è¿™äº› Futureï¼Œå¾—åˆ°å®ƒä»¬è¿è¡Œåçš„ç»“æœã€‚</li>
<li>join / try_join æ˜¯ç”¨æ¥è½®è¯¢å¤šä¸ª Future çš„å®:</li>
</ol>
<ul>
<li>å®ƒä¼šä¾æ¬¡å¤„ç†æ¯ä¸ª Future</li>
<li>é‡åˆ°é˜»å¡å°±å¤„ç†ä¸‹ä¸€ä¸ª</li>
<li>ç›´åˆ°æ‰€æœ‰ Future äº§ç”Ÿç»“æœã€‚</li>
</ul>
<blockquote>
<p>æ•´ä¸ªç­‰å¾…æ–‡ä»¶è¯»å–çš„æ—¶é—´æ˜¯ max(time_for_file1, time_for_file2)ï¼Œæ€§èƒ½å’Œä½¿ç”¨çº¿ç¨‹çš„ç‰ˆæœ¬å‡ ä¹ä¸€è‡´ï¼Œä½†æ˜¯æ¶ˆè€—çš„èµ„æºï¼ˆä¸»è¦æ˜¯çº¿ç¨‹ï¼‰è¦å°‘å¾ˆå¤šã€‚</p>
</blockquote>
<p>å»ºè®®ä½ å¥½å¥½å¯¹æ¯”è¿™ä¸‰ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œå†™ä¸€å†™ï¼Œè¿è¡Œä¸€ä¸‹ï¼Œæ„Ÿå—å®ƒä»¬çš„å¤„ç†é€»è¾‘ã€‚</p>
<p>æ³¨æ„åœ¨æœ€åçš„ async/await çš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½æŠŠä»£ç å†™æˆè¿™æ ·ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
// è¯»å– Cargo.tomlï¼ŒIO æ“ä½œ 1
let content1 = fs::read_to_string(&quot;./Cargo.toml&quot;).await?;
// è¯»å– Cargo.lockï¼ŒIO æ“ä½œ 2
let content1 = fs::read_to_string(&quot;./Cargo.lock&quot;).await?;
</code></pre></pre>
<p>è¿™æ ·å†™çš„è¯ï¼Œå’Œç¬¬ä¸€ç‰ˆåŒæ­¥çš„ç‰ˆæœ¬æ²¡æœ‰åŒºåˆ«ï¼Œå› ä¸º await ä¼šè¿è¡Œ Future ç›´åˆ° Future æ‰§è¡Œç»“æŸï¼Œæ‰€ä»¥ä¾æ—§æ˜¯å…ˆè¯»å– Cargo.tomlï¼Œå†è¯»å– Cargo.lockï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°å¹¶å‘çš„æ•ˆæœã€‚</p>
</div>
</details>
<h3 id="æ·±å…¥æ€è·¯"><a class="header" href="#æ·±å…¥æ€è·¯">æ·±å…¥æ€è·¯</a></h3>
<details id="admonition-ä»async-fnäº†è§£åˆ°futureçš„æ€è·¯" class="admonition info">
<summary class="admonition-title">
<p>ä»async fnäº†è§£åˆ°futureçš„æ€è·¯</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä»async-fnäº†è§£åˆ°futureçš„æ€è·¯"></a></p>
</summary>
<div>
<ol>
<li>æ‹†è§£ async fn æœ‰ç‚¹å¥‡æ€ªçš„è¿”å›å€¼ç»“æ„</li>
<li>æˆ‘ä»¬å­¦ä¹ äº† Reactor pattern</li>
<li>å¤§è‡´äº†è§£äº† tokio å¦‚ä½•é€šè¿‡ executor å’Œ reactor å…±åŒä½œç”¨ï¼Œå®Œæˆ Future çš„è°ƒåº¦ã€æ‰§è¡Œã€é˜»å¡ï¼Œä»¥åŠå”¤é†’ã€‚è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¾ªç¯ï¼Œç›´åˆ° Future è¿”å› Poll::Ready(T)ã€‚</li>
</ol>
</div>
</details>
<h3 id="æ·±å…¥äº†è§£"><a class="header" href="#æ·±å…¥äº†è§£">æ·±å…¥äº†è§£</a></h3>
<p>å¥½ï¼Œäº†è§£äº† Future åœ¨è½¯ä»¶å¼€å‘ä¸­çš„å¿…è¦æ€§ï¼Œæ¥æ·±å…¥ç ”ç©¶ä¸€ä¸‹ Future/async/awaitã€‚</p>
<details id="admonition-å¼‚æ­¥å‡½æ•°async-fnå…¶å®æ˜¯è¯­æ³•ç³–å®ƒæœ‰ç­‰ä»·å‡½æ•°å†™æ³•" class="admonition info">
<summary class="admonition-title">
<p>å¼‚æ­¥å‡½æ•°ï¼ˆasync fnï¼‰å…¶å®æ˜¯è¯­æ³•ç³–ï¼Œå®ƒæœ‰ç­‰ä»·å‡½æ•°å†™æ³•ã€‚</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å¼‚æ­¥å‡½æ•°async-fnå…¶å®æ˜¯è¯­æ³•ç³–å®ƒæœ‰ç­‰ä»·å‡½æ•°å†™æ³•"></a></p>
</summary>
<div>
<p>åœ¨å‰é¢ä»£ç æ’°å†™è¿‡ç¨‹ä¸­ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ï¼Œå¼‚æ­¥å‡½æ•°ï¼ˆasync fnï¼‰çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„ impl Future<Output> çš„ç»“æ„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/38%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9AFuture%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AE%83%E5%92%8Casyncawait%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%9F.png" alt="38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasyncawaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" /></p>
<blockquote>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€èˆ¬ä¼šç”¨ impl å…³é”®å­—ä¸ºæ•°æ®ç»“æ„å®ç° traitï¼Œä¹Ÿå°±æ˜¯è¯´æ¥åœ¨ impl å…³é”®å­—åé¢çš„ä¸œè¥¿æ˜¯ä¸€ä¸ª traitï¼Œæ‰€ä»¥ï¼Œæ˜¾ç„¶ Future æ˜¯ä¸€ä¸ª traitï¼Œå¹¶ä¸”è¿˜æœ‰ä¸€ä¸ªå…³è”ç±»å‹ Outputã€‚</p>
</blockquote>
<p>æ¥çœ‹ <a href="https://doc.rust-lang.org/std/future/trait.Future.html">Future çš„å®šä¹‰</a>ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Future {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}

pub enum Poll&lt;T&gt; {
    Ready(T),
    Pending,
}
</code></pre></pre>
<ol>
<li>é™¤äº† Output å¤–ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ª poll() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å› <a href="https://doc.rust-lang.org/std/future/trait.Future.html">PollSelf::Output</a>ã€‚</li>
<li>è€Œ Poll<T> æ˜¯ä¸ª enumï¼ŒåŒ…å« Ready å’Œ Pending ä¸¤ä¸ªçŠ¶æ€ã€‚</li>
<li>æ˜¾ç„¶ï¼Œå½“ Future è¿”å› Pending çŠ¶æ€æ—¶ï¼Œæ´»è¿˜æ²¡å¹²å®Œï¼Œä½†å¹²ä¸ä¸‹å»äº†ï¼Œéœ€è¦é˜»å¡ä¸€é˜µå­ï¼Œç­‰æŸä¸ªäº‹ä»¶å°†å…¶å”¤é†’ï¼›</li>
<li>å½“ Future è¿”å› Ready çŠ¶æ€æ—¶ï¼ŒFuture å¯¹åº”çš„å€¼å·²ç»å¾—åˆ°ï¼Œæ­¤æ—¶å¯ä»¥è¿”å›äº†ã€‚</li>
</ol>
<blockquote>
<p>ä½ çœ‹ï¼Œè¿™æ ·ä¸€ä¸ªç®€å•çš„æ•°æ®ç»“æ„ï¼Œå°±æ‰˜èµ·äº†åºå¤§çš„ Rust å¼‚æ­¥ async/await å¤„ç†çš„ç”Ÿæ€ã€‚</p>
</blockquote>
<p>å›åˆ° async fn çš„è¿”å›å€¼æˆ‘ä»¬æ¥ç€è¯´ï¼Œæ˜¾ç„¶å®ƒæ˜¯ä¸€ä¸ª impl Future.</p>
<blockquote>
<p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬ç»™ä¸€ä¸ªæ™®é€šçš„å‡½æ•°è¿”å› impl Future<Output>ï¼Œå®ƒçš„è¡Œä¸ºå’Œ async fn æ˜¯ä¸æ˜¯ä¸€è‡´å‘¢ï¼Ÿ</p>
</blockquote>
<p>æ¥å†™ä¸ªç®€å•çš„å®éªŒï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use futures::executor::block_on;
use std::future::Future;

#[tokio::main]
async fn main() {
    let name1 = &quot;Tyr&quot;.to_string();
    let name2 = &quot;Lindsey&quot;.to_string();

    say_hello1(&amp;name1).await;
    say_hello2(&amp;name2).await;

    // Future é™¤äº†å¯ä»¥ç”¨ await æ¥æ‰§è¡Œå¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥ç”¨ executor æ‰§è¡Œ
    block_on(say_hello1(&amp;name1));
    block_on(say_hello2(&amp;name2));
}

async fn say_hello1(name: &amp;str) -&gt; usize {
    println!(&quot;Hello {}&quot;, name);
    42
}

// async fn å…³é”®å­—ç›¸å½“äºä¸€ä¸ªè¿”å› impl Future&lt;Output&gt; çš„è¯­æ³•ç³–
fn say_hello2&lt;'fut&gt;(name: &amp;'fut str) -&gt; impl Future&lt;Output = usize&gt; + 'fut {
    async move {
        println!(&quot;Hello {}&quot;, name);
        42
    }
}
</code></pre></pre>
<blockquote>
<p>è¿è¡Œè¿™æ®µä»£ç ä½ ä¼šå‘ç°ï¼Œsay_hello1 å’Œ say_hello2 æ˜¯ç­‰ä»·çš„ï¼ŒäºŒè€…éƒ½å¯ä»¥ä½¿ç”¨ await æ¥æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å°†å…¶æä¾›ç»™ä¸€ä¸ª executor æ¥æ‰§è¡Œã€‚</p>
</blockquote>
</div>
</details>
<h3 id="executor"><a class="header" href="#executor">executor</a></h3>
<details id="admonition-executoræ˜¯ä»€ä¹ˆ--rustå¦‚ä½•æ”¯æŒ-rustå¸¸ç”¨çš„executoræœ‰å“ªäº›" class="admonition info">
<summary class="admonition-title">
<p>executoræ˜¯ä»€ä¹ˆ-&gt; Rustå¦‚ä½•æ”¯æŒ-&gt;Rustå¸¸ç”¨çš„executoræœ‰å“ªäº›ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-executoræ˜¯ä»€ä¹ˆ--rustå¦‚ä½•æ”¯æŒ-rustå¸¸ç”¨çš„executoræœ‰å“ªäº›"></a></p>
</summary>
<div>
<p>è¿™é‡Œæˆ‘ä»¬è§åˆ°äº†ä¸€ä¸ªæ–°çš„åè¯ï¼šexecutorã€‚</p>
<p>ä»€ä¹ˆæ˜¯ executorï¼Ÿ</p>
<ol>
<li>ä½ å¯ä»¥æŠŠ executor å¤§è‡´æƒ³è±¡æˆä¸€ä¸ª Future çš„è°ƒåº¦å™¨ã€‚</li>
<li>å¯¹äºçº¿ç¨‹æ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£è°ƒåº¦ï¼›</li>
<li>ä½†æ“ä½œç³»ç»Ÿä¸ä¼šå»è°ƒåº¦ç”¨æˆ·æ€çš„åç¨‹ï¼ˆæ¯”å¦‚ Futureï¼‰ï¼Œæ‰€ä»¥ä»»ä½•ä½¿ç”¨äº†åç¨‹æ¥å¤„ç†å¹¶å‘çš„ç¨‹åºï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ª executor æ¥è´Ÿè´£åç¨‹çš„è°ƒåº¦ã€‚</li>
</ol>
<p>å¾ˆå¤šåœ¨è¯­è¨€å±‚é¢æ”¯æŒåç¨‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ¯”å¦‚ Golang / Erlangï¼Œéƒ½è‡ªå¸¦ä¸€ä¸ªç”¨æˆ·æ€çš„è°ƒåº¦å™¨ã€‚</p>
<p>Rust è™½ç„¶ä¹Ÿæä¾› Future è¿™æ ·çš„åç¨‹ï¼Œä½†å®ƒåœ¨è¯­è¨€å±‚é¢å¹¶ä¸æä¾› executorï¼ŒæŠŠè¦ä¸è¦ä½¿ç”¨ executor å’Œä½¿ç”¨ä»€ä¹ˆæ ·çš„ executor çš„è‡ªä¸»æƒäº¤ç»™äº†å¼€å‘è€…ã€‚</p>
<ul>
<li>å¥½å¤„æ˜¯ï¼Œå½“æˆ‘çš„ä»£ç ä¸­ä¸éœ€è¦ä½¿ç”¨åç¨‹æ—¶ï¼Œä¸éœ€è¦å¼•å…¥ä»»ä½•è¿è¡Œæ—¶ï¼›</li>
<li>è€Œéœ€è¦ä½¿ç”¨åç¨‹æ—¶ï¼Œå¯ä»¥åœ¨ç”Ÿæ€ç³»ç»Ÿä¸­é€‰æ‹©æœ€åˆé€‚æˆ‘åº”ç”¨çš„ executorã€‚</li>
</ul>
<hr />
<p>å¸¸è§çš„ executor æœ‰ï¼š</p>
<ol>
<li>futures åº“è‡ªå¸¦çš„å¾ˆç®€å•çš„ executorï¼Œä¸Šé¢çš„ä»£ç å°±ä½¿ç”¨äº†å®ƒçš„ block_on å‡½æ•°ï¼›</li>
<li>tokio æä¾›çš„ executorï¼Œå½“ä½¿ç”¨ #[tokio::main] æ—¶ï¼Œå°±éšå«å¼•å…¥äº† tokio çš„ executorï¼›</li>
<li><a href="https://github.com/async-rs/async-std">async-std</a> æä¾›çš„ executorï¼Œå’Œ tokio ç±»ä¼¼ï¼›</li>
<li><a href="https://github.com/smol-rs/smol">smol æä¾›çš„ async-executor</a>ï¼Œä¸»è¦æä¾›äº† block_onã€‚</li>
</ol>
<p>æ³¨æ„ï¼Œä¸Šé¢çš„ä»£ç æˆ‘ä»¬æ··ç”¨äº† #[tokio::main] å’Œ futures:executor::block_onï¼Œè¿™åªæ˜¯ä¸ºäº†å±•ç¤º Future ä½¿ç”¨çš„ä¸åŒæ–¹å¼ï¼Œåœ¨æ­£å¼ä»£ç é‡Œï¼Œä¸å»ºè®®æ··ç”¨ä¸åŒçš„ executorï¼Œä¼šé™ä½ç¨‹åºçš„æ€§èƒ½ï¼Œè¿˜å¯èƒ½å¼•å‘å¥‡æ€ªçš„é—®é¢˜ã€‚</p>
</div>
</details>
<h3 id="reactor-pattern"><a class="header" href="#reactor-pattern">reactor pattern</a></h3>
<details id="admonition-reactor-patternå¦‚ä½•ç»„æˆ" class="admonition info">
<summary class="admonition-title">
<p>Reactor Patternå¦‚ä½•ç»„æˆï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-reactor-patternå¦‚ä½•ç»„æˆ"></a></p>
</summary>
<div>
<p>å½“æˆ‘ä»¬è°ˆåˆ° executor æ—¶ï¼Œå°±ä¸å¾—ä¸æ reactorï¼Œå®ƒä¿©éƒ½æ˜¯ Reactor Pattern çš„ç»„æˆéƒ¨åˆ†ï¼Œä½œä¸ºæ„å»ºé«˜æ€§èƒ½äº‹ä»¶é©±åŠ¨ç³»ç»Ÿçš„ä¸€ä¸ªå¾ˆå…¸å‹æ¨¡å¼ï¼ŒReactor pattern å®ƒåŒ…å«ä¸‰éƒ¨åˆ†ï¼š</p>
<ol>
<li>taskï¼Œå¾…å¤„ç†çš„ä»»åŠ¡</li>
</ol>
<p>ä»»åŠ¡å¯ä»¥è¢«æ‰“æ–­ï¼Œå¹¶ä¸”æŠŠæ§åˆ¶æƒäº¤ç»™ executorï¼Œç­‰å¾…ä¹‹åçš„è°ƒåº¦ï¼›</p>
<ol start="2">
<li>executorï¼Œä¸€ä¸ªè°ƒåº¦å™¨ã€‚</li>
</ol>
<p>ç»´æŠ¤ç­‰å¾…è¿è¡Œçš„ä»»åŠ¡ï¼ˆready queueï¼‰ï¼Œä»¥åŠè¢«é˜»å¡çš„ä»»åŠ¡ï¼ˆwait queueï¼‰ï¼›</p>
<ol start="3">
<li>reactorï¼Œç»´æŠ¤äº‹ä»¶é˜Ÿåˆ—ã€‚</li>
</ol>
<p>å½“äº‹ä»¶æ¥ä¸´æ—¶ï¼Œé€šçŸ¥ executor å”¤é†’æŸä¸ªä»»åŠ¡ç­‰å¾…è¿è¡Œã€‚</p>
<ul>
<li>executor ä¼šè°ƒåº¦æ‰§è¡Œå¾…å¤„ç†çš„ä»»åŠ¡ï¼Œå½“ä»»åŠ¡æ— æ³•ç»§ç»­è¿›è¡Œå´åˆæ²¡æœ‰å®Œæˆæ—¶ï¼Œå®ƒä¼šæŒ‚èµ·ä»»åŠ¡ï¼Œå¹¶è®¾ç½®å¥½åˆé€‚çš„å”¤é†’æ¡ä»¶ã€‚</li>
<li>ä¹‹åï¼Œå¦‚æœ reactor å¾—åˆ°äº†æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶ï¼Œå®ƒä¼šå”¤é†’ä¹‹å‰æŒ‚èµ·çš„ä»»åŠ¡ï¼Œç„¶å executor å°±æœ‰æœºä¼šç»§ç»­æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚</li>
<li>è¿™æ ·ä¸€ç›´å¾ªç¯ä¸‹å»ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</li>
</ul>
</div>
</details>
<h3 id="æ€ä¹ˆç”¨-future-åšå¼‚æ­¥å¤„ç†"><a class="header" href="#æ€ä¹ˆç”¨-future-åšå¼‚æ­¥å¤„ç†">æ€ä¹ˆç”¨ Future åšå¼‚æ­¥å¤„ç†ï¼Ÿ</a></h3>
<details id="admonition-rustå¦‚ä½•åŸºäºreactor-patternä½¿ç”¨futureåšå¼‚æ­¥å¤„ç†" class="admonition info">
<summary class="admonition-title">
<p>Rustå¦‚ä½•åŸºäºReactor patternä½¿ç”¨Futureåšå¼‚æ­¥å¤„ç†</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-rustå¦‚ä½•åŸºäºreactor-patternä½¿ç”¨futureåšå¼‚æ­¥å¤„ç†"></a></p>
</summary>
<div>
<p>ç†è§£äº† Reactor pattern åï¼ŒRust ä½¿ç”¨ Future åšå¼‚æ­¥å¤„ç†çš„æ•´ä¸ªç»“æ„å°±æ¸…æ™°äº†ï¼Œæˆ‘ä»¬ä»¥ tokio ä¸ºä¾‹ï¼š</p>
<ol>
<li>async/await æä¾›è¯­æ³•å±‚é¢çš„æ”¯æŒ</li>
<li>Future æ˜¯å¼‚æ­¥ä»»åŠ¡çš„æ•°æ®ç»“æ„</li>
<li>å½“ fut.await æ—¶ï¼Œexecutor å°±ä¼šè°ƒåº¦å¹¶æ‰§è¡Œå®ƒã€‚</li>
</ol>
<hr />
<ul>
<li>tokio çš„è°ƒåº¦å™¨ï¼ˆexecutorï¼‰ä¼šè¿è¡Œåœ¨å¤šä¸ªçº¿ç¨‹ä¸Šï¼Œè¿è¡Œçº¿ç¨‹è‡ªå·±çš„ ready queue ä¸Šçš„ä»»åŠ¡ï¼ˆFutureï¼‰</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œå°±å»åˆ«çš„çº¿ç¨‹çš„è°ƒåº¦å™¨ä¸Šâ€œå·â€ä¸€äº›è¿‡æ¥è¿è¡Œã€‚</li>
<li>å½“æŸä¸ªä»»åŠ¡æ— æ³•å†ç»§ç»­å–å¾—è¿›å±•ï¼Œæ­¤æ—¶ Future è¿è¡Œçš„ç»“æœæ˜¯ Poll::Pendingï¼Œé‚£ä¹ˆè°ƒåº¦å™¨ä¼šæŒ‚èµ·ä»»åŠ¡ï¼Œå¹¶è®¾ç½®å¥½åˆé€‚çš„å”¤é†’æ¡ä»¶ï¼ˆWakerï¼‰ï¼Œç­‰å¾…è¢« reactor å”¤é†’ã€‚</li>
<li>è€Œ reactor ä¼šåˆ©ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„å¼‚æ­¥ I/Oï¼Œæ¯”å¦‚ epoll / kqueue / IOCPï¼Œæ¥ç›‘å¬æ“ä½œç³»ç»Ÿæä¾›çš„ IO äº‹ä»¶ï¼Œå½“é‡åˆ°æ»¡è¶³æ¡ä»¶çš„äº‹ä»¶æ—¶ï¼Œå°±ä¼šè°ƒç”¨ Waker.wake() å”¤é†’è¢«æŒ‚èµ·çš„ Futureã€‚è¿™ä¸ª Future ä¼šå›åˆ° ready queue ç­‰å¾…æ‰§è¡Œã€‚</li>
</ul>
<hr />
<p>æ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p>
<h2 id="-13"><a class="header" href="#-13"><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/38%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9AFuture%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AE%83%E5%92%8Casyncawait%E6%98%AF%E4%BB%80%E4%B9%88%E5%85%B3%E7%B3%BB%EF%BC%9F.jpg" alt="38ï½œå¼‚æ­¥å¤„ç†ï¼šFutureæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’Œasyncawaitæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ" /></a></h2>
<p>æˆ‘ä»¬ä»¥ä¸€ä¸ªå…·ä½“çš„ä»£ç ç¤ºä¾‹æ¥è¿›ä¸€æ­¥ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use futures::{SinkExt, StreamExt};
use tokio::net::TcpListener;
use tokio_util::codec::{Framed, LinesCodec};

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let addr = &quot;0.0.0.0:8080&quot;;
    let listener = TcpListener::bind(addr).await?;
    println!(&quot;listen to: {}&quot;, addr);
    loop {
        let (stream, addr) = listener.accept().await?;
        println!(&quot;Accepted: {:?}&quot;, addr);
        tokio::spawn(async move {
            // ä½¿ç”¨ LinesCodec æŠŠ TCP æ•°æ®åˆ‡æˆä¸€è¡Œè¡Œå­—ç¬¦ä¸²å¤„ç†
            let framed = Framed::new(stream, LinesCodec::new());
            // split æˆ writer å’Œ reader
            let (mut w, mut r) = framed.split();
            for line in r.next().await {
                // æ¯è¯»åˆ°ä¸€è¡Œå°±åŠ ä¸ªå‰ç¼€å‘å›
                w.send(format!(&quot;I got: {}&quot;, line?)).await?;
            }
            Ok::&lt;_, anyhow::Error&gt;(())
        });
    }
}
</code></pre></pre>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ TCP æœåŠ¡å™¨:</p>
<ol>
<li>æœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°±ä¼šç”¨<a href="https://docs.rs/tokio/1.13.0/tokio/fn.spawn.html"> tokio::spawn </a>åˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæ”¾å…¥ executor ä¸­æ‰§è¡Œã€‚</li>
<li>è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡æ¥å—å®¢æˆ·ç«¯å‘æ¥çš„æŒ‰è¡Œåˆ†éš”ï¼ˆåˆ†éš”ç¬¦æ˜¯ â€œ\r\nâ€ï¼‰çš„æ•°æ®å¸§ï¼ŒæœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€è¡Œï¼Œå°±åŠ ä¸ªå‰ç¼€æŠŠå†…å®¹ä¹ŸæŒ‰è¡Œå‘å›ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>ä½ å¯ä»¥ç”¨ telnet å’Œè¿™ä¸ªæœåŠ¡å™¨äº¤äº’ï¼š</li>
</ol>
<pre><code class="language-shell">â¯ telnet localhost 8080
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
hello
I got: hello
Connection closed by foreign host.
</code></pre>
<ul>
<li>å‡è®¾æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯è¾“å…¥äº†å¾ˆå¤§çš„ä¸€è¡Œæ•°æ®ï¼ŒæœåŠ¡å™¨åœ¨åš r.next().await åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œæ”¶ä¸å®Œä¸€è¡Œçš„æ•°æ®ï¼Œå› è€Œè¿™ä¸ª Future è¿”å› Poll::Pendingï¼Œæ­¤æ—¶å®ƒè¢«æŒ‚èµ·ã€‚</li>
<li>å½“åç»­å®¢æˆ·ç«¯çš„æ•°æ®åˆ°è¾¾æ—¶ï¼Œreactor ä¼šçŸ¥é“è¿™ä¸ª socket ä¸Šåˆæœ‰æ•°æ®äº†ï¼Œäºæ˜¯æ‰¾åˆ° socket å¯¹åº”çš„ Futureï¼Œå°†å…¶å”¤é†’ï¼Œç»§ç»­æ¥æ”¶æ•°æ®ã€‚</li>
<li>è¿™æ ·åå¤ä¸‹å»ï¼Œæœ€ç»ˆ r.next().await å¾—åˆ° Poll::Ready(Ok(line))ï¼Œäºæ˜¯å®ƒè¿”å› Ok(line)ï¼Œç¨‹åºç»§ç»­å¾€ä¸‹èµ°ï¼Œè¿›å…¥åˆ° w.send() çš„é˜¶æ®µã€‚</li>
</ul>
<blockquote>
<p>ä»è¿™æ®µä»£ç ä¸­ä½ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Rust ä¸‹ä½¿ç”¨å¼‚æ­¥å¤„ç†æ˜¯ä¸€ä»¶éå¸¸ç®€å•çš„äº‹æƒ…</p>
</blockquote>
<ol>
<li>é™¤äº†å‡ ä¸ªä½ å¯èƒ½ä¸å¤ªç†Ÿæ‚‰çš„æ¦‚å¿µ:</li>
</ol>
<ul>
<li>æ¯”å¦‚ç”¨äºåˆ›å»º Future çš„ async å…³é”®å­—</li>
<li>ç”¨äºæ‰§è¡Œå’Œç­‰å¾… Future æ‰§è¡Œå®Œæ¯•çš„ await å…³é”®å­—</li>
<li>ä»¥åŠç”¨äºè°ƒåº¦ Future æ‰§è¡Œçš„è¿è¡Œæ—¶ #[tokio:main] </li>
</ul>
<ol start="2">
<li>æ•´ä½“çš„ä»£ç å’Œä½¿ç”¨çº¿ç¨‹å¤„ç†çš„ä»£ç å®Œå…¨ä¸€è‡´ã€‚æ‰€ä»¥ï¼Œå®ƒçš„ä¸Šæ‰‹éš¾åº¦éå¸¸ä½ï¼Œå¾ˆå®¹æ˜“ä½¿ç”¨ã€‚</li>
</ol>
</div>
</details>
<h3 id="ä½¿ç”¨-future-çš„æ³¨æ„äº‹é¡¹"><a class="header" href="#ä½¿ç”¨-future-çš„æ³¨æ„äº‹é¡¹">ä½¿ç”¨ Future çš„æ³¨æ„äº‹é¡¹</a></h3>
<details id="admonition-ä½¿ç”¨futureå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ä¸‰ä¸ªæ³¨æ„äº‹é¡¹" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨Futureå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ä¸‰ä¸ªæ³¨æ„äº‹é¡¹</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä½¿ç”¨futureå¤„ç†å¼‚æ­¥ä»»åŠ¡çš„ä¸‰ä¸ªæ³¨æ„äº‹é¡¹"></a></p>
</summary>
<div>
<p>ç›®å‰æˆ‘ä»¬å·²ç»åŸºæœ¬æ˜ç™½ Future è¿è¡Œçš„åŸºæœ¬åŸç†äº†ï¼Œä¹Ÿå¯ä»¥åœ¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†è‡ªå¦‚åœ°ä½¿ç”¨ Future/async/await æ¥è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚</p>
<p>ä½†æ˜¯è¦æ³¨æ„ï¼Œä¸æ˜¯æ‰€æœ‰çš„åº”ç”¨åœºæ™¯éƒ½é€‚åˆç”¨ async/awaitï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæœ‰ä¸€äº›ä¸å®¹æ˜“æ³¨æ„åˆ°çš„å‘éœ€è¦æˆ‘ä»¬å¦¥å–„è€ƒè™‘ã€‚</p>
<ol>
<li>å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ—¶</li>
</ol>
<p>å½“ä½ è¦å¤„ç†çš„ä»»åŠ¡æ˜¯ CPU å¯†é›†å‹ï¼Œè€Œé IO å¯†é›†å‹ï¼Œæ›´é€‚åˆä½¿ç”¨çº¿ç¨‹ï¼Œè€Œé Futureã€‚</p>
<p>è¿™æ˜¯å› ä¸º Future çš„è°ƒåº¦æ˜¯åä½œå¼å¤šä»»åŠ¡ï¼ˆCooperative Multitaskingï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤é Future ä¸»åŠ¨æ”¾å¼ƒ CPUï¼Œä¸ç„¶å®ƒå°±ä¼šä¸€ç›´è¢«æ‰§è¡Œï¼Œç›´åˆ°è¿è¡Œç»“æŸã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use std::time::Duration;

// å¼ºåˆ¶ tokio åªä½¿ç”¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè¿™æ · task 2 ä¸ä¼šè·‘åˆ°å…¶å®ƒçº¿ç¨‹æ‰§è¡Œ
#[tokio::main(worker_threads = 1)]
async fn main() -&gt; Result&lt;()&gt; {
    // å…ˆå¼€å§‹æ‰§è¡Œ task 1 çš„è¯ä¼šé˜»å¡ï¼Œè®© task 2 æ²¡æœ‰æœºä¼šè¿è¡Œ
    tokio::spawn(async move {
        eprintln!(&quot;task 1&quot;);
        // è¯•è¯•æŠŠè¿™å¥æ³¨é‡Šæ‰çœ‹çœ‹ä¼šäº§ç”Ÿä»€ä¹ˆç»“æœ
        // tokio::time::sleep(Duration::from_millis(1)).await;
        loop {}
    });

    tokio::spawn(async move {
        eprintln!(&quot;task 2&quot;);
    });

    tokio::time::sleep(Duration::from_millis(1)).await;
    Ok(())
}
</code></pre></pre>
<p>task 1 é‡Œæœ‰ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ˜¯æ‰§è¡Œæ—¶é—´å¾ˆé•¿åˆä¸åŒ…æ‹¬ IO å¤„ç†çš„ä»£ç ã€‚è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå‘ç°ï¼Œtask 2 æ²¡æœ‰æœºä¼šå¾—åˆ°æ‰§è¡Œã€‚è¿™æ˜¯å› ä¸º task 1 ä¸æ‰§è¡Œç»“æŸï¼Œæˆ–è€…ä¸è®©å‡º CPUï¼Œtask 2 æ²¡æœ‰æœºä¼šè¢«è°ƒåº¦ã€‚</p>
<ol start="2">
<li>å¼‚æ­¥ä»£ç ä¸­ä½¿ç”¨ Mutex æ—¶</li>
</ol>
<p>å¤§éƒ¨åˆ†æ—¶å€™ï¼Œæ ‡å‡†åº“çš„ Mutex å¯ä»¥ç”¨åœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œè€Œä¸”ï¼Œè¿™æ˜¯æ¨èçš„ç”¨æ³•ã€‚</p>
<p>ç„¶è€Œï¼Œæ ‡å‡†åº“çš„ MutexGuard ä¸èƒ½å®‰å…¨åœ°è·¨è¶Š awaitï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬éœ€è¦è·å¾—é”ä¹‹åæ‰§è¡Œå¼‚æ­¥æ“ä½œï¼Œå¿…é¡»ä½¿ç”¨ tokio è‡ªå¸¦çš„ Mutexï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use std::{sync::Arc, time::Duration};
use tokio::sync::Mutex;

struct DB;

impl DB {
    // å‡è£…åœ¨ commit æ•°æ®
    async fn commit(&amp;mut self) -&gt; Result&lt;usize&gt; {
        Ok(42)
    }
}

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let db1 = Arc::new(Mutex::new(DB));
    let db2 = Arc::clone(&amp;db1);

    tokio::spawn(async move {
        let mut db = db1.lock().await;
        // å› ä¸ºæ‹¿åˆ°çš„ MutexGuard è¦è·¨è¶Š awaitï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ std::sync::Mutex
        // åªèƒ½ç”¨ tokio::sync::Mutex
        let affected = db.commit().await?;
        println!(&quot;db1: Total affected rows: {}&quot;, affected);
        Ok::&lt;_, anyhow::Error&gt;(())
    });

    tokio::spawn(async move {
        let mut db = db2.lock().await;
        let affected = db.commit().await?;
        println!(&quot;db2: Total affected rows: {}&quot;, affected);

        Ok::&lt;_, anyhow::Error&gt;(())
    });

    // è®©ä¸¤ä¸ª task æœ‰æœºä¼šæ‰§è¡Œå®Œ
    tokio::time::sleep(Duration::from_millis(1)).await;

    Ok(())
}
</code></pre></pre>
<blockquote>
<p>è¿™ä¸ªä¾‹å­æ¨¡æ‹Ÿäº†ä¸€ä¸ªæ•°æ®åº“çš„å¼‚æ­¥ commit() æ“ä½œ</p>
</blockquote>
<ul>
<li>å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨å¤šä¸ª tokio task ä¸­ä½¿ç”¨è¿™ä¸ª DBï¼Œéœ€è¦ä½¿ç”¨ Arc&lt;Mutext<DB>&gt;ã€‚</li>
<li>ç„¶è€Œï¼Œdb1.lock() æ‹¿åˆ°é”åï¼Œæˆ‘ä»¬éœ€è¦è¿è¡Œ db.commit().awaitï¼Œè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚</li>
<li>å‰é¢è®²è¿‡ï¼Œå› ä¸º tokio å®ç°äº† work-stealing è°ƒåº¦ï¼ŒFuture æœ‰å¯èƒ½åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ™®é€šçš„ MutexGuard ç¼–è¯‘ç›´æ¥å°±ä¼šå‡ºé”™ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ tokio çš„ Mutexã€‚<a href="https://docs.rs/tokio/1.13.0/tokio/sync/struct.Mutex.html">æ›´å¤šä¿¡æ¯å¯ä»¥çœ‹æ–‡æ¡£</a>ã€‚</li>
</ul>
<blockquote>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬åˆè§è¯†åˆ°äº† Rust ç¼–è¯‘å™¨çš„ä¼Ÿå¤§ä¹‹å¤„ï¼šå¦‚æœä¸€ä»¶äº‹ï¼Œå®ƒè§‰å¾—ä½ ä¸èƒ½åšï¼Œä¼šé€šè¿‡ç¼–è¯‘å™¨é”™è¯¯é˜»æ­¢ä½ ï¼Œè€Œä¸æ˜¯ä»»ç”±ç¼–è¯‘é€šè¿‡ï¼Œç„¶åè®©ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¬å¤©ç”±å‘½ï¼Œè®©ä½ æ— ä¼‘æ­¢åœ°å’Œæ‰æ‘¸ä¸å®šçš„å¹¶å‘ bug æ–—äº‰ã€‚</p>
</blockquote>
<ol start="3">
<li>åœ¨çº¿ç¨‹å’Œå¼‚æ­¥ä»»åŠ¡é—´åšåŒæ­¥æ—¶</li>
</ol>
<p>åœ¨ä¸€ä¸ªå¤æ‚çš„åº”ç”¨ç¨‹åºä¸­ï¼Œä¼šå…¼æœ‰è®¡ç®—å¯†é›†å’Œ IO å¯†é›†çš„ä»»åŠ¡ã€‚</p>
<p>å‰é¢è¯´äº†ï¼Œè¦é¿å…åœ¨ tokio è¿™æ ·çš„å¼‚æ­¥è¿è¡Œæ—¶ä¸­è¿è¡Œå¤§é‡è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œä¸€æ¥æ•ˆç‡ä¸é«˜ï¼ŒäºŒæ¥è¿˜å®¹æ˜“é¥¿æ­»å…¶å®ƒä»»åŠ¡ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯æˆ‘ä»¬ä½¿ç”¨ channel æ¥åœ¨çº¿ç¨‹å’Œ future ä¸¤è€…ä¹‹é—´åšåŒæ­¥ã€‚çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::thread;

use anyhow::Result;
use blake3::Hasher;
use futures::{SinkExt, StreamExt};
use rayon::prelude::*;
use tokio::{
    net::TcpListener,
    sync::{mpsc, oneshot},
};
use tokio_util::codec::{Framed, LinesCodec};

pub const PREFIX_ZERO: &amp;[u8] = &amp;[0, 0, 0];

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let addr = &quot;0.0.0.0:8080&quot;;
    let listener = TcpListener::bind(addr).await?;
    println!(&quot;listen to: {}&quot;, addr);

    // åˆ›å»º tokio task å’Œ thread ä¹‹é—´çš„ channel
    let (sender, mut receiver) = mpsc::unbounded_channel::&lt;(String, oneshot::Sender&lt;String&gt;)&gt;();

    // ä½¿ç”¨ thread å¤„ç†è®¡ç®—å¯†é›†å‹ä»»åŠ¡
    thread::spawn(move || {
        // è¯»å–ä» tokio task è¿‡æ¥çš„ msgï¼Œæ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ blocking_recvï¼Œè€Œé await
        while let Some((line, reply)) = receiver.blocking_recv() {
            // è®¡ç®— pow
            let result = match pow(&amp;line) {
                Some((hash, nonce)) =&gt; format!(&quot;hash: {}, once: {}&quot;, hash, nonce),
                None =&gt; &quot;Not found&quot;.to_string(),
            };
            // æŠŠè®¡ç®—ç»“æœä» oneshot channel é‡Œå‘å›
            if let Err(e) = reply.send(result) {
                println!(&quot;Failed to send: {}&quot;, e);
            }
        }
    });

    // ä½¿ç”¨ tokio task å¤„ç† IO å¯†é›†å‹ä»»åŠ¡
    loop {
        let (stream, addr) = listener.accept().await?;
        println!(&quot;Accepted: {:?}&quot;, addr);
        let sender1 = sender.clone();
        tokio::spawn(async move {
            // ä½¿ç”¨ LinesCodec æŠŠ TCP æ•°æ®åˆ‡æˆä¸€è¡Œè¡Œå­—ç¬¦ä¸²å¤„ç†
            let framed = Framed::new(stream, LinesCodec::new());
            // split æˆ writer å’Œ reader
            let (mut w, mut r) = framed.split();
            for line in r.next().await {
                // ä¸ºæ¯ä¸ªæ¶ˆæ¯åˆ›å»ºä¸€ä¸ª oneshot channelï¼Œç”¨äºå‘é€å›å¤
                let (reply, reply_receiver) = oneshot::channel();
                sender1.send((line?, reply))?;

                // æ¥æ”¶ pow è®¡ç®—å®Œæˆåçš„ hash å’Œ nonce
                if let Ok(v) = reply_receiver.await {
                    w.send(format!(&quot;Pow calculated: {}&quot;, v)).await?;
                }
            }
            Ok::&lt;_, anyhow::Error&gt;(())
        });
    }
}

// ä½¿ç”¨ rayon å¹¶å‘è®¡ç®— u32 ç©ºé—´ä¸‹æ‰€æœ‰ nonceï¼Œç›´åˆ°æ‰¾åˆ°æœ‰å¤´ N ä¸ª 0 çš„å“ˆå¸Œ
pub fn pow(s: &amp;str) -&gt; Option&lt;(String, u32)&gt; {
    let hasher = blake3_base_hash(s.as_bytes());
    let nonce = (0..u32::MAX).into_par_iter().find_any(|n| {
        let hash = blake3_hash(hasher.clone(), n).as_bytes().to_vec();
        &amp;hash[..PREFIX_ZERO.len()] == PREFIX_ZERO
    });
    nonce.map(|n| {
        let hash = blake3_hash(hasher, &amp;n).to_hex().to_string();
        (hash, n)
    })
}

// è®¡ç®—æºå¸¦ nonce åçš„å“ˆå¸Œ
fn blake3_hash(mut hasher: blake3::Hasher, nonce: &amp;u32) -&gt; blake3::Hash {
    hasher.update(&amp;nonce.to_be_bytes()[..]);
    hasher.finalize()
}

// è®¡ç®—æ•°æ®çš„å“ˆå¸Œ
fn blake3_base_hash(data: &amp;[u8]) -&gt; Hasher {
    let mut hasher = Hasher::new();
    hasher.update(data);
    hasher
}
</code></pre></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œ:</p>
<ol>
<li>æˆ‘ä»¬ä½¿ç”¨äº†ä¹‹å‰æ’°å†™çš„ TCP server</li>
<li>åªä¸è¿‡è¿™æ¬¡ï¼Œå®¢æˆ·ç«¯è¾“å…¥è¿‡æ¥çš„ä¸€è¡Œæ–‡å­—ï¼Œä¼šè¢«è®¡ç®—å‡ºä¸€ä¸ª POWï¼ˆProof of Workï¼‰çš„å“ˆå¸Œ</li>
<li>è°ƒæ•´ nonceï¼Œä¸æ–­è®¡ç®—å“ˆå¸Œï¼Œç›´åˆ°å“ˆå¸Œçš„å¤´ä¸‰ä¸ªå­—èŠ‚å…¨æ˜¯é›¶ä¸ºæ­¢ã€‚</li>
<li>æœåŠ¡å™¨è¦è¿”å›è®¡ç®—å¥½çš„å“ˆå¸Œå’Œè·å¾—è¯¥å“ˆå¸Œçš„ nonceã€‚</li>
<li>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨çº¿ç¨‹æ¥å¤„ç†å®ƒã€‚</li>
<li>è€Œåœ¨ tokio task å’Œ thread é—´ä½¿ç”¨ channel è¿›è¡ŒåŒæ­¥ã€‚æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ª ubounded MPSC channel ä» tokio task ä¾§å¾€ thread ä¾§å‘é€æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½é™„å¸¦ä¸€ä¸ª oneshot channel ç”¨äº thread ä¾§å¾€ tokio task ä¾§å‘é€æ•°æ®ã€‚</li>
</ol>
<blockquote>
<p>å»ºè®®ä½ ä»”ç»†è¯»è¯»è¿™æ®µä»£ç ï¼Œæœ€å¥½è‡ªå·±å†™ä¸€éï¼Œæ„Ÿå—ä¸€ä¸‹ä½¿ç”¨ channel åœ¨è®¡ç®—å¯†é›†å‹å’Œ IO å¯†é›†å‹ä»»åŠ¡åŒæ­¥çš„æ–¹å¼ã€‚</p>
</blockquote>
<p>å¦‚æœä½ ç”¨ telnet è¿æ¥ï¼Œå‘é€ â€œhello world!â€ï¼Œä¼šå¾—åˆ°ä¸åŒçš„å“ˆå¸Œå’Œ nonceï¼Œå®ƒä»¬éƒ½æ˜¯æ­£ç¡®çš„ç»“æœï¼š</p>
<pre><code class="language-shell">
â¯ telnet localhost 8080
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
hello world!
Pow calculated: hash: 0000006e6e9370d0f60f06bdc288efafa203fd99b9af0480d040b2cc89c44df0, once: 403407307
Connection closed by foreign host.

â¯ telnet localhost 8080
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
hello world!
Pow calculated: hash: 000000e23f0e9b7aeba9060a17ac676f3341284800a2db843e2f0e85f77f52dd, once: 36169623
Connection closed by foreign host.

</code></pre>
</div>
</details>
<h3 id="å¯¹æ¯”çº¿ç¨‹å­¦ä¹ future"><a class="header" href="#å¯¹æ¯”çº¿ç¨‹å­¦ä¹ future">å¯¹æ¯”çº¿ç¨‹å­¦ä¹ Future</a></h3>
<details id="admonition-å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ future" class="admonition info">
<summary class="admonition-title">
<p>å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ future</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ future"></a></p>
</summary>
<div>
<p>åœ¨å­¦ä¹  Future çš„ä½¿ç”¨æ—¶ï¼Œä¼°è®¡ä½ ä¹Ÿå‘ç°äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”çº¿ç¨‹æ¥å­¦ä¹ ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸‹åˆ—ä»£ç çš„ç»“æ„å¤šä¹ˆç›¸ä¼¼ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn thread_async() -&gt; JoinHandle&lt;usize&gt; {
    thread::spawn(move || {
        println!(&quot;hello thread!&quot;);
        42
    })
}

fn task_async() -&gt; impl Future&lt;Output = usize&gt; {
    async move {
        println!(&quot;hello async!&quot;);
        42
    }
}
</code></pre></pre>
</div>
</details>
<h3 id="ä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„-mutex-ä¸èƒ½è·¨è¶Š-await"><a class="header" href="#ä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„-mutex-ä¸èƒ½è·¨è¶Š-await">ä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„ Mutex ä¸èƒ½è·¨è¶Š awaitï¼Ÿ</a></h3>
<p>æƒ³æƒ³çœ‹ï¼Œä¸ºä»€ä¹ˆæ ‡å‡†åº“çš„ Mutex ä¸èƒ½è·¨è¶Š awaitï¼Ÿ</p>
<p>ä½ å¯ä»¥æŠŠæ–‡ä¸­ä½¿ç”¨ tokio::sync::Mutex çš„ä»£ç æ”¹æˆä½¿ç”¨ std::sync::Mutexï¼Œå¹¶å¯¹ä½¿ç”¨çš„æ¥å£åšç›¸åº”çš„æ”¹åŠ¨ï¼ˆæŠŠ lock().await æ”¹æˆ lock().unwrap()ï¼‰ï¼Œçœ‹çœ‹ç¼–è¯‘å™¨ä¼šæŠ¥ä»€ä¹ˆé”™ã€‚</p>
<p>å¯¹ç€é”™è¯¯æç¤ºï¼Œä½ æ˜ç™½ä¸ºä»€ä¹ˆäº†ä¹ˆï¼Ÿ</p>
<h2 id="asyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„"><a class="header" href="#asyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„">async/awaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</a></h2>
<details id="admonition-å¯¹-future-å’Œ-asyncawait-çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£" class="admonition info">
<summary class="admonition-title">
<p>å¯¹ Future å’Œ async/await çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å¯¹-future-å’Œ-asyncawait-çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£"></a></p>
</summary>
<div>
<p>å¯¹ Future å’Œ async/await çš„åŸºæœ¬æ¦‚å¿µæœ‰ä¸€ä¸ªæ¯”è¾ƒæ‰å®çš„ç†è§£:</p>
<ol>
<li>çŸ¥é“åœ¨ä»€ä¹ˆæƒ…å†µä¸‹è¯¥ä½¿ç”¨ Future</li>
<li>ä»€ä¹ˆæƒ…å†µä¸‹è¯¥ä½¿ç”¨ Thread</li>
<li>executor å’Œ reactor æ˜¯æ€ä¹ˆè”åŠ¨æœ€ç»ˆè®© Future å¾—åˆ°äº†ä¸€ä¸ªç»“æœã€‚</li>
</ol>
</div>
</details>
<p>ç„¶è€Œï¼Œæˆ‘ä»¬å¹¶ä¸æ¸…æ¥šä¸ºä»€ä¹ˆ async fn æˆ–è€… async block å°±èƒ½å¤Ÿäº§ç”Ÿ Futureï¼Œä¹Ÿå¹¶ä¸æ˜ç™½ Future æ˜¯æ€ä¹ˆè¢« executor å¤„ç†çš„ã€‚ç»§ç»­æ·±å…¥ä¸‹å»ï¼Œçœ‹çœ‹ async/await
è¿™ä¸¤ä¸ªå…³é”®è¯ç©¶ç«Ÿæ–½äº†ä»€ä¹ˆæ ·çš„é­”æ³•ï¼Œèƒ½å¤Ÿè®©ä¸€åˆ‡å¦‚æ­¤ç®€å•åˆå¦‚æ­¤è‡ªç„¶åœ°è¿è½¬èµ·æ¥ã€‚</p>
<h3 id="contextpin"><a class="header" href="#contextpin">Contextã€Pin</a></h3>
<details id="admonition-ä»futureå®šä¹‰ä¸­çš„pinå’Œcontextå¼€å§‹" class="admonition info">
<summary class="admonition-title">
<p>ä»Futureå®šä¹‰ä¸­çš„Pinå’ŒContextå¼€å§‹</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä»futureå®šä¹‰ä¸­çš„pinå’Œcontextå¼€å§‹"></a></p>
</summary>
<div>
<p>æå‰è¯´æ˜ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¼šç»§ç»­å›´ç»•ç€ Future è¿™ä¸ªç®€çº¦å´åˆå¹¶ä¸ç®€å•çš„æ¥å£ï¼Œæ¥æ¢è®¨ä¸€äº›åŸç†æ€§çš„ä¸œè¥¿ï¼Œä¸»è¦æ˜¯ Context å’Œ Pin è¿™ä¸¤ä¸ªç»“æ„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Future {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}
</code></pre></pre>
</div>
</details>
<h3 id="contextwaker-waker-çš„è°ƒç”¨æœºåˆ¶"><a class="header" href="#contextwaker-waker-çš„è°ƒç”¨æœºåˆ¶">Context::waker: Waker çš„è°ƒç”¨æœºåˆ¶</a></h3>
<details id="admonition-context-å°±æ˜¯-waker-çš„ä¸€ä¸ªå°è£…" class="admonition info">
<summary class="admonition-title">
<p>Context å°±æ˜¯ Waker çš„ä¸€ä¸ªå°è£…</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-context-å°±æ˜¯-waker-çš„ä¸€ä¸ªå°è£…"></a></p>
</summary>
<div>
<p>å…ˆæ¥çœ‹è¿™ä¸ªæ¥å£çš„ Context æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚</p>
<ol>
<li>executor é€šè¿‡è°ƒç”¨ poll æ–¹æ³•æ¥è®© Future ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</li>
<li>å¦‚æœ poll æ–¹æ³•è¿”å› Poll::Pendingï¼Œå°±é˜»å¡ Future</li>
<li>ç›´åˆ° reactor æ”¶åˆ°äº†æŸä¸ªäº‹ä»¶ï¼Œç„¶åè°ƒç”¨ Waker.wake() æŠŠ Future å”¤é†’ã€‚</li>
<li>è¿™ä¸ª Waker æ˜¯å“ªæ¥çš„å‘¢ï¼Ÿ</li>
</ol>
<p>å…¶å®ï¼Œå®ƒéšå«åœ¨ Context ä¸­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct Context&lt;'a&gt; {
    waker: &amp;'a Waker,
    _marker: PhantomData&lt;fn(&amp;'a ()) -&gt; &amp;'a ()&gt;,
}
</code></pre></pre>
<p>æ‰€ä»¥ï¼ŒContext å°±æ˜¯ Waker çš„ä¸€ä¸ªå°è£…ã€‚</p>
<p>å¦‚æœä½ å»çœ‹ Waker çš„å®šä¹‰å’Œç›¸å…³çš„ä»£ç ï¼Œä¼šå‘ç°å®ƒéå¸¸æŠ½è±¡ï¼Œå†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ª vtable æ¥å…è®¸å„ç§å„æ ·çš„ waker çš„è¡Œä¸ºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct RawWakerVTable {
    clone: unsafe fn(*const ()) -&gt; RawWaker,
    wake: unsafe fn(*const ()),
    wake_by_ref: unsafe fn(*const ()),
    drop: unsafe fn(*const ()),
}
</code></pre></pre>
<ol>
<li>è¿™ç§æ‰‹å·¥ç”Ÿæˆ vtable çš„åšæ³•ï¼Œå¯ä»¥æœ€å¤§ç¨‹åº¦å…¼é¡¾æ•ˆç‡å’Œçµæ´»æ€§ã€‚</li>
<li>Rust è‡ªèº«å¹¶ä¸æä¾›å¼‚æ­¥è¿è¡Œæ—¶ï¼Œå®ƒåªåœ¨æ ‡å‡†åº“é‡Œè§„å®šäº†ä¸€äº›åŸºæœ¬çš„æ¥å£ï¼Œè‡³äºæ€ä¹ˆå®ç°ï¼Œå¯ä»¥ç”±å„ä¸ªè¿è¡Œæ—¶ï¼ˆå¦‚ tokioï¼‰è‡ªè¡Œå†³å®šã€‚</li>
<li>æ‰€ä»¥åœ¨æ ‡å‡†åº“ä¸­ï¼Œä½ åªä¼šçœ‹åˆ°è¿™äº›æ¥å£çš„å®šä¹‰ï¼Œä»¥åŠâ€œé«˜å±‚â€æ¥å£çš„å®ç°ï¼Œæ¯”å¦‚ Waker ä¸‹çš„ wake æ–¹æ³•ï¼Œåªæ˜¯è°ƒç”¨äº† vtable é‡Œçš„ wake() è€Œå·²ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
impl Waker {
    /// Wake up the task associated with this `Waker`.
    #[inline]
    pub fn wake(self) {
        // The actual wakeup call is delegated through a virtual function call
        // to the implementation which is defined by the executor.
        let wake = self.waker.vtable.wake;
        let data = self.waker.data;

        // Don't call `drop` -- the waker will be consumed by `wake`.
        crate::mem::forget(self);

        // SAFETY: This is safe because `Waker::from_raw` is the only way
        // to initialize `wake` and `data` requiring the user to acknowledge
        // that the contract of `RawWaker` is upheld.
        unsafe { (wake)(data) };
    }
    ...
}
</code></pre></pre>
<blockquote>
<p>å¦‚æœä½ æƒ³é¡ºè—¤æ‘¸ç“œæ‰¾åˆ° vtable æ˜¯æ€ä¹ˆè®¾ç½®çš„ï¼Œå´å‘ç°ä¸€åˆ‡çº¿ç´¢éƒ½æ‚„æ— å£°æ¯åœ°ä¸­æ–­äº†ï¼Œé‚£æ˜¯å› ä¸ºï¼Œå…·ä½“çš„å®ç°å¹¶ä¸åœ¨æ ‡å‡†åº“ä¸­ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸‰æ–¹çš„å¼‚æ­¥è¿è¡Œæ—¶é‡Œï¼Œæ¯”å¦‚ tokioã€‚</p>
</blockquote>
</div>
</details>
<p>ä¸è¿‡ï¼Œè™½ç„¶æˆ‘ä»¬å¼€å‘æ—¶ä¼šä½¿ç”¨ tokioï¼Œä½†é˜…è¯»ã€ç†è§£ä»£ç æ—¶ï¼Œæˆ‘å»ºè®®çœ‹ futures åº“ï¼Œæ¯”å¦‚ waker vtable çš„å®šä¹‰ã€‚futures åº“è¿˜æœ‰ä¸€ä¸ªç®€å•çš„ executorï¼Œä¹Ÿéå¸¸é€‚åˆè¿›ä¸€æ­¥é€šè¿‡ä»£ç ç†è§£ executor çš„åŸç†ã€‚</p>
<h3 id="async-ç©¶ç«Ÿç”Ÿæˆäº†ä»€ä¹ˆ"><a class="header" href="#async-ç©¶ç«Ÿç”Ÿæˆäº†ä»€ä¹ˆ">async ç©¶ç«Ÿç”Ÿæˆäº†ä»€ä¹ˆï¼Ÿ</a></h3>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ Pinã€‚è¿™æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„æ•°æ®ç»“æ„ï¼Œæ­£å¸¸æ•°æ®ç»“æ„çš„æ–¹æ³•éƒ½æ˜¯ç›´æ¥ä½¿ç”¨ self / &amp;self / &amp;mut selfï¼Œå¯æ˜¯ poll() å´ä½¿ç”¨äº† Pin&lt;&amp;mut self&gt;ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<details id="admonition-rust-åœ¨ç¼–è¯‘-async-fn-æˆ–è€…-async-block-æ—¶å°±ä¼šç”Ÿæˆç±»ä¼¼çš„çŠ¶æ€æœºçš„å®ç°" class="admonition info">
<summary class="admonition-title">
<p>Rust åœ¨ç¼–è¯‘ async fn æˆ–è€… async block æ—¶ï¼Œå°±ä¼šç”Ÿæˆç±»ä¼¼çš„çŠ¶æ€æœºçš„å®ç°</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-rust-åœ¨ç¼–è¯‘-async-fn-æˆ–è€…-async-block-æ—¶å°±ä¼šç”Ÿæˆç±»ä¼¼çš„çŠ¶æ€æœºçš„å®ç°"></a></p>
</summary>
<div>
<p>ä¸ºäº†è®²æ˜ç™½ Pinï¼Œæˆ‘ä»¬å¾—å¾€å‰è¿½è¸ªä¸€æ­¥ï¼Œçœ‹çœ‹äº§ç”Ÿ Future çš„ä¸€ä¸ª async block/fn å†…éƒ¨ç©¶ç«Ÿç”Ÿæˆäº†ä»€ä¹ˆæ ·çš„ä»£ç ï¼Ÿæ¥çœ‹ä¸‹é¢è¿™ä¸ªç®€å•çš„ async å‡½æ•°ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
async fn write_hello_file_async(name: &amp;str) -&gt; anyhow::Result&lt;()&gt; {
    let mut file = fs::File::create(name).await?;
    file.write_all(b&quot;hello world!&quot;).await?;

    Ok(())
}
</code></pre></pre>
<ol>
<li>é¦–å…ˆå®ƒåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åå¾€è¿™ä¸ªæ–‡ä»¶é‡Œå†™å…¥ â€œhello world!â€ã€‚</li>
<li>è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ª awaitï¼Œåˆ›å»ºæ–‡ä»¶çš„æ—¶å€™ä¼šå¼‚æ­¥åˆ›å»ºï¼Œå†™å…¥æ–‡ä»¶çš„æ—¶å€™ä¼šå¼‚æ­¥å†™å…¥ã€‚</li>
<li>æœ€ç»ˆï¼Œæ•´ä¸ªå‡½æ•°å¯¹å¤–è¿”å›ä¸€ä¸ª Futureã€‚</li>
</ol>
<blockquote>
<p>å…¶å®ƒäººå¯ä»¥è¿™æ ·è°ƒç”¨ï¼š</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust  editable">
write_hello_file_async(&quot;/tmp/hello&quot;).await?;
</code></pre></pre>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œexecutor å¤„ç† Future æ—¶ï¼Œä¼šä¸æ–­åœ°è°ƒç”¨å®ƒçš„ poll() æ–¹æ³•ï¼Œäºæ˜¯ï¼Œä¸Šé¢é‚£å¥å®é™…ä¸Šç›¸å½“äºï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
match write_hello_file_async.poll(cx) {
    Poll::Ready(result) =&gt; return result,
    Poll::Pending =&gt; return Poll::Pending
}
</code></pre></pre>
<p>è¿™æ˜¯å•ä¸ª await çš„å¤„ç†æ–¹æ³•ï¼Œé‚£æ›´åŠ å¤æ‚çš„ï¼Œä¸€ä¸ªå‡½æ•°ä¸­æœ‰è‹¥å¹²ä¸ª awaitï¼Œè¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>
<p>ä»¥å‰é¢write_hello_file_async å‡½æ•°çš„å†…éƒ¨å®ç°ä¸ºä¾‹ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬åªæœ‰åœ¨å¤„ç†å®Œ create()ï¼Œæ‰èƒ½å¤„ç† write_all()ï¼Œæ‰€ä»¥ï¼Œåº”è¯¥æ˜¯ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let fut = fs::File::create(name);
match fut.poll(cx) {
    Poll::Ready(Ok(file)) =&gt; {
        let fut = file.write_all(b&quot;hello world!&quot;);
        match fut.poll(cx) {
            Poll::Ready(result) =&gt; return result,
            Poll::Pending =&gt; return Poll::Pending,
        }
    }
    Poll::Pending =&gt; return Poll::Pending,
}
</code></pre></pre>
<blockquote>
<p>ä½†æ˜¯ï¼Œå‰é¢è¯´è¿‡ï¼Œasync å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª Futureï¼Œæ‰€ä»¥ï¼Œè¿˜éœ€è¦æŠŠè¿™æ ·çš„ä»£ç å°è£…åœ¨ä¸€ä¸ª Future çš„å®ç°é‡Œï¼Œå¯¹å¤–æä¾›å‡ºå»ã€‚</p>
</blockquote>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒæŠŠå†…éƒ¨çš„çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸ºè¿™ä¸ªæ•°æ®ç»“æ„å®ç° Futureã€‚æ¯”å¦‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
enum WriteHelloFile {
    // åˆå§‹é˜¶æ®µï¼Œç”¨æˆ·æä¾›æ–‡ä»¶å
    Init(String),
    // ç­‰å¾…æ–‡ä»¶åˆ›å»ºï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨
    // è¿™æ˜¯ä¼ªä»£ç ï¼Œimpl Future ä¸èƒ½ç”¨åœ¨è¿™é‡Œ
    AwaitingCreate(impl Future&lt;Output = Result&lt;fs::File, std::io::Error&gt;&gt;),
    // ç­‰å¾…æ–‡ä»¶å†™å…¥ï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨
    AwaitingWrite(impl Future&lt;Output = Result&lt;(), std::io::Error&gt;&gt;),
    // Future å¤„ç†å®Œæ¯•
    Done,
}

impl WriteHelloFile {
    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {
        Self::Init(name.into())
    }
}

impl Future for WriteHelloFile {
    type Output = Result&lt;(), std::io::Error&gt;;

    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
        todo!()
    }
}

fn write_hello_file_async(name: &amp;str) -&gt; WriteHelloFile {
    WriteHelloFile::new(name)
}
</code></pre></pre>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æŠŠåˆšæ‰çš„ write_hello_file_async å¼‚æ­¥å‡½æ•°ï¼Œè½¬åŒ–æˆäº†ä¸€ä¸ªè¿”å› WriteHelloFile Future çš„å‡½æ•°ã€‚</p>
<p>æ¥çœ‹è¿™ä¸ª Future å¦‚ä½•å®ç°ï¼ˆè¯¦ç»†æ³¨é‡Šäº†ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
impl Future for WriteHelloFile {
    type Output = Result&lt;(), std::io::Error&gt;;

    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
        let this = self.get_mut();
        loop {
            match this {
                // å¦‚æœçŠ¶æ€æ˜¯ Initï¼Œé‚£ä¹ˆå°±ç”Ÿæˆ create Futureï¼ŒæŠŠçŠ¶æ€åˆ‡æ¢åˆ° AwaitingCreate
                WriteHelloFile::Init(name) =&gt; {
                    let fut = fs::File::create(name);
                    *self = WriteHelloFile::AwaitingCreate(fut);
                }
                // å¦‚æœçŠ¶æ€æ˜¯ AwaitingCreateï¼Œé‚£ä¹ˆ poll create Future
                // å¦‚æœè¿”å› Poll::Ready(Ok(_))ï¼Œé‚£ä¹ˆåˆ›å»º write Future
                // å¹¶æŠŠçŠ¶æ€åˆ‡æ¢åˆ° Awaiting
                WriteHelloFile::AwaitingCreate(fut) =&gt; match fut.poll(cx) {
                    Poll::Ready(Ok(file)) =&gt; {
                        let fut = file.write_all(b&quot;hello world!&quot;);
                        *self = WriteHelloFile::AwaitingWrite(fut);
                    }
                    Poll::Ready(Err(e)) =&gt; return Poll::Ready(Err(e)),
                    Poll::Pending =&gt; return Poll::Pending,
                },
                // å¦‚æœçŠ¶æ€æ˜¯ AwaitingWriteï¼Œé‚£ä¹ˆ poll write Future
                // å¦‚æœè¿”å› Poll::Ready(_)ï¼Œé‚£ä¹ˆçŠ¶æ€åˆ‡æ¢åˆ° Doneï¼Œæ•´ä¸ª Future æ‰§è¡ŒæˆåŠŸ
                WriteHelloFile::AwaitingWrite(fut) =&gt; match fut.poll(cx) {
                    Poll::Ready(result) =&gt; {
                        *self = WriteHelloFile::Done;
                        return Poll::Ready(result);
                    }
                    Poll::Pending =&gt; return Poll::Pending,
                },
                // æ•´ä¸ª Future å·²ç»æ‰§è¡Œå®Œæ¯•
                WriteHelloFile::Done =&gt; return Poll::Ready(Ok(())),
            }
        }
    }
}
</code></pre></pre>
<blockquote>
<p>è¿™ä¸ª Future å®Œæ•´å®ç°çš„å†…éƒ¨ç»“æ„ ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºçš„è¿ç§»ã€‚</p>
</blockquote>
<p>è¿™æ®µï¼ˆä¼ªï¼‰ä»£ç å’Œä¹‹å‰å¼‚æ­¥å‡½æ•°æ˜¯ç­‰ä»·çš„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
async fn write_hello_file_async(name: &amp;str) -&gt; anyhow::Result&lt;()&gt; {
    let mut file = fs::File::create(name).await?;
    file.write_all(b&quot;hello world!&quot;).await?;

    Ok(())
}
</code></pre></pre>
<blockquote>
<p>Rust åœ¨ç¼–è¯‘ async fn æˆ–è€… async block æ—¶ï¼Œå°±ä¼šç”Ÿæˆç±»ä¼¼çš„çŠ¶æ€æœºçš„å®ç°ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œçœ‹ä¼¼ç®€å•çš„å¼‚æ­¥å¤„ç†ï¼Œå†…éƒ¨éšè—äº†ä¸€å¥—å¹¶ä¸éš¾ç†è§£ã€ä½†æ˜¯å†™èµ·æ¥å¾ˆç”Ÿç¡¬å¾ˆå•°å—¦çš„çŠ¶æ€æœºç®¡ç†ä»£ç ã€‚</p>
</blockquote>
</div>
</details>
<p>å¥½ææ˜ç™½è¿™ä¸ªé—®é¢˜ï¼Œå›åˆ° pin ã€‚åˆšæ‰æˆ‘ä»¬æ‰‹å†™çŠ¶æ€æœºä»£ç çš„è¿‡ç¨‹ï¼Œèƒ½å¸®ä½ ç†è§£ä¸ºä»€ä¹ˆä¼šéœ€è¦ Pin è¿™ä¸ªé—®é¢˜ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦-pin"><a class="header" href="#ä¸ºä»€ä¹ˆéœ€è¦-pin">ä¸ºä»€ä¹ˆéœ€è¦ Pinï¼Ÿ</a></h3>
<details id="admonition-ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šå‡ºç°è‡ªå¼•ç”¨æ•°æ®ç»“æ„æœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦pinè§£å†³" class="admonition info">
<summary class="admonition-title">
<p>ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šå‡ºç°è‡ªå¼•ç”¨æ•°æ®ç»“æ„ï¼Ÿæœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦pinè§£å†³ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šå‡ºç°è‡ªå¼•ç”¨æ•°æ®ç»“æ„æœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦pinè§£å†³"></a></p>
</summary>
<div>
<p>åœ¨ä¸Šé¢å®ç° Future çš„çŠ¶æ€æœºä¸­ï¼Œæˆ‘ä»¬å¼•ç”¨äº† file è¿™æ ·ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
WriteHelloFile::AwaitingCreate(fut) =&gt; match fut.poll(cx) {
    Poll::Ready(Ok(file)) =&gt; {
        let fut = file.write_all(b&quot;hello world!&quot;);
        *self = WriteHelloFile::AwaitingWrite(fut);
    }
    Poll::Ready(Err(e)) =&gt; return Poll::Ready(Err(e)),
    Poll::Pending =&gt; return Poll::Pending,
}
</code></pre></pre>
<p>è¿™ä¸ªä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œfile è¢« fut å¼•ç”¨ï¼Œä½† file ä¼šåœ¨è¿™ä¸ªä½œç”¨åŸŸè¢«ä¸¢å¼ƒã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä¿å­˜åœ¨æ•°æ®ç»“æ„ä¸­ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
enum WriteHelloFile {
    // åˆå§‹é˜¶æ®µï¼Œç”¨æˆ·æä¾›æ–‡ä»¶å
    Init(String),
    // ç­‰å¾…æ–‡ä»¶åˆ›å»ºï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨
    AwaitingCreate(impl Future&lt;Output = Result&lt;fs::File, std::io::Error&gt;&gt;),
    // ç­‰å¾…æ–‡ä»¶å†™å…¥ï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ Future ä»¥ä¾¿å¤šæ¬¡è°ƒç”¨
    AwaitingWrite(AwaitingWriteData),
    // Future å¤„ç†å®Œæ¯•
    Done,
}

struct AwaitingWriteData {
    fut: impl Future&lt;Output = Result&lt;(), std::io::Error&gt;&gt;,
    file: fs::File,
}
</code></pre></pre>
<ol>
<li>å¯ä»¥ç”Ÿæˆä¸€ä¸ª AwaitingWriteData æ•°æ®ç»“æ„ï¼ŒæŠŠ file å’Œ fut éƒ½æ”¾è¿›å»</li>
<li>ç„¶ååœ¨ WriteHelloFile ä¸­å¼•ç”¨å®ƒã€‚</li>
<li>æ­¤æ—¶ï¼Œåœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„å†…éƒ¨ï¼Œfut æŒ‡å‘äº†å¯¹ file çš„å¼•ç”¨ï¼Œè¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œå«è‡ªå¼•ç”¨ç»“æ„ï¼ˆSelf-Referential Structureï¼‰ã€‚</li>
</ol>
<blockquote>
<p>è‡ªå¼•ç”¨ç»“æ„æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜æ˜¯ï¼šä¸€æ—¦å®ƒè¢«ç§»åŠ¨ï¼ŒåŸæœ¬çš„æŒ‡é’ˆå°±ä¼šæŒ‡å‘æ—§çš„åœ°å€ã€‚</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961729.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<p>æ‰€ä»¥éœ€è¦æœ‰æŸç§æœºåˆ¶æ¥ä¿è¯è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿã€‚</p>
<p>Pin å°±æ˜¯ä¸ºè¿™ä¸ªç›®çš„è€Œè®¾è®¡çš„ä¸€ä¸ªæ•°æ®ç»“æ„: æˆ‘ä»¬å¯ä»¥ Pin ä½æŒ‡å‘ä¸€ä¸ª Future çš„æŒ‡é’ˆ</p>
<p>çœ‹æ–‡ç¨¿ä¸­ Pin çš„å£°æ˜ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct Pin&lt;P&gt; {
    pointer: P,
}

impl&lt;P: Deref&gt; Deref for Pin&lt;P&gt; {
    type Target = P::Target;
    fn deref(&amp;self) -&gt; &amp;P::Target {
        Pin::get_ref(Pin::as_ref(self))
    }
}

impl&lt;P: DerefMut&lt;Target: Unpin&gt;&gt; DerefMut for Pin&lt;P&gt; {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut P::Target {
        Pin::get_mut(Pin::as_mut(self))
    }
}
</code></pre></pre>
<ol>
<li>Pin æ‹¿ä½çš„æ˜¯ä¸€ä¸ªå¯ä»¥è§£å¼•ç”¨æˆ T çš„æŒ‡é’ˆç±»å‹ Pï¼Œè€Œä¸æ˜¯ç›´æ¥æ‹¿åŸæœ¬çš„ç±»å‹ Tã€‚</li>
<li>æ‰€ä»¥ï¼Œå¯¹äº Pin è€Œè¨€ï¼Œä½ çœ‹åˆ°çš„éƒ½æ˜¯ Pin&lt;Box<T>&gt;ã€Pin&lt;&amp;mut T&gt;ï¼Œä½†ä¸ä¼šæ˜¯ Pin<T>ã€‚</li>
<li>å› ä¸º Pin çš„ç›®çš„æ˜¯ï¼ŒæŠŠ T çš„å†…å­˜ä½ç½®é”ä½ï¼Œä»è€Œé¿å…ç§»åŠ¨åè‡ªå¼•ç”¨ç±»å‹å¸¦æ¥çš„å¼•ç”¨å¤±æ•ˆé—®é¢˜ã€‚</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961721.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<p>è¿™æ ·æ•°æ®ç»“æ„å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œä½†æ˜¯ä½ æ— æ³•ç›´æ¥æ‹¿åˆ°åŸæ¥çš„æ•°æ®ç»“æ„è¿›è€Œç§»åŠ¨å®ƒã€‚</p>
</div>
</details>
<h3 id="è‡ªå¼•ç”¨æ•°æ®ç»“æ„"><a class="header" href="#è‡ªå¼•ç”¨æ•°æ®ç»“æ„">è‡ªå¼•ç”¨æ•°æ®ç»“æ„</a></h3>
<details id="admonition-ä¸¾ä¾‹è¯´æ˜è‡ªå¼•ç”¨ç±»å‹å­˜åœ¨ä»€ä¹ˆæ½œåœ¨å±å®³" class="admonition bug">
<summary class="admonition-title">
<p>ä¸¾ä¾‹è¯´æ˜è‡ªå¼•ç”¨ç±»å‹å­˜åœ¨ä»€ä¹ˆæ½œåœ¨å±å®³</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä¸¾ä¾‹è¯´æ˜è‡ªå¼•ç”¨ç±»å‹å­˜åœ¨ä»€ä¹ˆæ½œåœ¨å±å®³"></a></p>
</summary>
<div>
<p>å½“ç„¶ï¼Œè‡ªå¼•ç”¨æ•°æ®ç»“æ„å¹¶éåªåœ¨å¼‚æ­¥ä»£ç é‡Œå‡ºç°ï¼Œåªä¸è¿‡å¼‚æ­¥ä»£ç åœ¨å†…éƒ¨ç”Ÿæˆç”¨çŠ¶æ€æœºè¡¨è¿°çš„ Future æ—¶ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿè‡ªå¼•ç”¨ç»“æ„ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸ªå’Œ Future æ— å…³çš„ä¾‹å­ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#[derive(Debug)]
struct SelfReference {
    name: String,
    // åœ¨åˆå§‹åŒ–åæŒ‡å‘ name
    name_ptr: *const String,
}

impl SelfReference {
    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {
        SelfReference {
            name: name.into(),
            name_ptr: std::ptr::null(),
        }
    }

    pub fn init(&amp;mut self) {
        self.name_ptr = &amp;self.name as *const String;
    }

    pub fn print_name(&amp;self) {
        println!(
            &quot;struct {:p}: (name: {:p} name_ptr: {:p}), name: {}, name_ref: {}&quot;,
            self,
            &amp;self.name,
            self.name_ptr,
            self.name,
            // åœ¨ä½¿ç”¨ ptr æ˜¯éœ€è¦ unsafe
            // SAFETY: è¿™é‡Œ name_ptr æ½œåœ¨ä¸å®‰å…¨ï¼Œä¼šæŒ‡å‘æ—§çš„ä½ç½®
            unsafe { &amp;*self.name_ptr },
        );
    }
}

fn main() {
    let data = move_creates_issue();
    println!(&quot;data: {:?}&quot;, data);
    // å¦‚æœæŠŠä¸‹é¢è¿™å¥æ³¨é‡Šæ‰ï¼Œç¨‹åºè¿è¡Œä¼šç›´æ¥ segment error
    // data.print_name();
    print!(&quot;\\n&quot;);
    mem_swap_creates_issue();
}

fn move_creates_issue() -&gt; SelfReference {
    let mut data = SelfReference::new(&quot;Tyr&quot;);
    data.init();

    // ä¸ moveï¼Œä¸€åˆ‡æ­£å¸¸
    data.print_name();

    let data = move_it(data);

    // move ä¹‹åï¼Œname_ref æŒ‡å‘çš„ä½ç½®æ˜¯å·²ç»å¤±æ•ˆçš„åœ°å€
    // åªä¸è¿‡ç°åœ¨ move å‰çš„åœ°å€è¿˜æ²¡è¢«å›æ”¶æŒªä½œå®ƒç”¨
    data.print_name();
    data
}

fn mem_swap_creates_issue() {
    let mut data1 = SelfReference::new(&quot;Tyr&quot;);
    data1.init();

    let mut data2 = SelfReference::new(&quot;Lindsey&quot;);
    data2.init();

    data1.print_name();
    data2.print_name();

    std::mem::swap(&amp;mut data1, &amp;mut data2);
    data1.print_name();
    data2.print_name();
}

fn move_it(data: SelfReference) -&gt; SelfReference {
    data
}
</code></pre></pre>
<ol>
<li>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªè‡ªå¼•ç”¨ç»“æ„ SelfReferenceï¼Œå®ƒé‡Œé¢çš„ name_ref æŒ‡å‘äº† nameã€‚</li>
<li>æ­£å¸¸ä½¿ç”¨å®ƒæ—¶ï¼Œæ²¡æœ‰ä»»ä½•é—®é¢˜</li>
<li>ä½†ä¸€æ—¦å¯¹è¿™ä¸ªç»“æ„åš move æ“ä½œï¼Œname_ref æŒ‡å‘çš„ä½ç½®è¿˜ä¼šæ˜¯ move å‰ name çš„åœ°å€ï¼Œè¿™å°±å¼•å‘äº†é—®é¢˜ã€‚çœ‹ä¸‹å›¾ï¼š</li>
</ol>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961711.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<p>åŒæ ·çš„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ std::mem:swapï¼Œä¹Ÿä¼šå‡ºç°ç±»ä¼¼çš„é—®é¢˜ï¼Œä¸€æ—¦ swapï¼Œä¸¤ä¸ªæ•°æ®çš„å†…å®¹äº¤æ¢ï¼Œç„¶è€Œï¼Œç”±äº name_ref æŒ‡å‘çš„åœ°å€è¿˜æ˜¯æ—§çš„ï¼Œæ‰€ä»¥æ•´ä¸ªæŒ‡é’ˆä½“ç³»éƒ½æ··ä¹±äº†ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961697.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<p>çœ‹ä»£ç çš„è¾“å‡ºï¼Œè¾…åŠ©ä½ ç†è§£ï¼š</p>
<pre><code class="language-shell">
struct 0x7ffeea91d6e8: (name: 0x7ffeea91d6e8 name_ptr: 0x7ffeea91d6e8), name: Tyr, name_ref: Tyr
struct 0x7ffeea91d760: (name: 0x7ffeea91d760 name_ptr: 0x7ffeea91d6e8), name: Tyr, name_ref: Tyr
data: SelfReference { name: &quot;Tyr&quot;, name_ptr: 0x7ffeea91d6e8 }

struct 0x7ffeea91d6f0: (name: 0x7ffeea91d6f0 name_ptr: 0x7ffeea91d6f0), name: Tyr, name_ref: Tyr
struct 0x7ffeea91d710: (name: 0x7ffeea91d710 name_ptr: 0x7ffeea91d710), name: Lindsey, name_ref: Lindsey
struct 0x7ffeea91d6f0: (name: 0x7ffeea91d6f0 name_ptr: 0x7ffeea91d710), name: Lindsey, name_ref: Tyr
struct 0x7ffeea91d710: (name: 0x7ffeea91d710 name_ptr: 0x7ffeea91d6f0), name: Tyr, name_ref: Lindsey
</code></pre>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°ï¼Œswap ä¹‹åï¼Œname_ref æŒ‡å‘çš„å†…å®¹ç¡®å®å’Œ name ä¸ä¸€æ ·äº†ã€‚è¿™å°±æ˜¯è‡ªå¼•ç”¨ç»“æ„å¸¦æ¥çš„é—®é¢˜ã€‚</p>
</blockquote>
<p>ä½ ä¹Ÿè®¸ä¼šå¥‡æ€ªï¼Œä¸æ˜¯è¯´ move ä¹Ÿä¼šå‡ºé—®é¢˜ä¹ˆï¼Ÿä¸ºä»€ä¹ˆç¬¬äºŒè¡Œæ‰“å° name_ref è¿˜æ˜¯æŒ‡å‘äº† â€œTyrâ€ï¼Ÿ</p>
<p>è¿™æ˜¯å› ä¸º move åï¼Œä¹‹å‰çš„å†…å­˜å¤±æ•ˆï¼Œä½†æ˜¯å†…å­˜åœ°å€è¿˜æ²¡æœ‰è¢«æŒªä½œå®ƒç”¨ï¼Œæ‰€ä»¥è¿˜èƒ½æ­£å¸¸æ˜¾ç¤º â€œTyrâ€ã€‚ä½†è¿™æ ·çš„å†…å­˜è®¿é—®æ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æœä½ æŠŠ main ä¸­è¿™å¥ä»£ç æ³¨é‡Šæ‰ï¼Œç¨‹åºå°±ä¼š crashï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let data = move_creates_issue();
    println!(&quot;data: {:?}&quot;, data);
    // å¦‚æœæŠŠä¸‹é¢è¿™å¥æ³¨é‡Šæ‰ï¼Œç¨‹åºè¿è¡Œä¼šç›´æ¥ segment error
    // data.print_name();
    print!(&quot;\\n&quot;);
    mem_swap_creates_issue();
}
</code></pre></pre>
<blockquote>
<p>ç°åœ¨ä½ åº”è¯¥äº†è§£åˆ°åœ¨ Rust ä¸‹ï¼Œè‡ªå¼•ç”¨ç±»å‹å¸¦æ¥çš„æ½œåœ¨å±å®³äº†å§ã€‚</p>
</blockquote>
</div>
</details>
<details id="admonition-ä½¿ç”¨pinä¹‹åå¦‚ä½•è§£å†³é—®é¢˜" class="admonition info">
<summary class="admonition-title">
<p>ä½¿ç”¨pinä¹‹åå¦‚ä½•è§£å†³é—®é¢˜</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-ä½¿ç”¨pinä¹‹åå¦‚ä½•è§£å†³é—®é¢˜"></a></p>
</summary>
<div>
<p>æ‰€ä»¥ï¼ŒPin çš„å‡ºç°ï¼Œå¯¹è§£å†³è¿™ç±»é—®é¢˜å¾ˆå…³é”®ï¼Œå¦‚æœä½ è¯•å›¾ç§»åŠ¨è¢« Pin ä½çš„æ•°æ®ç»“æ„:</p>
<ul>
<li>è¦ä¹ˆï¼Œç¼–è¯‘å™¨ä¼šé€šè¿‡ç¼–è¯‘é”™è¯¯é˜»æ­¢ä½ ï¼›</li>
<li>è¦ä¹ˆï¼Œä½ å¼ºè¡Œä½¿ç”¨ unsafe Rustï¼Œè‡ªå·±è´Ÿè´£å…¶å®‰å…¨æ€§ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ä½¿ç”¨ Pin åå¦‚ä½•é¿å…ç§»åŠ¨å¸¦æ¥çš„é—®é¢˜ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::{marker::PhantomPinned, pin::Pin};

#[derive(Debug)]
struct SelfReference {
    name: String,
    // åœ¨åˆå§‹åŒ–åæŒ‡å‘ name
    name_ptr: *const String,
    // PhantomPinned å ä½ç¬¦
    _marker: PhantomPinned,
}

impl SelfReference {
    pub fn new(name: impl Into&lt;String&gt;) -&gt; Self {
        SelfReference {
            name: name.into(),
            name_ptr: std::ptr::null(),
            _marker: PhantomPinned,
        }
    }

    pub fn init(self: Pin&lt;&amp;mut Self&gt;) {
        let name_ptr = &amp;self.name as *const String;
        // SAFETY: è¿™é‡Œå¹¶ä¸ä¼šæŠŠä»»ä½•æ•°æ®ä» &amp;mut SelfReference ä¸­ç§»èµ°
        let this = unsafe { self.get_unchecked_mut() };
        this.name_ptr = name_ptr;
    }

    pub fn print_name(self: Pin&lt;&amp;Self&gt;) {
        println!(
            &quot;struct {:p}: (name: {:p} name_ptr: {:p}), name: {}, name_ref: {}&quot;,
            self,
            &amp;self.name,
            self.name_ptr,
            self.name,
            // åœ¨ä½¿ç”¨ ptr æ˜¯éœ€è¦ unsafe
            // SAFETY: å› ä¸ºæ•°æ®ä¸ä¼šç§»åŠ¨ï¼Œæ‰€ä»¥è¿™é‡Œ name_ptr æ˜¯å®‰å…¨çš„
            unsafe { &amp;*self.name_ptr },
        );
    }
}

fn main() {
    move_creates_issue();
}

fn move_creates_issue() {
    let mut data = SelfReference::new(&quot;Tyr&quot;);
    let mut data = unsafe { Pin::new_unchecked(&amp;mut data) };
    SelfReference::init(data.as_mut());

    // ä¸ moveï¼Œä¸€åˆ‡æ­£å¸¸
    data.as_ref().print_name();

    // ç°åœ¨åªèƒ½æ‹¿åˆ° pinned åçš„æ•°æ®ï¼Œæ‰€ä»¥ move ä¸äº†ä¹‹å‰
    move_pinned(data.as_mut());
    println!(&quot;{:?} ({:p})&quot;, data, &amp;data);

    // ä½ æ— æ³•æ‹¿å› Pin ä¹‹å‰çš„ SelfReference ç»“æ„ï¼Œæ‰€ä»¥è°ƒç”¨ä¸äº† move_it
    // move_it(data);
}

fn move_pinned(data: Pin&lt;&amp;mut SelfReference&gt;) {
    println!(&quot;{:?} ({:p})&quot;, data, &amp;data);
}

#[allow(dead_code)]
fn move_it(data: SelfReference) {
    println!(&quot;{:?} ({:p})&quot;, data, &amp;data);
}
</code></pre></pre>
<p>ç”±äºæ•°æ®ç»“æ„è¢«åŒ…è£¹åœ¨ Pin å†…éƒ¨ï¼Œæ‰€ä»¥åœ¨å‡½æ•°é—´ä¼ é€’æ—¶ï¼Œå˜åŒ–çš„åªæ˜¯æŒ‡å‘ data çš„ Pinï¼š</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F-4961106.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
</div>
</details>
<h3 id="unpin"><a class="header" href="#unpin">Unpin</a></h3>
<details id="admonition-äº†è§£pinçš„ä½œç”¨åunpinæœ‰ä»€ä¹ˆç”¨" class="admonition info">
<summary class="admonition-title">
<p>äº†è§£pinçš„ä½œç”¨åï¼ŒUnpinæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-äº†è§£pinçš„ä½œç”¨åunpinæœ‰ä»€ä¹ˆç”¨"></a></p>
</summary>
<div>
<p>å­¦ä¹ äº† Pinï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æƒ³èµ· Unpin ã€‚</p>
<p>é‚£ä¹ˆï¼ŒUnpin æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</p>
<p>Pin æ˜¯ä¸ºäº†è®©æŸä¸ªæ•°æ®ç»“æ„æ— æ³•åˆæ³•åœ°ç§»åŠ¨ï¼Œè€Œ Unpin åˆ™ç›¸å½“äºå£°æ˜æ•°æ®ç»“æ„æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼Œå®ƒçš„ä½œç”¨ç±»ä¼¼äº Send / Syncï¼Œé€šè¿‡ç±»å‹çº¦æŸæ¥å‘Šè¯‰ç¼–è¯‘å™¨å“ªäº›è¡Œä¸ºæ˜¯åˆæ³•çš„ã€å“ªäº›ä¸æ˜¯ã€‚</p>
<p>åœ¨ Rust ä¸­ï¼Œç»å¤§å¤šæ•°æ•°æ®ç»“æ„éƒ½æ˜¯å¯ä»¥ç§»åŠ¨çš„ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½è‡ªåŠ¨å®ç°äº† <a href="https://doc.rust-lang.org/std/marker/trait.Unpin.html">Unpin</a>ã€‚</p>
<p>å³ä¾¿è¿™äº›ç»“æ„è¢« Pin åŒ…è£¹ï¼Œå®ƒä»¬ä¾æ—§å¯ä»¥è¿›è¡Œç§»åŠ¨ï¼Œæ¯”å¦‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
use std::mem;
use std::pin::Pin;

let mut string = &quot;this&quot;.to_string();
let mut pinned_string = Pin::new(&amp;mut string);

// We need a mutable reference to call `mem::replace`.
// We can obtain such a reference by (implicitly) invoking `Pin::deref_mut`,
// but that is only possible because `String` implements `Unpin`.
mem::replace(&amp;mut *pinned_string, &quot;other&quot;.to_string());
</code></pre></pre>
<p>å½“æˆ‘ä»¬ä¸å¸Œæœ›ä¸€ä¸ªæ•°æ®ç»“æ„è¢«ç§»åŠ¨ï¼Œå¯ä»¥ä½¿ç”¨ !Unpinã€‚åœ¨ Rust é‡Œï¼Œå®ç°äº† !Unpin çš„ï¼Œé™¤äº†å†…éƒ¨ç»“æ„ï¼ˆæ¯”å¦‚ Futureï¼‰ï¼Œä¸»è¦å°±æ˜¯ PhantomPinnedï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub struct PhantomPinned;
impl !Unpin for PhantomPinned {}
</code></pre></pre>
<p>æ‰€ä»¥ï¼Œå¦‚æœä½ å¸Œæœ›ä½ çš„æ•°æ®ç»“æ„ä¸èƒ½è¢«ç§»åŠ¨ï¼Œå¯ä»¥ä¸ºå…¶æ·»åŠ  PhantomPinned å­—æ®µæ¥éšå¼å£°æ˜ !Unpinã€‚</p>
<p>å½“æ•°æ®ç»“æ„æ»¡è¶³ Unpin æ—¶ï¼Œåˆ›å»º Pin ä»¥åŠä½¿ç”¨ Pinï¼ˆä¸»è¦æ˜¯ DerefMutï¼‰éƒ½å¯ä»¥ä½¿ç”¨å®‰å…¨æ¥å£ï¼Œå¦åˆ™ï¼Œéœ€è¦ä½¿ç”¨ unsafe æ¥å£ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
// å¦‚æœå®ç°äº† Unpinï¼Œå¯ä»¥é€šè¿‡å®‰å…¨æ¥å£åˆ›å»ºå’Œè¿›è¡Œ DerefMut
impl&lt;P: Deref&lt;Target: Unpin&gt;&gt; Pin&lt;P&gt; {
    pub const fn new(pointer: P) -&gt; Pin&lt;P&gt; {
        // SAFETY: the value pointed to is `Unpin`, and so has no requirements
        // around pinning.
        unsafe { Pin::new_unchecked(pointer) }
    }
    pub const fn into_inner(pin: Pin&lt;P&gt;) -&gt; P {
        pin.pointer
    }
}

impl&lt;P: DerefMut&lt;Target: Unpin&gt;&gt; DerefMut for Pin&lt;P&gt; {
    fn deref_mut(&amp;mut self) -&gt; &amp;mut P::Target {
        Pin::get_mut(Pin::as_mut(self))
    }
}

// å¦‚æœæ²¡æœ‰å®ç° Unpinï¼Œåªèƒ½é€šè¿‡ unsafe æ¥å£åˆ›å»ºï¼Œä¸èƒ½ä½¿ç”¨ DerefMut
impl&lt;P: Deref&gt; Pin&lt;P&gt; {
    pub const unsafe fn new_unchecked(pointer: P) -&gt; Pin&lt;P&gt; {
        Pin { pointer }
    }

    pub const unsafe fn into_inner_unchecked(pin: Pin&lt;P&gt;) -&gt; P {
        pin.pointer
    }
}
</code></pre></pre>
</div>
</details>
<h3 id="boxçš„unpinæ€è€ƒ"><a class="header" href="#boxçš„unpinæ€è€ƒ">### Box<T>çš„Unpinæ€è€ƒ</a></h3>
<details id="admonition-å¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„-t-unpinæˆ‘ä»¬ä¸ºå…¶ç”Ÿæˆ-boxé‚£ä¹ˆ-box-æ˜¯-unpin-è¿˜æ˜¯-unpin-çš„" class="admonition info">
<summary class="admonition-title">
<p>å¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„ T: !Unpinï¼Œæˆ‘ä»¬ä¸ºå…¶ç”Ÿæˆ Box<T>ï¼Œé‚£ä¹ˆ Box<T> æ˜¯ Unpin è¿˜æ˜¯ !Unpin çš„ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å¦‚æœä¸€ä¸ªæ•°æ®ç»“æ„-t-unpinæˆ‘ä»¬ä¸ºå…¶ç”Ÿæˆ-boxé‚£ä¹ˆ-box-æ˜¯-unpin-è¿˜æ˜¯-unpin-çš„"></a></p>
</summary>
<div>
<p>Box<T>æ˜¯Unpinï¼Œå› ä¸ºBox<T>å®ç°äº†Unpin trait</p>
</div>
</details>
<h3 id="async-äº§ç”Ÿçš„-future-ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹"><a class="header" href="#async-äº§ç”Ÿçš„-future-ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹">async äº§ç”Ÿçš„ Future ç©¶ç«Ÿæ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</a></h3>
<details id="admonition-rustä¸­futureæ˜¯ä¸€ä¸ªtraitasyncè¿”å›çš„æ˜¯ä¸€ä¸ªå®ç°äº†futureçš„genfutureç±»å‹è¿™é‡Œé¢‡ä¼¼pythonçš„yieldå¦‚ä½•å˜æˆåç¨‹çš„è¿‡ç¨‹" class="admonition info">
<summary class="admonition-title">
<p>Rustä¸­Futureæ˜¯ä¸€ä¸ªtraitï¼Œasyncè¿”å›çš„æ˜¯ä¸€ä¸ªå®ç°äº†Futureçš„GenFutureç±»å‹ã€‚è¿™é‡Œé¢‡ä¼¼pythonçš„yieldå¦‚ä½•å˜æˆåç¨‹çš„è¿‡ç¨‹ã€‚</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-rustä¸­futureæ˜¯ä¸€ä¸ªtraitasyncè¿”å›çš„æ˜¯ä¸€ä¸ªå®ç°äº†futureçš„genfutureç±»å‹è¿™é‡Œé¢‡ä¼¼pythonçš„yieldå¦‚ä½•å˜æˆåç¨‹çš„è¿‡ç¨‹"></a></p>
</summary>
<div>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯¹ Future çš„æ¥å£æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„è®¤è¯†ï¼Œä¹ŸçŸ¥é“ async å…³é”®å­—çš„èƒŒåéƒ½å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
pub trait Future {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}
</code></pre></pre>
<p>é‚£ä¹ˆï¼Œå½“ä½ å†™ä¸€ä¸ª async fn æˆ–è€…ä½¿ç”¨äº†ä¸€ä¸ª async block æ—¶ï¼Œç©¶ç«Ÿå¾—åˆ°äº†ä¸€ä¸ªä»€ä¹ˆç±»å‹çš„æ•°æ®å‘¢ï¼Ÿæ¯”å¦‚ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
let fut = async { 42 };
</code></pre></pre>
<p>ä½ è‚¯å®šèƒ½æ‹ç€èƒ¸è„¯è¯´ï¼Œè¿™ä¸ªæˆ‘çŸ¥é“ï¼Œä¸å°±æ˜¯ impl Future&lt;Output = i32&gt; ä¹ˆï¼Ÿ</p>
<p>å¯¹ï¼Œä½†æ˜¯ impl Future ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»å‹å•Šï¼Œæˆ‘ä»¬è®²è¿‡ï¼Œå®ƒç›¸å½“äº T: Futureï¼Œé‚£ä¹ˆè¿™ä¸ª T ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬æ¥å†™æ®µä»£ç æ¢ç´¢ä¸€ä¸‹ï¼ˆä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
fn main() {
    let fut = async { 42 };

    println!(&quot;type of fut is: {}&quot;, get_type_name(&amp;fut));
}

fn get_type_name&lt;T&gt;(_: &amp;T) -&gt; &amp;'static str {
    std::any::type_name::&lt;T&gt;()
}
</code></pre></pre>
<p>å®ƒçš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre><code class="language-shell">
type of fut is: core::future::from_generator::GenFuture&lt;xxx::main::{{closure}}&gt;
</code></pre>
<p>å®ç° Future trait çš„æ˜¯ä¸€ä¸ªå« GenFuture çš„ç»“æ„ï¼Œå®ƒå†…éƒ¨æœ‰ä¸€ä¸ªé—­åŒ…ã€‚çŒœæµ‹è¿™ä¸ªé—­åŒ…æ˜¯ async { 42 } äº§ç”Ÿçš„ï¼Ÿ</p>
<p>æˆ‘ä»¬çœ‹ GenFuture çš„å®šä¹‰ï¼ˆæ„Ÿå…´è¶£å¯ä»¥åœ¨ Rust æºç ä¸­æœ from_generatorï¼‰ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ªæ³›å‹ç»“æ„ï¼Œå†…éƒ¨æ•°æ® T è¦æ»¡è¶³ Generator traitï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
struct GenFuture&lt;T: Generator&lt;ResumeTy, Yield = ()&gt;&gt;(T);

pub trait Generator&lt;R = ()&gt; {
    type Yield;
    type Return;
    fn resume(
        self: Pin&lt;&amp;mut Self&gt;, 
        arg: R
    ) -&gt; GeneratorState&lt;Self::Yield, Self::Return&gt;;
}
</code></pre></pre>
<p><a href="https://doc.rust-lang.org/std/ops/trait.Generator.html">Generator</a> æ˜¯ Rust nightly çš„ä¸€ä¸ª traitï¼Œè¿˜æ²¡æœ‰è¿›å…¥åˆ°æ ‡å‡†åº“ã€‚å¤§è‡´çœ‹çœ‹å®˜ç½‘å±•ç¤ºçš„ä¾‹å­ï¼Œå®ƒæ˜¯æ€ä¹ˆç”¨çš„ï¼š</p>
<pre><pre class="playground"><code class="language-rust  editable">
#![feature(generators, generator_trait)]

use std::ops::{Generator, GeneratorState};
use std::pin::Pin;

fn main() {
    let mut generator = || {
        yield 1;
        return &quot;foo&quot;
    };

    match Pin::new(&amp;mut generator).resume(()) {
        GeneratorState::Yielded(1) =&gt; {}
        _ =&gt; panic!(&quot;unexpected return from resume&quot;),
    }
    match Pin::new(&amp;mut generator).resume(()) {
        GeneratorState::Complete(&quot;foo&quot;) =&gt; {}
        _ =&gt; panic!(&quot;unexpected return from resume&quot;),
    }
}
</code></pre></pre>
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä½ åˆ›å»ºä¸€ä¸ªé—­åŒ…ï¼Œé‡Œé¢æœ‰ yield å…³é”®å­—ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ª Generatorã€‚</li>
<li>å¦‚æœä½ åœ¨ Python ä¸­ä½¿ç”¨è¿‡ yieldï¼ŒäºŒè€…å…¶å®éå¸¸ç±»ä¼¼ã€‚</li>
<li>å› ä¸º Generator æ˜¯ä¸€ä¸ªè¿˜æ²¡è¿›å…¥åˆ°ç¨³å®šç‰ˆçš„åŠŸèƒ½ï¼Œå¤§è‡´äº†è§£ä¸€ä¸‹å°±è¡Œï¼Œä»¥åç­‰å®ƒçš„ API ç¨³å®šåå†ä»”ç»†ç ”ç©¶ã€‚</li>
</ol>
</div>
</details>
<h3 id="å›é¡¾æ•´ç†futureçš„contextpinunpinä»¥åŠasyncawait"><a class="header" href="#å›é¡¾æ•´ç†futureçš„contextpinunpinä»¥åŠasyncawait">å›é¡¾æ•´ç†Futureçš„Contextã€Pin/Unpinï¼Œä»¥åŠasync/await</a></h3>
<details id="admonition-å›é¡¾æ•´ç†futureçš„contextpinunpinä»¥åŠasyncawait" class="admonition info">
<summary class="admonition-title">
<p>å›é¡¾æ•´ç†Futureçš„Contextã€Pin/Unpinï¼Œä»¥åŠasync/await</p>
<p><a class="admonition-anchor-link" href="5_concurrency_async.html#admonition-å›é¡¾æ•´ç†futureçš„contextpinunpinä»¥åŠasyncawait"></a></p>
</summary>
<div>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/39%EF%BD%9C%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%EF%BC%9Aasyncawait%E5%86%85%E9%83%A8%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F.jpg" alt="39ï½œå¼‚æ­¥å¤„ç†ï¼šasyncawaitå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" /></p>
<blockquote>
<p>å¹¶å‘ä»»åŠ¡è¿è¡Œåœ¨ Future è¿™æ ·çš„åç¨‹ä¸Šæ—¶ï¼Œasync/await æ˜¯äº§ç”Ÿå’Œè¿è¡Œå¹¶å‘ä»»åŠ¡çš„æ‰‹æ®µï¼Œasync å®šä¹‰ä¸€ä¸ªå¯ä»¥å¹¶å‘æ‰§è¡Œçš„ Future ä»»åŠ¡ï¼Œawait è§¦å‘è¿™ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚å…·ä½“æ¥è¯´ï¼š</p>
</blockquote>
<ol>
<li>å½“æˆ‘ä»¬ä½¿ç”¨ async å…³é”®å­—æ—¶ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ª impl Future çš„ç»“æœã€‚</li>
<li>å¯¹äºä¸€ä¸ª async block æˆ–è€… async fn æ¥è¯´ï¼Œå†…éƒ¨çš„æ¯ä¸ª await éƒ½ä¼šè¢«ç¼–è¯‘å™¨æ•æ‰ï¼Œå¹¶æˆä¸ºè¿”å›çš„ Future çš„ poll() æ–¹æ³•çš„å†…éƒ¨çŠ¶æ€æœºçš„ä¸€ä¸ªçŠ¶æ€ã€‚</li>
<li>Rust çš„ Future éœ€è¦å¼‚æ­¥è¿è¡Œæ—¶æ¥è¿è¡Œ Future</li>
</ol>
<ul>
<li>ä»¥ tokio ä¸ºä¾‹ï¼Œå®ƒçš„ executor ä¼šä» run queue ä¸­å–å‡º Future è¿›è¡Œ poll()</li>
<li>å½“ poll() è¿”å› Pending æ—¶ï¼Œè¿™ä¸ª Future ä¼šè¢«æŒ‚èµ·</li>
<li>ç›´åˆ° reactor å¾—åˆ°äº†æŸä¸ªäº‹ä»¶ï¼Œå”¤é†’è¿™ä¸ª Futureï¼Œå°†å…¶æ·»åŠ å› run queue ç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œã€‚</li>
<li>tokio ä¸€èˆ¬ä¼šåœ¨æ¯ä¸ªç‰©ç†çº¿ç¨‹ï¼ˆæˆ–è€… CPU coreï¼‰ä¸‹è¿è¡Œä¸€ä¸ªçº¿ç¨‹</li>
<li>æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ run queue æ¥å¤„ç† Futureã€‚</li>
<li>ä¸ºäº†æä¾›æœ€å¤§çš„ååé‡ï¼Œtokio å®ç°äº† work stealing schedulerï¼Œè¿™æ ·ï¼Œå½“æŸä¸ªçº¿ç¨‹ä¸‹æ²¡æœ‰å¯æ‰§è¡Œçš„ Futureï¼Œå®ƒä¼šä»å…¶å®ƒçº¿ç¨‹çš„ run queue ä¸­â€œå·â€ä¸€ä¸ªæ‰§è¡Œã€‚</li>
</ul>
</div>
</details>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vi-æ··åˆç¼–ç¨‹"><a class="header" href="#vi-æ··åˆç¼–ç¨‹">VI æ··åˆç¼–ç¨‹</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kv-serverè®¾è®¡ä¸å®ç°"><a class="header" href="#kv-serverè®¾è®¡ä¸å®ç°">KV Serverè®¾è®¡ä¸å®ç°</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥webæ¡†æ¶"><a class="header" href="#æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥webæ¡†æ¶">æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="checklist"><a class="header" href="#checklist">Checklist</a></h1>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->


                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">

    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

        <script type="text/javascript">
            window.addEventListener('load', function () {
                MathJax.Hub.Register.StartupHook('End', function () {
                    window.setTimeout(window.print, 100);
                });
            });
        </script>
</body>
</html>
