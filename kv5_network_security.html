<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js rust">
<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>ç½‘ç»œå®‰å…¨ - Anatomy In First Rust Programming Class ğŸ¦€</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="ä»¥rustç¼–ç¨‹ç¬¬ä¸€è¯¾çš„ä»£ç ä¸ºä¾‹è¿›è¡ŒåŸºç¡€ä»£ç åˆ†æ">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff"/>

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="md-favicon.png">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="highlight.css">
    <link rel="stylesheet" href="tomorrow-night.css">
    <link rel="stylesheet" href="ayu-highlight.css">

    <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="assets/pagetoc/pagetoc_style.css">
        <link rel="stylesheet" href="assets/css/mdbook-admonish.css">

        <!-- MathJax -->
        <script async type="text/javascript"
                src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<!-- Provide site root to javascript -->
<script type="text/javascript">
    var path_to_root = "";
    var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
</script>

<!-- Work around some values being stored in localStorage wrapped in quotes -->
<script type="text/javascript">
    try {
        var theme = localStorage.getItem('mdbook-theme');
        var sidebar = localStorage.getItem('mdbook-sidebar');

        if (theme.startsWith('"') && theme.endsWith('"')) {
            localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
        }

        if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
            localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
        }
    } catch (e) {
    }
</script>

<!-- Set the theme before any content is loaded, prevents flash -->
<script type="text/javascript">
    var theme;
    try {
        theme = localStorage.getItem('mdbook-theme');
    } catch (e) {
    }
    if (theme === null || theme === undefined) {
        theme = default_theme;
    }
    var html = document.querySelector('html');
    html.classList.remove('no-js')
    html.classList.remove('rust')
    html.classList.add(theme);
    html.classList.add('js');
</script>

<!-- Hide / unhide sidebar before it is displayed -->
<script type="text/javascript">
    var html = document.querySelector('html');
    var sidebar = 'hidden';
    if (document.body.clientWidth >= 1080) {
        try {
            sidebar = localStorage.getItem('mdbook-sidebar');
        } catch (e) {
        }
        sidebar = sidebar || 'visible';
    }
    html.classList.remove('sidebar-visible');
    html.classList.add("sidebar-" + sidebar);
</script>

<nav id="sidebar" class="sidebar" aria-label="Table of contents">
    <div class="sidebar-scrollbox">
        <ol class="chapter"><li class="chapter-item expanded "><a href="anatomy_logic.html"><strong aria-hidden="true">1.</strong> æºç é˜…è¯»é€»è¾‘</a></li><li class="chapter-item expanded "><a href="intro_gdb_lldb.html"><strong aria-hidden="true">2.</strong> gdb/lldbè°ƒè¯•æˆ–æŸ¥çœ‹å†…å­˜ç»“æ„</a></li><li class="chapter-item expanded "><a href="get_hands_dirty.html"><strong aria-hidden="true">3.</strong> get hands dirty</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="httpie.html"><strong aria-hidden="true">3.1.</strong> httpie</a></li><li class="chapter-item expanded "><a href="rgrep.html"><strong aria-hidden="true">3.2.</strong> rgrep</a></li><li class="chapter-item expanded "><a href="thumbor.html"><strong aria-hidden="true">3.3.</strong> thumbor</a></li><li class="chapter-item expanded "><a href="queryer.html"><strong aria-hidden="true">3.4.</strong> queryer</a></li></ol></li><li class="chapter-item expanded "><a href="rust_cores.html"><strong aria-hidden="true">4.</strong> Rustæ ¸å¿ƒæ·±å…¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="1_stack_heap_ownership_lifetime_memory.html"><strong aria-hidden="true">4.1.</strong> I. ä»æ ˆå †ã€æ‰€æœ‰æƒã€ç”Ÿå‘½å‘¨æœŸå¼€å§‹å†…å­˜ç®¡ç†</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="1_1_stack_heap.html"><strong aria-hidden="true">4.1.1.</strong> ä»å †æ ˆå¼€å§‹</a></li><li class="chapter-item "><a href="1_2_programming_basic_concepts.html"><strong aria-hidden="true">4.1.2.</strong> å››å¤§ç¼–ç¨‹åŸºç¡€æ¦‚å¿µ</a></li><li class="chapter-item "><a href="1_3_ownership.html"><strong aria-hidden="true">4.1.3.</strong> æ‰€æœ‰æƒ</a></li><li class="chapter-item "><a href="1_4_lifetime.html"><strong aria-hidden="true">4.1.4.</strong> ç”Ÿå‘½å‘¨æœŸ</a></li><li class="chapter-item "><a href="1_5_go_through.html"><strong aria-hidden="true">4.1.5.</strong> ä»åˆ›å»ºåˆ°æ¶ˆäº¡</a></li></ol></li><li class="chapter-item expanded "><a href="2_type_system.html"><strong aria-hidden="true">4.2.</strong> II. ç±»å‹ç³»ç»Ÿ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_1_type_details.html"><strong aria-hidden="true">4.2.1.</strong> ç±»å‹ç³»ç»Ÿç‰¹ç‚¹</a></li><li class="chapter-item "><a href="2_2_generic.html"><strong aria-hidden="true">4.2.2.</strong> æ³›å‹</a></li><li class="chapter-item "><a href="2_3_trait.html"><strong aria-hidden="true">4.2.3.</strong> trait</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="2_3_0_trait_overview.html"><strong aria-hidden="true">4.2.3.1.</strong> traitæ¦‚è§ˆ</a></li><li class="chapter-item "><a href="2_3_1_trait_impl.html"><strong aria-hidden="true">4.2.3.2.</strong> Trait Impl</a></li><li class="chapter-item "><a href="2_3_2_trait_object.html"><strong aria-hidden="true">4.2.3.3.</strong> Trait Object</a></li><li class="chapter-item "><a href="2_3_3_trait_frequently.html"><strong aria-hidden="true">4.2.3.4.</strong> å¸¸ç”¨trait</a></li><li class="chapter-item "><a href="2_3_4_trait_design.html"><strong aria-hidden="true">4.2.3.5.</strong> Traitè®¾è®¡</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="3_data_structure.html"><strong aria-hidden="true">4.3.</strong> III. æ•°æ®ç»“æ„</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="3_1_smart_pointer.html"><strong aria-hidden="true">4.3.1.</strong> æ™ºèƒ½æŒ‡é’ˆ</a></li><li class="chapter-item "><a href="3_2_containers.html"><strong aria-hidden="true">4.3.2.</strong> é›†åˆå®¹å™¨</a></li><li class="chapter-item "><a href="3_3_error_handling.html"><strong aria-hidden="true">4.3.3.</strong> é”™è¯¯å¤„ç†</a></li><li class="chapter-item "><a href="3_4_closure.html"><strong aria-hidden="true">4.3.4.</strong> é—­åŒ…</a></li></ol></li><li class="chapter-item expanded "><a href="4_macros.html"><strong aria-hidden="true">4.4.</strong> IV. å®ç¼–ç¨‹</a></li><li class="chapter-item expanded "><a href="5_concurrency_async.html"><strong aria-hidden="true">4.5.</strong> V. å¹¶å‘ä¸å¼‚æ­¥</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="5_1_concurrency_primitives.html"><strong aria-hidden="true">4.5.1.</strong> å¹¶å‘åŸè¯­(Concurrency Primitives)</a></li><li class="chapter-item "><a href="5_2_future_async_await.html"><strong aria-hidden="true">4.5.2.</strong> å¼‚æ­¥ï¼šFuture/Async/Await</a></li><li class="chapter-item "><a href="5_3_deepin_async_await.html"><strong aria-hidden="true">4.5.3.</strong> æ·±å…¥async/await</a></li></ol></li><li class="chapter-item expanded "><a href="6_unsafe_ffi.html"><strong aria-hidden="true">4.6.</strong> VI. æ··åˆç¼–ç¨‹</a></li></ol></li><li class="chapter-item expanded "><a href="kv_server_design.html"><strong aria-hidden="true">5.</strong> kv serverè®¾è®¡ä¸å®ç°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="kv1_basic.html"><strong aria-hidden="true">5.1.</strong> åŸºæœ¬æµç¨‹</a></li><li class="chapter-item expanded "><a href="kv2_protocols.html"><strong aria-hidden="true">5.2.</strong> å®ç°å¹¶éªŒè¯åè®®å±‚</a></li><li class="chapter-item expanded "><a href="kv3_advanced_traits.html"><strong aria-hidden="true">5.3.</strong> é«˜çº§traitæ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv4_network.html"><strong aria-hidden="true">5.4.</strong> ç½‘ç»œå¤„ç†</a></li><li class="chapter-item expanded "><a href="kv5_network_security.html" class="active"><strong aria-hidden="true">5.5.</strong> ç½‘ç»œå®‰å…¨</a></li><li class="chapter-item expanded "><a href="kv6_async_refactor.html"><strong aria-hidden="true">5.6.</strong> å¼‚æ­¥æ”¹é€ </a></li><li class="chapter-item expanded "><a href="kv7_big_refactor.html"><strong aria-hidden="true">5.7.</strong> é‡å¤§é‡æ„</a></li><li class="chapter-item expanded "><a href="kv8_config_ci_cd.html"><strong aria-hidden="true">5.8.</strong> é…ç½®ã€æµ‹è¯•ã€ç›‘æ§ã€CI/CD</a></li></ol></li><li class="chapter-item expanded "><a href="custom_axum_async_web_framework.html"><strong aria-hidden="true">6.</strong> æ„å»ºè‡ªå·±çš„ç±»axumå¼‚æ­¥Webæ¡†æ¶</a></li><li class="chapter-item expanded affix "><a href="checklist.html">Checklist</a></li></ol>
    </div>
    <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
</nav>

<div id="page-wrapper" class="page-wrapper">

    <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
        <div id="menu-bar" class="menu-bar sticky bordered">
            <div class="left-buttons">
                <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                    <i class="fa fa-bars"></i>
                </button>
                <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                    <i class="fa fa-paint-brush"></i>
                </button>
                <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                    <li role="none">
                        <button role="menuitem" class="theme" id="light">Light</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="rust">Rust (default)</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="coal">Coal</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="navy">Navy</button>
                    </li>
                    <li role="none">
                        <button role="menuitem" class="theme" id="ayu">Ayu</button>
                    </li>
                </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
            </div>

            <h1 class="menu-title">Anatomy In First Rust Programming Class ğŸ¦€</h1>
            <h4 class="menu-bar"><a href="https://kuanhsiaokuo.github.io/think-tool-kit/">ä¿æŒæ‰¹åˆ¤ï¼Œæœ‰æ‰€å–èˆï¼ŒçŸ¥è¡Œåˆä¸€, æ–¹è§çœŸæˆ‘</a> -- ç»ƒæ­¦ä¸ç»ƒåŠŸ
                åˆ°å¤´ä¸€åœºç©º -- ã€Šèµ›åšè‹±é›„ä¼ ã€‹ </h4>
            <div class="right-buttons">
                    <a href="print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/KuanHsiaoKuo/geektime-tyr-rust.git" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-rust"></i>
                    </a>
            </div>
        </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" name="search" id="searchbar" name="searchbar"
                           placeholder="Search this book ..." aria-controls="searchresults-outer"
                           aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

        <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
        <script type="text/javascript">
            document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
            document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
            Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
            });
        </script>

        <div id="content" class="content">
            <main>

                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <h1 id="äº”ç½‘ç»œå®‰å…¨ç”Ÿæˆ-x509-è¯ä¹¦"><a class="header" href="#äº”ç½‘ç»œå®‰å…¨ç”Ÿæˆ-x509-è¯ä¹¦">äº”ã€ç½‘ç»œå®‰å…¨ï¼šç”Ÿæˆ x509 è¯ä¹¦</a></h1>
<!--ts-->
<ul>
<li><a href="#%E4%BA%94%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E7%94%9F%E6%88%90-x509-%E8%AF%81%E4%B9%A6">äº”ã€ç½‘ç»œå®‰å…¨ï¼šç”Ÿæˆ x509 è¯ä¹¦</a>
<ul>
<li><a href="#%E5%9C%A8-kv-server-%E4%B8%AD%E4%BD%BF%E7%94%A8-tls">åœ¨ KV server ä¸­ä½¿ç”¨ TLS</a>
<ul>
<li><a href="#%E5%AE%9E%E7%8E%B0tls">å®ç°TLS</a></li>
</ul>
</li>
<li><a href="#%E8%AE%A9-kv-clientserver-%E6%94%AF%E6%8C%81-tls">è®© KV client/server æ”¯æŒ TLS</a></li>
<li><a href="#%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E5%9B%9E%E9%A1%BE">ç½‘ç»œå®‰å…¨å¼€å‘å›é¡¾</a></li>
<li><a href="#%E8%80%83%E8%99%91%E5%8F%8C%E5%90%91%E9%AA%8C%E8%AF%81">è€ƒè™‘åŒå‘éªŒè¯</a></li>
</ul>
</li>
</ul>
<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: runner, at: Sat Oct 15 10:54:50 UTC 2022 -->
<!--te-->
<details id="admonition-é‚£ä¹ˆå½“æˆ‘ä»¬çš„åº”ç”¨æ¶æ„åœ¨-tcp-ä¸Šæ—¶å¦‚ä½•ä½¿ç”¨-tls-æ¥ä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´çš„å®‰å…¨æ€§å‘¢" class="admonition question">
<summary class="admonition-title">
<p>é‚£ä¹ˆï¼Œå½“æˆ‘ä»¬çš„åº”ç”¨æ¶æ„åœ¨ TCP ä¸Šæ—¶ï¼Œå¦‚ä½•ä½¿ç”¨ TLS æ¥ä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´çš„å®‰å…¨æ€§å‘¢ï¼Ÿ</p>
<p><a class="admonition-anchor-link" href="#admonition-é‚£ä¹ˆå½“æˆ‘ä»¬çš„åº”ç”¨æ¶æ„åœ¨-tcp-ä¸Šæ—¶å¦‚ä½•ä½¿ç”¨-tls-æ¥ä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´çš„å®‰å…¨æ€§å‘¢"></a></p>
</summary>
<div>
<p>æƒ³è¦ä½¿ç”¨ TLSï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ <a href="https://en.wikipedia.org/wiki/X.509">x509 è¯ä¹¦</a>ã€‚TLS éœ€è¦ x509 è¯ä¹¦è®©å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨æ˜¯å¦æ˜¯ä¸€ä¸ªå—ä¿¡çš„æœåŠ¡å™¨ï¼Œç”šè‡³æœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯ï¼Œç¡®è®¤å¯¹æ–¹æ˜¯ä¸€ä¸ªå—ä¿¡çš„å®¢æˆ·ç«¯ã€‚</p>
<p>ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬è¦æœ‰èƒ½åŠ›ç”Ÿæˆè‡ªå·±çš„ CA è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦ï¼Œç”šè‡³å®¢æˆ·ç«¯è¯ä¹¦ã€‚è¯ä¹¦ç”Ÿæˆçš„ç»†èŠ‚ä»Šå¤©å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œæˆ‘ä¹‹å‰åšäº†<a href="https://github.com/tyrchen/certify">ä¸€ä¸ªå« certify çš„åº“</a>ï¼Œå¯ä»¥ç”¨æ¥ç”Ÿæˆå„ç§è¯ä¹¦ã€‚</p>
</div>
</details>
<details id="admonition-ä½¿ç”¨ä¸æµ‹è¯•ç”Ÿæˆè¯ä¹¦" class="admonition note">
<summary class="admonition-title">
<p>ä½¿ç”¨ä¸æµ‹è¯•ï¼šç”Ÿæˆè¯ä¹¦</p>
<p><a class="admonition-anchor-link" href="#admonition-ä½¿ç”¨ä¸æµ‹è¯•ç”Ÿæˆè¯ä¹¦"></a></p>
</summary>
<div>
<ol>
<li>æˆ‘ä»¬å¯ä»¥åœ¨ Cargo.toml é‡ŒåŠ å…¥è¿™ä¸ªåº“ï¼š</li>
</ol>
<pre><code class="language-toml">
[dev-dependencies]
...
certify = &quot;0.3&quot;
...
</code></pre>
<ol start="2">
<li>ç„¶ååœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º fixtures ç›®å½•å­˜æ”¾è¯ä¹¦</li>
<li>å†åˆ›å»º examples/gen_cert.rs æ–‡ä»¶ï¼Œæ·»å…¥å¦‚ä¸‹ä»£ç ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use certify::{generate_ca, generate_cert, load_ca, CertType, CA};
use tokio::fs;

struct CertPem {
    cert_type: CertType,
    cert: String,
    key: String,
}

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    let pem = create_ca()?;
    gen_files(&amp;pem).await?;
    let ca = load_ca(&amp;pem.cert, &amp;pem.key)?;
    let pem = create_cert(&amp;ca, &amp;[&quot;kvserver.acme.inc&quot;], &quot;Acme KV server&quot;, false)?;
    gen_files(&amp;pem).await?;
    let pem = create_cert(&amp;ca, &amp;[], &quot;awesome-device-id&quot;, true)?;
    gen_files(&amp;pem).await?;
    Ok(())
}

fn create_ca() -&gt; Result&lt;CertPem&gt; {
    let (cert, key) = generate_ca(
        &amp;[&quot;acme.inc&quot;],
        &quot;CN&quot;,
        &quot;Acme Inc.&quot;,
        &quot;Acme CA&quot;,
        None,
        Some(10 * 365),
    )?;
    Ok(CertPem {
        cert_type: CertType::CA,
        cert,
        key,
    })
}

fn create_cert(ca: &amp;CA, domains: &amp;[&amp;str], cn: &amp;str, is_client: bool) -&gt; Result&lt;CertPem&gt; {
    let (days, cert_type) = if is_client {
        (Some(365), CertType::Client)
    } else {
        (Some(5 * 365), CertType::Server)
    };
    let (cert, key) = generate_cert(ca, domains, &quot;CN&quot;, &quot;Acme Inc.&quot;, cn, None, is_client, days)?;

    Ok(CertPem {
        cert_type,
        cert,
        key,
    })
}

async fn gen_files(pem: &amp;CertPem) -&gt; Result&lt;()&gt; {
    let name = match pem.cert_type {
        CertType::Client =&gt; &quot;client&quot;,
        CertType::Server =&gt; &quot;server&quot;,
        CertType::CA =&gt; &quot;ca&quot;,
    };
    fs::write(format!(&quot;fixtures/{}.cert&quot;, name), pem.cert.as_bytes()).await?;
    fs::write(format!(&quot;fixtures/{}.key&quot;, name), pem.key.as_bytes()).await?;
    Ok(())
}
</code></pre></pre>
<p>è¿™ä¸ªä»£ç å¾ˆç®€å•:</p>
<ul>
<li>å®ƒå…ˆç”Ÿæˆäº†ä¸€ä¸ª CA è¯ä¹¦</li>
<li>ç„¶åå†ç”ŸæˆæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦ï¼Œå…¨éƒ¨å­˜å…¥åˆšåˆ›å»ºçš„ fixtures ç›®å½•ä¸‹ã€‚</li>
<li>ä½ éœ€è¦ <code>cargo run --examples gen_cert</code> è¿è¡Œä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼Œå¾…ä¼šæˆ‘ä»¬ä¼šåœ¨æµ‹è¯•ä¸­ç”¨åˆ°è¿™äº›è¯ä¹¦å’Œå¯†é’¥ã€‚</li>
</ul>
</div>
</details>
<h2 id="åœ¨-kv-server-ä¸­ä½¿ç”¨-tls"><a class="header" href="#åœ¨-kv-server-ä¸­ä½¿ç”¨-tls">åœ¨ KV server ä¸­ä½¿ç”¨ TLS</a></h2>
<details id="admonition-tls-æ˜¯ç›®å‰æœ€ä¸»è¦çš„åº”ç”¨å±‚å®‰å…¨åè®®" class="admonition info">
<summary class="admonition-title">
<p>TLS æ˜¯ç›®å‰æœ€ä¸»è¦çš„åº”ç”¨å±‚å®‰å…¨åè®® </p>
<p><a class="admonition-anchor-link" href="#admonition-tls-æ˜¯ç›®å‰æœ€ä¸»è¦çš„åº”ç”¨å±‚å®‰å…¨åè®®"></a></p>
</summary>
<div>
<p>TLS æ˜¯ç›®å‰æœ€ä¸»è¦çš„åº”ç”¨å±‚å®‰å…¨åè®®ï¼Œè¢«å¹¿æ³›ç”¨äºä¿æŠ¤æ¶æ„åœ¨ TCP ä¹‹ä¸Šçš„ï¼Œæ¯”å¦‚ MySQLã€HTTP ç­‰å„ç§åè®®ã€‚ä¸€ä¸ªç½‘ç»œåº”ç”¨ï¼Œå³ä¾¿æ˜¯åœ¨å†…ç½‘ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰å®‰å…¨åè®®æ¥ä¿æŠ¤ï¼Œéƒ½æ˜¯å¾ˆå±é™©çš„ã€‚</p>
<p><img src="https://raw.githubusercontent.com/KuanHsiaoKuo/writing_materials/main/imgs/71befa0bbf5225582dd01a7330c641f7.png" alt="img" /></p>
<p>å¯¹äº KV server æ¥è¯´ï¼Œä½¿ç”¨ TLS ä¹‹åï¼Œæ•´ä¸ªåè®®çš„æ•°æ®å°è£…å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/Users/kuanhsiaokuo/Migrations/writing_materials/077659d231dd45b1617ed3707c74cf13.jpg" alt="img" /></p>
</div>
</details>
<p>æ‰€ä»¥ä»Šå¤©è¦åšçš„å°±æ˜¯åœ¨ä¸Šä¸€è®²çš„ç½‘ç»œå¤„ç†çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ  TLS æ”¯æŒï¼Œä½¿å¾— KV server çš„å®¢æˆ·ç«¯æœåŠ¡å™¨ä¹‹é—´çš„é€šè®¯è¢«ä¸¥æ ¼ä¿æŠ¤èµ·æ¥ï¼Œç¡®ä¿æœ€å¤§ç¨‹åº¦çš„å®‰å…¨ï¼Œå…é­ç¬¬ä¸‰æ–¹çš„å·çª¥ã€ç¯¡æ”¹ä»¥åŠä»¿é€ ã€‚</p>
<h3 id="å®ç°tls"><a class="header" href="#å®ç°tls">å®ç°TLS</a></h3>
<p>å¥½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ TLS æ€ä¹ˆå®ç°ã€‚</p>
<p>ä¼°è®¡å¾ˆå¤šäººä¸€å¬ TLS æˆ–è€… SSLï¼Œå°±å¤´çš®å‘éº»ï¼Œå› ä¸ºä¹‹å‰è·Ÿ <a href="https://www.openssl.org">openssl</a> æ‰“äº¤é“æœ‰è¿‡å¾ˆå¤šä¸å¥½çš„ç»å†ã€‚openssl çš„ä»£ç åº“å¤ªåºæ‚ï¼ŒAPI ä¸å‹å¥½ï¼Œç¼–è¯‘é“¾æ¥éƒ½å¾ˆè´¹åŠ²ã€‚</p>
<details id="admonition-ä¸è¿‡åœ¨-rust-ä¸‹ä½¿ç”¨-tls-çš„ä½“éªŒè¿˜æ˜¯å¾ˆä¸é”™çš„" class="admonition info">
<summary class="admonition-title">
<p>ä¸è¿‡ï¼Œåœ¨ Rust ä¸‹ä½¿ç”¨ TLS çš„ä½“éªŒè¿˜æ˜¯å¾ˆä¸é”™çš„ï¼š </p>
<p><a class="admonition-anchor-link" href="#admonition-ä¸è¿‡åœ¨-rust-ä¸‹ä½¿ç”¨-tls-çš„ä½“éªŒè¿˜æ˜¯å¾ˆä¸é”™çš„"></a></p>
</summary>
<div>
<ul>
<li>Rust å¯¹ openssl æœ‰å¾ˆä¸é”™çš„å°è£…: <a href="https://github.com/sfackler/rust-openssl">rust-openssl</a></li>
<li>ä¹Ÿæœ‰ä¸ä¾èµ– openssl ç”¨ Rust æ’°å†™çš„ <a href="https://github.com/rustls/rustls">rustls</a></li>
<li>tokio è¿›ä¸€æ­¥æä¾›äº†<a href="https://github.com/tokio-rs/tls">ç¬¦åˆ tokio ç”Ÿæ€åœˆçš„ tls æ”¯æŒ</a>ï¼Œæœ‰ openssl ç‰ˆæœ¬å’Œ rustls ç‰ˆæœ¬å¯é€‰ã€‚</li>
</ul>
</div>
</details>
<p>æˆ‘ä»¬ä»Šå¤©å°±ç”¨ <a href="https://github.com/tokio-rs/tls/tree/master/tokio-rustls">tokio-rustls</a> æ¥æ’°å†™ TLS çš„æ”¯æŒã€‚</p>
<blockquote>
<p>ç›¸ä¿¡ä½ åœ¨å®ç°è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­åŠ å…¥ TLS åè®®æ¥ä¿æŠ¤ç½‘ç»œå±‚ï¼Œæ˜¯å¤šä¹ˆè½»æ¾çš„ä¸€ä»¶äº‹æƒ…ã€‚</p>
</blockquote>
<details id="admonition-1-å…ˆåœ¨-cargotoml-ä¸­æ·»åŠ -tokio-rustls" class="admonition note">
<summary class="admonition-title">
<ol>
<li>å…ˆåœ¨ Cargo.toml ä¸­æ·»åŠ  tokio-rustlsï¼š</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-1-å…ˆåœ¨-cargotoml-ä¸­æ·»åŠ -tokio-rustls"></a></p>
</summary>
<div>
<pre><code class="language-toml">
[dev-dependencies]
...
certify = &quot;0.3&quot;
...
</code></pre>
</div>
</details>
<details id="admonition-2-ç„¶ååˆ›å»º-srcnetworktlsrsæ’°å†™å¦‚ä¸‹ä»£ç -è®°å¾—åœ¨-srcnetworkmodrs-ä¸­å¼•å…¥è¿™ä¸ªæ–‡ä»¶" class="admonition note">
<summary class="admonition-title">
<ol start="2">
<li>ç„¶ååˆ›å»º src/network/tls.rsï¼Œæ’°å†™å¦‚ä¸‹ä»£ç , è®°å¾—åœ¨ src/network/mod.rs ä¸­å¼•å…¥è¿™ä¸ªæ–‡ä»¶ </li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-2-ç„¶ååˆ›å»º-srcnetworktlsrsæ’°å†™å¦‚ä¸‹ä»£ç -è®°å¾—åœ¨-srcnetworkmodrs-ä¸­å¼•å…¥è¿™ä¸ªæ–‡ä»¶"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
use std::io::Cursor;
use std::sync::Arc;

use tokio::io::{AsyncRead, AsyncWrite};
use tokio_rustls::rustls::{internal::pemfile, Certificate, ClientConfig, ServerConfig};
use tokio_rustls::rustls::{AllowAnyAuthenticatedClient, NoClientAuth, PrivateKey, RootCertStore};
use tokio_rustls::webpki::DNSNameRef;
use tokio_rustls::TlsConnector;
use tokio_rustls::{
    client::TlsStream as ClientTlsStream, server::TlsStream as ServerTlsStream, TlsAcceptor,
};

use crate::KvError;

/// KV Server è‡ªå·±çš„ ALPN (Application-Layer Protocol Negotiation)
const ALPN_KV: &amp;str = &quot;kv&quot;;

/// å­˜æ”¾ TLS ServerConfig å¹¶æä¾›æ–¹æ³• accept æŠŠåº•å±‚çš„åè®®è½¬æ¢æˆ TLS
#[derive(Clone)]
pub struct TlsServerAcceptor {
    inner: Arc&lt;ServerConfig&gt;,
}

/// å­˜æ”¾ TLS Client å¹¶æä¾›æ–¹æ³• connect æŠŠåº•å±‚çš„åè®®è½¬æ¢æˆ TLS
#[derive(Clone)]
pub struct TlsClientConnector {
    pub config: Arc&lt;ClientConfig&gt;,
    pub domain: Arc&lt;String&gt;,
}

impl TlsClientConnector {
    /// åŠ è½½ client cert / CA certï¼Œç”Ÿæˆ ClientConfig
    pub fn new(
        domain: impl Into&lt;String&gt;,
        identity: Option&lt;(&amp;str, &amp;str)&gt;,
        server_ca: Option&lt;&amp;str&gt;,
    ) -&gt; Result&lt;Self, KvError&gt; {
        let mut config = ClientConfig::new();

        // å¦‚æœæœ‰å®¢æˆ·ç«¯è¯ä¹¦ï¼ŒåŠ è½½ä¹‹
        if let Some((cert, key)) = identity {
            let certs = load_certs(cert)?;
            let key = load_key(key)?;
            config.set_single_client_cert(certs, key)?;
        }

        // åŠ è½½æœ¬åœ°ä¿¡ä»»çš„æ ¹è¯ä¹¦é“¾
        config.root_store = match rustls_native_certs::load_native_certs() {
            Ok(store) | Err((Some(store), _)) =&gt; store,
            Err((None, error)) =&gt; return Err(error.into()),
        };

        // å¦‚æœæœ‰ç­¾ç½²æœåŠ¡å™¨çš„ CA è¯ä¹¦ï¼Œåˆ™åŠ è½½å®ƒï¼Œè¿™æ ·æœåŠ¡å™¨è¯ä¹¦ä¸åœ¨æ ¹è¯ä¹¦é“¾
        // ä½†æ˜¯è¿™ä¸ª CA è¯ä¹¦èƒ½éªŒè¯å®ƒï¼Œä¹Ÿå¯ä»¥
        if let Some(cert) = server_ca {
            let mut buf = Cursor::new(cert);
            config.root_store.add_pem_file(&amp;mut buf).unwrap();
        }

        Ok(Self {
            config: Arc::new(config),
            domain: Arc::new(domain.into()),
        })
    }

    /// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream
    pub async fn connect&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ClientTlsStream&lt;S&gt;, KvError&gt;
    where
        S: AsyncRead + AsyncWrite + Unpin + Send,
    {
        let dns = DNSNameRef::try_from_ascii_str(self.domain.as_str())
            .map_err(|_| KvError::Internal(&quot;Invalid DNS name&quot;.into()))?;

        let stream = TlsConnector::from(self.config.clone())
            .connect(dns, stream)
            .await?;

        Ok(stream)
    }
}

impl TlsServerAcceptor {
    /// åŠ è½½ server cert / CA certï¼Œç”Ÿæˆ ServerConfig
    pub fn new(cert: &amp;str, key: &amp;str, client_ca: Option&lt;&amp;str&gt;) -&gt; Result&lt;Self, KvError&gt; {
        let certs = load_certs(cert)?;
        let key = load_key(key)?;

        let mut config = match client_ca {
            None =&gt; ServerConfig::new(NoClientAuth::new()),
            Some(cert) =&gt; {
                // å¦‚æœå®¢æˆ·ç«¯è¯ä¹¦æ˜¯æŸä¸ª CA è¯ä¹¦ç­¾å‘çš„ï¼Œåˆ™æŠŠè¿™ä¸ª CA è¯ä¹¦åŠ è½½åˆ°ä¿¡ä»»é“¾ä¸­
                let mut cert = Cursor::new(cert);
                let mut client_root_cert_store = RootCertStore::empty();
                client_root_cert_store
                    .add_pem_file(&amp;mut cert)
                    .map_err(|_| KvError::CertifcateParseError(&quot;CA&quot;, &quot;cert&quot;))?;

                let client_auth = AllowAnyAuthenticatedClient::new(client_root_cert_store);
                ServerConfig::new(client_auth)
            }
        };

        // åŠ è½½æœåŠ¡å™¨è¯ä¹¦
        config
            .set_single_cert(certs, key)
            .map_err(|_| KvError::CertifcateParseError(&quot;server&quot;, &quot;cert&quot;))?;
        config.set_protocols(&amp;[Vec::from(&amp;ALPN_KV[..])]);

        Ok(Self {
            inner: Arc::new(config),
        })
    }

    /// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream
    pub async fn accept&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ServerTlsStream&lt;S&gt;, KvError&gt;
    where
        S: AsyncRead + AsyncWrite + Unpin + Send,
    {
        let acceptor = TlsAcceptor::from(self.inner.clone());
        Ok(acceptor.accept(stream).await?)
    }
}

fn load_certs(cert: &amp;str) -&gt; Result&lt;Vec&lt;Certificate&gt;, KvError&gt; {
    let mut cert = Cursor::new(cert);
    pemfile::certs(&amp;mut cert).map_err(|_| KvError::CertifcateParseError(&quot;server&quot;, &quot;cert&quot;))
}

fn load_key(key: &amp;str) -&gt; Result&lt;PrivateKey, KvError&gt; {
    let mut cursor = Cursor::new(key);

    // å…ˆå°è¯•ç”¨ PKCS8 åŠ è½½ç§é’¥
    if let Ok(mut keys) = pemfile::pkcs8_private_keys(&amp;mut cursor) {
        if !keys.is_empty() {
            return Ok(keys.remove(0));
        }
    }

    // å†å°è¯•åŠ è½½ RSA key
    cursor.set_position(0);
    if let Ok(mut keys) = pemfile::rsa_private_keys(&amp;mut cursor) {
        if !keys.is_empty() {
            return Ok(keys.remove(0));
        }
    }

    // ä¸æ”¯æŒçš„ç§é’¥ç±»å‹
    Err(KvError::CertifcateParseError(&quot;private&quot;, &quot;key&quot;))
}
</code></pre></pre>
<ul>
<li>è¿™ä¸ªä»£ç åˆ›å»ºäº†ä¸¤ä¸ªæ•°æ®ç»“æ„ TlsServerAcceptor / TlsClientConnectorã€‚</li>
<li>è™½ç„¶å®ƒæœ‰ 100 å¤šè¡Œï¼Œä½†ä¸»è¦çš„å·¥ä½œå…¶å®å°±æ˜¯æ ¹æ®æä¾›çš„è¯ä¹¦ï¼Œæ¥ç”Ÿæˆ tokio-tls éœ€è¦çš„ ServerConfig / ClientConfigã€‚</li>
<li>å› ä¸º TLS éœ€è¦éªŒè¯è¯ä¹¦çš„ CAï¼Œæ‰€ä»¥è¿˜éœ€è¦åŠ è½½ CA è¯ä¹¦ã€‚è™½ç„¶å¹³æ—¶åœ¨åš Web å¼€å‘æ—¶ï¼Œæˆ‘ä»¬éƒ½åªä½¿ç”¨æœåŠ¡å™¨è¯ä¹¦ï¼Œä½†å…¶å® TLS æ”¯æŒåŒå‘éªŒè¯ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦æ˜¯å¦æ˜¯å®ƒè®¤è¯†çš„ CA ç­¾å‘çš„ã€‚</li>
</ul>
</div>
</details>
<blockquote>
<p>å¤„ç†å®Œ config åï¼Œè¿™æ®µä»£ç çš„æ ¸å¿ƒé€»è¾‘å…¶å®å°±æ˜¯å®¢æˆ·ç«¯çš„ connect() æ–¹æ³•å’ŒæœåŠ¡å™¨çš„ accept() æ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ¥å—ä¸€ä¸ªæ»¡è¶³ AsyncRead + AsyncWrite + Unpin + Send çš„ streamã€‚</p>
</blockquote>
<details id="admonition-3-è€ƒè™‘åˆ°é€šç”¨æ€§æˆ‘ä»¬ä¸å¸Œæœ›-tls-ä»£ç åªèƒ½æ¥å—-tcpstreamæ‰€ä»¥è¿™é‡Œæä¾›äº†ä¸€ä¸ªæ³›å‹å‚æ•°-s" class="admonition note">
<summary class="admonition-title">
<ol start="3">
<li>è€ƒè™‘åˆ°é€šç”¨æ€§ï¼Œæˆ‘ä»¬ä¸å¸Œæœ› TLS ä»£ç åªèƒ½æ¥å— TcpStreamï¼Œæ‰€ä»¥è¿™é‡Œæä¾›äº†ä¸€ä¸ªæ³›å‹å‚æ•° Sï¼š</li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-3-è€ƒè™‘åˆ°é€šç”¨æ€§æˆ‘ä»¬ä¸å¸Œæœ›-tls-ä»£ç åªèƒ½æ¥å—-tcpstreamæ‰€ä»¥è¿™é‡Œæä¾›äº†ä¸€ä¸ªæ³›å‹å‚æ•°-s"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
/// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream
pub async fn connect&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ClientTlsStream&lt;S&gt;, KvError&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send,
{
    let dns = DNSNameRef::try_from_ascii_str(self.domain.as_str())
        .map_err(|_| KvError::Internal(&quot;Invalid DNS name&quot;.into()))?;

    let stream = TlsConnector::from(self.config.clone())
        .connect(dns, stream)
        .await?;

    Ok(stream)
}

/// è§¦å‘ TLS åè®®ï¼ŒæŠŠåº•å±‚çš„ stream è½¬æ¢æˆ TLS stream
pub async fn accept&lt;S&gt;(&amp;self, stream: S) -&gt; Result&lt;ServerTlsStream&lt;S&gt;, KvError&gt;
where
    S: AsyncRead + AsyncWrite + Unpin + Send,
{
    let acceptor = TlsAcceptor::from(self.inner.clone());
    Ok(acceptor.accept(stream).await?)
}
</code></pre></pre>
<ul>
<li>åœ¨ä½¿ç”¨ TlsConnector æˆ–è€… TlsAcceptor å¤„ç†å®Œ connect/accept åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª TlsStream</li>
<li>å®ƒä¹Ÿæ»¡è¶³ AsyncRead + AsyncWrite + Unpin + Send</li>
<li>åç»­çš„æ“ä½œå°±å¯ä»¥åœ¨å…¶ä¸Šå®Œæˆäº†ã€‚</li>
<li>ç™¾æ¥è¡Œä»£ç å°±æå®šäº† TLSï¼Œæ˜¯ä¸æ˜¯å¾ˆè½»æ¾ï¼Ÿ</li>
</ul>
</div>
</details>
<details id="admonition-4-æˆ‘ä»¬æ¥é¡ºç€å¾€ä¸‹å†™æ®µæµ‹è¯•" class="admonition note">
<summary class="admonition-title">
<ol start="4">
<li>æˆ‘ä»¬æ¥é¡ºç€å¾€ä¸‹å†™æ®µæµ‹è¯•ï¼š </li>
</ol>
<p><a class="admonition-anchor-link" href="#admonition-4-æˆ‘ä»¬æ¥é¡ºç€å¾€ä¸‹å†™æ®µæµ‹è¯•"></a></p>
</summary>
<div>
<pre><pre class="playground"><code class="language-rust  editable">
#[cfg(test)]
mod tests {

    use std::net::SocketAddr;

    use super::*;
    use anyhow::Result;
    use tokio::{
        io::{AsyncReadExt, AsyncWriteExt},
        net::{TcpListener, TcpStream},
    };

    const CA_CERT: &amp;str = include_str!(&quot;../../fixtures/ca.cert&quot;);
    const CLIENT_CERT: &amp;str = include_str!(&quot;../../fixtures/client.cert&quot;);
    const CLIENT_KEY: &amp;str = include_str!(&quot;../../fixtures/client.key&quot;);
    const SERVER_CERT: &amp;str = include_str!(&quot;../../fixtures/server.cert&quot;);
    const SERVER_KEY: &amp;str = include_str!(&quot;../../fixtures/server.key&quot;);

    #[tokio::test]
    async fn tls_should_work() -&gt; Result&lt;()&gt; {
        let ca = Some(CA_CERT);

        let addr = start_server(None).await?;

        let connector = TlsClientConnector::new(&quot;kvserver.acme.inc&quot;, None, ca)?;
        let stream = TcpStream::connect(addr).await?;
        let mut stream = connector.connect(stream).await?;
        stream.write_all(b&quot;hello world!&quot;).await?;
        let mut buf = [0; 12];
        stream.read_exact(&amp;mut buf).await?;
        assert_eq!(&amp;buf, b&quot;hello world!&quot;);

        Ok(())
    }

    #[tokio::test]
    async fn tls_with_client_cert_should_work() -&gt; Result&lt;()&gt; {
        let client_identity = Some((CLIENT_CERT, CLIENT_KEY));
        let ca = Some(CA_CERT);

        let addr = start_server(ca.clone()).await?;

        let connector = TlsClientConnector::new(&quot;kvserver.acme.inc&quot;, client_identity, ca)?;
        let stream = TcpStream::connect(addr).await?;
        let mut stream = connector.connect(stream).await?;
        stream.write_all(b&quot;hello world!&quot;).await?;
        let mut buf = [0; 12];
        stream.read_exact(&amp;mut buf).await?;
        assert_eq!(&amp;buf, b&quot;hello world!&quot;);

        Ok(())
    }

    #[tokio::test]
    async fn tls_with_bad_domain_should_not_work() -&gt; Result&lt;()&gt; {
        let addr = start_server(None).await?;

        let connector = TlsClientConnector::new(&quot;kvserver1.acme.inc&quot;, None, Some(CA_CERT))?;
        let stream = TcpStream::connect(addr).await?;
        let result = connector.connect(stream).await;

        assert!(result.is_err());

        Ok(())
    }

    async fn start_server(ca: Option&lt;&amp;str&gt;) -&gt; Result&lt;SocketAddr&gt; {
        let acceptor = TlsServerAcceptor::new(SERVER_CERT, SERVER_KEY, ca)?;

        let echo = TcpListener::bind(&quot;127.0.0.1:0&quot;).await.unwrap();
        let addr = echo.local_addr().unwrap();

        tokio::spawn(async move {
            let (stream, _) = echo.accept().await.unwrap();
            let mut stream = acceptor.accept(stream).await.unwrap();
            let mut buf = [0; 12];
            stream.read_exact(&amp;mut buf).await.unwrap();
            stream.write_all(&amp;buf).await.unwrap();
        });

        Ok(addr)
    }
}
</code></pre></pre>
<ul>
<li>è¿™æ®µæµ‹è¯•ä»£ç ä½¿ç”¨äº† include_str! å®ï¼Œåœ¨ç¼–è¯‘æœŸæŠŠæ–‡ä»¶åŠ è½½æˆå­—ç¬¦ä¸²æ”¾åœ¨ RODATA æ®µã€‚</li>
<li>æˆ‘ä»¬æµ‹è¯•äº†ä¸‰ç§æƒ…å†µï¼šæ ‡å‡†çš„ TLS è¿æ¥ã€å¸¦æœ‰å®¢æˆ·ç«¯è¯ä¹¦çš„ TLS è¿æ¥ï¼Œä»¥åŠå®¢æˆ·ç«¯æä¾›äº†é”™çš„åŸŸåçš„æƒ…å†µã€‚</li>
<li>è¿è¡Œ cargo test ï¼Œæ‰€æœ‰æµ‹è¯•éƒ½èƒ½é€šè¿‡ã€‚</li>
</ul>
</div>
</details>
<h2 id="è®©-kv-clientserver-æ”¯æŒ-tls"><a class="header" href="#è®©-kv-clientserver-æ”¯æŒ-tls">è®© KV client/server æ”¯æŒ TLS</a></h2>
<p>åœ¨ TLS çš„æµ‹è¯•éƒ½é€šè¿‡åï¼Œå°±å¯ä»¥æ·»åŠ  kvs å’Œ kvc å¯¹ TLS çš„æ”¯æŒäº†ã€‚</p>
<p>ç”±äºæˆ‘ä»¬ä¸€è·¯ä»¥æ¥è‰¯å¥½çš„æ¥å£è®¾è®¡ï¼Œå°¤å…¶æ˜¯ ProstClientStream / ProstServerStream éƒ½æ¥å—æ³›å‹å‚æ•°ï¼Œä½¿å¾— TLS çš„ä»£ç å¯ä»¥æ— ç¼åµŒå…¥ã€‚</p>
<details id="admonition-å’Œä¸Šä¸€ç‰ˆé¡¹ç›®ç›¸æ¯”æ›´æ–°åçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç å„è‡ªä»…ä»…å¤šäº†ä¸€è¡Œå°±æŠŠ-tcpstream-å°è£…æˆäº†-tlsstream" class="admonition note">
<summary class="admonition-title">
<p>å’Œä¸Šä¸€ç‰ˆé¡¹ç›®ç›¸æ¯”ï¼Œæ›´æ–°åçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç ï¼Œå„è‡ªä»…ä»…å¤šäº†ä¸€è¡Œï¼Œå°±æŠŠ TcpStream å°è£…æˆäº† TlsStreamã€‚ </p>
<p><a class="admonition-anchor-link" href="#admonition-å’Œä¸Šä¸€ç‰ˆé¡¹ç›®ç›¸æ¯”æ›´æ–°åçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç å„è‡ªä»…ä»…å¤šäº†ä¸€è¡Œå°±æŠŠ-tcpstream-å°è£…æˆäº†-tlsstream"></a></p>
</summary>
<div>
<ol>
<li>æ¯”å¦‚å®¢æˆ·ç«¯ï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
// æ–°åŠ çš„ä»£ç 
let connector = TlsClientConnector::new(&quot;kvserver.acme.inc&quot;, None, Some(ca_cert))?;

let stream = TcpStream::connect(addr).await?;

// æ–°åŠ çš„ä»£ç 
let stream = connector.connect(stream).await?;

let mut client = ProstClientStream::new(stream);
</code></pre></pre>
<p>ä»…ä»…éœ€è¦æŠŠä¼ ç»™ ProstClientStream çš„ streamï¼Œä» TcpStream æ¢æˆç”Ÿæˆçš„ TlsStreamï¼Œå°±æ— ç¼æ”¯æŒäº† TLSã€‚</p>
<ol start="2">
<li>æˆ‘ä»¬çœ‹å®Œæ•´çš„ä»£ç ï¼Œsrc/server.rsï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use kv3::{MemTable, ProstServerStream, Service, ServiceInner, TlsServerAcceptor};
use tokio::net::TcpListener;
use tracing::info;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();
    let addr = &quot;127.0.0.1:9527&quot;;

    // ä»¥åä»é…ç½®æ–‡ä»¶å–
    let server_cert = include_str!(&quot;../fixtures/server.cert&quot;);
    let server_key = include_str!(&quot;../fixtures/server.key&quot;);

    let acceptor = TlsServerAcceptor::new(server_cert, server_key, None)?;
    let service: Service = ServiceInner::new(MemTable::new()).into();
    let listener = TcpListener::bind(addr).await?;
    info!(&quot;Start listening on {}&quot;, addr);
    loop {
        let tls = acceptor.clone();
        let (stream, addr) = listener.accept().await?;
        info!(&quot;Client {:?} connected&quot;, addr);
        let stream = tls.accept(stream).await?;
        let stream = ProstServerStream::new(stream, service.clone());
        tokio::spawn(async move { stream.process().await });
    }
}
</code></pre></pre>
<ol start="3">
<li>src/client.rsï¼š</li>
</ol>
<pre><pre class="playground"><code class="language-rust  editable">
use anyhow::Result;
use kv3::{CommandRequest, ProstClientStream, TlsClientConnector};
use tokio::net::TcpStream;
use tracing::info;

#[tokio::main]
async fn main() -&gt; Result&lt;()&gt; {
    tracing_subscriber::fmt::init();

    // ä»¥åç”¨é…ç½®æ›¿æ¢
    let ca_cert = include_str!(&quot;../fixtures/ca.cert&quot;);

    let addr = &quot;127.0.0.1:9527&quot;;
    // è¿æ¥æœåŠ¡å™¨
    let connector = TlsClientConnector::new(&quot;kvserver.acme.inc&quot;, None, Some(ca_cert))?;
    let stream = TcpStream::connect(addr).await?;
    let stream = connector.connect(stream).await?;

    let mut client = ProstClientStream::new(stream);

    // ç”Ÿæˆä¸€ä¸ª HSET å‘½ä»¤
    let cmd = CommandRequest::new_hset(&quot;table1&quot;, &quot;hello&quot;, &quot;world&quot;.to_string().into());

    // å‘é€ HSET å‘½ä»¤
    let data = client.execute(cmd).await?;
    info!(&quot;Got response {:?}&quot;, data);

    Ok(())
}
</code></pre></pre>
</div>
</details>
<blockquote>
<p>è¿™å°±æ˜¯ä½¿ç”¨ trait åšé¢å‘æ¥å£ç¼–ç¨‹çš„å·¨å¤§å¨åŠ›ï¼Œç³»ç»Ÿçš„å„ä¸ªç»„ä»¶å¯ä»¥æ¥è‡ªä¸åŒçš„ cratesï¼Œä½†åªè¦å…¶æ¥å£ä¸€è‡´ï¼ˆæˆ–è€…æˆ‘ä»¬åˆ›å»º adapter ä½¿å…¶æ¥å£ä¸€è‡´ï¼‰ï¼Œå°±å¯ä»¥æ— ç¼æ’å…¥ã€‚</p>
</blockquote>
<details id="admonition-æµ‹è¯•é€šè¿‡" class="admonition success">
<summary class="admonition-title">
<p>æµ‹è¯•é€šè¿‡ </p>
<p><a class="admonition-anchor-link" href="#admonition-æµ‹è¯•é€šè¿‡"></a></p>
</summary>
<div>
<ul>
<li>å®Œæˆä¹‹åï¼Œæ‰“å¼€ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</li>
</ul>
<pre><code class="language-shell">RUST_LOG=info cargo run --bin kvs --quiet
</code></pre>
<ul>
<li>ç„¶ååœ¨å¦ä¸€ä¸ªå‘½ä»¤è¡Œçª—å£ï¼Œè¿è¡Œï¼š</li>
</ul>
<pre><code class="language-shell">RUST_LOG=info cargo run --bin kvc --quie
</code></pre>
</div>
</details>
<p>æ­¤æ—¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ”¶åˆ°äº†å½¼æ­¤çš„è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ä¸”å¤„ç†æ­£å¸¸ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„ KV server å·²ç»å…·å¤‡è¶³å¤Ÿçš„å®‰å…¨æ€§äº†ï¼</p>
<p>ä»¥åï¼Œç­‰æˆ‘ä»¬ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œå°±å¯ä»¥æ ¹æ®é…ç½®æ–‡ä»¶è¯»å–è¯ä¹¦å’Œç§é’¥ã€‚è¿™æ ·å¯ä»¥åœ¨éƒ¨ç½²çš„æ—¶å€™ï¼Œæ‰ä» vault ä¸­è·å–ç§é’¥ï¼Œæ—¢ä¿è¯çµæ´»æ€§ï¼Œåˆèƒ½ä¿è¯ç³»ç»Ÿè‡ªèº«çš„å®‰å…¨ã€‚</p>
<h2 id="ç½‘ç»œå®‰å…¨å¼€å‘å›é¡¾"><a class="header" href="#ç½‘ç»œå®‰å…¨å¼€å‘å›é¡¾">ç½‘ç»œå®‰å…¨å¼€å‘å›é¡¾</a></h2>
<p>ç½‘ç»œå®‰å…¨æ˜¯å¼€å‘ç½‘ç»œç›¸å…³çš„åº”ç”¨ç¨‹åºä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ã€‚è™½ç„¶ KV Server è¿™æ ·çš„æœåŠ¡åŸºæœ¬ä¸Šä¼šè¿è¡Œåœ¨äº‘ç«¯å—æ§çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œä¸ä¼šå¯¹ internet æä¾›æœåŠ¡ï¼Œç„¶è€Œäº‘ç«¯å†…éƒ¨çš„å®‰å…¨æ€§ä¹Ÿä¸å®¹å¿½è§†ã€‚ä½ ä¸å¸Œæœ›æ•°æ®åœ¨æµåŠ¨çš„è¿‡ç¨‹ä¸­è¢«ç¯¡æ”¹ã€‚</p>
<p>TLS å¾ˆå¥½åœ°è§£å†³äº†å®‰å…¨æ€§çš„é—®é¢˜ï¼Œå¯ä»¥ä¿è¯æ•´ä¸ªä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ã€‚å¦‚æœä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦çš„è¯ï¼Œè¿˜å¯ä»¥åšä¸€å®šç¨‹åº¦çš„å®¢æˆ·ç«¯åˆæ³•æ€§çš„éªŒè¯ã€‚æ¯”å¦‚ä½ å¯ä»¥åœ¨äº‘ç«¯ä¸ºæ‰€æœ‰æœ‰æƒè®¿é—® KV server
çš„å®¢æˆ·ç«¯ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦ï¼Œè¿™æ ·ï¼Œåªè¦å®¢æˆ·ç«¯çš„ç§é’¥ä¸æ³„éœ²ï¼Œå°±åªæœ‰æ‹¥æœ‰è¯ä¹¦çš„å®¢æˆ·ç«¯æ‰èƒ½è®¿é—® KV serverã€‚</p>
<p>ä¸çŸ¥é“ä½ ç°åœ¨æœ‰æ²¡æœ‰è§‰å¾—ï¼Œåœ¨ Rust ä¸‹ä½¿ç”¨ TLS æ˜¯éå¸¸æ–¹ä¾¿çš„ä¸€ä»¶äº‹æƒ…ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬æ„å»ºçš„ ProstServerStream / ProstClientStreamï¼Œå› ä¸ºæœ‰è¶³å¤Ÿå¥½çš„æŠ½è±¡ï¼Œå¯ä»¥åœ¨ TcpStream å’Œ TlsStream
ä¹‹é—´æ¸¸åˆƒæœ‰ä½™åœ°åˆ‡æ¢ã€‚å½“ä½ æ„å»ºå¥½ç›¸å…³çš„ä»£ç ï¼Œåªéœ€è¦æŠŠ TcpStream æ¢æˆ TlsStreamï¼ŒKV server å°±å¯ä»¥æ— ç¼åˆ‡æ¢åˆ°ä¸€ä¸ªå®‰å…¨çš„ç½‘ç»œåè®®æ ˆã€‚</p>
<h2 id="è€ƒè™‘åŒå‘éªŒè¯"><a class="header" href="#è€ƒè™‘åŒå‘éªŒè¯">è€ƒè™‘åŒå‘éªŒè¯</a></h2>
<p>ç›®å‰æˆ‘ä»¬çš„ kvc / kvs åªåšäº†å•å‘çš„éªŒè¯ï¼Œå¦‚æœæœåŠ¡å™¨è¦éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿå¦‚æœä½ æ²¡æœ‰å¤´ç»ªï¼Œå¯ä»¥å†ä»”ç»†çœ‹çœ‹æµ‹è¯• TLS çš„ä»£ç ï¼Œç„¶åæ”¹åŠ¨ kvc/kvs ä½¿å¾—åŒå‘éªŒè¯ä¹Ÿèƒ½é€šè¿‡å§ã€‚</p>
<p>é™¤äº† TLSï¼Œå¦å¤–ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„å¤„ç†åº”ç”¨å±‚å®‰å…¨çš„åè®®æ˜¯ <a href="https://noiseprotocol.org">noise protocol</a>
ã€‚ä½ å¯ä»¥é˜…è¯»<a href="https://zhuanlan.zhihu.com/p/96944134">é™ˆå¤©çš„è¿™ç¯‡æ–‡ç« </a>äº†è§£ noise protocolã€‚Rust ä¸‹æœ‰<a href="https://github.com/mcginty/snow"> snow </a>
è¿™ä¸ªå¾ˆä¼˜ç§€çš„åº“å¤„ç† noise
protocolã€‚å¯¹äºæœ‰ä½™åŠ›çš„åŒå­¦ï¼Œä½ ä»¬å¯ä»¥çœ‹çœ‹å®ƒçš„æ–‡æ¡£ï¼Œå°è¯•ç€å†™æ®µ<a href="https://github.com/seanmonstar/reqwest/blob/master/src/tls.rs">ç±»ä¼¼reqwestçš„ tls.rs çš„ä»£ç </a>
ï¼Œè®©æˆ‘ä»¬çš„ kvs / kvc å¯ä»¥ä½¿ç”¨ noise protocolã€‚</p>

            </main>

            <!--            <script src="https://utteranc.es/client.js"-->
            <!--                    repo="RustMagazine/rust_magazine_2022"-->
            <!--                    issue-term="title"-->
            <!--                    theme="github-light"-->
            <!--                    crossorigin="anonymous"-->
            <!--                    async></script>-->

            <nav class="nav-wrapper" aria-label="Page navigation">
                <!-- Mobile navigation buttons -->
                    <a rel="prev" href="kv4_network.html" class="mobile-nav-chapters previous"
                       title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="kv6_async_refactor.html" class="mobile-nav-chapters next"
                       title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                <div style="clear: both"></div>
            </nav>
        </div>
    </div>

    <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="kv4_network.html" class="nav-chapters previous" title="Previous chapter"
               aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="kv6_async_refactor.html" class="nav-chapters next" title="Next chapter"
               aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
    </nav>

</div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

<script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
<script src="highlight.js" type="text/javascript" charset="utf-8"></script>
<script src="book.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JS scripts -->
    <script type="text/javascript" src="assets/mermaid/mermaid.min.js"></script>
    <script type="text/javascript" src="assets/mermaid/mermaid-init.js"></script>
    <script type="text/javascript" src="assets/smart-anchor.js"></script>
    <script type="text/javascript" src="assets/pagetoc/sidebar.js"></script>

</body>
</html>
